<?xml version="1.0" encoding="utf-8"?>
<!--
  Copyright (C) 2010 Orbeon, Inc.

  This program is free software; you can redistribute it and/or modify it under the terms of the
  GNU Lesser General Public License as published by the Free Software Foundation; either version
  2.1 of the License, or (at your option) any later version.

  This program is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY;
  without even the implied warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.
  See the GNU Lesser General Public License for more details.

  The full text of the license is available at http://www.gnu.org/copyleft/lesser.html
  -->
<!-- This is the Orbeon Forms Form Runner standard summary page -->
<html xmlns:xs="http://www.w3.org/2001/XMLSchema"
      xmlns:xforms="http://www.w3.org/2002/xforms"
      xmlns:ev="http://www.w3.org/2001/xml-events"
      xmlns:xxforms="http://orbeon.org/oxf/xml/xforms"
      xmlns:xi="http://www.w3.org/2001/XInclude"
      xmlns:f="http://orbeon.org/oxf/xml/formatting"
      xmlns:xhtml="http://www.w3.org/1999/xhtml"
      xmlns:xxi="http://orbeon.org/oxf/xml/xinclude"
      xmlns:xsl="http://www.w3.org/1999/XSL/Transform"
      xmlns:fr="http://orbeon.org/oxf/xml/form-runner"
      xmlns:widget="http://orbeon.org/oxf/xml/widget"
      xmlns="http://www.w3.org/1999/xhtml">

    <head>
        <title>Orbeon Form Runner</title>
        <xhtml:link rel="stylesheet" href="/apps/fr/style/form-runner-summary.css" type="text/css" media="all"/>
        <!-- Summary page XForms model -->
        <xforms:model id="fr-form-model" xxforms:xpath-analysis="true">

            <!-- NOTE: This test is duplicated in other places -->
            <xxforms:variable name="parameters" select="xxforms:instance('fr-parameters-instance')"/>
            <xxforms:variable name="is-form-builder" select="$parameters/app = 'orbeon' and $parameters/form = 'builder'"/>

            <xxforms:variable name="has-roles" select="xxforms:instance('fr-roles-instance')/has-roles = 'true'" as="xs:boolean"/>
            <xxforms:variable name="app-query" select="if ($is-form-builder and $has-roles) then instance('fr-search-instance')/query[contains(@path, 'application-name') and @search-field = 'true'] else ()" as="element(query)?"/>
            <xxforms:variable name="form-query" select="if ($app-query) then instance('fr-search-instance')/query[contains(@path, 'form-name') and @search-field = 'true'] else ()" as="element(query)?"/>
            <xxforms:variable name="initial-app-value" select="if ($app-query) then xxforms:instance('fr-permissions')/app[1][not(@name = '*')]/@name else ()" as="xs:string?"/>

            <xxforms:variable name="app" as="xs:string" select="xxforms:instance('fr-parameters-instance')/app"/>
            <xxforms:variable name="form" as="xs:string" select="xxforms:instance('fr-parameters-instance')/form"/>

            <!-- Model initialization -->
            <xforms:action ev:event="xforms-model-construct-done">
                <!-- Query list of documents -->
                <xforms:send submission="search-submission"/>
            </xforms:action>

            <!-- Model initialization after we got the source form -->
            <xforms:action ev:event="get-source-form-submission-done">
                <!-- Store resources from configuration instance -->
                <xxforms:variable name="resources-instance" as="element(xforms:instance)"
                                  select="xxforms:instance('fr-source-form-instance')/xhtml:head/xforms:model/xforms:instance[@id = 'fr-form-resources']"/>
                <xforms:action if="not($resources-instance/@src)">
                    <!-- Copy inline instance -->
                    <xforms:insert nodeset="instance('fr-form-resources')" origin="$resources-instance/*"/>
                </xforms:action>
                <xforms:action if="$resources-instance/@src">
                    <!-- Dereference @src -->
                    <xforms:insert nodeset="instance('fr-form-resources')" origin="doc($resources-instance/@src)"/>
                </xforms:action>
                <!-- Update to current language -->
                <xforms:dispatch name="fr-update-language" target="fr-resources-model"/>

                <!-- Set page size -->
                <xxforms:variable name="page-size" select="instance('fr-search-instance')/page-size" as="element(page-size)"/>
                <xforms:setvalue ref="$page-size" model="fr-persistence-model"
                                 value="xxforms:property(string-join(('oxf.fr.summary.page-size', $app, $form), '.'))"/>
            </xforms:action>

            <!-- Standard Form Runner data instance -->
            <xforms:instance id="fr-form-instance">
                <dummy/>
            </xforms:instance>

            <!-- Metadata -->
            <xforms:instance id="fr-form-metadata" xxforms:readonly="true">
                <metadata xmlns="">
                    <application-name>orbeon</application-name>
                    <form-name>runner</form-name>
                    <title>Orbeon Form Runner</title>
                    <description>Orbeon Form Runner is the start page for all your forms.</description>
                    <author>Orbeon, Inc.</author>
                    <logo mediatype="" filename="" size=""/>
                </metadata>
            </xforms:instance>

            <!-- Standard Form Runner resources instance -->
            <xforms:instance id="fr-form-resources">
                <resources xmlns=""/>
            </xforms:instance>

            <!-- Instance to control the triggers' appearance -->
            <xforms:instance id="fr-summary-triggers-instance">
                <triggers xmlns="">
                    <new/>
                    <view/>
                    <pdf/>
                    <delete/>
                </triggers>
            </xforms:instance>

            <xforms:bind nodeset="instance('fr-summary-triggers-instance')">
                <!-- Operations on entries are disabled if no entry is selected -->
                <xforms:bind nodeset="view | pdf" readonly="not(property('xxforms:noscript')) and count(tokenize(instance('fr-selection-instance'), '\s+')) != 1"/>
                <xforms:bind nodeset="delete" readonly="not(property('xxforms:noscript')) and count(tokenize(instance('fr-selection-instance'), '\s+')) = 0"/>
            </xforms:bind>

            <xxforms:variable name="parameters" select="xxforms:instance('fr-parameters-instance')"/>

            <xforms:action ev:event="fr-summary-create">
                <xforms:load resource="/fr/{$parameters/app}/{$parameters/form}/new{if (property('xxforms:noscript')) then '?fr-noscript=true' else ''}"/>
            </xforms:action>

            <!-- Currently unused -->
            <!--<xforms:action ev:event="fr-summary-edit">-->
                <!--<xforms:load resource="/fr/{$parameters/app}/{$parameters/form}/edit/{normalize-space(instance('fr-selection-instance'))}/{if (property('xxforms:noscript')) then '?fr-noscript=true' else ''}" xxforms:target="_blank"/>-->
            <!--</xforms:action>-->

            <xforms:action ev:event="fr-summary-view" if="count(tokenize(instance('fr-selection-instance'), '\s+')) = 1">
                <xforms:load resource="/fr/{$parameters/app}/{$parameters/form}/view/{normalize-space(instance('fr-selection-instance'))}{if (property('xxforms:noscript')) then '?fr-noscript=true' else ''}"/>
            </xforms:action>

            <xforms:action ev:event="fr-summary-test">
                <xforms:load resource="/fr/{$parameters/app}/{$parameters/form}/test/{normalize-space(instance('fr-selection-instance'))}{if (property('xxforms:noscript')) then '?fr-noscript=true' else ''}" xxforms:target="_blank" xxforms:show-progress="false"/>
            </xforms:action>

            <xforms:action ev:event="fr-summary-xml">
                <!-- TODO -->
                <!--<xforms:load resource="abc" f:url-type="resource"/>-->
            </xforms:action>

            <!-- Instance to track search results and paging -->
            <xforms:instance id="fr-search-instance">
                <search xmlns="">
                    <!-- Application name -->
                    <app/>
                    <!-- Form name -->
                    <form/>
                    <!-- Free text search query -->
                    <query/>
                    <!-- Paging -->
                    <page-size>5</page-size>
                    <page-number>1</page-number>
                    <!-- Sorting -->
                    <sort-key/>
                    <!-- Language -->
                    <lang/>
                </search>
            </xforms:instance>

            <xforms:bind nodeset="instance('fr-search-instance')">
                <!-- Don't send this to the server -->
                <xforms:bind nodeset="query/@search-field" relevant=". = 'true'"/>
                <!-- Set types so the search fields display the proper controls -->
                <xforms:bind nodeset="query[ends-with(@type, ':date')]" type="xforms:date"/>
                <xforms:bind nodeset="query[ends-with(@type, ':time')]" type="xforms:time"/>
                <xforms:bind nodeset="query[ends-with(@type, ':dateTime')]" type="xforms:dateTime"/>

                <!-- Set default value for app and form if needed -->
                <!-- Do this declaratively so we don't depend on order of execution of submissions -->
                <xforms:bind nodeset="$app-query" readonly="false()"
                             calculate="if (normalize-space() = '' and $initial-app-value) then $initial-app-value else ."/>
                <!-- Adjust value for form if there is an app constraint and a form constraint -->
                <xforms:bind nodeset="$form-query" readonly="false()"
                             calculate="(for $a in xxforms:instance('fr-permissions')/app[@name = $app-query]
                                             return for $current in . return if ($a/form[@name = ($current, '*')]) then .
                                                 else $a/form[1]/@name, .)[1]"/>
                <!-- Force exact query match if there is an app constraint -->
                <xforms:bind nodeset="$app-query/@match" readonly="false()" calculate="if ($initial-app-value) then 'exact' else ."/>
                <!-- Force exact query match if there is a form constraint -->
                <xforms:bind nodeset="$form-query/@match" readonly="false()" calculate="if (xxforms:instance('fr-permissions')/app[@name = $app-query]/form[1][not(@name = '*')]) then 'exact' else ."/>

            </xforms:bind>

            <xforms:instance id="fr-search-template" xxforms:readonly="true">
                <query xmlns="" name="" path="" label="" type="" control="" search-field="" match="substring"/>
            </xforms:instance>

            <!-- Paging information -->
            <xforms:instance id="fr-paging-instance">
                <search xmlns="">
                    <total/>
                    <search-total/>
                    <page-size/>
                    <page-number/>
                    <page-count/>
                    <from>0</from>
                    <to>0</to>
                    <prev-trigger/>
                    <next-trigger/>
                </search>
            </xforms:instance>

            <!-- Calculations for page navigation -->
            <xforms:bind nodeset="instance('fr-paging-instance')">
                <xforms:bind nodeset="total" calculate="(instance('fr-summary-instance')/@total, 0)[1]"/>
                <xforms:bind nodeset="search-total" calculate="(instance('fr-summary-instance')/@search-total, 0)[1]"/>
                <xforms:bind nodeset="page-size" calculate="instance('fr-search-instance')/page-size"/>
                <xforms:bind nodeset="page-number" calculate="instance('fr-search-instance')/page-number"/>
                <xforms:bind nodeset="page-count" calculate="(../search-total + ../page-size - 1) idiv ../page-size"/>
                <xforms:bind nodeset="from" calculate="if (../search-total = 0) then 0 else (../page-number - 1) * ../page-size + 1"/>
                <xforms:bind nodeset="to" calculate="min((../page-number * ../page-size, ../search-total))"/>
                <xforms:bind nodeset="prev-trigger" readonly="../search-total = 0 or xs:integer(../page-number) le 1"/>
                <xforms:bind nodeset="next-trigger" readonly="../search-total = 0 or xs:integer(../search-total) le xs:integer(../to)"/>
            </xforms:bind>

            <xforms:instance id="fr-summary-headers-instance">
                <dummy xmlns=""/>
            </xforms:instance>

            <xforms:instance id="fr-configuration-instance">
                <configuration xmlns=""/>
            </xforms:instance>

            <xforms:instance id="fr-selection-instance">
                <selection xmlns=""/>
            </xforms:instance>

            <!-- Extract summary configuration information from the XHTML document -->
            <!-- TODO: Move back to persistence model? -->
            <xforms:action ev:event="xforms-submit-done" ev:observer="get-source-form-submission">

                <xforms:dispatch name="get-source-form-submission-done" target="fr-form-model"/>

                <xxforms:variable name="summary-elements" as="element()*"
                                  select="xxforms:instance('fr-source-form-instance')/xhtml:body//*[(@ref or @bind) and @class and tokenize(@class, '\s+') = ('fr-summary', 'fr-search')]"/>

                <!-- Extract fields which must appear in the summary -->
                <xforms:insert context="instance('fr-configuration-instance')" nodeset="*" origin="$summary-elements"/>

                <!-- Create elements holding structured search data -->
                <xforms:action xxforms:iterate="$summary-elements">
                    <xxforms:variable name="control" select="." as="element()"/>

                    <!-- Insert empty template -->
                    <xforms:insert context="instance('fr-search-instance')" nodeset="query" origin="instance('fr-search-template')"/>
                    <xxforms:variable name="query" select="instance('fr-search-instance')/query[last()]"/>

                    <!-- Add control information to template -->
                    <xforms:setvalue ref="$query/@control" value="$control/local-name()"/>

                    <!-- Add whether we must show the search field -->
                    <xforms:setvalue ref="$query/@search-field" value="tokenize($control/@class, '\s+') = ('fr-search')"/>

                    <!-- All the control's "ancestor" @ref, @context or @bind -->
                    <xxforms:variable name="all-ancestors" select="$control/ancestor-or-self::*/(@ref | @context | @bind)" as="attribute()*"/>
                    <!-- First control @bind ancestor and its own ancestors with @ref, @context or @bind  -->
                    <xxforms:variable name="bind-ancestors" select="reverse($all-ancestors)[name() = 'bind'][1]/ancestor-or-self::*/(@ref | @context | @bind)" as="attribute()*"/>

                    <!-- All control's ancestors based on a path (@ref or @context) up to the first @bind if any -->
                    <xxforms:variable name="path-ancestors" select="reverse($all-ancestors except $bind-ancestors)" as="attribute()*"/>
                    <!-- First ancestor @bind if any -->
                    <xxforms:variable name="bind-ancestor" select="reverse($bind-ancestors)[1]" as="attribute()?"/>

                    <!-- Add meta-information to template -->
                    <!-- First, try paths -->
                    <xforms:action if="exists($path-ancestors)">
                        <xforms:setvalue ref="$query/@name" value="$path-ancestors[1]"/>
                        <xforms:setvalue ref="$query/@path" value="string-join($path-ancestors, '/')"/>
                    </xforms:action>
                    <!-- Then, try binds -->
                    <xforms:action if="exists($bind-ancestor)">
                        <xxforms:variable name="bind" select="xxforms:instance('fr-source-form-instance')/xhtml:head/xforms:model//xforms:bind[@id = $bind-ancestor]"/>

                        <!-- Set control name if not already done with @ref -->
                        <xforms:setvalue if="empty($path-ancestors)" ref="$query/@name" value="substring-before($bind-ancestor, '-bind')"/>
                        <!-- Prepend path from binds -->
                        <xforms:setvalue ref="$query/@path" value="string-join((($bind/ancestor-or-self::xforms:bind/(@nodeset | @ref))[position() gt 1], if (normalize-space()) then . else ()), '/')"/>

                        <!--<xforms:message level="xxforms:log-info">XXX Bind: <xforms:output value="saxon:serialize($bind, 'xml')"/></xforms:message>-->
                        <!--<xforms:message level="xxforms:log-info">XXX Path: <xforms:output value="$query/@path"/></xforms:message>-->

                        <!-- Copy namespace declarations from form to <query> element -->
                        <!-- Note: Copying namespaces from the xforms:bind is tricky. We can't copy the namespaces nodes, as copying from
                             a tiny tree to dom4j fails. If we copy the element, it doesn't copy nodes that are not used. So we go
                             through serialization/parsing so all the namespaces are copied into the document. -->
                        <xforms:insert context="$query" origin="saxon:parse(saxon:serialize($bind, 'xml'))"/>
                        <xforms:insert context="$query" origin="$query/xforms:bind/namespace::*[local-name() != '']"/>
                        <xforms:delete nodeset="$query/xforms:bind"/>

                        <xforms:setvalue ref="$query/@type" value="if ($bind/@type) then $bind/@type else 'xs:string'"/>
                    </xforms:action>

                    <!-- Compute label information -->
                    <xxforms:variable name="label" select="$control/xforms:label" as="xs:element(xforms:label)*"/>
                    <xxforms:variable name="form-resources" model="fr-resources-model" select="$fr-form-resources" as="element(resource)?"/>
                    <xforms:setvalue ref="$query/@label"
                                     value="if ($label/@ref or $label/@bind) then $form-resources/*[local-name() = $query/@name]/label else $label"/>
                </xforms:action>

            </xforms:action>

            <!-- Summary data -->
            <xforms:instance id="fr-summary-instance">
                <documents xmlns="" total="0" search-total="0">
                    <!-- Content will be like this -->
                    <!--
                    <document name="" created="" last-modified="">
                        <id/>
                        <details>
                            <detail/>
                            <detail/>
                        </details>
                    </document>
                    -->
                </documents>
            </xforms:instance>

            <!-- This submission doesn't validate as we allow sending incomplete date, time and dateTime -->
            <xforms:submission id="search-submission"
                    ref="instance('fr-search-instance')" validate="false"
                    method="post" resource="{xxforms:instance('fr-uris-instance')/data-collection}/search/{$parameters/app}/{$parameters/form}"
                    replace="instance" instance="fr-summary-instance">
                <!-- Set language upon submitting -->
                <xforms:action ev:event="xforms-submit">
                    <xforms:setvalue ref="lang" value="xxforms:instance('fr-language-instance')"/>
                </xforms:action>
                <!-- Handle offline mode -->
                <!--<xxforms:script ev:event="xforms-submit-done">-->
                    <!--if (ORBEON.xforms.Document.isOfflineAvailable()) {-->
                        <!--var noFormDataDiv = ORBEON.util.Dom.get("fr-no-form-data");-->
                        <!--// If the table is empty, skip this-->
                        <!--if (YAHOO.util.Dom.hasClass(noFormDataDiv, "xforms-disabled")) {-->
                            <!--var summaryIndex = 1;-->
                            <!--while (true) {-->
                                <!--// Check if there is an item at this index; otherwise stop.-->
                                <!--var nameControlId = "fr-document-name" + XFORMS_SEPARATOR_1 + summaryIndex;-->
                                <!--if (ORBEON.util.Dom.get(nameControlId) == null) break;-->
                                <!--// Get URL for edit page of this form-->
                                <!--var name = ORBEON.xforms.Document.getValue(nameControlId);-->
                                <!--var url = window.location.href + "/" + name + "/edit";-->
                                <!--// Store in instance if this form is offline or not-->
                                <!--var offlineControlId = "fr-document-offline" + XFORMS_SEPARATOR_1 + summaryIndex;-->
                                <!--var isOffline = ORBEON.xforms.Document.isFormOffline(url);-->
                                <!--ORBEON.xforms.Document.setValue(offlineControlId, isOffline ? "true" : "false");-->
                                <!--summaryIndex++;-->
                            <!--}-->
                        <!--}-->
                    <!--}-->
                <!--</xxforms:script>-->
            </xforms:submission>

        </xforms:model>
    </head>
    <body>
        <!-- Whether this is the summary page for the form builder -->
        <xxforms:variable name="is-form-builder" select="$parameters/app = 'orbeon' and $parameters/form = 'builder'"/>
        <fr:view>
            <xforms:label>Orbeon Form Runner</xforms:label>
            <fr:body>
                <xforms:group appearance="xxforms:internal">
                    <!-- Stop value change propagation so changes in this section of the form don't cause data
                         to become dirty in fr-peristence-model -->
                    <xforms:action ev:event="xforms-value-changed" ev:propagate="stop"/>

                    <xforms:group class="fr-summary-search">

                        <!-- Search also when user presses "enter" in a field -->
                        <xforms:action ev:event="DOMActivate">
                            <!-- Reset search selection and navigation -->
                            <xforms:setvalue ref="instance('fr-selection-instance')" value="''"/>
                            <xforms:setindex repeat="documents-repeat" index="1"/>
                            <xforms:setvalue ref="instance('fr-search-instance')/page-number" value="1"/>

                            <xforms:send submission="search-submission"/>
                        </xforms:action>

                        <xforms:switch>
                            <!-- Free-text search -->
                            <xforms:case id="search-free">
                                <table class="fr-layout-table">
                                    <tr>
                                        <td>
                                            <!-- Search field -->
                                            <xforms:input ref="instance('fr-search-instance')/query" class="fr-search-input"/>
                                        </td>
                                        <td class="fr-search-button-td">
                                            <!-- Search button -->
                                            <fr:button>
                                                <xforms:label>
                                                    <xhtml:img width="16" height="16" src="/apps/fr/style/images/pixelmixer/search_16.png" alt=""/>
                                                    <xforms:output value="$fr-resources/summary/search/search-forms"/>
                                                </xforms:label>
                                            </fr:button>
                                        </td>
                                        <td class="fr-search-options-td">
                                            <!-- Search options -->
                                            <xforms:group ref=".[instance('fr-search-instance')/query[@path and @search-field = 'true']]">
                                                <xforms:trigger appearance="minimal">
                                                    <xforms:label ref="$fr-resources/summary/search/show-options"/>
                                                    <xforms:action ev:event="DOMActivate">
                                                        <xforms:setvalue xxforms:iterate="instance('fr-search-instance')/query" ref="."/>
                                                        <xforms:toggle case="search-options"/>
                                                        <xforms:setfocus control="search-options"/>
                                                    </xforms:action>
                                                </xforms:trigger>
                                            </xforms:group>
                                        </td>
                                    </tr>
                                </table>
                            </xforms:case>
                            <!-- Search options -->
                            <xforms:case id="search-options">
                                <xhtml:div class="fr-search-options-div">
                                    <xhtml:div class="fr-search-options-title">Search Options</xhtml:div>
                                    <!-- Special form builder search: use input or select1 for app/form name -->
                                    <xforms:group ref=".[$is-form-builder and $has-roles]">
                                        <div class="fr-summary-search-item">
                                            <!-- Application -->
                                            <xforms:group ref="$app-query">
                                                <xxforms:variable name="label" select="@label" as="xs:string"/>
                                                <!-- Use an input if app name is a wildcard -->
                                                <xxforms:variable name="is-input" select="xxforms:instance('fr-permissions')/app[@name = '*']" as="xs:boolean"/>
                                                <xforms:input ref=".[$is-input]">
                                                    <xforms:label>
                                                        <xforms:output value="$label"/>
                                                    </xforms:label>
                                                </xforms:input>
                                                <xforms:select1 ref=".[not($is-input)]">
                                                    <xforms:label>
                                                        <xforms:output value="$label"/>
                                                    </xforms:label>
                                                    <xforms:itemset model="fr-roles-model" nodeset="instance('fr-permissions')/app">
                                                        <xforms:label ref="@name"/>
                                                        <xforms:value ref="@name"/>
                                                    </xforms:itemset>

                                                    <xforms:action ev:event="xforms-value-changed">
                                                        <!-- Clear dependent form, actual value is recalculated just before submission if needed -->
                                                        <xforms:setvalue ref="$form-query"/>

                                                        <!-- Reset search selection and navigation -->
                                                        <xforms:setvalue ref="instance('fr-selection-instance')" value="''"/>
                                                        <xforms:setindex repeat="documents-repeat" index="1"/>
                                                        <xforms:setvalue ref="instance('fr-search-instance')/page-number" value="1"/>

                                                        <xforms:send submission="search-submission"/>
                                                    </xforms:action>
                                                </xforms:select1>
                                            </xforms:group>
                                        </div>
                                        <div class="fr-summary-search-item">
                                            <!-- Form -->
                                            <xforms:group ref="$form-query">
                                                <xxforms:variable name="label" select="@label" as="xs:string"/>
                                                <xxforms:variable name="current-app" select="xxforms:instance('fr-permissions')/app[@name = $app-query]"/>
                                                <!-- Use an input if app name or form name is a wildcard -->
                                                <xxforms:variable name="is-input" select="xxforms:instance('fr-permissions')/app/@name = '*' or $current-app/form[@name = '*']" as="xs:boolean"/>
                                                <xforms:input ref=".[$is-input]">
                                                    <xforms:label>
                                                        <xforms:output value="$label"/>
                                                    </xforms:label>
                                                </xforms:input>
                                                <xforms:select1 ref=".[not($is-input)]">
                                                    <xforms:label>
                                                        <xforms:output value="$label"/>
                                                    </xforms:label>
                                                    <xforms:itemset nodeset="$current-app/form">
                                                        <xforms:label ref="@name"/>
                                                        <xforms:value ref="@name"/>
                                                    </xforms:itemset>

                                                    <!-- Update search results when selection changes -->
                                                    <xforms:action ev:event="xforms-value-changed">
                                                        <!-- Reset search selection and navigation -->
                                                        <xforms:setvalue ref="instance('fr-selection-instance')" value="''"/>
                                                        <xforms:setindex repeat="documents-repeat" index="1"/>
                                                        <xforms:setvalue ref="instance('fr-search-instance')/page-number" value="1"/>

                                                        <xforms:send submission="search-submission"/>
                                                    </xforms:action>
                                                </xforms:select1>
                                            </xforms:group>
                                        </div>
                                    </xforms:group>
                                    <!-- Structured search over query terms that have search-field set to 'true' -->
                                    <xforms:repeat nodeset="instance('fr-search-instance')/query[@path and @search-field = 'true']" id="search-repeat">
                                        <xxforms:variable name="control-name" select="@name"/>
                                        <div class="fr-summary-search-item">
                                            <xxforms:variable name="label" select="@label"/>

                                            <xforms:group ref=".[not($is-form-builder and $has-roles and (contains(@path, 'application-name') or contains(@path, 'form-name')))]">
                                                <!-- Regular search field (exclude app/form name if we are Form Builder and we have roles) -->

                                                <!-- input -->
                                                <xforms:input ref=".[@control = ('input', 'inplace-input')]">
                                                    <xforms:label>
                                                        <xforms:output value="$label"/>
                                                    </xforms:label>
                                                </xforms:input>
                                                <!-- textarea -->
                                                <xforms:input ref=".[@control = 'textarea']">
                                                    <xforms:label>
                                                        <xforms:output value="$label"/>
                                                    </xforms:label>
                                                </xforms:input>
                                                <!-- select1 -->
                                                <xforms:select1 ref=".[@control = 'select1']">
                                                    <xforms:label>
                                                        <xforms:output value="$label"/>
                                                    </xforms:label>
                                                    <xforms:item>
                                                        <xforms:label ref="$fr-resources/summary/labels/any"/>
                                                        <xforms:value/>
                                                    </xforms:item>
                                                    <xforms:itemset model="fr-persistence-model"
                                                                    nodeset="$form-resources/*[local-name() = $control-name]/item"
                                                                    xxforms:refresh-items="false">
                                                        <xforms:label ref="label"/>
                                                        <xforms:value ref="value"/>
                                                    </xforms:itemset>
                                                </xforms:select1>
                                            </xforms:group>
                                        </div>
                                    </xforms:repeat>
                                    <xhtml:div class="fr-search-options-buttons">
                                        <!-- Search button -->
                                        <fr:button>
                                            <xforms:label>
                                                <!--<xhtml:img width="10" height="14" src="/apps/fr/style/search.gif" alt=""/>-->
                                                <xhtml:img width="16" height="16" src="/apps/fr/style/images/pixelmixer/search_16.png" alt=""/>
                                                <xforms:output value="$fr-resources/summary/search/search-forms"/>
                                            </xforms:label>
                                        </fr:button>
                                        <!-- Close search options -->
                                        <xforms:trigger appearance="minimal">
                                            <xforms:label ref="$fr-resources/summary/search/close-options"/>
                                            <xforms:action ev:event="DOMActivate">
                                                <xforms:setvalue xxforms:iterate="instance('fr-search-instance')/query" ref="."/>
                                                <xforms:toggle case="search-free"/>
                                                <xforms:setfocus control="search-free"/>
                                            </xforms:action>
                                        </xforms:trigger>
                                    </xhtml:div>
                                </xhtml:div>
                            </xforms:case>
                        </xforms:switch>

                        <div class="fr-clear"/>
                    </xforms:group>

                    <xforms:group ref="instance('fr-summary-instance')" xxforms:update="full">

                        <!-- Stop propagation of all the UI events here because we don't care about validity and visited properties -->
                        <xforms:action ev:event="#all" ev:propagate="stop"/>

                        <xforms:group ref="instance('fr-paging-instance')[search-total != total]" class="fr-summary-search-count">
                            <xforms:output value="$fr-resources/summary/search/returned-1"/>
                            <xforms:output value="instance('fr-paging-instance')/search-total"/>
                            <xforms:output value="$fr-resources/summary/paging/of"/>
                            <xforms:output value="instance('fr-paging-instance')/total"/>
                            <xforms:output value="$fr-resources/summary/search/returned-2"/>
                        </xforms:group>

                        <xxforms:variable name="show-created" select="xxforms:property(string-join(('oxf.fr.summary.show-created', $app, $form), '.'))"/>
                        <xxforms:variable name="show-last-modified" select="xxforms:property(string-join(('oxf.fr.summary.show-last-modified', $app, $form), '.'))"/>

                        <div class="fr-summary-table-div">
                            <fr:datatable scrollable="horizontal" width="940px">
                                <!-- scrollable="horizontal" width="940px" -->
                                <thead>
                                    <tr>
                                        <th fr:sortable="false" class="fr-summary-repeat-selection-checkbox"/>
                                        <th fr:sortable="false" class="fr-summary-repeat-column-number" fr:resizeable="true">
                                            <xforms:output value="$fr-resources/summary/titles/row-number"/>
                                        </th>
                                        <xforms:repeat nodeset="if ($show-created) then . else ()">
                                            <th fr:sortable="false" fr:resizeable="true">
                                                <xforms:output value="$fr-resources/summary/titles/created"/>
                                            </th>
                                        </xforms:repeat>
                                        <xforms:repeat nodeset="if ($show-last-modified) then . else ()">
                                            <th fr:sortable="false" fr:resizeable="true">
                                                <xforms:output value="$fr-resources/summary/titles/last-modified"/>
                                            </th>
                                        </xforms:repeat>
                                        <!-- Iterate through specially marked controls and derive resource id then resource -->
                                        <xforms:repeat nodeset="instance('fr-configuration-instance')/*[tokenize(@class, '\s+') = 'fr-summary']" id="fr-summary-repeat-column-number">
                                            <th fr:sortable="false" fr:resizeable="true">
                                                <!-- Output showing as the header of the column -->
                                                <xforms:output value="
                                                    for
                                                        (: Current node is a control, such as xforms:input :)
                                                        $control-info in .,
                                                        (: Control has id='title-control', $resource-id = 'title' :)
                                                        $resource-id in substring-before($control-info/@id, '-control'),
                                                        (: Find resource for control id; will be empty string if node found :)
                                                        $resource in ($form-resources/*[local-name() = $resource-id], '')[1]
                                                    return
                                                        (: If we found a resource, use its label :)
                                                        if ($resource instance of element()) then $resource/label
                                                        (: If no resource is found, try to use the inline label :)
                                                        else if (normalize-space($control-info/xforms:label) != '') then $control-info/xforms:label
                                                        (: If everything fails, display the name of the control between brakets :)
                                                        else concat('[', $resource-id, ']')"/>
                                            </th>
                                        </xforms:repeat>
                                    </tr>
                                </thead>
                                <tbody>
                                    <xforms:repeat nodeset="document" id="documents-repeat">
                                        <!-- 1-based position in the current page -->
                                        <xxforms:variable name="position" select="position()" as="xs:integer"/>
                                        <!-- 1-based position in the entire result set -->
                                        <xxforms:variable name="document-number" select="instance('fr-paging-instance')/from + $position - 1" as="xs:integer"/>

                                        <!-- Document name and href for edition -->
                                        <xxforms:variable name="document-name" select="@name" as="xs:string"/>
                                        <xxforms:variable name="document-href" select="concat('/fr/', $parameters/app, '/', $parameters/form, '/edit/',
                                                $document-name, if (property('xxforms:noscript')) then '?fr-noscript=true' else '')"/>

                                        <tr class="{if (tokenize(instance('fr-selection-instance'), '\s+') = $document-name) then 'fr-summary-row-selected' else 'fr-summary-row-not-selected'}">
                                            <td class="fr-summary-repeat-selection-checkbox">
                                                <xforms:select appearance="full" ref="instance('fr-selection-instance')" id="document-selection">
                                                    <xforms:item>
                                                        <xforms:label/>
                                                        <xforms:value value="$document-name"/>
                                                    </xforms:item>
                                                </xforms:select>
                                            </td>
                                            <td class="fr-summary-repeat-column-number">
                                                <xhtml:a href="{$document-href}" target="_blank">
                                                    <xforms:output value="$document-number"/>
                                                </xhtml:a>
                                            </td>
                                            <xforms:repeat nodeset="if ($show-created) then @created else ()">
                                                <td>
                                                    <xhtml:a href="{$document-href}" target="_blank">
                                                        <xforms:output value="if (. castable as xs:dateTime) then format-dateTime(xs:dateTime(.), $fr-resources/summary/formats/save-datetime, xxforms:instance('fr-language-instance'), (), ()) else ."/>
                                                    </xhtml:a>
                                                </td>
                                            </xforms:repeat>
                                            <xforms:repeat nodeset="if ($show-last-modified) then @last-modified else ()">
                                                <td>
                                                    <xhtml:a href="{$document-href}" target="_blank">
                                                        <xforms:output value="if (. castable as xs:dateTime) then format-dateTime(xs:dateTime(.), $fr-resources/summary/formats/save-datetime, xxforms:instance('fr-language-instance'), (), ()) else ."/>
                                                    </xhtml:a>
                                                </td>
                                            </xforms:repeat>
                                            <!-- One column for each detail -->
                                            <xforms:repeat nodeset="details/detail" id="document-details-repeat">
                                                <td>
                                                    <xhtml:a href="{$document-href}" target="_blank">
                                                        <!-- NOTE: Doing everything in a single big output XPath expression has the benefit of producing much less markup -->
                                                        <xforms:output value="
                                                            for $detail-position in position() return
                                                                for $query in instance('fr-search-instance')/query[$detail-position + 1] return
                                                                    for $control in $query/@control return
                                                                        if ($control = 'textarea') then
                                                                            if (string-length(.) > 20) then concat(substring(., 1, 20), '...') else .
                                                                        else if ($control = 'select') then
                                                                            string-join(for $v in tokenize(., '\s+') return $form-resources/*[local-name() = $query/@name]/item[value = $v]/label, ', ')
                                                                        else if ($control = 'select1') then
                                                                            for $v in . return $form-resources/*[local-name() = $query/@name]/item[value = $v]/label
                                                                        else
                                                                            for $type in substring-after($query/@type, ':') return
                                                                                if ($type = 'date') then
                                                                                    (if (. castable as xs:date) then format-date(xs:date(.), $fr-resources/summary/formats/date, xxforms:instance('fr-language-instance'), (), ()) else .)
                                                                                else if ($type = 'time') then
                                                                                    (if (. castable as xs:time) then format-time(xs:time(.), $fr-resources/summary/formats/time, xxforms:instance('fr-language-instance'), (), ()) else .)
                                                                                else if ($type = 'dateTime') then
                                                                                    (if (. castable as xs:dateTime) then format-dateTime(xs:dateTime(.), $fr-resources/summary/formats/dateTime, xxforms:instance('fr-language-instance'), (), ()) else .)
                                                                                else if ($type = 'dayTimeDuration') then
                                                                                    (
                                                                                        if (. castable as xs:dayTimeDuration) then
                                                                                            string-join(
                                                                                                (
                                                                                                    if (days-from-duration(.) = 0) then () else concat(days-from-duration(.), ' d'),
                                                                                                    if (hours-from-duration(.) = 0) then () else concat(hours-from-duration(.), ' h'),
                                                                                                    if (minutes-from-duration(.) = 0) then () else concat(minutes-from-duration(.), ' min'),
                                                                                                    if (seconds-from-duration(.) = 0) then () else concat(seconds-from-duration(.), ' sec')
                                                                                                 ), ' '
                                                                                            )
                                                                                        else .
                                                                                    )
                                                                                else ."/>
                                                    </xhtml:a>
                                                </td>
                                            </xforms:repeat>
                                        </tr>
                                    </xforms:repeat>
                                    <xforms:group ref=".[not(document)]">
                                        <tr>
                                            <td colspan="{4 + count(instance('fr-configuration-instance')/*[tokenize(@class, '\s+') = 'fr-summary'])}">
                                                <xforms:output id="fr-no-form-data" mediatype="text/html" value="saxon:serialize($fr-resources/summary/messages/no-form-found/node(), 'html')"/>
                                            </td>
                                        </tr>
                                    </xforms:group>
                                </tbody>
                            </fr:datatable>
                        </div>

                        <div class="fr-paging-buttons">
                            <xforms:trigger ref="instance('fr-paging-instance')/prev-trigger" appearance="minimal">
                                <xforms:label>
                                    <xhtml:img width="16" height="16" src="/apps/fr/style/images/silk/resultset_first.png" alt="First" title="First"/>
                                    <!--<xhtml:span><xforms:output value="$fr-resources/summary/labels/first"/></xhtml:span>-->
                                </xforms:label>
                                <xforms:action ev:event="DOMActivate">
                                    <xforms:setvalue ref="instance('fr-search-instance')/page-number" value="1"/>
                                    <xforms:setindex repeat="documents-repeat" index="1"/>
                                    <xforms:send submission="search-submission"/>
                                </xforms:action>
                            </xforms:trigger>

                            <xforms:trigger ref="instance('fr-paging-instance')/prev-trigger" appearance="minimal">
                                <xforms:label>
                                    <xhtml:img width="16" height="16" src="/apps/fr/style/images/silk/resultset_previous.png" alt="Previous" title="Previous"/>
                                    <!--<xhtml:span><xforms:output value="$fr-resources/summary/labels/previous"/></xhtml:span>-->
                                </xforms:label>
                                <xforms:action ev:event="DOMActivate">
                                    <xforms:setvalue ref="instance('fr-search-instance')/page-number" value=". - 1"/>
                                    <xforms:setindex repeat="documents-repeat" index="1"/>
                                    <xforms:send submission="search-submission"/>
                                </xforms:action>
                            </xforms:trigger>

                            <xforms:group class="fr-paging-numbers" ref=".[xs:integer(instance('fr-paging-instance')/search-total) gt 0]">
                                <!-- Some results -->
                                <xforms:output value="max((instance('fr-paging-instance')/from, 0))"/>
                                <xforms:output value="$fr-resources/summary/paging/to"/>
                                <xforms:output value="max((instance('fr-paging-instance')/to, 0))"/>
                                <xforms:output value="$fr-resources/summary/paging/of"/>
                                <xforms:output value="instance('fr-paging-instance')/search-total"/>
                            </xforms:group>
                            <xforms:group class="fr-paging-numbers" ref=".[xs:integer(instance('fr-paging-instance')/search-total) = 0]">
                                <!-- No results -->
                            </xforms:group>

                            <xforms:trigger ref="instance('fr-paging-instance')/next-trigger" appearance="minimal">
                                <xforms:label>
                                    <!--<xhtml:span><xforms:output value="$fr-resources/summary/labels/next"/></xhtml:span>-->
                                    <xhtml:img width="16" height="16" src="/apps/fr/style/images/silk/resultset_next.png" alt="Next" title="Next"/>
                                </xforms:label>
                                <xforms:action ev:event="DOMActivate">
                                    <xforms:setvalue ref="instance('fr-search-instance')/page-number" value=". + 1"/>
                                    <xforms:setindex repeat="documents-repeat" index="1"/>
                                    <xforms:send submission="search-submission"/>
                                </xforms:action>
                            </xforms:trigger>

                            <xforms:trigger ref="instance('fr-paging-instance')/next-trigger" appearance="minimal">
                                <xforms:label>
                                    <!--<xhtml:span><xforms:output value="$fr-resources/summary/labels/last"/></xhtml:span>-->
                                    <xhtml:img width="16" height="16" src="/apps/fr/style/images/silk/resultset_last.png" alt="Last" title="Last"/>
                                </xforms:label>
                                <xforms:action ev:event="DOMActivate">
                                    <xforms:setvalue ref="instance('fr-search-instance')/page-number" value="instance('fr-paging-instance')/page-count"/>
                                    <xforms:setindex repeat="documents-repeat" index="1"/>
                                    <xforms:send submission="search-submission"/>
                                </xforms:action>
                            </xforms:trigger>
                        </div>

                    </xforms:group>
                </xforms:group>

            </fr:body>
            <fr:bottom>
                <!-- Custom buttons for the summary page -->
                <xforms:group model="fr-form-model" class="fr-buttons">
                    <!-- Directly iterate over the tokenized property -->
                    <xforms:repeat ref="tokenize(xxforms:property(string-join(('oxf.fr.summary.buttons', $app, $form), '.')), '\s+')">
                        <xhtml:span class="fr-button">
                            <!-- New button -->
                            <xforms:group ref="if (. = 'new') then instance('fr-summary-triggers-instance')/new else ()">
                                <fr:button ref=".">
                                    <xforms:label>
                                        <!--<xhtml:img src="/apps/fr/style/add.gif" alt=""/>-->
                                        <xhtml:img width="16" height="16" src="/apps/fr/style/images/pixelmixer/plus_16.png" alt=""/>
                                        <xhtml:span><xforms:output ref="$fr-resources/summary/labels/new-form"/></xhtml:span>
                                    </xforms:label>
                                    <!-- TODO: add hints to buttons -->
                                    <!--<xforms:hint>Create a new form</xforms:hint>-->
                                    <xforms:dispatch ev:event="DOMActivate" target="fr-form-model" name="fr-summary-create"/>
                                </fr:button>
                            </xforms:group>
                            <!-- Print button -->
                            <xforms:group ref="if (. = 'print') then instance('fr-summary-triggers-instance')/view else ()">
                                <fr:button ref=".">
                                    <xforms:label>
                                        <xhtml:img width="16" height="16" src="/apps/fr/style/images/silk/eye.png" alt=""/>
                                        <xhtml:span><xforms:output value="$fr-resources/detail/labels/review"/></xhtml:span>
                                        <!--<xhtml:img src="/apps/fr/style/report.gif" alt="Print"/>-->
                                        <!--<xhtml:span><xforms:output value="$fr-resources/detail/labels/print"/></xhtml:span>-->
                                    </xforms:label>
                                    <xforms:action ev:event="DOMActivate">
                                        <!-- Assertion: only one document selected -->
                                        <!--<xforms:setindex repeat="documents-repeat" index="instance('fr-selection-instance')"/>-->
                                        <xforms:dispatch target="fr-form-model" name="fr-summary-view"/>
                                    </xforms:action>
                                </fr:button>
                            </xforms:group>
                            <!-- PDF button -->
                            <xforms:group ref="if (. = 'pdf') then instance('fr-summary-triggers-instance')/pdf else ()">

                                <!-- Create the link so that the URL gets rewritten -->
                                <xhtml:a style="display:none" class="fr-summary-pdf-anchor" target="_blank" f:url-type="resource"
                                         href="/fr/{$parameters/app}/{$parameters/form}/pdf/{tokenize(normalize-space(instance('fr-selection-instance')), '\s+')[1]}?fr-language={xxforms:instance('fr-language-instance')}"/>

                                <!-- In script mode, intercept client-side click and open window directly -->
                                <xxforms:script ev:event="xforms-enabled" ev:target="#observer">
                                    var button = ORBEON.util.Dom.getElementsByName(this, "button")[0];
                                    YAHOO.util.Event.addListener(button, "click", function(_dummy, group) {
                                        var a = YAHOO.util.Dom.getElementsByClassName("fr-summary-pdf-anchor", null, group)[0];
                                        window.open(a.href, a.target)
                                    }, this);
                                </xxforms:script>

                                <fr:button ref=".">
                                    <xforms:label>
                                        <xhtml:img width="16" height="16" src="/apps/fr/style/pdf.png" alt=""/>
                                        <xhtml:span><xforms:output value="$fr-resources/detail/labels/print-pdf"/></xhtml:span>
                                    </xforms:label>

                                    <!-- Only call submission directly in noscript mode and if only one document selected -->
                                    <xforms:action ev:event="DOMActivate"
                                                   if="property('xxforms:noscript')and count(tokenize(instance('fr-selection-instance'), '\s+')) = 1">
                                        <xforms:load resource="/fr/{$parameters/app}/{$parameters/form}/pdf/{tokenize(normalize-space(instance('fr-selection-instance')), '\s+')[1]}?fr-language={xxforms:instance('fr-language-instance')}"
                                                     xxforms:show-progress="false" f:url-type="resource"/>
                                    </xforms:action>
                                </fr:button>
                            </xforms:group>
                            <!-- Test button -->
                            <xforms:group ref="if (. = 'test') then instance('fr-summary-triggers-instance')/view else ()">
                                <fr:button ref=".">
                                    <xforms:label>
                                        <xhtml:img width="16" height="16" src="/forms/orbeon/builder/images/play.png" alt="" title="Test Form"/>
                                        <xhtml:span>Test</xhtml:span>
                                    </xforms:label>
                                    <xforms:action ev:event="DOMActivate">
                                        <!-- Assertion: only one document selected -->
                                        <!--<xforms:setindex repeat="documents-repeat" index="instance('fr-selection-instance')"/>-->
                                        <xforms:dispatch target="fr-form-model" name="fr-summary-test"/>
                                    </xforms:action>
                                </fr:button>
                            </xforms:group>
                            <!-- Delete button -->
                            <xforms:group ref="if (. = 'delete') then instance('fr-summary-triggers-instance')/delete else ()">
                                <fr:button ref=".">
                                    <xforms:label>
                                        <xhtml:img width="16" height="16" src="/apps/fr/style/images/pixelmixer/delete_16.png" alt=""/>
                                        <xhtml:span><xforms:output ref="$fr-resources/summary/labels/delete-form"/></xhtml:span>
                                    </xforms:label>
                                    <!-- Open delete confirmation dialog -->
                                    <xforms:dispatch ev:event="DOMActivate" name="fr-show" targetid="delete-confirmation-dialog"/>
                                </fr:button>
                            </xforms:group>
                        </xhtml:span>
                    </xforms:repeat>
                </xforms:group>

                <!-- Delete confirmation dialog -->
                <fr:alert-dialog id="delete-confirmation-dialog">
                    <fr:label ref="$fr-resources/summary/labels/delete-form"/>
                    <fr:message><xforms:output value="$fr-resources/summary/messages/delete-confirmation"/></fr:message>
                    <fr:negative-choice/>
                    <fr:positive-choice>
                        <xforms:action ev:event="DOMActivate">
                            <!-- Parse the selected rows -->
                            <xforms:action xxforms:iterate="tokenize(instance('fr-selection-instance'), '\s+')">
                                <xxforms:variable name="document-name" select="." as="xs:string"/>
                                <xforms:dispatch name="fr-delete-data" target="fr-persistence-model">
                                    <xxforms:context name="document-id" select="$document-name"/>
                                </xforms:dispatch>
                            </xforms:action>
                            <!-- Reset search selection and navigation -->
                            <xforms:setvalue ref="instance('fr-selection-instance')" value="''"/>
                            <xforms:setindex repeat="documents-repeat" index="1"/>
                            <xforms:setvalue ref="instance('fr-search-instance')/page-number" value="1"/>
                            <!-- Update search -->
                            <xforms:send submission="search-submission"/>
                        </xforms:action>
                    </fr:positive-choice>
                </fr:alert-dialog>
            </fr:bottom>
        </fr:view>
    </body>
</html>
