// Copyright (C) 2010 Orbeon, Inc.
//
// This program is free software; you can redistribute it and/or modify it under the terms of the
// GNU Lesser General Public License as published by the Free Software Foundation; either version
// 2.1 of the License, or (at your option) any later version.
//
// This program is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY;
// without even the implied warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.
// See the GNU Lesser General Public License for more details.
//
// The full text of the license is available at http://www.gnu.org/copyleft/lesser.html

@import (reference) "../../../../../../../../../bootstrap-src/less/variables";
@import (reference) "../../../../../../../../../form-runner/jvm/src/main/assets/apps/fr/style/form-runner-common";

@fbGutter: 10px;
@fbToolbarWidth: 208px;
@fbBottomHeight: 54px;
@fbGridIconsGutter: 22px;
@fbIconsHeight: 16px;
@fbGridRowMinHeight: 66px;

// Retro Summer #2 Color Scheme
@color1: #FFEA48; // Gargoyle Gas
@color2: #FABB01; // Selective Yellow
@color3: #F25930; // Portland Orange
@color4: #0B3D6F; // Ateneo Blue
@color5: #0081C7; // NCS Blue
@color6: #48BCD7; // Sea Serpent

@wallAccentLight:  @color2;
@wallAccentBright: @color3;
@cellHighlight: @color5;
@explanatoryTextShadow: rgba(0, 123, 255, 25%);

@fbButtonsBackground: white; // so that the borderless buttons look good

// Case of non-embedded Form Builder: size body to take the whole viewport
body.orbeon {
    position: absolute;
    left: 0;
    top: 0;
    width: 100vw;
    height: 100vh;
    box-sizing: border-box;
    background-color: @grayLight;
}

// Case of embedded Form Builder: size with some defaults (expecting that the embedding code will override this)
.orbeon.orbeon-portlet-div {
    position: absolute;
    left: 1vw;
    top: 50px;
    width: 98vw;
    bottom: 1vh;
    box-sizing: border-box;
    border: 1px solid @grayLight;
    background-color: @grayLight;

    // Reset general embedding styles
    .navbar.navbar-fixed-top {
        position: absolute;
        .navbar-inner {
            border-radius: 0;
        }
    }

    .fr-summary-button, .fr-new-button {
        display: none;
    }
}

.orbeon {

    .fb-main {
        position: absolute;
        top: 48px + @fbGutter;
        right: @fbGutter;
        left: @fbGutter + @fbToolbarWidth + @fbGutter/2;                    // Half of the space between toolbox and main is on the toolbox, other half is on the padding, for non-OS X scrollbars
        bottom: @fbBottomHeight + @fbGutter;
        overflow-y: auto;
        border-radius: @baseBorderRadius;

        .fb-main-inner {
            background-color: @wellBackground;
            box-sizing: border-box;
            margin-bottom: 0;
            min-width: 740px;                                               // To allow for fluidity but not "too small" (was 980px)
            min-height: 100%;                                               // So the main area uses all the available space, not revealing a large portion of the background

            .container-fluid {
                padding: 0 40px;                                            // Additional padding on the sides, to leave space for icons
            }
        }
    }

    .fb-body {
        margin-bottom: 10px;
    }

    .fb-bottom {
        z-index: @zindexFixedNavbar;                                        // put in front like the navbar
        background-color: @fbButtonsBackground;
    }

    .fb-messages { display: none; }                                         // Section of the HTML we use to output localized text used by client-side code

    .fb-section-grid-editor,
    .fb-control-editor-left,
    .fb-control-editor-right,
    .fb-control-editor-top,
    .fb-row-editor {
        position: absolute; top: 0; left: 0;                                // Its left/right in the browser relative to the current section
        display: none;                                                      // Shown in code when mouse over section
        i:not([class ~= 'disabled']) { cursor: pointer }                    // Non-disabled icons are clickable
    }

    .fb-section-grid-editor,
    .fb-control-editor-left,
    .fb-control-editor-right {

        &> div {
            display: flex;
            flex-direction: column;
            align-items: baseline;
            margin-top: 2px;

            .fa {
                height: 16px;
                padding: 1px;
            }
        }

        // Zoom effect on icons
        .fa:not([class ~= 'disabled']):hover {

            &::before {
                font-size: 120%;
                transition: all ease 100ms;
            }

            transition: all ease 100ms;
        }
    }

    .fb-section-grid-editor,
    .fb-row-editor {
        .fa {
            width: 18px;
        }
    }

    .fb-control-editor-left,
    .fb-control-editor-right,
    .fb-control-editor-top {
        .fa {
            height: 16px;
            font-size: 14px;
        }
    }

    .fb-section-grid-editor {
        padding-right: 10px;                                                // Space between icons and section
    }
    .fb-control-editor-left {
        padding-left:  4px;
        padding-top: 0;
    }
    .fb-control-editor-right {
        padding-right: 4px;
        padding-top: 0;
    }

    .fb-control-editor-top {
        box-sizing: border-box;
        z-index: 1;
        //transform: rotate(-3deg); // experiment to visually clarify that this is overlay information
        div {
            display: block;
            margin-left: 4px;
            margin-bottom: 6px;
            padding: 4px 8px;
            //background-color: rgba(red(@color1), green(@color1), blue(@color1), 75%);
            //background-color: rgba(red(@color6), green(@color6), blue(@color6), 75%);
            background-color: rgba(255, 255, 255, 75%);
            border: 2px solid @cellHighlight;
            border-radius: @baseBorderRadius;
        }
    }

    .fb-control-editor-left {
        .fb-x-split { transform: rotate(135deg) }                           // Default icon is tilted at a 45º angle
        .fb-y-split { transform: rotate(45deg)  }
        .fb-x-split { position: relative; left: -1px; top: -4px }           // Adjustments
    }

    .fb-section-label-editor-click-interceptor {                            // Shown on top of each section label to avoid click → collapse
        position: absolute;                                                 // Is left/right set in code relative to the current section label
        cursor: pointer;
        font-size: 18px;                                                    // Matching the title font size
        line-height: 36px;                                                  // So text is vertically centered
        color: #BBB;                                                        // Light gray denoting hint
        font-family: @frBaseFontFamily;                                     // Matching font defined by Bootstrap for titles
        z-index: 1;                                                         // Show on top of the page (default is 0)
    }

    .fb-edit-section-label {                                                // Input created dynamically to edit section label
        position: absolute;
        z-index: 2;                                                         // Display on top of click interceptor
        box-sizing: border-box;                                             // Makes relative sizing easier
        font-size: @frSectionTitleHeight;
    }

    h2.fr-section-title.hover {                                               // .hover added by CS on mouse over click interceptor
        #gradient > .vertical(#ddd, #ddd);
    }

    .fb-delete-grid-trigger {
        position: absolute;                                                 // Its left/right set in JS relative to the current grid
        display: none;                                                      // Shown in JS when mouse over grid
        padding: 0;                                                         // Space between icons and grid, and at top/left in case the mouse moves a bit out
    }

    .fr-view .fr-section-container .fr-grid.fr-editable {                   // Tons of classes to take precedence over FR styling
        .fr-grid-td, .fr-grid-th {

            // See https://github.com/orbeon/orbeon-forms/issues/3616
            // See grid.xbl comment. We only do this at design-time for now.
            .fr-grid-th, .fr-grid-td {
                overflow-x: hidden;                                         // We don't want large content to change the size of the cells
            }

            &:hover {
                .xforms-label, .xforms-hint, .xforms-text .xforms-output-output {
                    &:empty:before {
                        content: attr(placeholder);
                        color: #bbb;
                        font-size: 100%;                                   // Override the larger size set by Form Runner for the `*`
                    }
                }
            }
        }
        .xforms-label {
            display: block;                                                 // Overrides display: table set by Form Runner
            .fb-edit-label-html {
                float: right;                                               // Checkbox to the right of the input
                width: auto;                                                // Undos the width: 100%
                margin: 0 0 0 5px;                                          // Space between input and checkbox
            }
            .fb-edit-label {
                display: block;
                overflow: hidden;                                           // For the box not to go "under" the checkbox, so the input can be width: 100%
            }
        }
    }

    .fb-ie-warning {}

    .fb-nowrap { white-space: nowrap }
    .fb-hide-alert .xforms-visited > .xforms-alert.xforms-active { display: none }


    // ***** D&D *******************************************************************************************************

    // Change mouse pointer when over "move" icon, as an additional hint
    .fr-body
    .fb-control-editor-right
    .fb-control-handle {
        cursor: grab;
        cursor: -webkit-grab; // Chrome 49 and Safari 10 still don't support the un-prefixed `grab`
    }

    // Hide the icons while the control moved
    .gu-mirror, .gu-transit, .gu-unselectable {
        .fb-control-editor-left, .fb-control-editor-right, .fb-control-editor-top {
            * { display: none }
        }
    }

    // Highlight the grid cell when dragging over
    .fb-main .fr-grid-td:has(.gu-transit) {
        background-color: #ccc;
    }

    // Use copy or move cursor during D&D
    .gu-mirror.fb-dnd-copy { cursor: copy; cursor: -webkit-copy }
    .gu-mirror.fb-dnd-move { cursor: move; cursor: -webkit-move }
    // So the cursor is inside the element, and picking the cursor works
    .gu-mirror { padding-right: 24px }

    .fb-grid-dnd-wall-container {

        &.fb-grid-dnd-wall-vertical   { width : 8px }
        &.fb-grid-dnd-wall-horizontal { height: 8px }

        position: absolute;
        background-color: @wallAccentLight;
        &:hover                 { background-color: @wallAccentBright }         // Cue container can be grabbed
        &.fb-grid-dnd-wall-drop { background-color: @wallAccentBright }         // On drop, wall will be moved here

        .fb-grid-dnd-wall-handle {
            height: 100%;
        }
        z-index: 2;                                                         // For containers to be above the shadow
    }

    .fb-grid-dnd-wall-vertical   .fb-grid-dnd-wall-handle { cursor: col-resize }
    .fb-grid-dnd-wall-horizontal .fb-grid-dnd-wall-handle { cursor: row-resize }

    .fb-grid-dnd-wall-veil {
        z-index: 1;                                                         // Veil prevents hover on elements in the grid during D&D
        position: absolute;                                                 // So it takes no space on the page
    }
    .fb-grid-dnd-wall-shadow {
        position: absolute;
        background-color: #ccc;
        z-index: 1;                                                         // For shadow to be above controls
    }

    // D&D from the toolbox
    .fb-main .fr-grid-td .gu-transit.fb-tool {
        width: 100%;
        height: 100%;
        text-align: center;
        padding-top: 1.5em;
    }

    .fb-toolbox .fb-tool .fb-add-control button {
        cursor: grab;
    }

    // ***** Toolbox ***************************************************************************************************

    .fb-toolbox {
        position: absolute;
        left: @fbGutter;
        top: 48px + @fbGutter;
        bottom: @fbBottomHeight + @fbGutter;
        width: @fbToolbarWidth;
        box-sizing: border-box;

        .fb-toolbox-inside {
            width: 100%;
            height: 100%;
            padding: 0 @fbGutter/2 0 0;             // Half of the space between toolbox and main is on the toolbox, other half is on the padding, for non-OS X scrollbars
            box-sizing: border-box;
            display: grid;
            grid-template-rows: auto 1fr;

            // For section template version selection
            .xforms-select1-appearance-minimal select {
                width: @fbToolbarWidth - 2 * @fbGutter - 4px; // would like to use 100%, but fails in `fieldset` if content is too wide
                margin: 4px 0;
            }

            .xforms-trigger a {
                text-decoration: none;
                color: @frHeaderColor;
            }

            .xbl-fr-tabbable .nav-tabs {

                li {
                    width: 50%;
                    a { text-align: center }
                }

                li:first-of-type > a {
                    margin-left: 0;
                }

                li:last-of-type > a {
                    margin-right: 0;
                }

                &>  li:not(.active) > a {

                    background-color: #ccc;
                    color: white;

                    &:hover {
                        background-color: white;
                        color: #ccc;
                    }
                }
            }

            .fb-toolbox-icons-tools {
                padding: 8px;
                text-align: center;
                background-color: white;

                .xforms-trigger-appearance-minimal {
                    margin: 0;
                }

                .xforms-trigger-appearance-minimal a:focus {
                    outline: none;
                }

                .fa-code {
                    font-weight: bold;
                }

                &.fb-toolbox-top-icons {
                    display: grid;
                    grid-template-columns: repeat(6, 1fr);
                    border-radius: @baseBorderRadius;

                    .fb-form-settings-button     { grid-row-start: 1; grid-column-start: 1; }
                    .fb-cut-button               { grid-row-start: 1; grid-column-start: 2; }
                    .fb-copy-button              { grid-row-start: 1; grid-column-start: 3; }
                    .fb-paste-button             { grid-row-start: 1; grid-column-start: 4; }
                    .fb-undo-button              { grid-row-start: 1; grid-column-start: 5; }
                    .fb-redo-button              { grid-row-start: 1; grid-column-start: 6; }
                }

                &.fb-toolbox-advanced-icons {
                    display: grid;
                    grid-template-columns: repeat(3, 1fr);
                    padding: 0;
                    margin-bottom: 2px;
                    align-items: baseline;

                    .fb-workflow-button          { grid-row-start: 1; ; grid-column-start: 1; }
                    .fb-permissions-button       { grid-row-start: 1; ; grid-column-start: 1; }
                    .fb-edit-source-button       { grid-row-start: 1; ; grid-column-start: 2; }
                    .fb-reload-components-button { grid-row-start: 1; ; grid-column-start: 3; }
                }

                // Zoom effect on icons
                .xforms-trigger-appearance-minimal:not([class ~= 'xforms-readonly']) {
                    button {
                        padding: 0;
                        border: none;
                    }
                }
                .xforms-trigger-appearance-minimal:not([class ~= 'xforms-readonly']):hover {
                    button {
                        margin-top: 4px;
                        transition: all ease 100ms;
                    }
                    .fa::before {
                        font-size: 18px;
                        transition: all ease 100ms;
                    }
                }
            }

            .fb-tools {

                padding: 0;
                margin-bottom: 15px;

                margin-bottom: @fbGutter;
                &:last-child { margin-bottom: 0 }

                legend {
                    font-size: 11px;
                    margin-bottom: 4px;
                    line-height: 24px;
                    text-align: left;
                    font-weight: bold;
                }

                .fb-tool {
                    //margin: 0 0 0 4px;
                    margin: 0;

                    .xforms-trigger button {
                        padding: 2px 4px;
                        border: none; background: none; box-shadow: none;                                                   // remove button default styling
                        font-size: 85%;                                                                                     // smaller text next icon
                        width: 100%;                 // to increase clicking area
                        text-align: left;

                        i {
                            margin-top: -1px;        // so that Bootstrap icons are better aligned
                        }
                        img {
                            margin-top: -3px;        // so that Bootstrap icons are better aligned
                            width: 16px;
                            height: 16px;
                        }

                        i, img { margin-right: 3px } // space between icon and text

                        &:hover {
                            #gradient > .vertical(@grayLighter, @grayLighter);                                                             // effect on hover
                        }

                        i.fa {
                            width: 14px;
                            font-size: 14px;
                            margin-left: 1px;
                            margin-right: 4px;
                        }
                    }

                    .fb-add-action-button, .fb-add-http-service-button, .fb-add-service-database-button {
                        display: block;
                        //border-top: 1px solid #e5e5e5;
                        button {
                            padding-left: 0;
                        }
                    }

                    &.xforms-dnd-item {
                        display: flex;
                        justify-content: space-between;
                        align-items: center;

                        i.fa {
                            margin-left: 0;
                        }

                        &> .xforms-trigger {
                            flex-grow: 1;
                            display: inline-block;
                        }

                        .fb-action-service-grab {
                            display: inline-block;
                            opacity: 0.1;
                            flex-grow: 0;
                            margin: 0;
                        }

                        &.xforms-dnd-moves .fb-action-service-grab {
                            cursor: move;
                            opacity: 0.5;
                        }

                        &:hover {
                            border-radius: @baseBorderRadius;
                            #gradient > .vertical(@grayLighter, @grayLighter);                                                             // effect on hover
                        }
                    }
                }

                // Services and actions
                ul { margin: 0; overflow: auto }
                li { list-style-type: none; white-space: nowrap; font-size: 11px }
            }

            #fb-toolbox-tabs {
                min-height: 0;
                > div {
                    height: 100%;
                    display: grid;
                    grid-template-rows: auto 1fr;
                    .tab-content {
                        overflow-y: auto;
                        border-radius: 0 0 @baseBorderRadius @baseBorderRadius;
                    }
                }
            }

            .xbl-fr-alert-dialog {display: none }   // because w/ Chrome, a DIV of the dialog remains under the toolbox DIV and causes the toolbox to scroll

            .fr-orbeon-version { color: white; }
        }
    }

    // ***** Dialogs ***************************************************************************************************

    // All dialogs
    .xforms-dialog {

        // Things look better when the headings are centered
        .xbl-fr-grid .fr-grid.fr-repeat .fr-grid-head .fr-grid-th {
            vertical-align: middle;
        }

        .xforms-trigger.xforms-trigger-appearance-full button {
            min-width: 9.5em;
        }

        // Improve layout of prefixes/suffixes
        .input-append {

            display: flex;

            &> .add-on {
            }

            &> input[type = "text"] {
                width: auto; // otherwise set at 100%
                flex-grow: 1;
            }
        }

        .xforms-label:empty, .fr-grid .xforms-label:empty {
            display: none;
        }

        .xforms-label {
            margin-top: 5px;

            // Try to make icons appear vertically centered
            img {
                vertical-align: middle;
                margin-bottom: (@baseLineHeight - @fbIconsHeight) / 2;
            }
        }

        // Add colon after labels to make them more distinct. Do we like this?
        // See also https://github.com/orbeon/orbeon-forms/issues/383
        .xforms-label:after { content: ": " }
        // Exceptions to above rule
        legend.xforms-label:after,
        .fr-grid-th .xforms-label:after,
        .fr-grid thead tr th .xforms-label:after,
        .xbl-fr-alert-dialog-message .xforms-label:after { content: none }

        fieldset { padding: 0 }

        .tab-content {
            .tab-pane > .xbl-fr-grid:last-child {
                margin-bottom: 0; // default is set to 10px somewhere else
            }
        }

        .xforms-tabbable-appearance-left > .tabs-left {
            display: grid; // tried with `flex` but didn't manage to make things work nicely (kind of with `min-width` though)
            grid-template-columns: max-content 1fr;

            &> .nav-tabs {
                grid-row: 1;
                grid-column: 1;
                padding-bottom: 40px; // so that we don't have a too small "notch" at the bottom
                float: none;          // to reset existing `float` just in case
                //min-width: fit-content; // could use this once Edge supports it
            }
            &> .tab-content {
                grid-row: 1;
                grid-column: 2;
            }
        }

        // Indent all radio controls, not only those with
        .xforms-select1-appearance-full .xforms-items,
        .xbl-fb-boolean-or-formula .fr-component-group .xforms-textarea {
            padding: 4px 6px;
        }

        .xbl-fb-boolean-or-formula .xforms-textarea {
            display: block;
        }

        // Same as in `grid.less`, but with email dialog this is not in a grid!
        .xbl-fr-checkbox-input {
            .xforms-select-appearance-full, .xforms-select1-appearance-full {
                .xforms-items {
                    padding: 4px 0;
                }
            }
        }
    }

    // Metadata editor dialog
    .fb-dialog-form-settings {
        width: 1000px; // larger so that tab titles in French, in particular, fit
        max-width: none;

        .popover.xforms-help-popover {
            // Override `white-space: pre-wrap` which we set by default following
            // https://github.com/orbeon/orbeon-forms/issues/1618. That works for
            // plain text, but here we want HTML content and we want regular white-space.
            // We need a better solution!
            .popover-content {
                white-space: normal;
            }

            // Make popover a bit narrower so it fits in the dialog
            max-width: 350px;
        }

        .tab-content {
            // Override Boostrap default so the help tooltips are not clipped
            overflow: visible;
        }

        div[class ^= "fb-settings-mode-"] {
            display: grid;
            grid-template-columns: auto 1fr;

            &> .alert-error {
                grid-row-start: 1;
                grid-column-start: 1;
                grid-column-end: span 2;
            }

            &> .alert-info {
                grid-row-start: 2;
                grid-column-start: 1;
                grid-column-end: span 2;
            }

            &> img {
                grid-row-start: 3;
                grid-column-start: 1;
            }

            &> .xbl-fr-tabbable {
                grid-row-start: 3;
                grid-column-start: 2;
            }
        }

        img {
            margin: 1em;
        }

        .xforms-label { display: block; }

        .fb-dialog-form-settings-fields {
            width: 100%;
            .xforms-input input, .xforms-textarea textarea {
                width: 100%;
                box-sizing: border-box;
            }
        }

        .fb-dialog-form-settings-info {
            display: grid;
            grid-template-columns: 50% 50%;

            &> .fb-dialog-form-settings-info-versions {
                grid-row: 1;
                grid-column: 1;
                padding-right: 10px;
            }

            &> .fb-dialog-form-settings-info-stats {
                grid-row: 1;
                grid-column: 2;
                padding-left: 10px;

                // Format stats table
                table tbody {

                    th { text-align: left  }
                    td { text-align: right }

                    // We can't use .table-striped, as xf:repeat adds delimiters, so we do our own zebra-striping
                    tr:nth-child(4n+3) > th, tr:nth-child(4n+3) > td {
                        background-color: @tableBackgroundAccent;
                    }
                }
            }
        }

        .fb-attachment-max-size-control, .fb-attachment-max-size-aggregate-control, .fb-attachment-mediatypes-control {
            & > .fr-component-group {
                display: flex;
                align-items: center;

                label.radio {
                    margin-bottom: 0; // remove extra margin for `align-items`
                }

                & > .xforms-input, &> .xbl-fr-number {
                    flex-grow: 1;
                }
            }
        }

        .xbl-fr-grid .fr-grid-td > .xbl-component {
            &.fb-labels-placeholders, &.fb-hints-placeholders {
                margin-top: 0; // make closer to the previous control
                .xforms-items {
                    padding-left: 6px; // align with previous control
                }
            }
        }
    }

    .fb-dialog-email-settings {
        width: 800px;
        max-width: none;
    }

    .fb-dialog-messages {
        width: 1050px;
        max-width: none;

        .fb-messages-language-column {
            width: 150px;
        }

        .fb-messages-name-column {
            width: 450px;
        }

        .fb-messages-html-column {
           width: 80px;

            span.xforms-items {
                align-items: center;
            }

            .checkbox {
                margin: 0;
            }

            .checkbox > span {
                display: none;
            }
        }
    }

    .fb-dialog-search {
        width: 600px;
        max-width: none;

        .fa-search {
            font-size: 24pt;
            color: #0081C7;
            margin: 2px 0;
        }

        // Use longer chain to override general margin rule in grid
        .xbl-fr-grid .fr-grid .fr-grid-body .fr-grid-td .fb-open-settings {
            margin-top: 7px;
        }
    }

    .fb-dialog-http-services {

        width: 550px;
        max-width: none;

        .xbl-fr-grid .fr-grid .xforms-textarea textarea {
            height: @baseLineHeight * 10 + 8px;
        }

        .fb-service-dialog-error, .fb-service-dialog-success {
            border: 2px solid;
            padding: 2px;
        }

        .fb-service-dialog-error {
            border-color: red;
        }

        .fb-service-dialog-success {
            border-color: green;
        }

        .fb-submission-response-body {
            textarea {
                height: 200px;
            }
        }

        .fb-submission-response-headers {
            display: block;
            max-height: 200px;
            overflow-y: auto;
        }

        .fb-submission-response-noheaders {
            font-style: italic;
            padding: 4px;
        }

        .fb-service-request-body textarea {
            height: @baseLineHeight * 8 + 8px;
        }
    }

    // Bindings editor dialog
    .fb-action-dialog {
        width: 800px;
        max-width: none;

        .fb-action-phrase-outer > .xforms-label {
            border-bottom: none;
            &:after {
                content: ": ";
            }
        }

        .fb-action-phrase {
            display: flex;
            justify-content: flex-start;
            align-items: flex-end;
        }

        .fb-action-observer, .fb-action-event, .fb-action-control {
            display: inline-block;
            margin-right: 5px;
            select {
                width: 100% ;
            }
        }

        .tab-content {
            .dialog-scrollable(600px);
        }

        // On the left, taking most of the space, all for the fields for one line
        .fb-action-options {

            input, textarea, select {
                width: 100%;
            }

            // `N-col-span-M` means that the option take M/N of the available space
            // E.g. `3-col-span-2` takes 2/3 of the available space for options

            .fb-action-option-2-col-span-1,
            .fb-action-option-3-col-span-1,
            .fb-action-option-3-col-span-2 {
                display: inline-block;
                vertical-align: top;
                margin: 0;
                padding-right: 10px;
                box-sizing: border-box;
            }

            @optionsWidth : 700px;
            @2colWidth    : @optionsWidth/2;
            @3colWidth    : @optionsWidth/3;

            // So all the options are on the same line
            min-width: @optionsWidth;

            .fb-action-option-2-col-span-1 { width: @2colWidth }
            .fb-action-option-3-col-span-1 { width: @3colWidth }
            .fb-action-option-3-col-span-2 { width: @3colWidth * 2 }

            // We use `appearance="minimal"` on labels
            label {
                border-bottom: 1px solid #e5e5e5;
                margin-bottom: 10px;
            }
        }

        .xbl-fr-dnd-repeat {
            display: table;
            width: 100%;

            // A reorderable line
            .fb-action-iteration {
                display: table-row;

                // On the right, the buttons to reorder, remove, and add rows
                .fb-action-buttons {
                    // Use a minimal amount of horizontal space, leaving space for the "options"
                    width: 1%;
                    padding-top: 3px;
                    text-align: right;
                    white-space: nowrap;
                    vertical-align: top;
                }

                .fb-action-options, .fb-action-buttons {
                    display: table-cell;
                    padding-bottom: 5px;
                }
            }
        }

        .fb-action-xpath {

            &> textarea {
                //width: 100%;
            }
        }

        .xforms-trigger-appearance-minimal.xforms-readonly i {
            opacity: 0.4;
            cursor: pointer;
        }

        .fb-action-options {
            .select2-container {
                display: block;
            }
        }
    }

    .xbl-fr-dnd-repeat {

        // Hide buttons while dragging as they get moved to the left (which maybe could be fixed?)
        .gu-mirror {
            .fb-action-buttons {
                display: none;
            }
        }

        .fb-action-grab {
            display: inline-block;
            opacity: 0.1;
        }

        .xforms-dnd-moves .fb-action-grab {
            cursor: move;
            opacity: 0.5;
        }
    }

    #fb-database-service-dialog {
        width: 550px;
        max-width: none;
        textarea {
            height: 10em;
            font-family: @monoFontFamily;
        }
    }


    // Help dialog
    .fb-section-help-dialog {
        width: 400px;
        textarea {
            width: 98%;
            height: 12em;
        }
    }

    .fb-ids-dialog {
        width: 500px;

        table {
            table-layout: fixed;

            .fb-status {
                width: 24px;
            }
        }
    }

    .fb-add-language-dialog {
        width: 400px;
        max-width: none;
    }

    .fb-pdf-dialog {
        width: 700px;
        max-width: none;
    }

    .fb-search-dialog {
        width: 500px;
        max-width: none;
    }

    // https://github.com/orbeon/orbeon-forms/issues/3277
    // There shouldn't be an `.xforms-label-appearance-minimal` anyway if the `minimal label works.
    .xbl-fr-grid .fr-grid {
        .xbl-component, .xforms-control {
            .xforms-label-appearance-minimal {
                display: none;
            }
        }
    }

    .fb-dialog-control-settings {

        width: 1000px;
        max-width: none;

        .xbl-fb-language-choice {
            .navbar {
                margin: 0;

                .navbar-inner {
                    padding: 3px;
                }
            }
        }

        .xforms-label {
            margin-top: 5px;
        }

        .tab-pane {
            .dialog-scrollable(90vh);
        }

        // Adjust so that images within radio/checkbox looks centered like it is in the toolbox
        label[class ~= radio], label[class ~= checkbox] {
            img {
                margin-top: -3px
            }
        }

        .fr-grid-help .xforms-textarea textarea {
            height: @baseLineHeight * 5 + 8px;
        }

        .fb-base-tab-div {
            display: flex;
            .fb-base-tab-left, .fb-base-tab-right {
                flex-flow: column;
                width: 50%;
            }
            margin-bottom: 4px; // so that the highlight around "Email Options" is not truncated at the bottom
        }

        .fr-grid .fb-control-settings-alert-block {
            display: flex;
            margin: 4px 0 4px 4px;

            .xforms-label {
                display: none;
            }
            .xforms-input {
                flex-grow: 1;
            }
            .xforms-input.xforms-type-boolean {
                flex-grow: 0;
                margin: 0 4px;
            }
        }

        .fb-control-settings-options {

            .xforms-items {
                margin-bottom: 5px; // otherwise they are too close from each other
            }

            .fb-control-settings-summary-show {
                .xforms-items, &.xforms-select1 {
                    margin-left: 20px;
                }

                .fb-role-required-checkbox {
                    .xforms-items {
                        margin-left: 40px;
                    }
                }
            }

            .fb-control-settings-allow-bulk-edit {
                .xforms-items {
                    margin-left: 40px;
                }

                .fb-role-required-checkbox {
                    .xforms-items {
                        margin-left: 60px;
                    }
                }
            }

            .fb-control-settings-summary-show, .fb-control-settings-allow-bulk-edit {
                &.xforms-select1 select {
                    width: min-content;
                    margin-bottom: 5px;
                }
            }

            .fb-role-required-checkbox {
                display: grid;
                grid-template-columns: auto 1fr;

                span.xforms-switch.fb-roles-any-or-all {
                    margin-left: 0;

                    select {
                        width: min-content;
                        margin-right: 5px;
                    }

                    div.xforms-case-selected {
                        padding-bottom: 5px;
                    }
                }

                .fb-role-row {
                    display: grid;
                    grid-template-columns: auto max-content;
                    column-gap: 10px;
                    padding-bottom: 5px;

                    .fb-param-grab {
                        display: inline-block;
                        opacity: 0.1;
                    }

                    &.xforms-dnd-moves .fb-param-grab {
                        cursor: move;
                        opacity: 0.5;
                    }
                }
            }
        }

        .fb-validations-tab {
            .xbl-fb-boolean-or-formula .fr-component-group {
                .xforms-items, .xforms-textarea {
                    padding: 0; // no padding here as we are within a small visible grid cell and want to look like the rest
                }
            }
        }
    }

    .fb-dialog-container-settings {
        width: 1010px;
        max-width: none;

        .xbl-fr-grid .fr-grid-td > .xforms-control {
            &.fb-standard-classes {
                .xforms-items[role = group][tabindex] {
                    padding-left: 0; // align with previous control
                }
            }
        }
    }

    #fb-schema-upload-dialog {
        width: 400px;

        .xforms-hint { width: 100% }
        .xforms-select1 { height: 10em; width: 100% }
        .fb-dialog-h2 { font-size: larger; display: block; padding-top: .3em; padding-bottom: .3em }
        .fb-dialog-section { display: block; margin-left: 1em }
    }

    .fb-edit-source-dialog {
        width: 900px;
        max-width: none;
        .xxforms-dialog-body {
            position: relative;     // So `.CodeMirror` height can be relative to the body height
        }
        .CodeMirror {
            font-size: 12px;        // Pick slightly smaller font size, default being 13px
            position: absolute;     // So height can be 100%-64px of the dialog body
            height: auto;           // Override default `300px`
            top: 0; bottom: 64px;   // Leave room for buttons
            width: 100%;
        }
        .xforms-alert.xforms-active { display: block }
    }

    // Publish dialog
    .fb-publish-dialog {
        width: 500px;

        .table {
            background-color: white;
            table-layout: auto;
            margin-bottom: @fbGutter;
            th {
                font-weight: bold;
                text-align: right;
                .narrow-td();

                .xforms-output .xforms-output-output {
                    white-space: nowrap;
                }
            }
        }

        .fb-publish-message {
            background-color: white;
            .fr-border();
            display: block;
            padding: @fbGutter;

            ul {
                list-style: square;
                margin-bottom: 0;
            }
        }

        .alert {
            display: block;
        }
    }

    // Test dialog
    .fb-test-dialog {
        width: 90vw;                                // Try to be very wide
        max-width: none;
        .xxforms-dialog-body {
            .fb-dialog-remaining-height {
                height: 100%;
            }
            .fb-test-iframe {
                height: 100%; width: 100%;          // Use all the space available in container (.fb-dialog-remaining-height)
                box-sizing: border-box;             // So the size of this box doesn't get larger than its container, which would add scrollbars to the container
                border: none;                       // By default, iframes have a particularly ugly border
            }
        }
    }

    // ***** In-Place Editing ******************************************************************************************

    // Label and hint editors

    .fr-grid .xforms-label input, .fr-grid .xforms-hint input, .fb-label-editor input[type='text'] {
        height: @baseLineHeight;
        padding: 0;
        box-sizing: border-box;
        border-radius: 0;
    }

    .fb-label-editor {
        position: absolute;                         // If not explicitly set, jQuery uses position: relative, which create scrollbars
        top: 0; left: 0;                            // So the first call to .offset() works when the page is scrolled, see issue #2093
        z-index: 1;                                 // For the editor to be above control, allowing it to catch clicks, see issue #3410
        display: flex;
        input[type='text'] {
            flex-flow: column;
            width: 100%;
        }
        input[type='checkbox'] {                    // Use margin as padding doesn't work well on HTML input elements
            margin-left: 5px;
            flex-flow: column;
        }
        &.fb-label-editor-for-hint input {          // Smaller font size for hint, to match hint itself
            font-size: smaller;
        }
        &.fb-label-editor-for-hint input, &.fb-label-editor-for-label input {
            border-radius: @baseBorderRadius;
        }
        &.fb-label-editor-for-text {
            .mce-content-body {
                border: 1px solid transparent;
                padding: 1px; // so that cursor does not touch border

                border-radius: @baseBorderRadius;

                // Similar to .focusHighlight()
                &:focus-within {
                    box-shadow: 0 0 0 0.2rem @explanatoryTextShadow;
                    outline: 0;
                    transition: border-color .15s ease-in-out,box-shadow .15s ease-in-out;
                    border-color: #ccc;
                }
            }
        }
    }

    h2 .fr-section-label {
        height: 36px;                               // So the title takes space even when empty; 36px is line-height in bootstrap.css
                                                    // Defined as height, not max-height, as Firefox doesn't support max-height on
                                                    // tables, table rows, or table cells; the browser will expand it anyway as needed,
                                                    // so in this case height is equivalent to max-height.
    }

    // Yes/no clear button
    .xbl-fr-yesno-input {
        > .fr-component-group {
            width: fit-content; // so that the radio buttons and the clear button have a consistent width
            button {
                width: 100%;
                &:hover {
                    background-color: #ddd;
                }
            }
        }
    }

    // ***** Grid ******************************************************************************************************

    .fb {

        .xbl-fr-section .fr-section-content {
            padding: 10px;          // don't need as much padding as usual because grids have extra padding for their icons
        }

        .xbl-fr-grid {
            padding: 0 0 0 @fbGridIconsGutter; // reserve space for top/left icons
        }
    }

    .fb-cell-editor, .fb-row-editor { display: none } // Contains the editing markup that will be moved inside each grid td

    .fb-grid-cell-icons, .fb-grid-control-icons, .fb-grid-row-icons {
        display: block; width: @fbIconsHeight;
        height: 60px; // Q: Should this use one of the constants?
        text-align: center;
    }

    // Delete, expand, shrink shown to the left of the cell
    .fb-grid-cell-icons { position: absolute; left: .5em; top: .5em}
    .fb-grid-cell-icons img { margin-bottom: 0; padding: 0 }
    .fr-grid .fr-grid-td .fb-grid-cell-icons img { display: inline }
    // Control details and validation shown to the top right of the cell
    .fb-grid-control-icons { position: absolute; right: .5em; top: .5em }
    .fb-grid-control-icons img { margin-bottom: 0; padding: 0 }

    // Simply styling for file select to just show "x"
    #fr-form-group .fb-static-upload {
        background: none;
        position: absolute; // show upload UI at the bottom of the cell and remove file upload indicator
        left: 32px;
        bottom: .5em;
        .xforms-upload-info, .xforms-upload-size, .xforms-upload-remove { padding: 0 }
        .xforms-upload-info {
            background: none;
        }
    }

    .fr-grid .fr-grid-td .fb-grid-control-icons img { display: inline }
    .fb-label-hint-placeholder,                                                         // Grey color for placeholder "Click here to edit…" so users can distinguish it from an actual value
    .fb-label-hint-placeholder .btn { color: #bbb }                                     // To take precedence over color set for button's labels in xforms.css
    .fr-grid .fr-grid-td .xforms-trigger .btn input,                                    // Override margin set in form-runner-base.css for buttons in noscript (rendered as input)
    .btn .xforms-label { margin: 0 }                                                    // Override margin set in form-runner-base.css for regular labels

    .fr-grid-td .fb-hover { position: relative }                                        // So elements shown on hover can be absolutely positioned relative to the cell
                                                                                        // Necessary as Firefox doesn't support position: relative on table cells (http://goo.gl/Atzi2)


    // Editable grids
    .fr-view .xbl-fr-grid .fr-grid.fr-editable {

        .fr-grid-td {
            &.fb-selected {
                box-shadow: 0 0 0 4px @cellHighlight !important;
                outline: 0;
                transition: border-color .15s ease-in-out,box-shadow .15s ease-in-out;
                border-radius: @baseBorderRadius;
                z-index: 1;                                                             // Highlight to show over grey background for hover cell
            }
        }

        .fr-grid-td {
            &:hover:not(.fb-selected) {                                                 // Grey background on hover on non-selected cell, to indicate it can be selected
                background-color: #eee;
            }
        }

        &.fr-repeat.fr-repeat-single-row .fr-grid-body .fr-grid-td > * {
            &> .xforms-label,
            &> .xforms-help,
            &> .xforms-hint {
                display: none;
            }
        }

        .fr-grid-body { grid-gap: 0px }
        &.fr-norepeat {
            .fr-grid-body { grid-gap: 1px }
            &.fb-hover .fr-grid-td { box-shadow: 0 0 0 1px @grayLighter }
        }

        // Enough space to hold row icons so hovering doesn't cause the row to expand
        .fr-grid-td {
            min-height: @fbGridRowMinHeight;
        }

        // Generate multiples of min height so that empty cells take space
        .generateMinHeight(@h) when (@h > 0) {
            .fr-grid-td[data-fr-h =  '@{h}'] { min-height: @h * @fbGridRowMinHeight; }
            .generateMinHeight(@h - 1)
        }

        .generateMinHeight(20);

        .xforms-label, .xforms-hint, .btn span, .xforms-text .xforms-output-output {
            &:hover {
                // Indicate the value can be edited
                background-color: #ddd;
                cursor: pointer;
                border-radius: @baseBorderRadius;
            }
        }
        // Make click area with the grey background larger, as it will typically contain a longer text
        .xforms-text .xforms-output-output {
            min-height: 50px;
            display: block;
            border: 1px solid transparent; // so we can have a visible border when editing without causing resizing
            border-radius: @baseBorderRadius;
            padding: 1px; // so that cursor does not touch border
        }

        // Even if the label or hint is empty, we still want space for 1 line to be reserved
        // In regular grid content
        .fr-grid-td {
            & > .xbl-component, & > .xforms-control {
                & > .xforms-label, & > .xforms-hint {
                    min-height: 20px; // Use min-height instead of height so text wraps if it doesn't fit on 1 line
                    display: block;
                }
            }
        }

        // In grid header, for the repeat single line
        .fr-grid-th {
            .xforms-label, .xforms-hint {
                min-height: 20px; // Use min-height instead of height so text wraps if it doesn't fit on 1 line
                display: block;
            }
        }

        .fr-grid-td, .fr-grid-th {
            // Space for highlights
            padding-top: 4px;
            padding-bottom: 4px;
            // Space for the icons to the left and right of the control
            padding-left: 24px;
            padding-right: 24px;

            // Inputs for editing the label and hint to take the whole width of the grid content
            .xforms-label input, .xforms-hint input {
                width: 100%
            }
        }
    }

    .fb-use-toolbar-message, .fb-click-message {
        display: none;
        font-size: 70%;
        color: gray;
        width: 100%;
        font-style: italic;
        text-align: center;
        margin-top: 2em
    }
    .fb-selected .fb-use-toolbar-message { display: block }
    td:hover .fb-click-message { display: block }
    td.fb-selected:hover .fb-click-message { display: none }

    .fb-component-icon { display: block }

    // Read-only components
    .fb-section-component .fr-grid-td { background-image: none; background-color: #F8F8F8; border: solid 1px #F8F8F8 }
    .xforms-readonly .xforms-input-input { background-image: none; background-color: #CCCCCC }
    .xforms-readonly textarea { background-image: none; background-color: #CCCCCC }

    // ***** Message ***************************************************************************************************

    // Size message so that it fits within bottom navbar, see #486
    .fr-messages, .fb-xpath-errors {
        display: inline-block;
        .alert {
            display: inline-block;
            margin: 0;
            line-height: normal;
            height: 30px;
        }
    }

    // ***** Layout ****************************************************************************************************

    #fr-view {
        display: block;                                                     // So we can get its width in `position.coffee`
        margin-left: 0
    }

    .fb-bottom {
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        width: 100%;
        box-sizing: border-box;
        height: @fbBottomHeight;
        line-height: @fbBottomHeight;
        vertical-align: middle;
        text-align: right;                                                  // Message and buttons to show on the right
        padding: 0 @fbGutter;

        .fr-status-icons { display: none }                                  // Don't show valid/invalid icon, as we show XPath errors in .fb-xpath-errors

        // Override Form Runner defaults
        .fr-buttons {
            display: inline-block;                                          // We have messages shown on the same line
            position: static;
            width: auto;
            margin: 0;
            padding: 0 10px;
            vertical-align: top;
            background-color: @fbButtonsBackground;
        }
    }

    .fr-container { top: 10px }                                             // Override 40px in form-runner-base.css as we don't leave as much as space at the top since the navbar isn't fixed

    // Both navbars
    .navbar .navbar-inner {
        box-shadow: none;
    }

    // Top Form Builder navbar only
    .fb-navbar {
        position: absolute;
        margin-bottom: 0;                                                   // override 18px in bootstrap.css as the content below the navbar (.fr-top) already as its own padding
        border-radius: 0;                                                   // override Bootstrap rounded corners
        .navbar-inner {
            .container {
                width: auto;
                h1 {
                    color: #777;
                }
                .nav {
                    &> li {
                        padding-top: 0;
                        padding-bottom: 0;
                    }
                    margin-left: auto;                                          // Show at the end of the line in `flex` layout
                    margin-right: 0;                                            // Override excessive margin set by Bootstrap
                }
            }
        }
    }

    // Form navbar only
    .fb-main .navbar {
        margin-top: 0;                                                      // Overrides 10px in form-runner-bootstrap-override, as this navbar is not at the top of the page

        .fb-language-triggers {
            i {
                background: none;
                color: white;
                opacity: 0.7;
            }
        }
    }

    .navbar .fr-language-choice .nav {
        margin-right: 0;
    }

    .xforms-dialog {

        // Make the language choice selector smaller and floating to the top right
        .xbl-fb-language-choice {
            float: right;

            .navbar {
                margin-bottom: 0;
                .navbar-inner {
                    min-height: 10px;
                }

                .nav > li >a {
                    padding: 5px;
                }
            }
        }
    }

    .fb-section-template-details {
        font-size: .8em;
        padding: 0 4px;
        margin-bottom: 4px;
        border: 1px solid #ddd;
        border-radius: 2px;
        background-color: #d3eeff;
    }
}

// ***** Other media ***************************************************************************************************

// This is also used for PDF generation
@media print {
    input { height: 1em }
}
