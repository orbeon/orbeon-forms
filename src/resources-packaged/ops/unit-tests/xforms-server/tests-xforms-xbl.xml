<!--
  Copyright (C) 2010 Orbeon, Inc.

  This program is free software; you can redistribute it and/or modify it under the terms of the
  GNU Lesser General Public License as published by the Free Software Foundation; either version
  2.1 of the License, or (at your option) any later version.

  This program is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY;
  without even the implied warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.
  See the GNU Lesser General Public License for more details.

  The full text of the license is available at http://www.gnu.org/copyleft/lesser.html
  -->
<group description="XForms XBL" xmlns:p="http://www.orbeon.com/oxf/pipeline"
    xmlns:xsl="http://www.w3.org/1999/XSL/Transform"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xmlns:xs="http://www.w3.org/2001/XMLSchema"
    xmlns:xh="http://www.w3.org/1999/xhtml"
    xmlns:oxf="http://www.orbeon.com/oxf/processors"
    xmlns:xi="http://www.w3.org/2001/XInclude"
    xmlns:xxi="http://orbeon.org/oxf/xml/xinclude"
    xmlns:xf="http://www.w3.org/2002/xforms"
    xmlns:exf="http://www.exforms.org/exf/1-0"
    xmlns:xxf="http://orbeon.org/oxf/xml/xforms"
    xmlns:ev="http://www.w3.org/2001/xml-events"
    xmlns:xbl="http://www.w3.org/ns/xbl"
    xmlns:xxbl="http://orbeon.org/oxf/xml/xbl"
    xmlns:fr="http://orbeon.org/oxf/xml/form-runner">

    <test description="Event handler observing XBL bound element" name="oxf:pipeline">
        <input name="config" href="wrap-xforms-state.xpl"/>
        <input name="document">
            <xh:html>
                <xh:head>
                    <xf:model id="model">
                        <xf:instance id="instance">
                            <instance>
                                <foo1>42</foo1>
                            </instance>
                        </xf:instance>
                    </xf:model>
                    <xbl:xbl>
                        <xbl:binding id="fr-foo" element="fr|foo">
                            <xbl:template>
                                <xf:model id="model">
                                    <xf:instance id="instance">
                                        <instance/>
                                    </xf:instance>
                                </xf:model>
                                <xf:group xbl:attr="model context ref bind" xxbl:scope="outer">
                                    <xbl:content includes="xf|label,xf|help,xf|hint,xf|alert"/>

                                    <xf:group id="component-inner-group" appearance="xxf:internal" xxbl:scope="inner">

                                        <xf:var name="result" as="node()?">
                                            <xxf:sequence value="." xxbl:scope="outer"/>
                                        </xf:var>

                                        <!--<xf:var name="inner" value="." as="node()?"/>-->

                                        <!-- React to update to bound node -->
                                        <xf:group ref="$result" appearance="xxf:internal" id="component-result-group">
                                            <xf:action ev:event="xforms-value-changed xforms-enabled" if="$result castable as xs:integer">
                                                <xf:setvalue ref="instance('instance')" value="xs:integer($result) + 1"/>
                                            </xf:action>
                                        </xf:group>

                                        <!-- Local controls -->
                                        <xf:group appearance="xxf:internal" id="component-controls-group">
                                            <xf:input id="my-input" ref="."/>
                                            <xf:setvalue ev:event="xforms-value-changed" if="context() castable as xs:integer" ref="$result" value="xs:integer(context()) - 1"/>
                                        </xf:group>

                                        <!-- Stop propagation of all UI events -->
                                        <xf:action ev:event="#all" ev:propagate="stop"/>

                                    </xf:group>
                                </xf:group>
                            </xbl:template>
                        </xbl:binding>
                    </xbl:xbl>
                </xh:head>
                <xh:body>
                    <fr:foo id="my-foo" ref="foo1">
                        <xf:label>My label</xf:label>
                    </fr:foo>
                </xh:body>
            </xh:html>
        </input>
        <output name="response">
            <xxf:event-response>
                <xxf:dynamic-state>
                    <dynamic-state>
                        <instances>
                            <instance id="instance" model-id="my-foo$model">
                                <instance>43</instance>
                            </instance>
                        </instances>
                    </dynamic-state>
                </xxf:dynamic-state>
                <xxf:action>
                    <xxf:control-values>
                        <xxf:control id="my-foo$xf-3" label="My label"/>
                        <xxf:control id="my-foo$my-input">43</xxf:control>
                    </xxf:control-values>
                </xxf:action>
            </xxf:event-response>
        </output>
    </test>

    <test description="XBL Component in Repeat: Events Upon New Iteration" name="oxf:pipeline">
        <input name="config">
            <p:config>
                <p:param name="response" type="output"/>

                <p:processor name="oxf:pipeline">
                    <p:input name="config" href="wrap-xforms-state.xpl"/>
                    <p:input name="document">
                        <xh:html>
                            <xh:head>
                                <xf:model id="main-model" xxf:encrypt-item-values="false">
                                    <xf:instance id="main-instance">
                                        <instance xmlns="">
                                            <date>2009-01-02</date>
                                            <date>2008-02-01</date>
                                        </instance>
                                    </xf:instance>
                                    <xf:bind ref="date1 | date2" type="xf:date"/>

                                    <!-- TEST: Action to take on xforms-ready -->
                                    <xf:action ev:event="xforms-ready">
                                        <!-- Tricky: add second refresh because first refresh causes a series of values set into nested components -->
                                        <xf:refresh/>
                                        <xf:refresh/>
                                        <xf:delete ref="instance('events')/*"/>
                                        <xf:dispatch name="DOMActivate" targetid="add-row-trigger"/>
                                    </xf:action>

                                    <!-- TEST: Events to gather -->
                                    <xf:instance id="events">
                                        <events/>
                                    </xf:instance>
                                </xf:model>

                                <xbl:xbl>
                                    <xbl:binding id="fr-dropdown-date-binding" element="fr|dropdown-date">
                                        <xbl:template>
                                            <!-- Local model -->
                                            <xf:model id="date-model">
                                                <xf:instance id="date-instance">
                                                    <date>
                                                        <year/>
                                                        <month/>
                                                        <day/>
                                                    </date>
                                                </xf:instance>

                                                <xf:instance id="years-itemset">
                                                    <years/>
                                                </xf:instance>

                                                <xf:instance id="months-itemset">
                                                    <months/>
                                                </xf:instance>

                                                <xf:instance id="days-itemset">
                                                    <days/>
                                                </xf:instance>

                                                <!-- Initialize itemsets upon initialization -->
                                                <xf:action ev:event="xforms-model-construct-done">
                                                    <xf:action iterate="(2007 to 2009)">
                                                        <xf:var name="year" value="." as="xs:string"/>
                                                        <xf:insert context="instance('years-itemset')" origin="xxf:element('year', $year)"/>
                                                    </xf:action>
                                                    <xf:action iterate="(1 to 3)">
                                                        <xf:var name="month" value="." as="xs:string"/>
                                                        <xf:insert context="instance('months-itemset')" ref="*" origin="xxf:element('month', $month)"/>
                                                    </xf:action>
                                                    <xf:action iterate="(1 to 3)">
                                                        <xf:var name="day" value="." as="xs:string"/>
                                                        <xf:insert context="instance('days-itemset')" ref="*" origin="xxf:element('day', $day)"/>
                                                    </xf:action>
                                                </xf:action>
                                            </xf:model>
                                            <!-- Local controls -->
                                            <xf:group xbl:attr="model context ref bind" xxbl:scope="outer">
                                                <xbl:content includes="xf|label,xf|help,xf|hint,xf|alert"/>

                                                <xf:group id="component-inner-group" appearance="xxf:internal" xxbl:scope="inner">

                                                    <xf:var id="result-variable" name="result" as="node()?">
                                                        <xxf:sequence value="." xxbl:scope="outer"/>
                                                    </xf:var>

                                                    <!-- React to update to bound node -->
                                                    <xf:group ref="$result" appearance="xxf:internal" id="component-result-group">
                                                        <!-- Only set local values if the bound node is an xs:date -->
                                                        <xf:action ev:event="xforms-value-changed xforms-enabled" if="$result castable as xs:date" context="instance('date-instance')">
                                                            <xf:setvalue ref="year" value="year-from-date($result)"/>
                                                            <xf:setvalue ref="month" value="month-from-date($result)"/>
                                                            <xf:setvalue ref="day" value="day-from-date($result)"/>
                                                        </xf:action>
                                                    </xf:group>

                                                    <xf:group model="date-model" id="component-controls-group">
                                                        <xf:select1 ref="year" xxf:refresh-items="false" id="year-select">
                                                            <xf:item>
                                                                <xf:label>Year</xf:label>
                                                                <xf:value/>
                                                            </xf:item>
                                                            <xf:itemset ref="instance('years-itemset')/year">
                                                                <xf:label ref="."/>
                                                                <xf:value ref="."/>
                                                            </xf:itemset>
                                                        </xf:select1>
                                                        <xf:select1 ref="month" xxf:refresh-items="false" id="month-select">
                                                            <xf:item>
                                                                <xf:label>Month</xf:label>
                                                                <xf:value/>
                                                            </xf:item>
                                                            <xf:itemset ref="instance('months-itemset')/month">
                                                                <xf:label ref="."/>
                                                                <xf:value ref="."/>
                                                            </xf:itemset>
                                                        </xf:select1>
                                                        <xf:select1 ref="day" xxf:refresh-items="true" id="day-select">
                                                            <xf:item>
                                                                <xf:label>Day</xf:label>
                                                                <xf:value/>
                                                            </xf:item>
                                                            <xf:itemset ref="instance('days-itemset')/day">
                                                                <xf:label ref="."/>
                                                                <xf:value ref="."/>
                                                            </xf:itemset>
                                                        </xf:select1>

                                                        <!-- React to update to local values -->
                                                        <xf:action ev:event="xforms-value-changed">
                                                            <!-- Only proceed if all parts are integers -->
                                                            <xf:action if="year castable as xs:integer and month castable as xs:integer and day castable as xs:integer">
                                                                <xf:var name="date-string" value="concat(year, '-', format-number(xs:integer(month), '00'), '-', format-number(xs:integer(day), '00'))" as="xs:string"/>
                                                                <!-- Only set value if the result is castable as a date -->
                                                                <xf:setvalue if="$date-string castable as xs:date" ref="$result" value="$date-string"/>
                                                            </xf:action>
                                                        </xf:action>
                                                    </xf:group>
                                                </xf:group>

                                            </xf:group>
                                        </xbl:template>
                                    </xbl:binding>
                                </xbl:xbl>

                            </xh:head>
                            <xh:body>
                                <xf:group>
                                    <!-- TEST: Event listener -->
                                    <xf:insert ev:event="xforms-value-changed xforms-enabled xforms-disabled"
                                                   xxf:phantom="true"
                                                   context="instance('events')" ref="*"
                                                   origin="xxf:element('event',
                                                            (xxf:attribute('type', event('xxf:type')),
                                                             xxf:attribute('target', event('xxf:targetid')),
                                                             xxf:attribute('indexes', string-join(event('xxf:repeat-indexes'), ' '))))"/>

                                    <xf:repeat ref="date" id="date-repeat">
                                        <fr:dropdown-date ref="." id="fr-dropdown-date">
                                            <xf:label>Date: </xf:label>
                                        </fr:dropdown-date>
                                    </xf:repeat>

                                    <xf:trigger id="add-row-trigger">
                                        <xf:label>Add</xf:label>
                                        <xf:insert ev:event="DOMActivate" ref="date" at="index('date-repeat')"/>
                                    </xf:trigger>

                                    <xf:trigger id="remove-row-trigger">
                                        <xf:label>Remove</xf:label>
                                        <xf:delete ev:event="DOMActivate" ref="date" at="index('date-repeat')"/>
                                    </xf:trigger>
                                </xf:group>

                            </xh:body>
                        </xh:html>
                    </p:input>
                    <p:output name="response" ref="response"/>
                </p:processor>

            </p:config>
        </input>
        <output name="response">
           <xxf:event-response>
                <xxf:dynamic-state>
                    <dynamic-state>
                        <instances>
                            <instance id="main-instance" model-id="main-model">
                                <instance>
                                    <date>2009-01-02</date>
                                    <date>2008-02-01</date>
                                    <date>2008-02-01</date>
                                </instance>
                            </instance>
                            <instance id="events" model-id="main-model">
                                <events>
                                    <event type="xforms-enabled" target="fr-dropdown-date" indexes="2"/>
                                    <event type="xforms-enabled" target="xf-25" indexes="2"/>
                                    <event type="xforms-enabled" target="component-inner-group" indexes="2"/>
                                    <event type="xforms-enabled" target="result-variable" indexes="2"/>
                                    <event type="xforms-enabled" target="component-result-group" indexes="2"/>
                                    <event type="xforms-enabled" target="component-controls-group" indexes="2"/>
                                    <event type="xforms-enabled" target="year-select" indexes="2"/>
                                    <event type="xforms-enabled" target="month-select" indexes="2"/>
                                    <event type="xforms-enabled" target="day-select" indexes="2"/>
                                    <event type="xforms-value-changed" target="year-select" indexes="2"/>
                                    <event type="xforms-value-changed" target="month-select" indexes="2"/>
                                    <event type="xforms-value-changed" target="day-select" indexes="2"/>
                                </events>
                            </instance>
                            <instance id="date-instance" model-id="fr-dropdown-date$date-model·1">
                                <date>
                                    <year>2009</year>
                                    <month>1</month>
                                    <day>2</day>
                                </date>
                            </instance>
                            <instance id="years-itemset" model-id="fr-dropdown-date$date-model·1">
                                <years>
                                    <year>2009</year>
                                    <year>2008</year>
                                    <year>2007</year>
                                </years>
                            </instance>
                            <instance id="months-itemset" model-id="fr-dropdown-date$date-model·1">
                                <months>
                                    <month>1</month>
                                    <month>2</month>
                                    <month>3</month>
                                </months>
                            </instance>
                            <instance id="days-itemset" model-id="fr-dropdown-date$date-model·1">
                                <days>
                                    <day>1</day>
                                    <day>2</day>
                                    <day>3</day>
                                </days>
                            </instance>
                            <instance id="date-instance" model-id="fr-dropdown-date$date-model·2">
                                <date>
                                    <year>2008</year>
                                    <month>2</month>
                                    <day>1</day>
                                </date>
                            </instance>
                            <instance id="years-itemset" model-id="fr-dropdown-date$date-model·2">
                                <years>
                                    <year>2009</year>
                                    <year>2008</year>
                                    <year>2007</year>
                                </years>
                            </instance>
                            <instance id="months-itemset" model-id="fr-dropdown-date$date-model·2">
                                <months>
                                    <month>1</month>
                                    <month>2</month>
                                    <month>3</month>
                                </months>
                            </instance>
                            <instance id="days-itemset" model-id="fr-dropdown-date$date-model·2">
                                <days>
                                    <day>1</day>
                                    <day>2</day>
                                    <day>3</day>
                                </days>
                            </instance>
                            <instance id="date-instance" model-id="fr-dropdown-date$date-model·3">
                                <date>
                                    <year>2008</year>
                                    <month>2</month>
                                    <day>1</day>
                                </date>
                            </instance>
                            <instance id="years-itemset" model-id="fr-dropdown-date$date-model·3">
                                <years>
                                    <year>2009</year>
                                    <year>2008</year>
                                    <year>2007</year>
                                </years>
                            </instance>
                            <instance id="months-itemset" model-id="fr-dropdown-date$date-model·3">
                                <months>
                                    <month>1</month>
                                    <month>2</month>
                                    <month>3</month>
                                </months>
                            </instance>
                            <instance id="days-itemset" model-id="fr-dropdown-date$date-model·3">
                                <days>
                                    <day>1</day>
                                    <day>2</day>
                                    <day>3</day>
                                </days>
                            </instance>
                        </instances>
                        <controls>
                            <control effective-id="date-repeat" index="2"/>
                        </controls>
                    </dynamic-state>
                </xxf:dynamic-state>
                <xxf:action>
                     <xxf:control-values>
                        <xxf:control id="fr-dropdown-date$xf-25·1" label="Date: "/>
                        <xxf:control id="fr-dropdown-date$year-select·1">2009</xxf:control>
                        <xxf:itemset id="fr-dropdown-date$year-select·1">[{"label":"Year","value":""},{"label":"2009","value":"2009"},{"label":"2008","value":"2008"},{"label":"2007","value":"2007"}]</xxf:itemset>
                        <xxf:control id="fr-dropdown-date$month-select·1">1</xxf:control>
                        <xxf:itemset id="fr-dropdown-date$month-select·1">[{"label":"Month","value":""},{"label":"1","value":"1"},{"label":"2","value":"2"},{"label":"3","value":"3"}]</xxf:itemset>
                        <xxf:control id="fr-dropdown-date$day-select·1">2</xxf:control>
                        <xxf:itemset id="fr-dropdown-date$day-select·1">[{"label":"Day","value":""},{"label":"1","value":"1"},{"label":"2","value":"2"},{"label":"3","value":"3"}]</xxf:itemset>
                        <xxf:control id="fr-dropdown-date$xf-25·2" label="Date: "/>
                        <xxf:control id="fr-dropdown-date$year-select·2">2008</xxf:control>
                        <xxf:itemset id="fr-dropdown-date$year-select·2">[{"label":"Year","value":""},{"label":"2009","value":"2009"},{"label":"2008","value":"2008"},{"label":"2007","value":"2007"}]</xxf:itemset>
                        <xxf:control id="fr-dropdown-date$month-select·2">2</xxf:control>
                        <xxf:itemset id="fr-dropdown-date$month-select·2">[{"label":"Month","value":""},{"label":"1","value":"1"},{"label":"2","value":"2"},{"label":"3","value":"3"}]</xxf:itemset>
                        <xxf:control id="fr-dropdown-date$day-select·2">1</xxf:control>
                        <xxf:itemset id="fr-dropdown-date$day-select·2">[{"label":"Day","value":""},{"label":"1","value":"1"},{"label":"2","value":"2"},{"label":"3","value":"3"}]</xxf:itemset>
                        <xxf:control id="fr-dropdown-date$xf-25·3" label="Date: "/>
                        <xxf:control id="fr-dropdown-date$year-select·3">2008</xxf:control>
                        <xxf:itemset id="fr-dropdown-date$year-select·3">[{"label":"Year","value":""},{"label":"2009","value":"2009"},{"label":"2008","value":"2008"},{"label":"2007","value":"2007"}]</xxf:itemset>
                        <xxf:control id="fr-dropdown-date$month-select·3">2</xxf:control>
                        <xxf:itemset id="fr-dropdown-date$month-select·3">[{"label":"Month","value":""},{"label":"1","value":"1"},{"label":"2","value":"2"},{"label":"3","value":"3"}]</xxf:itemset>
                        <xxf:control id="fr-dropdown-date$day-select·3">1</xxf:control>
                        <xxf:itemset id="fr-dropdown-date$day-select·3">[{"label":"Day","value":""},{"label":"1","value":"1"},{"label":"2","value":"2"},{"label":"3","value":"3"}]</xxf:itemset>
                        <xxf:control id="add-row-trigger" label="Add"/>
                        <xxf:control id="remove-row-trigger" label="Remove"/>
                    </xxf:control-values>
                </xxf:action>
            </xxf:event-response>
        </output>
    </test>

    <test description="XBL component with local model variables" name="oxf:pipeline">
        <input name="config">
            <p:config>
                <p:param name="response" type="output"/>

                <p:processor name="oxf:pipeline">
                    <p:input name="config" href="wrap-xforms-state.xpl"/>
                    <p:input name="document">
                        <xh:html>
                            <xh:head>
                                <xf:model id="main-model">
                                    <xf:instance id="main-instance">
                                        <values xmlns="">
                                            <value1>foo-value</value1>
                                            <value2>bar-value</value2>
                                        </values>
                                    </xf:instance>
                                    <xf:bind ref="value1" readonly="../value2 = '42'"/>
                                </xf:model>
                                <xbl:xbl>
                                    <xbl:binding id="fr-super-control-binding" element="fr|super-control">
                                        <xbl:template>
                                            <xf:model id="super-control-model">
                                                <xf:instance id="super-control-instance">
                                                    <instance xmlns="">
                                                        <value/>
                                                        <name/>
                                                    </instance>
                                                </xf:instance>
                                                <!-- TEST: The variable below must be found and not cause an error -->
                                                <xf:var name="ctx" context="xxf:component-context()" xbl:attr="value=ref" as="node()*"/>
                                                <xf:bind ref="value" readonly="exf:readonly($ctx)"/>
                                                <!-- TEST: The variable must point to the outer element -->
                                                <xf:bind ref="name" calculate="name($ctx[1])"/>
                                            </xf:model>

                                            <xf:group xbl:attr="model context ref bind" xxbl:scope="outer">
                                                <xbl:content includes="xf|label,xf|help,xf|hint,xf|alert"/>

                                                <xf:group id="component-inner-group" appearance="xxf:internal" xxbl:scope="inner">

                                                    <xf:var name="result" as="node()?">
                                                        <xxf:sequence value="." xxbl:scope="outer"/>
                                                    </xf:var>

                                                    <!-- React to update to bound node -->
                                                    <xf:group ref="$result" appearance="xxf:internal" id="component-result-group">
                                                        <xf:action ev:event="xforms-value-changed xforms-enabled">
                                                            <xf:setvalue ref="instance('super-control-instance')/value" value="$result"/>
                                                        </xf:action>
                                                    </xf:group>

                                                    <!-- Local controls -->
                                                    <xf:group model="super-control-model" id="component-controls-group">

                                                        <xf:input ref="value" id="my-input"/>

                                                        <!-- React to update to local controls -->
                                                        <xf:action ev:event="xforms-value-changed">
                                                            <xf:setvalue ref="$result" value="context()/value"/>
                                                        </xf:action>
                                                    </xf:group>
                                                </xf:group>

                                            </xf:group>
                                        </xbl:template>
                                    </xbl:binding>
                                </xbl:xbl>
                            </xh:head>
                            <xh:body>
                                <fr:super-control ref="value1" id="fr-super-control-1">
                                    <xf:label>Internal value 1: </xf:label>
                                </fr:super-control>
                                <fr:super-control ref="value2" id="fr-super-control-2">
                                    <xf:label>Internal value 2: </xf:label>
                                </fr:super-control>
                                <xf:input ref="value1" id="input-1">
                                    <xf:label>External value 1: </xf:label>
                                </xf:input>
                                <xf:input ref="value2" id="input-2">
                                    <xf:label>External value 2: </xf:label>
                                </xf:input>
                            </xh:body>
                        </xh:html>
                    </p:input>
                    <p:output name="response" ref="response"/>
                </p:processor>

            </p:config>
        </input>
        <output name="response">
           <xxf:event-response>
                <xxf:dynamic-state>
                    <dynamic-state>
                        <instances>
                            <instance id="super-control-instance" model-id="fr-super-control-1$super-control-model">
                                <instance>
                                    <value>foo-value</value>
                                    <name>value1</name>
                                </instance>
                            </instance>
                            <instance id="super-control-instance" model-id="fr-super-control-2$super-control-model">
                                <instance>
                                    <value>bar-value</value>
                                    <name>value2</name>
                                </instance>
                            </instance>
                        </instances>
                    </dynamic-state>
                </xxf:dynamic-state>
                <xxf:action>
                    <xxf:control-values>
                        <xxf:control id="fr-super-control-1$xf-9" label="Internal value 1: "/>
                        <xxf:control id="fr-super-control-1$my-input">foo-value</xxf:control>
                        <xxf:control id="fr-super-control-2$xf-21" label="Internal value 2: "/>
                        <xxf:control id="fr-super-control-2$my-input">bar-value</xxf:control>
                        <xxf:control id="input-1" label="External value 1: ">foo-value</xxf:control>
                        <xxf:control id="input-2" label="External value 2: ">bar-value</xxf:control>
                    </xxf:control-values>
                </xxf:action>
            </xxf:event-response>
        </output>
    </test>

    <test description="Dispatch event to model within XBL" name="oxf:pipeline">
        <input name="config">
            <p:config>
                <p:param name="response" type="output"/>

                <p:processor name="oxf:pipeline">
                    <p:input name="config" href="wrap-xforms-state.xpl"/>
                    <p:input name="document">
                        <xh:html>
                            <xh:head>
                                <!-- Model just so we get XForms processing -->
                                <xf:model/>
                                <!-- XBL -->
                                <xbl:xbl>
                                    <xbl:binding id="component" element="fr|component">
                                        <xbl:template>
                                            <xf:model id="xbl-model">
                                                <xf:instance id="xbl-instance">
                                                    <value/>
                                                </xf:instance>
                                                <!-- Dispatch event -->
                                                <xf:dispatch ev:event="xforms-model-construct-done" name="doit" targetid="xbl-model"/>
                                                <!-- React to dispatched event -->
                                                <xf:setvalue ev:event="doit" ref=".">gotit</xf:setvalue>
                                            </xf:model>
                                            <xf:output id="xbl-output" model="xbl-model" ref="."/>
                                        </xbl:template>
                                    </xbl:binding>
                                </xbl:xbl>
                            </xh:head>
                            <xh:body>
                                <!-- Use component -->
                                <fr:component id="my-component"/>
                            </xh:body>
                        </xh:html>
                    </p:input>
                    <p:output name="response" ref="response"/>
                </p:processor>

            </p:config>
        </input>
        <output name="response">
           <xxf:event-response>
                <xxf:dynamic-state>
                    <dynamic-state>
                        <instances>
                            <instance id="xbl-instance" model-id="my-component$xbl-model">
                                <value>gotit</value>
                            </instance>
                        </instances>
                    </dynamic-state>
                </xxf:dynamic-state>
                <xxf:action>
                    <xxf:control-values>
                        <xxf:control id="my-component$xbl-output">gotit</xxf:control>
                    </xxf:control-values>
                </xxf:action>
            </xxf:event-response>
        </output>
    </test>

    <test description="Namespace in attribute in XBL" name="oxf:pipeline">
        <input name="config">
            <p:config>
                <p:param name="response" type="output"/>

                <p:processor name="oxf:pipeline">
                    <p:input name="config" href="wrap-xforms-state.xpl"/>
                    <p:input name="document">
                        <xh:html>
                            <xh:head>
                                <!-- Model just so we get XForms processing -->
                                <xf:model/>
                            </xh:head>
                            <xh:body>
                                <!-- XBL -->
                                <xbl:xbl>
                                    <xbl:binding id="fr-databound-select1" element="fr|foobar">
                                        <xbl:template>
                                            <xf:model id="xbl-model">
                                                <!-- Check that the namespace for xxf:* is in scope: this must not cause a Java exception -->
                                                <xf:message ev:event="xforms-model-construct-done" level="xxf:log-info">Done!</xf:message>
                                            </xf:model>
                                        </xbl:template>
                                    </xbl:binding>
                                </xbl:xbl>
                                <!-- Use component -->
                                <fr:foobar id="my-component"/>
                            </xh:body>
                        </xh:html>
                    </p:input>
                    <p:output name="response" ref="response"/>
                </p:processor>

            </p:config>
        </input>
        <output name="response">
           <xxf:event-response>
                <xxf:dynamic-state>
                    <dynamic-state/>
                </xxf:dynamic-state>
                <xxf:action>
                    <xxf:control-values/>
                </xxf:action>
            </xxf:event-response>
        </output>
    </test>

    <test description="Send submission upon xforms-model-construct-done within XBL" name="oxf:pipeline">
        <input name="config">
            <p:config>
                <p:param name="response" type="output"/>

                <p:processor name="oxf:pipeline">
                    <p:input name="config" href="wrap-xforms-state.xpl"/>
                    <p:input name="document">
                        <xh:html>
                            <xh:head>
                                <!-- Model just so we get XForms processing -->
                                <xf:model/>
                                <!-- XBL -->
                                <xbl:xbl>
                                    <xbl:binding id="component" element="fr|component">
                                        <xbl:template>
                                            <xf:model id="xbl-model">

                                                <xf:instance id="initial-instance">
                                                    <instance>
                                                        <value>1</value>
                                                    </instance>
                                                </xf:instance>

                                                <xf:instance id="new-instance">
                                                    <instance>
                                                        <value>2</value>
                                                    </instance>
                                                </xf:instance>

                                                <xf:submission id="replace-submission"
                                                                   ref="instance('new-instance')" method="post" resource="echo:"
                                                                   replace="instance" instance="initial-instance"
                                                                   xxf:readonly="false"/>

                                                <!-- When this is called on xforms-ready, controls must update properly -->
                                                <xf:send ev:event="xforms-model-construct-done" submission="replace-submission"/>

                                            </xf:model>
                                            <xf:output id="xbl-output" model="xbl-model" ref="."/>
                                        </xbl:template>
                                    </xbl:binding>
                                </xbl:xbl>
                            </xh:head>
                            <xh:body>
                                <!-- Use component -->
                                <fr:component id="my-component"/>
                            </xh:body>
                        </xh:html>
                    </p:input>
                    <p:output name="response" ref="response"/>
                </p:processor>

            </p:config>
        </input>
        <output name="response">
           <xxf:event-response>
                <xxf:dynamic-state>
                    <dynamic-state>
                        <instances>
                            <instance id="initial-instance" model-id="my-component$xbl-model">
                                <instance>
                                    <value>2</value>
                                </instance>
                            </instance>
                        </instances>
                    </dynamic-state>
                </xxf:dynamic-state>
                <xxf:action>
                    <xxf:control-values>
                        <xxf:control id="my-component$xbl-output">2</xxf:control>
                    </xxf:control-values>
                </xxf:action>
            </xxf:event-response>
        </output>
    </test>

    <test description="Prefixing of @id and @for on HTML elements within XBL and repeats" name="oxf:pipeline">
        <input name="config">
            <p:config>
                <p:param name="response" type="output"/>

                <p:processor name="oxf:pipeline">
                    <p:input name="config" href="wrap-xforms-state.xpl"/>
                    <p:input name="document">
                        <xh:html>
                            <xh:head>
                                <xf:model id="model">
                                    <xf:instance id="instance">
                                        <values xmlns="">
                                            <value1>color: red</value1>
                                            <value2>font-weight: bold</value2>
                                        </values>
                                    </xf:instance>
                                    <xf:bind ref="value1" readonly="../value2 = '42'"/>
                                </xf:model>
                                <xbl:xbl>
                                    <xbl:binding id="fr-super-control-binding" element="fr|super-control">
                                        <xbl:template>
                                            <xf:group xbl:attr="ref" xxbl:scope="outer">
                                                <xh:div style="{.}">
                                                    Div 3
                                                </xh:div>
                                                <xh:input id="my-html-input" name="my-html-input"/>
                                                <xh:label for="my-html-input">This is an HTML control</xh:label>
                                            </xf:group>
                                        </xbl:template>
                                    </xbl:binding>
                                </xbl:xbl>
                            </xh:head>
                            <xh:body>

                                <fr:super-control ref="value1" id="fr-super-control-1"/>
                                <fr:super-control ref="value2" id="fr-super-control-2"/>
                                <xf:repeat id="repeat" ref="value1 | value2">
                                    <xh:div id="my-repeated-id">
                                        <fr:super-control ref="." id="fr-super-control-3"/>
                                    </xh:div>
                                </xf:repeat>

                            </xh:body>
                        </xh:html>
                    </p:input>
                    <p:output name="response" ref="response"/>
                </p:processor>

            </p:config>
        </input>
        <output name="response">
            <xxf:event-response>
                <xxf:dynamic-state>
                    <dynamic-state>
                        <controls>
                            <control effective-id="repeat" index="1"/>
                        </controls>
                    </dynamic-state>
                </xxf:dynamic-state>
                <xxf:action>
                    <xxf:control-values>
                        <xxf:attribute id="fr-super-control-1$xf-6" for="fr-super-control-1$xf-5" name="style">color: red</xxf:attribute>
                        <xxf:attribute id="fr-super-control-2$xf-10" for="fr-super-control-2$xf-9" name="style">font-weight: bold</xxf:attribute>
                        <xxf:attribute id="fr-super-control-3$xf-14·1" for="fr-super-control-3$xf-13·1" name="style">color: red</xxf:attribute>
                        <xxf:attribute id="fr-super-control-3$xf-14·2" for="fr-super-control-3$xf-13·2" name="style">font-weight: bold</xxf:attribute>
                    </xxf:control-values>
                </xxf:action>
            </xxf:event-response>
        </output>
    </test>

    <test description="XBL event hiding and dispatch to bound node" name="oxf:pipeline">
        <input name="config">
            <p:config>
                <p:param name="response" type="output"/>

                <p:processor name="oxf:pipeline">
                    <p:input name="config" href="wrap-xforms-state.xpl"/>
                    <p:input name="document">
                        <xh:html>
                            <xh:head>
                                <xf:model id="model">

                                    <!-- TEST: Events to gather -->
                                    <xf:instance id="events">
                                        <events/>
                                    </xf:instance>

                                </xf:model>

                                <xbl:xbl>
                                    <xbl:binding id="foobar-component" element="fr|foobar">
                                        <xbl:template>
                                            <!-- Local model -->
                                            <xf:model id="internal-model">
                                            </xf:model>
                                            <!-- Local controls -->
                                            <xf:group id="internal-group">
                                                <!-- React to creation of group -->
                                                <xf:action ev:event="xforms-enabled" ev:target="#observer">
                                                    <!-- Simulate user click on all triggers -->
                                                    <xf:dispatch name="DOMActivate" targetid="internal-trigger-1"/>
                                                    <xf:dispatch name="DOMActivate" targetid="internal-trigger-2"/>
                                                    <xf:dispatch name="DOMActivate" targetid="internal-trigger-3"/>
                                                </xf:action>

                                                <xf:trigger id="internal-trigger-1">
                                                    <xf:label>Dispatch outside</xf:label>
                                                    <!-- Dispatch to bound node -->
                                                    <xf:dispatch ev:event="DOMActivate" name="fr:my-event" targetid="foobar-component">
                                                        <xf:property name="fr:my-context" value="42"/>
                                                    </xf:dispatch>
                                                </xf:trigger>
                                                <xf:trigger id="internal-trigger-2">
                                                    <xf:label>Dispatch inside group</xf:label>
                                                    <!-- Dispatch to local group -->
                                                    <xf:dispatch ev:event="DOMActivate" name="fr:my-event" targetid="internal-group">
                                                        <xf:property name="fr:my-context" value="43"/>
                                                    </xf:dispatch>
                                                </xf:trigger>
                                                <xf:trigger id="internal-trigger-3">
                                                    <xf:label>Dispatch inside model</xf:label>
                                                    <!-- Dispatch to local model -->
                                                    <xf:dispatch ev:event="DOMActivate" name="fr:my-event" targetid="internal-model">
                                                        <xf:property name="fr:my-context" value="44"/>
                                                    </xf:dispatch>
                                                </xf:trigger>
                                            </xf:group>
                                        </xbl:template>
                                    </xbl:binding>
                                </xbl:xbl>
                            </xh:head>
                            <xh:body>

                                <xf:group id="external-group">
                                    <!-- Record all events -->
                                    <xf:insert ev:event="#all"
                                                   context="instance('events')" ref="*"
                                                   origin="xxf:element('event',
                                                            (xxf:attribute('type', event('xxf:type')),
                                                             xxf:attribute('target', event('xxf:targetid')),
                                                             xxf:attribute('phase', event('xxf:phase')),
                                                             xxf:attribute('original-target', event('xxf:targetid')),
                                                             xxf:attribute('indexes', string-join(event('xxf:repeat-indexes'), ' ')),
                                                             xxf:attribute('original-indexes', string-join(event('xxf:repeat-indexes'), ' '))))"/>

                                    <xf:insert ev:event="#all" ev:phase="capture"
                                                   context="instance('events')" ref="*"
                                                   origin="xxf:element('event',
                                                            (xxf:attribute('type', event('xxf:type')),
                                                             xxf:attribute('target', event('xxf:targetid')),
                                                             xxf:attribute('phase', event('xxf:phase')),
                                                             xxf:attribute('original-target', event('xxf:targetid')),
                                                             xxf:attribute('indexes', string-join(event('xxf:repeat-indexes'), ' ')),
                                                             xxf:attribute('original-indexes', string-join(event('xxf:repeat-indexes'), ' '))))"/>

                                    <fr:foobar id="my-foobar">
                                        <xf:message ev:event="fr:my-event"><xf:output value="concat('Got it: ', event('fr:my-context'))"/></xf:message>
                                    </fr:foobar>
                                </xf:group>
                            </xh:body>
                        </xh:html>
                    </p:input>
                    <p:output name="response" ref="response"/>
                </p:processor>

            </p:config>
        </input>
        <output name="response">
            <xxf:event-response>
                <xxf:dynamic-state>
                    <dynamic-state>
                        <instances>
                            <instance id="events" model-id="model">
                                <events>
                                    <event type="xforms-enabled" target="external-group" phase="target" original-target="external-group" indexes="" original-indexes=""/>
                                    <event type="xforms-enabled" target="my-foobar" phase="capture" original-target="my-foobar" indexes="" original-indexes=""/>
                                    <event type="xforms-enabled" target="my-foobar" phase="bubbling" original-target="my-foobar" indexes="" original-indexes=""/>
                                    <event type="fr:my-event" target="my-foobar" phase="capture" original-target="my-foobar" indexes="" original-indexes=""/>
                                    <event type="fr:my-event" target="my-foobar" phase="bubbling" original-target="my-foobar" indexes="" original-indexes=""/>
                                </events>
                            </instance>
                        </instances>
                    </dynamic-state>
                </xxf:dynamic-state>
                <xxf:action>
                    <xxf:control-values>
                        <xxf:control id="my-foobar$internal-trigger-1" label="Dispatch outside"/>
                        <xxf:control id="my-foobar$internal-trigger-2" label="Dispatch inside group"/>
                        <xxf:control id="my-foobar$internal-trigger-3" label="Dispatch inside model"/>
                    </xxf:control-values>
                    <xxf:message level="modal">Got it: 42</xxf:message>
                </xxf:action>
            </xxf:event-response>
        </output>
    </test>

    <test description="XBL namespace mapping clashes" name="oxf:pipeline">
        <input name="config">
            <p:config>
                <p:param name="response" type="output"/>

                <p:processor name="oxf:pipeline">
                    <p:input name="config" href="wrap-xforms-state.xpl"/>
                    <p:input name="document">
                        <xh:html>
                            <xh:head>
                                <xf:model id="model">
                                    <xf:instance id="instance">
                                        <value>Hello, world!</value>
                                    </xf:instance>
                                </xf:model>
                                <!-- First component -->
                                <xbl:xbl xmlns:myexf="http://www.exforms.org/exf/1-0">
                                    <xbl:binding id="foo-component" element="fr|foo">
                                        <xbl:template>
                                            <xf:group xxbl:scope="outer">
                                                <xf:var name="result" as="node()?" xxbl:scope="inner">
                                                    <xxf:sequence value="." xxbl:scope="outer"/>
                                                </xf:var>
                                                <!-- Use prefix myexf declared only in this XBL binding, and use on element with id "clash" -->
                                                <xf:output id="clash" value="myexf:readonly($result)" xxbl:scope="inner">
                                                    <xf:label>Read-only: </xf:label>
                                                </xf:output>
                                            </xf:group>
                                        </xbl:template>
                                    </xbl:binding>
                                </xbl:xbl>
                                <!-- Second component -->
                                <xbl:xbl>
                                    <xbl:binding id="bar-component" element="fr|bar">
                                        <xbl:template>
                                            <xf:group xxbl:scope="outer">
                                                <xf:var name="result" as="node()?" xxbl:scope="inner">
                                                    <xxf:sequence value="." xxbl:scope="outer"/>
                                                </xf:var>
                                                <!-- Element with id "clash" doesn't have the myexf prefix used by the other component -->
                                                <xf:output id="clash" ref="$result" xxbl:scope="inner">
                                                    <xf:label>Message: </xf:label>
                                                </xf:output>
                                            </xf:group>
                                        </xbl:template>
                                    </xbl:binding>
                                </xbl:xbl>
                            </xh:head>
                            <xh:body>

                                <!-- Use the XBL components: this must not cause an exception! -->
                                <fr:foo id="my-foo"/>
                                <fr:bar id="my-bar"/>

                            </xh:body>
                        </xh:html>
                    </p:input>
                    <p:output name="response" ref="response"/>
                </p:processor>

            </p:config>
        </input>
        <output name="response">
            <xxf:event-response>
                <xxf:dynamic-state>
                    <dynamic-state/>
                </xxf:dynamic-state>
                <xxf:action>
                    <xxf:control-values>
                        <xxf:control id="my-foo$clash" label="Read-only: ">false</xxf:control>
                        <xxf:control id="my-bar$clash" label="Message: ">Hello, world!</xxf:control>
                    </xxf:control-values>
                </xxf:action>
            </xxf:event-response>
        </output>
    </test>

    <test description="Insert yields correct repeat index in XBL" name="oxf:pipeline">
        <input name="config">
            <p:config>
                <p:param name="response" type="output"/>

                <p:processor name="oxf:pipeline">
                    <p:input name="config" href="wrap-xforms-state.xpl"/>
                    <p:input name="document">
                        <xh:html>
                            <xh:head>
                                <xf:model id="model">
                                    <xf:instance id="instance">
                                        <instance xmlns="">
                                            <record/>
                                        </instance>
                                    </xf:instance>

                                    <!-- Insert globally upon ready -->
                                    <xf:insert ev:event="xforms-ready" ref="instance('instance')/record" at="1"/>

                                </xf:model>

                                <xbl:xbl script-type="application/xhtml+xml">
                                    <xbl:binding id="fr-foo" element="fr|foo">
                                        <xbl:template>
                                            <xbl:content/>
                                        </xbl:template>
                                    </xbl:binding>
                                </xbl:xbl>

                                <xbl:xbl script-type="application/xhtml+xml">
                                    <xbl:binding id="fr-bar" element="fr|bar">
                                        <xbl:template>
                                            <xf:model id="model">
                                                <xf:instance id="instance">
                                                    <instance xmlns="">
                                                        <record/>
                                                    </instance>
                                                </xf:instance>
                                                <!-- Insert locally upon xforms-enabled of the group -->
                                                <xf:insert ev:event="xforms-enabled" ev:observer="bar-group" ev:target="bar-group" ref="instance('instance')/record" at="1"/>
                                            </xf:model>
                                            <xf:group id="bar-group" model="model" appearance="xxf:internal">
                                                <xbl:content/>
                                            </xf:group>
                                        </xbl:template>
                                    </xbl:binding>
                                </xbl:xbl>
                            </xh:head>
                            <xh:body>

                                <!-- Without XBL (update to global instance) -->
                                <xf:repeat ref="record" id="repeat-no-xbl">
                                    <xf:output id="my-output" value="index('repeat-no-xbl')"/>
                                </xf:repeat>

                                <!-- With XBL (update to global instance) -->
                                <fr:foo id="my-foo">
                                    <xf:repeat ref="record" id="repeat-xbl-foo">
                                        <xf:output id="my-output-foo" value="index('repeat-xbl-foo')"/>
                                    </xf:repeat>
                                </fr:foo>

                                <!-- With XBL (update to local instance) -->
                                <fr:bar id="my-bar">
                                    <xf:repeat ref="record" id="repeat-xbl-bar">
                                        <xf:output id="my-output-bar" value="index('repeat-xbl-bar')"/>
                                    </xf:repeat>
                                </fr:bar>
                            </xh:body>
                        </xh:html>
                    </p:input>
                    <p:output name="response" ref="response"/>
                </p:processor>

            </p:config>
        </input>
        <output name="response">
            <xxf:event-response>
                <xxf:dynamic-state>
                    <dynamic-state>
                        <instances>
                            <instance id="instance" model-id="model">
                                <instance>
                                    <record/>
                                    <record/>
                                </instance>
                            </instance>
                            <instance id="instance" model-id="my-bar$model">
                                <instance>
                                    <record/>
                                    <record/>
                                </instance>
                            </instance>
                        </instances>
                        <controls>
                            <control effective-id="repeat-no-xbl" index="2"/>
                            <control effective-id="my-foo$repeat-xbl-foo" index="2"/>
                            <control effective-id="my-bar$repeat-xbl-bar" index="2"/>
                        </controls>
                    </dynamic-state>
                </xxf:dynamic-state>
                <xxf:action>
                    <xxf:control-values>
                        <xxf:control id="my-output·1">2</xxf:control>
                        <xxf:control id="my-output·2">2</xxf:control>
                        <xxf:control id="my-foo$my-output-foo·1">2</xxf:control>
                        <xxf:control id="my-foo$my-output-foo·2">2</xxf:control>
                        <xxf:control id="my-bar$my-output-bar·1">2</xxf:control>
                        <xxf:control id="my-bar$my-output-bar·2">2</xxf:control>
                    </xxf:control-values>
                </xxf:action>
            </xxf:event-response>
        </output>
    </test>

    <test description="Repeat index updates through user interaction inside and outside XBL" name="oxf:pipeline">
        <input name="config">
            <p:config>
                <p:param name="response" type="output"/>

                <p:processor name="oxf:pipeline">
                    <p:input name="config" href="wrap-xforms-state.xpl"/>
                    <p:input name="document">
                        <xh:html>
                            <xh:head>
                                <xf:model id="model">
                                    <xf:instance id="instance">
                                        <instance xmlns="">
                                            <record/>
                                        </instance>
                                    </xf:instance>

                                    <xf:action ev:event="xforms-ready">
                                        <!-- Insert one element, this takes index to 2 -->
                                        <xf:insert ref="instance('instance')/record" at="1"/>
                                        <xf:refresh/>
                                        <!-- Dispatch repeat focus to change the index back to 1 -->
                                        <xf:dispatch name="xxforms-repeat-activate" targetid="my-output" xxf:repeat-indexes="1"/>
                                    </xf:action>

                                </xf:model>

                                <xbl:xbl script-type="application/xhtml+xml">
                                    <xbl:binding id="fr-foo" element="fr|foo">
                                        <xbl:template>
                                            <xbl:content/>
                                        </xbl:template>
                                    </xbl:binding>
                                </xbl:xbl>

                                <xbl:xbl script-type="application/xhtml+xml">
                                    <xbl:binding id="fr-bar" element="fr|bar">
                                        <xbl:template>
                                            <xf:model id="model">
                                                <xf:instance id="instance">
                                                    <instance xmlns="">
                                                        <record/>
                                                    </instance>
                                                </xf:instance>
                                                <xf:action ev:event="xforms-model-construct-done">
                                                    <!-- Insert two element, this takes index to 3 -->
                                                    <xf:insert ref="instance('instance')/record"/>
                                                    <xf:insert ref="instance('instance')/record"/>
                                                </xf:action>
                                                <xf:action ev:event="xforms-enabled" ev:observer="bar-group" ev:target="bar-group">
                                                    <!-- Dispatch repeat focus to change the index back to 2 -->
                                                    <xf:dispatch name="xxforms-repeat-activate" targetid="my-output-bar" xxf:repeat-indexes="2"/>
                                                </xf:action>
                                            </xf:model>
                                            <xf:group id="bar-group" model="model" appearance="xxf:internal">
                                                <!-- You wouldn't usually set back the scope to "inner", but this is for testing only -->
                                                <xbl:content xxbl:scope="inner"/>
                                            </xf:group>
                                        </xbl:template>
                                    </xbl:binding>
                                </xbl:xbl>
                            </xh:head>
                            <xh:body>
                                <!-- Without XBL (update to global instance) -->
                                <xf:repeat ref="record" id="repeat-no-xbl">
                                    <xf:output id="my-output" value="index('repeat-no-xbl')"/>
                                </xf:repeat>

                                <!-- With XBL (update to global instance) -->
                                <fr:foo id="my-foo">
                                    <xf:repeat ref="record" id="repeat-xbl-foo">
                                        <xf:output id="my-output-foo" value="index('repeat-xbl-foo')"/>
                                    </xf:repeat>
                                </fr:foo>

                                <!-- With XBL (update to local instance) -->
                                <fr:bar id="my-bar">
                                    <xf:repeat ref="record" id="repeat-xbl-bar">
                                        <xf:output id="my-output-bar" value="index('repeat-xbl-bar')"/>
                                    </xf:repeat>
                                </fr:bar>
                            </xh:body>
                        </xh:html>
                    </p:input>
                    <p:output name="response" ref="response"/>
                </p:processor>

            </p:config>
        </input>
        <output name="response">
            <xxf:event-response>
                <xxf:dynamic-state>
                    <dynamic-state>
                        <instances>
                            <instance id="instance" model-id="model">
                                <instance>
                                    <record/>
                                    <record/>
                                </instance>
                            </instance>
                            <instance id="instance" model-id="my-bar$model">
                                <instance>
                                    <record/>
                                    <record/>
                                    <record/>
                                </instance>
                            </instance>
                        </instances>
                        <controls>
                            <control effective-id="repeat-no-xbl" index="1"/>
                            <control effective-id="my-foo$repeat-xbl-foo" index="2"/>
                            <control effective-id="my-bar$repeat-xbl-bar" index="2"/>
                        </controls>
                    </dynamic-state>
                </xxf:dynamic-state>
                <xxf:action>
                    <xxf:control-values>
                        <xxf:control id="my-output·1">1</xxf:control>
                        <xxf:control id="my-output·2">1</xxf:control>
                        <xxf:control id="my-foo$my-output-foo·1">2</xxf:control>
                        <xxf:control id="my-foo$my-output-foo·2">2</xxf:control>
                        <xxf:control id="my-bar$my-output-bar·1">2</xxf:control>
                        <xxf:control id="my-bar$my-output-bar·2">2</xxf:control>
                        <xxf:control id="my-bar$my-output-bar·3">2</xxf:control>
                    </xxf:control-values>
                </xxf:action>
            </xxf:event-response>
        </output>
    </test>

    <test description="XBL xxf:instance() scoping" name="oxf:pipeline">
        <input name="config">
            <p:config>
                <p:param name="response" type="output"/>

                <p:processor name="oxf:pipeline">
                    <p:input name="config" href="wrap-xforms-state.xpl"/>
                    <p:input name="document">
                        <xh:html>
                            <xh:head>
                                <xf:model id="model">
                                    <xf:instance id="global-instance-1">
                                        <global-instance-1/>
                                    </xf:instance>
                                    <xf:instance id="global-instance-2">
                                        <global-instance-2/>
                                    </xf:instance>
                                </xf:model>

                                <xbl:xbl script-type="application/xhtml+xml">
                                    <xbl:binding id="fr-foobar" element="fr|foobar">
                                        <xbl:template>
                                            <xf:model id="local-model">
                                                <xf:instance id="local-instance">
                                                    <local-instance/>
                                                </xf:instance>
                                            </xf:model>

                                            <xf:output value="name()" xxbl:scope="outer"/>
                                            <xf:group>
                                                <xf:output id="output-2" value="name()"/>
                                            </xf:group>
                                            <xf:output id="output-3" value="name(instance('local-instance'))"/>
                                            <xf:output id="output-4" value="name(xxf:instance('local-instance'))"/>
                                            <xf:output id="output-5" value="name(xxf:instance('global-instance-1'))"/>
                                            <xf:output id="output-6" value="name(xxf:instance('global-instance-2'))"/>
                                        </xbl:template>
                                    </xbl:binding>
                                </xbl:xbl>
                            </xh:head>
                            <xh:body>

                                <fr:foobar id="my-foobar"/>

                                <xf:group id="my-group" context="instance('global-instance-2')">
                                    <fr:foobar id="my-foobar2"/>
                                </xf:group>

                            </xh:body>
                        </xh:html>
                    </p:input>
                    <p:output name="response" ref="response"/>
                </p:processor>

            </p:config>
        </input>
        <output name="response">
            <xxf:event-response>
                <xxf:dynamic-state>
                    <dynamic-state/>
                </xxf:dynamic-state>
                <xxf:action>
                    <xxf:control-values>
                        <xxf:control id="my-foobar$xf-3">global-instance-1</xxf:control>
                        <xxf:control id="my-foobar$output-2">local-instance</xxf:control>
                        <xxf:control id="my-foobar$output-3">local-instance</xxf:control>
                        <xxf:control id="my-foobar$output-4">local-instance</xxf:control>
                        <xxf:control id="my-foobar$output-5">global-instance-1</xxf:control>
                        <xxf:control id="my-foobar$output-6">global-instance-2</xxf:control>
                        <xxf:control id="my-foobar2$xf-6">global-instance-2</xxf:control>
                        <xxf:control id="my-foobar2$output-2">local-instance</xxf:control>
                        <xxf:control id="my-foobar2$output-3">local-instance</xxf:control>
                        <xxf:control id="my-foobar2$output-4">local-instance</xxf:control>
                        <xxf:control id="my-foobar2$output-5">global-instance-1</xxf:control>
                        <xxf:control id="my-foobar2$output-6">global-instance-2</xxf:control>
                    </xxf:control-values>
                </xxf:action>
            </xxf:event-response>
        </output>
    </test>

    <test description="XBL xbl:implementation and xbl:handler" name="oxf:pipeline">
        <input name="config">
            <p:config>
                <p:param name="response" type="output"/>

                <p:processor name="oxf:pipeline">
                    <p:input name="config" href="wrap-xforms-state.xpl"/>
                    <p:input name="document">
                        <xh:html>
                            <xh:head>
                                <xf:model id="model">
                                    <xf:instance id="instance">
                                        <instance xmlns=""/>
                                    </xf:instance>

                                    <xf:action ev:event="xforms-ready">
                                        <xf:dispatch name="my-event" targetid="my-bar-1">
                                            <xf:property name="fr:one" value="'Red'"/>
                                            <xf:property name="fr:two" value="'Blue'"/>
                                        </xf:dispatch>
                                        <xf:dispatch name="my-event" targetid="my-bar-2">
                                            <xf:property name="fr:one" value="'Cat'"/>
                                            <xf:property name="fr:two" value="'Mouse'"/>
                                        </xf:dispatch>
                                    </xf:action>

                                </xf:model>

                                <xbl:xbl script-type="application/xhtml+xml">
                                    <xbl:binding id="fr-bar" element="fr|bar">

                                        <xbl:handlers>
                                            <!-- Handlers are attached to the bound node -->
                                            <xbl:handler event="my-event" phase="target">
                                                <xf:setvalue model="model" ref="value1" value="event('fr:one')"/>
                                                <xf:setvalue model="model" ref="value2" value="event('fr:two')"/>
                                            </xbl:handler>

                                            <!-- TEST: Record all events -->
                                            <xbl:handler event="#all">
                                                <xf:insert model="model"
                                                   context="instance('events')" ref="*"
                                                   origin="xxf:element('event',
                                                            (xxf:attribute('type', event('xxf:type')),
                                                             xxf:attribute('target', event('xxf:targetid')),
                                                             xxf:attribute('phase', event('xxf:phase')),
                                                             xxf:attribute('original-target', event('xxf:targetid')),
                                                             xxf:attribute('indexes', string-join(event('xxf:repeat-indexes'), ' ')),
                                                             xxf:attribute('original-indexes', string-join(event('xxf:repeat-indexes'), ' '))))"/>
                                            </xbl:handler>
                                        </xbl:handlers>

                                        <!-- Test model placement within xbl:implementation -->
                                        <xbl:implementation>
                                            <!-- Local model with local data -->
                                            <xf:model id="model">
                                                <xf:instance id="instance">
                                                    <instance xmlns="">
                                                        <value1/>
                                                        <value2/>
                                                    </instance>
                                                </xf:instance>
                                                <!-- TEST: Events to gather -->
                                                <xf:instance id="events">
                                                    <events/>
                                                </xf:instance>
                                            </xf:model>
                                        </xbl:implementation>

                                        <!-- Template with just the controls -->
                                        <xbl:template>
                                            <xf:group id="bar-group" model="model" appearance="xxf:internal">
                                                <xf:input id="input1" ref="value1"/>
                                                <xf:input id="input2" ref="value2"/>
                                            </xf:group>
                                        </xbl:template>
                                    </xbl:binding>
                                </xbl:xbl>
                            </xh:head>
                            <xh:body>
                                <fr:bar id="my-bar-1"/>
                                <fr:bar id="my-bar-2"/>
                            </xh:body>
                        </xh:html>
                    </p:input>
                    <p:output name="response" ref="response"/>
                </p:processor>

            </p:config>
        </input>
        <output name="response">
            <xxf:event-response>
                <xxf:dynamic-state>
                    <dynamic-state>
                        <instances>
                            <instance id="instance" model-id="my-bar-1$model">
                                <instance>
                                    <value1>Red</value1>
                                    <value2>Blue</value2>
                                </instance>
                            </instance>
                            <instance id="events" model-id="my-bar-1$model">
                                <events>
                                    <event type="xforms-enabled" target="my-bar-1" phase="target" original-target="my-bar-1" indexes="" original-indexes=""/>
                                    <event type="my-event" target="my-bar-1" phase="target" original-target="my-bar-1" indexes="" original-indexes=""/>
                                </events>
                            </instance>
                            <instance id="instance" model-id="my-bar-2$model">
                                <instance>
                                    <value1>Cat</value1>
                                    <value2>Mouse</value2>
                                </instance>
                            </instance>
                            <instance id="events" model-id="my-bar-2$model">
                                <events>
                                    <event type="xforms-enabled" target="my-bar-2" phase="target" original-target="my-bar-2" indexes="" original-indexes=""/>
                                    <event type="my-event" target="my-bar-2" phase="target" original-target="my-bar-2" indexes="" original-indexes=""/>
                                </events>
                            </instance>
                        </instances>
                    </dynamic-state>
                </xxf:dynamic-state>
                <xxf:action>
                    <xxf:control-values>
                        <xxf:control id="my-bar-1$input1">Red</xxf:control>
                        <xxf:control id="my-bar-1$input2">Blue</xxf:control>
                        <xxf:control id="my-bar-2$input1">Cat</xxf:control>
                        <xxf:control id="my-bar-2$input2">Mouse</xxf:control>
                    </xxf:control-values>
                </xxf:action>
            </xxf:event-response>
        </output>
    </test>

    <test description="Nested XBL references" name="oxf:pipeline">
        <input name="config">
            <p:config>
                <p:param name="response" type="output"/>

                <p:processor name="oxf:pipeline">
                    <p:input name="config" href="wrap-xforms-state.xpl"/>
                    <p:input name="document">
                        <xh:html>
                            <xh:head>
                                <xf:model id="model">
                                    <xf:instance id="main-instance">
                                            <instance xmlns="">42</instance>
                                        </xf:instance>
                                    </xf:model>

                                    <xbl:xbl script-type="application/xhtml+xml">
                                        <xbl:binding id="fr-foo" element="fr|foo">
                                            <xbl:template>
                                                <xh:fieldset>
                                                    <xh:legend>Foo 1</xh:legend>
                                                    <xbl:content/>
                                                </xh:fieldset>
                                                <xh:h2>Foo 2</xh:h2>
                                                <xbl:content/>
                                            </xbl:template>
                                        </xbl:binding>
                                    </xbl:xbl>

                                    <xbl:xbl script-type="application/xhtml+xml">
                                        <xbl:binding id="fr-bar" element="fr|bar">
                                            <xbl:template>
                                                <xh:fieldset>
                                                    <xh:legend>Bar 1</xh:legend>
                                                    <xbl:content/>
                                                </xh:fieldset>
                                                <xh:h2>Bar 2</xh:h2>
                                                <xbl:content/>
                                            </xbl:template>
                                        </xbl:binding>
                                    </xbl:xbl>
                                </xh:head>
                                <xh:body>

                                    <fr:foo id="my-foo">
                                        <fr:bar>
                                            <xf:output value=".">
                                                <xf:label>Life, etc.: </xf:label>
                                            </xf:output>
                                        </fr:bar>
                                    </fr:foo>

                                </xh:body>
                            </xh:html>
                    </p:input>
                    <p:output name="response" ref="response"/>
                </p:processor>

            </p:config>
        </input>
        <output name="response">
            <xxf:event-response>
                <xxf:dynamic-state>
                    <dynamic-state/>
                </xxf:dynamic-state>
                <xxf:action>
                    <xxf:control-values>
                        <xxf:control id="my-foo$xf-4$xf-7" label="Life, etc.: ">42</xxf:control>
                        <xxf:control id="my-foo$xf-4$xf-9" label="Life, etc.: ">42</xxf:control>
                        <xxf:control id="my-foo$xf-5$xf-12" label="Life, etc.: ">42</xxf:control>
                        <xxf:control id="my-foo$xf-5$xf-14" label="Life, etc.: ">42</xxf:control>
                    </xxf:control-values>
                </xxf:action>
            </xxf:event-response>
        </output>
    </test>

    <test description="XBL events through xbl:handler" name="oxf:pipeline">
        <input name="config">
            <p:config>
                <p:param name="response" type="output"/>

                <p:processor name="oxf:pipeline">
                    <p:input name="config" href="wrap-xforms-state.xpl"/>
                    <p:input name="document">
                        <xh:html>
                            <xh:head>
                                <xf:model id="model">
                                    <xf:dispatch ev:event="xforms-ready" name="up-value1" targetid="level1-component">
                                        <xf:property name="title-value1" value="'Cool title'"/>
                                    </xf:dispatch>

                                    <!-- TEST: Events to gather -->
                                    <xf:instance id="events">
                                        <events/>
                                    </xf:instance>

                                    <xf:instance xmlns="" id="main-instance">
                                        <root>
                                            <level1>
                                                <level2>
                                                    <level3>
                                                        <title/>
                                                    </level3>
                                                </level2>
                                            </level1>
                                        </root>
                                    </xf:instance>

                                </xf:model>
                                <xbl:xbl>
                                    <xbl:binding id="fr-level1-binding" element="fr|level1">
                                        <xbl:handlers>
                                            <xbl:handler event="#all" xxbl:scope="outer">
                                                <!-- TEST: Event listener -->
                                                <xf:insert if="not(event('xxf:type') = 'xxforms-index-changed')" context="xxf:instance('events')" ref="*"
                                                   origin="xxf:element('event',
                                                            (xxf:attribute('observer', event('xxf:observerid')),
                                                             xxf:attribute('type', event('xxf:type')),
                                                             xxf:attribute('target', event('xxf:targetid')),
                                                             xxf:attribute('phase', event('xxf:phase')),
                                                             xxf:attribute('original-target', event('xxf:targetid')),
                                                             xxf:attribute('indexes', string-join(event('xxf:repeat-indexes'), ' '))))"/>
                                            </xbl:handler>
                                            <xbl:handler event="up-value1" phase="target" xxbl:scope="outer">
                                                <xf:dispatch name="up-value2" targetid="level2-component">
                                                    <xf:property name="title-value2" value="event('title-value1')"/>
                                                </xf:dispatch>
                                            </xbl:handler>
                                        </xbl:handlers>
                                        <xbl:template>
                                            <xf:repeat id="level1-repeat" ref="level1" xxbl:scope="outer">
                                                <xf:dispatch ev:event="down-2" name="down-1" targetid="fr-level1-binding" xxbl:scope="inner"/>
                                                <fr:level2 id="level2-component"/>
                                            </xf:repeat>
                                        </xbl:template>
                                    </xbl:binding>
                                </xbl:xbl>
                                <xbl:xbl>
                                    <xbl:binding id="fr-level2-binding" element="fr|level2">
                                        <xbl:handlers>
                                            <xbl:handler event="#all" xxbl:scope="outer">
                                                <!-- TEST: Event listener -->
                                                <xf:insert if="not(event('xxf:type') = 'xxforms-index-changed')" context="xxf:instance('events')" ref="*"
                                                   origin="xxf:element('event',
                                                            (xxf:attribute('observer', event('xxf:observerid')),
                                                             xxf:attribute('type', event('xxf:type')),
                                                             xxf:attribute('target', event('xxf:targetid')),
                                                             xxf:attribute('phase', event('xxf:phase')),
                                                             xxf:attribute('original-target', event('xxf:targetid')),
                                                             xxf:attribute('indexes', string-join(event('xxf:repeat-indexes'), ' '))))"/>
                                            </xbl:handler>
                                            <xbl:handler event="up-value2" phase="target" xxbl:scope="outer">
                                                <xf:dispatch name="up-value3" targetid="level3-component">
                                                    <xf:property name="title-value3" value="event('title-value2')"/>
                                                </xf:dispatch>
                                            </xbl:handler>
                                        </xbl:handlers>
                                        <xbl:template>
                                            <xf:repeat id="level2-repeat" ref="level2" xxbl:scope="outer">
                                                <xf:dispatch ev:event="down-3" name="down-2" targetid="fr-level2-binding" xxbl:scope="inner"/>
                                                <fr:level3 id="level3-component"/>
                                            </xf:repeat>
                                        </xbl:template>
                                    </xbl:binding>
                                </xbl:xbl>
                                <xbl:xbl>
                                    <xbl:binding id="fr-level3-binding" element="fr|level3">
                                        <xbl:handlers>
                                            <xbl:handler event="#all" xxbl:scope="outer">
                                                <!-- TEST: Event listener -->
                                                <xf:insert if="not(event('xxf:type') = 'xxforms-index-changed')" context="xxf:instance('events')" ref="*"
                                                   origin="xxf:element('event',
                                                            (xxf:attribute('observer', event('xxf:observerid')),
                                                             xxf:attribute('type', event('xxf:type')),
                                                             xxf:attribute('target', event('xxf:targetid')),
                                                             xxf:attribute('phase', event('xxf:phase')),
                                                             xxf:attribute('original-target', event('xxf:targetid')),
                                                             xxf:attribute('indexes', string-join(event('xxf:repeat-indexes'), ' '))))"/>
                                            </xbl:handler>
                                            <xbl:handler event="up-value3" phase="target" xxbl:scope="outer">
                                                <!-- Set title value -->
                                                <xf:setvalue ref="level3/title" value="event('title-value3')"/>

                                                <!-- Focus on control to see DOMFocusIn retargeting -->
                                                <xf:setfocus control="title-control"/>
                                            </xbl:handler>
                                        </xbl:handlers>
                                        <xbl:template>
                                            <xf:repeat id="level3-repeat" ref="level3" xxbl:scope="outer">
                                                <xf:input id="title-control" ref="title">
                                                    <xf:dispatch ev:event="DOMFocusIn" name="down-3" targetid="fr-level3-binding" xxbl:scope="inner"/>
                                                </xf:input>
                                            </xf:repeat>
                                        </xbl:template>
                                    </xbl:binding>
                                </xbl:xbl>
                            </xh:head>
                            <xh:body>

                                <xf:group context="instance('main-instance')" id="main-group">
                                    <!-- TEST: Event listener -->
                                    <xf:insert if="not(event('xxf:type') = 'xxforms-index-changed')" ev:event="#all" context="instance('events')" ref="*"
                                                   origin="xxf:element('event',
                                                            (xxf:attribute('observer', event('xxf:observerid')),
                                                             xxf:attribute('type', event('xxf:type')),
                                                             xxf:attribute('target', event('xxf:targetid')),
                                                             xxf:attribute('phase', event('xxf:phase')),
                                                             xxf:attribute('original-target', event('xxf:targetid')),
                                                             xxf:attribute('indexes', string-join(event('xxf:repeat-indexes'), ' '))))"/>

                                    <!-- Top-level component -->
                                    <fr:level1 id="level1-component"/>
                                </xf:group>
                            </xh:body>
                        </xh:html>
                    </p:input>
                    <p:output name="response" ref="response"/>
                </p:processor>

            </p:config>
        </input>
        <output name="response">
            <xxf:event-response>
                <xxf:dynamic-state>
                    <dynamic-state>
                        <instances>
                            <instance id="events" model-id="model">
                                <events>
                                    <event observer="main-group" type="xforms-enabled" target="main-group" phase="target" original-target="main-group" indexes=""/>
                                    <event observer="level1-component" type="xforms-enabled" target="level1-component" phase="target" original-target="level1-component" indexes=""/>
                                    <event observer="main-group" type="xforms-enabled" target="level1-component" phase="bubbling" original-target="level1-component" indexes=""/>
                                    <event observer="level1-component" type="xforms-enabled" target="level1-repeat" phase="bubbling" original-target="level1-repeat" indexes=""/>
                                    <event observer="main-group" type="xforms-enabled" target="level1-repeat" phase="bubbling" original-target="level1-repeat" indexes=""/>
                                    <event observer="level2-component" type="xforms-enabled" target="level2-component" phase="target" original-target="level2-component" indexes="1"/>
                                    <event observer="level1-component" type="xforms-enabled" target="level2-component" phase="bubbling" original-target="level2-component" indexes="1"/>
                                    <event observer="main-group" type="xforms-enabled" target="level2-component" phase="bubbling" original-target="level2-component" indexes="1"/>
                                    <event observer="level2-component" type="xforms-enabled" target="level2-repeat" phase="bubbling" original-target="level2-repeat" indexes="1"/>
                                    <event observer="level1-component" type="xforms-enabled" target="level2-repeat" phase="bubbling" original-target="level2-repeat" indexes="1"/>
                                    <event observer="main-group" type="xforms-enabled" target="level2-repeat" phase="bubbling" original-target="level2-repeat" indexes="1"/>
                                    <event observer="level3-component" type="xforms-enabled" target="level3-component" phase="target" original-target="level3-component" indexes="1 1"/>
                                    <event observer="level2-component" type="xforms-enabled" target="level3-component" phase="bubbling" original-target="level3-component" indexes="1 1"/>
                                    <event observer="level1-component" type="xforms-enabled" target="level3-component" phase="bubbling" original-target="level3-component" indexes="1 1"/>
                                    <event observer="main-group" type="xforms-enabled" target="level3-component" phase="bubbling" original-target="level3-component" indexes="1 1"/>
                                    <event observer="level3-component" type="xforms-enabled" target="level3-repeat" phase="bubbling" original-target="level3-repeat" indexes="1 1"/>
                                    <event observer="level2-component" type="xforms-enabled" target="level3-repeat" phase="bubbling" original-target="level3-repeat" indexes="1 1"/>
                                    <event observer="level1-component" type="xforms-enabled" target="level3-repeat" phase="bubbling" original-target="level3-repeat" indexes="1 1"/>
                                    <event observer="main-group" type="xforms-enabled" target="level3-repeat" phase="bubbling" original-target="level3-repeat" indexes="1 1"/>
                                    <event observer="level3-component" type="xforms-enabled" target="title-control" phase="bubbling" original-target="title-control" indexes="1 1 1"/>
                                    <event observer="level2-component" type="xforms-enabled" target="title-control" phase="bubbling" original-target="title-control" indexes="1 1 1"/>
                                    <event observer="level1-component" type="xforms-enabled" target="title-control" phase="bubbling" original-target="title-control" indexes="1 1 1"/>
                                    <event observer="main-group" type="xforms-enabled" target="title-control" phase="bubbling" original-target="title-control" indexes="1 1 1"/>
                                    <event observer="level1-component" type="up-value1" target="level1-component" phase="target" original-target="level1-component" indexes=""/>
                                    <event observer="level2-component" type="up-value2" target="level2-component" phase="target" original-target="level2-component" indexes="1"/>
                                    <event observer="level3-component" type="up-value3" target="level3-component" phase="target" original-target="level3-component" indexes="1 1"/>
                                    <event observer="level3-component" type="xforms-value-changed" target="title-control" phase="bubbling" original-target="title-control" indexes="1 1 1"/>
                                    <event observer="level2-component" type="xforms-value-changed" target="title-control" phase="bubbling" original-target="title-control" indexes="1 1 1"/>
                                    <event observer="level1-component" type="xforms-value-changed" target="title-control" phase="bubbling" original-target="title-control" indexes="1 1 1"/>
                                    <event observer="main-group" type="xforms-value-changed" target="title-control" phase="bubbling" original-target="title-control" indexes="1 1 1"/>
                                    <event observer="main-group" type="DOMFocusIn" target="main-group" phase="target" original-target="main-group" indexes=""/>
                                    <event observer="level1-component" type="DOMFocusIn" target="level1-component" phase="target" original-target="level1-component" indexes=""/>
                                    <event observer="main-group" type="DOMFocusIn" target="level1-component" phase="bubbling" original-target="level1-component" indexes=""/>
                                    <event observer="level1-component" type="DOMFocusIn" target="level1-repeat" phase="bubbling" original-target="level1-repeat" indexes=""/>
                                    <event observer="main-group" type="DOMFocusIn" target="level1-repeat" phase="bubbling" original-target="level1-repeat" indexes=""/>
                                    <event observer="level1-component" type="DOMFocusIn" target="level1-repeat~iteration" phase="bubbling" original-target="level1-repeat~iteration" indexes="1"/>
                                    <event observer="main-group" type="DOMFocusIn" target="level1-repeat~iteration" phase="bubbling" original-target="level1-repeat~iteration" indexes="1"/>
                                    <event observer="level2-component" type="DOMFocusIn" target="level2-component" phase="target" original-target="level2-component" indexes="1"/>
                                    <event observer="level1-component" type="DOMFocusIn" target="level2-component" phase="bubbling" original-target="level2-component" indexes="1"/>
                                    <event observer="main-group" type="DOMFocusIn" target="level2-component" phase="bubbling" original-target="level2-component" indexes="1"/>
                                    <event observer="level2-component" type="DOMFocusIn" target="level2-repeat" phase="bubbling" original-target="level2-repeat" indexes="1"/>
                                    <event observer="level1-component" type="DOMFocusIn" target="level2-repeat" phase="bubbling" original-target="level2-repeat" indexes="1"/>
                                    <event observer="main-group" type="DOMFocusIn" target="level2-repeat" phase="bubbling" original-target="level2-repeat" indexes="1"/>
                                    <event observer="level2-component" type="DOMFocusIn" target="level2-repeat~iteration" phase="bubbling" original-target="level2-repeat~iteration" indexes="1 1"/>
                                    <event observer="level1-component" type="DOMFocusIn" target="level2-repeat~iteration" phase="bubbling" original-target="level2-repeat~iteration" indexes="1 1"/>
                                    <event observer="main-group" type="DOMFocusIn" target="level2-repeat~iteration" phase="bubbling" original-target="level2-repeat~iteration" indexes="1 1"/>
                                    <event observer="level3-component" type="DOMFocusIn" target="level3-component" phase="target" original-target="level3-component" indexes="1 1"/>
                                    <event observer="level2-component" type="DOMFocusIn" target="level3-component" phase="bubbling" original-target="level3-component" indexes="1 1"/>
                                    <event observer="level1-component" type="DOMFocusIn" target="level3-component" phase="bubbling" original-target="level3-component" indexes="1 1"/>
                                    <event observer="main-group" type="DOMFocusIn" target="level3-component" phase="bubbling" original-target="level3-component" indexes="1 1"/>
                                    <event observer="level3-component" type="DOMFocusIn" target="level3-repeat" phase="bubbling" original-target="level3-repeat" indexes="1 1"/>
                                    <event observer="level2-component" type="DOMFocusIn" target="level3-repeat" phase="bubbling" original-target="level3-repeat" indexes="1 1"/>
                                    <event observer="level1-component" type="DOMFocusIn" target="level3-repeat" phase="bubbling" original-target="level3-repeat" indexes="1 1"/>
                                    <event observer="main-group" type="DOMFocusIn" target="level3-repeat" phase="bubbling" original-target="level3-repeat" indexes="1 1"/>
                                    <event observer="level3-component" type="DOMFocusIn" target="level3-repeat~iteration" phase="bubbling" original-target="level3-repeat~iteration" indexes="1 1 1"/>
                                    <event observer="level2-component" type="DOMFocusIn" target="level3-repeat~iteration" phase="bubbling" original-target="level3-repeat~iteration" indexes="1 1 1"/>
                                    <event observer="level1-component" type="DOMFocusIn" target="level3-repeat~iteration" phase="bubbling" original-target="level3-repeat~iteration" indexes="1 1 1"/>
                                    <event observer="main-group" type="DOMFocusIn" target="level3-repeat~iteration" phase="bubbling" original-target="level3-repeat~iteration" indexes="1 1 1"/>
                                    <event observer="level3-component" type="down-3" target="level3-component" phase="target" original-target="level3-component" indexes="1 1"/>
                                    <event observer="level2-component" type="down-2" target="level2-component" phase="target" original-target="level2-component" indexes="1"/>
                                    <event observer="level1-component" type="down-1" target="level1-component" phase="target" original-target="level1-component" indexes=""/>
                                    <event observer="main-group" type="down-1" target="level1-component" phase="bubbling" original-target="level1-component" indexes=""/>
                                    <event observer="level1-component" type="down-2" target="level2-component" phase="bubbling" original-target="level2-component" indexes="1"/>
                                    <event observer="main-group" type="down-2" target="level2-component" phase="bubbling" original-target="level2-component" indexes="1"/>
                                    <event observer="level2-component" type="down-3" target="level3-component" phase="bubbling" original-target="level3-component" indexes="1 1"/>
                                    <event observer="level1-component" type="down-3" target="level3-component" phase="bubbling" original-target="level3-component" indexes="1 1"/>
                                    <event observer="main-group" type="down-3" target="level3-component" phase="bubbling" original-target="level3-component" indexes="1 1"/>
                                    <event observer="level3-component" type="DOMFocusIn" target="title-control" phase="bubbling" original-target="title-control" indexes="1 1 1"/>
                                    <event observer="level2-component" type="DOMFocusIn" target="title-control" phase="bubbling" original-target="title-control" indexes="1 1 1"/>
                                    <event observer="level1-component" type="DOMFocusIn" target="title-control" phase="bubbling" original-target="title-control" indexes="1 1 1"/>
                                    <event observer="main-group" type="DOMFocusIn" target="title-control" phase="bubbling" original-target="title-control" indexes="1 1 1"/>
                                    <event observer="level2-component" type="up-value3" target="level3-component" phase="bubbling" original-target="level3-component" indexes="1 1"/>
                                    <event observer="level1-component" type="up-value3" target="level3-component" phase="bubbling" original-target="level3-component" indexes="1 1"/>
                                    <event observer="main-group" type="up-value3" target="level3-component" phase="bubbling" original-target="level3-component" indexes="1 1"/>
                                    <event observer="level1-component" type="up-value2" target="level2-component" phase="bubbling" original-target="level2-component" indexes="1"/>
                                    <event observer="main-group" type="up-value2" target="level2-component" phase="bubbling" original-target="level2-component" indexes="1"/>
                                    <event observer="main-group" type="up-value1" target="level1-component" phase="bubbling" original-target="level1-component" indexes=""/>
                                </events>
                            </instance>
                            <instance id="main-instance" model-id="model">
                                <root>
                                    <level1>
                                        <level2>
                                            <level3>
                                                <title>Cool title</title>
                                            </level3>
                                        </level2>
                                    </level1>
                                </root>
                            </instance>
                        </instances>
                        <controls>
                            <control effective-id="level1-component$level1-repeat" index="1"/>
                            <control effective-id="level1-component$level2-component$level2-repeat·1" index="1"/>
                            <control effective-id="level1-component$level2-component$level3-component$level3-repeat·1-1" index="1"/>
                        </controls>
                    </dynamic-state>
                </xxf:dynamic-state>
                <xxf:action>
                    <xxf:control-values>
                        <xxf:control id="level1-component$level2-component$level3-component$title-control·1-1-1">Cool title</xxf:control>
                    </xxf:control-values>
                    <xxf:focus control-id="level1-component$level2-component$level3-component$title-control·1-1-1"/>
                </xxf:action>
            </xxf:event-response>
        </output>
    </test>

    <test description="Simple toggle to XBL outer scope" name="oxf:pipeline">
        <input name="config" href="wrap-xforms-state.xpl"/>
        <input name="document">
            <xh:html>
                <xh:head>
                    <xf:model id="model">
                        <xf:instance id="instance">
                            <instance/>
                        </xf:instance>

                        <!-- my-case-2 is copied via xbl:content, so must be visible to this toggle -->
                        <xf:toggle ev:event="xforms-ready" case="my-case-2"/>

                    </xf:model>
                    <xbl:xbl>
                        <xbl:binding id="fr-foobar" element="fr|foobar">
                            <xbl:template>
                                <xbl:content/>
                            </xbl:template>
                        </xbl:binding>
                    </xbl:xbl>
                </xh:head>
                <xh:body>
                    <fr:foobar id="my-foobar">
                        <xf:switch id="my-switch">
                            <xf:case id="my-case-1"/>
                            <xf:case id="my-case-2"/>
                        </xf:switch>
                    </fr:foobar>
                </xh:body>
            </xh:html>
        </input>
        <output name="response">
            <xxf:event-response>
                <xxf:dynamic-state>
                    <dynamic-state>
                        <controls>
                            <control effective-id="my-foobar$my-switch" case-id="my-case-2"/>
                        </controls>
                    </dynamic-state>
                </xxf:dynamic-state>
                <xxf:action>
                    <xxf:control-values>
                        <xxf:div id="my-foobar$my-case-2" visibility="visible"/>
                        <xxf:div id="my-foobar$my-case-1" visibility="hidden"/>
                    </xxf:control-values>
                </xxf:action>
            </xxf:event-response>
        </output>
    </test>

    <test description="Toggle through two levels of XBL outer scope" name="oxf:pipeline">
        <input name="config" href="wrap-xforms-state.xpl"/>
        <input name="document">
            <xh:html>
                <xh:head>
                    <xf:model id="model">
                        <xf:instance id="instance">
                            <instance/>
                        </xf:instance>

                        <!-- my-case-2 is copied via xbl:content, so must be visible to this toggle -->
                        <xf:toggle ev:event="xforms-ready" case="my-case-2"/>

                    </xf:model>
                    <xbl:xbl>
                        <xbl:binding id="fr-foo" element="fr|foo">
                            <xbl:template>
                                <!-- Outer scope must be specified here; id will be generated automatically to be unique -->
                                <fr:bar xxbl:scope="outer">
                                    <xbl:content/>
                                </fr:bar>
                            </xbl:template>
                        </xbl:binding>
                    </xbl:xbl>
                    <xbl:xbl>
                        <xbl:binding id="fr-bar" element="fr|bar">
                            <xbl:template>
                                <xbl:content/>
                            </xbl:template>
                        </xbl:binding>
                    </xbl:xbl>
                </xh:head>
                <xh:body>
                    <fr:foo id="my-foo">
                        <xf:switch id="my-switch">
                            <xf:case id="my-case-1"/>
                            <xf:case id="my-case-2"/>
                        </xf:switch>
                    </fr:foo>
                </xh:body>
            </xh:html>
        </input>
        <output name="response">
            <xxf:event-response>
                <xxf:dynamic-state>
                    <dynamic-state>
                        <controls>
                            <control effective-id="my-foo$xf-5$my-switch" case-id="my-case-2"/>
                        </controls>
                    </dynamic-state>
                </xxf:dynamic-state>
                <xxf:action>
                    <xxf:control-values>
                        <xxf:div id="my-foo$xf-5$my-case-2" visibility="visible"/>
                        <xxf:div id="my-foo$xf-5$my-case-1" visibility="hidden"/>
                    </xxf:control-values>
                </xxf:action>
            </xxf:event-response>
        </output>
    </test>

    <test description="Automatic generation of unique id through outer scope" name="oxf:pipeline">
        <input name="config" href="wrap-xforms-state.xpl"/>
        <input name="document">
            <xh:html>
                <xh:head>
                    <xf:model id="model">
                        <xf:instance id="instance">
                            <instance>42</instance>
                        </xf:instance>
                    </xf:model>
                    <xbl:xbl>
                        <xbl:binding id="fr-foo" element="fr|foo">
                            <xbl:template>
                                <!-- group and input will get automatic unique ids in outer scope -->
                                <xf:group xxbl:scope="outer">
                                    <xf:input ref="."/>
                                </xf:group>
                            </xbl:template>
                        </xbl:binding>
                    </xbl:xbl>
                </xh:head>
                <xh:body>
                    <!-- Use ids likely to cause clashes -->
                    <xf:input ref="." id="xf-2"/>
                    <xf:input ref="." id="xf-3"/>
                    <xf:input ref="." id="xf-4"/>
                    <xf:input ref="." id="xf-5"/>
                    <xf:input ref="." id="xf-6"/>
                    <xf:input ref="." id="xf-7"/>
                    <xf:input ref="." id="xf-8"/>
                    <fr:foo id="my-foo-1"/>
                    <fr:foo id="my-foo-2"/>
                </xh:body>
            </xh:html>
        </input>
        <output name="response">
            <xxf:event-response>
                <xxf:dynamic-state>
                    <dynamic-state/>
                </xxf:dynamic-state>
                <xxf:action>
                    <xxf:control-values>
                        <xxf:control id="xf-2">42</xxf:control>
                        <xxf:control id="xf-3">42</xxf:control>
                        <xxf:control id="xf-4">42</xxf:control>
                        <xxf:control id="xf-5">42</xxf:control>
                        <xxf:control id="xf-6">42</xxf:control>
                        <xxf:control id="xf-7">42</xxf:control>
                        <xxf:control id="xf-8">42</xxf:control>
                        <xxf:control id="my-foo-1$xf-11">42</xxf:control>
                        <xxf:control id="my-foo-2$xf-14">42</xxf:control>
                    </xxf:control-values>
                </xxf:action>
            </xxf:event-response>
        </output>
    </test>

    <test description="Separation of inner/outer scope for id resolution" name="oxf:pipeline">
        <input name="config" href="wrap-xforms-state.xpl"/>
        <input name="document">
            <xh:html>
                <xh:head>
                    <xf:model id="model">
                        <xf:instance id="instance">
                            <instance/>
                        </xf:instance>
                    </xf:model>
                    <xbl:xbl>
                        <xbl:binding id="fr-foo" element="fr|foo">
                            <xbl:template>
                                <xf:switch id="my-switch">
                                    <xf:toggle ev:event="xforms-enabled" case="my-case-2"/>
                                    <xf:case id="my-case-1"/>
                                    <xf:case id="my-case-2"/>
                                    <xf:case id="my-case-3"/>
                                </xf:switch>
                            </xbl:template>
                        </xbl:binding>
                        <xbl:binding id="fr-bar" element="fr|bar">
                            <xbl:template>
                                <xf:switch id="my-switch">
                                    <xf:toggle ev:event="xforms-enabled" case="my-case-3"/>
                                    <xf:case id="my-case-1"/>
                                    <xf:case id="my-case-2"/>
                                    <xf:case id="my-case-3"/>
                                </xf:switch>
                            </xbl:template>
                        </xbl:binding>
                    </xbl:xbl>
                </xh:head>
                <xh:body>
                    <fr:foo id="my-foo-1"/>
                    <fr:foo id="my-foo-2"/>
                    <fr:bar id="my-bar-1"/>
                    <fr:bar id="my-bar-2"/>
                    <xf:switch id="my-switch">
                        <xf:toggle ev:event="xforms-enabled" case="my-case-1"/>
                        <xf:case id="my-case-1"/>
                        <xf:case id="my-case-2"/>
                        <xf:case id="my-case-3" selected="true"/>
                    </xf:switch>
                </xh:body>
            </xh:html>
        </input>
        <output name="response">
            <xxf:event-response>
                <xxf:dynamic-state>
                    <dynamic-state>
                        <controls>
                            <control effective-id="my-foo-1$my-switch" case-id="my-case-2"/>
                            <control effective-id="my-foo-2$my-switch" case-id="my-case-2"/>
                            <control effective-id="my-bar-1$my-switch" case-id="my-case-3"/>
                            <control effective-id="my-bar-2$my-switch" case-id="my-case-3"/>
                            <control effective-id="my-switch" case-id="my-case-1"/>
                        </controls>
                    </dynamic-state>
                </xxf:dynamic-state>
                <xxf:action>
                    <xxf:control-values>
                        <xxf:div id="my-foo-1$my-case-2" visibility="visible"/>
                        <xxf:div id="my-foo-1$my-case-1" visibility="hidden"/>
                        <xxf:div id="my-foo-1$my-case-3" visibility="hidden"/>
                        <xxf:div id="my-foo-2$my-case-2" visibility="visible"/>
                        <xxf:div id="my-foo-2$my-case-1" visibility="hidden"/>
                        <xxf:div id="my-foo-2$my-case-3" visibility="hidden"/>
                        <xxf:div id="my-bar-1$my-case-3" visibility="visible"/>
                        <xxf:div id="my-bar-1$my-case-1" visibility="hidden"/>
                        <xxf:div id="my-bar-1$my-case-2" visibility="hidden"/>
                        <xxf:div id="my-bar-2$my-case-3" visibility="visible"/>
                        <xxf:div id="my-bar-2$my-case-1" visibility="hidden"/>
                        <xxf:div id="my-bar-2$my-case-2" visibility="hidden"/>
                        <xxf:div id="my-case-1" visibility="visible"/>
                        <xxf:div id="my-case-2" visibility="hidden"/>
                        <xxf:div id="my-case-3" visibility="hidden"/>
                    </xxf:control-values>
                </xxf:action>
            </xxf:event-response>
        </output>
    </test>

    <test description="xf:setindex causes outer model to be recalculated/revalidated" name="oxf:pipeline">
        <input name="config" href="wrap-xforms-state.xpl"/>
        <input name="document">
            <xh:html>
                <xh:head>
                    <xf:model id="model">
                        <xf:instance id="instance">
                            <instance>
                                <value>1</value>
                                <value>2</value>
                                <index/>
                            </instance>
                        </xf:instance>

                        <xf:bind ref="index" calculate="index('my-repeat')"/>

                        <xf:setindex ev:event="xforms-ready" repeat="my-repeat" index="2"/>

                    </xf:model>
                    <xbl:xbl>
                        <xbl:binding id="fr-foo" element="fr|foo">
                            <xbl:template>
                                <xf:model id="foo-model">
                                    <xf:instance id="foo-instance">
                                        <instance/>
                                    </xf:instance>
                                </xf:model>
                                <xbl:content/>
                            </xbl:template>
                        </xbl:binding>
                    </xbl:xbl>
                </xh:head>
                <xh:body>
                    <fr:foo id="my-foo">
                        <xf:repeat id="my-repeat" ref="value">

                        </xf:repeat>
                    </fr:foo>
                </xh:body>
            </xh:html>
        </input>
        <output name="response">
            <xxf:event-response>
                <xxf:dynamic-state>
                    <dynamic-state>
                        <instances>
                            <instance id="instance" model-id="model">
                                <instance>
                                    <value>1</value>
                                    <value>2</value>
                                    <index>2</index>
                                </instance>
                            </instance>
                        </instances>
                        <controls>
                            <control effective-id="my-foo$my-repeat" index="2"/>
                        </controls>
                    </dynamic-state>
                </xxf:dynamic-state>
                <xxf:action>
                    <xxf:control-values/>
                </xxf:action>
            </xxf:event-response>
        </output>
    </test>

    <test description="Event handler observing XBL bound element" name="oxf:pipeline">
        <input name="config" href="wrap-xforms-state.xpl"/>
        <input name="document">
            <xh:html>
                <xh:head>
                    <xf:model id="model">
                        <xf:instance id="instance">
                            <instance/>
                        </xf:instance>

                        <!-- TEST: Events to gather -->
                        <xf:instance id="events">
                            <events/>
                        </xf:instance>

                        <xf:insert ev:event="my-event-1 my-event-2" context="instance('events')" ref="*"
                                       origin="xxf:element('event',
                                                (xxf:attribute('type', event('xxf:type')),
                                                 xxf:attribute('target', event('xxf:targetid'))
                                                 ))"/>

                    </xf:model>
                    <xbl:xbl>
                        <xbl:binding id="fr-foo" element="fr|foo">
                            <xbl:template>
                                <xbl:content includes="* > *"/>
                            </xbl:template>
                        </xbl:binding>
                    </xbl:xbl>
                </xh:head>
                <xh:body>
                    <fr:foo id="my-foo">
                        <!-- Don't put an id on the action -->
                        <xf:action ev:event="xforms-enabled xforms-disabled">
                            <xf:insert context="instance('events')" ref="*"
                                           origin="xxf:element('event',
                                                    (xxf:attribute('type', event('xxf:type')),
                                                     xxf:attribute('target', event('xxf:targetid'))
                                                     ))"/>
                            <xf:dispatch name="my-event-1" targetid="model"/>
                        </xf:action>
                        <xf:input id="my-foo-input" ref="."/>
                    </fr:foo>
                    <fr:foo id="my-foo-2">
                        <!-- Put an id on the action -->
                        <xf:action ev:event="xforms-enabled xforms-disabled" id="my-event">
                            <xf:insert context="instance('events')" ref="*"
                                           origin="xxf:element('event',
                                                    (xxf:attribute('type', event('xxf:type')),
                                                     xxf:attribute('target', event('xxf:targetid'))
                                                     ))"/>
                            <xf:dispatch name="my-event-2" targetid="model"/>
                        </xf:action>
                        <xf:input id="my-foo-input-2" ref="."/>
                    </fr:foo>
                </xh:body>
            </xh:html>
        </input>
        <output name="response">
            <xxf:event-response>
                <xxf:dynamic-state>
                    <dynamic-state>
                        <instances>
                            <instance id="events" model-id="model">
                                <events>
                                    <event type="xforms-enabled" target="my-foo"/>
                                    <event type="my-event-1" target="model"/>
                                    <event type="xforms-enabled" target="my-foo-input"/>
                                    <event type="my-event-1" target="model"/>
                                    <event type="xforms-enabled" target="my-foo-2"/>
                                    <event type="my-event-2" target="model"/>
                                    <event type="xforms-enabled" target="my-foo-input-2"/>
                                    <event type="my-event-2" target="model"/>
                                </events>
                            </instance>
                        </instances>
                    </dynamic-state>
                </xxf:dynamic-state>
                <xxf:action>
                    <xxf:control-values/>
                </xxf:action>
            </xxf:event-response>
        </output>
    </test>

    <test description="Simple variable/sequence inner/outer scoping" name="oxf:pipeline">
        <input name="config" href="wrap-xforms-state.xpl"/>
        <input name="document">
            <xh:html>
                <xh:head>
                    <xf:model id="model">
                        <xf:instance id="instance">
                            <instance>
                                <foo>42</foo>
                                <bar>43</bar>
                            </instance>
                        </xf:instance>
                    </xf:model>
                    <xbl:xbl>
                        <xbl:binding id="fr-foo" element="fr|foo">
                            <xbl:template>
                                <!-- Outer group -->
                                <xf:group xxbl:scope="outer" xbl:attr="model context ref bind">
                                    <xf:output ref="."/>
                                    <!-- Inner group -->
                                    <xf:group id="component-inner-group" appearance="xxf:internal" xxbl:scope="inner">

                                        <!-- Variable pointing to external single-node binding -->
                                        <xf:var name="result" as="node()?">
                                            <xxf:sequence value="." xxbl:scope="outer"/>
                                        </xf:var>

                                        <xf:output id="my-inner-output" ref="$result"/>

                                    </xf:group>
                                </xf:group>
                            </xbl:template>
                        </xbl:binding>
                    </xbl:xbl>
                </xh:head>
                <xh:body>
                    <fr:foo id="my-foo-1" ref="foo"/>
                    <fr:foo id="my-foo-2" ref="bar"/>
                </xh:body>
            </xh:html>
        </input>
        <output name="response">
            <xxf:event-response>
                <xxf:dynamic-state>
                    <dynamic-state/>
                </xxf:dynamic-state>
                <xxf:action>
                    <xxf:control-values>
                        <xxf:control id="my-foo-1$xf-4">42</xxf:control>
                        <xxf:control id="my-foo-1$my-inner-output">42</xxf:control>
                        <xxf:control id="my-foo-2$xf-9">43</xxf:control>
                        <xxf:control id="my-foo-2$my-inner-output">43</xxf:control>
                    </xxf:control-values>
                </xxf:action>
            </xxf:event-response>
        </output>
    </test>

    <test description="Copied items have access to outer scope" name="oxf:pipeline">
        <input name="config" href="wrap-xforms-state.xpl"/>
        <input name="document">
            <xh:html>
                <xh:head>
                    <xf:model id="model" xxf:encrypt-item-values="false">
                        <xf:instance id="instance">
                            <instance>
                                <foo>42</foo>
                                <bar>43</bar>
                            </instance>
                        </xf:instance>
                        <xf:instance id="items">
                            <items>
                                <item label="Apple" value="apple"/>
                                <item label="Orange" value="orange"/>
                                <item label="Banana" value="banana"/>
                                <item label="Kiwi" value="kiwi"/>
                            </items>
                        </xf:instance>
                    </xf:model>
                    <xbl:xbl>
                        <xbl:binding id="fr-foo" element="fr|foo">
                            <xbl:template>
                                <!-- Outer group -->
                                <xf:group xxbl:scope="outer" xbl:attr="model context ref bind">
                                    <xf:output ref="."/>
                                    <!-- Inner group -->
                                    <xf:group id="component-inner-group" appearance="xxf:internal" xxbl:scope="inner">

                                        <!-- Variable pointing to external single-node binding -->
                                        <xf:var name="result" as="node()?">
                                            <xxf:sequence value="." xxbl:scope="outer"/>
                                        </xf:var>

                                        <xf:select1 id="my-inner-select1" ref="$result">
                                            <xbl:content includes="fr|foo > xf|itemset, fr|foo > xf|choices, fr|foo > xf:item"/>
                                        </xf:select1>

                                    </xf:group>
                                </xf:group>
                            </xbl:template>
                        </xbl:binding>
                    </xbl:xbl>
                </xh:head>
                <xh:body>
                    <!-- Itemset -->
                    <fr:foo id="my-foo-1" ref="foo">
                        <xf:itemset ref="instance('items')/item[position() mod 2 = 1]">
                            <xf:label ref="@label"/>
                            <xf:value ref="@value"/>
                        </xf:itemset>
                    </fr:foo>
                    <!-- Choices and item -->
                    <fr:foo id="my-foo-2" ref="bar">
                        <xf:choices>
                            <xf:label ref="."/>
                            <xf:item>
                                <xf:label>Pear</xf:label>
                                <xf:value>pear</xf:value>
                            </xf:item>
                        </xf:choices>
                        <xf:choices>
                            <xf:label ref="../foo"/>
                            <xf:itemset ref="instance('items')/item[position() mod 2 = 0]">
                                <xf:label ref="@label"/>
                                <xf:value ref="@value"/>
                            </xf:itemset>
                        </xf:choices>
                        <xf:item>
                            <xf:label ref="instance('items')/item[1]/@label"/>
                            <xf:value ref="instance('items')/item[1]/@value"/>
                        </xf:item>
                    </fr:foo>
                </xh:body>
            </xh:html>
        </input>
        <output name="response">
            <xxf:event-response>
                <xxf:dynamic-state>
                    <dynamic-state/>
                </xxf:dynamic-state>
                <xxf:action>
                    <xxf:control-values>
                        <xxf:control id="my-foo-1$xf-4">42</xxf:control>
                        <xxf:itemset id="my-foo-1$my-inner-select1">[{"label":"Apple","value":"apple"},{"label":"Banana","value":"banana"}]</xxf:itemset>
                        <xxf:control id="my-foo-2$xf-12">43</xxf:control>
                        <xxf:itemset id="my-foo-2$my-inner-select1">[{"label":"43","value":"","children":[{"label":"Pear","value":"pear"}]},{"label":"42","value":"","children":[{"label":"Orange","value":"orange"},{"label":"Kiwi","value":"kiwi"}]},{"label":"Apple","value":"apple"}]</xxf:itemset>
                    </xxf:control-values>
                </xxf:action>
            </xxf:event-response>
        </output>
    </test>

    <test description="Variable scoping doesn't affect following controls scoping" name="oxf:pipeline">
        <input name="config" href="wrap-xforms-state.xpl"/>
        <input name="document">
            <xh:html>
                <xh:head>
                    <xf:model id="model">
                        <xf:instance id="instance">
                            <instance>
                                <foo>42</foo>
                                <bar>43</bar>
                            </instance>
                        </xf:instance>
                    </xf:model>
                    <xbl:xbl>
                        <xbl:binding id="fr-foo" element="fr|foo">
                            <xbl:template>
                                <xf:group xxbl:scope="outer" xbl:attr="model context ref bind">

                                    <xf:output value="."/>

                                    <xf:var name="result" as="node()?" xxbl:scope="inner">
                                        <xxf:sequence value="." xxbl:scope="outer"/>
                                    </xf:var>

                                    <xf:group>
                                        <xf:var name="result" as="node()?" value="."/>
                                        <xf:output value="."/>
                                        <xf:output value="$result"/>
                                    </xf:group>

                                    <xf:group id="my-inner-group" xxbl:scope="inner">
                                        <xf:output id="my-output-1" value="."/>
                                        <xf:output id="my-output-2" value="$result"/>
                                    </xf:group>

                                </xf:group>
                            </xbl:template>
                        </xbl:binding>
                    </xbl:xbl>
                </xh:head>
                <xh:body>
                    <fr:foo id="my-foo-1" ref="foo"/>
                </xh:body>
            </xh:html>
        </input>
        <output name="response">
            <xxf:event-response>
                <xxf:dynamic-state>
                    <dynamic-state/>
                </xxf:dynamic-state>
                <xxf:action>
                    <xxf:control-values>
                        <xxf:control id="my-foo-1$xf-4">42</xxf:control>
                        <xxf:control id="my-foo-1$xf-9">42</xxf:control>
                        <xxf:control id="my-foo-1$xf-10">42</xxf:control>
                        <xxf:control id="my-foo-1$my-output-2">42</xxf:control>
                    </xxf:control-values>
                </xxf:action>
            </xxf:event-response>
        </output>
    </test>

    <test description="Scoping of model variables upon model change" name="oxf:pipeline">
        <input name="config" href="wrap-xforms-state.xpl"/>
        <input name="document">
            <xh:html>
                <xh:head>
                    <xf:model id="model1">
                        <xf:instance id="instance1">
                            <instance>
                                <foo>42</foo>
                                <bar>43</bar>
                            </instance>
                        </xf:instance>
                        <xf:var name="foo" value="foo"/>
                        <xf:var name="bar" value="bar"/>
                    </xf:model>
                    <xf:model id="model2">
                        <xf:instance id="instance2">
                            <instance>
                                <foo>44</foo>
                                <bar>45</bar>
                            </instance>
                        </xf:instance>
                        <xf:var name="foo" value="foo"/>
                        <xf:var name="bar" value="bar"/>
                    </xf:model>
                    <xbl:xbl>
                        <xbl:binding id="fr-foo" element="fr|foo">
                            <xbl:template>
                                <xbl:content/>
                            </xbl:template>
                        </xbl:binding>
                    </xbl:xbl>
                </xh:head>
                <xh:body>
                    <!-- Top-level -->
                    <xf:output id="output1" value="string-join((foo, bar, $foo, $bar), ', ')"/>
                    <xf:group model="model2">
                        <xf:output id="output2" value="string-join((foo, bar, $foo, $bar), ', ')"/>
                        <xf:group model="model1">
                            <xf:output id="output3" value="string-join((foo, bar, $foo, $bar), ', ')"/>
                        </xf:group>
                    </xf:group>
                    <xf:group model="model2" context="bar">
                        <xf:output id="output4" value="string-join((../foo, ., $foo, $bar), ', ')"/>
                        <xf:group model="model1" context="foo">
                            <xf:output id="output5" value="string-join((., ../bar, $foo, $bar), ', ')"/>
                        </xf:group>
                    </xf:group>
                     <!-- Nested within XBL -->
                    <fr:foo id="my-foo">
                        <xf:output id="output6" value="string-join((foo, bar, $foo, $bar), ', ')"/>
                        <xf:group model="model2">
                            <xf:output id="output7" value="string-join((foo, bar, $foo, $bar), ', ')"/>
                            <xf:group model="model1">
                                <xf:output id="output8" value="string-join((foo, bar, $foo, $bar), ', ')"/>
                            </xf:group>
                        </xf:group>
                        <xf:group model="model2" context="bar">
                            <xf:output id="output9" value="string-join((../foo, ., $foo, $bar), ', ')"/>
                            <xf:group model="model1" context="foo">
                                <xf:output id="output10" value="string-join((., ../bar, $foo, $bar), ', ')"/>
                            </xf:group>
                        </xf:group>
                    </fr:foo>
                </xh:body>
            </xh:html>
        </input>
        <output name="response">
            <xxf:event-response>
                <xxf:dynamic-state>
                    <dynamic-state/>
                </xxf:dynamic-state>
                <xxf:action>
                    <xxf:control-values>
                        <xxf:control id="output1">42, 43, 42, 43</xxf:control>
                        <xxf:control id="output2">44, 45, 44, 45</xxf:control>
                        <xxf:control id="output3">42, 43, 42, 43</xxf:control>
                        <xxf:control id="output4">44, 45, 44, 45</xxf:control>
                        <xxf:control id="output5">42, 43, 42, 43</xxf:control>
                        <xxf:control id="my-foo$output6">42, 43, 42, 43</xxf:control>
                        <xxf:control id="my-foo$output7">44, 45, 44, 45</xxf:control>
                        <xxf:control id="my-foo$output8">42, 43, 42, 43</xxf:control>
                        <xxf:control id="my-foo$output9">44, 45, 44, 45</xxf:control>
                        <xxf:control id="my-foo$output10">42, 43, 42, 43</xxf:control>
                    </xxf:control-values>
                </xxf:action>
            </xxf:event-response>
        </output>
    </test>

    <test description="XBL outer group binding attributes" name="oxf:pipeline">
        <input name="config" href="wrap-xforms-state.xpl"/>
        <input name="document">
            <xh:html>
                <xh:head>
                    <xf:model id="model1">
                        <xf:instance id="instance1">
                            <instance>
                                <foo>42</foo>
                                <bar>43</bar>
                            </instance>
                        </xf:instance>
                        <xf:bind id="foo-bind1" ref="foo"/>
                        <xf:bind id="bar-bind1" ref="bar"/>
                        <xf:var name="foo" value="foo"/>
                        <xf:var name="bar" value="bar"/>
                    </xf:model>
                    <xf:model id="model2">
                        <xf:instance id="instance2">
                            <instance>
                                <foo>44</foo>
                                <bar>45</bar>
                            </instance>
                        </xf:instance>
                        <xf:bind id="foo-bind2" ref="foo"/>
                        <xf:bind id="bar-bind2" ref="bar"/>
                        <xf:var name="foo" value="foo"/>
                        <xf:var name="bar" value="bar"/>
                    </xf:model>
                    <xbl:xbl>
                        <xbl:binding id="fr-foo" element="fr|foo">
                            <xbl:template>
                                <xf:group xbl:attr="model context ref bind" xxbl:scope="outer">
                                    <xf:output value="."/>
                                </xf:group>
                            </xbl:template>
                        </xbl:binding>
                    </xbl:xbl>
                </xh:head>
                <xh:body>
                    <fr:foo id="foo10"/>
                    <fr:foo id="foo11" ref="bar"/>
                    <fr:foo id="foo12" ref="$bar"/>
                    <fr:foo id="foo13" bind="foo-bind1"/>
                    <fr:foo id="foo14" bind="bar-bind1"/>
                    <fr:foo id="foo15" bind="foo-bind2"/>
                    <fr:foo id="foo16" bind="bar-bind2"/>

                    <fr:foo id="foo20" model="model2"/>
                    <fr:foo id="foo21" model="model2" ref="bar"/>
                    <fr:foo id="foo22" model="model2" ref="$bar"/>
                    <fr:foo id="foo23" model="model2" bind="foo-bind1"/>
                    <fr:foo id="foo24" model="model2" bind="bar-bind1"/>
                    <fr:foo id="foo25" model="model2" bind="foo-bind2"/>
                    <fr:foo id="foo26" model="model2" bind="bar-bind2"/>

                </xh:body>
            </xh:html>
        </input>
        <output name="response">
            <xxf:event-response>
                <xxf:dynamic-state>
                    <dynamic-state/>
                </xxf:dynamic-state>
                <xxf:action>
                    <xxf:control-values>
                        <xxf:control id="foo10$xf-8">42 43</xxf:control>
                        <xxf:control id="foo11$xf-11">43</xxf:control>
                        <xxf:control id="foo12$xf-14">43</xxf:control>
                        <xxf:control id="foo13$xf-17">42</xxf:control>
                        <xxf:control id="foo14$xf-20">43</xxf:control>
                        <xxf:control id="foo15$xf-23">44</xxf:control>
                        <xxf:control id="foo16$xf-26">45</xxf:control>
                        <xxf:control id="foo20$xf-29">44 45</xxf:control>
                        <xxf:control id="foo21$xf-32">45</xxf:control>
                        <xxf:control id="foo22$xf-35">45</xxf:control>
                        <xxf:control id="foo23$xf-38">42</xxf:control>
                        <xxf:control id="foo24$xf-41">43</xxf:control>
                        <xxf:control id="foo25$xf-44">44</xxf:control>
                        <xxf:control id="foo26$xf-47">45</xxf:control>
                    </xxf:control-values>
                </xxf:action>
            </xxf:event-response>
        </output>
    </test>

    <test description="Event handler in component observes object in outer scope" name="oxf:pipeline">
        <input name="config" href="wrap-xforms-state.xpl"/>
        <input name="document">
            <xh:html>
                <xh:head>
                    <xf:model id="model1">
                        <xf:instance id="instance1">
                            <instance>
                                <foo>42</foo>
                            </instance>
                        </xf:instance>
                        <xf:dispatch ev:event="xforms-ready" name="foobar" targetid="my-input"/>
                    </xf:model>
                    <xbl:xbl>
                        <xbl:binding id="fr-foo" element="fr|foo">
                            <xbl:template>
                                <!-- NOTE: Put the entire group in outer scope, as we can't yet deal with different
                                     scopes for control and nested action -->
                                <xf:group id="my-group" xxbl:scope="outer">
                                    <!-- Observe object in outer scope -->
                                    <xf:setvalue ev:event="foobar" ev:observer="my-input" ref="foo">43</xf:setvalue>
                                </xf:group>
                            </xbl:template>
                        </xbl:binding>
                    </xbl:xbl>
                </xh:head>
                <xh:body>

                    <!-- Just a control to dispatch events to -->
                    <xf:input id="my-input" ref="foo"/>
                    <!-- Instantiate component -->
                    <fr:foo/>

                </xh:body>
            </xh:html>
        </input>
        <output name="response">
            <xxf:event-response>
                <xxf:dynamic-state>
                    <dynamic-state>
                        <instances>
                            <instance id="instance1" model-id="model1">
                                <instance>
                                    <foo>43</foo>
                                </instance>
                            </instance>
                        </instances>
                    </dynamic-state>
                </xxf:dynamic-state>
                <xxf:action>
                    <xxf:control-values>
                        <xxf:control id="my-input">43</xxf:control>
                    </xxf:control-values>
                </xxf:action>
            </xxf:event-response>
        </output>
    </test>

    <test description="#314476: Event handler outside component observes object within component" name="oxf:pipeline">
        <!-- See: http://forge.ow2.org/tracker/index.php?func=detail&aid=314476&group_id=168&atid=350207 -->
        <input name="config" href="wrap-xforms-state.xpl"/>
        <input name="document">
            <xh:html>
                <xh:head>
                    <xf:model id="model1">
                        <xf:instance id="instance1">
                            <instance>
                                <foo>42</foo>
                            </instance>
                        </xf:instance>
                        <xf:dispatch ev:event="xforms-ready" name="foobar" targetid="my-input"/>
                    </xf:model>
                    <xbl:xbl>
                        <xbl:binding id="fr-foo" element="fr|foo">
                            <xbl:template>
                                <xf:group id="my-group">
                                    <!-- Insert content in outer scope -->
                                    <xbl:content/>
                                </xf:group>
                            </xbl:template>
                        </xbl:binding>
                    </xbl:xbl>
                </xh:head>
                <xh:body>
                    <xf:group id="my-group">
                        <!-- Observe object within component -->
                        <xf:setvalue ev:event="foobar" ev:observer="my-input" ref="foo">43</xf:setvalue>

                        <!-- Instantiate component -->
                        <fr:foo id="my-foo">
                            <xf:input id="my-input" ref="foo"/>
                        </fr:foo>
                    </xf:group>
                </xh:body>
            </xh:html>
        </input>
        <output name="response">
            <xxf:event-response>
                <xxf:dynamic-state>
                    <dynamic-state>
                        <instances>
                            <instance id="instance1" model-id="model1">
                                <instance>
                                    <foo>43</foo>
                                </instance>
                            </instance>
                        </instances>
                    </dynamic-state>
                </xxf:dynamic-state>
                <xxf:action>
                    <xxf:control-values>
                        <xxf:control id="my-foo$my-input">43</xxf:control>
                    </xxf:control-values>
                </xxf:action>
            </xxf:event-response>
        </output>
    </test>

    <test description="Event handler child of bound node" name="oxf:pipeline">
        <input name="config" href="wrap-xforms-state.xpl"/>
        <input name="document">
            <xh:html>
                <xh:head>
                    <xf:model id="model1">
                        <xf:instance id="instance1">
                            <instance>
                                <foo>42</foo>
                            </instance>
                        </xf:instance>
                        <xf:dispatch ev:event="xforms-ready" name="my-event" targetid="my-foo"/>
                    </xf:model>
                    <xbl:xbl>
                        <xbl:binding id="fr-foo" element="fr|foo">
                            <xbl:template>
                                <xbl:content/>
                                <xh:div/>
                            </xbl:template>
                        </xbl:binding>
                    </xbl:xbl>
                </xh:head>
                <xh:body>
                    <!-- Instantiate component -->
                    <fr:foo id="my-foo">
                        <xf:setvalue ev:event="my-event" ref="foo">43</xf:setvalue>
                    </fr:foo>

                </xh:body>
            </xh:html>
        </input>
        <output name="response">
            <xxf:event-response>
                <xxf:dynamic-state>
                    <dynamic-state>
                        <instances>
                            <instance id="instance1" model-id="model1">
                                <instance>
                                    <foo>43</foo>
                                </instance>
                            </instance>
                        </instances>
                    </dynamic-state>
                </xxf:dynamic-state>
                <xxf:action>
                    <xxf:control-values/>
                </xxf:action>
            </xxf:event-response>
        </output>
    </test>

    <test description="Event handler with @ev:observer and child of bound node" name="oxf:pipeline">
        <input name="config" href="wrap-xforms-state.xpl"/>
        <input name="document">
            <xh:html>
                <xh:head>
                    <xf:model id="model1">
                        <xf:instance id="instance1">
                            <instance>
                                <foo>42</foo>
                            </instance>
                        </xf:instance>
                        <xf:dispatch ev:event="xforms-ready" name="my-event" targetid="my-input"/>
                    </xf:model>
                    <xbl:xbl>
                        <xbl:binding id="fr-foo" element="fr|foo">
                            <xbl:template>
                                <xbl:content/>
                                <xh:div/>
                            </xbl:template>
                        </xbl:binding>
                    </xbl:xbl>
                </xh:head>
                <xh:body>
                    <!-- Instantiate component -->
                    <fr:foo id="my-foo">
                        <xf:setvalue ev:event="my-event" ev:observer="my-input" ref="foo">43</xf:setvalue>
                    </fr:foo>

                    <xf:input id="my-input" ref="foo"/>

                </xh:body>
            </xh:html>
        </input>
        <output name="response">
            <xxf:event-response>
                <xxf:dynamic-state>
                    <dynamic-state>
                        <instances>
                            <instance id="instance1" model-id="model1">
                                <instance>
                                    <foo>43</foo>
                                </instance>
                            </instance>
                        </instances>
                    </dynamic-state>
                </xxf:dynamic-state>
                <xxf:action>
                    <xxf:control-values>
                        <xxf:control id="my-input">43</xxf:control>
                    </xxf:control-values>
                </xxf:action>
            </xxf:event-response>
        </output>
    </test>

    <test description="Nested action with different resolution scope than outer action" name="oxf:pipeline">
        <input name="config" href="wrap-xforms-state.xpl"/>
        <input name="document">
            <xh:html>
                <xh:head>
                    <xf:model id="model">
                        <xf:instance id="instance">
                            <instance xmlns=""/>
                        </xf:instance>
                    </xf:model>
                    <xbl:xbl>
                        <xbl:binding id="foobar-component" element="fr|foobar">
                            <xbl:template>
                                <xf:trigger id="my-trigger" xxbl:scope="outer">
                                    <!-- Outer action in outer scope -->
                                    <xf:action id="my-action" ev:event="xforms-enabled">
                                        <!-- Resolution/dispatch in inner scope -->
                                        <xf:dispatch id="my-dispatch" name="foobar" targetid="my-inner-group" xxbl:scope="inner"/>
                                    </xf:action>
                                </xf:trigger>
                                <!-- Group in inner scope -->
                                <xf:group id="my-inner-group">
                                    <!-- Set value in outer scope -->
                                    <xf:setvalue ev:event="foobar" ref="." xxbl:scope="outer">foobar</xf:setvalue>
                                </xf:group>
                            </xbl:template>
                        </xbl:binding>
                    </xbl:xbl>
                </xh:head>
                <xh:body>
                    <!-- Instantiate component -->
                    <fr:foobar id="my-foobar" />
                </xh:body>
            </xh:html>
        </input>
        <output name="response">
            <xxf:event-response>
                <xxf:dynamic-state>
                    <dynamic-state>
                        <instances>
                            <instance id="instance" model-id="model">
                                <instance>foobar</instance>
                            </instance>
                        </instances>
                    </dynamic-state>
                </xxf:dynamic-state>
                <xxf:action>
                    <xxf:control-values/>
                </xxf:action>
            </xxf:event-response>
        </output>
    </test>

    <test description="Use of context-sensitive XPath function in @if attribute within repeat with different scopes" name="oxf:pipeline">
        <input name="config" href="wrap-xforms-state.xpl"/>
        <input name="document">
            <xh:html>
                <xh:head>
                    <xf:model id="model">
                        <xf:instance id="instance">
                            <instance xmlns="">
                                <fruit>Apple</fruit>
                                <fruit>Orange</fruit>
                            </instance>
                        </xf:instance>
                    </xf:model>
                    <xbl:xbl>
                        <xbl:binding id="foobar-component" element="fr|foobar">
                            <xbl:template>
                                <!-- Repeat in outer scope -->
                                <xf:repeat id="my-repeat" ref="fruit" xxbl:scope="outer" startindex="2">
                                    <xf:var name="p" value="position()" as="xs:integer"/>
                                    <!-- Group in inner scope -->
                                    <xf:group id="my-group" xxbl:scope="inner">
                                        <!-- Action in outer scope -->
                                        <xf:action ev:event="xforms-enabled" if="xxf:index() = $p" xxbl:scope="outer">
                                            <xf:setvalue ref=".">Banana</xf:setvalue>
                                        </xf:action>
                                    </xf:group>
                                </xf:repeat>
                            </xbl:template>
                        </xbl:binding>
                    </xbl:xbl>
                </xh:head>
                <xh:body>
                    <!-- Instantiate component -->
                    <fr:foobar id="my-foobar" />
                </xh:body>
            </xh:html>
        </input>
        <output name="response">
            <xxf:event-response>
                <xxf:dynamic-state>
                    <dynamic-state>
                        <instances>
                            <instance id="instance" model-id="model">
                                <instance>
                                    <fruit>Apple</fruit>
                                    <fruit>Banana</fruit>
                                </instance>
                            </instance>
                        </instances>
                        <controls>
                            <control effective-id="my-foobar$my-repeat" index="2"/>
                        </controls>
                    </dynamic-state>
                </xxf:dynamic-state>
                <xxf:action>
                    <xxf:control-values/>
                </xxf:action>
            </xxf:event-response>
        </output>
    </test>

    <test description="Use of context-sensitive XPath function on xxf:context within repeat with different scopes" name="oxf:pipeline">
        <input name="config" href="wrap-xforms-state.xpl"/>
        <input name="document">
            <xh:html>
                <xh:head>
                    <xf:model id="model">
                        <xf:instance id="instance">
                            <instance xmlns="">
                                <fruit>Apple</fruit>
                                <fruit>Orange</fruit>
                            </instance>
                        </xf:instance>
                    </xf:model>
                    <xbl:xbl>
                        <xbl:binding id="foobar-component" element="fr|foobar">
                            <xbl:template>
                                <!-- Repeat in outer scope -->
                                <xf:repeat id="my-repeat" ref="fruit" xxbl:scope="outer" startindex="2">
                                    <xf:var name="p" value="position()" as="xs:integer"/>
                                    <!-- Group in inner scope -->
                                    <xf:group id="my-group" xxbl:scope="inner">
                                        <!-- Action in outer scope -->
                                        <xf:action ev:event="xforms-enabled" if="xxf:index() = $p" xxbl:scope="outer">
                                            <xf:dispatch name="foobar" targetid="my-group" xxbl:scope="inner">
                                                <xf:property name="index" value="xxf:index()" xxbl:scope="outer"/>
                                            </xf:dispatch>
                                            <xf:dispatch name="foobar" targetid="my-other-group" xxbl:scope="inner">
                                                <xf:property name="index" value="xxf:index()" xxbl:scope="outer"/>
                                            </xf:dispatch>
                                        </xf:action>

                                        <!-- Event handler in inner scope -->
                                        <xf:action ev:event="foobar">
                                            <xf:setvalue ref="." xxbl:scope="outer" value="concat(., ' ', event('index'))"/>
                                        </xf:action>

                                    </xf:group>
                                </xf:repeat>
                                <xf:group id="my-other-group">
                                    <!-- Event handler in inner scope -->
                                    <xf:action ev:event="foobar">
                                        <xf:setvalue ref="fruit[event('index')]" xxbl:scope="outer" value="concat(., ' ', event('index'))"/>
                                    </xf:action>
                                </xf:group>
                            </xbl:template>
                        </xbl:binding>
                    </xbl:xbl>
                </xh:head>
                <xh:body>
                    <!-- Instantiate component -->
                    <fr:foobar id="my-foobar" />
                </xh:body>
            </xh:html>
        </input>
        <output name="response">
            <xxf:event-response>
                <xxf:dynamic-state>
                    <dynamic-state>
                        <instances>
                            <instance id="instance" model-id="model">
                                <instance>
                                    <fruit>Apple</fruit>
                                    <fruit>Orange 2 2</fruit>
                                </instance>
                            </instance>
                        </instances>
                        <controls>
                            <control effective-id="my-foobar$my-repeat" index="2"/>
                        </controls>
                    </dynamic-state>
                </xxf:dynamic-state>
                <xxf:action>
                    <xxf:control-values/>
                </xxf:action>
            </xxf:event-response>
        </output>
    </test>

    <test description="Separate LHHA element in XBL content" name="oxf:pipeline">
        <input name="config" href="wrap-xforms-state.xpl"/>
        <input name="document">
            <xh:html>
                <xh:head>
                    <xf:model id="model">
                        <xf:instance id="instance">
                            <instance>
                                <foo1 label="My label">42</foo1>
                            </instance>
                        </xf:instance>
                    </xf:model>
                    <xbl:xbl>
                        <xbl:binding id="fr-foo" element="fr|foo">
                            <xbl:template>
                                <xf:group xbl:attr="ref" xxbl:scope="outer">
                                    <!-- Here xf:label and xf:input are copied within an outer group -->
                                    <xbl:content includes="xf|label,xf|input"/>
                                </xf:group>
                            </xbl:template>
                        </xbl:binding>
                    </xbl:xbl>
                </xh:head>
                <xh:body>
                    <fr:foo id="my-foo" ref="foo1">
                        <xf:label id="gaga-label" for="gaga" ref="@label"/>
                        <xf:input ref="." id="gaga"/>
                    </fr:foo>
                </xh:body>
            </xh:html>
        </input>
        <output name="response">
            <xxf:event-response>
                <xxf:dynamic-state>
                    <dynamic-state/>
                </xxf:dynamic-state>
                <xxf:action>
                    <xxf:control-values>
                        <xxf:control id="my-foo$gaga" label="My label">42</xxf:control>
                    </xxf:control-values>
                </xxf:action>
            </xxf:event-response>
        </output>
    </test>

    <test description="Separate LHHA element in XBL content in inner-scoped group" name="oxf:pipeline">
        <input name="config" href="wrap-xforms-state.xpl"/>
        <input name="document">
            <xh:html>
                <xh:head>
                    <xf:model id="model">
                        <xf:instance id="instance">
                            <instance>
                                <foo1 label="My label">42</foo1>
                            </instance>
                        </xf:instance>
                    </xf:model>
                    <xbl:xbl>
                        <xbl:binding id="fr-foo" element="fr|foo">
                            <xbl:template>
                                <xf:group xbl:attr="ref" xxbl:scope="outer" id="outer-group">
                                    <xf:var name="result" xxbl:scope="inner">
                                        <xxf:sequence value="." xxbl:scope="outer"/>
                                    </xf:var>
                                    <xf:group xxbl:scope="inner" ref="$result" id="inner-group">
                                        <!-- Here xf:label and xf:input are copied within an inner group -->
                                        <xbl:content includes="xf|label,xf|input"/>
                                    </xf:group>
                                </xf:group>
                            </xbl:template>
                        </xbl:binding>
                    </xbl:xbl>
                </xh:head>
                <xh:body>
                    <fr:foo id="my-foo" ref="foo1">
                        <xf:label id="gaga-label" for="gaga" ref="@label"/>
                        <xf:input ref="." id="gaga"/>
                    </fr:foo>
                </xh:body>
            </xh:html>
        </input>
        <output name="response">
            <xxf:event-response>
                <xxf:dynamic-state>
                    <dynamic-state/>
                </xxf:dynamic-state>
                <xxf:action>
                    <xxf:control-values>
                        <xxf:control id="my-foo$gaga" label="My label">42</xxf:control>
                    </xxf:control-values>
                </xxf:action>
            </xxf:event-response>
        </output>
    </test>

    <test description="Separate LHHA element with LHHA element outside copied XBL content" name="oxf:pipeline">
        <input name="config" href="wrap-xforms-state.xpl"/>
        <input name="document">
            <xh:html>
                <xh:head>
                    <xf:model id="model">
                        <xf:instance id="instance">
                            <instance>
                                <foo1 label="My label">42</foo1>
                            </instance>
                        </xf:instance>
                    </xf:model>
                    <xbl:xbl>
                        <xbl:binding id="fr-foo" element="fr|foo">
                            <xbl:template>
                                <xf:group xbl:attr="ref" xxbl:scope="outer">
                                    <!-- xf:input is copied within an outer group -->
                                    <xbl:content includes="xf|input"/>
                                </xf:group>
                            </xbl:template>
                        </xbl:binding>
                    </xbl:xbl>
                </xh:head>
                <xh:body>
                    <xf:label id="gaga-label" for="gaga" ref="foo1/@label"/>
                    <fr:foo id="my-foo" ref="foo1">
                        <xf:input ref="." id="gaga"/>
                    </fr:foo>
                </xh:body>
            </xh:html>
        </input>
        <output name="response">
            <xxf:event-response>
                <xxf:dynamic-state>
                    <dynamic-state/>
                </xxf:dynamic-state>
                <xxf:action>
                    <xxf:control-values>
                        <xxf:control id="my-foo$gaga" label="My label">42</xxf:control>
                    </xxf:control-values>
                </xxf:action>
            </xxf:event-response>
        </output>
    </test>

    <test description="xf:output within xf:message in XBL doesn't throw an exception" name="oxf:pipeline">
        <input name="config" href="wrap-xforms-state.xpl"/>
        <input name="document">
            <xh:html>
                <xh:head>
                    <xf:model id="model"/>
                    <xbl:xbl>
                        <xbl:binding id="fr-foo" element="fr|foo">
                            <xbl:template>
                                <xf:group id="my-group">
                                    <xf:message ev:event="xforms-enabled" id="my-message"
                                                    level="xxf:log-debug">Message: <xf:output id="my-output" value="event('xxf:type')"/>.</xf:message>
                                </xf:group>
                            </xbl:template>
                        </xbl:binding>
                    </xbl:xbl>
                </xh:head>
                <xh:body>
                    <fr:foo/>
                </xh:body>
            </xh:html>
        </input>
        <output name="response">
            <xxf:event-response>
                <xxf:dynamic-state>
                    <dynamic-state/>
                </xxf:dynamic-state>
                <xxf:action>
                    <xxf:control-values/>
                </xxf:action>
            </xxf:event-response>
        </output>
    </test>

    <test description="XBL components within non-relevant control doesn't throw an exception" name="oxf:pipeline">
        <input name="config" href="wrap-xforms-state.xpl"/>
        <input name="document">
            <xh:html>
                <xh:head>
                    <xf:model id="model"/>
                </xh:head>
                <xh:body>
                    <xf:group ref="()" id="my-group">
                        <fr:button id="my-button"/>
                    </xf:group>
                </xh:body>
            </xh:html>
        </input>
        <output name="response">
            <xxf:event-response>
                <xxf:dynamic-state>
                    <dynamic-state/>
                </xxf:dynamic-state>
                <xxf:action>
                    <xxf:control-values>
                        <xxf:control id="my-group" relevant="false"/>
                        <xxf:control id="my-button" relevant="false"/>
                        <xxf:control id="my-button$xf-8" relevant="false"/>
                    </xxf:control-values>
                </xxf:action>
            </xxf:event-response>
        </output>
    </test>

    <test description="Handling of namespaces with xbl:attr" name="oxf:pipeline">
        <input name="config" href="wrap-xforms-state.xpl"/>
        <input name="document">
            <xh:html>
                <xh:head>
                    <xf:model id="model">
                        <xf:instance id="instance">
                            <my:value xmlns:my="http://orbeon.org/oxf/xml/my">42</my:value>
                        </xf:instance>
                    </xf:model>
                    <xbl:xbl>
                        <xbl:binding id="fr-foo" element="fr|foo">
                            <xbl:template>
                                <xf:output id="my-output" xbl:attr="value" xxbl:scope="outer"/>
                            </xbl:template>
                        </xbl:binding>
                    </xbl:xbl>
                </xh:head>
                <xh:body xmlns:my="http://orbeon.org/oxf/xml/my">
                    <fr:foo id="my-foo" value="/my:value"/>
                </xh:body>
            </xh:html>
        </input>
        <output name="response">
            <xxf:event-response>
                <xxf:dynamic-state>
                    <dynamic-state/>
                </xxf:dynamic-state>
                <xxf:action>
                    <xxf:control-values>
                        <xxf:control id="my-foo$my-output">42</xxf:control>
                    </xxf:control-values>
                </xxf:action>
            </xxf:event-response>
        </output>
    </test>

    <test description="Non-relevant XBL control containing models and instances" name="oxf:pipeline">
        <input name="config" href="wrap-xforms-state.xpl"/>
        <input name="document">
            <xh:html>
                <xh:head>
                    <xf:model id="model">
                        <xf:instance id="instance">
                            <instance>42</instance>
                        </xf:instance>
                        <xf:action ev:event="xforms-ready">
                            <xf:message value="string-join(for $m in xxf:list-models() return xxf:list-instances($m), ', ')"/>
                            <xf:setvalue ref=".">43</xf:setvalue>
                            <xf:refresh/>
                            <xf:message value="string-join(for $m in xxf:list-models() return xxf:list-instances($m), ', ')"/>
                        </xf:action>
                    </xf:model>
                    <xbl:xbl>
                        <xbl:binding id="fr-foo" element="fr|foo">
                            <xbl:implementation>
                                <xf:model id="my-xbl-model">
                                    <xf:instance id="my-xbl-instance">
                                        <instance/>
                                    </xf:instance>
                                </xf:model>
                            </xbl:implementation>
                            <xbl:template>
                                <xf:output id="my-output"/>
                            </xbl:template>
                        </xbl:binding>
                    </xbl:xbl>
                </xh:head>
                <xh:body>
                    <fr:foo id="my-foo1"/>
                    <xf:group ref="()" id="my-group1">
                        <fr:foo id="my-foo2"/>
                    </xf:group>
                    <xf:group ref=".[. = '43']" id="my-group2">
                        <fr:foo id="my-foo3"/>
                    </xf:group>
                </xh:body>
            </xh:html>
        </input>
        <output name="response">
            <xxf:event-response>
                <xxf:dynamic-state>
                    <dynamic-state>
                        <instances>
                            <instance id="instance" model-id="model">
                                <instance>43</instance>
                            </instance>
                        </instances>
                    </dynamic-state>
                </xxf:dynamic-state>
                <xxf:action>
                    <xxf:control-values>
                        <xxf:control id="my-group1" relevant="false"/>
                        <xxf:control id="my-foo2" relevant="false"/>
                        <xxf:control id="my-foo2$my-output" relevant="false"/>
                    </xxf:control-values>
                    <xxf:message level="modal">instance, my-foo1$my-xbl-instance</xxf:message>
                    <xxf:message level="modal">instance, my-foo1$my-xbl-instance, my-foo3$my-xbl-instance</xxf:message>
                </xxf:action>
            </xxf:event-response>
        </output>
    </test>

    <test description="xf:label/xf:output within XBL" name="oxf:pipeline">
        <!-- See: http://forge.ow2.org/tracker/index.php?func=detail&aid=315244&group_id=168&atid=350207 -->
        <input name="config" href="wrap-xforms-state.xpl"/>
        <input name="document">
            <xh:html>
                <xh:head>
                    <xf:model id="model"/>
                    <xbl:xbl>
                        <xbl:binding id="fr-foo" element="fr|foo">
                            <xbl:template>
                                <xf:trigger id="xbl-trigger">
                                    <xf:label id="xbl-label"><xf:output id="xbl-output" value="'Press Me!'"/></xf:label>
                                </xf:trigger>
                            </xbl:template>
                        </xbl:binding>
                    </xbl:xbl>
                </xh:head>
                <xh:body>
                    <fr:foo id="my-foo1"/>
                </xh:body>
            </xh:html>
        </input>
        <output name="response">
            <xxf:event-response>
                <xxf:dynamic-state>
                    <dynamic-state/>
                </xxf:dynamic-state>
                <xxf:action>
                    <xxf:control-values>
                        <xxf:control id="my-foo1$xbl-trigger" label="Press Me!"/>
                    </xxf:control-values>
                </xxf:action>
            </xxf:event-response>
        </output>
    </test>

    <test description="xf:label/AVT within XBL" name="oxf:pipeline">
        <!-- See: http://forge.ow2.org/tracker/index.php?func=detail&aid=315244&group_id=168&atid=350207 -->
        <input name="config" href="wrap-xforms-state.xpl"/>
        <input name="document">
            <xh:html>
                <xh:head>
                    <xf:model id="model"/>
                    <xbl:xbl>
                        <xbl:binding id="fr-foo" element="fr|foo">
                            <xbl:template>
                                <xf:trigger id="xbl-trigger">
                                    <xf:label id="xbl-label"><xh:div id="xbl-avt" style="{'background-color: red'}"/></xf:label>
                                </xf:trigger>
                            </xbl:template>
                        </xbl:binding>
                    </xbl:xbl>
                </xh:head>
                <xh:body>
                    <fr:foo id="my-foo1"/>
                </xh:body>
            </xh:html>
        </input>
        <output name="response">
            <xxf:event-response>
                <xxf:dynamic-state>
                    <dynamic-state/>
                </xxf:dynamic-state>
                <xxf:action>
                    <xxf:control-values>
                        <xxf:control id="my-foo1$xbl-trigger" label="&lt;div id=&quot;my-foo1$xbl-avt&quot; style=&quot;background-color: red&quot;&gt;&lt;/div&gt;"/>
                    </xxf:control-values>
                </xxf:action>
            </xxf:event-response>
        </output>
    </test>

    <test description="Test that automatic include occurs" name="oxf:pipeline">
        <input name="config" href="wrap-xforms-controls.xpl"/>
        <input name="document">
            <xh:html>
                <xh:head>
                    <xf:model id="model">
                        <xf:instance>
                            <instance/>
                        </xf:instance>
                    </xf:model>
                </xh:head>
                <xh:body>
                    <fr:tutorial-input id="my-input" ref="."/>
                </xh:body>
            </xh:html>
        </input>
        <output name="response">
            <controls>
                <xh:span id="my-input$xf-3" class="xforms-control xforms-input">
                    <xh:input id="my-input$xf-3$xforms-input-1" type="text" name="my-input$xf-3$xforms-input-1" value="" class="xforms-input-input"/>
                </xh:span>
            </controls>
        </output>
    </test>

    <test description="Inline model in XBL template does not cause incorrect scoping of following controls" name="oxf:pipeline">
        <!-- See: http://forge.ow2.org/tracker/?func=detail&atid=350207&aid=315613&group_id=168 -->
        <input name="config" href="wrap-xforms-controls.xpl"/>
        <input name="document">
            <xh:html>
                <xh:head>
                    <xf:model id="model">
                        <xf:instance id="instance">
                            <instance>Hello</instance>
                        </xf:instance>
                    </xf:model>
                    <xbl:xbl>
                        <xbl:binding id="fr-foo" element="fr|foo">
                            <xbl:template>
                                <xf:group id="foo-group" xxbl:scope="outer">
                                    <xf:model id="datatable-model" xxbl:scope="inner">
                                        <xf:instance>
                                            <instance>world!</instance>
                                        </xf:instance>
                                    </xf:model>
                                    <xf:var id="v1" name="v1" value="."/>
                                    <xf:var id="v2" name="v2" xxbl:scope="inner">
                                        <xxf:sequence value="$v1" xxbl:scope="outer"/>
                                    </xf:var>
                                    <xf:output id="my-output" value="$v2" xxbl:scope="inner"/>
                                </xf:group>
                            </xbl:template>
                        </xbl:binding>
                    </xbl:xbl>
                </xh:head>
                <xh:body>
                    <fr:foo id="my-foo"/>
                </xh:body>
            </xh:html>
        </input>
        <output name="response">
            <controls>
                <xh:span id="my-foo$foo-group" class="xforms-group">
                    <xh:span id="my-foo$my-output" class="xforms-control xforms-output">
                        <xh:span id="my-foo$my-output$$c" class="xforms-output-output">Hello</xh:span>
                    </xh:span>
                </xh:span>
            </controls>
        </output>
    </test>

    <test description="AVTs within XBL with inner and outer scope are processed" name="oxf:pipeline">
        <!-- See: http://forge.ow2.org/tracker/index.php?func=detail&aid=315635&group_id=168&atid=350207 -->
        <input name="config" href="wrap-xforms-controls.xpl"/>
        <input name="document">
            <xh:html>
                <xh:head>
                    <xf:model id="model"/>
                    <xbl:xbl>
                        <xbl:binding id="fr-foo" element="fr|foo">
                            <xbl:template>
                                <!-- NOTE: xxforms-test-preserve-content is handled by wrap-xforms-controls.xpl -->
                                <xh:div class="xxforms-test-preserve-content">
                                    <xh:a id="outer-a" href="/outer/{count(.)}" xxbl:scope="outer"/>
                                    <xh:a id="inner-a" href="/inner/{count(.)}"/>
                                </xh:div>
                            </xbl:template>
                        </xbl:binding>
                    </xbl:xbl>
                </xh:head>
                <xh:body>
                    <fr:foo id="my-foo"/>
                </xh:body>
            </xh:html>
        </input>
        <output name="response">
            <controls>
                <xh:div class="xxforms-test-preserve-content">
                    <xh:a id="my-foo$outer-a" href="/outer/1" xxbl:scope="outer"/>
                    <xh:a id="my-foo$inner-a" href="/inner/1"/>
                </xh:div>
            </controls>
        </output>
    </test>

    <test description="xbl:content" name="oxf:pipeline">
        <!-- See: http://www.w3.org/TR/xbl/#the-content -->
        <input name="config" href="wrap-xforms-state.xpl"/>
        <input name="document">
            <xh:html>
                <xh:head>
                    <xf:model id="model"/>
                    <xbl:xbl>
                        <xbl:binding id="fr-foo" element="fr|foo">
                            <xbl:template>
                                <xbl:content includes="nothing *">
                                    <xf:output id="output-foo1" value="'Nothing!'"/>
                                </xbl:content>
                                <xbl:content includes="something *">
                                    <xf:output id="output-foo2" value="'Nothing either!'"/>
                                </xbl:content>
                            </xbl:template>
                        </xbl:binding>
                    </xbl:xbl>
                </xh:head>
                <xh:body>
                    <fr:foo id="my-foo">
                        <something>
                            <xf:output id="output-foo3" value="'Something!'"/>
                        </something>
                    </fr:foo>
                </xh:body>
            </xh:html>
        </input>
        <output name="response">
            <xxf:event-response>
                <xxf:dynamic-state>
                    <dynamic-state/>
                </xxf:dynamic-state>
                <xxf:action>
                    <xxf:control-values>
                        <xxf:control id="my-foo$output-foo1">Nothing!</xxf:control>
                        <xxf:control id="my-foo$output-foo3">Something!</xxf:control>
                    </xxf:control-values>
                </xxf:action>
            </xxf:event-response>
        </output>
    </test>

    <test description="NPE with submit within repeat within tabs" name="oxf:pipeline">
        <!-- See: http://forge.ow2.org/tracker/index.php?func=detail&aid=315848&group_id=168&atid=350207 -->
        <input name="config" href="wrap-xforms-state.xpl"/>
        <input name="document">
            <xh:html>
                <xh:head>
                    <xf:model id="model">
                        <xf:dispatch ev:event="xforms-ready" name="DOMActivate" targetid="my-submit"/>
                        <xf:instance id="instance">
                            <item/>
                        </xf:instance>
                        <xf:submission id="my-submission" method="get" action="echo:" replace="instance"/>
                    </xf:model>
                    <xbl:xbl>
                        <xbl:binding id="fr-foo" element="fr|foo">
                            <xbl:template>
                                <xbl:content/>
                            </xbl:template>
                        </xbl:binding>
                    </xbl:xbl>
                </xh:head>
                <xh:body>
                    <fr:foo id="my-foo">
                        <xf:repeat ref="." id="my-repeat">
                            <xf:submit id="my-submit" submission="my-submission"/>
                        </xf:repeat>
                    </fr:foo>
                </xh:body>
            </xh:html>
        </input>
        <output name="response">
            <xxf:event-response>
                <xxf:dynamic-state>
                    <dynamic-state>
                        <controls>
                            <control effective-id="my-foo$my-repeat" index="1"/>
                        </controls>
                    </dynamic-state>
                </xxf:dynamic-state>
                <xxf:action>
                    <xxf:control-values/>
                </xxf:action>
            </xxf:event-response>
        </output>
    </test>

    <test description="xxbl:global" name="oxf:pipeline">
        <input name="config" href="wrap-xforms-state.xpl"/>
        <input name="document">
            <xh:html>
                <xh:head>
                    <xf:model id="model">
                        <!-- Upon ready, simulate click on button + close dialog for both XBL controls -->
                        <xf:action ev:event="xforms-ready">
                            <xf:dispatch name="DOMActivate" targetid="|my-foo1$foo-trigger|"/>
                            <xxf:hide dialog="my-dialog"/>
                            <xf:dispatch name="DOMActivate" targetid="|my-foo2$foo-trigger|"/>
                            <xxf:hide dialog="my-dialog"/>
                        </xf:action>
                    </xf:model>
                    <xbl:xbl>
                        <xbl:binding element="fr|foo">
                            <xxbl:global>
                                <!-- The single global dialog -->
                                <xxf:dialog id="my-dialog" level="modal" model="my-dialog-model">
                                    <xf:label>My Dialog</xf:label>

                                    <!-- Dialog model -->
                                    <xf:model id="my-dialog-model">
                                        <xf:instance id="my-dialog-instance">
                                            <count>0</count>
                                        </xf:instance>
                                    </xf:model>

                                    <!-- Dialog keeps track of # of times it is open, and sends current count back to caller -->
                                    <xf:action ev:event="xxforms-dialog-open">
                                        <xf:setvalue ref="instance()" value="xs:integer(.) + 1"/>
                                        <xf:dispatch name="my-callback" targetid="{event('my-id')}">
                                            <xf:property name="my-value" value="instance()"/>
                                        </xf:dispatch>
                                    </xf:action>

                                </xxf:dialog>
                            </xxbl:global>
                            <xbl:template>
                                <!-- Local model state -->
                                <xf:model id="model">
                                    <xf:instance id="instance">
                                        <count/>
                                    </xf:instance>
                                </xf:model>
                                <xf:trigger id="foo-trigger">
                                    <xf:label>Open me</xf:label>
                                    <!-- Open global dialog upon click -->
                                    <xxf:show ev:event="DOMActivate" dialog="my-dialog" xxbl:scope="outer">
                                        <xf:property name="my-id" value="event('xxf:absolute-targetid')"/>
                                    </xxf:show>
                                    <!-- Upon callback, store value received -->
                                    <xf:setvalue ev:event="my-callback" ref="instance()" value="event('my-value')"/>
                                </xf:trigger>
                            </xbl:template>
                        </xbl:binding>
                    </xbl:xbl>
                </xh:head>
                <xh:body>
                    <fr:foo id="my-foo1"/>
                    <fr:foo id="my-foo2"/>
                </xh:body>
            </xh:html>
        </input>
        <output name="response">
            <xxf:event-response>
                <xxf:dynamic-state>
                    <dynamic-state>
                        <instances>
                            <instance id="my-dialog-instance" model-id="my-dialog-model">
                                <count>2</count>
                            </instance>
                            <instance id="instance" model-id="my-foo1$model">
                                <count>1</count>
                            </instance>
                            <instance id="instance" model-id="my-foo2$model">
                                <count>2</count>
                            </instance>
                        </instances>
                        <controls>
                            <control effective-id="my-dialog" visible="false"/>
                        </controls>
                    </dynamic-state>
                </xxf:dynamic-state>
                <xxf:action>
                    <xxf:control-values>
                        <xxf:control id="my-foo1$foo-trigger" label="Open me"/>
                        <xxf:control id="my-foo2$foo-trigger" label="Open me"/>
                        <xxf:control id="my-dialog" label="My Dialog"/>
                        <xxf:div id="my-dialog" visibility="hidden"/>
                    </xxf:control-values>
                </xxf:action>
            </xxf:event-response>
        </output>
    </test>
    
    <test description="[ #316295 ] XBL: var/sequence in different scope does not resolve repeat properly" name="oxf:pipeline">
        <!-- See: http://forge.ow2.org/tracker/index.php?func=detail&aid=316295&group_id=168&atid=350207 -->
        <input name="config" href="wrap-xforms-state.xpl"/>
        <input name="document">
            <xh:html>
                <xh:head>
                    <xf:model id="model"/>
                    <xbl:xbl>
                        <xbl:binding id="fr-gaga" element="fr|gaga">
                            <xbl:template>
                                <xf:group>
                                    <xf:var name="repeat-index" id="my-var">
                                        <xxf:sequence value="index('my-repeat')" xxbl:scope="outer" id="my-sequence"/>
                                    </xf:var>
                                    <xf:repeat id="my-repeat" xxbl:scope="outer" ref="1"/>
                                    <xf:output value="$repeat-index" id="my-output"/>
                                </xf:group>
                            </xbl:template>
                        </xbl:binding>
                    </xbl:xbl>
                </xh:head>
                <xh:body>
                    <fr:gaga id="my-gaga"/>
                </xh:body>
            </xh:html>
        </input>
        <output name="response">
            <xxf:event-response>
                <xxf:dynamic-state>
                    <dynamic-state>
                        <controls>
                            <control effective-id="my-gaga$my-repeat" index="1"/>
                        </controls>
                    </dynamic-state>
                </xxf:dynamic-state>
                <xxf:action>
                    <xxf:control-values>
                        <xxf:control id="my-gaga$my-output">1</xxf:control>
                    </xxf:control-values>
                </xxf:action>
            </xxf:event-response>
        </output>
    </test>
    
    <test description="Visibility of outer variable from XBL content" name="oxf:pipeline">
        <input name="config" href="wrap-xforms-state.xpl"/>
        <input name="document">
            <xh:html>
                <xh:head>
                    <xf:model id="model"/>
                    <xbl:xbl>
                        <xbl:binding id="fr-gaga" element="fr|gaga">
                            <xbl:template>
                                <xbl:content/>
                            </xbl:template>
                        </xbl:binding>
                        <xbl:binding id="fr-toto" element="fr|toto">
                            <xbl:template>
                                <xf:group id="group1" xxbl:scope="outer">
                                    <xf:group id="group2" xxbl:scope="inner">
                                        <xf:var name="v2"><xxf:sequence value="$v1" xxbl:scope="outer"/></xf:var>
                                        <xf:output id="o2" value="$v2"/>
                                    </xf:group>
                                </xf:group>
                            </xbl:template>
                        </xbl:binding>
                    </xbl:xbl>
                </xh:head>
                <xh:body>
                    <!-- Outer variable -->
                    <xf:var name="v1">gaga</xf:var>
                    <!-- With xbl:content -->
                    <fr:gaga id="my-gaga">
                        <xf:output id="o1" value="$v1"/>
                    </fr:gaga>
                    <!-- With custom inner/outer -->
                    <fr:toto id="my-toto"/>
                </xh:body>
            </xh:html>
        </input>
        <output name="response">
            <xxf:event-response>
                <xxf:dynamic-state>
                    <dynamic-state/>
                </xxf:dynamic-state>
                <xxf:action>
                    <xxf:control-values>
                        <xxf:control id="my-gaga$o1">gaga</xxf:control>
                        <xxf:control id="my-toto$o2">gaga</xxf:control>
                    </xxf:control-values>
                </xxf:action>
            </xxf:event-response>
        </output>
    </test>

    <test description="Event handlers with and without xxbl:mode='nohandlers'" name="oxf:pipeline">
        <input name="config" href="wrap-xforms-state.xpl"/>
        <input name="document">
            <xh:html>
                <xh:head>
                    <xf:model id="model">
                        <xf:dispatch ev:event="xforms-ready" name="my-event" targetid="my-gaga"/>
                        <xf:dispatch ev:event="xforms-ready" name="my-event" targetid="my-toto"/>
                    </xf:model>
                    <xbl:xbl>
                        <xbl:binding id="fr-gaga" element="fr|gaga">
                            <xbl:template>
                                <xbl:content/>
                            </xbl:template>
                        </xbl:binding>
                        <xbl:binding id="fr-toto" element="fr|toto" xxbl:mode="nohandlers">
                            <xbl:template>
                                <xbl:content/>
                            </xbl:template>
                        </xbl:binding>
                    </xbl:xbl>
                </xh:head>
                <xh:body>
                    <fr:gaga id="my-gaga">
                        <xf:message id="gaga-message" ev:event="my-event">Hello gaga!</xf:message>
                        <xf:output id="gaga-output" value="'Gaga'"/>
                    </fr:gaga>
                    <fr:toto id="my-toto">
                        <xf:message id="toto-message" ev:event="my-event">Hello toto!</xf:message>
                        <xf:output id="toto-output" value="'Toto'"/>
                    </fr:toto>
                </xh:body>
            </xh:html>
        </input>
        <output name="response">
            <xxf:event-response>
                <xxf:dynamic-state>
                    <dynamic-state/>
                </xxf:dynamic-state>
                <xxf:action>
                    <xxf:control-values>
                        <xxf:control id="my-gaga$gaga-output">Gaga</xxf:control>
                        <xxf:control id="my-toto$toto-output">Toto</xxf:control>
                    </xxf:control-values>
                    <xxf:message level="modal">Hello gaga!</xxf:message>
                </xxf:action>
            </xxf:event-response>
        </output>
    </test>

    <test description="Nested bindings and xxbl:mode='handlers'" name="oxf:pipeline">
        <input name="config" href="wrap-xforms-state.xpl"/>
        <input name="document">
            <xh:html>
                <xh:head>
                    <xf:model id="model">
                        <xf:dispatch ev:event="xforms-ready" name="my-event" targetid="my-gaga"/>
                        <xf:dispatch ev:event="xforms-ready" name="my-event" targetid="my-toto"/>
                    </xf:model>
                    <xbl:xbl>
                        <xbl:binding id="fr-gaga" element="fr|gaga">
                            <xbl:template>
                                <xbl:content/>
                            </xbl:template>
                        </xbl:binding>
                        <xbl:binding id="fr-toto" element="fr|toto">
                            <xbl:template>
                                <xbl:content/>
                            </xbl:template>
                        </xbl:binding>
                    </xbl:xbl>
                </xh:head>
                <xh:body>
                    <fr:gaga id="my-gaga">
                        <fr:toto id="my-toto">
                            <!-- This handler must be visible from the outside and react to the dispatch to my-toto -->
                            <xf:message id="toto-message" ev:event="my-event">Hello toto!</xf:message>
                            <xf:output id="toto-output" value="'Toto'"/>
                        </fr:toto>
                    </fr:gaga>
                </xh:body>
            </xh:html>
        </input>
        <output name="response">
            <xxf:event-response xmlns:xxf="http://orbeon.org/oxf/xml/xforms">
                <xxf:dynamic-state>
                    <dynamic-state/>
                </xxf:dynamic-state>
                <xxf:action>
                    <xxf:control-values>
                        <xxf:control id="my-gaga$my-toto$toto-output">Toto</xxf:control>
                    </xxf:control-values>
                    <xxf:message level="modal">Hello toto!</xxf:message>
                </xxf:action>
            </xxf:event-response>
        </output>
    </test>

    <test description="Simple xxbl:mode='binding'" name="oxf:pipeline">
        <input name="config" href="wrap-xforms-state.xpl"/>
        <input name="document">
            <xh:html>
                <xh:head>
                    <xf:model id="model">
                        <xf:instance id="instance">
                            <no>Oops!</no>
                        </xf:instance>
                        <xf:instance id="answer">
                            <answer>42</answer>
                        </xf:instance>
                    </xf:model>
                    <xbl:xbl>
                        <xbl:binding id="fr-gaga" element="fr|gaga" xxbl:mode="binding">
                            <xbl:template>
                                <xbl:content/>
                            </xbl:template>
                        </xbl:binding>
                        <xbl:binding id="fr-toto" element="fr|toto">
                            <xbl:template>
                                <xbl:content/>
                            </xbl:template>
                        </xbl:binding>
                    </xbl:xbl>
                </xh:head>
                <xh:body>
                    <fr:gaga id="my-gaga" ref="instance('answer')">
                        <xf:output id="gaga-output" value="."/>
                    </fr:gaga>
                    <fr:toto id="my-toto" ref="instance()">
                        <xf:output id="toto-output" value="."/>
                    </fr:toto>
                </xh:body>
            </xh:html>
        </input>
        <output name="response">
            <xxf:event-response>
                <xxf:dynamic-state>
                    <dynamic-state/>
                </xxf:dynamic-state>
                <xxf:action>
                    <xxf:control-values>
                        <xxf:control id="my-gaga$gaga-output">42</xxf:control>
                        <xxf:control id="my-toto$toto-output">Oops!</xxf:control>
                    </xxf:control-values>
                </xxf:action>
            </xxf:event-response>
        </output>
    </test>

    <test description="xxf:binding(), xxf:binding-context() and xxf:component-context()" name="oxf:pipeline">
        <input name="config" href="wrap-xforms-state.xpl"/>
        <input name="document">
            <xh:html>
                <xh:head>
                    <xf:model id="model">
                        <xf:instance id="instance">
                            <values xmlns="">
                                <foo/>
                                <bar/>
                            </values>
                        </xf:instance>
                    </xf:model>
                    <xbl:xbl>
                        <xbl:binding id="fr-gaga" element="fr|gaga" xxbl:mode="binding">
                            <xbl:template>
                                <xf:output id="binding" value="string-join(for $i in xxf:binding('fr-gaga') return if ($i instance of node()) then name($i) else xs:string($i), ' ')"/>
                                <xf:output id="binding-context" value="string-join(for $i in xxf:binding-context('fr-gaga') return if ($i instance of node()) then name($i) else xs:string($i), ' ')"/>
                                <xf:output id="component-context" value="string-join(for $i in xxf:component-context() return if ($i instance of node()) then name($i) else xs:string($i), ' ')"/>
                            </xbl:template>
                        </xbl:binding>
                    </xbl:xbl>
                </xh:head>
                <xh:body>
                    <fr:gaga id="gaga1" ref="foo"/>
                    <fr:gaga id="gaga2" ref="*"/>
                    <fr:gaga id="gaga3" ref="1 to 10"/>
                    <fr:gaga id="gaga4"/>
                </xh:body>
            </xh:html>
        </input>
        <output name="response">
            <xxf:event-response xmlns:xxf="http://orbeon.org/oxf/xml/xforms">
                <xxf:dynamic-state>
                    <dynamic-state/>
                </xxf:dynamic-state>
                <xxf:action>
                    <xxf:control-values>
                        <xxf:control id="gaga1$binding">foo</xxf:control>
                        <xxf:control id="gaga1$binding-context">values</xxf:control>
                        <xxf:control id="gaga1$component-context">values</xxf:control>
                        <xxf:control id="gaga2$binding">foo</xxf:control>
                        <xxf:control id="gaga2$binding-context">values</xxf:control>
                        <xxf:control id="gaga2$component-context">values</xxf:control>
                        <xxf:control id="gaga3" readonly="true"/>
                        <xxf:control id="gaga3$binding">1</xxf:control>
                        <xxf:control id="gaga3$binding-context">values</xxf:control>
                        <xxf:control id="gaga3$component-context">values</xxf:control>
                        <xxf:control id="gaga4$binding-context">values</xxf:control>
                        <xxf:control id="gaga4$component-context">values</xxf:control>
                    </xxf:control-values>
                </xxf:action>
            </xxf:event-response>
        </output>
    </test>

    <test description="xxf:dynamic: mirror instance values" name="oxf:pipeline">
        <input name="config" href="wrap-xforms-state.xpl"/>
        <input name="document">
            <xh:html>
                <xh:head>
                    <xf:model id="model">
                        <xf:instance id="instance">
                            <xh:html>
                                <xh:head>
                                    <xf:model id="model">
                                        <xf:instance id="instance">
                                            <value>40</value>
                                        </xf:instance>
                                    </xf:model>
                                </xh:head>
                                <xh:body>
                                    <xf:output id="my-output" value=".">
                                        <!-- Increment value from the inside -->
                                        <xf:setvalue ev:event="xforms-value-changed" if="xs:integer(.) le 41" ref="." value=". + 1"/>
                                    </xf:output>
                                </xh:body>
                            </xh:html>
                        </xf:instance>

                        <!-- Increment value from the outside -->
                        <xf:setvalue ev:event="xforms-ready" ref="//value" value=". + 1"/>

                    </xf:model>
                </xh:head>
                <xh:body>
                    <xf:group id="my-group">
                        <xxf:dynamic ref="." id="my-dynamic"/>
                    </xf:group>
                </xh:body>
            </xh:html>
        </input>
        <output name="response">
            <xxf:event-response>
                <xxf:dynamic-state>
                    <dynamic-state>
                        <instances>
                            <instance id="instance" model-id="model">
                                <xh:html>
                                    <xh:head>
                                        <xf:model id="model" xxf:state-handling="client">
                                            <xf:instance id="instance">
                                                <value>42</value>
                                            </xf:instance>
                                        </xf:model>
                                    </xh:head>
                                    <xh:body>
                                        <xf:output id="my-output" value=".">
                                            <!-- Increment value from the inside -->
                                            <xf:setvalue ev:event="xforms-value-changed" if="xs:integer(.) le 41" ref="." value=". + 1"/>
                                        </xf:output>
                                    </xh:body>
                                </xh:html>
                            </instance>
                            <instance id="instance" model-id="my-dynamic$model">
                                <value>42</value>
                            </instance>
                        </instances>
                    </dynamic-state>
                </xxf:dynamic-state>
                <xxf:action>
                    <xxf:control-values>
                        <xxf:control id="my-dynamic$my-output">42</xxf:control>
                    </xxf:control-values>
                </xxf:action>
            </xxf:event-response>
        </output>
    </test>

    <test description="xxf:dynamic: change bind type" name="oxf:pipeline">
        <input name="config" href="wrap-xforms-state.xpl"/>
        <input name="document">
            <xh:html>
                <xh:head>
                    <xf:model id="model">
                        <xf:instance id="instance">
                            <xh:html>
                                <xh:head>
                                    <xf:model id="model">
                                        <xf:instance id="instance">
                                            <value>42</value>
                                        </xf:instance>
                                        <xf:bind id="my-bind" ref="." type="xs:string"/>
                                    </xf:model>
                                </xh:head>
                                <xh:body>
                                    <xf:output id="my-output" bind="my-bind"/>
                                </xh:body>
                            </xh:html>
                        </xf:instance>

                        <!-- Change bind type -->
                        <xf:setvalue ev:event="xforms-ready" ref="//xf:bind/@type" value="'xs:date'"/>

                    </xf:model>
                </xh:head>
                <xh:body>
                    <xf:group id="my-group">
                        <xxf:dynamic ref="." id="my-dynamic"/>
                    </xf:group>
                </xh:body>
            </xh:html>
        </input>
        <output name="response">
            <xxf:event-response>
                <xxf:dynamic-state>
                    <dynamic-state>
                        <instances>
                            <instance id="instance" model-id="model">
                                <xh:html>
                                    <xh:head>
                                        <xf:model id="model" xxf:state-handling="client">
                                            <xf:instance id="instance">
                                                <value>42</value>
                                            </xf:instance>
                                            <xf:bind id="my-bind" ref="." type="xs:date"/>
                                        </xf:model>
                                    </xh:head>
                                    <xh:body>
                                        <xf:output id="my-output" bind="my-bind"/>
                                    </xh:body>
                                </xh:html>
                            </instance>
                        </instances>
                    </dynamic-state>
                </xxf:dynamic-state>
                <xxf:action>
                    <xxf:control-values>
                        <xxf:control id="my-dynamic$my-output" valid="false">42</xxf:control>
                    </xxf:control-values>
                </xxf:action>
            </xxf:event-response>
        </output>
    </test>

    <test description="xxf:dynamic: insert and delete bind" name="oxf:pipeline">
        <input name="config" href="wrap-xforms-state.xpl"/>
        <input name="document">
            <xh:html>
                <xh:head>
                    <xf:model id="model">
                        <xf:instance id="instance">
                            <xh:html>
                                <xh:head>
                                    <xf:model id="model">
                                        <xf:instance id="instance">
                                            <instance>
                                                <value1>41</value1>
                                                <value2>42</value2>
                                            </instance>
                                        </xf:instance>
                                        <xf:bind id="bind1" ref="value1"/>
                                    </xf:model>
                                </xh:head>
                                <xh:body>
                                    <xf:output id="output1" bind="bind1"/>
                                    <xf:output id="output2" bind="bind2"/>
                                </xh:body>
                            </xh:html>
                        </xf:instance>

                        <xf:action ev:event="xforms-ready">
                            <!-- Insert new bind -->
                            <xf:insert ref="//xf:bind" origin="xxf:element('xf:bind', (xxf:attribute('id', 'bind2'), xxf:attribute('ref', 'value2')))"/>
                            <!-- Delete first bind -->
                            <xf:delete ref="//xf:bind[@id = 'bind1']"/>
                        </xf:action>

                    </xf:model>
                </xh:head>
                <xh:body>
                    <xf:group id="my-group">
                        <xxf:dynamic ref="." id="my-dynamic"/>
                    </xf:group>
                </xh:body>
            </xh:html>
        </input>
        <output name="response">
            <xxf:event-response>
                <xxf:dynamic-state>
                    <dynamic-state>
                        <instances>
                            <instance id="instance" model-id="model">
                                <xh:html>
                                    <xh:head>
                                        <xf:model id="model" xxf:state-handling="client">
                                            <xf:instance id="instance">
                                                <instance>
                                                    <value1>41</value1>
                                                    <value2>42</value2>
                                                </instance>
                                            </xf:instance>
                                            <xf:bind id="bind2" ref="value2"/>
                                        </xf:model>
                                    </xh:head>
                                    <xh:body>
                                        <xf:output id="output1" bind="bind1"/>
                                        <xf:output id="output2" bind="bind2"/>
                                    </xh:body>
                                </xh:html>
                            </instance>
                        </instances>
                    </dynamic-state>
                </xxf:dynamic-state>
                <xxf:action>
                    <xxf:control-values>
                        <xxf:control id="my-dynamic$output1" relevant="false"/>
                        <xxf:control id="my-dynamic$output2">42</xxf:control>
                    </xxf:control-values>
                </xxf:action>
            </xxf:event-response>
        </output>
    </test>

    <test description="xxf:dynamic: update to content nested within top-level XBL binding" name="oxf:pipeline">
        <input name="config" href="wrap-xforms-state.xpl"/>
        <input name="document">
            <xh:html>
                <xh:head>
                    <!-- Create nested model with instance, bind and action to test de-indexing
                         See: https://github.com/orbeon/orbeon-forms/issues/770 -->
                    <xf:model id="model">
                        <xf:instance id="instance">
                            <xh:html>
                                <xh:head>
                                    <xf:model id="model">
                                        <xf:instance id="instance">
                                            <instance>
                                                <value1>41</value1>
                                                <value2>42</value2>
                                            </instance>
                                        </xf:instance>
                                        <xf:bind id="bind1" ref="value1"/>
                                        <xf:bind id="bind2" ref="value2"/>
                                    </xf:model>
                                    <xbl:xbl>
                                        <xbl:binding id="fr-bar" element="fr|bar">
                                            <xbl:template>
                                                <xf:model id="bar-model">
                                                    <xf:instance id="bar-instance"><bar/></xf:instance>
                                                    <xf:bind id="bar-bind" ref="."/>
                                                    <xf:setvalue ev:event="xforms-model-construct-done" id="bar-setvalue" ref=".">42</xf:setvalue>
                                                </xf:model>
                                                <xbl:content/>
                                            </xbl:template>
                                        </xbl:binding>
                                    </xbl:xbl>
                                </xh:head>
                                <xh:body>
                                    <xf:group id="my-group">
                                        <fr:bar id="my-bar" xxf:update="full">
                                            <xf:input id="input1" bind="bind1"/>
                                        </fr:bar>
                                    </xf:group>
                                </xh:body>
                            </xh:html>
                        </xf:instance>

                        <xf:action ev:event="xforms-ready">
                            <!-- Insert new control into XBL content -->
                            <xf:insert ref="//xf:input" origin="xxf:element('xf:input', (xxf:attribute('id', 'input2'), xxf:attribute('bind', 'bind2')))"/>
                        </xf:action>

                    </xf:model>
                </xh:head>
                <xh:body>
                    <xf:group id="my-group">
                        <xxf:dynamic ref="." id="my-dynamic"/>
                    </xf:group>
                </xh:body>
            </xh:html>
        </input>
        <output name="response">
            <xxf:event-response>
                <xxf:dynamic-state>
                    <dynamic-state>
                        <instances>
                            <instance id="instance" model-id="model">
                                <xh:html>
                                    <xh:head>
                                        <xf:model id="model" xxf:state-handling="client">
                                            <xf:instance id="instance">
                                                <instance>
                                                    <value1>41</value1>
                                                    <value2>42</value2>
                                                </instance>
                                            </xf:instance>
                                            <xf:bind id="bind1" ref="value1"/>
                                            <xf:bind id="bind2" ref="value2"/>
                                        </xf:model>
                                        <xbl:xbl>
                                            <xbl:binding id="fr-bar" element="fr|bar">
                                                <xbl:template>
                                                    <xf:model id="bar-model" xxf:state-handling="client">
                                                        <xf:instance id="bar-instance">
                                                            <bar/>
                                                        </xf:instance>
                                                        <xf:bind id="bar-bind" ref="."/>
                                                        <xf:setvalue ev:event="xforms-model-construct-done" id="bar-setvalue" ref=".">42</xf:setvalue>
                                                    </xf:model>
                                                    <xbl:content/>
                                                </xbl:template>
                                            </xbl:binding>
                                        </xbl:xbl>
                                    </xh:head>
                                    <xh:body>
                                        <xf:group id="my-group">
                                            <fr:bar id="my-bar" xxf:update="full">
                                                <xf:input id="input1" bind="bind1"/>
                                                <xf:input id="input2" bind="bind2"/>
                                            </fr:bar>
                                        </xf:group>
                                    </xh:body>
                                </xh:html>
                            </instance>
                            <instance id="bar-instance" model-id="my-dynamic$my-bar$bar-model">
                                <bar>42</bar>
                            </instance>
                        </instances>
                    </dynamic-state>
                </xxf:dynamic-state>
                <xxf:action>
                    <xxf:control-values>
                        <xxf:control id="my-dynamic$my-bar" class="xforms-update-full"/>
                        <xxf:inner-html id="my-dynamic$my-bar">&lt;span id="my-dynamic$my-bar$input1" class="xforms-control xforms-input"&gt;&lt;input id="my-dynamic$my-bar$input1$xforms-input-1" type="text" name="my-dynamic$my-bar$input1$xforms-input-1" value="41" class="xforms-input-input"&gt;&lt;/input&gt;&lt;/span&gt;&lt;span id="my-dynamic$my-bar$input2" class="xforms-control xforms-input"&gt;&lt;input id="my-dynamic$my-bar$input2$xforms-input-1" type="text" name="my-dynamic$my-bar$input2$xforms-input-1" value="42" class="xforms-input-input"&gt;&lt;/input&gt;&lt;/span&gt;</xxf:inner-html>
                    </xxf:control-values>
                </xxf:action>
            </xxf:event-response>
        </output>
    </test>

    <test description="#342: Instance replacement in edited form adds more than one root element" name="oxf:pipeline">
        <!-- See: https://github.com/orbeon/orbeon-forms/issues/342 -->
        <input name="config" href="wrap-xforms-state.xpl"/>
        <input name="document">
            <xh:html>
                <xh:head>
                    <xf:model id="model">
                        <xf:instance id="instance">
                            <xh:html>
                                <xh:head>
                                    <xf:model id="model">
                                        <xf:instance id="instance">
                                            <foo/>
                                        </xf:instance>
                                    </xf:model>
                                </xh:head>
                                <xh:body>
                                    <xf:group id="my-group">
                                        <xf:insert ev:event="xforms-enabled" ref="instance()" origin="xf:element('bar')"/>
                                    </xf:group>
                                </xh:body>
                            </xh:html>
                        </xf:instance>
                    </xf:model>
                </xh:head>
                <xh:body>
                    <xxf:dynamic ref="." id="my-dynamic"/>
                </xh:body>
            </xh:html>
        </input>
        <output name="response">
            <xxf:event-response>
                <xxf:dynamic-state>
                    <dynamic-state>
                        <instances>
                            <instance id="instance" model-id="model">
                                <xh:html>
                                    <xh:head>
                                        <xf:model id="model" xxf:state-handling="client">
                                            <xf:instance id="instance">
                                                <bar/>
                                            </xf:instance>
                                        </xf:model>
                                    </xh:head>
                                    <xh:body>
                                        <xf:group id="my-group">
                                            <xf:insert ev:event="xforms-enabled" ref="instance()" origin="xf:element('bar')"/>
                                        </xf:group>
                                    </xh:body>
                                </xh:html>
                            </instance>
                            <instance id="instance" model-id="my-dynamic$model">
                                <bar/>
                            </instance>
                        </instances>
                    </dynamic-state>
                </xxf:dynamic-state>
                <xxf:action>
                    <xxf:control-values/>
                </xxf:action>
            </xxf:event-response>
        </output>
    </test>

    <test description="#360: xxf:dynamic NPE with update of XBL with models" name="oxf:pipeline">
        <!-- See: https://github.com/orbeon/orbeon-forms/issues/360 -->
        <input name="config" href="wrap-xforms-state.xpl"/>
        <input name="document">
            <xh:html>
                <xh:head>
                    <xf:model id="model">
                        <xf:instance id="instance">
                            <xh:html>
                                <xh:head>
                                    <xf:model id="model"/>
                                    <xbl:xbl>
                                        <xbl:binding id="fr-bar" element="fr|bar">
                                            <xbl:implementation>
                                                <xf:model id="xbl-model">
                                                    <xf:instance id="xbl-instance"><value>42</value></xf:instance>
                                                </xf:model>
                                            </xbl:implementation>
                                            <xbl:template>
                                                <xbl:content/>
                                                <xf:output id="output1" value="instance()"/>
                                            </xbl:template>
                                        </xbl:binding>
                                    </xbl:xbl>
                                </xh:head>
                                <xh:body>
                                    <xf:group id="my-group">
                                        <fr:bar id="my-bar" xxf:update="full"/>
                                    </xf:group>
                                </xh:body>
                            </xh:html>
                        </xf:instance>

                        <xf:action ev:event="xforms-ready">
                            <!-- Insert new control into XBL content -->
                            <xf:insert context="//fr:bar" origin="xxf:element('xf:output', (xxf:attribute('id', 'output2'), xxf:attribute('value', '''Hello!''')))"/>
                        </xf:action>

                    </xf:model>
                </xh:head>
                <xh:body>
                    <xf:group id="my-group">
                        <xxf:dynamic ref="instance()" id="my-dynamic"/>
                    </xf:group>
                </xh:body>
            </xh:html>
        </input>
        <output name="response">
            <xxf:event-response xmlns:xxf="http://orbeon.org/oxf/xml/xforms">
                <xxf:dynamic-state>
                    <dynamic-state>
                        <instances>
                            <instance id="instance" model-id="model">
                                <xh:html>
                                    <xh:head>
                                        <xf:model id="model" xxf:state-handling="client"/>
                                        <xbl:xbl>
                                            <xbl:binding id="fr-bar" element="fr|bar">
                                                <xbl:implementation>
                                                    <xf:model id="xbl-model" xxf:state-handling="client">
                                                        <xf:instance id="xbl-instance">
                                                            <value>42</value>
                                                        </xf:instance>
                                                    </xf:model>
                                                </xbl:implementation>
                                                <xbl:template>
                                                    <xbl:content/>
                                                    <xf:output id="output1" value="instance()"/>
                                                </xbl:template>
                                            </xbl:binding>
                                        </xbl:xbl>
                                    </xh:head>
                                    <xh:body>
                                        <xf:group id="my-group">
                                            <fr:bar id="my-bar" xxf:update="full">
                                                <xf:output id="output2" value="'Hello!'"/>
                                            </fr:bar>
                                        </xf:group>
                                    </xh:body>
                                </xh:html>
                            </instance>
                        </instances>
                    </dynamic-state>
                </xxf:dynamic-state>
                <xxf:action>
                    <xxf:control-values>
                        <xxf:control id="my-dynamic$my-bar" class="xforms-update-full"/>
                        <xxf:inner-html id="my-dynamic$my-bar">&lt;span id="my-dynamic$my-bar$output2" class="xforms-control xforms-output"&gt;&lt;span id="my-dynamic$my-bar$output2$$c" class="xforms-output-output"&gt;Hello!&lt;/span&gt;&lt;/span&gt; &lt;span id="my-dynamic$my-bar$output1" class="xforms-control xforms-output"&gt;&lt;span id="my-dynamic$my-bar$output1$$c" class="xforms-output-output"&gt;42&lt;/span&gt;&lt;/span&gt;</xxf:inner-html>
                    </xxf:control-values>
                </xxf:action>
            </xxf:event-response>
        </output>
    </test>

    <test description="#437: Support XBL 'value' mode" name="oxf:pipeline">
        <!-- See: https://github.com/orbeon/orbeon-forms/issues/437 -->
        <input name="config" href="wrap-xforms-state.xpl"/>
        <input name="document">
            <xh:html>
                <xh:head>
                    <xf:model id="model">
                        <xf:instance id="instance">
                            <values xmlns="">
                                <foo/>
                            </values>
                        </xf:instance>
                        <xf:setvalue ev:event="xforms-ready" ref="foo">42</xf:setvalue>
                    </xf:model>
                    <xbl:xbl>
                        <xbl:binding id="fr-gaga" element="fr|gaga" xxbl:mode="binding value">
                            <xbl:template>
                                <xf:output id="gaga-output" value="xxf:value('fr-gaga')"/>
                            </xbl:template>
                        </xbl:binding>
                        <xbl:binding id="fr-toto" element="fr|toto" xxbl:mode="binding">
                            <xbl:template>
                                <xf:output id="toto-output" value="xxf:value('fr-toto')"/>
                            </xbl:template>
                        </xbl:binding>
                    </xbl:xbl>
                </xh:head>
                <xh:body>
                    <fr:gaga id="gaga1" ref="foo">
                        <xf:message ev:event="xforms-value-changed">fr:gaga changed!</xf:message>
                    </fr:gaga>
                    <fr:toto id="toto1" ref="foo">
                        <xf:message ev:event="xforms-value-changed">fr:toto Changed!</xf:message>
                    </fr:toto>
                </xh:body>
            </xh:html>
        </input>
        <output name="response">
            <xxf:event-response>
                <xxf:dynamic-state>
                    <dynamic-state>
                        <instances>
                            <instance id="instance" model-id="model">
                                <values>
                                    <foo>42</foo>
                                </values>
                            </instance>
                        </instances>
                    </dynamic-state>
                </xxf:dynamic-state>
                <xxf:action>
                    <xxf:control-values>
                        <xxf:control id="gaga1$gaga-output">42</xxf:control>
                    </xxf:control-values>
                    <xxf:message level="modal">fr:gaga changed!</xxf:message>
                </xxf:action>
            </xxf:event-response>
        </output>
    </test>

    <test description="#787: xxf:default result is ignored in XBL mirror instance" name="oxf:pipeline">
        <!-- See: https://github.com/orbeon/orbeon-forms/issues/787 -->
        <input name="config" href="wrap-xforms-state.xpl"/>
        <input name="document">
            <xh:html>
                <xh:head>
                    <xf:model id="model">
                        <xf:instance id="outer-instance" xxf:exclude-result-prefixes="#all">
                            <instance/>
                        </xf:instance>
                    </xf:model>
                    <xbl:xbl>
                        <xbl:binding id="fr-gaga" element="fr|gaga" xxbl:mode="binding">
                            <xbl:template>
                                <xf:model id="gaga-model">
                                    <xf:instance id="gaga-instance" xxbl:mirror="true">
                                        <empty/>
                                    </xf:instance>
                                    <xf:bind ref="." xxf:default="42"/>
                                </xf:model>
                            </xbl:template>
                        </xbl:binding>
                    </xbl:xbl>
                </xh:head>
                <xh:body>
                    <fr:gaga id="my-gaga" ref="instance()"/>
                </xh:body>
            </xh:html>
        </input>
        <output name="response">
            <xxf:event-response xmlns:xxf="http://orbeon.org/oxf/xml/xforms">
                <xxf:dynamic-state>
                    <dynamic-state>
                        <instances>
                            <instance id="outer-instance" model-id="model">
                                <instance>42</instance>
                            </instance>
                            <instance id="gaga-instance" model-id="my-gaga$gaga-model">
                                <instance>42</instance>
                            </instance>
                        </instances>
                    </dynamic-state>
                </xxf:dynamic-state>
                <xxf:action>
                    <xxf:control-values/>
                </xxf:action>
            </xxf:event-response>
        </output>
    </test>

    <!--

    TODO: more XBL ids tests:

    * test that LHHA with @for resolve ids in proper context
    * test scoping with ev:observer and repeats/XBL scope
    * test change of scope in inner action, e.g.:
    * test xxf:repeat-indexes resolution on actions, y.c. from within XBL component within repeat, and to tested repeat controls

    -->

</group>
