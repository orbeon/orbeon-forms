<?xml version="1.0" encoding="UTF-8"?>
<!--
  Copyright (C) 2010 Orbeon, Inc.

  This program is free software; you can redistribute it and/or modify it under the terms of the
  GNU Lesser General Public License as published by the Free Software Foundation; either version
  2.1 of the License, or (at your option) any later version.

  This program is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY;
  without even the implied warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.
  See the GNU Lesser General Public License for more details.

  The full text of the license is available at http://www.gnu.org/copyleft/lesser.html
  -->
<xforms:model xmlns:xhtml="http://www.w3.org/1999/xhtml"
      xmlns:xforms="http://www.w3.org/2002/xforms"
      xmlns:xs="http://www.w3.org/2001/XMLSchema"
      xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
      xmlns:ev="http://www.w3.org/2001/xml-events"
      xmlns:xi="http://www.w3.org/2001/XInclude"
      xmlns:xxi="http://orbeon.org/oxf/xml/xinclude"
      xmlns:xxforms="http://orbeon.org/oxf/xml/xforms"
      xmlns:fr="http://orbeon.org/oxf/xml/form-runner"
      xmlns:fb="http://orbeon.org/oxf/xml/form-builder"
      xmlns:saxon="http://saxon.sf.net/"
      xmlns:xbl="http://www.w3.org/ns/xbl"
      xmlns:context="java:org.orbeon.oxf.pipeline.StaticExternalContext"

      xxforms:external-events="show-fb-test-dialog"
      xxforms:noscript-support="false"
      xxforms:xpath-analysis="true"

      id="fr-form-model">

    <!-- Variable pointing to the current language -->
    <xxforms:variable name="fb-lang" select="instance('fb-language-instance')"/>
    <xxforms:variable name="form-resources" model="fr-resources-model" select="$fr-form-resources" as="element(resource)?"/>

    <xxforms:variable name="is-pe" select="context:isPE()" as="xs:boolean"/>

    <!-- Other variables -->
    <xxforms:variable name="model" select="xhtml:head/xforms:model[@id = 'fr-form-model']"/>
    <xxforms:variable name="form-instance" select="$model/xforms:instance[@id = 'fr-form-instance']/*"/>
    <xxforms:variable name="metadata-instance" select="$model/xforms:instance[@id = 'fr-form-metadata']/*"/>
    <xxforms:variable name="resources" select="$model/xforms:instance[@id = 'fr-form-resources']/*"/>
    <xxforms:variable name="current-resources" select="$resources/resource[@xml:lang = $fb-lang]"/>
    <xxforms:variable name="body" select="xhtml:body/fr:view/fr:body"/>

    <xxforms:variable name="component-bindings" select="instance('fb-components-instance')//xbl:binding" as="element(xbl:binding)*"/>
    <xxforms:variable name="components-qnames" select="for $t in $component-bindings//fb:template/*[1] return resolve-QName(name($t), $t)" as="xs:QName*"/>

    <xxforms:variable name="current-top-level-block" select="$body/fr:*[index('fb-top-level-repeat')]"/>
    <xxforms:variable name="current-td" select="xxforms:binding('fb-section-content-grid-td-repeat')[index('fb-section-content-grid-td-repeat')]" as="element()?"/>

    <!-- Main instance -->
    <xforms:instance id="fr-form-instance" src="oxf:/forms/orbeon/builder/form/template.xml"/>

    <xforms:action ev:event="xforms-model-construct-done">

        <!-- Check permissions if there are roles -->
        <xxforms:variable name="has-roles" select="not(xxforms:instance('fr-roles-instance')/has-roles = 'false')" as="xs:boolean"/>
        <xforms:action if="$has-roles">
            <!-- Make sure binds to app and form name are evaluated -->
            <xforms:rebuild/>
            <xforms:recalculate/>

            <xforms:action if="xxforms:instance('fr-parameters-instance')/mode = 'new'">
                <!-- New form: set default value for app and form if needed -->
                <!-- NOTE: we use xxforms:bind() instead of @bind because @bind doesn't seem to work properly (incorrect context?) -->
                <xforms:action context="xxforms:instance('fr-permissions')/app[1]" if="not(@name = '*')">
                    <xforms:setvalue ref="xxforms:bind('application-name-bind')" value="context()/@name"/>
                    <xforms:setvalue ref="instance('fb-metadata-instance')/application-name" value="context()/@name"/>
                </xforms:action>
            </xforms:action>
            <xforms:action if="not(xxforms:instance('fr-parameters-instance')/mode = 'new')">
                <!-- E.g. we are reading an existing doc: IF there are roles and roles don't match THEN send redirection -->
                <xxforms:variable name="app" select="xxforms:bind('application-name-bind')" as="xs:string"/>
                <xxforms:variable name="form" select="xxforms:bind('form-name-bind')" as="xs:string"/>
                <!-- See similar logic in FR -->
                <xforms:load if="not(exists(xxforms:instance('fr-permissions')/app[@name = '*'])
                                    or exists(xxforms:instance('fr-permissions')/app[@name = $app]/form[@name = ('*', $form)]))"
                             resource="/fr/unauthorized"/>
                <!--<xforms:message level="xxforms:log-debug">-->
                    <!--xxx-->
                    <!--<xforms:output value="$app"/>-->
                    <!--xxx-->
                    <!--<xforms:output value="$form"/>-->
                <!--</xforms:message>-->
            </xforms:action>
        </xforms:action>

        <!-- Handle user agent -->

        <xxforms:variable name="user-agent" select="xxforms:get-request-header('user-agent')"/>
        <xforms:setvalue ref="instance('fb-user-agent-instance')/value" value="$user-agent"/>
        <!-- IE detection -->
        <xxforms:variable name="is-ie" select="contains(lower-case($user-agent), 'msie') and not(contains(lower-case($user-agent), 'opera'))"/>
        <xforms:setvalue ref="instance('fb-user-agent-instance')/is-ie" value="$is-ie"/>
        <!-- Try to find IE version -->
        <xforms:action if="$is-ie">
            <xxforms:variable name="msie" select="(for $t in tokenize(lower-case($user-agent), '[;\(\)]') return normalize-space($t))[starts-with(., 'msie')][1]"/>
            <xxforms:variable name="ie-version" select="xs:integer(substring-before(normalize-space(substring-after($msie, 'msie')), '.'))"/>
            <xforms:setvalue ref="instance('fb-user-agent-instance')/ie-version" value="$ie-version"/>
            <xforms:setvalue ref="instance('fb-user-agent-instance')/is-supported-ie" value="$ie-version gt 6"/>
        </xforms:action>

        <!--  I18n -->

        <!-- Set current language: for new forms, use current FR language;
             for existing form, use language based on first resources available in loaded form -->
        <xforms:setvalue ref="$fb-lang" value="if (xxforms:instance('fr-parameters-instance')/mode = 'new')
                then xxforms:instance('fr-language-instance')
                else $resources/resource[1]/@xml:lang"/>
        <!-- For new forms -->
        <xforms:action if="xxforms:instance('fr-parameters-instance')/mode = 'new'">
            <!-- Set language in all @xml:lang  -->
            <xforms:action xxforms:iterate="instance('fr-form-instance')//@xml:lang">
                <xforms:setvalue ref="." value="$fb-lang"/>
            </xforms:action>
            <!-- Set initial form and first section titles -->
            <xforms:setvalue ref="$metadata-instance/title" value="$form-resources/template/untitled-form"/>
            <xforms:setvalue ref="$resources/resource/section-1/label" value="$form-resources/template/untitled-section"/>
        </xforms:action>

        <!-- Tasks when mode is not new -->
        <xforms:action if="not(xxforms:instance('fr-parameters-instance')/mode = 'new')">
            <!-- Load components right away, because we already have app/form names -->
            <xforms:send submission="fb-load-components"/>
            <!-- HACK: Store valid values so we don't see error message -->
            <xforms:setvalue ref="instance('fb-metadata-instance')/application-name">dummy</xforms:setvalue>
            <xforms:setvalue ref="instance('fb-metadata-instance')/form-name">dummy</xforms:setvalue>
        </xforms:action>

    </xforms:action>

    <xforms:action ev:event="xforms-ready">
        <!-- Show editor case if mode is not new -->
        <xxforms:variable name="is-new" select="xxforms:instance('fr-parameters-instance')/mode = 'new'" as="xs:boolean"/>
        <xforms:action if="$is-new">
            <xforms:setvalue ref="instance('fb-metadata-instance')/mode" value="'edit'"/>
            <xxforms:show ev:event="show-fb-editor-create-dialog" dialog="fb-editor-metadata-dialog"/>
        </xforms:action>
        <xforms:action if="not($is-new)">
            <xforms:toggle case="fb-editor-open-case"/>
            <xforms:toggle case="fb-metadata-view-case"/>
        </xforms:action>
    </xforms:action>

    <!-- Binds on main instance -->
    <xforms:bind nodeset=".">
        <xforms:bind nodeset="xhtml:head">
            <xforms:bind nodeset="xforms:model[@id = 'fr-form-model']">
                <!-- Form metadata (also used by Form Runner) -->
                <xforms:bind nodeset="xforms:instance[@id = 'fr-form-metadata']/*">
                    <xforms:bind id="application-name-bind" nodeset="application-name" required="true()" type="xs:NCName" readonly="false()"/>
                    <xforms:bind id="form-name-bind" nodeset="form-name" required="true()" type="xs:NCName" readonly="false()"/>
                    <!-- The constraint checks that all the titles are non-empty, not only the one currently visible -->
                    <xforms:bind id="title-bind" nodeset="title[@xml:lang = $fb-lang]" required="true()"
                                 constraint="not((for $t in ../title return normalize-space($t) = '') = true())"/>
                    <xforms:bind id="description-bind" nodeset="description[@xml:lang = $fb-lang]"/>
                    <xforms:bind id="logo-bind" nodeset="logo" type="xs:anyURI"/>
                    <!-- TODO: somehow mark current title as "required" if title in other languages are missing -->
                </xforms:bind>
                <!-- Global attachments (also used by Form Runner) -->
                <xforms:bind nodeset="xforms:instance[@id = 'fr-form-attachments']/*">
                    <xforms:bind id="css-attachment-bind" nodeset="css" type="xs:anyURI"/>
                    <xforms:bind id="pdf-attachment-bind" nodeset="pdf" type="xs:anyURI"/>
                </xforms:bind>
                <!-- Form instance -->
                <xforms:bind nodeset="xforms:instance[@id = 'fr-form-instance']/*">

                    <!-- Handle date / time types. Note we make them optional with xforms:* so we can save the form -->
                    <xforms:bind nodeset="*/*[name() = $model/xforms:bind/xforms:bind/xforms:bind[substring-after(@type, ':') = 'date']/@nodeset]" type="xforms:date"/>
                    <xforms:bind nodeset="*/*[name() = $model/xforms:bind/xforms:bind/xforms:bind[substring-after(@type, ':') = 'time']/@nodeset]" type="xforms:time"/>
                    <xforms:bind nodeset="*/*[name() = $model/xforms:bind/xforms:bind/xforms:bind[substring-after(@type, ':') = 'dateTime']/@nodeset]" type="xforms:dateTime"/>
                    <!-- Handle "boolean" type -->
                    <!--<xforms:bind nodeset="*/*[name() = $model/xforms:bind/xforms:bind/xforms:bind[substring-after(@type, ':') = 'boolean']/@nodeset]" type="xs:boolean"/>-->

                    <!-- Handle local attachments -->
                    <xforms:bind nodeset="*/*[@filename and @mediatype and @size]" type="xs:anyURI" class="fr-attachment"/>
                </xforms:bind>
                <!-- Resources -->
                <xforms:bind nodeset="xforms:instance[@id = 'fr-form-resources']/*">
                    <!-- Handle mandatory sections titles -->
                    <!-- The constraint checks that all the titles are non-empty, not only the one currently visible -->
                    <xforms:bind nodeset="resource/*[name() = $body//fr:section/@id/substring-before(., '-section')]/label" required="true()"
                                 constraint="not((for $t in for $n in name(..) return ../../../resource/*[name() = $n]/label return normalize-space($t) = '') = true())"/>
                </xforms:bind>
            </xforms:bind>
            <!-- Set HTML title with the first title found -->
            <xforms:bind nodeset="xhtml:title" calculate="$metadata-instance/title[1]"/>
        </xforms:bind>
    </xforms:bind>

    <!-- Metadata -->
    <xforms:instance id="fr-form-metadata" xxforms:readonly="true">
        <metadata>
            <application-name>orbeon</application-name>
            <form-name>builder</form-name>
            <title xml:lang="en">Form Builder</title>
            <description xml:lang="en">Orbeon Form Builder allows you to easily build forms right from your web browser and without programming.</description>
            <title xml:lang="fr">Form Builder</title>
            <description xml:lang="fr">Orbeon Form Builder vous permet d'éditer des formulaires directement depuis votre navigateur et sans programmation.</description>
            <title xml:lang="ru">Мастер форм</title>
            <description xml:lang="ru">Мастер форм позволяет легко создавать шаблоны форм запросов.</description>
            <author>Orbeon, Inc.</author>
            <logo mediatype="image/png" filename="orbeon-logo-trimmed-transparent-30.png" size="">/apps/fr/style/orbeon-logo-trimmed-transparent-30.png</logo>
        </metadata>
    </xforms:instance>

    <!-- Similar to fr-triggers-instance, but for FB-specific buttons -->
    <xforms:instance id="fb-triggers-instance">
        <triggers>
            <save-as/>
        </triggers>
    </xforms:instance>

    <xforms:bind nodeset="instance('fb-triggers-instance')">
        <!-- Condition for disabling Save as… button -->
        <!-- HACK: Not sure why, but if we don't put a calculate here (which is useless), then the readonly is not evaluated on recalculate -->
        <xforms:bind nodeset="save-as" readonly="xxforms:instance('fr-parameters-instance')/mode != 'edit'" calculate="xxforms:instance('fr-parameters-instance')/mode"/>
    </xforms:bind>

    <!-- HACK: Bind has inter-model dependency -->
    <xforms:recalculate ev:event="xxforms-value-changed" ev:observer="fr-parameters-instance"/>

    <!-- All form resources -->
    <xforms:instance id="fr-form-resources" src="oxf:/forms/orbeon/builder/form/resources.xml"
                     xxforms:readonly="true" xxforms:cache="true"/>
    <!--<xforms:instance id="fr-form-resources" src="oxf:/forms/orbeon/builder/form/resources.xml"-->
                     <!--xxforms:readonly="false"/>-->

    <!-- Instance containing the current language -->
    <xforms:instance id="fb-language-instance">
        <language/>
    </xforms:instance>

    <!-- Temporary instance for grid computations -->
    <xforms:instance id="fb-span-grid-instance">
        <grid/>
    </xforms:instance>

    <!-- Prepare span grid -->
    <xforms:action ev:event="fb-prepare-span-grid">
        <xxforms:variable name="grid" select="event('grid')"/>

        <!-- Columns are either on fr:grid or fr:repeat parent of fr:grid -->
        <xxforms:variable name="columns" select="($grid/@columns, $grid/../@columns)[1]" as="attribute(columns)"/>

        <!-- Prepare span grid -->
        <xxforms:variable name="tmp" select="instance('fb-span-grid-instance')"/>
        <xforms:delete nodeset="instance('fb-span-grid-instance')/*"/>
        <xforms:insert context="instance('fb-span-grid-instance')" nodeset="*"
                       origin="for $r in $grid/*:tr return xxforms:element('r', for $c in (1 to $columns) return xxforms:element('c'))"/>

        <!-- Fill-out table with rowspan / colspan data -->
        <xforms:action xxforms:iterate="instance('fb-span-grid-instance')/*"><!-- Iterating over rows -->
            <xxforms:variable name="r" select="."/>
            <xxforms:variable name="y" select="position()"/>

            <xforms:action xxforms:iterate="$grid/*:tr[$y]/*:td"><!-- Iterating over actual tds -->
                <xxforms:variable name="td" select="."/>
                <xxforms:variable name="td-x" select="position()"/>
                <xxforms:variable name="rowspan" select="if (@rowspan) then xs:integer(@rowspan) else 1"/>

                <xxforms:variable name="c" select="($r/c[. != 'x'])[$td-x]"/>
                <xxforms:variable name="x" select="count($c/preceding-sibling::c) + 1"/>

                <xforms:action xxforms:iterate="$r/following-sibling::r[position() lt $rowspan]">
                    <xforms:setvalue ref="c[$x]">x</xforms:setvalue>
                </xforms:action>
            </xforms:action>
        </xforms:action>
    </xforms:action>

    <!-- Store user-agent details -->
    <xforms:instance id="fb-user-agent-instance">
        <user-agent>
            <value/>
            <is-ie/>
            <ie-version/>
            <is-supported-ie/>
        </user-agent>
    </xforms:instance>

    <!-- Form to test -->
    <xforms:instance id="fr-form-to-test-instance">
        <dummy xmlns=""/>
    </xforms:instance>

    <!-- Submission to test the form -->
    <xforms:submission id="fb-test-form-submission"
            ref="instance('fr-form-to-test-instance')" method="post" replace="all"
            resource="/fr/orbeon/builder/test" xxforms:target="fb-test-iframe" xxforms:show-progress="false">
            <!-- TODO: Will want to change target to: fb-test-iframe -->

        <!-- Prepare submission -->
        <!-- See also dialog-publish.xml -->
        <xforms:action ev:event="xforms-submit">
            <!-- Copy form -->
            <xforms:insert nodeset="instance('fr-form-to-test-instance')" origin="instance('fr-form-instance')"/>
            <!-- Insert in-scope components -->
            <xforms:insert nodeset="instance('fr-form-to-test-instance')/xhtml:head/*"
                           origin="instance('fb-components-instance')/xbl:xbl[xbl:binding]"/>
            <!-- Remove bindings that don't have a template as those will cause issues if they map to xforms:* -->
            <xforms:delete nodeset="instance('fr-form-to-test-instance')/xhtml:head/xbl:xbl/xbl:binding[not(xbl:template)]"/>
        </xforms:action>

        <!-- Clean-up after submission -->
        <xforms:action ev:event="xforms-submit-done xforms-submit-error">
            <!-- Remove form content in order to save memory -->
            <xforms:insert nodeset="instance('fr-form-to-test-instance')" origin="xxforms:element('dummy')"/>
        </xforms:action>

    </xforms:submission>

    <!-- TODO: check where local variable can be used instead -->
    <xforms:instance id="fb-variables">
        <variables>
            <done/>

            <!-- Currently open in-place editor -->
            <inplace-id/>
            <inplace-repeat-indexes/>

            <next-section-id/>
            <next-control-id/>

            <new-language/>
            <new-language-trigger/>

            <controls-triggers/>
            <sections-triggers/>
            <grids-triggers/>

            <xml-view/>
        </variables>
    </xforms:instance>

    <xforms:bind nodeset="instance('fb-variables')">
        <!-- When are toolbar controls triggers enabled -->
        <xforms:bind nodeset="controls-triggers"
                     readonly="$current-td/ancestor::xbl:binding or ($current-td/* and not($current-td/following-sibling::*:td[1][not(*)]
                                                                        or not($current-td/following-sibling::*:td)
                                                                            and (not(exists($current-td/../following-sibling::*:tr[1]/*:td[1]/*)))))"/>
        <!-- When are grids triggers enabled -->
        <xforms:bind nodeset="grids-triggers" readonly="$current-td/ancestor::xbl:binding"/>
    </xforms:bind>

    <!-- React to a focus on a repeat -->
    <xforms:action ev:event="DOMFocusIn" ev:target="fb-section-content-grid-td-repeat">
        <!-- TODO: anything here? -->
    </xforms:action>

    <!-- Ensure there is an empty xhtml:td to place a new control (may fail) -->
    <xforms:action ev:event="fb-ensure-empty-td">

        <xforms:action context="$current-td">
            <xforms:action if="not(exists(*))">
                <!-- There is no  element in the current td, don't change anything -->
            </xforms:action>
            <xforms:action if="exists(*)">
                <!-- There is an element in the current td, figure out what to do -->
                <xxforms:variable name="is-next-td-available" select="following-sibling::*:td[1][not(*)]"/>
                <xforms:action if="$is-next-td-available">
                    <!-- Next cell is empty, move to that one -->
                    <xforms:setindex repeat="fb-section-content-grid-td-repeat" index="index('fb-section-content-grid-td-repeat') + 1"/>
                </xforms:action>
                <xforms:action if="not($is-next-td-available) and following-sibling::*:td">
                    <!-- TODO: Not sure we have a plan here -->
                </xforms:action>
                <xforms:action if="not($is-next-td-available) and not(following-sibling::*:td)">
                    <xxforms:variable name="is-insert-new-row"
                                      select="exists(../following-sibling::*:tr[1]/*:td[1]/*) or not(exists(../following-sibling::*:tr[1]))"/>
                    <!-- We are the last cell of the row -->
                    <xforms:action if="$is-insert-new-row">
                        <!-- The first cell of the next row is occupied, or there is no next row: insert new row -->
                        <xforms:dispatch name="DOMActivate" target="fb-insert-row-below-trigger"/>
                        <!-- Make sure the first cell is selected -->
                        <xforms:setindex repeat="fb-section-content-grid-td-repeat" index="1"/>
                    </xforms:action>
                    <xforms:action if="not($is-insert-new-row)">
                        <!-- There is a next row, and its first cell is empty, move to that one -->
                        <xforms:setindex repeat="fb-section-content-grid-tr-repeat" index="index('fb-section-content-grid-tr-repeat') + 1"/>
                        <xforms:setindex repeat="fb-section-content-grid-td-repeat" index="1"/>
                    </xforms:action>
                </xforms:action>
            </xforms:action>
        </xforms:action>
    </xforms:action>

    <!-- Delete control and associated resources -->
    <xforms:action ev:event="fb-delete-control">
        <xxforms:variable name="control" select="event('control')"/>

        <xxforms:variable name="control-name" select="substring-before($control/@id, '-control')"/>
        <xxforms:variable name="section-name" select="$control/ancestor::fr:section[1]/(if (@context) then @context else substring-before(@bind, '-bind'))"/>
        <xxforms:variable name="bind" select="$model/xforms:bind[@id = 'fr-form-binds']/xforms:bind[@nodeset = $section-name]/xforms:bind[@nodeset = $control-name]"/>

        <!-- Delete control -->
        <xforms:delete nodeset="$control"/>
        <!-- Delete instance holder -->
        <xforms:delete nodeset="$form-instance/*[name() = $section-name]/*[name() = $control-name]"/>
        <!-- Delete resources -->
        <xforms:delete nodeset="$resources/resource/*[name() = $control-name]"/>
        <!-- Delete bind if any -->
        <xforms:delete nodeset="$bind"/>
    </xforms:action>

    <!-- Insert instance and resource holders -->
    <xforms:action ev:event="fb-insert-holders">
        <xxforms:variable name="current-td" select="event('current-td')"/>
        <xxforms:variable name="section-name" select="event('section-name')"/>
        <xxforms:variable name="instance-holder" select="event('instance-holder')"/>
        <xxforms:variable name="resource-holders" select="event('resource-holders')"/>

        <!-- All the xhtml:td elements up to the current one within the current section -->
        <xxforms:variable name="tds" select="$current-td/preceding::*:td intersect $current-td/ancestor::fr:section[1]//*:td"/>

        <!-- Name of the preceding control id -->
        <xxforms:variable name="preceding-control-id" select="substring-before(($tds/*)[last()]/@id, '-control')"/>

        <!--<xforms:message level="xxforms:log-info">-->
            <!--Preceding: <xforms:output value="$preceding-control-id"/>-->
        <!--</xforms:message>-->

        <!-- Insert new holder element into the instance just after the previous control -->
        <xforms:insert context="$form-instance/*[name() = $section-name]"
                       nodeset="*[name() = $preceding-control-id]"
                       origin="$instance-holder"/>

        <!-- Insert resources placeholders for all languages -->
        <xforms:action xxforms:iterate="$resources/resource">
            <xxforms:variable name="position" select="position()"/>
            <xforms:insert context="." nodeset="*[name() = $preceding-control-id]" origin="$resource-holders[$position]"/>

            <!-- Insert resource templates only if holder passed is not empty -->
            <xforms:insert context="*[name() = name($resource-holders[$position])]" if="not(*)" origin="instance('fb-resource-template')/*"/>
        </xforms:action>
    </xforms:action>

    <!-- Cut/copy/paste instance -->
    <xforms:instance id="fb-xcv-instance">
        <xcv>
            <control/>
            <holder/>
            <resources/>
            <bind/>
            <cut-trigger/>
            <copy-trigger/>
            <paste-trigger/>
        </xcv>
    </xforms:instance>
    <xxforms:variable name="xcv" select="instance('fb-xcv-instance')"/>

    <xforms:bind nodeset="$xcv">
        <xforms:bind nodeset="cut-trigger" readonly="not(exists($current-td/*))"/>
        <xforms:bind nodeset="copy-trigger" readonly="not(exists($current-td/*))"/>
        <xforms:bind nodeset="paste-trigger" readonly="not(exists(../control/*))"/>
    </xforms:bind>

    <!-- Copy current control to xcv instance -->
    <xforms:action ev:event="fb-copy-control">
        <xxforms:variable name="current-control" select="event('current-td')/*"/>

        <xforms:action if="exists($current-control)">
            <xxforms:variable name="current-control-name" select="substring-before($current-control/@id, '-control')"/>
            <xxforms:variable name="current-bind-id" select="concat($current-control-name, '-bind')"/>
            <xxforms:variable name="bind" select="$model//xforms:bind[@id = $current-bind-id]"/>

            <!-- Clear clipboard -->
            <xforms:action xxforms:iterate="$xcv/*">
                <xforms:delete nodeset="*"/>
            </xforms:action>

            <!-- Copy control -->
            <xforms:insert context="$xcv/control" origin="$current-control"/>

            <!-- Copy holder -->
            <xforms:insert context="$xcv/holder" origin="$form-instance/*/*[name() = $current-control-name]"/>

            <!-- Copy all resources -->
            <xforms:insert context="$xcv/resources" origin="$resources/resource/*[name() = $current-control-name]"/>

            <!-- Copy bind if any -->
            <xforms:insert context="$xcv/bind" origin="$bind"/>
        </xforms:action>

    </xforms:action>

    <!-- Adjust control bindings -->
    <xforms:action ev:event="fb-rename-control">
        <xxforms:variable name="control" select="event('control')"/>
        <xxforms:variable name="new-control-name" select="event('new-name')"/>

        <xforms:action context="$control">
            <!-- Set @id in any case -->
            <xforms:insert context="." origin="xxforms:attribute('id', concat($new-control-name, '-control'))"/>

            <!-- Set @ref value if present -->
            <xforms:setvalue ref="@ref" value="$new-control-name"/>

            <!-- Set @bind value if present -->
            <xforms:setvalue ref="@bind" value="concat($new-control-name, '-bind')"/>

            <!-- Set xforms:label, xforms:hint, xforms:help and xforms:alert @ref if present -->
            <xforms:action xxforms:iterate="(xforms:label, xforms:hint, xforms:help, xforms:alert)[@ref = '' or starts-with(@ref, '$form-resources')]">
                <xxforms:variable name="local-name" select="local-name()"/>
                <xforms:setvalue ref="@ref" value="concat('$form-resources/', $new-control-name, '/', $local-name)"/>
            </xforms:action>

            <!-- Set xforms:itemset/@nodeset value if present -->
            <xforms:setvalue ref="xforms:itemset/@nodeset" value="concat('$form-resources/', $new-control-name, '/item')"/>
        </xforms:action>
    </xforms:action>

    <!-- Rename holders -->
    <xforms:action ev:event="fb-rename-holders">
        <xxforms:variable name="holders" select="event('holders')"/>
        <xxforms:variable name="new-name" select="event('new-name')"/>

        <!-- Iterate through instance holder and all resources -->
        <xforms:action xxforms:iterate="$holders">
            <xxforms:variable name="current-holder" select="."/>

            <!-- Insert new placeholder after existing one -->
            <xforms:insert nodeset="$current-holder" origin="xxforms:element($new-name)"/>
            <!-- Copy existing content into new element -->
            <xforms:insert context="$current-holder/following-sibling::*[1]" origin="$current-holder/(@* | node())"/>
            <!-- Delete old element -->
            <xforms:delete nodeset="$current-holder"/>
        </xforms:action>
    </xforms:action>

    <!-- Rename bind -->
    <xforms:action ev:event="fb-rename-bind">
        <xxforms:variable name="old-name" select="event('old-name') treat as xs:string"/>
        <xxforms:variable name="new-name" select="event('new-name') treat as xs:string"/>
        <xxforms:variable name="old-bind-id" select="concat($old-name, '-bind')"/>
        <xxforms:variable name="bind" select="$model//xforms:bind[@id = $old-bind-id]"/>
        <xforms:action context="$bind" if="exists(.)">
            <xforms:setvalue ref="@id" value="concat($new-name, '-bind')"/>
            <xforms:insert context="." origin="xxforms:attribute('name', $new-name)"/>
            <xforms:setvalue ref="@nodeset" value="$new-name"/>
        </xforms:action>
    </xforms:action>

    <!-- Paste control if there is one in the clipboard -->
    <xforms:action ev:event="fb-paste-control" if="$xcv/control/*">

        <!-- Try to find empty td -->
        <xforms:dispatch name="fb-ensure-empty-td" target="fr-form-model"/>

        <!-- Get new td -->
        <xxforms:variable name="new-td" select="xxforms:binding('fb-section-content-grid-td-repeat')[index('fb-section-content-grid-td-repeat')]"/>
        <xforms:action context="$new-td" if="not(exists(*))">
            <!-- We now have an empty cell for pasting -->

            <xxforms:variable name="xcv-control-id" select="$xcv/control/*/@id"/>

            <!-- Check if clipboard control id is in use -->
            <xforms:action if="$body//*[@id = $xcv-control-id]">
                <!-- If so, get new id and replace references -->
                <xforms:dispatch name="fb-compute-control-id" target="fr-form-model"/>
                <xxforms:variable name="new-control-name" select="concat('control-', $next-control-id)"/>

                <!-- Adjust bindings on xcv control -->
                <xforms:dispatch name="fb-rename-control" target="fr-form-model">
                    <xxforms:context name="control" select="$xcv/control/*"/>
                    <xxforms:context name="new-name" select="$new-control-name"/>
                </xforms:dispatch>

                <!-- Rename holders -->
                <xforms:dispatch name="fb-rename-holders" target="fr-form-model">
                    <xxforms:context name="holders" select="($xcv/holder/*, $xcv/resources/*)"/>
                    <xxforms:context name="new-name" select="$new-control-name"/>
                </xforms:dispatch>

                <!-- Update bind if existing -->
                <xforms:setvalue ref="$xcv/bind/xforms:bind/@id" value="concat($new-control-name, '-bind')"/>
                <xforms:setvalue ref="$xcv/bind/xforms:bind/@nodeset" value="$new-control-name"/>

            </xforms:action>

            <!-- Insert control -->
            <xforms:insert context="$new-td" origin="$xcv/control/*"/>

            <!-- Insert instance and resource holders -->
            <!-- TODO: match against existing languages, as that may have changed between copy and paste -->
            <xxforms:variable name="section-name" select="$current-td/ancestor::fr:section[1]/(if (@context) then @context else substring-before(@bind, '-bind'))"/>
            <xforms:dispatch name="fb-insert-holders" target="fr-form-model">
                <xxforms:context name="current-td" select="$new-td"/>
                <xxforms:context name="section-name" select="$section-name"/>
                <xxforms:context name="instance-holder" select="$xcv/holder/*"/>
                <xxforms:context name="resource-holders" select="$xcv/resources/*"/>
            </xforms:dispatch>

            <!-- Insert bind if any -->
            <xforms:action if="exists($xcv/bind/xforms:bind)">
                <xxforms:variable name="control-name" select="substring-before($xcv/control/*/@id, '-control')"/>
                <xforms:dispatch name="fb-ensure-bind" target="fr-form-model">
                    <xxforms:context name="control-name" select="$control-name"/>
                </xforms:dispatch>
                <xxforms:variable name="bind" select="$model//xforms:bind[@nodeset = $control-name]"/>
                <xforms:insert nodeset="$bind" origin="$xcv/bind/xforms:bind"/>
                <xforms:delete nodeset="$bind"/>
            </xforms:action>

        </xforms:action>
    </xforms:action>

    <!-- Generic instance to set the control id on which to work -->
    <!-- NOTE: Ideally we wouldn't need this kind of global variables, but could either call functions or pass parameters to events -->
    <xforms:instance id="fb-current-control-instance">
        <control>
            <id/>
        </control>
    </xforms:instance>
    <xxforms:variable name="current-control-name" select="instance('fb-current-control-instance')/id"/>

    <!-- Create the bind element for the current control or section if it does not exist yet -->
    <xforms:action ev:event="fb-ensure-bind">
        <!-- Control name: use this if you want to create the bind for the section and the control -->
        <xxforms:variable name="control-name" select="event('control-name')" as="xs:string?"/>
        <!-- Section name: use this if you don't pass a control name and just want to create the bind for the section -->
        <xxforms:variable name="section-name" select="event('section-name')" as="xs:string?"/>

        <!-- Proceed only if a control name or section name is provided -->
        <xforms:action if="$control-name or $section-name">
            <!-- Insert bind container if needed -->
            <xforms:insert context="$model"
                           if="not(xforms:bind[@id = 'fr-form-binds'])"
                           nodeset="xforms:instance[@id = 'fr-form-instance']"
                           origin="instance('fb-bind-template')"/>

            <!-- Insert bind for section if needed -->
            <xxforms:variable name="current-control"
                              select="if ($control-name) then $body//*[@id = concat($control-name, '-control')] else ()"/>
            <xxforms:variable name="current-section-name"
                              select="if ($control-name) then $current-control/ancestor::fr:section[1]/(if (@context) then @context else substring-before(@bind, '-bind')) else $section-name"/>
            <xxforms:variable name="is-custom-instance" select="$metadata-instance/form-instance-mode = 'custom'"/>
            <xforms:action context="$model/xforms:bind[@id = 'fr-form-binds']">
                <xforms:action if="empty(xforms:bind[@name = $current-section-name])">
                    <xforms:insert context="." nodeset="xforms:bind" origin="instance('fb-bind-template')"/>
                    <xxforms:variable name="bind" select="xforms:bind[last()]" as="element(xforms:bind)"/>
                    <xforms:setvalue ref="$bind/@id" value="concat($current-section-name, '-bind')"/>
                    <xforms:setvalue ref="$bind/@name" value="$current-section-name"/>
                    <xforms:setvalue ref="$bind/@nodeset" value="if ($is-custom-instance) then '()' else $current-section-name"/>
                </xforms:action>
            </xforms:action>

            <xforms:action if="$control-name">
                <!-- Insert bind for control if needed -->
                <xxforms:variable name="current-bind-id" select="concat($control-name, '-bind')"/>
                <xforms:action context="$model/xforms:bind[@id = 'fr-form-binds']/xforms:bind[@name = $current-section-name]">
                    <xforms:action if="not(xforms:bind[@id = $current-bind-id])">
                        <xforms:insert context="." nodeset="xforms:bind" origin="instance('fb-bind-template')"/>
                        <xxforms:variable name="bind" select="xforms:bind[last()]" as="element(xforms:bind)"/>
                        <xforms:setvalue ref="$bind/@id" value="$current-bind-id"/>
                        <xforms:insert context="$bind" origin="xxforms:attribute('name', $control-name)"/>
                        <xforms:setvalue ref="$bind/@nodeset" value="if ($is-custom-instance) then '()' else $control-name"/>
                    </xforms:action>
                </xforms:action>
            </xforms:action>
        </xforms:action>
    </xforms:action>

    <!-- TODO: Use this once OF supports custom XPath functions -->
    <!--<xforms:function name="fb:get-section-name" as="xs:string">-->
        <!--<xforms:param name="section" as="element(fr:section)"/>-->
        <!--<xforms:return select="if ($section/@context) then $section/@context else substring-before($section/@bind, '-bind')"/>-->
    <!--</xforms:function>-->

    <!-- Schema upload dialog -->
    <xforms:instance id="fb-schema-upload-instance">
        <validation>
            <schema-uri filename="" mediatype="" size=""/>
            <schema>
                <!-- Content will be like this -->
                <!--<xs:schema>-->
                    <!--...-->
                <!--</xs:schema>-->
            </schema>
            <temp-type/>
        </validation>
    </xforms:instance>

    <xforms:bind nodeset="instance('fb-schema-upload-instance')">
        <xforms:bind nodeset="temp-type" readonly="true()"/>
    </xforms:bind>

    <!-- Submission to load the components library -->
    <!-- NOTE: We only pass the app name, not the form name -->
    <xforms:submission id="fb-load-components" serialization="none"
                       method="get" resource="/fr/service/custom/orbeon/builder/toolbox?application={xxforms:bind('application-name-bind')}"
                       replace="instance" instance="fb-components-instance"
                       xxforms:readonly="true" xxforms:cache="true"/>

    <xforms:instance id="fb-components-instance">
        <!-- This contains the components available for the currently edited form -->
        <components/>
    </xforms:instance>

    <!-- Template for outer bind -->
    <xforms:instance id="fb-bind-template" xxforms:readonly="true" xxforms:exclude-result-prefixes="pipeline xhtml xs xsi ev xi xxi xxforms fr fb saxon xbl exforms context">
        <xforms:bind id="fr-form-binds" nodeset="." name=""/>
    </xforms:instance>

    <xforms:bind nodeset="instance('fb-variables')">
        <xforms:bind nodeset="new-language-trigger" readonly="normalize-space(../new-language) = ''"/>
    </xforms:bind>

    <xxforms:variable name="variables" select="instance('fb-variables')"/>
    <xxforms:variable name="next-section-id" select="$variables/next-section-id"/>
    <xxforms:variable name="next-control-id" select="$variables/next-control-id"/>

    <!-- Compute the next section id -->
    <xforms:action ev:event="fb-compute-section-id">
        <!-- Initialize with count of existing sections (we could as well start from 1) -->
        <xforms:setvalue if="$next-section-id = ''" ref="$next-section-id" value="count($body//fr:section)"/>
        <!-- Increment number until the id doesn't clash with the control id OR the element name -->
        <xforms:action while="$body//fr:section[@id = concat('section-', $next-section-id, '-section')]
                                or $form-instance/*[name() = concat('section-', $next-section-id)]">
            <xforms:setvalue ref="$next-section-id" value=". + 1"/>
        </xforms:action>
    </xforms:action>

    <!-- Compute the next control id -->
    <xforms:action ev:event="fb-compute-control-id">
        <!-- Initialize based on count of existing controls (we could as well start from 1) -->
        <xforms:setvalue if="$next-control-id = ''" ref="$next-control-id" value="count($body//*[ends-with(@id, '-control')]) + 1"/>
        <!-- Increment number until the id doesn't clash with the control id OR the element name -->
        <xforms:action while="$body//*[@id = concat('control-', $next-control-id, '-control')]
                                or $form-instance/*/*[name() = concat('control-', $next-control-id)]">
            <xforms:setvalue ref="$next-control-id" value=". + 1"/>
        </xforms:action>
    </xforms:action>

    <xforms:instance id="fb-section-template" xxforms:readonly="true" xxforms:exclude-result-prefixes="pipeline xs xsi ev xi xxi xxforms fb saxon xbl exforms context">
        <fr:section id="" bind="">
            <xforms:label ref=""/>
            <xforms:help ref=""/>
            <fr:grid columns="1">
                <xhtml:tr>
                    <xhtml:td/>
                </xhtml:tr>
            </fr:grid>
        </fr:section>
    </xforms:instance>

    <xforms:instance id="fb-resource-template" xxforms:readonly="true" xxforms:exclude-result-prefixes="pipeline xhtml xforms xs xsi ev xi xxi xxforms fr fb saxon xbl exforms context">
        <template>
            <label/>
            <hint/>
            <help/>
            <alert/>
        </template>
    </xforms:instance>

    <xforms:instance id="fb-grid-1-template" xxforms:readonly="true" xxforms:exclude-result-prefixes="pipeline xforms xs xsi ev xi xxi xxforms fb saxon xbl exforms context">
        <fr:grid columns="1">
            <xhtml:tr>
                <xhtml:td/>
            </xhtml:tr>
        </fr:grid>
    </xforms:instance>

    <xforms:instance id="fb-lhha-template" xxforms:readonly="true" xxforms:exclude-result-prefixes="pipeline xhtml xs xsi ev xi xxi xxforms fr fb saxon xbl exforms context">
        <xforms:input>
            <xforms:label ref=""/>
            <xforms:hint ref=""/>
            <xforms:help ref=""/>
            <xforms:alert ref="$fr-resources/detail/labels/alert"/>
        </xforms:input>
    </xforms:instance>

    <!-- Instance for metadata editor -->
    <xforms:instance id="fb-metadata-instance">
        <metadata>
            <application-name/>
            <form-name/>
            <next-trigger/>
            <mode/> <!-- edit | save-as -->
            <toolbox>
                <schema/>
                <css/>
                <pdf/>
                <view-source/>
                <edit-source/>
                <services-actions/>
            </toolbox>
        </metadata>
    </xforms:instance>

    <!-- Enable/disable trigger -->
    <xforms:setvalue ev:event="xxforms-invalid" ev:observer="fb-metadata-instance" ref="instance('fb-metadata-instance')/next-trigger">disabled</xforms:setvalue>
    <xforms:setvalue ev:event="xxforms-valid" ev:observer="fb-metadata-instance" ref="instance('fb-metadata-instance')/next-trigger">enabled</xforms:setvalue>

    <xforms:bind nodeset="instance('fb-metadata-instance')">
        <!-- App/form name -->
        <!-- NOTE: use normalize-space() = . because type validation seems to allow leading and trailing spaces -->
        <xforms:bind nodeset="application-name" required="true()" type="xs:NCName" constraint="normalize-space() = ."/>
        <xforms:bind nodeset="form-name" required="true()" type="xs:NCName" constraint="normalize-space() = ."/>
        <!-- Triggers -->
        <xforms:bind nodeset="next-trigger" readonly=". = 'disabled'"/>
        <xforms:bind nodeset="toolbox/schema" relevant="xxforms:property('oxf.fb.menu.schema')"/>
        <xforms:bind nodeset="toolbox/css" relevant="xxforms:property('oxf.fb.menu.css')"/>
        <xforms:bind nodeset="toolbox/pdf" relevant="xxforms:property('oxf.fb.menu.pdf')"/>
        <xforms:bind nodeset="toolbox/view-source" relevant="xxforms:property('oxf.fb.menu.view-source')"/>
        <xforms:bind nodeset="toolbox/edit-source" relevant="xxforms:property('oxf.fb.menu.edit-source')"/>
    </xforms:bind>


</xforms:model>
