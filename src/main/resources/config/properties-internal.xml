<!--
  Copyright (C) 2010 Orbeon, Inc.

  This program is free software; you can redistribute it and/or modify it under the terms of the
  GNU Lesser General Public License as published by the Free Software Foundation; either version
  2.1 of the License, or (at your option) any later version.

  This program is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY;
  without even the implied warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.
  See the GNU Lesser General Public License for more details.

  The full text of the license is available at http://www.gnu.org/copyleft/lesser.html
  -->
<properties xmlns:xs="http://www.w3.org/2001/XMLSchema"
            xmlns:oxf="http://www.orbeon.com/oxf/processors"
            xmlns:xh="http://www.w3.org/1999/xhtml"
            xmlns:xf="http://www.w3.org/2002/xforms"
            xmlns:xxf="http://orbeon.org/oxf/xml/xforms"
            xmlns:exf="http://www.exforms.org/exf/1-0"
            xmlns:xbl="http://www.w3.org/ns/xbl"
            xmlns:xxbl="http://orbeon.org/oxf/xml/xbl"
            xmlns:fr="http://orbeon.org/oxf/xml/form-runner">

    <!-- ==== Internal base properties ============================================================================ -->

    <!-- URL rewriting -->
    <property as="xs:string"  name="oxf.url-rewriting.platform-paths">
        ^/(ops/|config/|xbl/orbeon/|forms/orbeon/|apps/fr/|js/|xforms-server).*$
    </property>
    <property as="xs:string"  name="oxf.url-rewriting.app-paths">
        ^/(apps|xbl|forms)/.*$
    </property>
    <property as="xs:string"  name="oxf.url-rewriting.app-prefix"                    value="/apps"/>

    <property as="xs:string"  name="oxf.url-rewriting.wsrp.context"                  value=""/>
    <property as="xs:boolean" name="oxf.url-rewriting.wsrp.encode-resources"         value="false"/>

    <!-- HTTP client -->
    <property as="xs:string"  name="oxf.http.state"                                  value="session"/>
    <property as="xs:string"  name="oxf.http.forward-headers.private"                value="Orbeon-Client"/>
    <property as="xs:string"  name="oxf.http.forward-cookies.private"                value=""/>

    <!--
        Note on Cache-Control for HTTP responses:

        For pages, we used to set Cache-Control to public, however this caused a rare and hard to reproduce issue
        where IE 7 (and maybe other versions of IE, but not Firefox), over-aggressively cached pages generated by Orbeon
        Forms. As a result, user A could log a page, logout from the application; later, user B logs into the
        application with the same browser, navigates to the page, and gets the version generated earlier for user A,
        which was cached by the browser (no request being set by IE to the server).

        Setting Cache-Control to no-cache solves the problem, but in that case IE doesn't reset the value of form fields
        when navigating back to a page, which breaks the mechanism we have to restore the form upon hitting back in the
        browser. Setting Cache-Control to private, max-age=0 solves the caching issue and doesn't prevent IE from
        restoring form fields upon hitting back. This is also what Google does on their home page (as of 2010-12-02).

        Note on blank Pragma:

        Tomcat adds "Pragma", "Expires" and "Cache-Control" headers when resources are constrained,disabling caching if
        they are not set. We must re-set them to allow caching.
    -->
    <property as="xs:string"  name="oxf.http.page.cache-headers">
        Cache-Control: private, max-age=0; Pragma:
    </property>
    <property as="xs:string"  name="oxf.http.resource.cache-headers">
        Cache-Control: public; Pragma:
    </property>
    <property as="xs:string"  name="oxf.http.nocache.cache-headers">
        Cache-Control: no-cache, no-store, must-revalidate; Pragma: no-cache; Expires: 0
    </property>

    <!--
        About oxf.http.internal-paths:

        The following property contains a regular expression which determines which request paths are internal.
        Since 4.7, we avoid doing HTTP requests over the network for requests that target Orbeon Forms itself, and
        we don't support anymore those requests being made over the network, so this property shouldn't be changed
        by users, and thus isn't listed in the documentation.
      -->
    <property as="xs:string"  name="oxf.http.internal-paths"                              value="(?!/exist/)/.*(?&lt;!\.jsp)"/>

    <!-- Processor-specific properties -->
    <property as="xs:string"  processor-name="oxf:page-flow" name="instance-passing"      value="redirect"/>
    <property as="xs:string"  processor-name="oxf:page-flow" name="submission-path"       value="/xforms-server-submit"/>
    <property as="xs:anyURI"  processor-name="oxf:page-flow" name="submission-model"      value="oxf:/ops/xforms/xforms-server-submit.xpl"/>

    <!-- ==== Internal XForms properties ========================================================================== -->

     <!-- XForms cache configuration -->
    <property as="xs:string"  name="oxf.xforms.state-handling"                            value="server"/>
    <property as="xs:boolean" name="oxf.xforms.cache.document"                            value="true"/>

    <property as="xs:boolean" name="oxf.xforms.optimize-get-all"                          value="true"/>
    <property as="xs:boolean" name="oxf.xforms.local-submission-forward"                  value="true"/>
    <property as="xs:boolean" name="oxf.xforms.local-submission-include"                  value="false"/>
    <property as="xs:boolean" name="oxf.xforms.local-instance-include"                    value="false"/>

    <property as="xs:boolean" name="oxf.xforms.gzip-state"                                value="true"/>

    <!-- NOTE: This is only used client-side by dialogs. Unclear why it should default to false. -->
    <property as="xs:boolean" name="oxf.xforms.use-aria"                                  value="false"/>

    <property as="xs:boolean" name="oxf.xforms.xforms11-switch"                           value="false"/>

    <!-- Whitespace handling for XForms documents -->
    <property as="xs:string"  name="oxf.xforms.whitespace.base.default"                   value="collapse"/>
    <property as="xs:string"  name="oxf.xforms.whitespace.base.normalize">
        xf|model,
        xbl|xbl
    </property>
    <property as="xs:string"  name="oxf.xforms.whitespace.base.preserve">
        xf|instance > *,
        xf|var,
        xxf|var,
        xf|variable,
        xxf|variable,
        exf|variable,
        xf|setvalue,
        xf|value,
        xxf|sequence,
        xxf|script,
        xf|action[type=xpath],
        xs|schema,
        xh|pre,
        xh|textarea,
        xh|script,
        xh|style,
        xh|template
    </property>
    <property as="xs:string"  name="oxf.xforms.whitespace.base.collapse">
        xf|label,
        xf|help,
        xf|hint,
        xf|alert,
        xf|message,
        xbl|template,
        xxbl|global
    </property>
    <property as="xs:string"  name="oxf.xforms.whitespace.html.default"                   value="normalize"/>
    <property as="xs:string"  name="oxf.xforms.whitespace.html.collapse">
        xh|title,
        xh|body
    </property>

    <property as="xs:string"  name="oxf.xforms.assets.baseline.updates.offline">
        <!-- Not sure if all of these are needed but listing them all won't hurt -->
        -/ops/javascript/scalajs/orbeon-xforms.js
        -/ops/javascript/scalajs/orbeon-xforms-offline.js
        -/apps/fr/resources/scalajs/orbeon-form-runner.js
        -/apps/fr/resources/scalajs/orbeon-form-runner-web.js
        -/forms/orbeon/builder/resources/scalajs/orbeon-form-builder.js

        <!-- Form Runner CSS -->
        +/apps/fr/style/form-runner-common.css
        +/apps/fr/style/form-runner-base.css
        +/apps/fr/style/form-runner-orbeon.css
        +/apps/fr/style/form-runner-responsive.css

        <!-- Temporary until we can create a baseline that includes baseline XBL components -->
        +/xbl/orbeon/section/section.css
        +/xbl/orbeon/grid/grid.css

        <!-- Temporary until we can create a baseline that includes baseline XBL components -->
        +/xbl/orbeon/date/bootstrap-datepicker-1.8.0-dist/js/bootstrap-datepicker.min.js

        <!-- Main offline JavaScript -->
        +/apps/fr/resources/scalajs/orbeon-form-runner-offline.js
    </property>

    <!-- ==== Internal Form Runner properties ===================================================================== -->

    <!-- CSS/JavaScript update to the Form Runner baseline -->
    <property as="xs:string"  name="oxf.xforms.assets.baseline.updates.fr">
        +/apps/fr/style/form-runner-common.css
        +/apps/fr/style/form-runner-base.css
        +/apps/fr/style/form-runner-orbeon.css

        -/ops/javascript/scalajs/orbeon-xforms.js
        +/apps/fr/resources/scalajs/orbeon-form-runner-web.js
    </property>

    <!-- Additional CSS/JavaScript for the detail page -->
    <property as="xs:string"  name="oxf.fr.detail.css.uri.*.*">
        /apps/fr/style/form-runner-responsive.css
    </property>
    <property as="xs:string"  name="oxf.fr.detail.js.uri.*.*">
    </property>

    <!-- Additional CSS/JavaScript for the summary page -->
    <property as="xs:string"  name="oxf.fr.summary.css.uri.*.*"/>
    <property as="xs:string"  name="oxf.fr.summary.js.uri.*.*"/>

    <!-- PDF template formatting -->
    <!-- NOTE: In the future we don't want those to apply to XHTML, but to an intermediate representation -->
    <!-- NOTE: Can't use xxf:split() in these expressions yet (saxon:evaluate() doesn't find the functions). -->
    <property as="xs:string"  name="oxf.fr.pdf.format.input-string">
        (./descendant-or-self::*[tokenize(@class, '\s+') = 'xforms-input']/input)[1]/@value/string()
    </property>
    <!-- https://github.com/orbeon/orbeon-forms/issues/4272 -->
    <property as="xs:string"  name="oxf.fr.pdf.format.input-time-string">
        (./descendant-or-self::*[tokenize(@class, '\s+') = 'xforms-input' and tokenize(@class, '\s+') = 'xforms-type-time']/input)[1]/@value/string()
    </property>
    <property as="xs:string"  name="oxf.fr.pdf.format.input-dateTime">
        string-join(.//*[tokenize(@class, '\s+') = 'xforms-input-input']/@value/string(), ' ')
    </property>
    <property as="xs:string"  name="oxf.fr.pdf.format.output-string">
        .//*[tokenize(@class, '\s+') = 'xforms-output-output']/string()
    </property>
    <property as="xs:string"  name="oxf.fr.pdf.format.textarea">
        .//textarea/string()
    </property>
    <property as="xs:string"  name="oxf.fr.pdf.format.select-label">
        (.//option[@selected = 'selected'], .//input[@checked = 'checked']/parent::label)[1]/string()
    </property>
    <property as="xs:string"  name="oxf.fr.pdf.format.select-value">
        (.//option[@selected = 'selected'], .//input[@checked = 'checked'])[1]/@value/string()
    </property>
    <property as="xs:string"  name="oxf.fr.pdf.format.select-labels-string">
        string-join((.//option[@selected = 'selected'], .//input[@checked = 'checked']/parent::label)/string(), ' - ')
    </property>

    <property as="xs:string"  name="oxf.fr.pdf.format.select-labels">
        (.//option[@selected = 'selected'], .//input[@checked = 'checked']/parent::label)/string()
    </property>
    <property as="xs:string"  name="oxf.fr.pdf.format.select-values">
        (.//option[@selected = 'selected'], .//input[@checked = 'checked'])/@value/string()
    </property>

    <property as="xs:string"  name="oxf.fr.pdf.format.attachment-url">
        (
            ./descendant-or-self::*[
                tokenize(@class, '\s+') = 'xforms-output' and
                not(
                    tokenize(@class, '\s+') = 'xforms-disabled'
                )
            ]/img[
                not(
                    tokenize(@class, '\s+') = ('xforms-help', 'xforms-disabled')
                ) and (
                    tokenize(@class, '\s+') = 'xforms-output-output' or not(@id)
                )
            ]/@src
        )[1]/string()[
            . != '/ops/images/xforms/spacer.gif'
        ]
    </property>

    <property as="xs:string"  name="oxf.fr.pdf.format.attachment-metadata">
        for $info in (.//*[@class = 'xforms-upload-info']) return
            string-join(
                $info/*[
                    @class = (
                        'xforms-upload-filename',
                        'xforms-upload-mediatype',
                        'xforms-upload-size'
                    )
                ]/string()[normalize-space()],
                ', '
            )
    </property>

    <property as="xs:string"  name="oxf.fr.pdf.format.fr-autocomplete">
        .//*[tokenize(@class, '\s+') = 'fr-autocomplete-external-value']/input/@value/string()
    </property>

    <property as="xs:string"  name="oxf.fr.pdf.map.*.*.xforms-input.*"                    value="input-string"/>
    <property as="xs:string"  name="oxf.fr.pdf.map.*.*.xforms-input.date"                 value="input-string"/>
    <property as="xs:string"  name="oxf.fr.pdf.map.*.*.xforms-input.time"                 value="input-string"/>
    <property as="xs:string"  name="oxf.fr.pdf.map.*.*.xforms-input.dateTime"             value="input-dateTime"/>
    <property as="xs:string"  name="oxf.fr.pdf.map.*.*.xforms-input.boolean"              value="select-value"/>
    <property as="xs:string"  name="oxf.fr.pdf.map.*.*.xforms-output.*"                   value="output-string"/>
    <property as="xs:string"  name="oxf.fr.pdf.map.*.*.xforms-textarea.*"                 value="textarea"/>
    <property as="xs:string"  name="oxf.fr.pdf.map.*.*.xforms-select.*"                   value="select-labels-string"/>
    <property as="xs:string"  name="oxf.fr.pdf.map.*.*.xforms-select1.*"                  value="select-label"/>
    <property as="xs:string"  name="oxf.fr.pdf.map.*.*.fr-us-state.*"                     value="select-label"/>
    <property as="xs:string"  name="oxf.fr.pdf.map.*.*.fr-attachment.anyURI"              value="attachment-metadata"/>
    <property as="xs:string"  name="oxf.fr.pdf.map.*.*.fr-image-attachment.anyURI"        value="attachment-url"/>
    <property as="xs:string"  name="oxf.fr.pdf.map.*.*.fr-wpaint.*"                       value="attachment-url"/>
    <property as="xs:string"  name="oxf.fr.pdf.map.*.*.fr-number.*"                       value="input-string"/>
    <property as="xs:string"  name="oxf.fr.pdf.map.*.*.fr-currency.*"                     value="input-string"/>
    <property as="xs:string"  name="oxf.fr.pdf.map.*.*.fr-date.*"                         value="input-string"/>
    <property as="xs:string"  name="oxf.fr.pdf.map.*.*.fr-time.*"                         value="input-time-string"/>
    <property as="xs:string"  name="oxf.fr.pdf.map.*.*.fr-us-phone.*"                     value="input-string"/>
    <property as="xs:string"  name="oxf.fr.pdf.map.*.*.fr-dropdown-select1.*"             value="select-label"/>
    <property as="xs:string"  name="oxf.fr.pdf.map.*.*.fr-yesno-input.*"                  value="select-value"/>
    <property as="xs:string"  name="oxf.fr.pdf.map.*.*.fr-autocomplete.*"                 value="fr-autocomplete"/>
    <property as="xs:string"  name="oxf.fr.pdf.map.*.*.fr-databound-select1.*"            value="select-label"/>
    <property as="xs:string"  name="oxf.fr.pdf.map.*.*.fr-checkbox-input.*"               value="select-value"/>

     <!-- Internal processes -->
    <property as="xs:string"  name="oxf.fr.detail.process.save-import.*.*"                value='save'/>
    <property as="xs:string"  name="oxf.fr.detail.process.validation-dialog-review.*.*"   value='abort'/>
    <property as="xs:string"  name="oxf.fr.detail.process.validation-dialog-continue.*.*" value='resume'/>
    <property as="xs:string"  name="oxf.fr.detail.process.autosave.*.*"                   value='save(draft = "true")'/>
    <property as="xs:string"  name="oxf.fr.detail.process.relinquish-lease.*.*"           value='relinquish-lease'/>

    <!-- Reusable processes -->
    <property as="xs:string"  name="oxf.fr.detail.process.orbeon-home.*.*">
        relinquish-lease
        then navigate("/")
    </property>
    <property as="xs:string"  name="oxf.fr.detail.process.form-runner-home.*.*">
        relinquish-lease
        then navigate("/fr/")
    </property>
    <property as="xs:string"  name="oxf.fr.detail.process.require-uploads.*.*">
        pending-uploads
        recover (error-message("upload-in-progress") then success)
    </property>
    <property as="xs:string"  name="oxf.fr.detail.process.require-valid.*.*">
        show-relevant-errors
        then captcha
        then validate("error")
        recover (
            show-relevant-errors
            then expand-invalid
            then error-message("form-validation-error")
            then success
        )
    </property>
    <property as="xs:string"  name="oxf.fr.detail.process.review-messages.*.*">
        validate("warning")
        then validate("info")
        recover (xf:show("fr-validation-dialog") then suspend)
    </property>
    <property as="xs:string"  name="oxf.fr.detail.process.validate-all.*.*">
        require-valid
        then review-messages
    </property>
    <property as="xs:string"  name="oxf.fr.detail.process.wizard-prev.*.*">
        wizard-prev
        recover error-message(
            resource   = "wizard-prev-error",
            appearance = "ephemeral"
        )
    </property>
    <property as="xs:string"  name="oxf.fr.detail.process.wizard-next.*.*">
        wizard-next
        recover error-message(
            resource   = "wizard-next-error",
            appearance = "ephemeral"
        )
    </property>
    <property as="xs:string"  name="oxf.fr.detail.process.wizard-prev.*.*">
        xf:dispatch(name = "fr-prev", targetid = "fr-view-component")
    </property>
    <property as="xs:string"  name="oxf.fr.detail.process.wizard-toc.*.*">
        xf:dispatch(name = "fr-show-toc",  targetid = "fr-view-component")
    </property>

    <!-- Home page internal processes -->
    <property as="xs:string"  name="oxf.fr.home.process.load-local">
        xf:send("read-local-metadata")
        then xf:dispatch("process-results")
    </property>
    <property as="xs:string"  name="oxf.fr.home.process.load-remote">
        xf:send("read-remote-metadata")
        then xf:dispatch("store-credentials")
        recover ask-credentials
    </property>
    <property as="xs:string"  name="oxf.fr.home.process.ask-credentials">
        xf:show("fr-credentials-dialog")
        then suspend
        then load-remote
    </property>
    <property as="xs:string"  name="oxf.fr.home.process.load-start-with-remote">
        load-remote
        then load-local
    </property>
    <property as="xs:string"  name="oxf.fr.home.process.load-start-with-credentials">
        ask-credentials
        then load-local
    </property>

    <property as="xs:string"  name="oxf.fr.home.process.credentials-ok">
        resume
    </property>
    <property as="xs:string"  name="oxf.fr.home.process.credentials-cancel">
        abort then load-local
    </property>
    <property as="xs:string"  name="oxf.fr.home.process.publish-local">
        xf:dispatch("confirm-local-publish")    then suspend then xf:dispatch("local-publish")
    </property>
    <property as="xs:string"  name="oxf.fr.home.process.unpublish-local">
        xf:dispatch("confirm-local-unpublish")  then suspend then xf:dispatch("local-unpublish")
    </property>
    <property as="xs:string"  name="oxf.fr.home.process.publish-remote">
        xf:dispatch("confirm-remote-publish")   then suspend then xf:dispatch("remote-publish")
    </property>
    <property as="xs:string"  name="oxf.fr.home.process.unpublish-remote">
        xf:dispatch("confirm-remote-unpublish") then suspend then xf:dispatch("remote-unpublish")
    </property>
    <property as="xs:string"  name="oxf.fr.home.process.local-to-remote">
        xf:dispatch("confirm-local-to-remote")  then suspend then xf:dispatch("local-to-remote")
    </property>
    <property as="xs:string"  name="oxf.fr.home.process.remote-to-local">
        xf:dispatch("confirm-remote-to-local")  then suspend then xf:dispatch("remote-to-local")
    </property>
    <property as="xs:string"  name="oxf.fr.home.process.upgrade-local">
        xf:dispatch("confirm-local-upgrade")    then suspend then xf:dispatch("local-upgrade")
    </property>
    <property as="xs:string"  name="oxf.fr.home.process.upgrade-remote">
        xf:dispatch("confirm-remote-upgrade")   then suspend then xf:dispatch("remote-upgrade")
    </property>
    <property as="xs:string"  name="oxf.fr.home.process.confirmation-ok">
        resume
    </property>
    <property as="xs:string"  name="oxf.fr.home.process.confirmation-cancel">
        abort
    </property>

    <!-- ==== Internal Form Builder properties ==================================================================== -->

    <!-- In case somebody overrides with weaker properties -->
    <property as="xs:string"  name="oxf.fr.detail.label.appearance.orbeon.builder"        value="full"/>
    <property as="xs:string"  name="oxf.fr.detail.hint.appearance.orbeon.builder"         value="full"/>
    <property as="xs:string"  name="oxf.fr.persistence.provider.orbeon.builder.form"      value="resource"/>
    <property as="xs:string"  name="oxf.fr.detail.captcha.orbeon.builder"                 value=""/>

    <property as="xs:string"  name="oxf.xforms.assets.baseline.updates.fb">
        +/forms/orbeon/builder/resources/form-builder.css

        +/ops/dragula/dragula.min.js
        -/apps/fr/resources/scalajs/orbeon-form-runner-web.js
        +/forms/orbeon/builder/resources/scalajs/orbeon-form-builder.js
    </property>

</properties>
