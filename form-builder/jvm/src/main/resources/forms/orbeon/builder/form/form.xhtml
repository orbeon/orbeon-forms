<!--
  Copyright (C) 2010 Orbeon, Inc.

  This program is free software; you can redistribute it and/or modify it under the terms of the
  GNU Lesser General Public License as published by the Free Software Foundation; either version
  2.1 of the License, or (at your option) any later version.

  This program is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY;
  without even the implied warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.
  See the GNU Lesser General Public License for more details.

  The full text of the license is available at http://www.gnu.org/copyleft/lesser.html
  -->
<xh:html xmlns:xh="http://www.w3.org/1999/xhtml"
      xmlns:xf="http://www.w3.org/2002/xforms"
      xmlns:xs="http://www.w3.org/2001/XMLSchema"
      xmlns:ev="http://www.w3.org/2001/xml-events"
      xmlns:xi="http://www.w3.org/2001/XInclude"
      xmlns:xxi="http://orbeon.org/oxf/xml/xinclude"
      xmlns:xxf="http://orbeon.org/oxf/xml/xforms"
      xmlns:fr="http://orbeon.org/oxf/xml/form-runner"
      xmlns:fb="http://orbeon.org/oxf/xml/form-builder"
      xmlns:secure="java:org.orbeon.oxf.util.SecureUtils"
      xmlns:frf="java:org.orbeon.oxf.fr.FormRunner">
    <xh:head>
        <xi:include href="oxf:/apps/fr/includes/permissions-model.xml"      xxi:omit-xml-base="true"/>
        <xi:include href="oxf:/forms/orbeon/builder/form/model.xml"         xxi:omit-xml-base="true"/>
        <xi:include href="oxf:/forms/orbeon/builder/form/toolbox-model.xml" xxi:omit-xml-base="true"/>
        <xi:include href="oxf:/apps/fr/includes/versioning-model.xml"       xxi:omit-xml-base="true"/>
    </xh:head>
    <xh:body>

        <xh:div class="xforms-hidden">
            <!-- For the summary page -->
            <xf:output id="application-name-control" bind="application-name-bind" class="fr-summary fr-search">
                <xf:label ref="$form-resources/application-name/label"/>
            </xf:output>
            <xf:output id="form-name-control" bind="form-name-bind" class="fr-summary fr-search">
                <xf:label ref="$form-resources/form-name/label"/>
            </xf:output>
            <xf:output id="title-control" bind="title-bind" class="fr-summary fr-search">
                <xf:label ref="$form-resources/title/label"/>
            </xf:output>
            <xf:output id="description-control" bind="description-bind" class="fr-summary fr-search">
                <xf:label ref="$form-resources/description/label"/>
            </xf:output>
            <!-- Expose property -->
            <xf:output class="fb-tinymce-config" value="xxf:property('oxf.fb.tinymce.config')"/>
        </xh:div>

        <xh:div class="fb-navbar navbar navbar-fixed-top">
            <xh:div class="navbar-inner">
                <xh:div class="container">
                    <xh:span>
                        <xh:img src="/apps/fr/style/orbeon-navbar-logo.png" alt=""/>
                    </xh:span>
                    <xh:h1 class="brand">Form Builder</xh:h1>
                    <xh:ul class="nav">
                        <xh:li>
                            <xh:a tabindex="-1" href="http://doc.orbeon.com/form-builder/" target="_blank" rel="noopener">Form Builder User Guide</xh:a>
                        </xh:li>
                        <xh:li>
                            <fr:language-selector/>
                        </xh:li>
                    </xh:ul>
                </xh:div>
            </xh:div>
        </xh:div>

        <xh:div class="fb-bottom">

            <fr:status-icons/>
            <fr:messages/>

            <!-- XPath errors in edited form -->
            <xh:div class="fb-xpath-errors">
                <xf:output
                    class="alert"
                    ref="instance('fb-variables')/xpath-errors[xs:integer(.) gt 0]"
                    value="xxf:format-message($form-resources/messages/xpath-errors, xs:integer(.))"/>
            </xh:div>

            <xh:div class="fr-buttons">

                <xf:var
                    name="buttons-names"
                    value="xxf:split(xxf:property('oxf.fr.detail.buttons.orbeon.builder'))"/>

                <xf:repeat ref="$buttons-names">
                    <xf:var name="button-name" value="."/>
                    <xf:var name="primary"     value="position() = last()"/>

                    <xf:var
                        name="class"
                        value="
                            concat(
                                'xforms-trigger-appearance-xxforms-',
                                if ($primary) then
                                    'primary'
                                else
                                    'default'
                            )"/>

                    <fr:process-button
                        name="{$button-name}"
                        class="{$class}"
                        ref="xxf:instance('fb-triggers-instance')/other"/>

                </xf:repeat>

            </xh:div>
        </xh:div>

        <xi:include href="oxf:/forms/orbeon/builder/form/toolbox.xml" xxi:omit-xml-base="true"/>

        <xh:div class="fb-main">
            <xh:div class="fb-main-inner">
                <xh:div class="navbar navbar-inverse">
                    <xh:div class="navbar-inner">
                        <xh:div class="container">
                            <!-- Custom logo upload is removed in 4.0 -->
                            <xf:group
                                ref="
                                    xxf:trim(
                                        xxf:property(
                                            string-join(
                                                (
                                                    'oxf.fr.default-logo.uri',
                                                    bind('application-name-bind'),
                                                    bind('form-name-bind')
                                                ),
                                                '.'
                                            )
                                        )
                                    )[xxf:non-blank()]">
                                <xh:img src="{.}" alt=""/>
                            </xf:group>
                            <fr:title ref="bind('title-bind')"/>

                            <!-- Language selector -->
                            <xh:div class="fr-language-choice">
                                <xf:select1 id="fb-resources-language-select" ref="$fb-lang" appearance="bootstrap">
                                    <xf:itemset ref="$resources/resource">
                                        <xf:label value="xxf:instance('fr-languages-instance')/language[@code = context()/@xml:lang]/@native-name"/>
                                        <xf:value ref="@xml:lang"/>
                                    </xf:itemset>

                                    <!-- Force RRR when the value changes. The value change doesn't cause a rebuild, therefore the binds don't update. -->
                                    <xf:action ev:event="xforms-value-changed" model="fr-form-model">
                                        <xf:rebuild/>
                                        <xf:recalculate/>
                                        <xf:refresh/>
                                    </xf:action>

                                </xf:select1>
                            </xh:div>

                            <!-- Add/remove language -->
                            <xf:group class="fb-language-triggers" ref=".[fr:is-pe()]">
                                <xf:trigger appearance="minimal" id="fb-add-language">
                                    <xf:label><xh:i class="fa fa-plus-circle" title="{$form-resources/dialog-add-language/add-language/label}"/></xf:label>
                                    <xxf:show ev:event="DOMActivate" dialog="fb-add-language-dialog" neighbor="fb-resources-language-select"/>
                                </xf:trigger>
                                <xf:trigger appearance="minimal" id="fb-language-remove" ref=".[count($resources/resource) gt 1]">
                                    <xf:label><xh:i class="fa fa-minus-circle" title="{$form-resources/dialog-add-language/remove-language/label}"/></xf:label>
                                    <xf:action ev:event="DOMActivate">
                                        <!-- Ask confirmation -->
                                        <xxf:show dialog="fb-confirmation-dialog">
                                            <xf:property name="fr:message"
                                                             value="concat($form-resources/messages/delete-resources, ' ''',
                                                                         xxf:instance('fr-languages-instance')/language[@code = $fb-lang]/(if (@native-name != @english-name) then concat(@native-name, ' (', @english-name, ')') else @native-name),
                                                                         '''?')"/>
                                            <xf:property name="fr:confirmation-target" value="'fb-language-remove'"/>
                                        </xxf:show>
                                    </xf:action>
                                    <xf:action ev:event="fb-confirmation-yes">
                                        <!-- Delete resources for this language -->
                                        <xf:delete ref="$resources/resource[@xml:lang = $fb-lang]"/>
                                        <xf:delete ref="$metadata-instance/title[@xml:lang = $fb-lang]"/>
                                        <xf:delete ref="$metadata-instance/description[@xml:lang = $fb-lang]"/>
                                        <xf:delete ref="$metadata-instance/email/(subject | body)/template[@xml:lang = $fb-lang]"/>
                                        <xf:setvalue ref="$fb-lang" value="$resources/resource[1]/@xml:lang"/>

                                        <!-- Force RRR when the value changes. The value change doesn't cause a rebuild, therefore the binds don't update. -->
                                        <xf:rebuild/>
                                        <xf:recalculate/>
                                    </xf:action>
                                </xf:trigger>
                            </xf:group>
                        </xh:div>
                    </xh:div>
                </xh:div>

                <xf:var
                    name="is-page-layout-fluid"
                    value="
                        frf:optionFromMetadataOrPropertiesXPath(
                            bind('metadata-bind'),
                            'html-page-layout',
                            bind('application-name-bind'),
                            bind('form-name-bind'),
                            'edit'
                        ) = 'fluid'"/>

                <xh:div class="container{'-fluid'[$is-page-layout-fluid]}">

                    <xh:div class="row{'-fluid'[$is-page-layout-fluid]}">
                        <xh:div class="span12">

                        <!--
                            Form content. Set context on form instance and define this group as `#fr-form-group` as observers will refer to it.
                            NOTE: Use `fr-view-component` whenever possible instead since Orbeon Forms 2017.1.
                        -->
                        <xf:group id="fr-form-group" class="fr-body fr-border" model="fr-form-model" ref="instance('fr-form-instance')" xxf:element="div">
                            <xh:a name="fr-form"/>

                            <xf:var name="dialogs-closed" value="instance('fb-variables')/dialogs-open = 0"/>

                            <!-- Cut/copy/paste/undo/redo -->
                            <xf:dispatch if="$dialogs-closed" observer="#document" event="keydown" xxf:modifiers="ctrl"          xxf:text="x" name="DOMActivate" targetid="cut-trigger"/>
                            <xf:dispatch if="$dialogs-closed" observer="#document" event="keydown" xxf:modifiers="ctrl"          xxf:text="c" name="DOMActivate" targetid="copy-trigger"/>
                            <xf:dispatch if="$dialogs-closed" observer="#document" event="keydown" xxf:modifiers="ctrl"          xxf:text="v" name="DOMActivate" targetid="paste-trigger"/>

                            <xf:dispatch if="$dialogs-closed" observer="#document" event="keydown" xxf:modifiers="ctrl"          xxf:text="z" name="DOMActivate" targetid="undo-trigger"/>
                            <xf:dispatch if="$dialogs-closed" observer="#document" event="keydown" xxf:modifiers="ctrl"          xxf:text="y" name="DOMActivate" targetid="redo-trigger"/>

                            <xf:dispatch if="$dialogs-closed" observer="#document" event="keydown" xxf:modifiers="command"       xxf:text="x" name="DOMActivate" targetid="cut-trigger"/>
                            <xf:dispatch if="$dialogs-closed" observer="#document" event="keydown" xxf:modifiers="command"       xxf:text="c" name="DOMActivate" targetid="copy-trigger"/>
                            <xf:dispatch if="$dialogs-closed" observer="#document" event="keydown" xxf:modifiers="command"       xxf:text="v" name="DOMActivate" targetid="paste-trigger"/>

                            <xf:dispatch if="$dialogs-closed" observer="#document" event="keydown" xxf:modifiers="command"       xxf:text="z" name="DOMActivate" targetid="undo-trigger"/>
                            <xf:dispatch if="$dialogs-closed" observer="#document" event="keydown" xxf:modifiers="command shift" xxf:text="z" name="DOMActivate" targetid="redo-trigger"/>

                            <xf:action   if="$dialogs-closed" observer="#document" event="keydown" xxf:modifiers="ctrl"          xxf:text="j">
                                <xf:dispatch name="fb-show-dialog" targetid="dialog-search"/>
                            </xf:action>

                            <xf:action   if="$dialogs-closed" observer="#document" event="keydown" xxf:modifiers="command"       xxf:text="j">
                                <xf:dispatch name="fb-show-dialog" targetid="dialog-search"/>
                            </xf:action>

                            <!-- Buttons -->
                            <xf:action type="xpath" if="$dialogs-closed" observer="#document" event="keydown" xxf:modifiers="ctrl" xxf:text="s">
                                fr:run-process-by-name('oxf.fr.detail.process', 'save')
                            </xf:action>

                            <xf:action type="xpath" if="$dialogs-closed" observer="#document" event="keydown" xxf:modifiers="command" xxf:text="s">
                                fr:run-process-by-name('oxf.fr.detail.process', 'save')
                            </xf:action>

                            <!-- Cursor navigation -->
                            <xf:action
                                xmlns:fbf="java:org.orbeon.oxf.fb.FormBuilderXPathApi"
                                observer="#document"
                                event="keydown"
                                xxf:text="left"
                                if="$dialogs-closed"
                                type="xpath">

                                for $id in $current-td/*/@id
                                return
                                    for $name in frf:controlNameFromIdOpt($id)
                                    return
                                        for $prev in fbf:findNextControlId($name, 'previous')
                                        return
                                            fbf:selectCellForControlId($prev)
                            </xf:action>

                            <xf:action
                                xmlns:fbf="java:org.orbeon.oxf.fb.FormBuilderXPathApi"
                                observer="#document"
                                event="keydown"
                                xxf:text="right"
                                if="$dialogs-closed"
                                type="xpath">

                                for $id in $current-td/*/@id
                                return
                                    for $name in frf:controlNameFromIdOpt($id)
                                    return
                                        for $next in fbf:findNextControlId($name, 'next')
                                        return
                                            fbf:selectCellForControlId($next)
                            </xf:action>

<!--                            <xf:action type="xpath" if="$dialogs-closed" observer="#document" event="keydown" xxf:modifiers="command option" xxf:text="t">-->
<!--                                fr:run-process-by-name('oxf.fr.detail.process', 'test')-->
<!--                            </xf:action>-->

<!--                            <xf:action type="xpath" if="$dialogs-closed" observer="#document" event="keydown" xxf:modifiers="command option" xxf:text="p">-->
<!--                                fr:run-process-by-name('oxf.fr.detail.process', 'publish')-->
<!--                            </xf:action>-->

<!--                            <xf:action type="xpath" if="$dialogs-closed" observer="#document" event="keydown" xxf:modifiers="command option" xxf:text="n">-->
<!--                                fr:run-process-by-name('oxf.fr.detail.process', 'new')-->
<!--                            </xf:action>-->

<!--                            &lt;!&ndash; Open dialogs &ndash;&gt;-->
<!--                            <xxf:show if="$dialogs-closed" observer="#document" event="keypress" xxf:text="o s" dialog="dialog-edit-source"/>-->

<!--                            <xf:dispatch if="$dialogs-closed" observer="#document" event="keypress" xxf:text="o c" name="fb-show-dialog" targetid="dialog-control-settings">-->
<!--                                <xf:property name="control-id" value="$current-td/*/@id"/>-->
<!--                            </xf:dispatch>-->

<!--                            &lt;!&ndash; Structure &ndash;&gt;-->
<!--                            <xf:action-->
<!--                                xmlns:toolboxOps="java:org.orbeon.oxf.fb.ToolboxOps"-->
<!--                                if="$dialogs-closed"-->
<!--                                observer="#document"-->
<!--                                event="keypress"-->
<!--                                xxf:text="n s"-->
<!--                                type="xpath">-->
<!--                                toolboxOps:insertNewSection(true())-->
<!--                            </xf:action>-->

<!--                            <xf:action-->
<!--                                xmlns:toolboxOps="java:org.orbeon.oxf.fb.ToolboxOps"-->
<!--                                if="$dialogs-closed"-->
<!--                                observer="#document"-->
<!--                                event="keypress"-->
<!--                                xxf:text="n g"-->
<!--                                type="xpath">-->
<!--                                toolboxOps:insertNewGrid(false())-->
<!--                            </xf:action>-->

<!--                            &lt;!&ndash; Insert controls &ndash;&gt;-->
<!--                            <xf:action-->
<!--                                xmlns:toolboxOps="java:org.orbeon.oxf.fb.ToolboxOps"-->
<!--                                if="$dialogs-closed"-->
<!--                                observer="#document"-->
<!--                                event="keypress"-->
<!--                                xxf:text="n r"-->
<!--                                type="xpath">-->
<!--                                toolboxOps:insertNewGrid(true())-->
<!--                            </xf:action>-->

<!--                            <xf:action-->
<!--                                xmlns:toolboxOps="java:org.orbeon.oxf.fb.ToolboxOps"-->
<!--                                if="$dialogs-closed"-->
<!--                                observer="#document"-->
<!--                                event="keypress"-->
<!--                                xxf:text="i t f"-->
<!--                                type="xpath">-->
<!--                                toolboxOps:insertNewControl(xxf:instance('fb-components-instance')/xbl:xbl/xbl:binding[@id = 'fb-input'])-->
<!--                            </xf:action>-->

<!--                            <xf:action-->
<!--                                xmlns:toolboxOps="java:org.orbeon.oxf.fb.ToolboxOps"-->
<!--                                if="$dialogs-closed"-->
<!--                                observer="#document"-->
<!--                                event="keypress"-->
<!--                                xxf:text="i t a"-->
<!--                                type="xpath">-->
<!--                                toolboxOps:insertNewControl(xxf:instance('fb-components-instance')/xbl:xbl/xbl:binding[@id = 'fb-textarea'])-->
<!--                            </xf:action>-->

<!--                            <xf:action-->
<!--                                xmlns:toolboxOps="java:org.orbeon.oxf.fb.ToolboxOps"-->
<!--                                if="$dialogs-closed"-->
<!--                                observer="#document"-->
<!--                                event="keypress"-->
<!--                                xxf:text="i t h"-->
<!--                                type="xpath">-->
<!--                                toolboxOps:insertNewControl(xxf:instance('fb-components-instance')/xbl:xbl/xbl:binding[@id = 'fr-tinymce'])-->
<!--                            </xf:action>-->

<!--                            <xf:action-->
<!--                                xmlns:toolboxOps="java:org.orbeon.oxf.fb.ToolboxOps"-->
<!--                                if="$dialogs-closed"-->
<!--                                observer="#document"-->
<!--                                event="keypress"-->
<!--                                xxf:text="i u e"-->
<!--                                type="xpath">-->
<!--                                toolboxOps:insertNewControl(xxf:instance('fb-components-instance')/xbl:xbl/xbl:binding[@id = 'fr-explanation'])-->
<!--                            </xf:action>-->

<!--                            <xf:action-->
<!--                                xmlns:toolboxOps="java:org.orbeon.oxf.fb.ToolboxOps"-->
<!--                                if="$dialogs-closed"-->
<!--                                observer="#document"-->
<!--                                event="keypress"-->
<!--                                xxf:text="i u c"-->
<!--                                type="xpath">-->
<!--                                toolboxOps:insertNewControl(xxf:instance('fb-components-instance')/xbl:xbl/xbl:binding[@id = 'fb-output'])-->
<!--                            </xf:action>-->

<!--                            <xf:action-->
<!--                                xmlns:toolboxOps="java:org.orbeon.oxf.fb.ToolboxOps"-->
<!--                                if="$dialogs-closed"-->
<!--                                observer="#document"-->
<!--                                event="keypress"-->
<!--                                xxf:text="i u h"-->
<!--                                type="xpath">-->
<!--                                toolboxOps:insertNewControl(xxf:instance('fb-components-instance')/xbl:xbl/xbl:binding[@id = 'fr-hidden'])-->
<!--                            </xf:action>-->

<!--                            <xf:action-->
<!--                                xmlns:toolboxOps="java:org.orbeon.oxf.fb.ToolboxOps"-->
<!--                                if="$dialogs-closed"-->
<!--                                observer="#document"-->
<!--                                event="keypress"-->
<!--                                xxf:text="i t n"-->
<!--                                type="xpath">-->
<!--                                toolboxOps:insertNewControl(xxf:instance('fb-components-instance')/xbl:xbl/xbl:binding[@id = 'fr-number' and contains(@element, 'fr|number')])-->
<!--                            </xf:action>-->

<!--                            <xf:action-->
<!--                                xmlns:toolboxOps="java:org.orbeon.oxf.fb.ToolboxOps"-->
<!--                                if="$dialogs-closed"-->
<!--                                observer="#document"-->
<!--                                event="keypress"-->
<!--                                xxf:text="i t c"-->
<!--                                type="xpath">-->
<!--                                toolboxOps:insertNewControl(xxf:instance('fb-components-instance')/xbl:xbl/xbl:binding[@id = 'fr-number' and contains(@element, 'fr|currency')])-->
<!--                            </xf:action>-->

<!--                            <xf:action-->
<!--                                xmlns:toolboxOps="java:org.orbeon.oxf.fb.ToolboxOps"-->
<!--                                if="$dialogs-closed"-->
<!--                                observer="#document"-->
<!--                                event="keypress"-->
<!--                                xxf:text="i d d"-->
<!--                                type="xpath">-->
<!--                                toolboxOps:insertNewControl(xxf:instance('fb-components-instance')/xbl:xbl/xbl:binding[@id = 'fr-date'])-->
<!--                            </xf:action>-->

<!--                            <xf:action-->
<!--                                xmlns:toolboxOps="java:org.orbeon.oxf.fb.ToolboxOps"-->
<!--                                if="$dialogs-closed"-->
<!--                                observer="#document"-->
<!--                                event="keypress"-->
<!--                                xxf:text="i d t"-->
<!--                                type="xpath">-->
<!--                                toolboxOps:insertNewControl(xxf:instance('fb-components-instance')/xbl:xbl/xbl:binding[@id = 'fr-time'])-->
<!--                            </xf:action>-->

<!--                            <xf:action-->
<!--                                xmlns:toolboxOps="java:org.orbeon.oxf.fb.ToolboxOps"-->
<!--                                if="$dialogs-closed"-->
<!--                                observer="#document"-->
<!--                                event="keypress"-->
<!--                                xxf:text="i s m"-->
<!--                                type="xpath">-->
<!--                                toolboxOps:insertNewControl(xxf:instance('fb-components-instance')/xbl:xbl/xbl:binding[@id = 'fr-dropdown-select1'])-->
<!--                            </xf:action>-->

<!--                            <xf:action-->
<!--                                xmlns:toolboxOps="java:org.orbeon.oxf.fb.ToolboxOps"-->
<!--                                if="$dialogs-closed"-->
<!--                                observer="#document"-->
<!--                                event="keypress"-->
<!--                                xxf:text="i s r"-->
<!--                                type="xpath">-->
<!--                                toolboxOps:insertNewControl(xxf:instance('fb-components-instance')/xbl:xbl/xbl:binding[@id = 'fb-input-select1-full'])-->
<!--                            </xf:action>-->

<!--                            <xf:action-->
<!--                                xmlns:toolboxOps="java:org.orbeon.oxf.fb.ToolboxOps"-->
<!--                                if="$dialogs-closed"-->
<!--                                observer="#document"-->
<!--                                event="keypress"-->
<!--                                xxf:text="i s c"-->
<!--                                type="xpath">-->
<!--                                toolboxOps:insertNewControl(xxf:instance('fb-components-instance')/xbl:xbl/xbl:binding[@id = 'fb-input-select-full'])-->
<!--                            </xf:action>-->

<!--                            &lt;!&ndash; TODO: move containers &ndash;&gt;-->

<!--                            &lt;!&ndash; TODO: cursor navigation &ndash;&gt;-->
<!--                            &lt;!&ndash;<xf:message observer="#document" event="keypress" xxf:text="left"/>&ndash;&gt;-->
<!--                            &lt;!&ndash;<xf:message observer="#document" event="keypress" xxf:text="right"/>&ndash;&gt;-->
<!--                            &lt;!&ndash;<xf:message observer="#document" event="keypress" xxf:text="up"/>&ndash;&gt;-->
<!--                            &lt;!&ndash;<xf:message observer="#document" event="keypress" xxf:text="down"/>&ndash;&gt;-->

                            <!-- IE warning -->
                            <xf:group ref=".[fr:mode() != 'new' and xxf:instance('fb-user-agent-instance')/is-supported-browser = 'false']">
                                <xf:switch>
                                    <xf:case id="fb-ie-warning-case-on">
                                        <!-- TODO: i18n -->
                                        <xh:div class="fb-ie-warning alert alert-error">
                                            It appears that you are using
                                            <xf:output value="xxf:instance('fb-user-agent-instance')/browser-name"/>.
                                            Form Builder is likely not working properly with this browser. We recommend you upgrade to
                                            <xf:output
                                                xmlns:BrowserVersion="java:org.orbeon.builder.BrowserVersion"
                                                value="BrowserVersion:MinimalMicrosoftBrowserNameAndVersion()"/>
                                            or newer, or use
                                            <a href="http://www.google.com/chrome">Google Chrome</a>,
                                            <a href="http://www.mozilla.com/firefox/">Firefox</a>,
                                            or
                                            <a href="http://www.apple.com/safari/">Safari</a>.
                                            If we made a mistake and you are not using
                                            <xf:output value="xxf:instance('fb-user-agent-instance')/browser-name"/>,
                                            please
                                            <a href="mailto:info@orbeon.com?subject=Form Builder Microsoft Browser Version">let us know</a>.

                                            <xf:trigger appearance="minimal">
                                                <xf:label>[close]</xf:label>
                                                <xf:toggle ev:event="DOMActivate" case="fb-ie-warning-case-off"/>
                                            </xf:trigger>
                                        </xh:div>
                                    </xf:case>
                                    <xf:case id="fb-ie-warning-case-off"/>
                                </xf:switch>
                            </xf:group>


                            <!-- Some common form edition functions -->
                            <xf:group ref="instance('fb-form-instance')" appearance="xxf:internal">

                                <!-- Don't let any event go out from within this group -->
                                <!-- Q: Do we still need this? -->
                                <xf:action ev:event="#all" ev:propagate="stop"/>

                                <!-- Form settings dialog -->
                                <fb:dialog-form-settings
                                    id="dialog-form-settings"
                                    resources-ref="$form-resources"
                                    fr-resources-ref="$fr-resources"
                                    body-ref="$body">

                                    <!-- Update title/description -->
                                    <xf:action ev:event="fb-update-metadata">
                                        <xf:setvalue ref="bind('title-bind')"       value="event('title')"/>
                                        <xf:setvalue ref="bind('description-bind')" value="event('description')"/>

                                        <xf:delete ref="bind('description-bind')/@mediatype"/>
                                        <xf:insert
                                            if="event('description-mediatype') = 'text/html'"
                                            context="bind('description-bind')"
                                            origin="xf:attribute('mediatype', 'text/html')"/>

                                        <!-- Add/remove singleton setting as needed -->
                                        <xf:delete
                                            bind="singleton-bind"/>
                                        <xf:insert
                                            if="event('singleton') = 'true'"
                                            context="bind('metadata-bind')"
                                            ref="*"
                                            origin="xf:element('singleton', event('singleton'))"/>

                                        <!-- Add/remove wizard setting as needed -->
                                        <xf:delete
                                            bind="wizard-bind"/>
                                        <xf:insert
                                            if="event('wizard') = ('true', 'false')"
                                            context="bind('metadata-bind')"
                                            ref="*"
                                            origin="xf:element('wizard', event('wizard'))"/>

                                        <!-- Add/remove wizard mode setting as needed -->
                                        <xf:delete
                                            bind="wizard-mode-bind"/>
                                        <xf:insert
                                            if="event('wizard-mode') = ('free', 'lax', 'strict')"
                                            context="bind('metadata-bind')"
                                            ref="*"
                                            origin="xf:element('wizard-mode', event('wizard-mode'))"/>

                                        <xf:delete
                                            bind="wizard-subsections-nav-bind"/>
                                        <xf:insert
                                            if="event('wizard-subsections-nav') = ('true', 'false')"
                                            context="bind('metadata-bind')"
                                            ref="*"
                                            origin="xf:element('wizard-subsections-nav', event('wizard-subsections-nav'))"/>

                                        <xf:delete
                                            bind="wizard-subsections-toc-bind"/>
                                        <xf:insert
                                            if="event('wizard-subsections-toc') = ('active', 'all', 'none')"
                                            context="bind('metadata-bind')"
                                            ref="*"
                                            origin="xf:element('wizard-subsections-toc', event('wizard-subsections-toc'))"/>

                                        <!-- Add/remove XForms properties as needed -->
                                        <xf:delete
                                            bind="attachment-max-size-bind"/>
                                        <xf:insert
                                            if="event('attachment-max-size') castable as xs:integer and
                                                xs:integer(event('attachment-max-size')) ge 0"
                                            context="bind('fb-form-model-bind')"
                                            origin="xf:attribute('xxf:upload.max-size', event('attachment-max-size'))"/>

                                        <xf:delete
                                            bind="attachment-max-size-aggregate-bind"/>
                                        <xf:insert
                                            if="event('attachment-max-size-aggregate') castable as xs:integer and
                                                xs:integer(event('attachment-max-size-aggregate')) ge 0"
                                            context="bind('fb-form-model-bind')"
                                            origin="xf:attribute('xxf:upload.max-size-aggregate', event('attachment-max-size-aggregate'))"/>

                                        <xf:delete
                                            bind="attachment-mediatypes-bind"/>
                                        <xf:insert
                                            if="xxf:non-blank(event('attachment-mediatypes'))"
                                            context="bind('fb-form-model-bind')"
                                            origin="xf:attribute('xxf:upload.mediatypes', event('attachment-mediatypes'))"/>

                                        <xf:delete
                                            bind="labels-bind"/>
                                        <xf:insert
                                            if="exists(event('labels'))"
                                            context="bind('fb-form-model-bind')"
                                            origin="xf:attribute('xxf:label.appearance', event('labels'))"/>

                                        <xf:delete
                                            bind="hints-bind"/>
                                        <xf:insert
                                            if="exists(event('hints'))"
                                            context="bind('fb-form-model-bind')"
                                            origin="xf:attribute('xxf:hint.appearance', event('hints'))"/>

                                        <xf:delete
                                            bind="data-migration-bind"/>
                                        <xf:insert
                                            if="event('data-migration') = ('enabled', 'disabled', 'error')"
                                            context="bind('metadata-bind')"
                                            ref="*"
                                            origin="xf:element('data-migration', event('data-migration'))"/>

                                        <xf:action iterate="'rendered-page-orientation', 'rendered-page-size', 'html-page-layout'">
                                            <xf:var name="n" value="."/>
                                            <xf:delete
                                                ref="bind(concat($n, '-bind'))"/>
                                            <xf:insert
                                                if="not(event($n) = 'default')"
                                                context="bind('metadata-bind')"
                                                ref="*"
                                                origin="xf:element($n, event($n))"/>
                                        </xf:action>

                                        <xf:action iterate="'relevant', 'readonly'" type="xpath" xmlns:fbf="java:org.orbeon.oxf.fb.FormBuilderXPathApi">
                                            fbf:writeAndNormalizeCalculatedMip((), ., event(.))
                                        </xf:action>

                                        <xf:delete
                                            bind="analysis-calculate-bind"/>
                                        <xf:insert
                                            if="event('analysis-calculate') = ('true', 'false')"
                                            context="bind('fb-form-model-bind')"
                                            origin="xf:attribute('xxf:analysis.calculate', event('analysis-calculate'))"/>

                                        <xf:delete
                                            bind="xbl-bind"/>
                                        <xf:insert
                                            if="exists(event('xbl')/@*)"
                                            context="bind('metadata-bind')"
                                            ref="*"
                                            origin="xf:element('xbl', event('xbl')[exists(@*)])"/>

                                    </xf:action>
                                    <!-- Update app/form name if changed -->
                                    <xf:action
                                            ev:event="fb-update-metadata"
                                            if="bind('application-name-bind') != event('app') or bind('form-name-bind') != event('form')">

                                        <!-- Copy data to main instance -->
                                        <xf:setvalue ref="bind('application-name-bind')" value="event('app')"/>
                                        <xf:setvalue ref="bind('form-name-bind')"        value="event('form')"/>

                                        <!-- Refresh components -->
                                        <xf:dispatch name="fb-load-toolbox-action" targetid="fb-toolbox-model">
                                            <xf:property name="deannotate" value="true()"/>
                                        </xf:dispatch>
                                    </xf:action>
                                    <!-- "Save as" -->
                                    <xf:action
                                            ev:event="fb-update-metadata"
                                            if="event('mode') = 'save-as'">
                                        <!-- Create new document id -->
                                        <xf:setvalue
                                            ref="xxf:instance('fr-parameters-instance')/document"
                                            value="secure:randomHexId()"/>
                                        <!-- Actually save -->
                                        <xf:action type="xpath">
                                            fr:run-process-by-name('oxf.fr.detail.process', 'save')
                                        </xf:action>
                                        <!-- Change URL to have new document id -->
                                        <xf:action type="javascript">
                                            <xf:param name="documentId" value="fr:document-id()"/>
                                            <xf:body>ORBEON.builder.private.API.updateLocationDocumentId(documentId)</xf:body>
                                        </xf:action>
                                    </xf:action>
                                </fb:dialog-form-settings>

                                <fb:dialog-email-settings
                                    id="dialog-email-settings"
                                    resources-ref="$form-resources"
                                    fr-resources-ref="$fr-resources"
                                    body-ref="$body">

                                    <xf:action ev:event="fb-update">
                                        <xf:delete
                                            bind="email-bind"/>
                                        <xf:insert
                                            if="exists(event('email'))"
                                            context="bind('metadata-bind')"
                                            ref="*"
                                            origin="event('email')"/>
                                    </xf:action>

                                </fb:dialog-email-settings>

                                <!-- Other dialogs -->
                                <xf:var name="form" value="."/>

                                <fb:dialog-control-settings   id="dialog-control-settings"   ref="$form"      resources-ref="$form-resources"/>
                                <fb:dialog-container-settings id="dialog-container-settings" ref="$form"      resources-ref="$form-resources"/>
                                <fb:dialog-itemsets           id="dialog-itemsets"                            resources-ref="$form-resources"/>
                                <fb:dialog-edit-source        id="dialog-edit-source"        ref="$form"      resources-ref="$form-resources"/>
                                <fb:dialog-http-services      id="dialog-http-services"      ref="$form"      resources-ref="$form-resources"/>
                                <fb:dialog-ids                id="dialog-ids"                ref="$form"      resources-ref="$form-resources"/>

                                <fb:dialog-search             id="dialog-search"             ref="$form"      resources-ref="$form-resources">
                                    <xf:action
                                        xmlns:fbf="java:org.orbeon.oxf.fb.FormBuilderXPathApi"
                                        event="fb-apply"
                                        if="xxf:non-blank(event('control-name'))">

                                        <xf:dispatch
                                            iterate="
                                                for $elem in reverse(
                                                    frf:findAncestorSectionsLeafToRoot(
                                                        fbf:findControlByNameOrEmpty(event('control-name')),
                                                        false()
                                                    )
                                                )
                                                return $elem/@id"
                                            name="fr-expand"
                                            targetid="{concat('|fbâ‰¡', ., '|')}"/>

                                        <xf:action type="xpath">fbf:selectCellForControlId(concat(event('control-name'), '-control'))</xf:action>
                                    </xf:action>
                                </fb:dialog-search>

                                <fb:dialog-pdf                id="dialog-pdf"                ref="$form"      resources-ref="$form-resources">
                                    <xf:action ev:event="fb-apply">
                                        <xf:delete bind="pdf-attachments-bind"/>
                                        <xf:insert
                                            context="bind('attachments-bind')"
                                            ref="*"
                                            origin="event('pdf-attachments')"/>
                                    </xf:action>
                                </fb:dialog-pdf>

                                <xf:group bind="fb-toolbox-workflow-bind">
                                    <fb:workflow20201
                                        id="fb-workflow20201-dialog"
                                        resources-ref="$form-resources"
                                        ref="frf:metadataInstanceRootOpt(xxf:instance('fb-form-instance'))"/>
                                </xf:group>
                                <xf:group bind="fb-toolbox-permissions-bind">
                                    <fb:permissions
                                        id="fb-permissions-dialog"
                                        resources-ref="$form-resources"
                                        metadata-ref="frf:metadataInstanceRootOpt(xxf:instance('fb-form-instance'))"/>
                                </xf:group>

                                <xf:action event="fr-save" observer="dialog-edit-source">
                                    <xf:dispatch targetid="fr-form-model" name="fr-annotate-data">
                                        <xf:property name="data" value="event('value')"/>
                                    </xf:dispatch>
                                </xf:action>

                                <fr:alert-dialog id="dialog-confirmation">
                                    <fr:label ref="$form-resources/dialog-confirmation/label"/>
                                    <fr:negative-choice><fr:label value="$fr-resources/buttons/no"  mediatype="text/html"/></fr:negative-choice>
                                    <fr:positive-choice><fr:label value="$fr-resources/buttons/yes" mediatype="text/html"/></fr:positive-choice>
                                </fr:alert-dialog>

                                <xf:action event="fb-request-delete-http-service" observer="dialog-http-services">

                                    <xf:var
                                        name="impacted-actions"
                                        value="
                                            count(
                                                $model/fb:action[
                                                    ends-with(@id, '-binding')
                                                ]//xf:send/@submission[
                                                    . = concat(event('service-name'), '-submission')
                                                ]
                                            )
                                            +
                                            count(
                                                $model/fr:action//fr:service-call/@service[
                                                    . = event('service-name')
                                                ]
                                            )"/>
                                    <xf:dispatch name="fr-show" targetid="dialog-confirmation">
                                        <xf:property
                                            name="message"
                                            value="
                                                xxf:format-message(
                                                    $form-resources/messages/delete-service,
                                                    (
                                                        event('service-name'), (: service name              :)
                                                        $impacted-actions      (: count of impacted actions :)
                                                    )
                                                )"/>
                                        <xf:property
                                            name="positive-targetid"
                                            value="xxf:absolute-id('dialog-http-services')"/>
                                    </xf:dispatch>
                                </xf:action>

                                <xf:action event="fr-positive" observer="dialog-http-services">
                                    <xf:dispatch name="fb-confirm-delete-http-service" targetid="dialog-http-services"/>
                                </xf:action>

                            </xf:group>

                            <xf:group class="fb fb-hide-alert">
                                <!-- Dynamically display the form being edited -->
                                <xxf:dynamic id="fb" ref="instance('fb-form-instance')"/>
                                <!--<fr:xforms-inspector/>-->

                                <xf:action event="xxforms-action-error" observer="#document fb" propagate="stop">
                                    <xf:message level="xxf:log-error" value="concat('Error: ', xxf:trim(event('message')))"/>
                                    <xf:message level="xxf:log-error" value="event('element')"/>
                                </xf:action>

                            </xf:group>

                            <xf:var name="fb-resources"  value="xxf:get-variable('fr-resources-model', 'fr-form-resources')"/>

                            <xh:div class="fb-messages">
                                <!-- Resources for control resources editors -->
                                <xf:output class="fb-message-lhha-checkbox" ref="$form-resources/messages/lhha-checkbox"/>
                                <xf:output class="fb-message-enter-label"   ref="$form-resources/enter-label/label"/>
                                <xf:output class="fb-message-type-label"    ref="$form-resources/type-label/label"/>
                                <xf:output class="fb-message-enter-hint"    ref="$form-resources/enter-hint/label"/>
                                <xf:output class="fb-message-type-hint"     ref="$form-resources/type-hint/label"/>
                                <xf:output class="fb-message-enter-text"    ref="$form-resources/enter-text/label"/>
                                <xf:output class="fb-message-type-text"     ref="$form-resources/type-text/label"/>
                            </xh:div>

                            <!-- Editors -->
                            <!-- NOTE: This needs to be after the xxf:dynamic as the shared upload control use xxf:binding() to get the
                                       binding of the current node, which only works if the control exists -->

                            <xh:div class="fb-control-editor-left">
                                <xh:i
                                    class="fb-x-merge fa fa-long-arrow-right fa-fw"
                                    role="button"
                                    title="{$fb-resources/merge-right-icon/label}"/>
                                <xh:i
                                    class="fb-x-split fa fa-unlink fa-fw"
                                    role="button"
                                    title="{$fb-resources/split-horizontally-icon/label}"/>
                                <xh:i
                                    class="fb-y-merge fa fa-long-arrow-down fa-fw"
                                    role="button"
                                    title="{$fb-resources/merge-below-icon/label}"/>
                                <xh:i
                                    class="fb-y-split fa fa-unlink fa-fw"
                                    role="button"
                                    title="{$fb-resources/split-vertically-icon/label}"/>
                            </xh:div>

                            <xh:div class="fb-control-editor-right">
                                <xh:i
                                    class="fb-control-handle fa fa-arrows fa-fw"
                                    draggable="true"
                                    title="{$fb-resources/move-icon/label}"/>
                                <xh:i
                                    class="fb-control-edit-details fa fa-cogs fa-fw"
                                    role="button"
                                    title="{$fb-resources/control-settings-icon/label}"/>
                                <xh:i
                                    class="fb-control-delete fa fa-minus-circle fa-fw"
                                    role="button"
                                    title="{$fb-resources/delete-control-icon/label}"/>
                                <xh:i
                                    class="fb-control-edit-items fa fa-th-list fa-fw"
                                    role="button"
                                    title="{$fb-resources/edit-items/label}"/>

                                <!-- Used by the button/link editor, see the placeholders.coffee which uses a state machine -->
                                <!--<xf:group ref=".[exists($control/xf:label/@ref)]" appearance="xxf:internal">-->
                                    <!--<xf:input xxf:autocomplete="off" id="fb-edit-label" class="fb-edit-label" ref="$current-resources/*[name() = frf:controlNameFromId($control-id)]/label">-->
                                        <!--<xf:label appearance="minimal" ref="$form-resources/type-label/label"/>-->
                                    <!--</xf:input>-->
                                <!--</xf:group>-->

                            </xh:div>

                            <xh:div class="fb-section-grid-editor">
                                <xf:output class="fb-enter-section-title-label xforms-hidden" ref="$form-resources/enter-section-title/label"/>
                                <xf:output class="fb-type-section-title-label xforms-hidden"  ref="$form-resources/type-section-title/label"/>
                                <xh:i
                                    class="fb-container-edit-details fa fa-cogs fa-fw"
                                    role="button"
                                    title="{$fb-resources/section-details-icon/label}"/>
                                <xh:i
                                    class="fb-container-delete fa fa-minus-circle fa-fw"
                                    role="button"
                                    title="{$fb-resources/delete-container-icon/label}"/>
                                <xh:i
                                    class="fb-container-move-up fa fa-arrow-up fa-fw"
                                    role="button"
                                    title="{$fb-resources/move-up-icon/label}"/>
                                <xh:i
                                    class="fb-container-move-down fa fa-arrow-down fa-fw"
                                    role="button"
                                    title="{$fb-resources/move-down-icon/label}"/>
                                <xh:i
                                    class="fb-container-move-right fa fa-arrow-right fa-fw"
                                    role="button"
                                    title="{$fb-resources/move-right-icon/label}"/>
                                <xh:i
                                    class="fb-container-move-left fa fa-arrow-left fa-fw"
                                    role="button"
                                    title="{$fb-resources/move-left-icon/label}"/>
                                <xh:i
                                    class="fb-container-cut fa fa-cut fa-fw"
                                    role="button"
                                    title="{$fb-resources/cut/label}"/>
                                <xh:i
                                    class="fb-container-copy fa fa-copy fa-fw"
                                    role="button"
                                    title="{$fb-resources/copy/label}"/>
                                <!-- MAYBE: Paste icon if allowed? -->
                                <xh:i
                                    class="fb-container-merge fa fa-share-alt fa-fw"
                                    role="button"
                                    title="{$fb-resources/merge-section/label}"/>
                            </xh:div>

                            <xh:div class="fb-row-editor">
                                <!-- Insert row above -->
                                <xh:i
                                    class="fb-row-insert-above fa fa-chevron-up fa-fw"
                                    role="button"
                                    title="{$fb-resources/insert-row-above-icon/label}"/>
                                <!-- Delete row -->
                                <xh:i
                                    class="fb-row-delete fa fa-minus-circle fa-fw"
                                    role="button"
                                    title="{$fb-resources/delete-row-icon/label}"/>
                                <!-- Insert row below -->
                                <xh:i
                                    class="fb-row-insert-below fa fa-chevron-down fa-fw"
                                    role="button"
                                    title="{$fb-resources/insert-row-below-icon/label}"/>
                            </xh:div>

                        </xf:group>
                        </xh:div>
                    </xh:div>
                </xh:div>
            </xh:div>
        </xh:div>

        <fr:dialogs>
            <xi:include href="oxf:/forms/orbeon/builder/form/dialog-language.xml" xxi:omit-xml-base="true"/>
            <xi:include href="oxf:/forms/orbeon/builder/form/dialog-publish.xml" xxi:omit-xml-base="true"/>
            <xi:include href="oxf:/forms/orbeon/builder/form/dialog-schema.xml" xxi:omit-xml-base="true"/>
            <xi:include href="oxf:/forms/orbeon/builder/form/dialog-actions.xml" xxi:omit-xml-base="true"/>
            <xi:include href="oxf:/forms/orbeon/builder/form/dialog-database-service.xml" xxi:omit-xml-base="true"/>
            <xi:include href="oxf:/forms/orbeon/builder/form/dialog-confirmation.xml" xxi:omit-xml-base="true"/>
            <xi:include href="oxf:/forms/orbeon/builder/form/dialog-test.xml" xxi:omit-xml-base="true"/>
        </fr:dialogs>
    </xh:body>
</xh:html>
