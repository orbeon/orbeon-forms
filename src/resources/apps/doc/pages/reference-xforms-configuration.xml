<?xml version="1.0" encoding="windows-1252"?>
<!--
  Copyright (C) 2010 Orbeon, Inc.

  This program is free software; you can redistribute it and/or modify it under the terms of the
  GNU Lesser General Public License as published by the Free Software Foundation; either version
  2.1 of the License, or (at your option) any later version.

  This program is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY;
  without even the implied warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.
  See the GNU Lesser General Public License for more details.

  The full text of the license is available at http://www.gnu.org/copyleft/lesser.html
  -->
<document xmlns:p="http://www.orbeon.com/oxf/pipeline"
          xmlns:xforms="http://www.w3.org/2002/xforms"
          xmlns:xxforms="http://orbeon.org/oxf/xml/xforms"
          xmlns:xsl="http://www.w3.org/1999/XSL/Transform"
          xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
          xmlns:xhtml="http://www.w3.org/1999/xhtml"
          xmlns:ev="http://www.w3.org/2001/xml-events"
          xmlns:xi="http://www.w3.org/2001/XInclude" >
    <header>
        <title>XForms Reference: XForms Engine Configuration</title>
    </header>
    <body>
        <section>
            <title>Introduction</title>
            <p>
                This part of the XForms reference documentation focuses on XForms engine configuration.
            </p>
        </section>
        <a name="xforms-state-handling"/>
        <section>
            <title>State Handling</title>
            <a name="state-handling-rationale"/>
            <section>
                <title>Rationale</title>
                <p>
                    The Orbeon Forms XForms engine requires keeping processing state while operating on an XForms page.
                    Such state includes the current values of XForms instances, selected repeated elements, and more.
                    With Orbeon Forms, XForms state information can be handled in one of two ways:
                </p>
                <ul>
                    <li>
                        <p>
                            <b>Server-side:</b> in this case, state information is stored on the server. Only very
                            little state information circulates between client and server. The most frequently used
                            state information is stored in memory. Less frequently used state information is stored
                            on disk in a local database.
                        </p>
                        <p>
                            Benefits of the approach:
                        </p>
                        <ul>
                            <li>
                                <p>
                                    Resulting HTML page are smaller. HTML pages increase in size as more XForms
                                    controls are used, but they don't increase in size proportionally to the size of
                                    XForms instances.
                                </p>
                            </li>
                            <li>
                                <p>
                                    Small amounts of data circulate between the client browser and the Orbeon Forms
                                    XForms server.
                                </p>
                            </li>
                            <li>
                                <p>
                                    This means that very large XForms instances can be processed without any impact
                                    on the amount of data that is transmitted between the client and the server.
                                </p>
                            </li>
                        </ul>
                        <p>
                            Drawbacks of the approach:
                        </p>
                        <ul>
                            <li>
                                <p>
                                    The Orbeon Forms XForms server needs to be stateful. It uses server memory to
                                    store state information even when no request is being processed. This creates
                                    additional demand for resources on the server and slightly complicates the task
                                    of tuning the server.
                                </p>
                            </li>
                            <li>
                                <p>
                                    State information can become unavailable when sessions expire or when the server
                                    is restarted. When state information becomes unavailable for a page, that page
                                    will no longer function unless it is reloaded.
                                </p>
                            </li>
                        </ul>
                        <note>
                            Orbeon Forms ensures that it is possible to open multiple client browser windows
                            showing the same page within the same session.
                        </note>
                    </li>
                    <li>
                        <p>
                            <b>Client-side:</b> in this case, static initial state information is sent along with the
                            initial HTML page, and dynamic state is exchanged over the wire between the client browser
                            and the Orbeon Forms XForms server when necessary.
                        </p>
                        <p>
                            Benefits of the approach:
                        </p>
                        <ul>
                            <li>
                                <p>
                                    The Orbeon Forms server is entirely stateless. It only requires memory while
                                    processing a client request. It can be restarted without consequence for the XForms
                                    engine.
                                </p>
                            </li>
                            <li>
                                <p>
                                    State information does not expire as long as the user keeps the
                                    application page open in the web browser.
                                </p>
                            </li>
                        </ul>
                        <p>
                            Drawbacks of the approach:
                        </p>
                        <ul>
                            <li>
                                <p>
                                    Resulting HTML pages are larger. In particular, the size of state data grows
                                    when XForms instances grow, regardless of whether many XForms controls are
                                    bound to instance data.
                                </p>
                            </li>
                            <li>
                                <p>
                                    More data circulates between the client browser and the Orbeon Forms XForms server.
                                </p>
                            </li>
                        </ul>
                        <note>
                            Orbeon Forms compresses and encrypts XForms state information sent to the client.
                        </note>
                    </li>
                </ul>
                <p>
                    By default, Orbeon forms store XForms state information on the server. Please change this
                    default to client-side only if you have well understood the tradeoffs explained above.
                </p>
            </section>
            <a name="state-handling-configuration"/>
            <section>
                <title>Configuring State Handling</title>
                <p>
                    State handling can be configured globally for all pages, or locally for each individual page
                    served. Global configuration is performed in <code>properties.xml</code> with the
                    <code>oxf.xforms.state-handling</code> property. When missing or set to <code>client</code>,
                    state is stored client-side. When set to <code>server</code>, state is stored server-side. For
                    example:
                </p>
                <xml-source>
                    <comment> Store state on the server </comment>
                    <property as="xs:string" name="oxf.xforms.state-handling" value="server"/>
                </xml-source>
                <p>
                    The global configuration can be overridden for each page by setting the
                    <code>xxforms:state-handling</code> attribute in the page. This attribute can be set  on the
                    root element of the XHTML page, or on the first <code>xforms:model</code> element. Only the
                    first such attribute encountered by the XForms engine is used:
                </p>
                <xml-source show-namespaces="false">
                    <xforms:model xxforms:state-handling="client">
                        ...
                    </xforms:model>
                </xml-source>
                <p>
                    When storing state on the server, the maximum size of the data to be stored globally in memory
                    can be selected using the <code>oxf.xforms.store.application.size</code> property. The size is
                    specified in bytes:
                </p>
                <xml-source>
                    <comment> Allow a maximum of 20 MB of state information among all users </comment>
                    <property as="xs:integer" name="oxf.xforms.store.application.size"               value="20000000"/>
                </xml-source>
                <p>
                    When the allowed memory space for state information is full, Orbeon passivates state information
                    to a local eXist database. Configuration parameters for the connection to the eXist database
                    can be changed. The defaults are as follows:
                </p>
                <xml-source>
                    <comment> Disk-based store connection information </comment>
                    <property as="xs:string"  name="oxf.xforms.store.application.username"           value="guest"/>
                    <property as="xs:string"  name="oxf.xforms.store.application.password"           value="guest"/>
                    <property as="xs:anyURI"  name="oxf.xforms.store.application.uri"                value="xmldb:exist:///"/>
                    <property as="xs:string"  name="oxf.xforms.store.application.collection"         value="/db/orbeon/xforms/cache/"/>
                </xml-source>
                <p>
                    Whether state information is kept client-side or server-side, a property controls whether the XForms
                    engine should try to optimize state reconstruction by using a cache. This property should usually
                    be set to <code>true</code>:
                </p>
                <xml-source>
                    <comment> This should usually be set to "true" </comment>
                    <property as="xs:boolean" name="oxf.xforms.cache.document"                       value="true"/>
                </xml-source>
                <p>
                    If the above property is set to <code>true</code>, the number of XForms documents that can be
                    held in that document cache at a given time is configured with the following property:
                </p>
                <xml-source>
                    <comment> Store at most 10 documents in the cache </comment>
                    <property as="xs:integer" name="oxf.xforms.cache.documents.size"                 value="10"/>
                </xml-source>
                <p>
                    Note that this represents XForms documents in a particular state of interaction with a user,
                    which means that if to users load the same XForms page two entries will be needed in the cache.
                </p>
            </section>
            <a name="session-heartbeat"/>
            <section added="2008-03-01">
                <title>Session Heartbeat</title>
                <p>
                    If you happen to leave a browser window open on your computer, chances are that you will get
                    back to that window and keep using the application. The last thing you want to happen when you
                    come back is lose your session and therefore your data.
                </p>
                <p>
                    This is not always a correct guess of course: you may just happen to leave a window or tab open
                    without planning to use it again. Conversely you may have a page which is not actually visible,
                    for example in your browser history, yet you will come back to it. This approach wouldn’t be
                    good for banking applications either. Still, in many situations, such as filling-out large
                    forms, it sounds like a good idea to keep your session alive for open pages.
                </p>
                <p>
                    To achieve this goal you could make all server sessions longer. However this is harder to
                    configure for the application developer, and this won’t discriminate between pages that are
                    actually open on a client and the ones that are not. And while it may be ideal to have
                    infinitely long sessions, unfortunately many applications are not ready for this kind of
                    approach.
                </p>
                <p>
                    So Orbeon Forms supports a "session heartbeat" feature. Here is how this works:
                </p>
                <ul>
                    <li>
                        <p>
                            When this feature is enabled (the default), an open XForms page in a client browser
                            regularly pings the server through Ajax to keep the current server session alive.
                        </p>
                    </li>
                    <li>
                        <p>
                            The ping delay is automatically computed based on the server’s session timeout. The
                            client pings the server at 80% of the session expiration time after the last interaction
                            with the server.
                        </p>
                    </li>
                    <li>
                        <p>
                            We are careful not to hit the XForms engine too much, in fact we do a very limited
                            amount of work on the server for each ping, so they should run fast.
                        </p>
                    </li>
                    <li>
                        <p>
                            XForms state information for pages hit with the heartbeat just migrates to the <a
                            href="#state-handling-configuration">disk store</a> over time if RAM is used by other
                            pages, so keeping even large numbers of pages open should not have any negative impact
                            on server RAM.
                        </p>
                    </li>
                    <li>
                        <p>
                            When a user gets back to using the page, state information migrates back from disk to
                            RAM, and the page will be live again.
                        </p>
                    </li>
                    <li>
                        <p>
                            Sessions do eventually expire as nobody keeps a browser open forever.
                        </p>
                    </li>
                </ul>
                <p>
                    Note that whenever an application keeps sessions alive for a long time, it is a good idea to
                    keep as little data as possible in the session. The Orbeon Forms XForms engine itself uses a <a
                    href="#state-handling-configuration">global state store</a> and does not use session objects
                    for storage, but do remember to keep your sessions small!
                </p>
                <p>
                    The session heartbeat should help prevent many occurrences of "session expired" error messages.
                    As an Orbeon Forms application developer you don’t have to worry about anything: the session
                    heartbeat is enabled by default. You can configure it globally in <code>properties.xml</code>:
                </p>
                <xml-source>
                    <property as="xs:boolean" name="oxf.xforms.session-heartbeat" value="true"/>
                </xml-source>
                <p>
                    You can also override the global default by specifying a property on the first XForms model of a
                    page:
                </p>
                <xml-source>
                    <xforms:model id="my-model" xxforms:session-heartbeat="false"/>
                </xml-source>
            </section>
        </section>
        <a name="local-submissions"/>
        <section>
            <title>Local Submissions</title>
            <a name="local-submissions-rationale"/>
            <section>
                <title>Rationale</title>
                <p>
                    XForms pages can make heavy use of services through the use of <code>&lt;xforms:submission></code>.
                    A service is primarily identified by a URL.
                </p>
                <ul>
                    <li>
                        <p>
                            Sometimes a service is remote (on a machine other than the machine on which Orbeon Forms is
                            installed), in which case the URL is necessarily an absolute URL starting with
                            <code>http://</code> or <code>https://</code>.
                        </p>
                    </li>
                    <li>
                        <p>
                            But often services are implemented within Orbeon Forms itself, not only on the same server
                            but within the same web application. In the case of such local submission, Orbeon Forms
                            provides a special optimized mode which has the following benefits:
                        </p>
                        <ul>
                            <li>
                                <p>
                                    No actual HTTP connection is initiated, so performance is likely to be better.
                                </p>
                            </li>
                            <li>
                                <p>
                                    There is no need to deal with absolute URLs such as
                                    <code>http://localhost:8080</code>, especially when proxies or firewalls are in
                                    place.
                                </p>
                            </li>
                        </ul>
                    </li>
                </ul>
                <p>
                    For more information, see also the <a
                    href="http://wiki.orbeon.com/forms/doc/developer-guide/configuration-properties#TOC-Submission">Configuration
                    Properties</a> related to submissions.
                </p>
            </section>
            <a name="local-submissions-enabling"/>
            <section>
                <title>Enabling Local Submissions</title>
                <p>
                    Orbeon Forms performs a local submission if:
                </p>
                <ul>
                    <li>
                        <p>
                            The URL specified is not a absolute, i.e. does not start with <code>http://</code> or
                            <code>https://</code>.
                        </p>
                    </li>
                    <li>
                        <p>
                            The submission is not asynchronous. (This restriction may be lifted in the future.)
                        </p>
                    </li>
                    <li>
                        <p>
                            In a servlet environment:
                        </p>
                        <ul>
                            <li>
                                <p>
                                    The submission has <code>replace="all"</code> (which is the default if no
                                    <code>replace</code> attribute is specified) and the
                                    <code>oxf.xforms.local-submission-forward</code> property is set to
                                    <code>true</code> (which is the default).
                                </p>
                            </li>
                            <li>
                                <p>
                                    The submission has <code>replace="instance"</code>, <code>replace="text"</code> or
                                    <code>replace="none"</code> and the
                                    <code>oxf.xforms.local-submission-include</code> property is set to
                                    <code>true</code> (the default is <code>false</code>).
                                </p>
                            </li>
                        </ul>
                    </li>
                    <li>
                        <p>
                            In a portlet environment:
                        </p>
                        <ul>
                            <li>
                                <p>
                                    The <code>f:url-norewrite</code> attribute is not set to <code>true</code>.
                                </p>
                            </li>
                            <li>
                                <p>
                                    The <code>f:url-type</code> attribute is not set to <code>resource</code>.
                                </p>
                            </li>
                        </ul>
                        <note>
                            The portlet logic above is likely to be revised in the future. Also note that in the case of
                            optimized submissions within portlets, requests are made directly to the Orbeon Forms
                            portlet and do not use servlet forward/include.
                        </note>
                    </li>
                </ul>
            </section>
            <a name="local-submissions-context"/>
            <section>
                <title>Context Resolution</title>
                <p>
                    In a servlet environment, paths are resolved as follows:
                </p>
                <ul>
                    <li>
                        <p>
                            If <code>f:url-norewrite</code> is not set to <code>true</code>, the resource is resolved
                            against the current servlet context.
                        </p>
                    </li>
                    <li>
                        <p>
                            If <code>f:url-norewrite</code> is set to <code>true</code>, the resource is resolved
                            against the servlet container root. This allows accessing other web applications within the
                            same servlet container.
                        </p>
                    </li>
                </ul>
                <p>
                    Say your application is under context <code>/orbeon</code>, and you have a second web application
                    under context <code>/foo</code>:
                </p>
                <xml-source xmlns:f="http://orbeon.org/oxf/xml/formatting">
                    <comment> This submission calls /orbeon/bar </comment>
                    <xforms:submission replace="all" method="post" resource="/bar"/>
                    <comment> This submission calls /foo/bar </comment>
                    <xforms:submission replace="all" method="post" resource="/foo/bar" f:url-norewrite="true"/>
                </xml-source>
            </section>
            <a name="local-submissions-includes"/>
            <section>
                <title>Limitations of Includes</title>
                <p>
                    With <code>replace="instance"</code>, <code>replace="text"</code> or <code>replace="none"</code>,
                    optimized submission are implemented using the servlet container's include mechanism, which does not
                    automatically build path information for the included resource.
                </p>
                <p>
                    In this case, Orbeon Forms is therefore unable to provide proper "servlet path" and "path info"
                    information. Orbeon Forms handles this situation in the following way:
                </p>
                <ul>
                    <li>
                        <p>
                            A blank (<code>""</code>) "servlet path" is provided.
                        </p>
                    </li>
                    <li>
                        <p>
                            The "path info" contains the entire path provided, instead of the path following the servlet
                            path.
                        </p>
                    </li>
                </ul>
                <p>
                   This may cause some application which rely on the "servlet path" information to behave incorrectly.
                   For example, consider the eXist REST servlet:
                </p>
                <ul>
                    <li>
                        <p>
                            It is mounted as <code>/exist/rest</code> within Orbeon Forms.
                        </p>
                    </li>
                    <li>
                        <p>
                            eXist (quite properly) expects any path following <code>/exist/rest</code> to be a path
                            into the database, e.g. <code>/exist/rest/db/orbeon</code> produces a path called
                            <code>/db/orbeon</code>.
                        </p>
                    </li>
                    <li>
                        <p>
                            If Orbeon Forms calls the eXist REST servlet with a blank servlet path and a path info
                            containing <code>/exist/rest/db/orbeon</code>, eXist obviously obtains an incorrect database
                            path.
                        </p>
                    </li>
                </ul>
                <warning>
                   In short you must be careful when using local includes. The good news is that if you are using
                   servlets which do not depend on path information as explained above, or if you have control over the
                   implementation of the services you are calling, then you can most likely work around this limitation.
                </warning>
                <p>
                   Local forwards are not subject to that limitation.
                </p>
            </section>
        </section>
        <a name="xforms-resources"/>
        <section>
            <title>JavaScript and CSS Resources</title>
            <p>
                This section has <a href="http://wiki.orbeon.com/forms/doc/developer-guide/xforms-javascript-css-resources">moved to the Orbeon Forms wiki</a>.
            </p>
        </section>
        <a name="xforms-back-forward"/>
        <section>
            <title>Browser Navigation (Back and Forward) Handling</title>
            <p>
                When visiting an XForms page by using your browser's Back and Forward buttons, or other
                browser-history mechanisms, Orbeon Forms by default restores the appearance of that page as it was
                when you left it. (Browsers don't automatically handle this behavior with Ajax applications!) This
                behavior best matches the usual user experience obtained when navigating regular web pages.
            </p>
            <p>
                In certain situations, it can be useful instead to ask the XForms page to reload entirely. You
                control this by using the <code>xxforms:revisit-handling</code> attribute on the first XForms model
                of the page you want to reload. This attribute supports two values: <code>restore</code> (the
                default) and <code>reload</code>. Example:
            </p>
            <xml-source>
                <xforms:model xxforms:revisit-handling="reload"/>
            </xml-source>
            <note>
                It is recommended to use the <code>reload</code> value carefully, as reloading pages upon browser
                navigation often does not match the expectation of the user.
            </note>
        </section>
        <section>
            <title>Encryption</title>
            <p>
                Orbeon Forms encrypt some information sent to the client (for example when using client-side state
                state handling). This is done through the following property in <code>properties.xml</code>:
            </p>
            <xml-source>
                <property as="xs:string" name="oxf.xforms.password" value="REPLACE THIS WITH YOUR OWN PASSWORD"/>
            </xml-source>
            <warning>
                <p>
                    It is strongly advised to change the default password in the property above.
                </p>
            </warning>
            <p>
                In addition, Orbeon Forms by default encrypts the value of selection controls before sending them to
                the client. This can be controlled with this property:
            </p>
            <xml-source>
                <property as="xs:boolean" name="oxf.xforms.encrypt-item-values" value="true"/>
            </xml-source>
            <p>
                In general, this should be set to <code>true</code>, but you can set it to <code>false</code> if you
                need to access the value of selection controls through JavaScript on the client, or through offline
                binds.
            </p>
        </section>
        <a name="xforms-debugging"/>
        <section>
            <title>Debugging XForms Pages</title>
            <a name="xforms-logging"/>
            <section added="2006-10-21">
                <title>Enabling XForms Logging</title>
                <p>
                    This section has <a href="http://wiki.orbeon.com/forms/doc/developer-guide/xforms-logging">moved to the Orbeon Forms wiki</a>.
                </p>
            </section>
        </section>
    </body>
</document>
