<!--
  Copyright (C) 2018 Orbeon, Inc.

  This program is free software; you can redistribute it and/or modify it under the terms of the
  GNU Lesser General Public License as published by the Free Software Foundation; either version
  2.1 of the License, or (at your option) any later version.

  This program is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY;
  without even the implied warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.
  See the GNU Lesser General Public License for more details.

  The full text of the license is available at http://www.gnu.org/copyleft/lesser.html
  -->
<group
    xmlns:xs="http://www.w3.org/2001/XMLSchema"
    xmlns:xh="http://www.w3.org/1999/xhtml"
    xmlns:oxf="http://www.orbeon.com/oxf/processors"
    xmlns:xf="http://www.w3.org/2002/xforms"
    xmlns:xxf="http://orbeon.org/oxf/xml/xforms"
    xmlns:fr="http://orbeon.org/oxf/xml/form-runner"
    xmlns:saxon="http://saxon.sf.net/"

    description="Form Runner Actions"
>

    <test description="For #3803: Basic flattening of actions" name="oxf:unsafe-xslt">
        <input name="config" href="test-actions.xsl"/>
        <input name="data">
            <xh:html>
                <xh:head>
                    <xf:model id="fr-form-model">

                        <fr:listener
                            version="2018.2"

                            modes="new"
                            events="enabled value-changed activated"
                            controls="my-control"

                            actions="my-action"/>

                        <fr:listener
                            version="2018.2"

                            events="form-load-after-controls"

                            actions="my-action other-action"/>

                        <fr:action name="my-action" version="2018.2">

                            <fr:control-setvalue value="'before'" control="control-before"/>

                            <fr:service-call service="my-service-gaga">
                                <fr:value     control="control1" ref="/request/control1"/>
                                <fr:value     control="control2" ref="/request/control2"/>
                                <fr:url-param control="control3" name="param3"/>
                            </fr:service-call>

                            <fr:control-setvalue value="/response/foo" control="control-foo"/>
                            <fr:control-setvalue value="/response/bar" control="control-bar"/>

                            <fr:service-call service="my-service-toto">
                                <fr:value     control="control4"     ref="/request/control4"/>
                                <fr:url-param control="control5"     name="param5"/>
                                <fr:sql-param control="control6"     index="2"/>
                                <fr:value     value="current-date()" ref="/request/value7"/>
                            </fr:service-call>

                            <fr:control-setvalue value="'after'" control="control-after"/>
                            <fr:dataset-write name="my-dataset"/>

                            <fr:if condition="true()">
                                <fr:control-setvalue value="'in-if'" control="control-in-if"/>
                            </fr:if>

                            <fr:repeat-clear repeat="my-grid"/>

                            <fr:data-iterate ref="/response/row">
                                <fr:repeat-add-iteration repeat="my-grid" at="end"/>
                                <fr:control-setvalue value="name" control="my-name" at="end"/>
                                <fr:control-setitems items="item" label="@label" value="@value" control="my-dropdown" at="end"/>

                                <fr:control-setattachment control="my-attachment" at="end"/>
                                <fr:control-setfilename   control="my-attachment" at="end" value="'My Image.png'"/>
                                <fr:control-setmediatype  control="my-attachment" at="end" value="'image/png'"/>
                            </fr:data-iterate>

                            <fr:repeat-remove-iteration repeat="my-grid" at="start"/>

                            <fr:data-iterate ref="/response/row[exists(foo)]">

                                <fr:process-call scope="oxf.fr.detail.process" name="acme-process"/>

                                <fr:service-call service="my-service-get-attachment">
                                    <fr:url-param name="my-attachment-id" value="foo"/>
                                </fr:service-call>

                                <fr:repeat-add-iteration repeat="my-grid" at="end"/>
                                <fr:control-setattachment control="my-attachment" at="end"/>
                            </fr:data-iterate>

                            <fr:process-call scope="oxf.fr.detail.process" name="summary"/>
                            <fr:navigate location="https://www.bbc.com/news"/>
                            <fr:navigate location="https://www.bbc.com/news" target="_blank"/>

                        </fr:action>
                    </xf:model>
                </xh:head>
                <xh:body xmlns:fb="http://orbeon.org/oxf/xml/form-builder">
                    <fr:view>
                        <fr:body>
                            <fr:section id="my-section-section" bind="my-section-bind">
                                <xf:label ref="$form-resources/my-section/label"/>
                                <fr:grid id="my-grid-grid" bind="my-grid-bind" repeat="content" min="1"
                                         template="instance('my-grid-template')"
                                         apply-defaults="true"
                                         fb:initial-iterations="first">
                                    <fr:c y="1" x="1" w="6"/>
                                    <fr:c y="1" x="7" w="6"/>
                                </fr:grid>
                            </fr:section>
                        </fr:body>
                    </fr:view>
                </xh:body>
            </xh:html>
        </input>
        <output name="data">
            <xf:model id="fr-form-model">

                <xf:action
                    observer="my-control-control"
                    target="#observer"
                    event="xforms-enabled xforms-value-changed DOMActivate"
                    if="fr:mode() = ('new')">
                    <xf:dispatch name="fr-call-user-my-action-action" targetid="fr-form-model">
                        <xf:property name="action-source" value="event('xxf:absolute-targetid')"/>
                    </xf:dispatch>
                </xf:action>

                <xf:action
                    target="fr-form-model"
                    event="fr-run-form-load-action-after-controls">

                    <xf:dispatch name="fr-call-user-my-action-action"    targetid="fr-form-model">
                        <xf:property name="action-source" value="event('xxf:absolute-targetid')"/>
                    </xf:dispatch>
                    <xf:dispatch name="fr-call-user-other-action-action" targetid="fr-form-model">
                        <xf:property name="action-source" value="event('xxf:absolute-targetid')"/>
                    </xf:dispatch>
                </xf:action>

                <xf:action
                    id="my-action-binding"
                    event="fr-call-user-my-action-action"
                    target="fr-form-model">

                    <xf:action type="xpath">
                        xxf:set-request-attribute('fr-action-source', event('action-source')),
                        xxf:set-request-attribute('fr-action-error', false()),
                        for $i in 1 to 10 return xxf:set-request-attribute(concat('fr-action-continuation-is-last-iteration-', $i), ()),
                        for $i in 1 to 10 return xxf:set-request-attribute(concat('fr-iteration-context-', $i), ())
                    </xf:action>

                    <xf:action>
                        <xf:var name="value" value="'before'"/>
                        <xf:rebuild/>
                        <xf:recalculate/>
                        <xf:action iterate="frf:resolveTargetRelativeToActionSource(xxf:get-request-attribute('fr-action-source'), 'control-before', true())">
                           <xf:setvalue ref="." value="$value"/>
                       </xf:action>
                    </xf:action>
                    <xf:insert
                        ref="xxf:instance('fr-service-request-instance')"
                        origin="saxon:parse(xxf:instance('my-service-gaga-instance'))"/>
                    <xf:action context="xxf:instance('fr-service-request-instance')">
                        <xf:action>
                            <xf:var
                                name="value"
                                value="frf:resolveTargetRelativeToActionSource(xxf:get-request-attribute('fr-action-source'), 'control1', true())"/>
                            <xf:setvalue
                                ref="/request/control1"
                                value="$value"/>
                        </xf:action>
                        <xf:action>
                            <xf:var
                                name="value"
                                value="frf:resolveTargetRelativeToActionSource(xxf:get-request-attribute('fr-action-source'), 'control2', true())"/>
                            <xf:setvalue
                                ref="/request/control2"
                                value="$value"/>
                        </xf:action>
                        <xf:action>
                            <xf:var
                                name="value"
                                value="frf:resolveTargetRelativeToActionSource(xxf:get-request-attribute('fr-action-source'), 'control3', true())"/>
                            <xf:setvalue
                                ref="/*/param3"
                                value="$value"/>
                        </xf:action>
                    </xf:action>
                    <xf:action type="xpath">xxf:set-request-attribute('fr-action-continuation-id', 'my-action-2-id')</xf:action>
                    <xf:insert ref="xxf:instance('fr-service-response-instance')" origin="xf:element('response')"/>
                    <xf:send submission="my-service-gaga-submission"/>
                </xf:action>
                <xf:action
                    observer="my-service-gaga-submission"
                    event="xforms-submit-done"
                    context="xxf:instance('fr-service-response-instance')"
                    if="xxf:get-request-attribute('fr-action-continuation-id') = 'my-action-2-id'">
                    <xf:action>
                        <xf:var name="value" value="/response/foo"/>
                        <xf:rebuild/>
                        <xf:recalculate/>
                        <xf:action iterate="frf:resolveTargetRelativeToActionSource(xxf:get-request-attribute('fr-action-source'), 'control-foo', true())">
                           <xf:setvalue ref="." value="$value"/>
                       </xf:action>
                    </xf:action>
                    <xf:action>
                        <xf:var name="value" value="/response/bar"/>
                        <xf:rebuild/>
                        <xf:recalculate/>
                        <xf:action iterate="frf:resolveTargetRelativeToActionSource(xxf:get-request-attribute('fr-action-source'), 'control-bar', true())">
                           <xf:setvalue ref="." value="$value"/>
                       </xf:action>
                    </xf:action>
                    <xf:insert
                        ref="xxf:instance('fr-service-request-instance')"
                        origin="saxon:parse(xxf:instance('my-service-toto-instance'))"/>
                    <xf:var
                        name="original-context"
                        value="."/>
                    <xf:action context="xxf:instance('fr-service-request-instance')">
                        <xf:action>
                            <xf:var
                                name="value"
                                value="frf:resolveTargetRelativeToActionSource(xxf:get-request-attribute('fr-action-source'), 'control4', true())"/>
                            <xf:setvalue
                                ref="/request/control4"
                                value="$value"/>
                        </xf:action>
                        <xf:action>
                            <xf:var
                                name="value"
                                value="frf:resolveTargetRelativeToActionSource(xxf:get-request-attribute('fr-action-source'), 'control5', true())"/>
                            <xf:setvalue
                                ref="/*/param5"
                                value="$value"/>
                        </xf:action>
                        <xf:action>
                            <xf:var
                                name="value"
                                value="frf:resolveTargetRelativeToActionSource(xxf:get-request-attribute('fr-action-source'), 'control6', true())"/>
                            <xf:setvalue
                                xmlns:sql="http://orbeon.org/oxf/xml/sql"
                                ref="/sql:config/sql:query/sql:param[2]/(@value | @select)[1]"
                                value="
                                        concat(
                                            '''',
                                            replace(
                                                string(
                                                    $value
                                                ),
                                                '''',
                                                ''''''
                                            ),
                                            ''''
                                        )"/>
                        </xf:action>
                        <xf:action>
                            <xf:var
                                name="value"
                                context="$original-context"
                                value="current-date()"/>

                            <xf:setvalue
                                ref="/request/value7"
                                value="$value"/>
                        </xf:action>
                    </xf:action>
                    <xf:action type="xpath">xxf:set-request-attribute('fr-action-continuation-id', 'my-action-3-id')</xf:action>
                    <xf:insert ref="xxf:instance('fr-service-response-instance')" origin="xf:element('response')"/>
                    <xf:send submission="my-service-toto-submission"/>
                </xf:action>
                <xf:action
                    observer="my-service-toto-submission"
                    event="xforms-submit-done"
                    context="xxf:instance('fr-service-response-instance')"
                    if="xxf:get-request-attribute('fr-action-continuation-id') = 'my-action-3-id'">
                    <xf:action>
                        <xf:var name="value" value="'after'"/>
                        <xf:rebuild/>
                        <xf:recalculate/>
                        <xf:action iterate="frf:resolveTargetRelativeToActionSource(xxf:get-request-attribute('fr-action-source'), 'control-after', true())">
                           <xf:setvalue ref="." value="$value"/>
                       </xf:action>
                    </xf:action>
                    <xf:action>
                        <xf:var name="value" value="."/>
                        <xf:insert
                            context="xxf:instance('fr-service-response-instance')"
                            ref="instance('fr-dataset-my-dataset')"
                            origin="$value"/>
                    </xf:action>

                    <xf:var name="cond1" value="true()"/>
                    <xf:action if="$cond1">
                        <xf:action>
                            <xf:var name="value" value="'in-if'"/>
                            <xf:rebuild/>
                            <xf:recalculate/>
                            <xf:action iterate="frf:resolveTargetRelativeToActionSource(xxf:get-request-attribute('fr-action-source'), 'control-in-if', true())">
                                <xf:setvalue ref="." value="$value"/>
                            </xf:action>
                        </xf:action>
                        <xf:dispatch name="fr-action-continuation-my-action-4-id" targetid="fr-form-model"/>
                    </xf:action>
                    <xf:action if="not($cond1)">
                        <xf:dispatch name="fr-action-continuation-my-action-4-id" targetid="fr-form-model"/>
                    </xf:action>

               </xf:action>
               <xf:action observer="fr-form-model" event="fr-action-continuation-my-action-4-id" context="xxf:instance('fr-service-response-instance')">
                    <xf:action type="xpath">frf:repeatClear('my-section false none my-grid true none')</xf:action>
                    <xf:action if="empty(/response/row)">
                        <xf:dispatch name="fr-action-continuation-my-action-5-id" targetid="fr-form-model"/>
                    </xf:action>
                    <xf:action iterate="/response/row">
                        <xf:action if="not(xxf:get-request-attribute('fr-action-error') = true())">
                            <xf:action type="xpath">xxf:set-request-attribute('fr-action-continuation-is-last-iteration-1', position() = last())</xf:action>
                            <xf:action type="xpath">xxf:set-request-attribute('fr-iteration-context-1', .)</xf:action>
                            <xf:action type="xpath">frf:repeatAddIteration('my-section false none my-grid true end', true())</xf:action>
                            <xf:action>
                                <xf:var name="value" value="name"/>
                                <xf:rebuild/>
                                <xf:recalculate/>
                                <xf:action iterate="frf:resolveTargetRelativeToActionSourceFromBinds('fr-form-model', 'my-name')[last()]">
                                   <xf:setvalue ref="." value="$value"/>
                               </xf:action>
                            </xf:action>
                            <xf:action>

                                <xf:rebuild/>
                                <xf:recalculate/>

                                <xf:var
                                    xmlns:secure="java:org.orbeon.oxf.util.SecureUtils"
                                    name="new-itemset-id"
                                    value="concat('fr', secure:randomHexId())"/>

                                <xf:var
                                    name="new-itemset-holder"
                                    value="xf:element('itemset', xf:attribute('id', $new-itemset-id))"/>

                                <xf:var
                                    name="items-expr-context"
                                    value="."/>

                                <xf:action iterate="xxf:instance('fr-form-resources')/resource">

                                    <xf:var name="fr-lang" value="@xml:lang"/>

                                    <xf:var
                                        name="response-items"
                                        context="$items-expr-context"
                                        value="item"/>

                                    <xf:insert
                                        context="$new-itemset-holder"
                                        ref="*"
                                        origin="xf:element('choices')"/>

                                    <xf:var
                                        name="new-choices-holder"
                                        value="$new-itemset-holder/choices[last()]"/>

                                    <xf:action iterate="$response-items">
                                        <xf:var name="item-label" value="@label"/>
                                        <xf:var name="item-value" value="@value"/>
                                        <xf:insert
                                            context="$new-choices-holder"
                                            ref="*"
                                            origin="xf:element('item', (xf:element('label', xs:string($item-label)), xf:element('value', xs:string($item-value))))"/>
                                    </xf:action>
                                </xf:action>

                                <xf:dispatch name="fr-call-itemset-action" targetid="fr-form-instance">
                                    <xf:property name="control-name"       value="'my-dropdown'"/>
                                    <xf:property name="new-itemset-id"     value="$new-itemset-id"/>
                                    <xf:property name="new-itemset-holder" value="$new-itemset-holder"/>
                                    <xf:property name="at"                 value="'end'"/>
                                </xf:dispatch>

                            </xf:action>
                            <xf:action>
                                <xf:var name="value" value="xxf:instance('fr-service-response-instance')/string()"/>
                                <xf:var name="mediatype" value="uri-param-values($value, 'mediatype')[1]"/>
                                <xf:var name="size"      value="uri-param-values($value, 'size')[1]"/>
                                <xf:rebuild/>
                                <xf:recalculate/>
                                <xf:action iterate="frf:resolveTargetRelativeToActionSourceFromBinds('fr-form-model', 'my-attachment')[last()]">
                                    <xf:setvalue ref="image, ." value="$value"/>
                                    <xf:setvalue ref="image/@mediatype, ./@mediatype" value="$mediatype"/>
                                    <xf:setvalue ref="image/@size, ./@size" value="$size"/>
                                </xf:action>
                            </xf:action>
                            <xf:action>
                                <xf:var name="value" value="'My Image.png'"/>
                                <xf:rebuild/>
                                <xf:recalculate/>
                                <xf:action iterate="frf:resolveTargetRelativeToActionSourceFromBinds('fr-form-model', 'my-attachment')[last()]">
                                    <xf:setvalue ref="@filename" value="$value"/>
                                </xf:action>
                            </xf:action>
                            <xf:action>
                                 <xf:var name="value" value="'image/png'"/>
                                 <xf:rebuild/>
                                 <xf:recalculate/>
                                 <xf:action iterate="frf:resolveTargetRelativeToActionSourceFromBinds('fr-form-model', 'my-attachment')[last()]">
                                     <xf:setvalue ref="image/@mediatype, ./@mediatype" value="$value"/>
                                 </xf:action>
                            </xf:action>
                            <xf:dispatch
                                if="xxf:get-request-attribute('fr-action-continuation-is-last-iteration-1') = true()"
                                name="fr-action-continuation-my-action-5-id"
                                targetid="fr-form-model"/>
                        </xf:action>
                    </xf:action>
                </xf:action>
                <xf:action observer="fr-form-model" event="fr-action-continuation-my-action-5-id"  context="xxf:instance('fr-service-response-instance')">
                    <xf:action type="xpath">frf:repeatRemoveIteration('my-section false none my-grid true start')</xf:action>
                    <xf:action if="empty(/response/row[exists(foo)])">
                        <xf:dispatch name="fr-action-continuation-my-action-7-id" targetid="fr-form-model"/>
                    </xf:action>
                    <xf:action iterate="/response/row[exists(foo)]">
                        <xf:action if="not(xxf:get-request-attribute('fr-action-error') = true())">

                            <xf:action type="xpath">xxf:set-request-attribute('fr-action-continuation-is-last-iteration-1', position() = last())</xf:action>
                            <xf:action type="xpath">xxf:set-request-attribute('fr-iteration-context-1', .)</xf:action>

                            <xf:action xmlns:process="java:org.orbeon.oxf.fr.process.SimpleProcess" type="xpath">
                                process:runProcessByName('oxf.fr.detail.process', 'acme-process')
                            </xf:action>

                            <xf:insert
                                ref="xxf:instance('fr-service-request-instance')"
                                origin="saxon:parse(xxf:instance('my-service-get-attachment-instance'))"/>

                            <xf:var name="original-context" value="."/>
                            <xf:action context="xxf:instance('fr-service-request-instance')">
                                <xf:action>
                                    <xf:var name="value" context="$original-context" value="foo"/>
                                    <xf:setvalue ref="/*/my-attachment-id" value="$value"/>
                                </xf:action>
                            </xf:action>
                            <xf:action type="xpath">xxf:set-request-attribute('fr-action-continuation-id', 'my-action-6-id')</xf:action>
                            <xf:insert ref="xxf:instance('fr-service-response-instance')" origin="xf:element('response')"/>
                            <xf:send submission="my-service-get-attachment-submission"/>
                        </xf:action>
                   </xf:action>
                </xf:action>
                <xf:action observer="my-service-get-attachment-submission" event="xforms-submit-done" context="xxf:instance('fr-service-response-instance')" if="xxf:get-request-attribute('fr-action-continuation-id') = 'my-action-6-id'">
                <xf:action type="xpath">frf:repeatAddIteration('my-section false none my-grid true end', true())</xf:action>
                    <xf:action>
                        <xf:var name="value" value="xxf:instance('fr-service-response-instance')/string()"/>
                        <xf:var name="mediatype" value="uri-param-values($value, 'mediatype')[1]"/>
                        <xf:var name="size"      value="uri-param-values($value, 'size')[1]"/>
                        <xf:rebuild/>
                        <xf:recalculate/>
                        <xf:action iterate="frf:resolveTargetRelativeToActionSourceFromBinds('fr-form-model', 'my-attachment')[last()]">
                            <xf:setvalue ref="image, ." value="$value"/>
                            <xf:setvalue ref="image/@mediatype, ./@mediatype" value="$mediatype"/>
                            <xf:setvalue ref="image/@size, ./@size" value="$size"/>
                        </xf:action>
                    </xf:action>
                    <xf:dispatch
                        if="xxf:get-request-attribute('fr-action-continuation-is-last-iteration-1') = true()"
                        name="fr-action-continuation-my-action-7-id"
                        targetid="fr-form-model"/>
                </xf:action>
                <xf:action
                    observer="fr-form-model"
                    event="fr-action-continuation-my-action-7-id"
                    context="xxf:instance('fr-service-response-instance')">

                     <xf:action type="xpath" xmlns:process="java:org.orbeon.oxf.fr.process.SimpleProcess">
                         process:runProcessByName('oxf.fr.detail.process', 'summary')
                     </xf:action>

                     <xf:action type="xpath" xmlns:process="java:org.orbeon.oxf.fr.process.SimpleProcess">
                         process:runProcess('navigate(uri = ''https://www.bbc.com/news'')')
                     </xf:action>

                     <xf:action type="xpath" xmlns:process="java:org.orbeon.oxf.fr.process.SimpleProcess">
                         process:runProcess('navigate(uri = ''https://www.bbc.com/news'', target = ''_blank'')')
                     </xf:action>
                </xf:action>
                <xf:action
                    xmlns:frf="java:org.orbeon.oxf.fr.FormRunner"
                    xmlns:process="java:org.orbeon.oxf.fr.process.SimpleProcess"
                    event="xforms-submit-error"
                    observer="my-service-gaga-submission my-service-toto-submission my-service-get-attachment-submission"
                    type="xpath">

                    xxf:set-request-attribute('fr-action-error', true()),
                    process:runProcessByName('oxf.fr.detail.process', 'action-service-error')
                </xf:action>
            </xf:model>
        </output>
    </test>

    <test description="For #4142: Flattening of simple condition" name="oxf:unsafe-xslt">
        <input name="config" href="test-actions.xsl"/>
        <input name="data">
            <xh:html>
                <xh:head>
                    <xf:model id="fr-form-model">

                        <fr:listener
                            version="2018.2"
                            events="form-load-after-controls"
                            actions="my-action"/>

                        <fr:action name="my-action" version="2018.2">
                            <fr:alert message="1"/>
                            <fr:if condition="true()">
                                <fr:alert message="2"/>
                            </fr:if>
                            <fr:alert message="3"/>
                        </fr:action>
                    </xf:model>
                </xh:head>
            </xh:html>
        </input>
        <output name="data">
            <xf:model id="fr-form-model">

               <xf:action target="fr-form-model" event="fr-run-form-load-action-after-controls">
                   <xf:dispatch name="fr-call-user-my-action-action" targetid="fr-form-model">
                       <xf:property name="action-source" value="event('xxf:absolute-targetid')"/>
                   </xf:dispatch>
               </xf:action>

               <xf:action id="my-action-binding" event="fr-call-user-my-action-action" target="fr-form-model">
                   <xf:action type="xpath">
                       xxf:set-request-attribute('fr-action-source', event('action-source')),
                        xxf:set-request-attribute('fr-action-error', false()),
                        for $i in 1 to 10 return xxf:set-request-attribute(concat('fr-action-continuation-is-last-iteration-', $i), ()),
                        for $i in 1 to 10 return xxf:set-request-attribute(concat('fr-iteration-context-', $i), ())
                   </xf:action>
                   <xf:message>1</xf:message>
                   <xf:var name="cond1" value="true()"/>
                   <xf:action if="$cond1">
                       <xf:message>2</xf:message>
                       <xf:dispatch name="fr-action-continuation-my-action-2-id" targetid="fr-form-model"/>
                   </xf:action>
                   <xf:action if="not($cond1)">
                       <xf:dispatch name="fr-action-continuation-my-action-2-id" targetid="fr-form-model"/>
                   </xf:action>
               </xf:action>
               <xf:action observer="fr-form-model" event="fr-action-continuation-my-action-2-id" context="instance('fr-form-instance')">
                   <xf:message>3</xf:message>
               </xf:action>

            </xf:model>
        </output>
    </test>

    <test description="For #4142: Flattening of service within condition within iteration" name="oxf:unsafe-xslt">
        <input name="config" href="test-actions.xsl"/>
        <input name="data">
            <xh:html>
                <xh:head>
                    <xf:model id="fr-form-model">

                        <fr:listener
                            version="2018.2"
                            events="form-load-after-controls"
                            actions="my-action"/>

                        <fr:action name="my-action" version="2018.2">
                            <fr:alert message="1"/>
                            <fr:service-call service="my-service-1"/>

                            <fr:alert message="2"/>
                            <fr:data-iterate ref="/*/record">
                                <fr:alert message="3"/>
                                <fr:service-call service="my-service-2"/>

                                <fr:alert message="4"/>
                                <fr:if condition="true()">
                                    <fr:alert message="5"/>
                                    <fr:service-call service="my-service-3">
                                        <fr:url-param name="text" value="." expression-context="current-iteration"/>
                                    </fr:service-call>

                                    <fr:alert message="6"/>
                                </fr:if>
                                <fr:alert message="7"/>
                            </fr:data-iterate>
                            <fr:alert message="8"/>
                            <fr:service-call service="my-service-4"/>
                            <fr:alert message="9"/>
                        </fr:action>
                    </xf:model>
                </xh:head>
            </xh:html>
        </input>
        <output name="data">
            <xf:model id="fr-form-model">

                <xf:action target="fr-form-model" event="fr-run-form-load-action-after-controls">
                    <xf:dispatch name="fr-call-user-my-action-action" targetid="fr-form-model">
                        <xf:property name="action-source" value="event('xxf:absolute-targetid')"/>
                    </xf:dispatch>
                </xf:action>

                <xf:action id="my-action-binding" event="fr-call-user-my-action-action" target="fr-form-model">
                    <xf:action type="xpath">
                        xxf:set-request-attribute('fr-action-source', event('action-source')),
                        xxf:set-request-attribute('fr-action-error', false()),
                        for $i in 1 to 10 return xxf:set-request-attribute(concat('fr-action-continuation-is-last-iteration-', $i), ()),
                        for $i in 1 to 10 return xxf:set-request-attribute(concat('fr-iteration-context-', $i), ())
                    </xf:action>
                    <xf:message>1</xf:message>
                    <xf:insert ref="xxf:instance('fr-service-request-instance')"
                               origin="saxon:parse(xxf:instance('my-service-1-instance'))"/>
                    <xf:action type="xpath">xxf:set-request-attribute('fr-action-continuation-id', 'my-action-2-id')</xf:action>
                    <xf:insert ref="xxf:instance('fr-service-response-instance')" origin="xf:element('response')"/>
                    <xf:send submission="my-service-1-submission"/>
                </xf:action>
                <xf:action observer="my-service-1-submission" event="xforms-submit-done"
                           context="xxf:instance('fr-service-response-instance')"
                           if="xxf:get-request-attribute('fr-action-continuation-id') = 'my-action-2-id'">
                    <xf:message>2</xf:message>
                    <xf:action if="empty(/*/record)">
                        <xf:dispatch name="fr-action-continuation-my-action-6-id" targetid="fr-form-model"/>
                    </xf:action>
                    <xf:action iterate="/*/record">
                        <xf:action if="not(xxf:get-request-attribute('fr-action-error') = true())">
                            <xf:action type="xpath">xxf:set-request-attribute('fr-action-continuation-is-last-iteration-1', position() =
                                last())
                            </xf:action>
                            <xf:action type="xpath">xxf:set-request-attribute('fr-iteration-context-1', .)</xf:action>
                            <xf:message>3</xf:message>
                            <xf:insert ref="xxf:instance('fr-service-request-instance')"
                                       origin="saxon:parse(xxf:instance('my-service-2-instance'))"/>
                            <xf:action type="xpath">xxf:set-request-attribute('fr-action-continuation-id', 'my-action-3-id')</xf:action>
                            <xf:insert ref="xxf:instance('fr-service-response-instance')" origin="xf:element('response')"/>
                            <xf:send submission="my-service-2-submission"/>
                        </xf:action>
                    </xf:action>
                </xf:action>
                <xf:action observer="my-service-2-submission" event="xforms-submit-done"
                           context="xxf:instance('fr-service-response-instance')"
                           if="xxf:get-request-attribute('fr-action-continuation-id') = 'my-action-3-id'">
                    <xf:message>4</xf:message>
                    <xf:var name="cond1" value="true()"/>
                    <xf:action if="$cond1">
                        <xf:message>5</xf:message>
                        <xf:insert ref="xxf:instance('fr-service-request-instance')"
                                   origin="saxon:parse(xxf:instance('my-service-3-instance'))"/>
                        <xf:var name="original-context" value="."/>
                        <xf:action context="xxf:instance('fr-service-request-instance')">
                            <xf:action>
                                <xf:var name="value" context="xxf:get-request-attribute('fr-iteration-context-1')" value="."/>
                                <xf:setvalue ref="/*/text" value="$value"/>
                            </xf:action>
                        </xf:action>
                        <xf:action type="xpath">xxf:set-request-attribute('fr-action-continuation-id', 'my-action-4-id')</xf:action>
                        <xf:insert ref="xxf:instance('fr-service-response-instance')" origin="xf:element('response')"/>
                        <xf:send submission="my-service-3-submission"/>
                    </xf:action>
                    <xf:action if="not($cond1)">
                        <xf:dispatch name="fr-action-continuation-my-action-5-id" targetid="fr-form-model"/>
                    </xf:action>
                </xf:action>
                <xf:action observer="my-service-3-submission" event="xforms-submit-done"
                           context="xxf:instance('fr-service-response-instance')"
                           if="xxf:get-request-attribute('fr-action-continuation-id') = 'my-action-4-id'">
                    <xf:message>6</xf:message>
                    <xf:dispatch name="fr-action-continuation-my-action-5-id" targetid="fr-form-model"/>
                </xf:action>
                <xf:action observer="fr-form-model" event="fr-action-continuation-my-action-5-id" context="xxf:instance('fr-service-response-instance')">
                    <xf:message>7</xf:message>
                    <xf:dispatch if="xxf:get-request-attribute('fr-action-continuation-is-last-iteration-1') = true()"
                                 name="fr-action-continuation-my-action-6-id" targetid="fr-form-model"/>
                </xf:action>
                <xf:action observer="fr-form-model" event="fr-action-continuation-my-action-6-id" context="xxf:instance('fr-service-response-instance')">
                    <xf:message>8</xf:message>
                    <xf:insert ref="xxf:instance('fr-service-request-instance')"
                               origin="saxon:parse(xxf:instance('my-service-4-instance'))"/>
                    <xf:action type="xpath">xxf:set-request-attribute('fr-action-continuation-id', 'my-action-7-id')</xf:action>
                    <xf:insert ref="xxf:instance('fr-service-response-instance')" origin="xf:element('response')"/>
                    <xf:send submission="my-service-4-submission"/>
                </xf:action>
                <xf:action observer="my-service-4-submission" event="xforms-submit-done"
                           context="xxf:instance('fr-service-response-instance')"
                           if="xxf:get-request-attribute('fr-action-continuation-id') = 'my-action-7-id'">
                    <xf:message>9</xf:message>
                </xf:action>
                <xf:action xmlns:frf="java:org.orbeon.oxf.fr.FormRunner"
                           xmlns:process="java:org.orbeon.oxf.fr.process.SimpleProcess" event="xforms-submit-error"
                           observer="my-service-1-submission my-service-2-submission my-service-3-submission my-service-4-submission"
                           type="xpath">xxf:set-request-attribute('fr-action-error', true()),
                    process:runProcessByName('oxf.fr.detail.process', 'action-service-error')
                </xf:action>
            </xf:model>

        </output>
    </test>

    <test description="For #4204: Nested `fr:data-iterate`" name="oxf:unsafe-xslt">
        <input name="config" href="test-actions.xsl"/>
        <input name="data">
            <xh:html>
                <xh:head>
                    <xf:model id="fr-form-model">

                        <fr:listener
                            version="2018.2"
                            events="form-load-after-controls"
                            actions="my-action"/>

                        <fr:action name="my-action" version="2018.2">

                            <fr:service-call service="echo"/>
                            <fr:repeat-clear repeat="my-section"/>

                            <fr:data-iterate ref="/*/level1">
                                <fr:repeat-add-iteration repeat="my-section" at="end"/>
                                <fr:repeat-clear repeat="my-grid" at="end"/>
                                <fr:data-iterate ref="level2" expression-context="current-iteration">
                                    <fr:repeat-add-iteration repeat="my-grid" at="end end"/>
                                    <fr:control-setvalue value="." control="my-control-foo" at="end" expression-context="current-iteration"/>
                                </fr:data-iterate>
                                <fr:control-setvalue value="." control="my-control-bar" at="end" expression-context="current-iteration"/>
                            </fr:data-iterate>

                        </fr:action>
                    </xf:model>
                </xh:head>
                <xh:body xmlns:fb="http://orbeon.org/oxf/xml/form-builder">
                    <fr:view>
                        <fr:body>
                            <fr:section id="my-section-section" bind="my-section-bind"
                                repeat="content" min="1"
                                template="instance('my-section-template')"
                                apply-defaults="true">
                                <xf:label ref="$form-resources/my-section/label"/>
                                <fr:grid id="my-grid-grid" bind="my-grid-bind" repeat="content" min="1"
                                         template="instance('my-grid-template')"
                                         apply-defaults="true"
                                         fb:initial-iterations="first">
                                    <fr:c y="1" x="1" w="6"/>
                                    <fr:c y="1" x="7" w="6"/>
                                </fr:grid>
                            </fr:section>
                        </fr:body>
                    </fr:view>
                </xh:body>
            </xh:html>
        </input>
        <output name="data">
            <xf:model id="fr-form-model">

                <xf:action target="fr-form-model" event="fr-run-form-load-action-after-controls">
                    <xf:dispatch name="fr-call-user-my-action-action" targetid="fr-form-model">
                        <xf:property name="action-source" value="event('xxf:absolute-targetid')"/>
                    </xf:dispatch>
                </xf:action>

                <xf:action id="my-action-binding" event="fr-call-user-my-action-action" target="fr-form-model">
                    <xf:action type="xpath">
                        xxf:set-request-attribute('fr-action-source', event('action-source')),
                        xxf:set-request-attribute('fr-action-error', false()),
                        for $i in 1 to 10 return xxf:set-request-attribute(concat('fr-action-continuation-is-last-iteration-', $i), ()),
                        for $i in 1 to 10 return xxf:set-request-attribute(concat('fr-iteration-context-', $i), ())
                    </xf:action>
                    <xf:insert ref="xxf:instance('fr-service-request-instance')" origin="saxon:parse(xxf:instance('echo-instance'))"/>
                    <xf:action type="xpath">xxf:set-request-attribute('fr-action-continuation-id', 'my-action-2-id')</xf:action>
                    <xf:insert ref="xxf:instance('fr-service-response-instance')" origin="xf:element('response')"/>
                    <xf:send submission="echo-submission"/>
                </xf:action>
                <xf:action
                    observer="echo-submission"
                    event="xforms-submit-done"
                    context="xxf:instance('fr-service-response-instance')"
                    if="xxf:get-request-attribute('fr-action-continuation-id') = 'my-action-2-id'">
                    <xf:action type="xpath">frf:repeatClear('my-section true none')</xf:action>
                    <xf:action if="empty(/*/level1)">
                        <xf:dispatch name="fr-action-continuation-my-action-4-id" targetid="fr-form-model"/>
                    </xf:action>
                    <xf:action iterate="/*/level1">
                        <xf:action if="not(xxf:get-request-attribute('fr-action-error') = true())">
                            <xf:action type="xpath">xxf:set-request-attribute('fr-action-continuation-is-last-iteration-1', position() = last())</xf:action>
                            <xf:action type="xpath">xxf:set-request-attribute('fr-iteration-context-1', .)</xf:action>
                            <xf:action type="xpath">frf:repeatAddIteration('my-section true end', true())</xf:action>
                            <xf:action type="xpath">frf:repeatClear('my-section true end my-grid true none')</xf:action>
                            <xf:action if="empty(level2)">
                                <xf:dispatch name="fr-action-continuation-my-action-3-id" targetid="fr-form-model"/>
                            </xf:action>
                            <xf:action iterate="level2" context="xxf:get-request-attribute('fr-iteration-context-1')">
                                <xf:action if="not(xxf:get-request-attribute('fr-action-error') = true())">
                                    <xf:action type="xpath">xxf:set-request-attribute('fr-action-continuation-is-last-iteration-2', position() = last())</xf:action>
                                    <xf:action type="xpath">xxf:set-request-attribute('fr-iteration-context-2', .)</xf:action>
                                    <xf:action type="xpath">frf:repeatAddIteration('my-section true end my-grid true end', true())</xf:action>
                                    <xf:action>
                                        <xf:var name="value" value="."/>
                                        <xf:rebuild/>
                                        <xf:recalculate/>
                                        <xf:action iterate="frf:resolveTargetRelativeToActionSourceFromBinds('fr-form-model', 'my-control-foo')[last()]">
                                            <xf:setvalue ref="." value="$value"/>
                                        </xf:action>
                                    </xf:action>
                                    <xf:dispatch
                                        if="xxf:get-request-attribute('fr-action-continuation-is-last-iteration-2') = true()"
                                        name="fr-action-continuation-my-action-3-id"
                                        targetid="fr-form-model"/>
                                </xf:action>
                            </xf:action>
                        </xf:action>
                    </xf:action>
                </xf:action>
                <xf:action observer="fr-form-model" event="fr-action-continuation-my-action-3-id" context="xxf:get-request-attribute('fr-iteration-context-1')">
                    <xf:action>
                        <xf:var name="value" value="."/>
                        <xf:rebuild/>
                        <xf:recalculate/>
                        <xf:action iterate="frf:resolveTargetRelativeToActionSourceFromBinds('fr-form-model', 'my-control-bar')[last()]">
                            <xf:setvalue ref="." value="$value"/>
                        </xf:action>
                    </xf:action>
                    <xf:dispatch
                        if="xxf:get-request-attribute('fr-action-continuation-is-last-iteration-1') = true()"
                        name="fr-action-continuation-my-action-4-id"
                        targetid="fr-form-model"/>
                </xf:action>
                <xf:action
                     xmlns:frf="java:org.orbeon.oxf.fr.FormRunner"
                     xmlns:process="java:org.orbeon.oxf.fr.process.SimpleProcess"
                     event="xforms-submit-error"
                     observer="echo-submission"
                     type="xpath">

                     xxf:set-request-attribute('fr-action-error', true()),
                     process:runProcessByName('oxf.fr.detail.process', 'action-service-error')
                </xf:action>
            </xf:model>
        </output>
    </test>

</group>
