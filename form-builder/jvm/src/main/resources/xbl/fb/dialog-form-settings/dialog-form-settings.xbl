<!--
  Copyright (C) 2012 Orbeon, Inc.

  This program is free software; you can redistribute it and/or modify it under the terms of the
  GNU Lesser General Public License as published by the Free Software Foundation; either version
  2.1 of the License, or (at your option) any later version.

  This program is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY;
  without even the implied warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.
  See the GNU Lesser General Public License for more details.

  The full text of the license is available at http://www.gnu.org/copyleft/lesser.html
  -->
<xbl:xbl xmlns:xh="http://www.w3.org/1999/xhtml"
         xmlns:xf="http://www.w3.org/2002/xforms"
         xmlns:xs="http://www.w3.org/2001/XMLSchema"
         xmlns:xxf="http://orbeon.org/oxf/xml/xforms"
         xmlns:fr="http://orbeon.org/oxf/xml/form-runner"
         xmlns:fb="http://orbeon.org/oxf/xml/form-builder"
         xmlns:xbl="http://www.w3.org/ns/xbl"
         xmlns:xxbl="http://orbeon.org/oxf/xml/xbl"
         xmlns:fbf="java:org.orbeon.oxf.fb.FormBuilderXPathApi"
         xmlns:frf="java:org.orbeon.oxf.fr.FormRunner"
         xmlns:xsl="http://www.w3.org/1999/XSL/Transform"
         xmlns:oxf="http://www.orbeon.com/oxf/processors">

    <xbl:binding
            id="fb-dialog-form-settings"
            element="fb|dialog-form-settings"
            xxbl:mode="javascript-lifecycle">
        <xbl:handlers>
            <!-- Handler to open dialog -->
            <xbl:handler event="fb-show-dialog xxforms-dialog-open" phase="target">

                <!-- Clear local values -->
                <xf:setvalue iterate="$i//*[not(*)]" ref="."/>
                <xf:setvalue iterate="$i//@*"        ref="."/>

                <xf:setvalue
                    ref="$i/lang"
                    value="event('lang')"/>

                <!-- Save event context information in local instance -->
                <xf:setvalue
                    iterate="
                        'for-button-name', 'app', 'form', 'thumbnail', 'allow-template-use',
                        'singleton', 'mode', 'created-with-version'"
                    ref="$i/*[name() = context()]"
                    value="event(context())"/>

                <!-- There can be multiple title/descriptions in different languages -->
                <!-- https://github.com/orbeon/orbeon-forms/issues/3613 -->
                <xf:delete
                    ref="$i/(title | description)"/>

                <xf:insert
                    context="$i"
                    ref="*"
                    origin="event('title'), event('description')"/>

                <xf:insert
                    iterate="$i/description[empty(@mediatype)]"
                    context="."
                    origin="xf:attribute('mediatype', 'text/plain')"/>

                <xf:setvalue
                    ref="$i/original-app"
                    value="$i/app"/>

                <xf:setvalue
                    iterate="'filename', 'mediatype', 'size'"
                    ref="$i/thumbnail/@*[name() = context()]"
                    value="event(concat('thumbnail-', context()))"/>

                <xf:var name="is-new-form"      value="$i/mode = 'new'"/>
                <xf:var name="is-app-form"      value="$i/mode = 'app-form'"/>
                <xf:var name="is-form-settings" value="not($is-new-form or $is-app-form)"/>

                <xf:setvalue
                    ref="$i/updated-with-versions"
                    value="string-join(event('updated-with-versions'), ', ')"/>

                <xf:setvalue
                    iterate="'attachment-max-size-per-file', 'attachment-max-size-aggregate-per-form', 'attachment-max-files-per-control'"
                    ref="$i/*[name() = context()]"
                    value="(event(context()), -2)[1]"/>

                <xf:setvalue
                    ref="$i/attachment-mediatypes"
                    value="(event('attachment-mediatypes'), $unlikely-mediatype)[1]"/>

                <xf:action iterate="'wizard', 'wizard-subsections-nav', 'wizard-separate-toc', 'wizard-section-status'">
                    <xf:var name="name" value="."/>
                    <xf:setvalue
                        ref="$i/*[name() = $name]"
                        value="(event($name)[. = ('true', 'false')], 'default')[1]"/>
                </xf:action>

                <xf:setvalue
                    ref="$i/wizard-mode"
                    value="(event('wizard-mode')[. = ('free', 'lax', 'strict')], 'default')[1]"/>

                <xf:setvalue
                    ref="$i/wizard-subsections-toc"
                    value="(event('wizard-subsections-toc')[. = ('active', 'all', 'none')], 'default')[1]"/>

                <xf:setvalue
                    ref="$i/labels"
                    value="(xxf:split(event('labels'))[. = 'full'], 'default')[1]"/>

                <xf:setvalue
                    ref="$i/labels-placeholders"
                    value="xxf:split(event('labels')) = 'minimal'"/>

                <xf:setvalue
                    ref="$i/hints"
                    value="(xxf:split(event('hints'))[. = ('full', 'tooltip')], 'default')[1]"/>

                <xf:setvalue
                    ref="$i/hints-placeholders"
                    value="xxf:split(event('hints')) = 'minimal'"/>

                <xf:setvalue
                    ref="$i/automatic-hints"
                    value="(event('automatic-hints')[. = ('true', 'false')], 'default')[1]"/>

                <xf:setvalue
                    ref="$i/data-migration"
                    value="(event('data-migration')[. = ('enabled', 'disabled', 'error')], 'default')[1]"/>

                <xf:setvalue
                    ref="$i/grid-tab-order"
                    value="(event('grid-tab-order')[. = ('rows', 'columns')], 'default')[1]"/>

                <xf:action iterate="'rendered-page-orientation', 'rendered-page-size'">
                    <xf:var name="n" value="."/>
                    <xf:setvalue
                        ref="$i/*[name() = $n]"
                        value="
                            (
                                event($n)[
                                    . = xxf:resource-elements(
                                        concat(
                                            'dialog-form-settings.',
                                            $n,
                                            '.item'
                                        ),
                                        '|fr-form-resources|'
                                    )/@id
                                ],
                                'default'
                            )[1]"/>
                </xf:action>

                <xf:setvalue
                    ref="$i/readonly-disable-calculate"
                    value="(event('readonly-disable-calculate')[. = ('true', 'false')], 'default')[1]"/>

                <xf:setvalue
                    iterate="'relevant', 'readonly'"
                    ref="$i/*[name() = context()]"
                    value="event(context())"/>

                <xf:setvalue
                    ref="$i/html-page-layout"
                    value="(event('html-page-layout')[. = ('fixed', 'fluid')], 'default')[1]"/>

                <xf:setvalue
                    ref="$i/density"
                    value="(event('density')[. = ('compact', 'comfortable', 'roomy')], 'default')[1]"/>

                <xf:setvalue
                    ref="$i/analysis-calculate"
                    value="(event('analysis-calculate')[. = ('true', 'false')], 'default')[1]"/>

                <!--  Sanitize as caller might pass an initial app name which is not allowed by current permissions -->
                <xf:action if="$has-roles and not($allowed-apps-if-has-roles = ('*', event('app')))">
                    <xf:setvalue
                        if="$app-chooser = 'output'"
                        ref="app"
                        value="$allowed-apps-if-has-roles[1]"/>
                    <xf:setvalue
                        if="$app-chooser = 'select1'"
                        ref="app"
                        value="''"/>
                </xf:action>

                <!-- Process `fb:control-details` -->

                <!-- Initialize specific control settings -->
                <!-- NOTE: Part of this is duplicated in `dialog-control-settings.xbl`. -->
                <xf:action if="$is-form-settings">

                    <xf:delete
                        ref="instance('dynamic')/* | instance('control-details-metadata')/*"/>

                    <xf:var
                        name="all-metadata-with-control-details"
                        value="event('component-bindings')/fb:metadata[exists(fb:control-details) and not(fb:form-settings/@show = 'false')]"/>

                    <xf:insert
                        context="instance('control-details-metadata')"
                        origin="$all-metadata-with-control-details"/>

                    <xf:action iterate="$all-metadata-with-control-details/fb:control-details">

                        <xf:var
                            name="control-details"
                            value="."/>

                        <xf:var
                            name="mutable-control-details"
                            value="xxf:mutable-document($control-details)/*"/>

                        <!-- Process the LHHA of each details control -->
                        <xf:action iterate="$mutable-control-details//(xf:label, xf:hint, xf:help, xf:alert)">
                            <xf:var name="lhha" value="."/>
                            <!-- If it has a lang attribute, only keep if matches the current language -->
                            <xf:delete if="exists($lhha/@lang) and $lhha/@lang != $i/lang" ref="$lhha"/>
                            <!-- If it has a `ref="$resources/..."`, evaluate it -->
                            <xf:action if="starts-with($lhha/@ref, '$resources/')">
                                <xf:var name="resource-path" value="substring-after($lhha/@ref, '$resources/')"/>
                                <xf:setvalue ref="$lhha" value="$resources/xxf:evaluate($resource-path)"/>
                                <xf:delete ref="$lhha/@ref"/>
                            </xf:action>
                        </xf:action>

                        <!-- Complete the custom form -->
                        <xf:insert
                            context="instance('dynamic')"
                            ref="*"
                            origin="instance('dynamic-template')"/>

                        <xf:var
                            name="inserted"
                            value="instance('dynamic')/*[last()]"/>

                        <xf:insert
                            context="$inserted//xf:model"
                            ref="*"
                            origin="$mutable-control-details/xf:model/*"/>

                        <xf:var
                            name="control-metadata"
                            value="$control-details/.."/>

                        <xf:var
                            name="xbl-binding"
                            value="$control-metadata/.."/>

                        <xf:var
                            name="view-template"
                            value="
                                (
                                    $control-metadata/fb:templates/fb:view/*,
                                    $control-metadata/fb:template/*
                                )[1]"/>

                        <!-- Don't use `node-name($view-template)` as we did before as we want a uniquely identifiable
                             name. We remove the `appearance` attribute, so we cannot use that. See
                             https://github.com/orbeon/orbeon-forms/issues/5026 -->
                        <xf:var
                            name="direct-qname"
                            as="xs:QName"
                            value="fbf:directNameFromBinding($xbl-binding)"/>

                        <xf:var
                            name="control-settings-elem"
                            value="(event('xbl')/*[node-name(.) = $direct-qname])[1]"/>

                        <xf:insert
                            context="$inserted//xf:instance"
                            origin="
                                if (exists($control-settings-elem)) then
                                    $control-settings-elem
                                else
                                    xf:element(
                                        $direct-qname,
                                        (: Also copy attributes that are always there on the view template :)
                                        $view-template/(@* except (@id, @appearance, @ref, @bind))
                                    )"/>

                        <xf:insert
                            context="$inserted//xh:body"
                            origin="$mutable-control-details/(* except xf:model)"/>

                    </xf:action>
                </xf:action>

                <xxf:show dialog="dialog"/>

                <xf:var name="form" value="xxf:instance('fb-form-instance')"/>

                <!-- Tell custom settings to initialize -->
                <xf:dispatch
                    if="xxf:non-blank(xxf:property('oxf.fb.extension.form-settings'))"
                    name="fb-initialize" targetid="fb-custom-form-settings">
                    <xf:property name="form"              value="$form"/>
                    <xf:property name="form-instance"     value="frf:formInstanceRoot($form)"/>
                    <xf:property name="metadata-instance" value="frf:metadataInstanceRootOpt($form)"/>
                </xf:dispatch>

                <!-- Check for default template for backward compatibility -->
                <!-- https://github.com/orbeon/orbeon-forms/issues/6782 -->
                <xf:action if="doc-available('oxf:/forms/orbeon/builder/form/template.xml')">

                    <xf:var name="template" value="doc('oxf:/forms/orbeon/builder/form/template.xml')"/>
                    <xf:var name="metadata-instance" value="frf:metadataInstanceRootOpt($form)"/>

                    <xf:insert
                        context="instance('template-forms')"
                        ref="_[1]"
                        position="before"
                        origin="
                            xf:element(
                                '_',
                                (
                                    xf:element('url', 'oxf:/forms/orbeon/builder/form/template.xml'),
                                    ($metadata-instance//title[xxf:non-blank()], xf:element('title', xxf:r('dialog-form-settings.default-template', '|fr-form-resources|')))[1],
                                    $metadata-instance//(description | thumbnail)[xxf:non-blank()]
                                )
                            )"/>
                </xf:action>

                <!-- Load form templates -->
                <xf:send
                    if="$is-new-form and $max-templates gt count(instance('template-forms')/*)"
                    submission="search-form-templates-submission">
                    <!-- Pass a string as we don't support sequences in tunnel parameters yet -->
                    <xf:property
                        name="remaining-app-names"
                        value="if ($app-chooser = ('select1', 'output')) then string-join($allowed-apps-if-has-roles, ' ') else ()"
                        xxf:tunnel="true"/>
                </xf:send>
                <!-- Explicit focus is necessary or the tab might not consistently open -->
                <xf:setfocus
                    if="$is-new-form"
                    control="fb-templates-grid"/>

                <!-- If there are invalid initial app/form values, mark them as visited and focus on first -->
                <xf:action if="$is-app-form or $is-form-settings">
                    <xf:var
                        name="invalid-app-form"
                        value="$i/(app, form)[not(valid())]"/>
                    <xf:action if="exists($invalid-app-form)">
                        <xf:setfocus
                            iterate="$invalid-app-form[1]"
                            control="fb-{name()}-name-input"/>
                    </xf:action>
                    <!-- Explicit focus is necessary or the tab might not consistently open -->
                    <xf:setfocus
                        if="empty($invalid-app-form)"
                        control="fb-general-settings-grid"/>
                </xf:action>

                <xf:action type="javascript" event="xxforms-dialog-open" target="#observer">
                    ORBEON.xforms.XBL.instanceForControl(this).dialogOpening();
                </xf:action>

                <!-- Mark app and form fields visited so that their associated info alerts show -->
                <xf:action
                    if="$i/app != '' and $i/form != ''"
                    iterate="'fb-app-name-input', 'fb-app-name-select1', 'fb-form-name-input'">
                    <xxf:setvisited
                        control="{.}"
                        recurse="true"/>
                </xf:action>

            </xbl:handler>

            <!-- Save and close if valid -->
            <xbl:handler
                event="DOMActivate"
                observer="fb-app-name-input fb-form-name-input fb-title-input fb-continue-button"
                if="$i/mode != 'new' or instance('navigation') = 'general'">

                <xf:action if="$i/@valid = 'true'">

                    <xf:var name="form" value="xxf:instance('fb-form-instance')"/>

                    <!-- Tell custom settings to apply changes -->
                    <xf:dispatch name="fb-apply" targetid="fb-custom-form-settings">
                        <xf:property name="form"              value="$form"/>
                        <xf:property name="form-instance"     value="frf:formInstanceRoot($form)"/>
                        <xf:property name="metadata-instance" value="frf:metadataInstanceRootOpt($form)"/>
                    </xf:dispatch>

                    <!-- Remove attributes if their value is the same as the value of the attribute on the view template -->
                    <xf:action iterate="instance('dynamic')/*">
                        <xf:var
                            name="p"
                            value="position()"/>
                        <xf:var
                            name="control-settings-elem"
                            value="(.//xf:instance/*)[1]"/>
                        <!--
                            Search by position. Each element under `instance('dynamic')` has a corresponding element under
                            `instance('control-details-metadata')` in order. We cannot search using the element name under
                            the view template as we did previously because we use a uniquely identifiable direct name. See:

                            - https://github.com/orbeon/orbeon-forms/issues/5026
                            - https://github.com/orbeon/orbeon-forms/issues/5315
                        -->
                        <xf:var
                            name="view-template"
                            value="
                                (
                                    instance('control-details-metadata')/
                                    fb:metadata[$p]/
                                    (fb:template | fb:templates/fb:view)/
                                    *
                                )[1]"/>
                        <xf:action iterate="$control-settings-elem/@*">
                            <xf:var name="xbl-attribute" value="."/>
                            <xf:delete
                                if="
                                    exists(
                                        $view-template/@*[
                                            name() = $xbl-attribute/name() and
                                            .      = $xbl-attribute
                                        ]
                                    )"
                                ref="$xbl-attribute"/>
                        </xf:action>
                    </xf:action>

                    <!-- Normalize `description` elements -->
                    <xf:delete
                        ref="$i/description/@mediatype[. = 'text/plain']"/>

                    <!-- Dispatch event with result -->
                    <xf:dispatch name="fb-update-metadata" targetid="fb-dialog-form-settings">
                        <xf:property name="app"                                    value="$i/app/string()"/>
                        <xf:property name="form"                                   value="$i/form/string()"/>
                        <xf:property name="title"                                  value="$i/title"/>
                        <xf:property name="description"                            value="$i/description"/>
                        <xf:property name="thumbnail"                              value="$i/thumbnail/string()"/>
                        <xf:property name="thumbnail-filename"                     value="$i/thumbnail/@filename/string()"/>
                        <xf:property name="thumbnail-mediatype"                    value="$i/thumbnail/@mediatype/string()"/>
                        <xf:property name="thumbnail-size"                         value="$i/thumbnail/@size/string()"/>
                        <xf:property name="allow-template-use"                     value="$i/allow-template-use/string()"/>
                        <xf:property name="singleton"                              value="$i/singleton/string()"/>
                        <xf:property name="attachment-max-size-per-file"           value="$i/attachment-max-size-per-file/string()"/>
                        <xf:property name="attachment-max-size-aggregate-per-form" value="$i/attachment-max-size-aggregate-per-form/string()"/>
                        <xf:property name="attachment-max-files-per-control"          value="$i/attachment-max-files-per-control/string()"/>
                        <xf:property name="attachment-mediatypes"                  value="$i/attachment-mediatypes/string()[. != $unlikely-mediatype]"/>
                        <xf:property name="wizard"                                 value="$i/wizard/string()"/>
                        <xf:property name="wizard-mode"                            value="$i/wizard-mode/string()"/>
                        <xf:property name="wizard-subsections-nav"                 value="$i/wizard-subsections-nav/string()"/>
                        <xf:property name="wizard-subsections-toc"                 value="$i/wizard-subsections-toc/string()"/>
                        <xf:property name="wizard-separate-toc"                    value="$i/wizard-separate-toc/string()"/>
                        <xf:property name="wizard-section-status"                  value="$i/wizard-section-status/string()"/>
                        <xf:property name="mode"                                   value="$i/mode/string()"/>
                        <xf:property name="automatic-hints"                        value="$i/automatic-hints/string()"/>
                        <xf:property name="data-migration"                         value="$i/data-migration/string()"/>
                        <xf:property name="available-from"                         value="$i/available-from"/>
                        <xf:property name="available-to"                           value="$i/available-to"/>
                        <xf:property name="grid-tab-order"                         value="$i/grid-tab-order/string()"/>
                        <xf:property name="rendered-page-orientation"              value="$i/rendered-page-orientation/string()"/>
                        <xf:property name="rendered-page-size"                     value="$i/rendered-page-size/string()"/>
                        <xf:property name="readonly-disable-calculate"             value="$i/readonly-disable-calculate/string()"/>
                        <xf:property name="relevant"                               value="$i/relevant/string()"/>
                        <xf:property name="readonly"                               value="$i/readonly/string()"/>
                        <xf:property name="html-page-layout"                       value="$i/html-page-layout/string()"/>
                        <xf:property name="density"                                value="$i/density/string()"/>
                        <xf:property name="analysis-calculate"                     value="$i/analysis-calculate/string()"/>
                        <xf:property name="automatic-hints"                        value="$i/automatic-hints/string()"/>

                        <xf:property
                            name="labels"
                            value="
                                if ($i/labels = 'default') then
                                    ()
                                else string-join(
                                    (
                                        $i/labels/string(),
                                        'minimal'[data($i/labels-placeholders)]
                                    ),
                                    ' '
                                )"/>

                        <xf:property
                            name="hints"
                            value="
                                if ($i/hints = 'default') then
                                    ()
                                else string-join(
                                    (
                                        $i/hints/string(),
                                        'minimal'[data($i/hints-placeholders)]
                                    ),
                                    ' '
                                )"/>

                        <xf:property
                            name="control-settings-elems"
                            value="
                                for $subform in instance('dynamic')/*
                                return
                                    ($subform//xf:instance/*)[1]
                        "/>

                        <xf:property
                            name="template-url"
                            value="
                                if ($i/mode/string() = 'new') then
                                    instance('template-forms')/*[index('form-template-repeat')]/url/string()
                                else
                                    ()
                        "/>

                    </xf:dispatch>

                    <!-- Don't leave this stuff around -->
                    <!-- We don't need any of the templates (even builtin ones) -->
                    <xf:delete
                        ref="
                            instance('dynamic')/* |
                            instance('control-details-metadata')/* |
                            instance('template-forms')/*"/>

                    <!-- Hide this dialog -->
                    <xxf:hide dialog="dialog"/>

                </xf:action>
            </xbl:handler>

            <!-- Put his handler after the above handler, otherwise the above handler condition will be satisfied as we
                 set `instance('navigation') = 'templates'`. -->
            <xbl:handler
                event="DOMActivate"
                observer="fb-continue-button"
                if="$i/mode = 'new' and instance('navigation') = 'templates'">
                <xf:setfocus control="fb-general-settings-grid"/>
                <xf:setvalue ref="instance('navigation')" value="'general'"/>
            </xbl:handler>

            <xbl:handler observer="dialog" event="xxforms-dialog-close" phase="target">
                <xf:action type="javascript">
                    ORBEON.xforms.XBL.instanceForControl(this).dialogClosing();
                </xf:action>
            </xbl:handler>.
        </xbl:handlers>
        <xbl:implementation>
            <xf:model id="model">

                <!-- Maximum number of form templates to load -->
                <xf:var
                    name="max-templates"
                    value="100"/>

                <xf:instance id="local">
                    <_ valid="true">
                        <for-button-name/>
                        <lang/>
                        <original-app/>
                        <app/>
                        <form/>
                        <singleton/>
                        <thumbnail filename="" mediatype="" size=""/>
                        <allow-template-use/>
                        <wizard/>
                        <wizard-mode/>
                        <wizard-subsections-nav/>
                        <wizard-subsections-toc/>
                        <wizard-separate-toc/>
                        <wizard-section-status/>
                        <rendered-page-orientation/>
                        <rendered-page-size/>
                        <readonly-disable-calculate/>
<!--                        <relevant/>-->
                        <readonly/>
                        <html-page-layout/>
                        <density/>
                        <attachment-max-size-per-file/>
                        <attachment-max-size-aggregate-per-form/>
                        <attachment-max-files-per-control/>
                        <attachment-mediatypes/>
                        <labels/>
                        <labels-placeholders/>
                        <hints/>
                        <hints-placeholders/>
                        <automatic-hints/>
                        <grid-tab-order/>
                        <mode/>
                        <created-with-version/>
                        <updated-with-versions/>
                        <data-migration/>
                        <analysis-calculate/>
                        <xbl/>
                    </_>
                </xf:instance>

                <xf:var
                    name="i"
                    value="instance()"/>

                <xf:var
                    name="unlikely-mediatype"
                    value="'orbeon/a26ffc179d3013f2726fbed92d03e9ed74a1c029'"/>

                <xf:var
                    name="has-roles"
                    value="not(xxf:instance('fb-permissions')/@
                    has-roles = 'false')"/>

                <!-- NOTE: Can contain '*'. -->
                <xf:var
                    name="allowed-apps-if-has-roles"
                    value="xxf:instance('fb-permissions')/app/@name/string()"/>

                <!-- Control used for choosing the app name; value can be: 'input', 'output', or 'select1' -->
                <xf:var
                    name="app-chooser"
                    value="
                        if (not($has-roles) or $allowed-apps-if-has-roles = '*') then
                            'input'
                        else if (count($allowed-apps-if-has-roles) = 1) then
                            'output'
                        else
                            'select1'"
                />

                <xf:bind
                    ref="app | form"
                    required="../mode = 'app-form'"
                    constraint="xxf:is-blank() or matches(., '^[A-Za-z0-9\-_]+$') and xxf:max-length(255)"
                    xxf:whitespace="trim"
                    readonly="false()"/>
                <xf:bind
                    ref="title | description"
                    xxf:whitespace="trim"/>
                <xf:bind
                    id="app-bind"
                    ref="app"
                    constraint="not($has-roles and not($allowed-apps-if-has-roles = ('*', .)))"/>
                <xf:bind
                    id="form-bind"
                    ref="form">
                    <xf:constraint
                        level="info"
                        value="xxf:non-blank() and xxf:non-blank(../app)"
                        id="blank-form-alert-constraint"/>
                    <xf:constraint
                        level="info"
                        value="
                            not(
                                xxf:non-blank()                                                         and
                                xxf:non-blank(../app)                                                   and
                                instance('fr-counts-instance')/published-forms castable as xs:integer   and
                                instance('fr-counts-instance')/in-progress-forms castable as xs:integer and
                                instance('fr-counts-instance')/published-forms = 0                      and
                                instance('fr-counts-instance')/in-progress-forms = 0
                            )"
                        id="no-form-alert-constraint"/>
                    <xf:constraint
                        level="info"
                        value="
                            not(
                                xxf:non-blank()                                                         and
                                instance('fr-counts-instance')/published-forms castable as xs:integer   and
                                instance('fr-counts-instance')/published-forms != 0
                            )"
                        id="form-published-constraint"/>
                    <xf:constraint
                        level="info"
                        value="
                            not(
                                xxf:non-blank()                                                         and
                                instance('fr-counts-instance')/in-progress-forms castable as xs:integer and
                                instance('fr-counts-instance')/in-progress-forms != 0
                            )"
                        id="form-in-progress-constraint"/>
                </xf:bind>
                <xf:bind
                    ref="singleton"
                    calculate="if (string() = '') then 'false' else ."
                    readonly="false()"
                    type="xs:boolean"/>
                <xf:bind
                    ref="allow-template-use"
                    calculate="if (string() = '') then 'false' else ."
                    readonly="false()"
                    type="xs:boolean"/>
                <xf:bind
                    ref="attachment-max-size-per-file | attachment-max-size-aggregate-per-form | attachment-max-files-per-control"
                    type="xs:integer"
                    constraint="xxf:non-negative() or . = -2"/>
                <xf:bind
                    ref="attachment-mediatypes"
                    constraint="fbf:isValidListOfMediatypeRanges(.)"/>
                <xf:bind
                    ref="labels-placeholders"
                    readonly="../labels = 'default'"
                    type="xs:boolean"/>
                <xf:bind
                    ref="hints-placeholders"
                    readonly="../hints = 'default'"
                    type="xs:boolean"/>
                <xf:bind
                    ref="mode"
                    constraint=". = ('new', 'app-form', 'form-settings')"/>
                <xf:bind
                    ref="data-migration"
                    relevant="fr:is-pe()"/>
                <xf:bind
                    ref="(available-from, available-to)/@dateTime"
                    type="xs:dateTime"/>
                <xf:bind
                    ref="relevant | readonly"
                    type="xxf:XPath2"
                    xxf:whitespace="trim"
                    required="false()"/>

                <xf:instance id="dynamic" xxf:exclude-result-prefixes="#all">
                    <_/>
                </xf:instance>

                <xf:instance id="control-details-metadata">
                    <_/>
                </xf:instance>

                <xf:instance id="dynamic-template" xxf:readonly="true">
                    <xh:html>
                        <xh:head>
                            <xf:model id="custom-model">
                                <xf:instance id="custom-instance"/>
                            </xf:model>
                        </xh:head>
                        <xh:body/>
                    </xh:html>
                </xf:instance>

                <xf:instance id="modified">
                    <_ i="" dynamic=""/>
                </xf:instance>

                <xf:instance id="navigation">
                    <_>templates</_>
                </xf:instance>

                <xf:instance id="template-forms">
                    <_>
                        <_>
                            <url>oxf:/forms/orbeon/builder/form/template-blank.xml</url>
                            <title xml:lang="en">Blank Form</title>
                            <title xml:lang="fr">Formulaire vide</title>
                            <description xml:lang="en">Use this template to start from scratch.</description>
                            <description xml:lang="fr">Utilisez ce modèle pour commencer à partir de zéro.</description>
                            <thumbnail></thumbnail>
                        </_>
                        <_>
                            <url>oxf:/forms/orbeon/builder/form/template-wizard.xml</url>
                            <title xml:lang="en">Wizard Form</title>
                            <title xml:lang="fr">Formulaire "Wizard"</title>
                            <description xml:lang="en">Use this template to automatically use the Wizard view, which presents the form as a series of steps.</description>
                            <description xml:lang="fr">Utilisez ce modèle pour automatiquement utiliser la vue "Wizard", qui présente le formulaire comme une série d'étapes.</description>
                            <thumbnail>oxf:/forms/orbeon/builder/form/template-wizard.jpg</thumbnail>
                        </_>
                    </_>
                </xf:instance>

                <xf:instance id="search-templates-instance">
                    <search xmlns="" return-all-indexed-fields="true">
                        <query/>
                        <query name="application-name"
                               path="xh:head/xf:model[@id = 'fr-form-model']/xf:instance[@id = 'fr-form-metadata']/*/application-name"
                               match="substring"/>
                        <query name="form-name"
                               path="xh:head/xf:model[@id = 'fr-form-model']/xf:instance[@id = 'fr-form-metadata']/*/form-name"
                               match="substring"/>
                        <query name="title"
                               path="xh:head/xf:model[@id = 'fr-form-model']/xf:instance[@id = 'fr-form-metadata']/*/title"
                               match="substring"/>
                        <query name="description"
                               path="xh:head/xf:model[@id = 'fr-form-model']/xf:instance[@id = 'fr-form-metadata']/*/description"
                               match="substring"/>
                        <query name="thumbnail"
                               path="xh:head/xf:model[@id = 'fr-form-model']/xf:instance[@id = 'fr-form-metadata']/*/thumbnail"
                               match="substring"/>
                        <query name="thumbnail"
                               path="xh:head/xf:model[@id = 'fr-form-model']/xf:instance[@id = 'fr-form-metadata']/*/allow-template-use"
                               match="exact">true</query>
                        <page-size/>
                        <page-number>1</page-number>
                        <lang/>
                    </search>
                </xf:instance>

                <xf:submission
                    id="search-form-templates-submission"
                    ref="instance('search-templates-instance')"
                    validate="false"
                    method="post"
                    resource="/fr/service/persistence/search/orbeon/builder"
                    replace="none"
                    mode="asynchronous"
                    xxf:response-must-await="200ms"
                >

                    <xf:header>
                        <xf:name>Orbeon-Form-Definition-Version</xf:name>
                        <xf:value value="1"/>
                    </xf:header>

<!--                    <xf:setvalue-->
<!--                        event="xforms-submit-error"-->
<!--                        ref="instance('fr-landing-form-metadata-instance')/@state"-->
<!--                        value="'error'"/>-->

                    <!-- Set language upon submitting -->
                    <xf:action event="xforms-submit">
                        <xf:setvalue
                            ref="query[@name = 'application-name']"
                            value="
                                if (exists(event('remaining-app-names'))) then
                                    xxf:split(event('remaining-app-names'))[1]
                                else
                                    ''"/>

                        <!-- Return a single page and honor `$max-templates` -->
                        <xf:setvalue
                             ref="page-size"
                             value="max(($max-templates - count(instance('template-forms')/*), 0))"/>

                        <xf:setvalue ref="lang" value="'en'"/>
                        <!-- NOTE: xxf:lang() doesn't seem to work here -->
    <!--                    <xf:setvalue ref="lang" value="xxf:instance('fr-language-instance')"/>-->
<!--                        <xf:setvalue-->
<!--                            ref="instance('fr-landing-form-builder-instance')/@state"-->
<!--                            value="'loading'"/>-->
                    </xf:action>

                    <xf:action event="xforms-submit-done">
                        <xf:insert
                            context="instance('template-forms')"
                            ref="*"
                            origin="
                                for $doc in
                                    xxf:sort(
                                        event('response-body')/*/document[
                                            (: Exclude library forms :)
                                            details/detail[ends-with(@path, '/form-name')] != 'library'
                                        ],
                                        (: Sort alphabetically by title :)
                                        details/detail[ends-with(@path, '/title')],
                                        'text',
                                        'ascending'
                                    )
                                return
                                    xf:element(
                                        '_',
                                        (
                                            xf:element(
                                                'url',
                                                concat('/fr/service/persistence/crud/orbeon/builder/data/', $doc/@name, '/data.xml')
                                            ),
                                            xf:element(
                                                'app',
                                                $doc/details/detail[ends-with(@path, '/application-name')]/string()
                                            ),
                                            xf:element(
                                                'title',
                                                $doc/details/detail[ends-with(@path, '/title')]/string()
                                            ),
                                            xf:element(
                                                'description',
                                                $doc/details/detail[ends-with(@path, '/description')]/string()
                                            ),
                                            xf:element(
                                                'thumbnail',
                                                $doc/details/detail[ends-with(@path, '/thumbnail')]/string()
                                            )
                                        )
                                    )"/>
                        <xf:setindex repeat="form-template-repeat" index="1"/>
                        <xf:var
                            name="remaining-app-names"
                            value="
                                if (exists(event('remaining-app-names'))) then
                                    xxf:split(event('remaining-app-names'))[position() gt 1]
                                else
                                    ()"/>
                        <xf:send
                            if="exists($remaining-app-names) and $max-templates gt count(instance('template-forms')/*)"
                            submission="search-form-templates-submission">
                            <!-- Pass a string as we don't support sequences in tunnel parameters yet -->
                            <xf:property
                                name="remaining-app-names"
                                value="string-join($remaining-app-names, ' ')"
                                xxf:tunnel="true"/>
                        </xf:send>
                    </xf:action>
                </xf:submission>

                <xf:action
                    observer="fb-general-settings-grid"
                    target="#observer"
                    event="xforms-enabled"

                    if="xxf:non-blank($i/app) and xxf:non-blank($i/form) and valid($i/app) and valid($i/form)">

                    <xf:send submission="search-published-forms-submission">
                        <xf:property name="app"  value="$i/app/string()"  xxf:tunnel="true"/>
                        <xf:property name="form" value="$i/form/string()" xxf:tunnel="true"/>
                    </xf:send>
                    <xf:send submission="search-in-progress-forms-submission">
                        <xf:property name="app"  value="$i/app/string()"  xxf:tunnel="true"/>
                        <xf:property name="form" value="$i/form/string()" xxf:tunnel="true"/>
                    </xf:send>

                </xf:action>

                <xf:action
                    observer="fb-app-name-input fb-app-name-select1 fb-form-name-input"
                    event="xforms-value-changed"

                    if="xxf:non-blank($i/app) and xxf:non-blank($i/form) and valid($i/app) and valid($i/form)">

                    <xf:send submission="search-published-forms-submission">
                        <xf:property name="app"  value="$i/app/string()"  xxf:tunnel="true"/>
                        <xf:property name="form" value="$i/form/string()" xxf:tunnel="true"/>
                    </xf:send>
                    <xf:send submission="search-in-progress-forms-submission">
                        <xf:property name="app"  value="$i/app/string()"  xxf:tunnel="true"/>
                        <xf:property name="form" value="$i/form/string()" xxf:tunnel="true"/>
                    </xf:send>
                </xf:action>

                <xf:instance id="fr-counts-instance">
                    <_>
                        <published-apps/>
                        <published-forms/>
                        <in-progress-apps/>
                        <in-progress-forms/>
                    </_>
                </xf:instance>

                <xf:submission
                    id="search-published-forms-submission"
                    method="get"
                    serialization="none"
                    resource="/fr/service/persistence/form/{
                            event('app')
                        }{
                            if (exists(event('form'))) then
                                concat('/', event('form'))
                            else
                                ()
                        }?all-versions=true&amp;ignore-admin-permissions=true"
                    replace="none"
                    mode="asynchronous"
                    xxf:response-must-await="200ms"
                >

                    <xf:message
                        event="xforms-submit-error"
                        value="'submit error 1'"/>

                    <xf:action event="xforms-submit-done">
                        <xf:setvalue
                            ref="instance('fr-counts-instance')/(if (exists(event('form'))) then published-forms else published-apps)"
                            value="event('response-body')/*/@search-total"/>
                    </xf:action>
                </xf:submission>

                <xf:instance id="fr-search-in-progress-forms-instance">
                    <search xmlns="" return-all-indexed-fields="true">
                        <query/>
                        <query name="application-name"
                               path="xh:head/xf:model[@id = 'fr-form-model']/xf:instance[@id = 'fr-form-metadata']/*/application-name"
                               match="exact"/>
                        <query name="form-name"
                               path="xh:head/xf:model[@id = 'fr-form-model']/xf:instance[@id = 'fr-form-metadata']/*/form-name"
                               match="exact"/>
                        <page-size/>
                        <page-number>1</page-number>
                        <lang/>
                    </search>
                </xf:instance>

                <xf:submission
                    id="search-in-progress-forms-submission"
                    ref="instance('fr-search-in-progress-forms-instance')"
                    validate="false"
                    method="post"
                    resource="/fr/service/persistence/search/orbeon/builder"
                    replace="none"
                    mode="asynchronous"
                    xxf:response-must-await="200ms"
                >

                    <xf:header>
                        <xf:name>Orbeon-Form-Definition-Version</xf:name>
                        <xf:value value="1"/>
                    </xf:header>

                    <xf:action event="xforms-submit">
                        <xf:setvalue ref="query[@name = 'application-name']" value="event('app')"/>
                        <xf:setvalue ref="query[@name = 'form-name']"        value="event('form')"/>
                    </xf:action>

                    <xf:message
                        event="xforms-submit-error"
                        value="'submit error 2'"/>

                    <xf:action event="xforms-submit-done">
                        <xf:setvalue
                            ref="instance('fr-counts-instance')/(if (exists(event('form'))) then in-progress-forms else in-progress-apps)"
                            value="event('response-body')/*/@search-total"/>
                    </xf:action>

                </xf:submission>

            </xf:model>
        </xbl:implementation>
        <xbl:template xxbl:transform="oxf:unsafe-xslt">
            <xf:group xsl:version="2.0">
                <!-- Bindings specified on control -->
                <xf:var name="body"><xxf:value value=". treat as element()" xxbl:scope="outer" xbl:attr="model context ref=body-ref"/></xf:var>
                <xf:var name="resources"><xxf:value value=". treat as element()" xxbl:scope="outer" xbl:attr="model context ref=resources-ref"/></xf:var>
                <xf:var name="fr-resources"><xxf:value value=". treat as element()" xxbl:scope="outer" xbl:attr="model context ref=fr-resources-ref"/></xf:var>

                <xf:var name="is-new-form"      value="$i/mode = 'new'"/>
                <xf:var name="is-app-form"      value="$i/mode = 'app-form'"/>
                <xf:var name="is-form-settings" value="not($is-new-form or $is-app-form)"/>

                <!-- Once AVTs are supported: close="{not($is-new-form)}"  -->
                <xxf:dialog id="dialog" close="false" class="fb-dialog-form-settings">
                    <!-- Dialog title -->
                    <xf:label
                        value="
                            if ($is-new-form) then
                                (: No title in this case :)
                                ()
                            else if (xxf:non-blank($i/for-button-name)) then
                                (: The action must match a process button and we use the associated text label if present :)
                                let $r := xxf:r(concat('buttons.', $i/for-button-name), '|fr-fr-resources|')
                                return
                                    if (exists($r)) then
                                        frf:removeHtmlTags($r)
                                    else
                                        $resources/dialog-form-settings/label
                            else
                                (: Case of form settings :)
                                $resources/dialog-form-settings/label"/>

                    <!-- Expose mode to CSS -->
                    <xh:div class="fb-settings-mode-{{mode}}">
                        <!-- IE warning -->
                        <!-- TODO: i18n -->
                        <xf:group
                            ref=".[$is-new-form and xxf:instance('fb-user-agent-instance')/is-supported-browser = 'false']"
                            class="fb-ie-warning alert alert-error">

                            It appears that you are using
                            <xf:output value="xxf:instance('fb-user-agent-instance')/browser-name"/>.
                            Form Builder is likely not working properly with this browser. We recommend you upgrade to
                            <xf:output
                                xmlns:BrowserVersion="java:org.orbeon.builder.BrowserVersion"
                                value="BrowserVersion:MinimalMicrosoftBrowserNameAndVersion()"/>
                            or newer, or use
                            <a href="http://www.google.com/chrome">Google Chrome</a>,
                            <a href="http://www.mozilla.com/firefox/">Firefox</a>,
                            or
                            <a href="http://www.apple.com/safari/">Safari</a>.
                            If we made a mistake and you are not using
                            <xf:output value="xxf:instance('fb-user-agent-instance')/browser-name"/>,
                            please
                            <a href="mailto:info@orbeon.com?subject=Form Builder Microsoft Browser Version">let us know</a>.
                        </xf:group>

                        <!-- Show a number "icon" in new mode only -->
                        <xf:output
                            class="icon"
                            value="
                                if ($is-new-form) then
                                    if (instance('navigation') = 'templates') then
                                        1
                                    else
                                        2
                                 else
                                    ()"/>

                        <fb:language-choice ref="$i/lang[not($is-new-form)]"/>

                        <fr:tabbable id="fb-tabbable" class="fb-dialog-form-settings-fields">
                            <fr:tab visible="$is-new-form">

                                <xh:p class="alert alert-info">
                                    <xf:output value="$resources/messages/select-template-output"/>
                                </xh:p>

                                <xf:var
                                    name="lang"
                                    value="fr:lang()"/>

                                <!-- Make this an `xf:group` so we can focus on it -->
                                <xf:group xxf:element="div" class="fb-template-cards-container" id="fb-template-cards-container">
                                    <xh:div class="fb-template-cards">

                                        <xf:repeat ref="instance('template-forms')/*" id="form-template-repeat">
                                            <xh:div class="fb-template-card {if (position() le 2) then 'fb-builtin-template' else ()}" title="{{title}}">
                                                <xf:output class="fb-template-title" value="(title[@xml:lang = $lang], title)[1]"/>
                                                <xf:output class="fb-template-thumbnail" mediatype="image/*" ref="thumbnail[xxf:non-blank()]"/>
                                            </xh:div>
                                        </xf:repeat>
                                        <!-- If the user selects a template, and there is an app name associated,
                                             then set the app name to the selected template's app name. This makes
                                             sense because the user is more likely to be creating a form in an app
                                             that matches the template's app. The user can change this later.

                                             The user can have access to any app, or to a specific set. The search
                                             only searches for and returns templates from apps the user has access
                                             to. So it is safe to use those app names here.

                                             Some templates are in no app (like the "blank" template), which means
                                             they are global. If the user changes between a template with an app,
                                             and then a template without an app, we don't want the new app to be
                                             sticky. So we restore it to the original app. This makes sense because
                                             the user cannot directly change the app name in `new` mode.

                                             UPDATE: We only set the app name if the user only has access to a limited
                                             number of apps using `form-builder-permissions.xml`. We think that it might
                                             be too confusing to automatically set an app name in the general case.
                                        -->
                                        <xf:setvalue
                                            event="xxforms-index-changed"
                                            observer="form-template-repeat"
                                            if="$app-chooser = ('select1', 'output')"

                                            ref="$i/app"
                                            value="
                                                (
                                                    (: Selected app if present :)
                                                    instance('template-forms')/*[event('xxf:new-index')]/app[xxf:non-blank()]/string(),
                                                    (: Original app passed when the dialog opened otherwise :)
                                                    $i/original-app
                                                )[1]"/>
                                    </xh:div>
                                </xf:group>

                                <!-- Languages are not separated, so we cannot see the description in the current language :( -->
                                <xf:var
                                    name="description-opt"
                                    value="
                                        let $descriptions := instance('template-forms')/*[index('form-template-repeat')]/description[xxf:non-blank()]
                                        return
                                            ($descriptions[@xml:lang = $lang], $descriptions)[1]/xxf:trim()"/>

                                <!-- Same heuristic as in the Form Builder Summary page -->
                                <xf:group
                                    xxf:element="div"
                                    ref="$description-opt"
                                    class="alert fb-form-description">

                                    <xf:var name="is-html" value="starts-with(., '&lt;div')"/>
                                    <xf:output value=".[    $is-html ]" mediatype="text/html"/>
                                    <xf:output value=".[not($is-html)]"                      />
                                </xf:group>

                            </fr:tab>

                            <fr:tab visible="$is-new-form or $is-app-form or $is-form-settings">
<!--                            <fr:tab visible="$is-app-form or $is-form-settings">-->
                                <fr:label ref="$resources/general-settings[$is-form-settings]"/>

                                <xh:div class="alert alert-{{if ($is-new-form or $is-form-settings) then 'info' else 'error'}}">
                                    <xf:output
                                        value="if ($is-app-form) then $resources/messages/app-form-required else $resources/messages/app-form-optional"
                                        mediatype="text/html"/>
                                </xh:div>

                                <fr:grid id="fb-general-settings-grid">
                                    <fr:c x="1" y="1" w="6" h="1">
                                        <!-- Application name -->
                                        <!-- Use an input if app name is a wildcard -->
                                        <xf:input ref="app[$app-chooser = 'input']" id="fb-app-name-input" xxf:autocomplete="off" autofocus="true" incremental="true">
                                            <xf:label ref="$resources/application-name/label"/>
                                            <xf:hint ref="$resources/application-name/hint"/>
                                            <xf:help ref="$resources/application-name/help" mediatype="text/html"/>
                                            <xf:alert ref="$resources/application-name/alert"/>
                                        </xf:input>
                                        <!-- Otherwise, if there are multiple choices, use a dropdown -->
                                        <fr:dropdown-select1 ref="app[$app-chooser = 'select1']" id="fb-app-name-select1">
                                            <xf:label ref="$resources/application-name/label"/>
                                            <xf:itemset ref="$allowed-apps-if-has-roles">
                                                <xf:label ref="."/>
                                                <xf:value ref="."/>
                                            </xf:itemset>
                                        </fr:dropdown-select1>
                                        <!-- Otherwise, if there is just one choice, just show what the value will be -->
                                        <xf:output ref="app[$app-chooser = 'output']">
                                            <xf:label ref="$resources/application-name/label"/>
                                        </xf:output>
                                    </fr:c>
                                    <fr:c x="7" y="1" w="6" h="1">
                                        <!-- Form name -->
                                        <xf:input ref="form" id="fb-form-name-input" xxf:autocomplete="off" incremental="true">
                                            <xf:label ref="$resources/form-name/label"/>
                                            <xf:hint ref="$resources/form-name/hint"/>
                                            <xf:help ref="$resources/form-name/help" mediatype="text/html"/>
                                            <xf:alert ref="$resources/form-name/alert" level="error"/>
                                        </xf:input>
                                    </fr:c>
                                    <fr:c x="1" y="2" w="12" h="1">
                                        <xh:div class="fb-info-alerts">
                                            <xf:alert
                                                id="no-form-alert-external"
                                                for="fb-form-name-input"
                                                validation="no-form-alert-constraint"
                                                value="xxf:r('form-name.no-form-alert', '|fr-form-resources|')"/>
                                            <xf:alert
                                                id="form-published-alert-external"
                                                for="fb-form-name-input"
                                                validation="form-published-constraint"
                                                mediatype="text/html"
                                                value="
                                                    xxf:format-message(
                                                        xxf:r('form-name.form-published-alert', '|fr-form-resources|'),
                                                        (
                                                            instance('fr-counts-instance')/published-forms/xs:integer(.),
                                                            concat(
                                                                '/fr/admin?fr-search-app=exact:',
                                                                bind('app-bind'),
                                                                '&amp;fr-search-form=exact:',
                                                                bind('form-bind')
                                                            )
                                                        )
                                                    )"/>
                                            <xf:alert
                                                id="form-in-progress-alert-external"
                                                for="fb-form-name-input"
                                                validation="form-in-progress-constraint"
                                                mediatype="text/html"
                                                value="
                                                    xxf:format-message(
                                                        xxf:r('form-name.form-in-progress-alert', '|fr-form-resources|'),
                                                        (
                                                            instance('fr-counts-instance')/in-progress-forms/xs:integer(.),
                                                            concat(
                                                                '/fr/orbeon/builder/summary?fr-search-app=exact:',
                                                                bind('app-bind'),
                                                                '&amp;fr-search-form=exact:',
                                                                bind('form-bind')
                                                            )
                                                        )
                                                    )"/>
                                        </xh:div>
                                    </fr:c>
                                    <fr:c x="1" y="3" w="12" h="1">
                                        <!-- Title -->
                                        <xf:input ref="title[@xml:lang = $i/lang]" id="fb-title-input" xxf:autocomplete="off">
                                            <xf:label ref="$resources/title/label"/>
                                            <xf:hint ref="$resources/title/hint"/>
                                            <xf:alert ref="$resources/title/alert"/>
                                        </xf:input>
                                    </fr:c>
                                    <fr:c x="1" y="4" w="12" h="1">
                                        <xf:textarea ref="description[@xml:lang = $i/lang][not(@mediatype = 'text/html')]" id="fb-description-textarea">
                                            <xf:label ref="$resources/description/label"/>
                                            <xf:hint ref="$resources/description/hint"/>
                                            <xf:alert ref="$resources/description/alert"/>
                                        </xf:textarea>
                                        <xf:textarea mediatype="text/html" ref="description[@xml:lang = $i/lang][@mediatype = 'text/html']">
                                            <xf:label ref="$resources/description/label"/>
                                            <xf:hint ref="$resources/description/hint"/>
                                            <xf:alert ref="$resources/description/alert"/>
                                        </xf:textarea>
                                    </fr:c>
                                    <fr:c x="1" y="5" w="12" h="1">
                                        <fr:checkbox-input
                                            ref="description[@xml:lang = $i/lang]/@mediatype"
                                            appearance="full"
                                            selected-value="text/html"
                                            deselected-value="text/plain">
                                            <xf:label ref="$resources/dialog-control-settings/use-html"/>
                                        </fr:checkbox-input>
                                    </fr:c>
                                </fr:grid>
                            </fr:tab>

                            <!-- Options -->
                            <fr:tab class="fb-dialog-form-settings-options" visible="$is-form-settings">
                                <fr:label value="$resources/dialog-form-settings/options"/>

                                <fr:grid>
                                    <xh:tr>
                                        <xh:td>
                                            <fr:checkbox-input ref="singleton" id="fb-singleton-input">
                                                <xf:label ref="$resources/dialog-form-settings/singleton/label"/>
                                                <xf:hint  ref="$resources/dialog-form-settings/singleton/hint"/>
                                            </fr:checkbox-input>
                                        </xh:td>
                                        <xh:td>
                                            <fr:checkbox-input ref="allow-template-use" id="fb-allow-template-use-input">
                                                <xf:label ref="$resources/dialog-form-settings/allow-template-use/label"/>
                                                <xf:hint  ref="$resources/dialog-form-settings/allow-template-use/hint"/>
                                            </fr:checkbox-input>
                                        </xh:td>
                                    </xh:tr>
                                    <xh:tr>
                                        <xh:td>
                                            <xf:select1 ref="data-migration" appearance="full xxf:horizontal">
                                                <xf:label ref="$resources/dialog-form-settings/data-migration/label"/>
                                                <xf:hint  ref="$resources/dialog-form-settings/data-migration/hint"/>
                                                <xf:itemset ref="$resources/dialog-form-settings/data-migration/item">
                                                    <xf:label ref="."/>
                                                    <xf:value
                                                            ref="
                                                            if (@id = 0) then
                                                                'default'
                                                            else if (@id = 1) then
                                                                'enabled'
                                                            else if (@id = 2) then
                                                                'disabled'
                                                            else
                                                                'error'"/>
                                                </xf:itemset>
                                            </xf:select1>
                                        </xh:td>
                                        <xh:td>
                                            <xf:select1 ref="grid-tab-order" appearance="full xxf:horizontal">
                                                <xf:label ref="$resources/dialog-form-settings/grid-tab-order/label"/>
                                                <xf:hint  ref="$resources/dialog-form-settings/grid-tab-order/hint"/>
                                                <xf:itemset ref="$resources/dialog-form-settings/grid-tab-order/item">
                                                    <xf:label ref="."/>
                                                    <xf:value
                                                            ref="
                                                        if (@id = 0) then
                                                            'default'
                                                        else if (@id = 1) then
                                                            'rows'
                                                        else
                                                            'columns'"/>
                                                </xf:itemset>
                                            </xf:select1>
                                        </xh:td>
                                    </xh:tr>
                                    <xh:tr>
                                        <xh:td>
                                            <fr:open-select1
                                                ref="attachment-max-size-per-file"
                                                appearance="full xxf:horizontal"
                                                type="integer"
                                                suffix="bytes"
                                                class="fb-attachment-max-size-per-file-control">

                                                <xf:label ref="$resources/dialog-form-settings/attachment-max-size-per-file/label"/>
                                                <xf:hint  ref="$resources/dialog-form-settings/attachment-max-size-per-file/hint"/>
                                                <xf:itemset ref="$resources/property-yes-no/item[@id = 0]">
                                                    <xf:label ref="."/>
                                                    <xf:value>-2</xf:value>
                                                </xf:itemset>
                                            </fr:open-select1>
                                        </xh:td>
                                        <xh:td>
                                            <fr:open-select1
                                                ref="attachment-max-size-aggregate-per-form"
                                                appearance="full xxf:horizontal"
                                                type="integer"
                                                suffix="bytes"
                                                class="fb-attachment-max-size-aggregate-per-form-control">

                                                <xf:label ref="$resources/dialog-form-settings/attachment-max-size-aggregate-per-form/label"/>
                                                <xf:hint  ref="$resources/dialog-form-settings/attachment-max-size-aggregate-per-form/hint"/>
                                                <xf:itemset ref="$resources/property-yes-no/item[@id = 0]">
                                                    <xf:label ref="."/>
                                                    <xf:value>-2</xf:value>
                                                </xf:itemset>
                                            </fr:open-select1>
                                        </xh:td>
                                    </xh:tr>
                                    <xh:tr>
                                        <xh:td>
                                            <fr:open-select1
                                                ref="attachment-max-files-per-control"
                                                appearance="full xxf:horizontal"
                                                type="integer"
                                                class="fb-attachment-max-files-per-control">

                                                <xf:label ref="$resources/dialog-form-settings/attachment-max-files-per-control/label"/>
                                                <xf:hint  ref="$resources/dialog-form-settings/attachment-max-files-per-control/hint"/>
                                                <xf:itemset ref="$resources/property-yes-no/item[@id = 0]">
                                                    <xf:label ref="."/>
                                                    <xf:value>-2</xf:value>
                                                </xf:itemset>
                                            </fr:open-select1>
                                        </xh:td>
                                        <xh:td>
                                            <fr:open-select1
                                                ref="attachment-mediatypes"
                                                appearance="full xxf:horizontal"
                                                class="fb-attachment-mediatypes-control">

                                                <xf:label ref="$resources/dialog-form-settings/attachment-mediatypes/label"/>
                                                <xf:hint  ref="$resources/dialog-form-settings/attachment-mediatypes/hint"/>
                                                <xf:itemset ref="$resources/property-yes-no/item[@id = 0]">
                                                    <xf:label ref="."/>
                                                    <xf:value value="$unlikely-mediatype"/>
                                                </xf:itemset>
                                            </fr:open-select1>
                                        </xh:td>
                                    </xh:tr>
                                    <xh:tr>
                                        <xh:td>
                                            <xf:select1 ref="automatic-hints" appearance="full xxf:horizontal">
                                                <xf:label ref="$resources/dialog-form-settings/automatic-hints/label"/>
                                                <xf:itemset ref="$resources/property-yes-no/item">
                                                    <xf:label ref="."/>
                                                    <xf:value ref="if (@id = 0) then 'default' else if (@id = 1) then 'true' else 'false'"/>
                                                </xf:itemset>
                                            </xf:select1>
                                        </xh:td>
                                        <xh:td/>
                                    </xh:tr>
                                </fr:grid>

                            </fr:tab>

                            <fr:tab class="fb-dialog-form-settings-control-options" visible="$is-form-settings">
                                <fr:label value="$resources/dialog-form-settings/control-settings"/>

                                <fr:tabbable
                                    appearance="left"
                                    readonly="true"
                                    id="fb-control-settings-tabbable"
                                    ref="instance('control-details-metadata')">
                                    <fr:tab ref="instance('control-details-metadata')/*:metadata">
                                        <xf:label value="(*:display-name[@lang = frf:currentLang()], *:display-name)[1]"/>

                                        <xf:var name="i" value="count(preceding-sibling::fb:metadata) + 1"/>
                                        <xxf:dynamic ref="instance('dynamic')/*[$i]" id="custom-properties"/>

                                    </fr:tab>
                                </fr:tabbable>

                            </fr:tab>

                            <fr:tab class="fb-dialog-form-settings-view-options" visible="$is-form-settings">
                                <fr:label value="$resources/dialog-form-settings/view-options"/>

                                <fr:grid>
                                    <xh:tr>
                                        <xh:td>
                                            <xf:select1 ref="html-page-layout" appearance="full xxf:horizontal">
                                                <xf:label ref="$resources/dialog-form-settings/html-page-layout/label"/>
                                                <xf:hint  ref="$resources/dialog-form-settings/html-page-layout/hint"/>
                                                <xf:itemset ref="$resources/dialog-form-settings/html-page-layout/item">
                                                    <xf:label ref="."/>
                                                    <xf:value ref="
                                                             if (@id = 1) then 'fixed'
                                                        else if (@id = 2) then 'fluid'
                                                        else                   'default'"/>
                                                </xf:itemset>
                                            </xf:select1>
                                        </xh:td>
                                        <xh:td>
                                            <xf:select1 ref="density" appearance="full xxf:horizontal">
                                                <xf:label ref="$resources/dialog-form-settings/density/label"/>
                                                <xf:hint  ref="$resources/dialog-form-settings/density/hint"/>
                                                <xf:itemset ref="$resources/dialog-form-settings/density/item">
                                                    <xf:label ref="."/>
                                                    <xf:value ref="
                                                             if (@id = 1) then 'compact'
                                                        else if (@id = 2) then 'comfortable'
                                                        else if (@id = 3) then 'roomy'
                                                        else                   'default'"/>
                                                </xf:itemset>
                                            </xf:select1>
                                        </xh:td>
                                    </xh:tr>
                                    <xh:tr>
                                        <xh:td>
                                            <xf:select1 ref="labels" appearance="full xxf:horizontal">
                                                <xf:label ref="$resources/dialog-form-settings/labels/label"/>
                                                <xf:hint  ref="$resources/dialog-form-settings/labels/hint"/>
                                                <xf:itemset ref="$resources/dialog-form-settings/appearances/item[@id != 2]">
                                                    <xf:label ref="."/>
                                                    <xf:value
                                                            ref="
                                                            if (@id = 0) then
                                                                'default'
                                                            else
                                                                'full'"/>
                                                </xf:itemset>
                                            </xf:select1>
                                        </xh:td>
                                        <xh:td>
                                            <xf:select1 ref="hints" appearance="full xxf:horizontal">
                                                <xf:label ref="$resources/dialog-form-settings/hints/label"/>
                                                <xf:hint  ref="$resources/dialog-form-settings/hints/hint"/>
                                                <xf:itemset ref="$resources/dialog-form-settings/appearances/item">
                                                    <xf:label ref="."/>
                                                    <xf:value
                                                            ref="
                                                            if (@id = 0) then
                                                                'default'
                                                            else if (@id = 1) then
                                                                'full'
                                                            else
                                                                'tooltip'"/>
                                                </xf:itemset>
                                            </xf:select1>
                                        </xh:td>
                                    </xh:tr>
                                    <xh:tr>
                                        <xh:td>
                                            <fr:checkbox-input ref="labels-placeholders" class="fb-labels-placeholders">
                                                <xf:label ref="$resources/dialog-form-settings/placeholders/label"/>
                                                <xf:hint  ref="$resources/dialog-form-settings/placeholders/hint"/>
                                                <xf:setvalue
                                                        event="xforms-value-changed"
                                                        if="event('xxf:value') = 'true'"
                                                        ref="../hints-placeholders"
                                                        value="false()"
                                                />
                                            </fr:checkbox-input>
                                        </xh:td>
                                        <xh:td>
                                            <fr:checkbox-input ref="hints-placeholders" class="fb-hints-placeholders">
                                                <xf:label ref="$resources/dialog-form-settings/placeholders/label"/>
                                                <xf:hint  ref="$resources/dialog-form-settings/placeholders/hint"/>
                                                <xf:setvalue
                                                        event="xforms-value-changed"
                                                        if="event('xxf:value') = 'true'"
                                                        ref="../labels-placeholders"
                                                        value="false()"
                                                />
                                            </fr:checkbox-input>
                                        </xh:td>
                                    </xh:tr>
                                </fr:grid>
                            </fr:tab>

                            <fr:tab class="fb-dialog-form-settings-wizard-options" visible="$is-form-settings">
                                <fr:label value="$resources/dialog-form-settings/wizard-options"/>

                                <fr:grid>
                                    <xh:tr>
                                        <xh:td>
                                            <xf:select1 ref="wizard" appearance="full xxf:horizontal">
                                                <xf:label ref="$resources/dialog-form-settings/wizard/label"/>
                                                <xf:hint  ref="$resources/dialog-form-settings/wizard/hint"/>
                                                <xf:itemset ref="$resources/property-yes-no/item">
                                                    <xf:label ref="."/>
                                                    <xf:value ref="if (@id = 0) then 'default' else if (@id = 1) then 'true' else 'false'"/>
                                                </xf:itemset>
                                            </xf:select1>
                                        </xh:td>
                                        <xh:td>
                                            <xf:select1 ref="wizard-mode" appearance="full xxf:horizontal">
                                                <xf:label ref="$resources/dialog-form-settings/wizard-mode/label"/>
                                                <xf:hint  ref="$resources/dialog-form-settings/wizard-mode/hint"/>
                                                <xf:itemset ref="$resources/dialog-form-settings/wizard-mode/item">
                                                    <xf:label ref="."/>
                                                    <xf:value ref="
                                                             if (@id = 1) then 'free'
                                                        else if (@id = 2) then 'lax'
                                                        else if (@id = 3) then 'strict'
                                                        else                   'default'"/>
                                                </xf:itemset>
                                            </xf:select1>
                                        </xh:td>
                                    </xh:tr>
                                    <xh:tr>
                                        <xh:td>
                                            <xf:select1 ref="wizard-subsections-nav" appearance="full xxf:horizontal">
                                                <xf:label ref="$resources/dialog-form-settings/wizard-subsections-nav/label"/>
                                                <xf:hint  ref="$resources/dialog-form-settings/wizard-subsections-nav/hint"/>
                                                <xf:itemset ref="$resources/property-yes-no/item">
                                                    <xf:label ref="."/>
                                                    <xf:value ref="if (@id = 0) then 'default' else if (@id = 1) then 'true' else 'false'"/>
                                                </xf:itemset>
                                            </xf:select1>
                                        </xh:td>
                                        <xh:td rowspan="2">
                                            <xf:select1 ref="wizard-subsections-toc" appearance="full">
                                                <xf:label ref="$resources/dialog-form-settings/wizard-subsections-toc/label"/>
                                                <xf:hint  ref="$resources/dialog-form-settings/wizard-subsections-toc/hint"/>
                                                <xf:itemset ref="$resources/dialog-form-settings/wizard-subsections-toc/item">
                                                    <xf:label ref="."/>
                                                    <xf:value ref="
                                                             if (@id = 1) then 'active'
                                                        else if (@id = 2) then 'all'
                                                        else if (@id = 3) then 'none'
                                                        else                   'default'"/>
                                                </xf:itemset>
                                            </xf:select1>
                                        </xh:td>
                                    </xh:tr>
                                    <xh:tr>
                                        <xh:td>
                                            <xf:select1 ref="wizard-separate-toc" appearance="full xxf:horizontal">
                                                <xf:label ref="$resources/dialog-form-settings/wizard-separate-toc/label"/>
                                                <xf:hint  ref="$resources/dialog-form-settings/wizard-separate-toc/hint"/>
                                                <xf:itemset ref="$resources/property-yes-no/item">
                                                    <xf:label ref="."/>
                                                    <xf:value ref="if (@id = 0) then 'default' else if (@id = 1) then 'true' else 'false'"/>
                                                </xf:itemset>
                                            </xf:select1>
                                        </xh:td>
                                    </xh:tr>
                                    <xh:tr>
                                        <xh:td>
                                            <xf:select1 ref="wizard-section-status" appearance="full xxf:horizontal">
                                                <xf:label ref="$resources/dialog-form-settings/wizard-section-status/label"/>
                                                <xf:hint  ref="$resources/dialog-form-settings/wizard-section-status/hint"/>
                                                <xf:itemset ref="$resources/property-yes-no/item">
                                                    <xf:label ref="."/>
                                                    <xf:value ref="if (@id = 0) then 'default' else if (@id = 1) then 'true' else 'false'"/>
                                                </xf:itemset>
                                            </xf:select1>
                                        </xh:td>
                                    </xh:tr>
                                </fr:grid>
                            </fr:tab>

                            <fr:tab class="fb-dialog-form-settings-pdf-options" visible="$is-form-settings">
                                <fr:label value="$resources/dialog-form-settings/pdf-options"/>

                                <fr:grid>
                                    <xh:tr>
                                        <xh:td>
                                            <xf:select1 ref="rendered-page-orientation" appearance="full xxf:horizontal">
                                                <xf:label ref="$resources/dialog-form-settings/rendered-page-orientation/label"/>
                                                <xf:hint  ref="$resources/dialog-form-settings/rendered-page-orientation/hint"/>
                                                <xf:itemset ref="$resources/dialog-form-settings/rendered-page-orientation/item">
                                                    <xf:label ref="."/>
                                                    <xf:value ref="@id"/>
                                                </xf:itemset>
                                            </xf:select1>
                                        </xh:td>
                                    </xh:tr>
                                    <xh:tr>
                                        <xh:td>
                                            <xf:select1 ref="rendered-page-size" appearance="full xxf:horizontal">
                                                <xf:label ref="$resources/dialog-form-settings/rendered-page-size/label"/>
                                                <xf:hint  ref="$resources/dialog-form-settings/rendered-page-size/hint"/>
                                                <xf:itemset ref="$resources/dialog-form-settings/rendered-page-size/item">
                                                    <xf:label ref="."/>
                                                    <xf:value ref="@id"/>
                                                </xf:itemset>
                                            </xf:select1>
                                        </xh:td>
                                    </xh:tr>
                                </fr:grid>
                            </fr:tab>

                            <!-- Formulas -->
                            <fr:tab visible="$is-form-settings">
                                <fr:label ref="$resources/dialog-control-settings/tab-formulas/label"/>
                                <fr:grid>
                                    <xh:tr>
                                        <xh:td>
                                            <xf:select1 ref="readonly-disable-calculate" appearance="full xxf:horizontal">
                                                <xf:label ref="$resources/dialog-form-settings/readonly-disable-calculate/label"/>
                                                <xf:hint  ref="$resources/dialog-form-settings/readonly-disable-calculate/hint"/>
                                                <xf:itemset ref="$resources/dialog-form-settings/readonly-disable-calculate/item">
                                                    <xf:label ref="."/>
                                                    <xf:value ref="@id"/>
                                                </xf:itemset>
                                            </xf:select1>
                                        </xh:td>
                                    </xh:tr>
                                    <xh:tr>
                                        <xh:td>
                                            <fb:boolean-or-formula ref="readonly">
                                                <xf:label ref="$resources/dialog-control-settings/readonly/label"/>
                                                <xf:hint  ref="$resources/dialog-control-settings/readonly/hint"/>
                                            </fb:boolean-or-formula>
                                        </xh:td>
<!--                                        <xh:td>-->
<!--                                            <fb:boolean-or-formula ref="relevant">-->
<!--                                                <xf:label ref="$resources/dialog-control-settings/visibility/label"/>-->
<!--                                                <xf:hint  ref="$resources/dialog-control-settings/visibility/hint"/>-->
<!--                                            </fb:boolean-or-formula>-->
<!--                                        </xh:td>-->
                                    </xh:tr>
                                    <xh:tr>
                                        <xh:td>
                                            <xf:select1 ref="analysis-calculate" appearance="full xxf:horizontal">
                                                <xf:label ref="$resources/dialog-form-settings/analysis-calculate/label"/>
                                                <xf:hint  ref="$resources/dialog-form-settings/analysis-calculate/hint"/>
                                                <xf:itemset ref="$resources/property-yes-no/item">
                                                    <xf:label ref="."/>
                                                    <xf:value ref="if (@id = 0) then 'default' else if (@id = 1) then 'true' else 'false'"/>
                                                </xf:itemset>
                                            </xf:select1>
                                        </xh:td>
                                    </xh:tr>
                                </fr:grid>
                            </fr:tab>

                            <!-- About -->
                            <fr:tab visible="$is-form-settings">
                                <fr:label value="$resources/dialog-form-settings/about"/>

                                <xh:div class="fb-dialog-form-settings-info">

                                    <xf:group class="fb-dialog-form-settings-info-versions">
                                        <xf:label value="$resources/dialog-form-settings/versions"/>

                                        <fr:grid>
                                            <xh:tr>
                                                <xh:td>
                                                    <xf:output value="$i/created-with-version">
                                                        <xf:label value="$resources/dialog-form-settings/created-with-version"/>
                                                    </xf:output>
                                                </xh:td>
                                            </xh:tr>
                                            <xh:tr>
                                                <xh:td>
                                                    <xf:output ref="$i/updated-with-versions">
                                                        <xf:label value="$resources/dialog-form-settings/updated-with-versions"/>
                                                    </xf:output>
                                                </xh:td>
                                            </xh:tr>
                                            <xh:tr>
                                                <xh:td>
                                                    <xf:output
                                                        xmlns:version="java:org.orbeon.oxf.common.Version"
                                                        value="version:versionWithEdition()">
                                                        <xf:label value="$resources/dialog-form-settings/current-version"/>
                                                    </xf:output>
                                                </xh:td>
                                            </xh:tr>
                                        </fr:grid>
                                    </xf:group>

                                    <fr:image-attachment ref="thumbnail" class="fb-dialog-form-settings-thumbnail">
                                        <xf:label ref="$resources/dialog-form-settings/thumbnail/label"/>
                                        <xf:hint  ref="$resources/dialog-form-settings/thumbnail/hint"/>
                                    </fr:image-attachment>

                                    <xf:group class="fb-dialog-form-settings-info-stats">
                                        <xf:label value="$resources/dialog-form-settings/stats"/>

                                        <xf:var
                                            name="labels"
                                            value="
                                                $resources/dialog-form-settings/(
                                                    sections, repeats, grids, section-templates, controls, all
                                                )
                                        "/>
                                        <xf:var
                                            name="counts"
                                            value="
                                                fbf:countSections($body),
                                                fbf:countRepeats($body),
                                                fbf:countGrids($body),
                                                fbf:countSectionTemplates($body),
                                                fbf:countAllNonContainers($body),
                                                fbf:countAllControls($body)
                                        "/>
                                        <xh:table class="table table-condensed">
                                            <xf:repeat ref="1 to count($labels)">
                                                <xf:var name="i" value="position()"/>
                                                <xh:tr>
                                                    <xh:th><xf:output value="$labels[$i]"/></xh:th>
                                                    <xh:td><xf:output value="$counts[$i]"/></xh:td>
                                                </xh:tr>
                                            </xf:repeat>
                                        </xh:table>
                                    </xf:group>
                                </xh:div>

                            </fr:tab>

                            <!-- Custom -->
                            <xsl:variable
                                xmlns:p="http://www.orbeon.com/oxf/pipeline"
                                name="custom-form-settings"
                                as="xs:string?"
                                select="p:trim(p:property('oxf.fb.extension.form-settings'))[p:non-blank()]"/>

                            <xsl:if test="$custom-form-settings">

                                <xsl:variable
                                    name="prefix"
                                    as="xs:string"
                                    select="substring-before($custom-form-settings, ':')"/>

                                <xsl:variable
                                    xmlns:p="http://www.orbeon.com/oxf/pipeline"
                                    name="namespace-uri"
                                    as="xs:string"
                                    select="p:property(concat('oxf.xforms.xbl.mapping.', $prefix))"/>

                                <fr:tab visible="not($is-new-form)">
                                    <fr:label ref="$resources/custom-settings"/>
                                    <xsl:element name="{$custom-form-settings}" namespace="{$namespace-uri}">
                                        <xsl:attribute name="id" select="'fb-custom-form-settings'"/>
                                    </xsl:element>
                                </fr:tab>
                            </xsl:if>

                        </fr:tabbable>

                        <fr:error-summary id="error-summary" observer="fb-tabbable" valid-ref="$i/@valid" lowest-level-to-show="warning">
                            <fr:label><xf:output value="xxf:r('errors.label', '|fr-form-resources|')"/></fr:label>
                        </fr:error-summary>

                    </xh:div>

                    <!-- See https://github.com/orbeon/orbeon-forms/issues/2337 -->
                    <xh:div class="fr-dialog-buttons" xml:space="preserve">
                        <!-- `autofocus="true"` so we can press ↵ on the template selection screen,
                             otherwise the scrollable `tab-content` gets the focus -->
                        <xf:trigger id="fb-continue-button" appearance="xxf:primary" autofocus="true">
                            <xf:label mediatype="text/html" value="$resources/(if ($is-new-form or $is-app-form) then continue else apply)/label"/>
                        </xf:trigger>
                        <xf:output value="$resources/or/label"/>
                        <xf:trigger appearance="minimal">
                            <xf:label mediatype="text/html" value="$resources/(if ($is-new-form) then back-to-summary else cancel)/label"/>
                            <!-- Hide this dialog without saving -->
                            <xxf:hide
                                event="DOMActivate"
                                if="not($is-new-form)"
                                dialog="dialog"/>
                            <!-- Or go back to the list of forms-->
                            <xf:action
                                event="DOMActivate"
                                if="$is-new-form"
                                type="xpath">
                                fr:run-process-by-name('oxf.fr.detail.process', 'close')
                            </xf:action>
                        </xf:trigger>
                    </xh:div>
                </xxf:dialog>
            </xf:group>
        </xbl:template>
    </xbl:binding>
</xbl:xbl>
