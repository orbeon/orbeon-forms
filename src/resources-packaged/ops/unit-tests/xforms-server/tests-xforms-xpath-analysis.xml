<!--
  Copyright (C) 2010 Orbeon, Inc.

  This program is free software; you can redistribute it and/or modify it under the terms of the
  GNU Lesser General Public License as published by the Free Software Foundation; either version
  2.1 of the License, or (at your option) any later version.

  This program is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY;
  without even the implied warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.
  See the GNU Lesser General Public License for more details.

  The full text of the license is available at http://www.gnu.org/copyleft/lesser.html
  -->
<group description="XForms XPath Analysis" xmlns:p="http://www.orbeon.com/oxf/pipeline"
    xmlns:xsl="http://www.w3.org/1999/XSL/Transform"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xmlns:xs="http://www.w3.org/2001/XMLSchema"
    xmlns:xh="http://www.w3.org/1999/xhtml"
    xmlns:oxf="http://www.orbeon.com/oxf/processors"
    xmlns:xi="http://www.w3.org/2001/XInclude"
    xmlns:xxi="http://orbeon.org/oxf/xml/xinclude"
    xmlns:xf="http://www.w3.org/2002/xforms"
    xmlns:ev="http://www.w3.org/2001/xml-events"
    xmlns:xbl="http://www.w3.org/ns/xbl"
    xmlns:fr="http://orbeon.org/oxf/xml/form-runner">

    <test description="Simple xforms:bind dependencies" name="oxf:java">
        <input name="config">
            <config sourcepath="oxf:/" class="org.orbeon.oxf.xforms.analysis.XPathAnalysisProcessor"/>
        </input>
        <input name="form">
            <xh:html xmlns:xxf="http://orbeon.org/oxf/xml/xforms">
                <xh:head>
                    <xf:model id="model" xxf:xpath-analysis="true">
                        <xf:instance id="i1">
                            <instance/>
                        </xf:instance>
                        <xf:instance id="i2">
                            <instance/>
                        </xf:instance>
                        <xf:instance id="i3">
                            <instance/>
                        </xf:instance>
                        <xf:instance id="i4">
                            <instance/>
                        </xf:instance>
                        <xf:instance id="i5">
                            <instance/>
                        </xf:instance>
                        <xf:instance id="i6">
                            <instance/>
                        </xf:instance>
                        <xf:instance id="i7">
                            <instance/>
                        </xf:instance>

                        <xf:bind ref="instance('i1')" id="bv1" type="xs:integer"/>
                        <xf:bind ref="instance('i2')" id="bv2" constraint="true()"/>
                        <xf:bind ref="instance('i3')" id="bv3" required="true()"/>

                        <xf:bind ref="instance('i4')" id="bc1" relevant="false()"/>
                        <xf:bind ref="instance('i5')" id="bc2" calculate="42"/>
                        <xf:bind ref="instance('i6')" id="bc3" readonly="true()"/>
                        <xf:bind ref="instance('i7')" id="bc4" xxf:default="42"/>

                    </xf:model>
                </xh:head>
                <xh:body/>
            </xh:html>
        </input>
        <output name="analysis">
            <request request-uri="/orbeon/doc/home-welcome" query-string="id=12&amp;print=false" method="GET">
                <model scope="" prefixed-id="model" default-instance-prefixed-id="i1" analyzed-binds="true">
                    <binds>
                        <bind id="bv1" ref="instance('i1')">
                            <binding>
                                <analysis expression="instance('i1')" analyzed="true">
                                    <returnable>
                                        <path>instance('i1')</path>
                                    </returnable>
                                    <dependent-models>
                                        <model>model</model>
                                    </dependent-models>
                                    <dependent-instances>
                                        <instance>i1</instance>
                                    </dependent-instances>
                                    <returnable-instances>
                                        <instance>i1</instance>
                                    </returnable-instances>
                                </analysis>
                            </binding>
                            <value>
                                <analysis expression="xs:string(.[1])" analyzed="true">
                                    <value-dependent>
                                        <path>instance('i1')</path>
                                    </value-dependent>
                                    <dependent-models>
                                        <model>model</model>
                                    </dependent-models>
                                    <dependent-instances>
                                        <instance>i1</instance>
                                    </dependent-instances>
                                </analysis>
                            </value>
                        </bind>
                        <bind id="bv2" ref="instance('i2')">
                            <binding>
                                <analysis expression="instance('i2')" analyzed="true">
                                    <returnable>
                                        <path>instance('i2')</path>
                                    </returnable>
                                    <dependent-models>
                                        <model>model</model>
                                    </dependent-models>
                                    <dependent-instances>
                                        <instance>i2</instance>
                                    </dependent-instances>
                                    <returnable-instances>
                                        <instance>i2</instance>
                                    </returnable-instances>
                                </analysis>
                            </binding>
                            <mip name="constraint" expression="true()">
                                <analysis expression="xs:boolean((true())[1])" analyzed="true"/>
                            </mip>
                        </bind>
                        <bind id="bv3" ref="instance('i3')">
                            <binding>
                                <analysis expression="instance('i3')" analyzed="true">
                                    <returnable>
                                        <path>instance('i3')</path>
                                    </returnable>
                                    <dependent-models>
                                        <model>model</model>
                                    </dependent-models>
                                    <dependent-instances>
                                        <instance>i3</instance>
                                    </dependent-instances>
                                    <returnable-instances>
                                        <instance>i3</instance>
                                    </returnable-instances>
                                </analysis>
                            </binding>
                            <mip name="required" expression="true()">
                                <analysis expression="xs:boolean((true())[1])" analyzed="true"/>
                            </mip>
                        </bind>
                        <bind id="bc1" ref="instance('i4')">
                            <binding>
                                <analysis expression="instance('i4')" analyzed="true">
                                    <returnable>
                                        <path>instance('i4')</path>
                                    </returnable>
                                    <dependent-models>
                                        <model>model</model>
                                    </dependent-models>
                                    <dependent-instances>
                                        <instance>i4</instance>
                                    </dependent-instances>
                                    <returnable-instances>
                                        <instance>i4</instance>
                                    </returnable-instances>
                                </analysis>
                            </binding>
                            <mip name="relevant" expression="false()">
                                <analysis expression="xs:boolean((false())[1])" analyzed="true"/>
                            </mip>
                        </bind>
                        <bind id="bc2" ref="instance('i5')">
                            <binding>
                                <analysis expression="instance('i5')" analyzed="true">
                                    <returnable>
                                        <path>instance('i5')</path>
                                    </returnable>
                                    <dependent-models>
                                        <model>model</model>
                                    </dependent-models>
                                    <dependent-instances>
                                        <instance>i5</instance>
                                    </dependent-instances>
                                    <returnable-instances>
                                        <instance>i5</instance>
                                    </returnable-instances>
                                </analysis>
                            </binding>
                            <mip name="calculate" expression="42">
                                <analysis expression="xs:string((42)[1])" analyzed="true"/>
                            </mip>
                        </bind>
                        <bind id="bc3" ref="instance('i6')">
                            <binding>
                                <analysis expression="instance('i6')" analyzed="true">
                                    <returnable>
                                        <path>instance('i6')</path>
                                    </returnable>
                                    <dependent-models>
                                        <model>model</model>
                                    </dependent-models>
                                    <dependent-instances>
                                        <instance>i6</instance>
                                    </dependent-instances>
                                    <returnable-instances>
                                        <instance>i6</instance>
                                    </returnable-instances>
                                </analysis>
                            </binding>
                            <mip name="readonly" expression="true()">
                                <analysis expression="xs:boolean((true())[1])" analyzed="true"/>
                            </mip>
                        </bind>
                        <bind id="bc4" ref="instance('i7')">
                            <binding>
                                <analysis expression="instance('i7')" analyzed="true">
                                    <returnable>
                                        <path>instance('i7')</path>
                                    </returnable>
                                    <dependent-models>
                                        <model>model</model>
                                    </dependent-models>
                                    <dependent-instances>
                                        <instance>i7</instance>
                                    </dependent-instances>
                                    <returnable-instances>
                                        <instance>i7</instance>
                                    </returnable-instances>
                                </analysis>
                            </binding>
                            <mip name="initial-value" expression="42">
                                <analysis expression="xs:string((42)[1])" analyzed="true"/>
                            </mip>
                        </bind>
                    </binds>
                    <bind-instances>
                        <instance>i1</instance>
                        <instance>i2</instance>
                        <instance>i3</instance>
                        <instance>i4</instance>
                        <instance>i5</instance>
                        <instance>i6</instance>
                        <instance>i7</instance>
                    </bind-instances>
                    <computed-binds-instances>
                        <instance>i3</instance>
                        <instance>i4</instance>
                        <instance>i5</instance>
                        <instance>i6</instance>
                        <instance>i7</instance>
                    </computed-binds-instances>
                    <validation-binds-instances>
                        <instance>i1</instance>
                        <instance>i2</instance>
                        <instance>i3</instance>
                    </validation-binds-instances>
                </model>
            </request>
        </output>
    </test>

    <test description="MIP xforms:bind dependencies" name="oxf:java">
        <input name="config">
            <config sourcepath="oxf:/" class="org.orbeon.oxf.xforms.analysis.XPathAnalysisProcessor"/>
        </input>
        <input name="form">
            <xh:html xmlns:xxf="http://orbeon.org/oxf/xml/xforms">
                <xh:head>
                    <xf:model id="model" xxf:xpath-analysis="true">
                        <xf:instance id="i1">
                            <instance>
                                <a/>
                                <b/>
                                <c/>
                            </instance>
                        </xf:instance>

                        <xf:instance id="i2">
                            <instance>
                                <a/>
                                <b/>
                                <c/>
                            </instance>
                        </xf:instance>

                        <xf:bind id="b1" ref="instance('i1')">
                            <xf:bind id="b11" ref="a" constraint="../b = 'x'"/>
                            <xf:bind id="b12" ref="b" readonly="instance('i2')/a"/>
                            <xf:bind id="b13" ref="instance()/c" required=". = 'y'"/>
                            <xf:bind id="b14" context="a"/>
                        </xf:bind>
                        <xf:bind id="b2" ref="instance('i2')">
                            <xf:bind id="b21" ref="a" calculate="concat(../b, ../c)"/>
                            <xf:bind id="b22" ref="b" xxf:default="concat(../a, ../c)"/>
                        </xf:bind>

                    </xf:model>
                </xh:head>
                <xh:body/>
            </xh:html>
        </input>
        <output name="analysis">
            <request request-uri="/orbeon/doc/home-welcome" query-string="id=12&amp;print=false" method="GET">
                <model scope="" prefixed-id="model" default-instance-prefixed-id="i1" analyzed-binds="true">
                    <binds>
                        <bind id="b1" ref="instance('i1')">
                            <binding>
                                <analysis expression="instance('i1')" analyzed="true">
                                    <returnable>
                                        <path>instance('i1')</path>
                                    </returnable>
                                    <dependent-models>
                                        <model>model</model>
                                    </dependent-models>
                                    <dependent-instances>
                                        <instance>i1</instance>
                                    </dependent-instances>
                                    <returnable-instances>
                                        <instance>i1</instance>
                                    </returnable-instances>
                                </analysis>
                            </binding>
                            <bind id="b11" ref="a">
                                <binding>
                                    <analysis expression="a" analyzed="true">
                                        <returnable>
                                            <path>instance('i1')/a</path>
                                        </returnable>
                                        <dependent-models>
                                            <model>model</model>
                                        </dependent-models>
                                        <dependent-instances>
                                            <instance>i1</instance>
                                        </dependent-instances>
                                        <returnable-instances>
                                            <instance>i1</instance>
                                        </returnable-instances>
                                    </analysis>
                                </binding>
                                <mip name="constraint" expression="../b = 'x'">
                                    <analysis expression="xs:boolean((../b = 'x')[1])" analyzed="true">
                                        <value-dependent>
                                            <path>instance('i1')/b</path>
                                        </value-dependent>
                                        <dependent-models>
                                            <model>model</model>
                                        </dependent-models>
                                        <dependent-instances>
                                            <instance>i1</instance>
                                        </dependent-instances>
                                    </analysis>
                                </mip>
                            </bind>
                            <bind id="b12" ref="b">
                                <binding>
                                    <analysis expression="b" analyzed="true">
                                        <returnable>
                                            <path>instance('i1')/b</path>
                                        </returnable>
                                        <dependent-models>
                                            <model>model</model>
                                        </dependent-models>
                                        <dependent-instances>
                                            <instance>i1</instance>
                                        </dependent-instances>
                                        <returnable-instances>
                                            <instance>i1</instance>
                                        </returnable-instances>
                                    </analysis>
                                </binding>
                                <mip name="readonly" expression="instance('i2')/a">
                                    <analysis expression="xs:boolean((instance('i2')/a)[1])" analyzed="true">
                                        <value-dependent>
                                            <path>instance('i2')/a</path>
                                        </value-dependent>
                                        <dependent-models>
                                            <model>model</model>
                                        </dependent-models>
                                        <dependent-instances>
                                            <instance>i2</instance>
                                        </dependent-instances>
                                    </analysis>
                                </mip>
                            </bind>
                            <bind id="b13" ref="instance()/c">
                                <binding>
                                    <analysis expression="instance()/c" analyzed="true">
                                        <returnable>
                                            <path>instance('i1')/c</path>
                                        </returnable>
                                        <dependent-models>
                                            <model>model</model>
                                        </dependent-models>
                                        <dependent-instances>
                                            <instance>i1</instance>
                                        </dependent-instances>
                                        <returnable-instances>
                                            <instance>i1</instance>
                                        </returnable-instances>
                                    </analysis>
                                </binding>
                                <mip name="required" expression=". = 'y'">
                                    <analysis expression="xs:boolean((. = 'y')[1])" analyzed="true">
                                        <value-dependent>
                                            <path>instance('i1')/c</path>
                                        </value-dependent>
                                        <dependent-models>
                                            <model>model</model>
                                        </dependent-models>
                                        <dependent-instances>
                                            <instance>i1</instance>
                                        </dependent-instances>
                                    </analysis>
                                </mip>
                            </bind>
                            <bind id="b14" context="a"/>
                        </bind>
                        <bind id="b2" ref="instance('i2')">
                            <binding>
                                <analysis expression="instance('i2')" analyzed="true">
                                    <returnable>
                                        <path>instance('i2')</path>
                                    </returnable>
                                    <dependent-models>
                                        <model>model</model>
                                    </dependent-models>
                                    <dependent-instances>
                                        <instance>i2</instance>
                                    </dependent-instances>
                                    <returnable-instances>
                                        <instance>i2</instance>
                                    </returnable-instances>
                                </analysis>
                            </binding>
                            <bind id="b21" ref="a">
                                <binding>
                                    <analysis expression="a" analyzed="true">
                                        <returnable>
                                            <path>instance('i2')/a</path>
                                        </returnable>
                                        <dependent-models>
                                            <model>model</model>
                                        </dependent-models>
                                        <dependent-instances>
                                            <instance>i2</instance>
                                        </dependent-instances>
                                        <returnable-instances>
                                            <instance>i2</instance>
                                        </returnable-instances>
                                    </analysis>
                                </binding>
                                <mip name="calculate" expression="concat(../b, ../c)">
                                    <analysis expression="xs:string((concat(../b, ../c))[1])" analyzed="true">
                                        <value-dependent>
                                            <path>instance('i2')/b</path>
                                            <path>instance('i2')/c</path>
                                        </value-dependent>
                                        <dependent-models>
                                            <model>model</model>
                                        </dependent-models>
                                        <dependent-instances>
                                            <instance>i2</instance>
                                        </dependent-instances>
                                    </analysis>
                                </mip>
                            </bind>
                            <bind id="b22" ref="b">
                                <binding>
                                    <analysis expression="b" analyzed="true">
                                        <returnable>
                                            <path>instance('i2')/b</path>
                                        </returnable>
                                        <dependent-models>
                                            <model>model</model>
                                        </dependent-models>
                                        <dependent-instances>
                                            <instance>i2</instance>
                                        </dependent-instances>
                                        <returnable-instances>
                                            <instance>i2</instance>
                                        </returnable-instances>
                                    </analysis>
                                </binding>
                                <mip name="initial-value" expression="concat(../a, ../c)">
                                    <analysis expression="xs:string((concat(../a, ../c))[1])" analyzed="true">
                                        <value-dependent>
                                            <path>instance('i2')/a</path>
                                            <path>instance('i2')/c</path>
                                        </value-dependent>
                                        <dependent-models>
                                            <model>model</model>
                                        </dependent-models>
                                        <dependent-instances>
                                            <instance>i2</instance>
                                        </dependent-instances>
                                    </analysis>
                                </mip>
                            </bind>
                        </bind>
                    </binds>
                    <bind-instances>
                        <instance>i1</instance>
                        <instance>i2</instance>
                    </bind-instances>
                    <computed-binds-instances>
                        <instance>i1</instance>
                        <instance>i2</instance>
                    </computed-binds-instances>
                    <validation-binds-instances>
                        <instance>i1</instance>
                    </validation-binds-instances>
                </model>
            </request>
        </output>
    </test>

    <test description="Rejection of unsupported attributes" name="oxf:java">
        <input name="config">
            <config sourcepath="oxf:/" class="org.orbeon.oxf.xforms.analysis.XPathAnalysisProcessor"/>
        </input>
        <input name="form">
            <xh:html xmlns:xxf="http://orbeon.org/oxf/xml/xforms">
                <xh:head>
                    <xf:model id="model" xxf:xpath-analysis="true">
                        <xf:instance id="instance">
                            <instance/>
                        </xf:instance>
                        <xf:bind ref="." id="my-bind"/>
                    </xf:model>
                </xh:head>
                <xh:body>
                    <!-- NOTE: @bind now supported -->
                    <xf:input id="u1" bind="my-bind"/>
                    <!-- NOTE: @context now supported -->
                    <xf:input id="u2" context="." ref="b"/>
                </xh:body>
            </xh:html>
        </input>
        <output name="analysis">
            <request request-uri="/orbeon/doc/home-welcome" query-string="id=12&amp;print=false" method="GET">
                <input scope="" prefixed-id="u1" model-prefixed-id="model" binding="true" value="true">
                    <binding>
                        <analysis expression="." analyzed="true">
                            <returnable>
                                <path>instance('instance')</path>
                            </returnable>
                            <dependent-models>
                                <model>model</model>
                            </dependent-models>
                            <dependent-instances>
                                <instance>instance</instance>
                            </dependent-instances>
                            <returnable-instances>
                                <instance>instance</instance>
                            </returnable-instances>
                        </analysis>
                    </binding>
                    <value>
                        <analysis expression="xs:string(.[1])" analyzed="true">
                            <value-dependent>
                                <path>instance('instance')</path>
                            </value-dependent>
                            <dependent-models>
                                <model>model</model>
                            </dependent-models>
                            <dependent-instances>
                                <instance>instance</instance>
                            </dependent-instances>
                        </analysis>
                    </value>
                </input>
                <input scope="" prefixed-id="u2" model-prefixed-id="model" binding="true" value="true">
                    <binding>
                        <analysis expression="b" analyzed="true">
                            <returnable>
                                <path>instance('instance')/b</path>
                            </returnable>
                            <dependent-models>
                                <model>model</model>
                            </dependent-models>
                            <dependent-instances>
                                <instance>instance</instance>
                            </dependent-instances>
                            <returnable-instances>
                                <instance>instance</instance>
                            </returnable-instances>
                        </analysis>
                    </binding>
                    <value>
                        <analysis expression="xs:string(.[1])" analyzed="true">
                            <value-dependent>
                                <path>instance('instance')/b</path>
                            </value-dependent>
                            <dependent-models>
                                <model>model</model>
                            </dependent-models>
                            <dependent-instances>
                                <instance>instance</instance>
                            </dependent-instances>
                        </analysis>
                    </value>
                </input>
                <model scope="" prefixed-id="model" default-instance-prefixed-id="instance" analyzed-binds="true">
                    <binds>
                        <bind id="my-bind" ref=".">
                            <binding>
                                <analysis expression="." analyzed="true">
                                    <returnable>
                                        <path>instance('instance')</path>
                                    </returnable>
                                    <dependent-models>
                                        <model>model</model>
                                    </dependent-models>
                                    <dependent-instances>
                                        <instance>instance</instance>
                                    </dependent-instances>
                                    <returnable-instances>
                                        <instance>instance</instance>
                                    </returnable-instances>
                                </analysis>
                            </binding>
                        </bind>
                    </binds>
                    <bind-instances>
                        <instance>instance</instance>
                    </bind-instances>
                </model>
            </request>
        </output>
    </test>

    <test description="Rejection of unsupported expressions" name="oxf:java">
        <input name="config">
            <config sourcepath="oxf:/" class="org.orbeon.oxf.xforms.analysis.XPathAnalysisProcessor"/>
        </input>
        <input name="form">
            <xh:html xmlns:xxf="http://orbeon.org/oxf/xml/xforms">
                <xh:head>
                    <xf:model id="model" xxf:xpath-analysis="true">
                        <xf:instance id="instance">
                            <instance/>
                        </xf:instance>
                    </xf:model>
                </xh:head>
                <xh:body>
                    <xf:input id="u1" ref="instance('instance')/a/*"/>
                    <xf:input id="u2" ref="instance('instance')/*/b"/>
                    <!-- TODO: This could be reliably analyzed w/o schema -->
                    <xf:input id="u3" ref="instance('instance')/a/*/parent::a"/>
                    <!-- TODO: This could be reliably analyzed w/o schema -->
                    <xf:input id="u4" ref="instance('instance')/a/*/ancestor::a"/>
                    <xf:input id="u5" ref="instance('instance')/a//parent::a"/>
                    <!-- Can't analyze w/o schema: e.g. if data is instance('instance')/a/b/a/c/ancestor::a -->
                    <xf:input id="u6" ref="instance('instance')/a//ancestor::a"/>

                    <!-- TODO: This should be supported -->
                    <xf:input id="u7" ref="/a/b"/>
                    <xf:input id="u8" ref="../a/b"/>
                    <!-- TODO: This should be supported -->
                    <xf:input id="u9" ref="root()/a/b"/>

                </xh:body>
            </xh:html>
        </input>
        <output name="analysis">
            <request request-uri="/orbeon/doc/home-welcome" query-string="id=12&amp;print=false" method="GET">
                <input scope="" prefixed-id="u1" model-prefixed-id="model" binding="true" value="true">
                    <binding>
                        <analysis expression="instance('instance')/a/*" analyzed="false"/>
                    </binding>
                    <value>
                        <analysis expression="xs:string(.[1])" analyzed="false"/>
                    </value>
                </input>
                <input scope="" prefixed-id="u2" model-prefixed-id="model" binding="true" value="true">
                    <binding>
                        <analysis expression="instance('instance')/*/b" analyzed="false"/>
                    </binding>
                    <value>
                        <analysis expression="xs:string(.[1])" analyzed="false"/>
                    </value>
                </input>
                <input scope="" prefixed-id="u3" model-prefixed-id="model" binding="true" value="true">
                    <binding>
                        <analysis expression="instance('instance')/a/*/parent::a" analyzed="false"/>
                    </binding>
                    <value>
                        <analysis expression="xs:string(.[1])" analyzed="false"/>
                    </value>
                </input>
                <input scope="" prefixed-id="u4" model-prefixed-id="model" binding="true" value="true">
                    <binding>
                        <analysis expression="instance('instance')/a/*/ancestor::a" analyzed="false"/>
                    </binding>
                    <value>
                        <analysis expression="xs:string(.[1])" analyzed="false"/>
                    </value>
                </input>
                <input scope="" prefixed-id="u5" model-prefixed-id="model" binding="true" value="true">
                    <binding>
                        <analysis expression="instance('instance')/a//parent::a" analyzed="false"/>
                    </binding>
                    <value>
                        <analysis expression="xs:string(.[1])" analyzed="false"/>
                    </value>
                </input>
                <input scope="" prefixed-id="u6" model-prefixed-id="model" binding="true" value="true">
                    <binding>
                        <analysis expression="instance('instance')/a//ancestor::a" analyzed="false"/>
                    </binding>
                    <value>
                        <analysis expression="xs:string(.[1])" analyzed="false"/>
                    </value>
                </input>
                <input scope="" prefixed-id="u7" model-prefixed-id="model" binding="true" value="true">
                    <binding>
                        <analysis expression="/a/b" analyzed="false"/>
                    </binding>
                    <value>
                        <analysis expression="xs:string(.[1])" analyzed="false"/>
                    </value>
                </input>
                <input scope="" prefixed-id="u8" model-prefixed-id="model" binding="true" value="true">
                    <binding>
                        <analysis expression="../a/b" analyzed="false"/>
                    </binding>
                    <value>
                        <analysis expression="xs:string(.[1])" analyzed="false"/>
                    </value>
                </input>
                <input scope="" prefixed-id="u9" model-prefixed-id="model" binding="true" value="true">
                    <binding>
                        <analysis expression="root()/a/b" analyzed="false"/>
                    </binding>
                    <value>
                        <analysis expression="xs:string(.[1])" analyzed="false"/>
                    </value>
                </input>
                <model scope="" prefixed-id="model" default-instance-prefixed-id="instance" analyzed-binds="true"/>
            </request>
        </output>
    </test>

    <test description="Handling of parent:: and ancestor:: axes" name="oxf:java">
        <input name="config">
            <config sourcepath="oxf:/" class="org.orbeon.oxf.xforms.analysis.XPathAnalysisProcessor"/>
        </input>
        <input name="form">
            <xh:html xmlns:xxf="http://orbeon.org/oxf/xml/xforms">
                <xh:head>
                    <xf:model id="model" xxf:xpath-analysis="true">
                        <xf:instance id="instance">
                            <instance/>
                        </xf:instance>
                    </xf:model>
                </xh:head>
                <xh:body>
                    <!-- parent:: -->
                    <xf:input id="p1" ref="instance('instance')/a/b"/>
                    <xf:input id="p2" ref="instance('instance')/a/.."/>
                    <xf:input id="p3" ref="instance('instance')/a/../b"/>

                    <!-- ancestor:: -->
                    <xf:input id="a1" ref="instance('instance')/a/b/ancestor::a"/>
                    <xf:input id="a2" ref="instance('instance')/a/b/ancestor::a/c"/>
                    <xf:input id="a3" ref="instance('instance')/a/b/a/c/ancestor::a"/>
                    <xf:input id="a4" ref="instance('instance')/a/b/a/(c/ancestor::a | d)"/>
                </xh:body>
            </xh:html>
        </input>
        <output name="analysis">
            <request request-uri="/orbeon/doc/home-welcome" query-string="id=12&amp;print=false" method="GET">
                <input scope="" prefixed-id="p1" model-prefixed-id="model" binding="true" value="true">
                    <binding>
                        <analysis expression="instance('instance')/a/b" analyzed="true">
                            <returnable>
                                <path>instance('instance')/a/b</path>
                            </returnable>
                            <dependent-models>
                                <model>model</model>
                            </dependent-models>
                            <dependent-instances>
                                <instance>instance</instance>
                            </dependent-instances>
                            <returnable-instances>
                                <instance>instance</instance>
                            </returnable-instances>
                        </analysis>
                    </binding>
                    <value>
                        <analysis expression="xs:string(.[1])" analyzed="true">
                            <value-dependent>
                                <path>instance('instance')/a/b</path>
                            </value-dependent>
                            <dependent-models>
                                <model>model</model>
                            </dependent-models>
                            <dependent-instances>
                                <instance>instance</instance>
                            </dependent-instances>
                        </analysis>
                    </value>
                </input>
                <input scope="" prefixed-id="p2" model-prefixed-id="model" binding="true" value="true">
                    <binding>
                        <analysis expression="instance('instance')/a/.." analyzed="true">
                            <returnable>
                                <path>instance('instance')</path>
                            </returnable>
                            <dependent-models>
                                <model>model</model>
                            </dependent-models>
                            <dependent-instances>
                                <instance>instance</instance>
                            </dependent-instances>
                            <returnable-instances>
                                <instance>instance</instance>
                            </returnable-instances>
                        </analysis>
                    </binding>
                    <value>
                        <analysis expression="xs:string(.[1])" analyzed="true">
                            <value-dependent>
                                <path>instance('instance')</path>
                            </value-dependent>
                            <dependent-models>
                                <model>model</model>
                            </dependent-models>
                            <dependent-instances>
                                <instance>instance</instance>
                            </dependent-instances>
                        </analysis>
                    </value>
                </input>
                <input scope="" prefixed-id="p3" model-prefixed-id="model" binding="true" value="true">
                    <binding>
                        <analysis expression="instance('instance')/a/../b" analyzed="true">
                            <returnable>
                                <path>instance('instance')/b</path>
                            </returnable>
                            <dependent-models>
                                <model>model</model>
                            </dependent-models>
                            <dependent-instances>
                                <instance>instance</instance>
                            </dependent-instances>
                            <returnable-instances>
                                <instance>instance</instance>
                            </returnable-instances>
                        </analysis>
                    </binding>
                    <value>
                        <analysis expression="xs:string(.[1])" analyzed="true">
                            <value-dependent>
                                <path>instance('instance')/b</path>
                            </value-dependent>
                            <dependent-models>
                                <model>model</model>
                            </dependent-models>
                            <dependent-instances>
                                <instance>instance</instance>
                            </dependent-instances>
                        </analysis>
                    </value>
                </input>
                <input scope="" prefixed-id="a1" model-prefixed-id="model" binding="true" value="true">
                    <binding>
                        <analysis expression="instance('instance')/a/b/ancestor::a" analyzed="true">
                            <returnable>
                                <path>instance('instance')/a</path>
                            </returnable>
                            <dependent-models>
                                <model>model</model>
                            </dependent-models>
                            <dependent-instances>
                                <instance>instance</instance>
                            </dependent-instances>
                            <returnable-instances>
                                <instance>instance</instance>
                            </returnable-instances>
                        </analysis>
                    </binding>
                    <value>
                        <analysis expression="xs:string(.[1])" analyzed="true">
                            <value-dependent>
                                <path>instance('instance')/a</path>
                            </value-dependent>
                            <dependent-models>
                                <model>model</model>
                            </dependent-models>
                            <dependent-instances>
                                <instance>instance</instance>
                            </dependent-instances>
                        </analysis>
                    </value>
                </input>
                <input scope="" prefixed-id="a2" model-prefixed-id="model" binding="true" value="true">
                    <binding>
                        <analysis expression="instance('instance')/a/b/ancestor::a/c" analyzed="true">
                            <returnable>
                                <path>instance('instance')/a/c</path>
                            </returnable>
                            <dependent-models>
                                <model>model</model>
                            </dependent-models>
                            <dependent-instances>
                                <instance>instance</instance>
                            </dependent-instances>
                            <returnable-instances>
                                <instance>instance</instance>
                            </returnable-instances>
                        </analysis>
                    </binding>
                    <value>
                        <analysis expression="xs:string(.[1])" analyzed="true">
                            <value-dependent>
                                <path>instance('instance')/a/c</path>
                            </value-dependent>
                            <dependent-models>
                                <model>model</model>
                            </dependent-models>
                            <dependent-instances>
                                <instance>instance</instance>
                            </dependent-instances>
                        </analysis>
                    </value>
                </input>
                <input scope="" prefixed-id="a3" model-prefixed-id="model" binding="true" value="true">
                    <binding>
                        <analysis expression="instance('instance')/a/b/a/c/ancestor::a" analyzed="true">
                            <returnable>
                                <path>instance('instance')/a</path>
                                <path>instance('instance')/a/b/a</path>
                            </returnable>
                            <dependent-models>
                                <model>model</model>
                            </dependent-models>
                            <dependent-instances>
                                <instance>instance</instance>
                            </dependent-instances>
                            <returnable-instances>
                                <instance>instance</instance>
                            </returnable-instances>
                        </analysis>
                    </binding>
                    <value>
                        <analysis expression="xs:string(.[1])" analyzed="true">
                            <value-dependent>
                                <path>instance('instance')/a</path>
                                <path>instance('instance')/a/b/a</path>
                            </value-dependent>
                            <dependent-models>
                                <model>model</model>
                            </dependent-models>
                            <dependent-instances>
                                <instance>instance</instance>
                            </dependent-instances>
                        </analysis>
                    </value>
                </input>
                <input scope="" prefixed-id="a4" model-prefixed-id="model" binding="true" value="true">
                    <binding>
                        <analysis expression="instance('instance')/a/b/a/(c/ancestor::a | d)" analyzed="true">
                            <returnable>
                                <path>instance('instance')/a</path>
                                <path>instance('instance')/a/b/a</path>
                                <path>instance('instance')/a/b/a/d</path>
                            </returnable>
                            <dependent-models>
                                <model>model</model>
                            </dependent-models>
                            <dependent-instances>
                                <instance>instance</instance>
                            </dependent-instances>
                            <returnable-instances>
                                <instance>instance</instance>
                            </returnable-instances>
                        </analysis>
                    </binding>
                    <value>
                        <analysis expression="xs:string(.[1])" analyzed="true">
                            <value-dependent>
                                <path>instance('instance')/a</path>
                                <path>instance('instance')/a/b/a</path>
                                <path>instance('instance')/a/b/a/d</path>
                            </value-dependent>
                            <dependent-models>
                                <model>model</model>
                            </dependent-models>
                            <dependent-instances>
                                <instance>instance</instance>
                            </dependent-instances>
                        </analysis>
                    </value>
                </input>
                <model scope="" prefixed-id="model" default-instance-prefixed-id="instance" analyzed-binds="true"/>
            </request>
        </output>
    </test>

    <test description="Dependencies on other nodes" name="oxf:java">
        <input name="config">
            <config sourcepath="oxf:/" class="org.orbeon.oxf.xforms.analysis.XPathAnalysisProcessor"/>
        </input>
        <input name="form">
            <xh:html xmlns:xxf="http://orbeon.org/oxf/xml/xforms">
                <xh:head>
                    <xf:model id="model" xxf:xpath-analysis="true">
                        <xf:instance id="instance">
                            <instance/>
                        </xf:instance>
                    </xf:model>
                </xh:head>
                <xh:body>
                    <xf:input id="d1" ref="instance('instance')/a[b]"/>
                    <xf:input id="d2" ref="instance('instance')/a[b = 42]"/>
                    <xf:input id="d3" ref="instance('instance')/a[../b = 42]"/>
                </xh:body>
            </xh:html>
        </input>
        <output name="analysis">
            <request request-uri="/orbeon/doc/home-welcome" query-string="id=12&amp;print=false" method="GET">
                <input scope="" prefixed-id="d1" model-prefixed-id="model" binding="true" value="true">
                    <binding>
                        <analysis expression="instance('instance')/a[b]" analyzed="true">
                            <returnable>
                                <path>instance('instance')/a</path>
                            </returnable>
                            <dependent-models>
                                <model>model</model>
                            </dependent-models>
                            <dependent-instances>
                                <instance>instance</instance>
                            </dependent-instances>
                            <returnable-instances>
                                <instance>instance</instance>
                            </returnable-instances>
                        </analysis>
                    </binding>
                    <value>
                        <analysis expression="xs:string(.[1])" analyzed="true">
                            <value-dependent>
                                <path>instance('instance')/a</path>
                            </value-dependent>
                            <dependent-models>
                                <model>model</model>
                            </dependent-models>
                            <dependent-instances>
                                <instance>instance</instance>
                            </dependent-instances>
                        </analysis>
                    </value>
                </input>
                <input scope="" prefixed-id="d2" model-prefixed-id="model" binding="true" value="true">
                    <binding>
                        <analysis expression="instance('instance')/a[b = 42]" analyzed="true">
                            <value-dependent>
                                <path>instance('instance')/a/b</path>
                            </value-dependent>
                            <returnable>
                                <path>instance('instance')/a</path>
                            </returnable>
                            <dependent-models>
                                <model>model</model>
                            </dependent-models>
                            <dependent-instances>
                                <instance>instance</instance>
                            </dependent-instances>
                            <returnable-instances>
                                <instance>instance</instance>
                            </returnable-instances>
                        </analysis>
                    </binding>
                    <value>
                        <analysis expression="xs:string(.[1])" analyzed="true">
                            <value-dependent>
                                <path>instance('instance')/a</path>
                                <path>instance('instance')/a/b</path>
                            </value-dependent>
                            <dependent-models>
                                <model>model</model>
                            </dependent-models>
                            <dependent-instances>
                                <instance>instance</instance>
                            </dependent-instances>
                        </analysis>
                    </value>
                </input>
                <input scope="" prefixed-id="d3" model-prefixed-id="model" binding="true" value="true">
                    <binding>
                        <analysis expression="instance('instance')/a[../b = 42]" analyzed="true">
                            <value-dependent>
                                <path>instance('instance')/b</path>
                            </value-dependent>
                            <returnable>
                                <path>instance('instance')/a</path>
                            </returnable>
                            <dependent-models>
                                <model>model</model>
                            </dependent-models>
                            <dependent-instances>
                                <instance>instance</instance>
                            </dependent-instances>
                            <returnable-instances>
                                <instance>instance</instance>
                            </returnable-instances>
                        </analysis>
                    </binding>
                    <value>
                        <analysis expression="xs:string(.[1])" analyzed="true">
                            <value-dependent>
                                <path>instance('instance')/a</path>
                                <path>instance('instance')/b</path>
                            </value-dependent>
                            <dependent-models>
                                <model>model</model>
                            </dependent-models>
                            <dependent-instances>
                                <instance>instance</instance>
                            </dependent-instances>
                        </analysis>
                    </value>
                </input>
                <model scope="" prefixed-id="model" default-instance-prefixed-id="instance" analyzed-binds="true"/>
            </request>
        </output>
    </test>

    <test description="Simple model variable accessed by view" name="oxf:java">
        <input name="config">
            <config sourcepath="oxf:/" class="org.orbeon.oxf.xforms.analysis.XPathAnalysisProcessor"/>
        </input>
        <input name="form">
            <xh:html xmlns:xxf="http://orbeon.org/oxf/xml/xforms">
                <xh:head>
                    <xf:model id="model" xxf:xpath-analysis="true">
                        <xf:instance id="instance">
                            <instance/>
                        </xf:instance>
                        <xxf:variable name="mv" select="instance()"/>
                    </xf:model>
                </xh:head>
                <xh:body>
                    <xf:output id="output1" value="$mv"/>
                </xh:body>
            </xh:html>
        </input>
        <output name="analysis">
            <request request-uri="/orbeon/doc/home-welcome" query-string="id=12&amp;print=false" method="GET">
                <output scope="" prefixed-id="output1" model-prefixed-id="model" binding="false" value="true">
                    <value>
                        <analysis expression="xs:string(($mv)[1])" analyzed="true">
                            <value-dependent>
                                <path>instance('instance')</path>
                            </value-dependent>
                            <dependent-models>
                                <model>model</model>
                            </dependent-models>
                            <dependent-instances>
                                <instance>instance</instance>
                            </dependent-instances>
                        </analysis>
                    </value>
                </output>
                <model scope="" prefixed-id="model" default-instance-prefixed-id="instance" analyzed-binds="true">
                    <variable scope="" prefixed-id="xf-1" model-prefixed-id="model" binding="false" value="true" name="mv">
                        <value>
                            <analysis expression="instance()" analyzed="true">
                                <returnable>
                                    <path>instance('instance')</path>
                                </returnable>
                                <dependent-models>
                                    <model>model</model>
                                </dependent-models>
                                <dependent-instances>
                                    <instance>instance</instance>
                                </dependent-instances>
                                <returnable-instances>
                                    <instance>instance</instance>
                                </returnable-instances>
                            </analysis>
                        </value>
                    </variable>
                </model>
            </request>
        </output>
    </test>

    <test description="Simple model variables with 2 models" name="oxf:java">
        <input name="config">
            <config sourcepath="oxf:/" class="org.orbeon.oxf.xforms.analysis.XPathAnalysisProcessor"/>
        </input>
        <input name="form">
            <xh:html xmlns:xxf="http://orbeon.org/oxf/xml/xforms">
                <xh:head>
                    <xf:model id="model1" xxf:xpath-analysis="true">
                        <xf:instance id="instance1">
                            <instance/>
                        </xf:instance>
                        <xxf:variable name="mv" select="instance()"/>
                    </xf:model>
                    <xf:model id="model2">
                        <xf:instance id="instance2">
                            <instance/>
                        </xf:instance>
                        <xxf:variable name="mv" select="instance()"/>
                    </xf:model>
                </xh:head>
                <xh:body>
                    <xf:output id="output1" model="model2" value="$mv"/>
                </xh:body>
            </xh:html>
        </input>
        <output name="analysis">
            <request request-uri="/orbeon/doc/home-welcome" query-string="id=12&amp;print=false" method="GET">
                <output scope="" prefixed-id="output1" model-prefixed-id="model2" binding="false" value="true">
                    <value>
                        <analysis expression="xs:string(($mv)[1])" analyzed="true">
                            <value-dependent>
                                <path>instance('instance2')</path>
                            </value-dependent>
                            <dependent-models>
                                <model>model2</model>
                            </dependent-models>
                            <dependent-instances>
                                <instance>instance2</instance>
                            </dependent-instances>
                        </analysis>
                    </value>
                </output>
                <model scope="" prefixed-id="model1" default-instance-prefixed-id="instance1" analyzed-binds="true">
                    <variable scope="" prefixed-id="xf-1" model-prefixed-id="model1" binding="false" value="true" name="mv">
                        <value>
                            <analysis expression="instance()" analyzed="true">
                                <returnable>
                                    <path>instance('instance1')</path>
                                </returnable>
                                <dependent-models>
                                    <model>model1</model>
                                </dependent-models>
                                <dependent-instances>
                                    <instance>instance1</instance>
                                </dependent-instances>
                                <returnable-instances>
                                    <instance>instance1</instance>
                                </returnable-instances>
                            </analysis>
                        </value>
                    </variable>
                </model>
                <model scope="" prefixed-id="model2" default-instance-prefixed-id="instance2" analyzed-binds="true">
                    <variable scope="" prefixed-id="xf-2" model-prefixed-id="model2" binding="false" value="true" name="mv">
                        <value>
                            <analysis expression="instance()" analyzed="true">
                                <returnable>
                                    <path>instance('instance2')</path>
                                </returnable>
                                <dependent-models>
                                    <model>model2</model>
                                </dependent-models>
                                <dependent-instances>
                                    <instance>instance2</instance>
                                </dependent-instances>
                                <returnable-instances>
                                    <instance>instance2</instance>
                                </returnable-instances>
                            </analysis>
                        </value>
                    </variable>
                </model>
            </request>
        </output>
    </test>

    <test description="Model variables" name="oxf:java">
        <input name="config">
            <config sourcepath="oxf:/" class="org.orbeon.oxf.xforms.analysis.XPathAnalysisProcessor"/>
        </input>
        <input name="form" href="oxf:/org/orbeon/oxf/xforms/analysis/model-variables.xhtml"/>
        <output name="analysis">
            <request request-uri="/orbeon/doc/home-welcome" query-string="id=12&amp;print=false" method="GET">
                <output scope="" prefixed-id="output1" model-prefixed-id="model1" binding="false" value="true">
                    <value>
                        <analysis expression="xs:string(($mv)[1])" analyzed="true">
                            <value-dependent>
                                <path>instance('instance1')</path>
                            </value-dependent>
                            <dependent-models>
                                <model>model1</model>
                            </dependent-models>
                            <dependent-instances>
                                <instance>instance1</instance>
                            </dependent-instances>
                        </analysis>
                    </value>
                </output>
                <group scope="" prefixed-id="group2" model-prefixed-id="model2" binding="false" value="false"/>
                <output scope="" prefixed-id="output2a" model-prefixed-id="model2" binding="false" value="true">
                    <value>
                        <analysis expression="xs:string(($mv)[1])" analyzed="true">
                            <value-dependent>
                                <path>instance('instance2')</path>
                            </value-dependent>
                            <dependent-models>
                                <model>model2</model>
                            </dependent-models>
                            <dependent-instances>
                                <instance>instance2</instance>
                            </dependent-instances>
                        </analysis>
                    </value>
                </output>
                <output scope="" prefixed-id="output2b" model-prefixed-id="model1" binding="false" value="true">
                    <value>
                        <analysis expression="xs:string(($mv)[1])" analyzed="true">
                            <value-dependent>
                                <path>instance('instance1')</path>
                            </value-dependent>
                            <dependent-models>
                                <model>model1</model>
                            </dependent-models>
                            <dependent-instances>
                                <instance>instance1</instance>
                            </dependent-instances>
                        </analysis>
                    </value>
                </output>
                <group scope="" prefixed-id="group3" model-prefixed-id="model1" binding="true" value="false">
                    <binding>
                        <analysis expression="xxf:instance('instance2')" analyzed="true">
                            <returnable>
                                <path>instance('instance2')</path>
                            </returnable>
                            <dependent-models>
                                <model>model2</model>
                            </dependent-models>
                            <dependent-instances>
                                <instance>instance2</instance>
                            </dependent-instances>
                            <returnable-instances>
                                <instance>instance2</instance>
                            </returnable-instances>
                        </analysis>
                    </binding>
                </group>
                <output scope="" prefixed-id="output3a" model-prefixed-id="model1" binding="false" value="true">
                    <value>
                        <analysis expression="xs:string(($mv)[1])" analyzed="true">
                            <value-dependent>
                                <path>instance('instance1')</path>
                            </value-dependent>
                            <dependent-models>
                                <model>model1</model>
                            </dependent-models>
                            <dependent-instances>
                                <instance>instance1</instance>
                            </dependent-instances>
                        </analysis>
                    </value>
                </output>
                <output scope="" prefixed-id="output3b" model-prefixed-id="model1" binding="false" value="true">
                    <value>
                        <analysis expression="xs:string(($mv)[1])" analyzed="true">
                            <value-dependent>
                                <path>instance('instance1')</path>
                            </value-dependent>
                            <dependent-models>
                                <model>model1</model>
                            </dependent-models>
                            <dependent-instances>
                                <instance>instance1</instance>
                            </dependent-instances>
                        </analysis>
                    </value>
                </output>
                <output scope="" prefixed-id="output3c" model-prefixed-id="model2" binding="false" value="true">
                    <value>
                        <analysis expression="xs:string(($mv)[1])" analyzed="true">
                            <value-dependent>
                                <path>instance('instance2')</path>
                            </value-dependent>
                            <dependent-models>
                                <model>model2</model>
                            </dependent-models>
                            <dependent-instances>
                                <instance>instance2</instance>
                            </dependent-instances>
                        </analysis>
                    </value>
                </output>
                <group scope="" prefixed-id="group4" model-prefixed-id="model1" binding="false" value="false"/>
                <output scope="" prefixed-id="output4a" model-prefixed-id="model1" binding="false" value="true">
                    <value>
                        <analysis expression="xs:string(($mv)[1])" analyzed="true">
                            <value-dependent>
                                <path>instance('instance1')</path>
                            </value-dependent>
                            <dependent-models>
                                <model>model1</model>
                            </dependent-models>
                            <dependent-instances>
                                <instance>instance1</instance>
                            </dependent-instances>
                        </analysis>
                    </value>
                </output>
                <output scope="" prefixed-id="output4b" model-prefixed-id="model1" binding="false" value="true">
                    <value>
                        <analysis expression="xs:string(($mv)[1])" analyzed="true">
                            <value-dependent>
                                <path>instance('instance1')</path>
                            </value-dependent>
                            <dependent-models>
                                <model>model1</model>
                            </dependent-models>
                            <dependent-instances>
                                <instance>instance1</instance>
                            </dependent-instances>
                        </analysis>
                    </value>
                </output>
                <output scope="" prefixed-id="output4c" model-prefixed-id="model2" binding="false" value="true">
                    <value>
                        <analysis expression="xs:string(($mv)[1])" analyzed="true">
                            <value-dependent>
                                <path>instance('instance2')</path>
                            </value-dependent>
                            <dependent-models>
                                <model>model2</model>
                            </dependent-models>
                            <dependent-instances>
                                <instance>instance2</instance>
                            </dependent-instances>
                        </analysis>
                    </value>
                </output>
                <variable scope="" prefixed-id="xf-3" model-prefixed-id="model1" binding="false" value="true" name="mv1">
                    <value>
                        <analysis expression="$mv" analyzed="true">
                            <returnable>
                                <path>instance('instance1')</path>
                            </returnable>
                            <dependent-models>
                                <model>model1</model>
                            </dependent-models>
                            <dependent-instances>
                                <instance>instance1</instance>
                            </dependent-instances>
                            <returnable-instances>
                                <instance>instance1</instance>
                            </returnable-instances>
                        </analysis>
                    </value>
                </variable>
                <variable scope="" prefixed-id="xf-4" model-prefixed-id="model2" binding="false" value="true" name="mv2">
                    <value>
                        <analysis expression="$mv" analyzed="true">
                            <returnable>
                                <path>instance('instance2')</path>
                            </returnable>
                            <dependent-models>
                                <model>model2</model>
                            </dependent-models>
                            <dependent-instances>
                                <instance>instance2</instance>
                            </dependent-instances>
                            <returnable-instances>
                                <instance>instance2</instance>
                            </returnable-instances>
                        </analysis>
                    </value>
                </variable>
                <output scope="" prefixed-id="output5a" model-prefixed-id="model1" binding="false" value="true">
                    <value>
                        <analysis expression="xs:string(($mv1)[1])" analyzed="true">
                            <value-dependent>
                                <path>instance('instance1')</path>
                            </value-dependent>
                            <dependent-models>
                                <model>model1</model>
                            </dependent-models>
                            <dependent-instances>
                                <instance>instance1</instance>
                            </dependent-instances>
                        </analysis>
                    </value>
                </output>
                <output scope="" prefixed-id="output5b" model-prefixed-id="model1" binding="false" value="true">
                    <value>
                        <analysis expression="xs:string(($mv2)[1])" analyzed="true">
                            <value-dependent>
                                <path>instance('instance2')</path>
                            </value-dependent>
                            <dependent-models>
                                <model>model2</model>
                            </dependent-models>
                            <dependent-instances>
                                <instance>instance2</instance>
                            </dependent-instances>
                        </analysis>
                    </value>
                </output>
                <model scope="" prefixed-id="model1" default-instance-prefixed-id="instance1" analyzed-binds="true">
                    <variable scope="" prefixed-id="xf-1" model-prefixed-id="model1" binding="false" value="true" name="mv">
                        <value>
                            <analysis expression="instance()" analyzed="true">
                                <returnable>
                                    <path>instance('instance1')</path>
                                </returnable>
                                <dependent-models>
                                    <model>model1</model>
                                </dependent-models>
                                <dependent-instances>
                                    <instance>instance1</instance>
                                </dependent-instances>
                                <returnable-instances>
                                    <instance>instance1</instance>
                                </returnable-instances>
                            </analysis>
                        </value>
                    </variable>
                </model>
                <model scope="" prefixed-id="model2" default-instance-prefixed-id="instance2" analyzed-binds="true">
                    <variable scope="" prefixed-id="xf-2" model-prefixed-id="model2" binding="false" value="true" name="mv">
                        <value>
                            <analysis expression="instance()" analyzed="true">
                                <returnable>
                                    <path>instance('instance2')</path>
                                </returnable>
                                <dependent-models>
                                    <model>model2</model>
                                </dependent-models>
                                <dependent-instances>
                                    <instance>instance2</instance>
                                </dependent-instances>
                                <returnable-instances>
                                    <instance>instance2</instance>
                                </returnable-instances>
                            </analysis>
                        </value>
                    </variable>
                </model>
            </request>
        </output>
    </test>

    <test description="Simple xxforms:instance function within models" name="oxf:java">
        <input name="config">
            <config sourcepath="oxf:/" class="org.orbeon.oxf.xforms.analysis.XPathAnalysisProcessor"/>
        </input>
        <input name="form">
            <xh:html xmlns:xxf="http://orbeon.org/oxf/xml/xforms">
                <xh:head>
                    <xf:model id="model1" xxf:xpath-analysis="true">
                        <xf:instance id="instance1">
                            <instance>42</instance>
                        </xf:instance>
                        <xxf:variable name="mv" select="xxf:instance('instance2')"/>
                    </xf:model>
                    <xf:model id="model2">
                        <xf:instance id="instance2">
                            <instance>43</instance>
                        </xf:instance>
                        <xxf:variable name="mv" select="xxf:instance('instance1')"/>
                    </xf:model>
                </xh:head>
                <xh:body/>
            </xh:html>
        </input>
        <output name="analysis">
            <request request-uri="/orbeon/doc/home-welcome" query-string="id=12&amp;print=false" method="GET">
                <model scope="" prefixed-id="model1" default-instance-prefixed-id="instance1" analyzed-binds="true">
                    <variable scope="" prefixed-id="xf-1" model-prefixed-id="model1" binding="false" value="true" name="mv">
                        <value>
                            <analysis expression="xxf:instance('instance2')" analyzed="true">
                                <returnable>
                                    <path>instance('instance2')</path>
                                </returnable>
                                <dependent-models>
                                    <model>model2</model>
                                </dependent-models>
                                <dependent-instances>
                                    <instance>instance2</instance>
                                </dependent-instances>
                                <returnable-instances>
                                    <instance>instance2</instance>
                                </returnable-instances>
                            </analysis>
                        </value>
                    </variable>
                </model>
                <model scope="" prefixed-id="model2" default-instance-prefixed-id="instance2" analyzed-binds="true">
                    <variable scope="" prefixed-id="xf-2" model-prefixed-id="model2" binding="false" value="true" name="mv">
                        <value>
                            <analysis expression="xxf:instance('instance1')" analyzed="true">
                                <returnable>
                                    <path>instance('instance1')</path>
                                </returnable>
                                <dependent-models>
                                    <model>model1</model>
                                </dependent-models>
                                <dependent-instances>
                                    <instance>instance1</instance>
                                </dependent-instances>
                                <returnable-instances>
                                    <instance>instance1</instance>
                                </returnable-instances>
                            </analysis>
                        </value>
                    </variable>
                </model>
            </request>
        </output>
    </test>

    <test description="Complex cross-models instance references" name="oxf:java">
        <input name="config">
            <config sourcepath="oxf:/" class="org.orbeon.oxf.xforms.analysis.XPathAnalysisProcessor"/>
        </input>
        <input name="form">
            <xh:html xmlns:xxf="http://orbeon.org/oxf/xml/xforms">
                <xh:head>
                    <xf:model xxf:xpath-analysis="true" id="model1">
                        <xf:instance id="instance11">
                            <instance/>
                        </xf:instance>
                        <xf:instance id="instance12">
                            <instance/>
                        </xf:instance>

                        <xxf:variable name="v11a" select="instance()"/>
                        <xxf:variable name="v11b" select="instance('instance11')"/>
                        <xxf:variable name="v12" select="instance('instance12')"/>

                        <xxf:variable name="v13" select="xxf:instance('instance21')"/>
                        <xxf:variable name="v14" select="xxf:instance('instance22')"/>

                        <xxf:variable name="v15a" model="model2" select="instance()"/>
                        <xxf:variable name="v15b" model="model2" select="instance('instance21')"/>
                        <xxf:variable name="v16" model="model2" select="instance('instance22')"/>

                    </xf:model>
                    <xf:model id="model2">
                        <xf:instance id="instance21">
                            <instance/>
                        </xf:instance>
                        <xf:instance id="instance22">
                            <instance/>
                        </xf:instance>

                        <xxf:variable name="v21" select="instance()"/>
                        <xxf:variable name="v22" select="instance('instance22')"/>

                        <xxf:variable name="v23" select="xxf:instance('instance11')"/>
                        <xxf:variable name="v24" select="xxf:instance('instance12')"/>

                        <xxf:variable name="v25a" model="model1" select="instance()"/>
                        <xxf:variable name="v25b" model="model1" select="instance('instance11')"/>
                        <xxf:variable name="v26" model="model1" select="instance('instance12')"/>

                    </xf:model>
                </xh:head>
                <xh:body/>
            </xh:html>
        </input>
        <output name="analysis">
            <request request-uri="/orbeon/doc/home-welcome" query-string="id=12&amp;print=false" method="GET">
                <model scope="" prefixed-id="model1" default-instance-prefixed-id="instance11" analyzed-binds="true">
                    <variable scope="" prefixed-id="xf-1" model-prefixed-id="model1" binding="false" value="true" name="v11a">
                        <value>
                            <analysis expression="instance()" analyzed="true">
                                <returnable>
                                    <path>instance('instance11')</path>
                                </returnable>
                                <dependent-models>
                                    <model>model1</model>
                                </dependent-models>
                                <dependent-instances>
                                    <instance>instance11</instance>
                                </dependent-instances>
                                <returnable-instances>
                                    <instance>instance11</instance>
                                </returnable-instances>
                            </analysis>
                        </value>
                    </variable>
                    <variable scope="" prefixed-id="xf-2" model-prefixed-id="model1" binding="false" value="true" name="v11b">
                        <value>
                            <analysis expression="instance('instance11')" analyzed="true">
                                <returnable>
                                    <path>instance('instance11')</path>
                                </returnable>
                                <dependent-models>
                                    <model>model1</model>
                                </dependent-models>
                                <dependent-instances>
                                    <instance>instance11</instance>
                                </dependent-instances>
                                <returnable-instances>
                                    <instance>instance11</instance>
                                </returnable-instances>
                            </analysis>
                        </value>
                    </variable>
                    <variable scope="" prefixed-id="xf-3" model-prefixed-id="model1" binding="false" value="true" name="v12">
                        <value>
                            <analysis expression="instance('instance12')" analyzed="true">
                                <returnable>
                                    <path>instance('instance12')</path>
                                </returnable>
                                <dependent-models>
                                    <model>model1</model>
                                </dependent-models>
                                <dependent-instances>
                                    <instance>instance12</instance>
                                </dependent-instances>
                                <returnable-instances>
                                    <instance>instance12</instance>
                                </returnable-instances>
                            </analysis>
                        </value>
                    </variable>
                    <variable scope="" prefixed-id="xf-4" model-prefixed-id="model1" binding="false" value="true" name="v13">
                        <value>
                            <analysis expression="xxf:instance('instance21')" analyzed="true">
                                <returnable>
                                    <path>instance('instance21')</path>
                                </returnable>
                                <dependent-models>
                                    <model>model2</model>
                                </dependent-models>
                                <dependent-instances>
                                    <instance>instance21</instance>
                                </dependent-instances>
                                <returnable-instances>
                                    <instance>instance21</instance>
                                </returnable-instances>
                            </analysis>
                        </value>
                    </variable>
                    <variable scope="" prefixed-id="xf-5" model-prefixed-id="model1" binding="false" value="true" name="v14">
                        <value>
                            <analysis expression="xxf:instance('instance22')" analyzed="true">
                                <returnable>
                                    <path>instance('instance22')</path>
                                </returnable>
                                <dependent-models>
                                    <model>model2</model>
                                </dependent-models>
                                <dependent-instances>
                                    <instance>instance22</instance>
                                </dependent-instances>
                                <returnable-instances>
                                    <instance>instance22</instance>
                                </returnable-instances>
                            </analysis>
                        </value>
                    </variable>
                    <variable scope="" prefixed-id="xf-6" model-prefixed-id="model2" binding="false" value="true" name="v15a">
                        <value>
                            <analysis expression="instance()" analyzed="true">
                                <returnable>
                                    <path>instance('instance21')</path>
                                </returnable>
                                <dependent-models>
                                    <model>model2</model>
                                </dependent-models>
                                <dependent-instances>
                                    <instance>instance21</instance>
                                </dependent-instances>
                                <returnable-instances>
                                    <instance>instance21</instance>
                                </returnable-instances>
                            </analysis>
                        </value>
                    </variable>
                    <variable scope="" prefixed-id="xf-7" model-prefixed-id="model2" binding="false" value="true" name="v15b">
                        <value>
                            <analysis expression="instance('instance21')" analyzed="true">
                                <returnable>
                                    <path>instance('instance21')</path>
                                </returnable>
                                <dependent-models>
                                    <model>model2</model>
                                </dependent-models>
                                <dependent-instances>
                                    <instance>instance21</instance>
                                </dependent-instances>
                                <returnable-instances>
                                    <instance>instance21</instance>
                                </returnable-instances>
                            </analysis>
                        </value>
                    </variable>
                    <variable scope="" prefixed-id="xf-8" model-prefixed-id="model2" binding="false" value="true" name="v16">
                        <value>
                            <analysis expression="instance('instance22')" analyzed="true">
                                <returnable>
                                    <path>instance('instance22')</path>
                                </returnable>
                                <dependent-models>
                                    <model>model2</model>
                                </dependent-models>
                                <dependent-instances>
                                    <instance>instance22</instance>
                                </dependent-instances>
                                <returnable-instances>
                                    <instance>instance22</instance>
                                </returnable-instances>
                            </analysis>
                        </value>
                    </variable>
                </model>
                <model scope="" prefixed-id="model2" default-instance-prefixed-id="instance21" analyzed-binds="true">
                    <variable scope="" prefixed-id="xf-9" model-prefixed-id="model2" binding="false" value="true" name="v21">
                        <value>
                            <analysis expression="instance()" analyzed="true">
                                <returnable>
                                    <path>instance('instance21')</path>
                                </returnable>
                                <dependent-models>
                                    <model>model2</model>
                                </dependent-models>
                                <dependent-instances>
                                    <instance>instance21</instance>
                                </dependent-instances>
                                <returnable-instances>
                                    <instance>instance21</instance>
                                </returnable-instances>
                            </analysis>
                        </value>
                    </variable>
                    <variable scope="" prefixed-id="xf-10" model-prefixed-id="model2" binding="false" value="true" name="v22">
                        <value>
                            <analysis expression="instance('instance22')" analyzed="true">
                                <returnable>
                                    <path>instance('instance22')</path>
                                </returnable>
                                <dependent-models>
                                    <model>model2</model>
                                </dependent-models>
                                <dependent-instances>
                                    <instance>instance22</instance>
                                </dependent-instances>
                                <returnable-instances>
                                    <instance>instance22</instance>
                                </returnable-instances>
                            </analysis>
                        </value>
                    </variable>
                    <variable scope="" prefixed-id="xf-11" model-prefixed-id="model2" binding="false" value="true" name="v23">
                        <value>
                            <analysis expression="xxf:instance('instance11')" analyzed="true">
                                <returnable>
                                    <path>instance('instance11')</path>
                                </returnable>
                                <dependent-models>
                                    <model>model1</model>
                                </dependent-models>
                                <dependent-instances>
                                    <instance>instance11</instance>
                                </dependent-instances>
                                <returnable-instances>
                                    <instance>instance11</instance>
                                </returnable-instances>
                            </analysis>
                        </value>
                    </variable>
                    <variable scope="" prefixed-id="xf-12" model-prefixed-id="model2" binding="false" value="true" name="v24">
                        <value>
                            <analysis expression="xxf:instance('instance12')" analyzed="true">
                                <returnable>
                                    <path>instance('instance12')</path>
                                </returnable>
                                <dependent-models>
                                    <model>model1</model>
                                </dependent-models>
                                <dependent-instances>
                                    <instance>instance12</instance>
                                </dependent-instances>
                                <returnable-instances>
                                    <instance>instance12</instance>
                                </returnable-instances>
                            </analysis>
                        </value>
                    </variable>
                    <variable scope="" prefixed-id="xf-13" model-prefixed-id="model1" binding="false" value="true" name="v25a">
                        <value>
                            <analysis expression="instance()" analyzed="true">
                                <returnable>
                                    <path>instance('instance11')</path>
                                </returnable>
                                <dependent-models>
                                    <model>model1</model>
                                </dependent-models>
                                <dependent-instances>
                                    <instance>instance11</instance>
                                </dependent-instances>
                                <returnable-instances>
                                    <instance>instance11</instance>
                                </returnable-instances>
                            </analysis>
                        </value>
                    </variable>
                    <variable scope="" prefixed-id="xf-14" model-prefixed-id="model1" binding="false" value="true" name="v25b">
                        <value>
                            <analysis expression="instance('instance11')" analyzed="true">
                                <returnable>
                                    <path>instance('instance11')</path>
                                </returnable>
                                <dependent-models>
                                    <model>model1</model>
                                </dependent-models>
                                <dependent-instances>
                                    <instance>instance11</instance>
                                </dependent-instances>
                                <returnable-instances>
                                    <instance>instance11</instance>
                                </returnable-instances>
                            </analysis>
                        </value>
                    </variable>
                    <variable scope="" prefixed-id="xf-15" model-prefixed-id="model1" binding="false" value="true" name="v26">
                        <value>
                            <analysis expression="instance('instance12')" analyzed="true">
                                <returnable>
                                    <path>instance('instance12')</path>
                                </returnable>
                                <dependent-models>
                                    <model>model1</model>
                                </dependent-models>
                                <dependent-instances>
                                    <instance>instance12</instance>
                                </dependent-instances>
                                <returnable-instances>
                                    <instance>instance12</instance>
                                </returnable-instances>
                            </analysis>
                        </value>
                    </variable>
                </model>
            </request>
        </output>
    </test>

    <test description="Basic xxf:variable/xxf:sequence" name="oxf:java">
        <input name="config">
            <config sourcepath="oxf:/" class="org.orbeon.oxf.xforms.analysis.XPathAnalysisProcessor"/>
        </input>
        <input name="form">
            <xh:html xmlns:xxf="http://orbeon.org/oxf/xml/xforms">
                <xh:head>

                    <xf:model xxf:xpath-analysis="true" id="model">

                        <xf:instance id="instance">
                            <instance>
                                <foo>42</foo>
                                <bar>43</bar>
                            </instance>
                        </xf:instance>

                        <xxf:variable id="vfoo" name="foo" select="foo"/>
                        <xxf:variable id="vbar" name="bar" select="bar"/>

                    </xf:model>
                </xh:head>
                <xh:body>
                    
                    <xxf:variable id="vsum" name="sum">
                        <xxf:sequence select="$foo + $bar"/>
                    </xxf:variable>
                    <xxf:variable id="vproduct" name="product">
                        <xxf:sequence ref="foo" select=". * $bar"/>
                    </xxf:variable>
                    <xxf:variable id="vdifference" name="difference" ref="foo">
                        <xxf:sequence select=". - $bar"/>
                    </xxf:variable>

                    <xf:output id="osum" value="$sum"/>
                    <xf:output id="oproduct" value="$product"/>
                    <xf:output id="odifference" value="$difference"/>
                </xh:body>
            </xh:html>
        </input>
        <output name="analysis">
            <request request-uri="/orbeon/doc/home-welcome" query-string="id=12&amp;print=false" method="GET">
                <variable scope="" prefixed-id="vsum" model-prefixed-id="model" binding="false" value="true" name="sum">
                    <value>
                        <analysis expression="$foo + $bar" analyzed="true">
                            <value-dependent>
                                <path>instance('instance')/foo</path>
                                <path>instance('instance')/bar</path>
                            </value-dependent>
                            <dependent-models>
                                <model>model</model>
                            </dependent-models>
                            <dependent-instances>
                                <instance>instance</instance>
                            </dependent-instances>
                        </analysis>
                    </value>
                </variable>
                <variable scope="" prefixed-id="vproduct" model-prefixed-id="model" binding="false" value="true" name="product">
                    <value>
                        <analysis expression=". * $bar" analyzed="true">
                            <value-dependent>
                                <path>instance('instance')/foo</path>
                                <path>instance('instance')/bar</path>
                            </value-dependent>
                            <dependent-models>
                                <model>model</model>
                            </dependent-models>
                            <dependent-instances>
                                <instance>instance</instance>
                            </dependent-instances>
                        </analysis>
                    </value>
                </variable>
                <variable scope="" prefixed-id="vdifference" model-prefixed-id="model" binding="true" value="true" name="difference">
                    <binding>
                        <analysis expression="foo" analyzed="true">
                            <returnable>
                                <path>instance('instance')/foo</path>
                            </returnable>
                            <dependent-models>
                                <model>model</model>
                            </dependent-models>
                            <dependent-instances>
                                <instance>instance</instance>
                            </dependent-instances>
                            <returnable-instances>
                                <instance>instance</instance>
                            </returnable-instances>
                        </analysis>
                    </binding>
                    <value>
                        <analysis expression=". - $bar" analyzed="true">
                            <value-dependent>
                                <path>instance('instance')/foo</path>
                                <path>instance('instance')/bar</path>
                            </value-dependent>
                            <dependent-models>
                                <model>model</model>
                            </dependent-models>
                            <dependent-instances>
                                <instance>instance</instance>
                            </dependent-instances>
                        </analysis>
                    </value>
                </variable>
                <output scope="" prefixed-id="osum" model-prefixed-id="model" binding="false" value="true">
                    <value>
                        <analysis expression="xs:string(($sum)[1])" analyzed="true">
                            <value-dependent>
                                <path>instance('instance')/foo</path>
                                <path>instance('instance')/bar</path>
                            </value-dependent>
                            <dependent-models>
                                <model>model</model>
                            </dependent-models>
                            <dependent-instances>
                                <instance>instance</instance>
                            </dependent-instances>
                        </analysis>
                    </value>
                </output>
                <output scope="" prefixed-id="oproduct" model-prefixed-id="model" binding="false" value="true">
                    <value>
                        <analysis expression="xs:string(($product)[1])" analyzed="true">
                            <value-dependent>
                                <path>instance('instance')/foo</path>
                                <path>instance('instance')/bar</path>
                            </value-dependent>
                            <dependent-models>
                                <model>model</model>
                            </dependent-models>
                            <dependent-instances>
                                <instance>instance</instance>
                            </dependent-instances>
                        </analysis>
                    </value>
                </output>
                <output scope="" prefixed-id="odifference" model-prefixed-id="model" binding="false" value="true">
                    <value>
                        <analysis expression="xs:string(($difference)[1])" analyzed="true">
                            <value-dependent>
                                <path>instance('instance')/foo</path>
                                <path>instance('instance')/bar</path>
                            </value-dependent>
                            <dependent-models>
                                <model>model</model>
                            </dependent-models>
                            <dependent-instances>
                                <instance>instance</instance>
                            </dependent-instances>
                        </analysis>
                    </value>
                </output>
                <model scope="" prefixed-id="model" default-instance-prefixed-id="instance" analyzed-binds="true">
                    <variable scope="" prefixed-id="vfoo" model-prefixed-id="model" binding="false" value="true" name="foo">
                        <value>
                            <analysis expression="foo" analyzed="true">
                                <returnable>
                                    <path>instance('instance')/foo</path>
                                </returnable>
                                <dependent-models>
                                    <model>model</model>
                                </dependent-models>
                                <dependent-instances>
                                    <instance>instance</instance>
                                </dependent-instances>
                                <returnable-instances>
                                    <instance>instance</instance>
                                </returnable-instances>
                            </analysis>
                        </value>
                    </variable>
                    <variable scope="" prefixed-id="vbar" model-prefixed-id="model" binding="false" value="true" name="bar">
                        <value>
                            <analysis expression="bar" analyzed="true">
                                <returnable>
                                    <path>instance('instance')/bar</path>
                                </returnable>
                                <dependent-models>
                                    <model>model</model>
                                </dependent-models>
                                <dependent-instances>
                                    <instance>instance</instance>
                                </dependent-instances>
                                <returnable-instances>
                                    <instance>instance</instance>
                                </returnable-instances>
                            </analysis>
                        </value>
                    </variable>
                </model>
            </request>
        </output>
    </test>

    <test description="XBL xxf:variable/xxf:sequence" name="oxf:java">
        <input name="config">
            <config sourcepath="oxf:/" class="org.orbeon.oxf.xforms.analysis.XPathAnalysisProcessor"/>
        </input>
        <input name="form">
            <xh:html xmlns:xxf="http://orbeon.org/oxf/xml/xforms" xmlns:fr="http://orbeon.org/oxf/xml/form-runner"
                     xmlns:exf="http://www.exforms.org/exf/1-0"
                     xmlns:xbl="http://www.w3.org/ns/xbl" xmlns:xxbl="http://orbeon.org/oxf/xml/xbl">
                <xh:head>

                    <xf:model xxf:xpath-analysis="true" id="model">

                        <xf:instance id="instance">
                            <instance>
                                <foo>42</foo>
                                <bar>43</bar>
                            </instance>
                        </xf:instance>

                        <xxf:variable id="vfoo" name="foo">
                            <xxf:sequence  select="foo"/>
                        </xxf:variable>
                        <xxf:variable id="vbar" name="bar">
                            <xxf:sequence  select="bar"/>
                        </xxf:variable>
                    </xf:model>
                    <xbl:xbl>
                        <xbl:binding id="fr-foo" element="fr|foo">
                            <xbl:implementation>
                                <xf:model id="model">
                                    <xf:instance id="instance">
                                        <instance/>
                                    </xf:instance>
                                </xf:model>
                            </xbl:implementation>
                            <xbl:template>

                                <xxf:variable id="iv" name="internal" select="."/>
                                <xxf:variable id="ov" name="external">
                                    <xxf:sequence xbl:attr="select=ref" xxbl:scope="outer"/>
                                </xxf:variable>
                                <xxf:variable id="ro" name="readonly" select="exf:readonly($external)"/>

                                <xf:group ref="$external" id="group-external"/>
                                <xf:output id="oexternal" value="$external"/>
                                <xf:output id="oro" value="$readonly"/>
                            </xbl:template>
                        </xbl:binding>
                    </xbl:xbl>
                </xh:head>
                <xh:body>
                    <fr:foo id="my-foo" ref="foo"/>
                </xh:body>
            </xh:html>
        </input>
        <output name="analysis">
            <request request-uri="/orbeon/doc/home-welcome" query-string="id=12&amp;print=false" method="GET">
                <foo scope="" prefixed-id="my-foo" model-prefixed-id="model" binding="true" value="false">
                    <binding>
                        <analysis expression="instance('instance')" analyzed="true">
                            <returnable>
                                <path>instance('instance')</path>
                            </returnable>
                            <dependent-models>
                                <model>model</model>
                            </dependent-models>
                            <dependent-instances>
                                <instance>instance</instance>
                            </dependent-instances>
                            <returnable-instances>
                                <instance>instance</instance>
                            </returnable-instances>
                        </analysis>
                    </binding>
                </foo>
                <variable scope="my-foo" prefixed-id="my-foo$iv" model-prefixed-id="my-foo$model" binding="false" value="true" name="internal">
                    <value>
                        <analysis expression="." analyzed="true">
                            <returnable>
                                <path>instance('my-foo$instance')</path>
                            </returnable>
                            <dependent-models>
                                <model>my-foo$model</model>
                            </dependent-models>
                            <dependent-instances>
                                <instance>my-foo$instance</instance>
                            </dependent-instances>
                            <returnable-instances>
                                <instance>my-foo$instance</instance>
                            </returnable-instances>
                        </analysis>
                    </value>
                </variable>
                <variable scope="my-foo" prefixed-id="my-foo$ov" model-prefixed-id="my-foo$model" binding="false" value="true" name="external">
                    <value>
                        <analysis expression="foo" analyzed="true">
                            <returnable>
                                <path>instance('instance')/foo</path>
                            </returnable>
                            <dependent-models>
                                <model>model</model>
                            </dependent-models>
                            <dependent-instances>
                                <instance>instance</instance>
                            </dependent-instances>
                            <returnable-instances>
                                <instance>instance</instance>
                            </returnable-instances>
                        </analysis>
                    </value>
                </variable>
                <variable scope="my-foo" prefixed-id="my-foo$ro" model-prefixed-id="my-foo$model" binding="false" value="true" name="readonly">
                    <value>
                        <analysis expression="exf:readonly($external)" analyzed="false"/>
                    </value>
                </variable>
                <group scope="my-foo" prefixed-id="my-foo$group-external" model-prefixed-id="my-foo$model" binding="true" value="false">
                    <binding>
                        <analysis expression="$external" analyzed="true">
                            <returnable>
                                <path>instance('instance')/foo</path>
                            </returnable>
                            <dependent-models>
                                <model>model</model>
                            </dependent-models>
                            <dependent-instances>
                                <instance>instance</instance>
                            </dependent-instances>
                            <returnable-instances>
                                <instance>instance</instance>
                            </returnable-instances>
                        </analysis>
                    </binding>
                </group>
                <output scope="my-foo" prefixed-id="my-foo$oexternal" model-prefixed-id="my-foo$model" binding="false" value="true">
                    <value>
                        <analysis expression="xs:string(($external)[1])" analyzed="true">
                            <value-dependent>
                                <path>instance('instance')/foo</path>
                            </value-dependent>
                            <dependent-models>
                                <model>model</model>
                            </dependent-models>
                            <dependent-instances>
                                <instance>instance</instance>
                            </dependent-instances>
                        </analysis>
                    </value>
                </output>
                <output scope="my-foo" prefixed-id="my-foo$oro" model-prefixed-id="my-foo$model" binding="false" value="true">
                    <value>
                        <analysis expression="xs:string(($readonly)[1])" analyzed="false"/>
                    </value>
                </output>
                <model scope="" prefixed-id="model" default-instance-prefixed-id="instance" analyzed-binds="true">
                    <variable scope="" prefixed-id="vfoo" model-prefixed-id="model" binding="false" value="true" name="foo">
                        <value>
                            <analysis expression="foo" analyzed="true">
                                <returnable>
                                    <path>instance('instance')/foo</path>
                                </returnable>
                                <dependent-models>
                                    <model>model</model>
                                </dependent-models>
                                <dependent-instances>
                                    <instance>instance</instance>
                                </dependent-instances>
                                <returnable-instances>
                                    <instance>instance</instance>
                                </returnable-instances>
                            </analysis>
                        </value>
                    </variable>
                    <variable scope="" prefixed-id="vbar" model-prefixed-id="model" binding="false" value="true" name="bar">
                        <value>
                            <analysis expression="bar" analyzed="true">
                                <returnable>
                                    <path>instance('instance')/bar</path>
                                </returnable>
                                <dependent-models>
                                    <model>model</model>
                                </dependent-models>
                                <dependent-instances>
                                    <instance>instance</instance>
                                </dependent-instances>
                                <returnable-instances>
                                    <instance>instance</instance>
                                </returnable-instances>
                            </analysis>
                        </value>
                    </variable>
                </model>
                <model scope="my-foo" prefixed-id="my-foo$model" default-instance-prefixed-id="my-foo$instance" analyzed-binds="true"/>
            </request>
        </output>
    </test>

    <test description="Expression both returning a node and using the node value in predicate" name="oxf:java">
        <input name="config">
            <config sourcepath="oxf:/" class="org.orbeon.oxf.xforms.analysis.XPathAnalysisProcessor"/>
        </input>
        <input name="form">
            <xh:html xmlns:xxf="http://orbeon.org/oxf/xml/xforms">
                <xh:head>
                    <xf:model id="model" xxf:xpath-analysis="true">
                        <xf:instance id="instance">
                            <instance><name/></instance>
                        </xf:instance>
                    </xf:model>
                </xh:head>
                <xh:body>
                    <xf:input id="input" ref="name[. = 42]"/>
                </xh:body>
            </xh:html>
        </input>
        <output name="analysis">
            <request request-uri="/orbeon/doc/home-welcome" query-string="id=12&amp;print=false" method="GET">
                <input scope="" prefixed-id="input" model-prefixed-id="model" binding="true" value="true">
                    <binding>
                        <analysis expression="name[. = 42]" analyzed="true">
                            <value-dependent>
                                <path>instance('instance')/name</path>
                            </value-dependent>
                            <returnable>
                                <path>instance('instance')/name</path>
                            </returnable>
                            <dependent-models>
                                <model>model</model>
                            </dependent-models>
                            <dependent-instances>
                                <instance>instance</instance>
                            </dependent-instances>
                            <returnable-instances>
                                <instance>instance</instance>
                            </returnable-instances>
                        </analysis>
                    </binding>
                    <value>
                        <analysis expression="xs:string(.[1])" analyzed="true">
                            <value-dependent>
                                <path>instance('instance')/name</path>
                            </value-dependent>
                            <dependent-models>
                                <model>model</model>
                            </dependent-models>
                            <dependent-instances>
                                <instance>instance</instance>
                            </dependent-instances>
                        </analysis>
                    </value>
                </input>
                <model scope="" prefixed-id="model" default-instance-prefixed-id="instance" analyzed-binds="true"/>
            </request>
        </output>
    </test>

    <test description="Binding depending on variable scoped in parent container" name="oxf:java">
        <input name="config">
            <config sourcepath="oxf:/" class="org.orbeon.oxf.xforms.analysis.XPathAnalysisProcessor"/>
        </input>
        <input name="form">
            <xh:html xmlns:xxf="http://orbeon.org/oxf/xml/xforms">
                <xh:head>
                    <xf:model id="model" xxf:xpath-analysis="true">
                        <xf:instance id="instance">
                            <instance><value/></instance>
                        </xf:instance>
                    </xf:model>
                </xh:head>
                <xh:body>
                    <xxf:variable id="show-variable" name="show" select="value = 'true'"/>
                    <xf:group id="enclosing-group">
                        <xf:group id="nested-group" ref=".[$show]"/>
                    </xf:group>

                </xh:body>
            </xh:html>
        </input>
        <output name="analysis">
            <request request-uri="/orbeon/doc/home-welcome" query-string="id=12&amp;print=false" method="GET">
                <variable scope="" prefixed-id="show-variable" model-prefixed-id="model" binding="false" value="true" name="show">
                    <value>
                        <analysis expression="value = 'true'" analyzed="true">
                            <value-dependent>
                                <path>instance('instance')/value</path>
                            </value-dependent>
                            <dependent-models>
                                <model>model</model>
                            </dependent-models>
                            <dependent-instances>
                                <instance>instance</instance>
                            </dependent-instances>
                        </analysis>
                    </value>
                </variable>
                <group scope="" prefixed-id="enclosing-group" model-prefixed-id="model" binding="false" value="false"/>
                <group scope="" prefixed-id="nested-group" model-prefixed-id="model" binding="true" value="false">
                    <binding>
                        <analysis expression=".[$show]" analyzed="true">
                            <value-dependent>
                                <path>instance('instance')/value</path>
                            </value-dependent>
                            <returnable>
                                <path>instance('instance')</path>
                            </returnable>
                            <dependent-models>
                                <model>model</model>
                            </dependent-models>
                            <dependent-instances>
                                <instance>instance</instance>
                            </dependent-instances>
                            <returnable-instances>
                                <instance>instance</instance>
                            </returnable-instances>
                        </analysis>
                    </binding>
                </group>
                <model scope="" prefixed-id="model" default-instance-prefixed-id="instance" analyzed-binds="true"/>
            </request>
        </output>
    </test>

    <test description="Top-level model with no instance" name="oxf:java">
        <input name="config">
            <config sourcepath="oxf:/" class="org.orbeon.oxf.xforms.analysis.XPathAnalysisProcessor"/>
        </input>
        <input name="form">
            <xh:html xmlns:xxf="http://orbeon.org/oxf/xml/xforms">
                <xh:head>
                    <xf:model id="model" xxf:xpath-analysis="true"/>
                </xh:head>
                <xh:body>
                    <xf:output id="output" value="current-date()"/>
                </xh:body>
            </xh:html>
        </input>
        <output name="analysis">
            <request request-uri="/orbeon/doc/home-welcome" query-string="id=12&amp;print=false" method="GET">
                <output scope="" prefixed-id="output" model-prefixed-id="model" binding="false" value="true">
                    <value>
                        <analysis expression="xs:string((current-date())[1])" analyzed="true"/>
                    </value>
                </output>
                <model scope="" prefixed-id="model" analyzed-binds="true"/>
            </request>
        </output>
    </test>

    <test description="XBL with no local model" name="oxf:java">
        <input name="config">
            <config sourcepath="oxf:/" class="org.orbeon.oxf.xforms.analysis.XPathAnalysisProcessor"/>
        </input>
        <input name="form">
            <xh:html xmlns:xxf="http://orbeon.org/oxf/xml/xforms" xmlns:fr="http://orbeon.org/oxf/xml/form-runner"
                     xmlns:exf="http://www.exforms.org/exf/1-0"
                     xmlns:xbl="http://www.w3.org/ns/xbl" xmlns:xxbl="http://orbeon.org/oxf/xml/xbl">
                <xh:head>
                    <xf:model xxf:xpath-analysis="true" id="model"/>
                    <xbl:xbl>
                        <xbl:binding id="fr-foo" element="fr|foo">
                            <xbl:template>
                                <xf:output id="output" value="current-date()"/>
                            </xbl:template>
                        </xbl:binding>
                    </xbl:xbl>
                </xh:head>
                <xh:body>
                    <fr:foo id="my-foo"/>
                </xh:body>
            </xh:html>
        </input>
        <output name="analysis">
            <request request-uri="/orbeon/doc/home-welcome" query-string="id=12&amp;print=false" method="GET">
                <foo scope="" prefixed-id="my-foo" model-prefixed-id="model" binding="false" value="false"/>
                <output scope="my-foo" prefixed-id="my-foo$output" binding="false" value="true">
                    <value>
                        <analysis expression="xs:string((current-date())[1])" analyzed="true"/>
                    </value>
                </output>
                <model scope="" prefixed-id="model" analyzed-binds="true"/>
            </request>
        </output>
    </test>

    <test description="Simple change of control validity based on MIP" name="oxf:pipeline">
        <input name="config" href="wrap-xforms-state.xpl"/>
        <input name="document">
            <xh:html xmlns:xxf="http://orbeon.org/oxf/xml/xforms">
                <xh:head>
                    <xf:model id="model" xxf:xpath-analysis="true">
                        <xf:instance id="i1">
                            <instance>
                                <a/>
                                <b/>
                            </instance>
                        </xf:instance>

                        <xf:bind id="b1" ref="instance()/a" constraint="../b = 'x'"/>

                        <xf:action ev:event="xforms-ready">
                            <xf:refresh/>
                            <xf:delete model="events-model" nodeset="*"/>

                            <!-- Cause a to become valid -->
                            <xf:setvalue ref="b">x</xf:setvalue>
                            <xf:refresh/>

                        </xf:action>

                    </xf:model>
                    <xf:model id="events-model">
                        <!-- TEST: Events to gather -->
                        <xf:instance id="events-instance">
                            <events/>
                        </xf:instance>
                    </xf:model>
                </xh:head>
                <xh:body>
                    <xf:insert ev:event="#all"
                                   model="events-model" context="." nodeset="*"
                                   origin="xxf:element('event',
                                            (xxf:attribute('type', xxf:event('xxf:type')),
                                             xxf:attribute('target', xxf:event('xxf:targetid'))))"/>


                    <xf:output id="g11" ref="a"/>

                </xh:body>
            </xh:html>
        </input>
        <output name="response">
            <xxf:event-response xmlns:xxf="http://orbeon.org/oxf/xml/xforms">
                <xxf:dynamic-state>
                    <dynamic-state>
                        <instances>
                            <instance id="i1" model-id="model">
                                <instance>
                                    <a/>
                                    <b>x</b>
                                </instance>
                            </instance>
                            <instance id="events-instance" model-id="events-model">
                                <events>
                                    <event type="xforms-valid" target="g11"/>
                                </events>
                            </instance>
                        </instances>
                    </dynamic-state>
                </xxf:dynamic-state>
                <xxf:action>
                    <xxf:control-values/>
                </xxf:action>
            </xxf:event-response>
        </output>
    </test>

    <test description="PO example: analysis" name="oxf:java">
        <input name="config">
            <config sourcepath="oxf:/" class="org.orbeon.oxf.xforms.analysis.XPathAnalysisProcessor"/>
        </input>
        <input name="form" href="oxf:/ops/unit-tests/xforms-server/po.xhtml"/>
        <output name="analysis">
            <request request-uri="/orbeon/doc/home-welcome" query-string="id=12&amp;print=false" method="GET">
                <repeat scope="" prefixed-id="item-repeat" model-prefixed-id="model" binding="true" value="false">
                    <binding>
                        <analysis expression="items/item" analyzed="true">
                            <returnable>
                                <path>instance('po')/items/item</path>
                            </returnable>
                            <dependent-models>
                                <model>model</model>
                            </dependent-models>
                            <dependent-instances>
                                <instance>po</instance>
                            </dependent-instances>
                            <returnable-instances>
                                <instance>po</instance>
                            </returnable-instances>
                        </analysis>
                    </binding>
                </repeat>
                <input scope="" prefixed-id="name" model-prefixed-id="model" binding="true" value="true">
                    <binding>
                        <analysis expression="name" analyzed="true">
                            <returnable>
                                <path>instance('po')/items/item/name</path>
                            </returnable>
                            <dependent-models>
                                <model>model</model>
                            </dependent-models>
                            <dependent-instances>
                                <instance>po</instance>
                            </dependent-instances>
                            <returnable-instances>
                                <instance>po</instance>
                            </returnable-instances>
                        </analysis>
                    </binding>
                    <value>
                        <analysis expression="xs:string(.[1])" analyzed="true">
                            <value-dependent>
                                <path>instance('po')/items/item/name</path>
                            </value-dependent>
                            <dependent-models>
                                <model>model</model>
                            </dependent-models>
                            <dependent-instances>
                                <instance>po</instance>
                            </dependent-instances>
                        </analysis>
                    </value>
                </input>
                <input scope="" prefixed-id="units" model-prefixed-id="model" binding="true" value="true">
                    <binding>
                        <analysis expression="units" analyzed="true">
                            <returnable>
                                <path>instance('po')/items/item/units</path>
                            </returnable>
                            <dependent-models>
                                <model>model</model>
                            </dependent-models>
                            <dependent-instances>
                                <instance>po</instance>
                            </dependent-instances>
                            <returnable-instances>
                                <instance>po</instance>
                            </returnable-instances>
                        </analysis>
                    </binding>
                    <value>
                        <analysis expression="xs:string(.[1])" analyzed="true">
                            <value-dependent>
                                <path>instance('po')/items/item/units</path>
                            </value-dependent>
                            <dependent-models>
                                <model>model</model>
                            </dependent-models>
                            <dependent-instances>
                                <instance>po</instance>
                            </dependent-instances>
                        </analysis>
                    </value>
                </input>
                <input scope="" prefixed-id="price" model-prefixed-id="model" binding="true" value="true">
                    <binding>
                        <analysis expression="price" analyzed="true">
                            <returnable>
                                <path>instance('po')/items/item/price</path>
                            </returnable>
                            <dependent-models>
                                <model>model</model>
                            </dependent-models>
                            <dependent-instances>
                                <instance>po</instance>
                            </dependent-instances>
                            <returnable-instances>
                                <instance>po</instance>
                            </returnable-instances>
                        </analysis>
                    </binding>
                    <value>
                        <analysis expression="xs:string(.[1])" analyzed="true">
                            <value-dependent>
                                <path>instance('po')/items/item/price</path>
                            </value-dependent>
                            <dependent-models>
                                <model>model</model>
                            </dependent-models>
                            <dependent-instances>
                                <instance>po</instance>
                            </dependent-instances>
                        </analysis>
                    </value>
                </input>
                <output scope="" prefixed-id="line-total" model-prefixed-id="model" binding="true" value="true">
                    <binding>
                        <analysis expression="total" analyzed="true">
                            <returnable>
                                <path>instance('po')/items/item/total</path>
                            </returnable>
                            <dependent-models>
                                <model>model</model>
                            </dependent-models>
                            <dependent-instances>
                                <instance>po</instance>
                            </dependent-instances>
                            <returnable-instances>
                                <instance>po</instance>
                            </returnable-instances>
                        </analysis>
                    </binding>
                    <value>
                        <analysis expression="xs:string(.[1])" analyzed="true">
                            <value-dependent>
                                <path>instance('po')/items/item/total</path>
                            </value-dependent>
                            <dependent-models>
                                <model>model</model>
                            </dependent-models>
                            <dependent-instances>
                                <instance>po</instance>
                            </dependent-instances>
                        </analysis>
                    </value>
                </output>
                <output scope="" prefixed-id="subtotal" model-prefixed-id="model" binding="true" value="true">
                    <binding>
                        <analysis expression="totals/subtotal" analyzed="true">
                            <returnable>
                                <path>instance('po')/totals/subtotal</path>
                            </returnable>
                            <dependent-models>
                                <model>model</model>
                            </dependent-models>
                            <dependent-instances>
                                <instance>po</instance>
                            </dependent-instances>
                            <returnable-instances>
                                <instance>po</instance>
                            </returnable-instances>
                        </analysis>
                    </binding>
                    <value>
                        <analysis expression="xs:string(.[1])" analyzed="true">
                            <value-dependent>
                                <path>instance('po')/totals/subtotal</path>
                            </value-dependent>
                            <dependent-models>
                                <model>model</model>
                            </dependent-models>
                            <dependent-instances>
                                <instance>po</instance>
                            </dependent-instances>
                        </analysis>
                    </value>
                </output>
                <output scope="" prefixed-id="tax" model-prefixed-id="model" binding="true" value="true">
                    <binding>
                        <analysis expression="totals/tax" analyzed="true">
                            <returnable>
                                <path>instance('po')/totals/tax</path>
                            </returnable>
                            <dependent-models>
                                <model>model</model>
                            </dependent-models>
                            <dependent-instances>
                                <instance>po</instance>
                            </dependent-instances>
                            <returnable-instances>
                                <instance>po</instance>
                            </returnable-instances>
                        </analysis>
                    </binding>
                    <value>
                        <analysis expression="xs:string(.[1])" analyzed="true">
                            <value-dependent>
                                <path>instance('po')/totals/tax</path>
                            </value-dependent>
                            <dependent-models>
                                <model>model</model>
                            </dependent-models>
                            <dependent-instances>
                                <instance>po</instance>
                            </dependent-instances>
                        </analysis>
                    </value>
                </output>
                <output scope="" prefixed-id="total" model-prefixed-id="model" binding="true" value="true">
                    <binding>
                        <analysis expression="totals/total" analyzed="true">
                            <returnable>
                                <path>instance('po')/totals/total</path>
                            </returnable>
                            <dependent-models>
                                <model>model</model>
                            </dependent-models>
                            <dependent-instances>
                                <instance>po</instance>
                            </dependent-instances>
                            <returnable-instances>
                                <instance>po</instance>
                            </returnable-instances>
                        </analysis>
                    </binding>
                    <value>
                        <analysis expression="xs:string(.[1])" analyzed="true">
                            <value-dependent>
                                <path>instance('po')/totals/total</path>
                            </value-dependent>
                            <dependent-models>
                                <model>model</model>
                            </dependent-models>
                            <dependent-instances>
                                <instance>po</instance>
                            </dependent-instances>
                        </analysis>
                    </value>
                </output>
                <model scope="" prefixed-id="model" default-instance-prefixed-id="po" analyzed-binds="true">
                    <binds>
                        <bind id="item-bind" ref="items/item">
                            <binding>
                                <analysis expression="items/item" analyzed="true">
                                    <returnable>
                                        <path>instance('po')/items/item</path>
                                    </returnable>
                                    <dependent-models>
                                        <model>model</model>
                                    </dependent-models>
                                    <dependent-instances>
                                        <instance>po</instance>
                                    </dependent-instances>
                                    <returnable-instances>
                                        <instance>po</instance>
                                    </returnable-instances>
                                </analysis>
                            </binding>
                            <bind id="name-bind" ref="name">
                                <binding>
                                    <analysis expression="name" analyzed="true">
                                        <returnable>
                                            <path>instance('po')/items/item/name</path>
                                        </returnable>
                                        <dependent-models>
                                            <model>model</model>
                                        </dependent-models>
                                        <dependent-instances>
                                            <instance>po</instance>
                                        </dependent-instances>
                                        <returnable-instances>
                                            <instance>po</instance>
                                        </returnable-instances>
                                    </analysis>
                                </binding>
                                <mip name="required" expression="true()">
                                    <analysis expression="xs:boolean((true())[1])" analyzed="true"/>
                                </mip>
                            </bind>
                            <bind id="units-bind" ref="units">
                                <binding>
                                    <analysis expression="units" analyzed="true">
                                        <returnable>
                                            <path>instance('po')/items/item/units</path>
                                        </returnable>
                                        <dependent-models>
                                            <model>model</model>
                                        </dependent-models>
                                        <dependent-instances>
                                            <instance>po</instance>
                                        </dependent-instances>
                                        <returnable-instances>
                                            <instance>po</instance>
                                        </returnable-instances>
                                    </analysis>
                                </binding>
                                <value>
                                    <analysis expression="xs:string(.[1])" analyzed="true">
                                        <value-dependent>
                                            <path>instance('po')/items/item/units</path>
                                        </value-dependent>
                                        <dependent-models>
                                            <model>model</model>
                                        </dependent-models>
                                        <dependent-instances>
                                            <instance>po</instance>
                                        </dependent-instances>
                                    </analysis>
                                </value>
                                <mip name="constraint" expression=". &gt; 0">
                                    <analysis expression="xs:boolean((. &gt; 0)[1])" analyzed="true">
                                        <value-dependent>
                                            <path>instance('po')/items/item/units</path>
                                        </value-dependent>
                                        <dependent-models>
                                            <model>model</model>
                                        </dependent-models>
                                        <dependent-instances>
                                            <instance>po</instance>
                                        </dependent-instances>
                                    </analysis>
                                </mip>
                            </bind>
                            <bind id="price-bind" ref="price">
                                <binding>
                                    <analysis expression="price" analyzed="true">
                                        <returnable>
                                            <path>instance('po')/items/item/price</path>
                                        </returnable>
                                        <dependent-models>
                                            <model>model</model>
                                        </dependent-models>
                                        <dependent-instances>
                                            <instance>po</instance>
                                        </dependent-instances>
                                        <returnable-instances>
                                            <instance>po</instance>
                                        </returnable-instances>
                                    </analysis>
                                </binding>
                                <value>
                                    <analysis expression="xs:string(.[1])" analyzed="true">
                                        <value-dependent>
                                            <path>instance('po')/items/item/price</path>
                                        </value-dependent>
                                        <dependent-models>
                                            <model>model</model>
                                        </dependent-models>
                                        <dependent-instances>
                                            <instance>po</instance>
                                        </dependent-instances>
                                    </analysis>
                                </value>
                                <mip name="constraint" expression=". &gt; 0">
                                    <analysis expression="xs:boolean((. &gt; 0)[1])" analyzed="true">
                                        <value-dependent>
                                            <path>instance('po')/items/item/price</path>
                                        </value-dependent>
                                        <dependent-models>
                                            <model>model</model>
                                        </dependent-models>
                                        <dependent-instances>
                                            <instance>po</instance>
                                        </dependent-instances>
                                    </analysis>
                                </mip>
                            </bind>
                            <bind id="line-total-bind" ref="total">
                                <binding>
                                    <analysis expression="total" analyzed="true">
                                        <returnable>
                                            <path>instance('po')/items/item/total</path>
                                        </returnable>
                                        <dependent-models>
                                            <model>model</model>
                                        </dependent-models>
                                        <dependent-instances>
                                            <instance>po</instance>
                                        </dependent-instances>
                                        <returnable-instances>
                                            <instance>po</instance>
                                        </returnable-instances>
                                    </analysis>
                                </binding>
                                <value>
                                    <analysis expression="xs:string(.[1])" analyzed="true">
                                        <value-dependent>
                                            <path>instance('po')/items/item/total</path>
                                        </value-dependent>
                                        <dependent-models>
                                            <model>model</model>
                                        </dependent-models>
                                        <dependent-instances>
                                            <instance>po</instance>
                                        </dependent-instances>
                                    </analysis>
                                </value>
                                <mip name="relevant" expression="for $u in ../units return $u castable as xs:decimal and $u &gt; 0">
                                    <analysis expression="xs:boolean((for $u in ../units return $u castable as xs:decimal and $u &gt; 0)[1])" analyzed="true">
                                        <value-dependent>
                                            <path>instance('po')/items/item/units</path>
                                        </value-dependent>
                                        <dependent-models>
                                            <model>model</model>
                                        </dependent-models>
                                        <dependent-instances>
                                            <instance>po</instance>
                                        </dependent-instances>
                                    </analysis>
                                </mip>
                                <mip name="calculate" expression="if (../units castable as xs:integer and ../price castable as xs:decimal) then ../units * ../price else '-'">
                                    <analysis expression="xs:string((if (../units castable as xs:integer and ../price castable as xs:decimal) then ../units * ../price else '-')[1])" analyzed="true">
                                        <value-dependent>
                                            <path>instance('po')/items/item/units</path>
                                            <path>instance('po')/items/item/price</path>
                                        </value-dependent>
                                        <dependent-models>
                                            <model>model</model>
                                        </dependent-models>
                                        <dependent-instances>
                                            <instance>po</instance>
                                        </dependent-instances>
                                    </analysis>
                                </mip>
                            </bind>
                        </bind>
                        <bind id="totals-bind" ref="totals">
                            <binding>
                                <analysis expression="totals" analyzed="true">
                                    <returnable>
                                        <path>instance('po')/totals</path>
                                    </returnable>
                                    <dependent-models>
                                        <model>model</model>
                                    </dependent-models>
                                    <dependent-instances>
                                        <instance>po</instance>
                                    </dependent-instances>
                                    <returnable-instances>
                                        <instance>po</instance>
                                    </returnable-instances>
                                </analysis>
                            </binding>
                            <bind id="subtotal-bind" ref="subtotal">
                                <binding>
                                    <analysis expression="subtotal" analyzed="true">
                                        <returnable>
                                            <path>instance('po')/totals/subtotal</path>
                                        </returnable>
                                        <dependent-models>
                                            <model>model</model>
                                        </dependent-models>
                                        <dependent-instances>
                                            <instance>po</instance>
                                        </dependent-instances>
                                        <returnable-instances>
                                            <instance>po</instance>
                                        </returnable-instances>
                                    </analysis>
                                </binding>
                                <value>
                                    <analysis expression="xs:string(.[1])" analyzed="true">
                                        <value-dependent>
                                            <path>instance('po')/totals/subtotal</path>
                                        </value-dependent>
                                        <dependent-models>
                                            <model>model</model>
                                        </dependent-models>
                                        <dependent-instances>
                                            <instance>po</instance>
                                        </dependent-instances>
                                    </analysis>
                                </value>
                                <mip name="calculate" expression="sum(for $t in ../../items/item/total[. castable as xs:decimal] return $t)">
                                    <analysis expression="xs:string((sum(for $t in ../../items/item/total[. castable as xs:decimal] return $t))[1])" analyzed="true">
                                        <value-dependent>
                                            <path>instance('po')/items/item/total</path>
                                        </value-dependent>
                                        <dependent-models>
                                            <model>model</model>
                                        </dependent-models>
                                        <dependent-instances>
                                            <instance>po</instance>
                                        </dependent-instances>
                                    </analysis>
                                </mip>
                            </bind>
                            <bind id="tax-bind" ref="tax">
                                <binding>
                                    <analysis expression="tax" analyzed="true">
                                        <returnable>
                                            <path>instance('po')/totals/tax</path>
                                        </returnable>
                                        <dependent-models>
                                            <model>model</model>
                                        </dependent-models>
                                        <dependent-instances>
                                            <instance>po</instance>
                                        </dependent-instances>
                                        <returnable-instances>
                                            <instance>po</instance>
                                        </returnable-instances>
                                    </analysis>
                                </binding>
                                <value>
                                    <analysis expression="xs:string(.[1])" analyzed="true">
                                        <value-dependent>
                                            <path>instance('po')/totals/tax</path>
                                        </value-dependent>
                                        <dependent-models>
                                            <model>model</model>
                                        </dependent-models>
                                        <dependent-instances>
                                            <instance>po</instance>
                                        </dependent-instances>
                                    </analysis>
                                </value>
                                <mip name="calculate" expression="../subtotal * ../../info/tax">
                                    <analysis expression="xs:string((../subtotal * ../../info/tax)[1])" analyzed="true">
                                        <value-dependent>
                                            <path>instance('po')/totals/subtotal</path>
                                            <path>instance('po')/info/tax</path>
                                        </value-dependent>
                                        <dependent-models>
                                            <model>model</model>
                                        </dependent-models>
                                        <dependent-instances>
                                            <instance>po</instance>
                                        </dependent-instances>
                                    </analysis>
                                </mip>
                            </bind>
                            <bind id="total-bind" ref="total">
                                <binding>
                                    <analysis expression="total" analyzed="true">
                                        <returnable>
                                            <path>instance('po')/totals/total</path>
                                        </returnable>
                                        <dependent-models>
                                            <model>model</model>
                                        </dependent-models>
                                        <dependent-instances>
                                            <instance>po</instance>
                                        </dependent-instances>
                                        <returnable-instances>
                                            <instance>po</instance>
                                        </returnable-instances>
                                    </analysis>
                                </binding>
                                <value>
                                    <analysis expression="xs:string(.[1])" analyzed="true">
                                        <value-dependent>
                                            <path>instance('po')/totals/total</path>
                                        </value-dependent>
                                        <dependent-models>
                                            <model>model</model>
                                        </dependent-models>
                                        <dependent-instances>
                                            <instance>po</instance>
                                        </dependent-instances>
                                    </analysis>
                                </value>
                                <mip name="calculate" expression="for $t in ../subtotal + ../tax return if ($t &gt; 4000) then $t else $t * 0.9">
                                    <analysis expression="xs:string((for $t in ../subtotal + ../tax return if ($t &gt; 4000) then $t else $t * 0.9)[1])" analyzed="true">
                                        <value-dependent>
                                            <path>instance('po')/totals/subtotal</path>
                                            <path>instance('po')/totals/tax</path>
                                        </value-dependent>
                                        <dependent-models>
                                            <model>model</model>
                                        </dependent-models>
                                        <dependent-instances>
                                            <instance>po</instance>
                                        </dependent-instances>
                                    </analysis>
                                </mip>
                            </bind>
                        </bind>
                        <bind id="info-tax-bind" ref="info/tax">
                            <binding>
                                <analysis expression="info/tax" analyzed="true">
                                    <returnable>
                                        <path>instance('po')/info/tax</path>
                                    </returnable>
                                    <dependent-models>
                                        <model>model</model>
                                    </dependent-models>
                                    <dependent-instances>
                                        <instance>po</instance>
                                    </dependent-instances>
                                    <returnable-instances>
                                        <instance>po</instance>
                                    </returnable-instances>
                                </analysis>
                            </binding>
                            <value>
                                <analysis expression="xs:string(.[1])" analyzed="true">
                                    <value-dependent>
                                        <path>instance('po')/info/tax</path>
                                    </value-dependent>
                                    <dependent-models>
                                        <model>model</model>
                                    </dependent-models>
                                    <dependent-instances>
                                        <instance>po</instance>
                                    </dependent-instances>
                                </analysis>
                            </value>
                        </bind>
                    </binds>
                    <bind-instances>
                        <instance>po</instance>
                    </bind-instances>
                    <computed-binds-instances>
                        <instance>po</instance>
                    </computed-binds-instances>
                    <validation-binds-instances>
                        <instance>po</instance>
                    </validation-binds-instances>
                </model>
                <model scope="" prefixed-id="events-model" default-instance-prefixed-id="events-instance" analyzed-binds="true"/>
            </request>
        </output>
    </test>

    <test description="PO example: change to values causing change to MIPs" name="oxf:pipeline">
        <input name="config" href="wrap-xforms-state.xpl"/>
        <input name="document" href="oxf:/ops/unit-tests/xforms-server/po.xhtml"/>
        <output name="response">
            <xxf:event-response xmlns:xxf="http://orbeon.org/oxf/xml/xforms">
                <xxf:dynamic-state>
                    <dynamic-state>
                        <instances>
                            <instance id="po" model-id="model" types="true">
                                <purchaseOrder>
                                    <items>
                                        <item>
                                            <name>Item 1</name>
                                            <units>3</units>
                                            <price>60</price>
                                            <total>180</total>
                                        </item>
                                        <item>
                                            <name>Item 2</name>
                                            <units>1</units>
                                            <price>500</price>
                                            <total>500</total>
                                        </item>
                                        <item>
                                            <name>Item 3</name>
                                            <units>1</units>
                                            <price>1500</price>
                                            <total>1500</total>
                                        </item>
                                    </items>
                                    <totals>
                                        <subtotal>2180</subtotal>
                                        <tax>479.6</tax>
                                        <total>2393.64</total>
                                    </totals>
                                    <info>
                                        <tax>0.22</tax>
                                    </info>
                                </purchaseOrder>
                            </instance>
                            <instance id="events-instance" model-id="events-model" types="true">
                                <events>
                                    <event type="xforms-value-changed" target="price" indexes="1"/>
                                    <event type="xforms-invalid" target="price" indexes="1"/>
                                    <event type="xforms-value-changed" target="line-total" indexes="1"/>
                                    <event type="xforms-invalid" target="line-total" indexes="1"/>
                                    <event type="xforms-value-changed" target="subtotal" indexes=""/>
                                    <event type="xforms-value-changed" target="tax" indexes=""/>
                                    <event type="xforms-value-changed" target="total" indexes=""/>
                                    <event type="xforms-value-changed" target="price" indexes="1"/>
                                    <event type="xforms-valid" target="price" indexes="1"/>
                                    <event type="xforms-value-changed" target="line-total" indexes="1"/>
                                    <event type="xforms-valid" target="line-total" indexes="1"/>
                                    <event type="xforms-value-changed" target="subtotal" indexes=""/>
                                    <event type="xforms-value-changed" target="tax" indexes=""/>
                                    <event type="xforms-value-changed" target="total" indexes=""/>
                                </events>
                            </instance>
                        </instances>
                        <controls>
                            <control effective-id="item-repeat" index="1"/>
                        </controls>
                    </dynamic-state>
                </xxf:dynamic-state>
                <xxf:action>
                    <xxf:control-values>
                        <xxf:control id="name1" required="true">Item 1</xxf:control>
                        <xxf:control id="units1" type="{http://www.w3.org/2001/XMLSchema}integer">3</xxf:control>
                        <xxf:control id="price1" type="{http://www.w3.org/2001/XMLSchema}decimal">60</xxf:control>
                        <xxf:control id="line-total1" readonly="true" type="{http://www.w3.org/2001/XMLSchema}decimal">180.00</xxf:control>
                        <xxf:control id="name2" required="true">Item 2</xxf:control>
                        <xxf:control id="units2" type="{http://www.w3.org/2001/XMLSchema}integer">1</xxf:control>
                        <xxf:control id="price2" type="{http://www.w3.org/2001/XMLSchema}decimal">500</xxf:control>
                        <xxf:control id="line-total2" readonly="true" type="{http://www.w3.org/2001/XMLSchema}decimal">500.00</xxf:control>
                        <xxf:control id="name3" required="true">Item 3</xxf:control>
                        <xxf:control id="units3" type="{http://www.w3.org/2001/XMLSchema}integer">1</xxf:control>
                        <xxf:control id="price3" type="{http://www.w3.org/2001/XMLSchema}decimal">1500</xxf:control>
                        <xxf:control id="line-total3" readonly="true" type="{http://www.w3.org/2001/XMLSchema}decimal">1,500.00</xxf:control>
                        <xxf:control id="subtotal" readonly="true" type="{http://www.w3.org/2001/XMLSchema}decimal">2,180.00</xxf:control>
                        <xxf:control id="tax" readonly="true" type="{http://www.w3.org/2001/XMLSchema}decimal">479.60</xxf:control>
                        <xxf:control id="total" readonly="true" type="{http://www.w3.org/2001/XMLSchema}decimal">2,393.64</xxf:control>
                    </xxf:control-values>
                </xxf:action>
            </xxf:event-response>
        </output>
    </test>

    <test description="Simple use of last() function" name="oxf:java">
        <input name="config">
            <config sourcepath="oxf:/" class="org.orbeon.oxf.xforms.analysis.XPathAnalysisProcessor"/>
        </input>
        <input name="form">
            <xh:html xmlns:xxf="http://orbeon.org/oxf/xml/xforms" xmlns:fr="http://orbeon.org/oxf/xml/form-runner"
                     xmlns:exf="http://www.exforms.org/exf/1-0"
                     xmlns:xbl="http://www.w3.org/ns/xbl" xmlns:xxbl="http://orbeon.org/oxf/xml/xbl">
                <xh:head>
                    <xf:model xxf:xpath-analysis="true" id="model">
                        <xf:instance id="i1">
                            <instance/>
                        </xf:instance>
                    </xf:model>
                </xh:head>
                <xh:body>
                    <xf:output id="01" value="a[last()]/b"/>
                </xh:body>
            </xh:html>
        </input>
        <output name="analysis">
            <request request-uri="/orbeon/doc/home-welcome" query-string="id=12&amp;print=false" method="GET">
                <output scope="" prefixed-id="01" model-prefixed-id="model" binding="false" value="true">
                    <value>
                        <analysis expression="xs:string((a[last()]/b)[1])" analyzed="true">
                            <value-dependent>
                                <path>instance('i1')/a/b</path>
                            </value-dependent>
                            <dependent-models>
                                <model>model</model>
                            </dependent-models>
                            <dependent-instances>
                                <instance>i1</instance>
                            </dependent-instances>
                        </analysis>
                    </value>
                </output>
                <model scope="" prefixed-id="model" default-instance-prefixed-id="i1" analyzed-binds="true"/>
            </request>
        </output>
    </test>

    <test description="Simple use of xxf:context() function" name="oxf:java">
        <input name="config">
            <config sourcepath="oxf:/" class="org.orbeon.oxf.xforms.analysis.XPathAnalysisProcessor"/>
        </input>
        <input name="form">
            <xh:html xmlns:xxf="http://orbeon.org/oxf/xml/xforms" xmlns:fr="http://orbeon.org/oxf/xml/form-runner"
                     xmlns:exf="http://www.exforms.org/exf/1-0"
                     xmlns:xbl="http://www.w3.org/ns/xbl" xmlns:xxbl="http://orbeon.org/oxf/xml/xbl">
                <xh:head>
                    <xf:model xxf:xpath-analysis="true" id="model">
                        <xf:instance id="i1">
                            <instance>
                                <foo/>
                                <bar/>
                            </instance>
                        </xf:instance>
                        <xf:instance id="i2">
                            <instance>
                                <foo/>
                                <bar/>
                            </instance>
                        </xf:instance>
                        <xf:instance id="i3">
                            <instance>
                                <foo/>
                                <bar/>
                            </instance>
                        </xf:instance>
                    </xf:model>
                </xh:head>
                <xh:body>
                    <xf:group id="g1" ref="instance()/foo">
                        <xf:group id="g2" ref="instance('i2')/foo">
                            <xf:group id="g3" ref="instance('i3')/foo">
                                <xf:output id="o1" value="xxf:context('g1')/../bar"/>
                                <xf:output id="o2" value="xxf:context('g2')/../bar"/>
                                <xf:output id="o3" value="xxf:context('g3')/../bar"/>

                                <xf:output id="o4" value="xxf:context('o4')/../bar"/>
                            </xf:group>
                        </xf:group>
                    </xf:group>
                </xh:body>
            </xh:html>
        </input>
        <output name="analysis">
            <request request-uri="/orbeon/doc/home-welcome" query-string="id=12&amp;print=false" method="GET">
                <group scope="" prefixed-id="g1" model-prefixed-id="model" binding="true" value="false">
                    <binding>
                        <analysis expression="instance()/foo" analyzed="true">
                            <returnable>
                                <path>instance('i1')/foo</path>
                            </returnable>
                            <dependent-models>
                                <model>model</model>
                            </dependent-models>
                            <dependent-instances>
                                <instance>i1</instance>
                            </dependent-instances>
                            <returnable-instances>
                                <instance>i1</instance>
                            </returnable-instances>
                        </analysis>
                    </binding>
                </group>
                <group scope="" prefixed-id="g2" model-prefixed-id="model" binding="true" value="false">
                    <binding>
                        <analysis expression="instance('i2')/foo" analyzed="true">
                            <returnable>
                                <path>instance('i2')/foo</path>
                            </returnable>
                            <dependent-models>
                                <model>model</model>
                            </dependent-models>
                            <dependent-instances>
                                <instance>i2</instance>
                            </dependent-instances>
                            <returnable-instances>
                                <instance>i2</instance>
                            </returnable-instances>
                        </analysis>
                    </binding>
                </group>
                <group scope="" prefixed-id="g3" model-prefixed-id="model" binding="true" value="false">
                    <binding>
                        <analysis expression="instance('i3')/foo" analyzed="true">
                            <returnable>
                                <path>instance('i3')/foo</path>
                            </returnable>
                            <dependent-models>
                                <model>model</model>
                            </dependent-models>
                            <dependent-instances>
                                <instance>i3</instance>
                            </dependent-instances>
                            <returnable-instances>
                                <instance>i3</instance>
                            </returnable-instances>
                        </analysis>
                    </binding>
                </group>
                <output scope="" prefixed-id="o1" model-prefixed-id="model" binding="false" value="true">
                    <value>
                        <analysis expression="xs:string((xxf:context('g1')/../bar)[1])" analyzed="true">
                            <value-dependent>
                                <path>instance('i1')/bar</path>
                            </value-dependent>
                            <dependent-models>
                                <model>model</model>
                            </dependent-models>
                            <dependent-instances>
                                <instance>i1</instance>
                            </dependent-instances>
                        </analysis>
                    </value>
                </output>
                <output scope="" prefixed-id="o2" model-prefixed-id="model" binding="false" value="true">
                    <value>
                        <analysis expression="xs:string((xxf:context('g2')/../bar)[1])" analyzed="true">
                            <value-dependent>
                                <path>instance('i2')/bar</path>
                            </value-dependent>
                            <dependent-models>
                                <model>model</model>
                            </dependent-models>
                            <dependent-instances>
                                <instance>i2</instance>
                            </dependent-instances>
                        </analysis>
                    </value>
                </output>
                <output scope="" prefixed-id="o3" model-prefixed-id="model" binding="false" value="true">
                    <value>
                        <analysis expression="xs:string((xxf:context('g3')/../bar)[1])" analyzed="true">
                            <value-dependent>
                                <path>instance('i3')/bar</path>
                            </value-dependent>
                            <dependent-models>
                                <model>model</model>
                            </dependent-models>
                            <dependent-instances>
                                <instance>i3</instance>
                            </dependent-instances>
                        </analysis>
                    </value>
                </output>
                <output scope="" prefixed-id="o4" model-prefixed-id="model" binding="false" value="true">
                    <value>
                        <analysis expression="xs:string((xxf:context('o4')/../bar)[1])" analyzed="true">
                            <value-dependent>
                                <path>instance('i3')/bar</path>
                            </value-dependent>
                            <dependent-models>
                                <model>model</model>
                            </dependent-models>
                            <dependent-instances>
                                <instance>i3</instance>
                            </dependent-instances>
                        </analysis>
                    </value>
                </output>
                <model scope="" prefixed-id="model" default-instance-prefixed-id="i1" analyzed-binds="true"/>
            </request>
        </output>
    </test>

    <test description="Simple use of xxf:repeat-current() function" name="oxf:java">
        <input name="config">
            <config sourcepath="oxf:/" class="org.orbeon.oxf.xforms.analysis.XPathAnalysisProcessor"/>
        </input>
        <input name="form">
            <xh:html xmlns:xxf="http://orbeon.org/oxf/xml/xforms" xmlns:fr="http://orbeon.org/oxf/xml/form-runner"
                     xmlns:exf="http://www.exforms.org/exf/1-0"
                     xmlns:xbl="http://www.w3.org/ns/xbl" xmlns:xxbl="http://orbeon.org/oxf/xml/xbl">
                <xh:head>
                    <xf:model xxf:xpath-analysis="true" id="model">
                        <xf:instance id="i1">
                            <instance/>
                        </xf:instance>
                        <xf:instance id="i2">
                            <instance/>
                        </xf:instance>
                    </xf:model>
                </xh:head>
                <xh:body>
                    <xf:repeat id="r1" ref="instance()/foo">
                        <xf:repeat id="r2" ref="instance('i2')/foo">
                            <xf:output id="o1" value="xxf:repeat-current('r1')/../bar"/>
                            <xf:output id="o2" value="xxf:repeat-current('r2')/../bar"/>
                            <xf:output id="o3" value="xxf:repeat-current()/../bar"/>
                            <xf:output id="o4" value="gaga[toto = xxf:repeat-current('r1')]"/>
                            <xf:output id="o5" value="gaga[toto = xxf:repeat-current('r2')]"/>
                            <xf:output id="o6" value="gaga[toto = xxf:repeat-current()]"/>
                        </xf:repeat>
                    </xf:repeat>
                </xh:body>
            </xh:html>
        </input>
        <output name="analysis">
            <request request-uri="/orbeon/doc/home-welcome" query-string="id=12&amp;print=false" method="GET">
                <repeat scope="" prefixed-id="r1" model-prefixed-id="model" binding="true" value="false">
                    <binding>
                        <analysis expression="instance()/foo" analyzed="true">
                            <returnable>
                                <path>instance('i1')/foo</path>
                            </returnable>
                            <dependent-models>
                                <model>model</model>
                            </dependent-models>
                            <dependent-instances>
                                <instance>i1</instance>
                            </dependent-instances>
                            <returnable-instances>
                                <instance>i1</instance>
                            </returnable-instances>
                        </analysis>
                    </binding>
                </repeat>
                <repeat scope="" prefixed-id="r2" model-prefixed-id="model" binding="true" value="false">
                    <binding>
                        <analysis expression="instance('i2')/foo" analyzed="true">
                            <returnable>
                                <path>instance('i2')/foo</path>
                            </returnable>
                            <dependent-models>
                                <model>model</model>
                            </dependent-models>
                            <dependent-instances>
                                <instance>i2</instance>
                            </dependent-instances>
                            <returnable-instances>
                                <instance>i2</instance>
                            </returnable-instances>
                        </analysis>
                    </binding>
                </repeat>
                <output scope="" prefixed-id="o1" model-prefixed-id="model" binding="false" value="true">
                    <value>
                        <analysis expression="xs:string((xxf:repeat-current('r1')/../bar)[1])" analyzed="true">
                            <value-dependent>
                                <path>instance('i1')/bar</path>
                            </value-dependent>
                            <dependent-models>
                                <model>model</model>
                            </dependent-models>
                            <dependent-instances>
                                <instance>i1</instance>
                            </dependent-instances>
                        </analysis>
                    </value>
                </output>
                <output scope="" prefixed-id="o2" model-prefixed-id="model" binding="false" value="true">
                    <value>
                        <analysis expression="xs:string((xxf:repeat-current('r2')/../bar)[1])" analyzed="true">
                            <value-dependent>
                                <path>instance('i2')/bar</path>
                            </value-dependent>
                            <dependent-models>
                                <model>model</model>
                            </dependent-models>
                            <dependent-instances>
                                <instance>i2</instance>
                            </dependent-instances>
                        </analysis>
                    </value>
                </output>
                <output scope="" prefixed-id="o3" model-prefixed-id="model" binding="false" value="true">
                    <value>
                        <analysis expression="xs:string((xxf:repeat-current()/../bar)[1])" analyzed="true">
                            <value-dependent>
                                <path>instance('i2')/bar</path>
                            </value-dependent>
                            <dependent-models>
                                <model>model</model>
                            </dependent-models>
                            <dependent-instances>
                                <instance>i2</instance>
                            </dependent-instances>
                        </analysis>
                    </value>
                </output>
                <output scope="" prefixed-id="o4" model-prefixed-id="model" binding="false" value="true">
                    <value>
                        <analysis expression="xs:string((gaga[toto = xxf:repeat-current('r1')])[1])" analyzed="true">
                            <value-dependent>
                                <path>instance('i2')/foo/gaga</path>
                                <path>instance('i2')/foo/gaga/toto</path>
                                <path>instance('i1')/foo</path>
                            </value-dependent>
                            <dependent-models>
                                <model>model</model>
                            </dependent-models>
                            <dependent-instances>
                                <instance>i2</instance>
                                <instance>i1</instance>
                            </dependent-instances>
                        </analysis>
                    </value>
                </output>
                <output scope="" prefixed-id="o5" model-prefixed-id="model" binding="false" value="true">
                    <value>
                        <analysis expression="xs:string((gaga[toto = xxf:repeat-current('r2')])[1])" analyzed="true">
                            <value-dependent>
                                <path>instance('i2')/foo/gaga</path>
                                <path>instance('i2')/foo/gaga/toto</path>
                                <path>instance('i2')/foo</path>
                            </value-dependent>
                            <dependent-models>
                                <model>model</model>
                            </dependent-models>
                            <dependent-instances>
                                <instance>i2</instance>
                            </dependent-instances>
                        </analysis>
                    </value>
                </output>
                <output scope="" prefixed-id="o6" model-prefixed-id="model" binding="false" value="true">
                    <value>
                        <analysis expression="xs:string((gaga[toto = xxf:repeat-current()])[1])" analyzed="true">
                            <value-dependent>
                                <path>instance('i2')/foo/gaga</path>
                                <path>instance('i2')/foo/gaga/toto</path>
                                <path>instance('i2')/foo</path>
                            </value-dependent>
                            <dependent-models>
                                <model>model</model>
                            </dependent-models>
                            <dependent-instances>
                                <instance>i2</instance>
                            </dependent-instances>
                        </analysis>
                    </value>
                </output>
                <model scope="" prefixed-id="model" default-instance-prefixed-id="i1" analyzed-binds="true"/>
            </request>
        </output>
    </test>

    <test description="Simple use of xxf:serialize() function" name="oxf:java">
        <input name="config">
            <config sourcepath="oxf:/" class="org.orbeon.oxf.xforms.analysis.XPathAnalysisProcessor"/>
        </input>
        <input name="form">
            <xh:html xmlns:xxf="http://orbeon.org/oxf/xml/xforms" xmlns:fr="http://orbeon.org/oxf/xml/form-runner"
                     xmlns:exf="http://www.exforms.org/exf/1-0"
                     xmlns:xbl="http://www.w3.org/ns/xbl" xmlns:xxbl="http://orbeon.org/oxf/xml/xbl">
                <xh:head>
                    <xf:model xxf:xpath-analysis="true" id="model">
                        <xf:instance id="i1">
                            <instance/>
                        </xf:instance>
                        <xf:instance id="i2">
                            <instance/>
                        </xf:instance>
                    </xf:model>
                </xh:head>
                <xh:body>
                    <xf:output id="o1" value="xxf:serialize(instance()/foo/bar, 'xml')"/>
                    <xf:output id="o2" value="xxf:serialize(instance('i2')/foo/bar, 'html')"/>
                    <xf:output id="o3" value="xxf:serialize(instance()/foo/bar, instance('i2')/gaga)"/>
                </xh:body>
            </xh:html>
        </input>
        <output name="analysis">
            <request request-uri="/orbeon/doc/home-welcome" query-string="id=12&amp;print=false" method="GET">
                <output scope="" prefixed-id="o1" model-prefixed-id="model" binding="false" value="true">
                    <value>
                        <analysis expression="xs:string((xxf:serialize(instance()/foo/bar, 'xml'))[1])" analyzed="true">
                            <value-dependent>
                                <path>instance('i1')/foo/bar</path>
                            </value-dependent>
                            <dependent-models>
                                <model>model</model>
                            </dependent-models>
                            <dependent-instances>
                                <instance>i1</instance>
                            </dependent-instances>
                        </analysis>
                    </value>
                </output>
                <output scope="" prefixed-id="o2" model-prefixed-id="model" binding="false" value="true">
                    <value>
                        <analysis expression="xs:string((xxf:serialize(instance('i2')/foo/bar, 'html'))[1])" analyzed="true">
                            <value-dependent>
                                <path>instance('i2')/foo/bar</path>
                            </value-dependent>
                            <dependent-models>
                                <model>model</model>
                            </dependent-models>
                            <dependent-instances>
                                <instance>i2</instance>
                            </dependent-instances>
                        </analysis>
                    </value>
                </output>
                <output scope="" prefixed-id="o3" model-prefixed-id="model" binding="false" value="true">
                    <value>
                        <analysis expression="xs:string((xxf:serialize(instance()/foo/bar, instance('i2')/gaga))[1])" analyzed="true">
                            <value-dependent>
                                <path>instance('i1')/foo/bar</path>
                                <path>instance('i2')/gaga</path>
                            </value-dependent>
                            <dependent-models>
                                <model>model</model>
                            </dependent-models>
                            <dependent-instances>
                                <instance>i1</instance>
                                <instance>i2</instance>
                            </dependent-instances>
                        </analysis>
                    </value>
                </output>
                <model scope="" prefixed-id="model" default-instance-prefixed-id="i1" analyzed-binds="true"/>
            </request>
        </output>
    </test>

    <test description="Expressions containing AtomicMappingExpression such as a/count(b) or a/sum(b)" name="oxf:java">
        <!-- See: http://forge.ow2.org/tracker/index.php?func=detail&aid=315523&group_id=168&atid=350207 -->
        <input name="config">
            <config sourcepath="oxf:/" class="org.orbeon.oxf.xforms.analysis.XPathAnalysisProcessor"/>
        </input>
        <input name="form">
            <xh:html xmlns:xxf="http://orbeon.org/oxf/xml/xforms">
                <xh:head>
                    <xf:model id="model" xxf:xpath-analysis="true">
                        <xf:instance id="instance">
                            <instance/>
                        </xf:instance>
                    </xf:model>
                </xh:head>
                <xh:body>
                    <xf:output id="o11" value="a/count(b)"/>
                    <xf:output id="o12" value="a/count(following-sibling::b)"/>
                    <xf:output id="o13" value="a/count(preceding-sibling::b)"/>
                    <xf:output id="o14" value="a/count(self::a)"/>
                    <xf:output id="o15" value="a/b/count(ancestor::a)"/>

                    <xf:output id="o21" value="a/sum(b)"/>
                    <xf:output id="o22" value="a/sum(following-sibling::b)"/>
                    <xf:output id="o23" value="a/sum(preceding-sibling::b)"/>
                    <xf:output id="o24" value="a/sum(self::a)"/>
                    <xf:output id="o25" value="a/b/sum(ancestor::a)"/>
                </xh:body>
            </xh:html>
        </input>
        <output name="analysis">
            <request request-uri="/orbeon/doc/home-welcome" query-string="id=12&amp;print=false" method="GET">
                <output scope="" prefixed-id="o11" model-prefixed-id="model" binding="false" value="true">
                    <value>
                        <analysis expression="xs:string((a/count(b))[1])" analyzed="true">
                            <dependent-models>
                                <model>model</model>
                            </dependent-models>
                            <dependent-instances>
                                <instance>instance</instance>
                            </dependent-instances>
                        </analysis>
                    </value>
                </output>
                <output scope="" prefixed-id="o12" model-prefixed-id="model" binding="false" value="true">
                    <value>
                        <analysis expression="xs:string((a/count(following-sibling::b))[1])" analyzed="true">
                            <dependent-models>
                                <model>model</model>
                            </dependent-models>
                            <dependent-instances>
                                <instance>instance</instance>
                            </dependent-instances>
                        </analysis>
                    </value>
                </output>
                <output scope="" prefixed-id="o13" model-prefixed-id="model" binding="false" value="true">
                    <value>
                        <analysis expression="xs:string((a/count(preceding-sibling::b))[1])" analyzed="true">
                            <dependent-models>
                                <model>model</model>
                            </dependent-models>
                            <dependent-instances>
                                <instance>instance</instance>
                            </dependent-instances>
                        </analysis>
                    </value>
                </output>
                <output scope="" prefixed-id="o14" model-prefixed-id="model" binding="false" value="true">
                    <value>
                        <analysis expression="xs:string((a/count(self::a))[1])" analyzed="true">
                            <dependent-models>
                                <model>model</model>
                            </dependent-models>
                            <dependent-instances>
                                <instance>instance</instance>
                            </dependent-instances>
                        </analysis>
                    </value>
                </output>
                <output scope="" prefixed-id="o15" model-prefixed-id="model" binding="false" value="true">
                    <value>
                        <analysis expression="xs:string((a/b/count(ancestor::a))[1])" analyzed="true">
                            <dependent-models>
                                <model>model</model>
                            </dependent-models>
                            <dependent-instances>
                                <instance>instance</instance>
                            </dependent-instances>
                        </analysis>
                    </value>
                </output>
                <output scope="" prefixed-id="o21" model-prefixed-id="model" binding="false" value="true">
                    <value>
                        <analysis expression="xs:string((a/sum(b))[1])" analyzed="true">
                            <value-dependent>
                                <path>instance('instance')/a/b</path>
                            </value-dependent>
                            <dependent-models>
                                <model>model</model>
                            </dependent-models>
                            <dependent-instances>
                                <instance>instance</instance>
                            </dependent-instances>
                        </analysis>
                    </value>
                </output>
                <output scope="" prefixed-id="o22" model-prefixed-id="model" binding="false" value="true">
                    <value>
                        <analysis expression="xs:string((a/sum(following-sibling::b))[1])" analyzed="true">
                            <value-dependent>
                                <path>instance('instance')/b</path>
                            </value-dependent>
                            <dependent-models>
                                <model>model</model>
                            </dependent-models>
                            <dependent-instances>
                                <instance>instance</instance>
                            </dependent-instances>
                        </analysis>
                    </value>
                </output>
                <output scope="" prefixed-id="o23" model-prefixed-id="model" binding="false" value="true">
                    <value>
                        <analysis expression="xs:string((a/sum(preceding-sibling::b))[1])" analyzed="true">
                            <value-dependent>
                                <path>instance('instance')/b</path>
                            </value-dependent>
                            <dependent-models>
                                <model>model</model>
                            </dependent-models>
                            <dependent-instances>
                                <instance>instance</instance>
                            </dependent-instances>
                        </analysis>
                    </value>
                </output>
                <output scope="" prefixed-id="o24" model-prefixed-id="model" binding="false" value="true">
                    <value>
                        <analysis expression="xs:string((a/sum(self::a))[1])" analyzed="true">
                            <value-dependent>
                                <path>instance('instance')/a</path>
                            </value-dependent>
                            <dependent-models>
                                <model>model</model>
                            </dependent-models>
                            <dependent-instances>
                                <instance>instance</instance>
                            </dependent-instances>
                        </analysis>
                    </value>
                </output>
                <output scope="" prefixed-id="o25" model-prefixed-id="model" binding="false" value="true">
                    <value>
                        <analysis expression="xs:string((a/b/sum(ancestor::a))[1])" analyzed="true">
                            <value-dependent>
                                <path>instance('instance')/a</path>
                            </value-dependent>
                            <dependent-models>
                                <model>model</model>
                            </dependent-models>
                            <dependent-instances>
                                <instance>instance</instance>
                            </dependent-instances>
                        </analysis>
                    </value>
                </output>
                <model scope="" prefixed-id="model" default-instance-prefixed-id="instance" analyzed-binds="true"/>
            </request>
        </output>
    </test>

    <test description="Logging of paths containing attributes" name="oxf:java">
        <input name="config">
            <config sourcepath="oxf:/" class="org.orbeon.oxf.xforms.analysis.XPathAnalysisProcessor"/>
        </input>
        <input name="form">
            <xh:html xmlns:xxf="http://orbeon.org/oxf/xml/xforms">
                <xh:head>
                    <xf:model id="model" xxf:xpath-analysis="true">
                        <xf:instance id="instance">
                            <instance/>
                        </xf:instance>
                    </xf:model>
                </xh:head>
                <xh:body>
                    <xf:output id="o11" value="@a"/>
                </xh:body>
            </xh:html>
        </input>
        <output name="analysis">
            <request request-uri="/orbeon/doc/home-welcome" query-string="id=12&amp;print=false" method="GET">
                <output scope="" prefixed-id="o11" model-prefixed-id="model" binding="false" value="true">
                    <value>
                        <analysis expression="xs:string((@a)[1])" analyzed="true">
                            <value-dependent>
                                <path>instance('instance')/@a</path>
                            </value-dependent>
                            <dependent-models>
                                <model>model</model>
                            </dependent-models>
                            <dependent-instances>
                                <instance>instance</instance>
                            </dependent-instances>
                        </analysis>
                    </value>
                </output>
                <model scope="" prefixed-id="model" default-instance-prefixed-id="instance" analyzed-binds="true"/>
            </request>
        </output>
    </test>

    <test description="Simple use of position() function" name="oxf:java">
        <input name="config">
            <config sourcepath="oxf:/" class="org.orbeon.oxf.xforms.analysis.XPathAnalysisProcessor"/>
        </input>
        <input name="form">
            <xh:html xmlns:xxf="http://orbeon.org/oxf/xml/xforms">
                <xh:head>
                    <xf:model id="model" xxf:xpath-analysis="true">
                        <xf:instance id="instance">
                            <instance/>
                        </xf:instance>
                    </xf:model>
                </xh:head>
                <xh:body>
                    <xf:output id="o11" value="position()"/>
                    <xf:output id="o12" value="a/position()"/>
                    <xf:output id="o13" value="a[position() = 1]"/>
                    <xf:output id="o14" value="a[position() = @p]"/>
                </xh:body>
            </xh:html>
        </input>
        <output name="analysis">
            <!-- NOTE: For now there is no information which would allow us to determine whether the position as changed -->
            <request request-uri="/orbeon/doc/home-welcome" query-string="id=12&amp;print=false" method="GET">
                <output scope="" prefixed-id="o11" model-prefixed-id="model" binding="false" value="true">
                    <value>
                        <analysis expression="xs:string((position())[1])" analyzed="true">
                            <dependent-models>
                                <model>model</model>
                            </dependent-models>
                            <dependent-instances>
                                <instance>instance</instance>
                            </dependent-instances>
                        </analysis>
                    </value>
                </output>
                <output scope="" prefixed-id="o12" model-prefixed-id="model" binding="false" value="true">
                    <value>
                        <analysis expression="xs:string((a/position())[1])" analyzed="true">
                            <dependent-models>
                                <model>model</model>
                            </dependent-models>
                            <dependent-instances>
                                <instance>instance</instance>
                            </dependent-instances>
                        </analysis>
                    </value>
                </output>
                <output scope="" prefixed-id="o13" model-prefixed-id="model" binding="false" value="true">
                    <value>
                        <analysis expression="xs:string((a[position() = 1])[1])" analyzed="true">
                            <value-dependent>
                                <path>instance('instance')/a</path>
                            </value-dependent>
                            <dependent-models>
                                <model>model</model>
                            </dependent-models>
                            <dependent-instances>
                                <instance>instance</instance>
                            </dependent-instances>
                        </analysis>
                    </value>
                </output>
                <output scope="" prefixed-id="o14" model-prefixed-id="model" binding="false" value="true">
                    <value>
                        <analysis expression="xs:string((a[position() = @p])[1])" analyzed="true">
                            <value-dependent>
                                <path>instance('instance')/a</path>
                                <path>instance('instance')/a/@p</path>
                            </value-dependent>
                            <dependent-models>
                                <model>model</model>
                            </dependent-models>
                            <dependent-instances>
                                <instance>instance</instance>
                            </dependent-instances>
                        </analysis>
                    </value>
                </output>
                <model scope="" prefixed-id="model" default-instance-prefixed-id="instance" analyzed-binds="true"/>
            </request>
        </output>
    </test>

    <test description="Bind referring to model variables" name="oxf:java">
        <input name="config">
            <config sourcepath="oxf:/" class="org.orbeon.oxf.xforms.analysis.XPathAnalysisProcessor"/>
        </input>
        <input name="form">
            <xh:html xmlns:xxf="http://orbeon.org/oxf/xml/xforms">
                <xh:head>
                    <xf:model id="model" xxf:xpath-analysis="true">
                        <xf:instance id="instance">
                            <instance/>
                        </xf:instance>
                        <xxf:variable id="v1" name="foo" select="instance()/a"/>
                        <xf:bind id="b1" ref="$foo"/>
                        <xf:bind id="b2" ref="." relevant="$foo = 42"/>
                    </xf:model>
                </xh:head>
                <xh:body/>
            </xh:html>
        </input>
        <output name="analysis">
            <request request-uri="/orbeon/doc/home-welcome" query-string="id=12&amp;print=false" method="GET">
                <model scope="" prefixed-id="model" default-instance-prefixed-id="instance" analyzed-binds="true">
                    <variable scope="" prefixed-id="v1" model-prefixed-id="model" binding="false" value="true" name="foo">
                        <value>
                            <analysis expression="instance()/a" analyzed="true">
                                <returnable>
                                    <path>instance('instance')/a</path>
                                </returnable>
                                <dependent-models>
                                    <model>model</model>
                                </dependent-models>
                                <dependent-instances>
                                    <instance>instance</instance>
                                </dependent-instances>
                                <returnable-instances>
                                    <instance>instance</instance>
                                </returnable-instances>
                            </analysis>
                        </value>
                    </variable>
                    <binds>
                        <bind id="b1" ref="$foo">
                            <binding>
                                <analysis expression="$foo" analyzed="true">
                                    <returnable>
                                        <path>instance('instance')/a</path>
                                    </returnable>
                                    <dependent-models>
                                        <model>model</model>
                                    </dependent-models>
                                    <dependent-instances>
                                        <instance>instance</instance>
                                    </dependent-instances>
                                    <returnable-instances>
                                        <instance>instance</instance>
                                    </returnable-instances>
                                </analysis>
                            </binding>
                        </bind>
                        <bind id="b2" ref=".">
                            <binding>
                                <analysis expression="." analyzed="true">
                                    <returnable>
                                        <path>instance('instance')</path>
                                    </returnable>
                                    <dependent-models>
                                        <model>model</model>
                                    </dependent-models>
                                    <dependent-instances>
                                        <instance>instance</instance>
                                    </dependent-instances>
                                    <returnable-instances>
                                        <instance>instance</instance>
                                    </returnable-instances>
                                </analysis>
                            </binding>
                            <mip name="relevant" expression="$foo = 42">
                                <analysis expression="xs:boolean(($foo = 42)[1])" analyzed="true">
                                    <value-dependent>
                                        <path>instance('instance')/a</path>
                                    </value-dependent>
                                    <dependent-models>
                                        <model>model</model>
                                    </dependent-models>
                                    <dependent-instances>
                                        <instance>instance</instance>
                                    </dependent-instances>
                                </analysis>
                            </mip>
                        </bind>
                    </binds>
                    <bind-instances>
                        <instance>instance</instance>
                    </bind-instances>
                    <computed-binds-instances>
                        <instance>instance</instance>
                    </computed-binds-instances>
                </model>
            </request>
        </output>
    </test>

    <test description="Control binding using @bind attribute" name="oxf:java">
        <input name="config">
            <config sourcepath="oxf:/" class="org.orbeon.oxf.xforms.analysis.XPathAnalysisProcessor"/>
        </input>
        <input name="form">
            <xh:html xmlns:xxf="http://orbeon.org/oxf/xml/xforms">
                <xh:head>
                    <xf:model id="model" xxf:xpath-analysis="true">
                        <xf:instance id="instance">
                            <instance/>
                        </xf:instance>
                        <xf:bind id="b1" ref="instance()">
                            <xf:bind id="b2" ref="a"/>
                        </xf:bind>
                    </xf:model>
                </xh:head>
                <xh:body>
                    <xf:output id="o1" bind="b1"/>
                    <xf:output id="o2" bind="b2"/>
                </xh:body>
            </xh:html>
        </input>
        <output name="analysis">
            <request request-uri="/orbeon/doc/home-welcome" query-string="id=12&amp;print=false" method="GET">
                <output scope="" prefixed-id="o1" model-prefixed-id="model" binding="true" value="true">
                    <binding>
                        <analysis expression="instance()" analyzed="true">
                            <returnable>
                                <path>instance('instance')</path>
                            </returnable>
                            <dependent-models>
                                <model>model</model>
                            </dependent-models>
                            <dependent-instances>
                                <instance>instance</instance>
                            </dependent-instances>
                            <returnable-instances>
                                <instance>instance</instance>
                            </returnable-instances>
                        </analysis>
                    </binding>
                    <value>
                        <analysis expression="xs:string(.[1])" analyzed="true">
                            <value-dependent>
                                <path>instance('instance')</path>
                            </value-dependent>
                            <dependent-models>
                                <model>model</model>
                            </dependent-models>
                            <dependent-instances>
                                <instance>instance</instance>
                            </dependent-instances>
                        </analysis>
                    </value>
                </output>
                <output scope="" prefixed-id="o2" model-prefixed-id="model" binding="true" value="true">
                    <binding>
                        <analysis expression="a" analyzed="true">
                            <returnable>
                                <path>instance('instance')/a</path>
                            </returnable>
                            <dependent-models>
                                <model>model</model>
                            </dependent-models>
                            <dependent-instances>
                                <instance>instance</instance>
                            </dependent-instances>
                            <returnable-instances>
                                <instance>instance</instance>
                            </returnable-instances>
                        </analysis>
                    </binding>
                    <value>
                        <analysis expression="xs:string(.[1])" analyzed="true">
                            <value-dependent>
                                <path>instance('instance')/a</path>
                            </value-dependent>
                            <dependent-models>
                                <model>model</model>
                            </dependent-models>
                            <dependent-instances>
                                <instance>instance</instance>
                            </dependent-instances>
                        </analysis>
                    </value>
                </output>
                <model scope="" prefixed-id="model" default-instance-prefixed-id="instance" analyzed-binds="true">
                    <binds>
                        <bind id="b1" ref="instance()">
                            <binding>
                                <analysis expression="instance()" analyzed="true">
                                    <returnable>
                                        <path>instance('instance')</path>
                                    </returnable>
                                    <dependent-models>
                                        <model>model</model>
                                    </dependent-models>
                                    <dependent-instances>
                                        <instance>instance</instance>
                                    </dependent-instances>
                                    <returnable-instances>
                                        <instance>instance</instance>
                                    </returnable-instances>
                                </analysis>
                            </binding>
                            <bind id="b2" ref="a">
                                <binding>
                                    <analysis expression="a" analyzed="true">
                                        <returnable>
                                            <path>instance('instance')/a</path>
                                        </returnable>
                                        <dependent-models>
                                            <model>model</model>
                                        </dependent-models>
                                        <dependent-instances>
                                            <instance>instance</instance>
                                        </dependent-instances>
                                        <returnable-instances>
                                            <instance>instance</instance>
                                        </returnable-instances>
                                    </analysis>
                                </binding>
                            </bind>
                        </bind>
                    </binds>
                    <bind-instances>
                        <instance>instance</instance>
                    </bind-instances>
                </model>
            </request>
        </output>
    </test>

    <test description="Basic LHHA analysis" name="oxf:java">
        <input name="config">
            <config sourcepath="oxf:/" class="org.orbeon.oxf.xforms.analysis.XPathAnalysisProcessor"/>
        </input>
        <input name="form">
            <xh:html xmlns:xxf="http://orbeon.org/oxf/xml/xforms" xmlns:fr="http://orbeon.org/oxf/xml/form-runner"
                     xmlns:xbl="http://www.w3.org/ns/xbl" xmlns:xxbl="http://orbeon.org/oxf/xml/xbl">
                <xh:head>
                    <xf:model xxf:xpath-analysis="true" id="m1">
                        <xf:instance id="i11">
                            <instance/>
                        </xf:instance>
                        <xf:instance id="i12">
                            <instance/>
                        </xf:instance>
                    </xf:model>
                    <xf:model id="m2">
                        <xf:instance id="i21">
                            <instance/>
                        </xf:instance>
                        <xf:instance id="i22">
                            <instance/>
                        </xf:instance>
                    </xf:model>
                </xh:head>
                <xh:body>
                    <xf:input id="i1" ref="instance()">
                        <xf:label ref="@label"/>
                        <xf:help ref="@help"/>
                        <xf:hint ref="@hint"/>
                        <xf:alert ref="@alert"/>
                    </xf:input>
                    <!-- Other attributes -->
                    <xf:input id="i2" ref="instance()">
                        <!-- Use of @context -->
                        <xf:label context="instance('i12')" ref="@label"/>
                        <!-- Use of @model -->
                        <xf:help model="m2" context="instance('i22')" ref="@label"/>
                        <!-- Combined use of attributes -->
                        <xf:hint model="m2" context="instance('i22')" ref="resource" value="@label"/>
                        <!-- Use of xxf:context() -->
                        <xf:alert value="xxf:context('i2')/@label2"/>
                    </xf:input>
                </xh:body>
            </xh:html>
        </input>
        <output name="analysis">
            <request request-uri="/orbeon/doc/home-welcome" query-string="id=12&amp;print=false" method="GET">
                <input scope="" prefixed-id="i1" model-prefixed-id="m1" binding="true" value="true">
                    <binding>
                        <analysis expression="instance()" analyzed="true">
                            <returnable>
                                <path>instance('i11')</path>
                            </returnable>
                            <dependent-models>
                                <model>m1</model>
                            </dependent-models>
                            <dependent-instances>
                                <instance>i11</instance>
                            </dependent-instances>
                            <returnable-instances>
                                <instance>i11</instance>
                            </returnable-instances>
                        </analysis>
                    </binding>
                    <value>
                        <analysis expression="xs:string(.[1])" analyzed="true">
                            <value-dependent>
                                <path>instance('i11')</path>
                            </value-dependent>
                            <dependent-models>
                                <model>m1</model>
                            </dependent-models>
                            <dependent-instances>
                                <instance>i11</instance>
                            </dependent-instances>
                        </analysis>
                    </value>
                    <label>
                        <analysis expression="xs:string(.[1])" analyzed="true">
                            <value-dependent>
                                <path>instance('i11')/@label</path>
                            </value-dependent>
                            <dependent-models>
                                <model>m1</model>
                            </dependent-models>
                            <dependent-instances>
                                <instance>i11</instance>
                            </dependent-instances>
                        </analysis>
                    </label>
                    <help>
                        <analysis expression="xs:string(.[1])" analyzed="true">
                            <value-dependent>
                                <path>instance('i11')/@help</path>
                            </value-dependent>
                            <dependent-models>
                                <model>m1</model>
                            </dependent-models>
                            <dependent-instances>
                                <instance>i11</instance>
                            </dependent-instances>
                        </analysis>
                    </help>
                    <hint>
                        <analysis expression="xs:string(.[1])" analyzed="true">
                            <value-dependent>
                                <path>instance('i11')/@hint</path>
                            </value-dependent>
                            <dependent-models>
                                <model>m1</model>
                            </dependent-models>
                            <dependent-instances>
                                <instance>i11</instance>
                            </dependent-instances>
                        </analysis>
                    </hint>
                    <alert>
                        <analysis expression="xs:string(.[1])" analyzed="true">
                            <value-dependent>
                                <path>instance('i11')/@alert</path>
                            </value-dependent>
                            <dependent-models>
                                <model>m1</model>
                            </dependent-models>
                            <dependent-instances>
                                <instance>i11</instance>
                            </dependent-instances>
                        </analysis>
                    </alert>
                </input>
                <input scope="" prefixed-id="i2" model-prefixed-id="m1" binding="true" value="true">
                    <binding>
                        <analysis expression="instance()" analyzed="true">
                            <returnable>
                                <path>instance('i11')</path>
                            </returnable>
                            <dependent-models>
                                <model>m1</model>
                            </dependent-models>
                            <dependent-instances>
                                <instance>i11</instance>
                            </dependent-instances>
                            <returnable-instances>
                                <instance>i11</instance>
                            </returnable-instances>
                        </analysis>
                    </binding>
                    <value>
                        <analysis expression="xs:string(.[1])" analyzed="true">
                            <value-dependent>
                                <path>instance('i11')</path>
                            </value-dependent>
                            <dependent-models>
                                <model>m1</model>
                            </dependent-models>
                            <dependent-instances>
                                <instance>i11</instance>
                            </dependent-instances>
                        </analysis>
                    </value>
                    <label>
                        <analysis expression="xs:string(.[1])" analyzed="true">
                            <value-dependent>
                                <path>instance('i12')/@label</path>
                            </value-dependent>
                            <dependent-models>
                                <model>m1</model>
                            </dependent-models>
                            <dependent-instances>
                                <instance>i12</instance>
                            </dependent-instances>
                        </analysis>
                    </label>
                    <help>
                        <analysis expression="xs:string(.[1])" analyzed="true">
                            <value-dependent>
                                <path>instance('i22')/@label</path>
                            </value-dependent>
                            <dependent-models>
                                <model>m2</model>
                            </dependent-models>
                            <dependent-instances>
                                <instance>i22</instance>
                            </dependent-instances>
                        </analysis>
                    </help>
                    <hint>
                        <analysis expression="xs:string((@label)[1])" analyzed="true">
                            <value-dependent>
                                <path>instance('i22')/resource/@label</path>
                            </value-dependent>
                            <dependent-models>
                                <model>m2</model>
                            </dependent-models>
                            <dependent-instances>
                                <instance>i22</instance>
                            </dependent-instances>
                        </analysis>
                    </hint>
                    <alert>
                        <analysis expression="xs:string((xxf:context('i2')/@label2)[1])" analyzed="true">
                            <value-dependent>
                                <path>instance('i11')/@label2</path>
                            </value-dependent>
                            <dependent-models>
                                <model>m1</model>
                            </dependent-models>
                            <dependent-instances>
                                <instance>i11</instance>
                            </dependent-instances>
                        </analysis>
                    </alert>
                </input>
                <model scope="" prefixed-id="m1" default-instance-prefixed-id="i11" analyzed-binds="true"/>
                <model scope="" prefixed-id="m2" default-instance-prefixed-id="i21" analyzed-binds="true"/>
            </request>
        </output>
    </test>

    <test description="LHHA analysis with nested outputs" name="oxf:java">
        <input name="config">
            <config sourcepath="oxf:/" class="org.orbeon.oxf.xforms.analysis.XPathAnalysisProcessor"/>
        </input>
        <input name="form">
            <xh:html xmlns:xxf="http://orbeon.org/oxf/xml/xforms" xmlns:fr="http://orbeon.org/oxf/xml/form-runner"
                     xmlns:xbl="http://www.w3.org/ns/xbl" xmlns:xxbl="http://orbeon.org/oxf/xml/xbl">
                <xh:head>
                    <xf:model xxf:xpath-analysis="true" id="m1">
                        <xf:instance id="i11">
                            <instance/>
                        </xf:instance>
                        <xf:instance id="i12">
                            <instance/>
                        </xf:instance>
                    </xf:model>
                    <xf:model id="m2">
                        <xf:instance id="i21">
                            <instance/>
                        </xf:instance>
                        <xf:instance id="i22">
                            <instance/>
                        </xf:instance>
                    </xf:model>
                </xh:head>
                <xh:body>
                    <xf:input id="i5" ref="instance()">
                        <!-- Simple xf:output -->
                        <xf:label>
                            <xh:span><xf:output ref="@label"/></xh:span>
                        </xf:label>
                        <!-- 2 simple xf:output -->
                        <xf:help>
                            <xh:span><xf:output ref="@help1"/> - <xf:output model="m2" ref="@help2"/></xh:span>
                        </xf:help>
                        <!-- Output we can't analyze -->
                        <xf:hint>
                            <xh:span><xf:output ref="@help1"/> - <xf:output value="index('my-repeat')"/></xh:span>
                        </xf:hint>
                    </xf:input>
                </xh:body>
            </xh:html>
        </input>
        <output name="analysis">
            <request request-uri="/orbeon/doc/home-welcome" query-string="id=12&amp;print=false" method="GET">
                <input scope="" prefixed-id="i5" model-prefixed-id="m1" binding="true" value="true">
                    <binding>
                        <analysis expression="instance()" analyzed="true">
                            <returnable>
                                <path>instance('i11')</path>
                            </returnable>
                            <dependent-models>
                                <model>m1</model>
                            </dependent-models>
                            <dependent-instances>
                                <instance>i11</instance>
                            </dependent-instances>
                            <returnable-instances>
                                <instance>i11</instance>
                            </returnable-instances>
                        </analysis>
                    </binding>
                    <value>
                        <analysis expression="xs:string(.[1])" analyzed="true">
                            <value-dependent>
                                <path>instance('i11')</path>
                            </value-dependent>
                            <dependent-models>
                                <model>m1</model>
                            </dependent-models>
                            <dependent-instances>
                                <instance>i11</instance>
                            </dependent-instances>
                        </analysis>
                    </value>
                    <label>
                        <analysis expression="xs:string(.[1])" analyzed="true">
                            <value-dependent>
                                <path>instance('i11')/@label</path>
                            </value-dependent>
                            <dependent-models>
                                <model>m1</model>
                            </dependent-models>
                            <dependent-instances>
                                <instance>i11</instance>
                            </dependent-instances>
                        </analysis>
                    </label>
                    <help>
                        <analysis expression="(xs:string(.[1])) | (xs:string(.[1]))" analyzed="true">
                            <value-dependent>
                                <path>instance('i11')/@help1</path>
                                <path>instance('i21')/@help2</path>
                            </value-dependent>
                            <dependent-models>
                                <model>m1</model>
                                <model>m2</model>
                            </dependent-models>
                            <dependent-instances>
                                <instance>i11</instance>
                                <instance>i21</instance>
                            </dependent-instances>
                        </analysis>
                    </help>
                    <hint>
                        <analysis expression="(xs:string(.[1])) | (xs:string((index('my-repeat'))[1]))" analyzed="false"/>
                    </hint>
                </input>
                <model scope="" prefixed-id="m1" default-instance-prefixed-id="i11" analyzed-binds="true"/>
                <model scope="" prefixed-id="m2" default-instance-prefixed-id="i21" analyzed-binds="true"/>
            </request>
        </output>
    </test>

    <test description="Constant variable" name="oxf:java">
        <input name="config">
            <config sourcepath="oxf:/" class="org.orbeon.oxf.xforms.analysis.XPathAnalysisProcessor"/>
        </input>
        <input name="form">
            <xh:html xmlns:xxf="http://orbeon.org/oxf/xml/xforms" xmlns:fr="http://orbeon.org/oxf/xml/form-runner"
                     xmlns:xbl="http://www.w3.org/ns/xbl" xmlns:xxbl="http://orbeon.org/oxf/xml/xbl">
                <xh:head>
                    <xf:model xxf:xpath-analysis="true" id="model">
                        <xf:instance id="instance">
                            <instance/>
                        </xf:instance>
                        <xxf:variable name="foo">Foo</xxf:variable>
                    </xf:model>
                </xh:head>
                <xh:body>
                    <xxf:variable name="bar">Bar</xxf:variable>
                    <xf:input id="i1" ref="$foo"/>
                    <xf:output id="o1" value="concat(gaga, $bar)"/>
                </xh:body>
            </xh:html>
        </input>
        <output name="analysis">
            <request request-uri="/orbeon/doc/home-welcome" query-string="id=12&amp;print=false" method="GET">
                <variable scope="" prefixed-id="xf-2" model-prefixed-id="model" binding="false" value="true" name="bar">
                    <value>
                        <analysis expression="'CONSTANT'" analyzed="true"/>
                    </value>
                </variable>
                <input scope="" prefixed-id="i1" model-prefixed-id="model" binding="true" value="true">
                    <binding>
                        <analysis expression="$foo" analyzed="true"/>
                    </binding>
                    <value>
                        <analysis expression="xs:string(.[1])" analyzed="true"/>
                    </value>
                </input>
                <output scope="" prefixed-id="o1" model-prefixed-id="model" binding="false" value="true">
                    <value>
                        <analysis expression="xs:string((concat(gaga, $bar))[1])" analyzed="true">
                            <value-dependent>
                                <path>instance('instance')/gaga</path>
                            </value-dependent>
                            <dependent-models>
                                <model>model</model>
                            </dependent-models>
                            <dependent-instances>
                                <instance>instance</instance>
                            </dependent-instances>
                        </analysis>
                    </value>
                </output>
                <model scope="" prefixed-id="model" default-instance-prefixed-id="instance" analyzed-binds="true">
                    <variable scope="" prefixed-id="xf-1" model-prefixed-id="model" binding="false" value="true" name="foo">
                        <value>
                            <analysis expression="'CONSTANT'" analyzed="true"/>
                        </value>
                    </variable>
                </model>
            </request>
        </output>
    </test>

    <test description="LHHA referring to model variable" name="oxf:java">
        <input name="config">
            <config sourcepath="oxf:/" class="org.orbeon.oxf.xforms.analysis.XPathAnalysisProcessor"/>
        </input>
        <input name="form">
            <xh:html xmlns:xxf="http://orbeon.org/oxf/xml/xforms" xmlns:fr="http://orbeon.org/oxf/xml/form-runner"
                     xmlns:xbl="http://www.w3.org/ns/xbl" xmlns:xxbl="http://orbeon.org/oxf/xml/xbl">
                <xh:head>
                    <xf:model xxf:xpath-analysis="true" id="m1">
                        <xf:instance id="i11">
                            <instance label=""/>
                        </xf:instance>
                        <xxf:variable name="label" select="instance()/@label"/>
                    </xf:model>
                </xh:head>
                <xh:body>
                    <xf:group id="g1">
                        <xf:label id="l1" ref="$label"/>
                    </xf:group>
                </xh:body>
            </xh:html>
        </input>
        <output name="analysis">
            <request request-uri="/orbeon/doc/home-welcome" query-string="id=12&amp;print=false" method="GET">
                <group scope="" prefixed-id="g1" model-prefixed-id="m1" binding="false" value="false">
                    <label>
                        <analysis expression="xs:string(.[1])" analyzed="true">
                            <value-dependent>
                                <path>instance('i11')/@label</path>
                            </value-dependent>
                            <dependent-models>
                                <model>m1</model>
                            </dependent-models>
                            <dependent-instances>
                                <instance>i11</instance>
                            </dependent-instances>
                        </analysis>
                    </label>
                </group>
                <model scope="" prefixed-id="m1" default-instance-prefixed-id="i11" analyzed-binds="true">
                    <variable scope="" prefixed-id="xf-1" model-prefixed-id="m1" binding="false" value="true" name="label">
                        <value>
                            <analysis expression="instance()/@label" analyzed="true">
                                <returnable>
                                    <path>instance('i11')/@label</path>
                                </returnable>
                                <dependent-models>
                                    <model>m1</model>
                                </dependent-models>
                                <dependent-instances>
                                    <instance>i11</instance>
                                </dependent-instances>
                                <returnable-instances>
                                    <instance>i11</instance>
                                </returnable-instances>
                            </analysis>
                        </value>
                    </variable>
                </model>
            </request>
        </output>
    </test>

    <test description="External LHHA preceding control and using variable" name="oxf:java">
        <input name="config">
            <config sourcepath="oxf:/" class="org.orbeon.oxf.xforms.analysis.XPathAnalysisProcessor"/>
        </input>
        <input name="form">
            <xh:html xmlns:xxf="http://orbeon.org/oxf/xml/xforms" xmlns:fr="http://orbeon.org/oxf/xml/form-runner"
                     xmlns:xbl="http://www.w3.org/ns/xbl" xmlns:xxbl="http://orbeon.org/oxf/xml/xbl">
                <xh:head>
                    <xf:model xxf:xpath-analysis="true" id="model">
                        <xf:instance id="instance">
                            <instance label="" bar=""/>
                        </xf:instance>
                    </xf:model>
                </xh:head>
                <xh:body>
                    <xxf:variable id="bar-variable" name="bar" select="@bar"/>
                    <xf:label id="my-label" for="my-input" value="$bar"/>
                    <xf:input id="my-input" ref="instance()"/>
                </xh:body>
            </xh:html>
        </input>
        <output name="analysis">
            <request request-uri="/orbeon/doc/home-welcome" query-string="id=12&amp;print=false" method="GET">
                <variable scope="" prefixed-id="bar-variable" model-prefixed-id="model" binding="false" value="true" name="bar">
                    <value>
                        <analysis expression="@bar" analyzed="true">
                            <returnable>
                                <path>instance('instance')/@bar</path>
                            </returnable>
                            <dependent-models>
                                <model>model</model>
                            </dependent-models>
                            <dependent-instances>
                                <instance>instance</instance>
                            </dependent-instances>
                            <returnable-instances>
                                <instance>instance</instance>
                            </returnable-instances>
                        </analysis>
                    </value>
                </variable>
                <input scope="" prefixed-id="my-input" model-prefixed-id="model" binding="true" value="true">
                    <binding>
                        <analysis expression="instance()" analyzed="true">
                            <returnable>
                                <path>instance('instance')</path>
                            </returnable>
                            <dependent-models>
                                <model>model</model>
                            </dependent-models>
                            <dependent-instances>
                                <instance>instance</instance>
                            </dependent-instances>
                            <returnable-instances>
                                <instance>instance</instance>
                            </returnable-instances>
                        </analysis>
                    </binding>
                    <value>
                        <analysis expression="xs:string(.[1])" analyzed="true">
                            <value-dependent>
                                <path>instance('instance')</path>
                            </value-dependent>
                            <dependent-models>
                                <model>model</model>
                            </dependent-models>
                            <dependent-instances>
                                <instance>instance</instance>
                            </dependent-instances>
                        </analysis>
                    </value>
                    <label>
                        <analysis expression="xs:string(($bar)[1])" analyzed="true">
                            <value-dependent>
                                <path>instance('instance')/@bar</path>
                            </value-dependent>
                            <dependent-models>
                                <model>model</model>
                            </dependent-models>
                            <dependent-instances>
                                <instance>instance</instance>
                            </dependent-instances>
                        </analysis>
                    </label>
                </input>
                <model scope="" prefixed-id="model" default-instance-prefixed-id="instance" analyzed-binds="true"/>
            </request>
        </output>
    </test>

    <test description="External LHHA positioning and evaluation context" name="oxf:java">
        <input name="config">
            <config sourcepath="oxf:/" class="org.orbeon.oxf.xforms.analysis.XPathAnalysisProcessor"/>
        </input>
        <input name="form">
            <xh:html xmlns:xxf="http://orbeon.org/oxf/xml/xforms" xmlns:fr="http://orbeon.org/oxf/xml/form-runner"
                     xmlns:xbl="http://www.w3.org/ns/xbl" xmlns:xxbl="http://orbeon.org/oxf/xml/xbl">
                <xh:head>
                    <xf:model xxf:xpath-analysis="true" id="model">
                        <xf:instance id="instance">
                            <instance label1="" label2="" help2="" help3="">
                                <value1/>
                                <nested group-label="" label3="" help1="">
                                    <value2/>
                                </nested>
                                <value3/>
                            </instance>
                        </xf:instance>
                    </xf:model>
                </xh:head>
                <xh:body>
                    <!-- Labels are forward-looking, helps are backward-looking  -->
                    <xf:label id="label1" for="input1" value="@label1"/>
                    <xf:input id="input1" ref="value1"/>
                    <xf:label id="label2" for="input2" value="@label2"/>
                    <xf:group id="group1" context="nested">
                        <xf:label id="group-label1" value="@group-label"/>
                        <xf:input id="input2" ref="value2"/>
                        <xf:label id="label3" for="input3" value="@label3"/>
                        <xf:help id="help1" for="input1" value="@help1"/>
                    </xf:group>
                    <xf:help id="help2" for="input2" value="@help2"/>
                    <xf:input id="input3" ref="value3"/>
                    <xf:help id="help3" for="input3" value="@help3"/>
                </xh:body>
            </xh:html>
        </input>
        <output name="analysis">
            <request request-uri="/orbeon/doc/home-welcome" query-string="id=12&amp;print=false" method="GET">
                <input scope="" prefixed-id="input1" model-prefixed-id="model" binding="true" value="true">
                    <binding>
                        <analysis expression="value1" analyzed="true">
                            <returnable>
                                <path>instance('instance')/value1</path>
                            </returnable>
                            <dependent-models>
                                <model>model</model>
                            </dependent-models>
                            <dependent-instances>
                                <instance>instance</instance>
                            </dependent-instances>
                            <returnable-instances>
                                <instance>instance</instance>
                            </returnable-instances>
                        </analysis>
                    </binding>
                    <value>
                        <analysis expression="xs:string(.[1])" analyzed="true">
                            <value-dependent>
                                <path>instance('instance')/value1</path>
                            </value-dependent>
                            <dependent-models>
                                <model>model</model>
                            </dependent-models>
                            <dependent-instances>
                                <instance>instance</instance>
                            </dependent-instances>
                        </analysis>
                    </value>
                    <label>
                        <analysis expression="xs:string((@label1)[1])" analyzed="true">
                            <value-dependent>
                                <path>instance('instance')/@label1</path>
                            </value-dependent>
                            <dependent-models>
                                <model>model</model>
                            </dependent-models>
                            <dependent-instances>
                                <instance>instance</instance>
                            </dependent-instances>
                        </analysis>
                    </label>
                        <help>
                            <analysis expression="xs:string((@help1)[1])" analyzed="true">
                                <value-dependent>
                                    <path>instance('instance')/nested/@help1</path>
                                </value-dependent>
                                <dependent-models>
                                    <model>model</model>
                                </dependent-models>
                                <dependent-instances>
                                    <instance>instance</instance>
                                </dependent-instances>
                            </analysis>
                        </help>
                </input>
                <group scope="" prefixed-id="group1" model-prefixed-id="model" binding="false" value="false">
                    <label>
                        <analysis expression="xs:string((@group-label)[1])" analyzed="true">
                            <value-dependent>
                                <path>instance('instance')/nested/@group-label</path>
                            </value-dependent>
                            <dependent-models>
                                <model>model</model>
                            </dependent-models>
                            <dependent-instances>
                                <instance>instance</instance>
                            </dependent-instances>
                        </analysis>
                    </label>
                </group>
                <input scope="" prefixed-id="input2" model-prefixed-id="model" binding="true" value="true">
                    <binding>
                        <analysis expression="value2" analyzed="true">
                            <returnable>
                                <path>instance('instance')/nested/value2</path>
                            </returnable>
                            <dependent-models>
                                <model>model</model>
                            </dependent-models>
                            <dependent-instances>
                                <instance>instance</instance>
                            </dependent-instances>
                            <returnable-instances>
                                <instance>instance</instance>
                            </returnable-instances>
                        </analysis>
                    </binding>
                    <value>
                        <analysis expression="xs:string(.[1])" analyzed="true">
                            <value-dependent>
                                <path>instance('instance')/nested/value2</path>
                            </value-dependent>
                            <dependent-models>
                                <model>model</model>
                            </dependent-models>
                            <dependent-instances>
                                <instance>instance</instance>
                            </dependent-instances>
                        </analysis>
                    </value>
                    <label>
                        <analysis expression="xs:string((@label2)[1])" analyzed="true">
                            <value-dependent>
                                <path>instance('instance')/@label2</path>
                            </value-dependent>
                            <dependent-models>
                                <model>model</model>
                            </dependent-models>
                            <dependent-instances>
                                <instance>instance</instance>
                            </dependent-instances>
                        </analysis>
                    </label>
                        <help>
                            <analysis expression="xs:string((@help2)[1])" analyzed="true">
                                <value-dependent>
                                    <path>instance('instance')/@help2</path>
                                </value-dependent>
                                <dependent-models>
                                    <model>model</model>
                                </dependent-models>
                                <dependent-instances>
                                    <instance>instance</instance>
                                </dependent-instances>
                            </analysis>
                        </help>
                </input>
                <input scope="" prefixed-id="input3" model-prefixed-id="model" binding="true" value="true">
                    <binding>
                        <analysis expression="value3" analyzed="true">
                            <returnable>
                                <path>instance('instance')/value3</path>
                            </returnable>
                            <dependent-models>
                                <model>model</model>
                            </dependent-models>
                            <dependent-instances>
                                <instance>instance</instance>
                            </dependent-instances>
                            <returnable-instances>
                                <instance>instance</instance>
                            </returnable-instances>
                        </analysis>
                    </binding>
                    <value>
                        <analysis expression="xs:string(.[1])" analyzed="true">
                            <value-dependent>
                                <path>instance('instance')/value3</path>
                            </value-dependent>
                            <dependent-models>
                                <model>model</model>
                            </dependent-models>
                            <dependent-instances>
                                <instance>instance</instance>
                            </dependent-instances>
                        </analysis>
                    </value>
                    <label>
                        <analysis expression="xs:string((@label3)[1])" analyzed="true">
                            <value-dependent>
                                <path>instance('instance')/nested/@label3</path>
                            </value-dependent>
                            <dependent-models>
                                <model>model</model>
                            </dependent-models>
                            <dependent-instances>
                                <instance>instance</instance>
                            </dependent-instances>
                        </analysis>
                    </label>
                        <help>
                            <analysis expression="xs:string((@help3)[1])" analyzed="true">
                                <value-dependent>
                                    <path>instance('instance')/@help3</path>
                                </value-dependent>
                                <dependent-models>
                                    <model>model</model>
                                </dependent-models>
                                <dependent-instances>
                                    <instance>instance</instance>
                                </dependent-instances>
                            </analysis>
                        </help>
                </input>
                <model scope="" prefixed-id="model" default-instance-prefixed-id="instance" analyzed-binds="true"/>
            </request>
        </output>
    </test>

    <test description="Handling of required upon initialization" name="oxf:pipeline">
        <!-- See: http://forge.ow2.org/tracker/index.php?func=detail&aid=315598&group_id=168&atid=350207 -->
        <input name="config" href="wrap-xforms-controls.xpl"/>
        <input name="document">
            <xh:html xmlns:xf="http://www.w3.org/2002/xforms"
                     xmlns:xh="http://www.w3.org/1999/xhtml"
                     xmlns:xxf="http://orbeon.org/oxf/xml/xforms">
                <xh:head>
                    <xf:model xxf:xhtml-layout="span" xxf:xpath-analysis="true">
                        <xf:instance>
                            <first-name/>
                        </xf:instance>
                        <xf:bind nodeset="instance()" required="true()"/>
                    </xf:model>
                </xh:head>
                <xh:body>
                    <xf:input id="my-input" ref="instance()">
                        <xf:alert>First name is mandatory</xf:alert>
                    </xf:input>
                </xh:body>
            </xh:html>
        </input>
        <output name="response">
            <controls xmlns:xhtml="http://www.w3.org/1999/xhtml">
                <xh:span xmlns:xh="http://www.w3.org/1999/xhtml" id="my-input" class="xforms-control xforms-input xforms-invalid xforms-required xforms-required-empty">
                    <xh:input id="my-input$xforms-input-1" type="text" name="my-input$xforms-input-1" value="" class="xforms-input-input"/>
                    <xh:span class="xforms-alert-active xforms-alert">First name is mandatory</xh:span>
                </xh:span>
            </controls>
        </output>
    </test>

    <test description="Simple itemset" name="oxf:java">
        <input name="config">
            <config sourcepath="oxf:/" class="org.orbeon.oxf.xforms.analysis.XPathAnalysisProcessor"/>
        </input>
        <input name="form">
            <xh:html xmlns:xxf="http://orbeon.org/oxf/xml/xforms">
                <xh:head>
                    <xf:model xxf:xpath-analysis="true" id="model">
                        <xf:instance id="instance">
                            <instance/>
                        </xf:instance>
                    </xf:model>
                </xh:head>
                <xh:body>
                    <xf:select id="my-select" ref="value">
                        <xf:itemset ref="../item">
                            <xf:label ref="label"/>
                            <xf:value ref="value"/>
                        </xf:itemset>
                    </xf:select>
                </xh:body>
            </xh:html>
        </input>
        <output name="analysis">
            <request request-uri="/orbeon/doc/home-welcome" query-string="id=12&amp;print=false" method="GET">
                <select scope="" prefixed-id="my-select" model-prefixed-id="model" binding="true" value="true">
                    <binding>
                        <analysis expression="value" analyzed="true">
                            <returnable>
                                <path>instance('instance')/value</path>
                            </returnable>
                            <dependent-models>
                                <model>model</model>
                            </dependent-models>
                            <dependent-instances>
                                <instance>instance</instance>
                            </dependent-instances>
                            <returnable-instances>
                                <instance>instance</instance>
                            </returnable-instances>
                        </analysis>
                    </binding>
                    <value>
                        <analysis expression="xs:string(.[1])" analyzed="true">
                            <value-dependent>
                                <path>instance('instance')/value</path>
                            </value-dependent>
                            <dependent-models>
                                <model>model</model>
                            </dependent-models>
                            <dependent-instances>
                                <instance>instance</instance>
                            </dependent-instances>
                        </analysis>
                    </value>
                    <itemset>
                        <analysis expression="(xs:string(.[1])) | (xs:string(.[1]))" analyzed="true">
                            <value-dependent>
                                <path>instance('instance')/item/label</path>
                                <path>instance('instance')/item/value</path>
                            </value-dependent>
                            <dependent-models>
                                <model>model</model>
                            </dependent-models>
                            <dependent-instances>
                                <instance>instance</instance>
                            </dependent-instances>
                        </analysis>
                    </itemset>
                </select>
                <model scope="" prefixed-id="model" default-instance-prefixed-id="instance" analyzed-binds="true"/>
            </request>
        </output>
    </test>

    <test description="Complex itemset" name="oxf:java">
        <input name="config">
            <config sourcepath="oxf:/" class="org.orbeon.oxf.xforms.analysis.XPathAnalysisProcessor"/>
        </input>
        <input name="form">
            <xh:html xmlns:xxf="http://orbeon.org/oxf/xml/xforms">
                <xh:head>
                    <xf:model xxf:xpath-analysis="true" id="model1">
                        <xf:instance id="instance1">
                            <instance/>
                        </xf:instance>
                    </xf:model>
                    <xf:model xxf:xpath-analysis="true" id="model2">
                        <xf:instance id="instance2">
                            <instance/>
                        </xf:instance>
                    </xf:model>
                </xh:head>
                <xh:body>
                    <xf:select id="my-select" ref="value">
                        <xf:item context="../item">
                            <xf:label ref="label"/>
                            <xf:value value="value"/>
                        </xf:item>
                        <xf:itemset context="../itemset" ref="item">
                            <xf:label ref="label"/>
                            <xf:value ref="value"/>
                        </xf:itemset>
                        <xf:choices context="../choices">
                            <xf:label ref="label"/>
                            <xf:item context="item">
                                <xf:label ref="label"/>
                                <xf:value value="value"/>
                            </xf:item>
                            <xf:itemset ref="itemset">
                                <xf:label ref="label"/>
                                <xf:value ref="value"/>
                            </xf:itemset>
                            <xf:choices model="model2" context="items">
                                <xf:item>
                                    <xf:label ref="item1/label"/>
                                    <xf:value value="item1/value"/>
                                </xf:item>
                                <xf:item context="item2">
                                    <xf:label ref="label"/>
                                    <xf:value value="value"/>
                                </xf:item>
                            </xf:choices>
                        </xf:choices>
                    </xf:select>
                </xh:body>
            </xh:html>
        </input>
        <output name="analysis">
            <request request-uri="/orbeon/doc/home-welcome" query-string="id=12&amp;print=false" method="GET">
                <select scope="" prefixed-id="my-select" model-prefixed-id="model1" binding="true" value="true">
                    <binding>
                        <analysis expression="value" analyzed="true">
                            <returnable>
                                <path>instance('instance1')/value</path>
                            </returnable>
                            <dependent-models>
                                <model>model1</model>
                            </dependent-models>
                            <dependent-instances>
                                <instance>instance1</instance>
                            </dependent-instances>
                            <returnable-instances>
                                <instance>instance1</instance>
                            </returnable-instances>
                        </analysis>
                    </binding>
                    <value>
                        <analysis expression="xs:string(.[1])" analyzed="true">
                            <value-dependent>
                                <path>instance('instance1')/value</path>
                            </value-dependent>
                            <dependent-models>
                                <model>model1</model>
                            </dependent-models>
                            <dependent-instances>
                                <instance>instance1</instance>
                            </dependent-instances>
                        </analysis>
                    </value>
                    <itemset>
                        <analysis expression="((((((((((((xs:string(.[1])) | (xs:string((value)[1]))) | (xs:string(.[1]))) | (xs:string(.[1]))) | (xs:string(.[1]))) | (xs:string(.[1]))) | (xs:string((value)[1]))) | (xs:string(.[1]))) | (xs:string(.[1]))) | (xs:string(.[1]))) | (xs:string((item1/value)[1]))) | (xs:string(.[1]))) | (xs:string((value)[1]))" analyzed="true">
                            <value-dependent>
                                <path>instance('instance1')/item/label</path>
                                <path>instance('instance1')/item/value</path>
                                <path>instance('instance1')/itemset/item/label</path>
                                <path>instance('instance1')/itemset/item/value</path>
                                <path>instance('instance1')/choices/label</path>
                                <path>instance('instance1')/choices/item/label</path>
                                <path>instance('instance1')/choices/item/value</path>
                                <path>instance('instance1')/choices/itemset/label</path>
                                <path>instance('instance1')/choices/itemset/value</path>
                                <path>instance('instance2')/items/item1/label</path>
                                <path>instance('instance2')/items/item1/value</path>
                                <path>instance('instance2')/items/item2/label</path>
                                <path>instance('instance2')/items/item2/value</path>
                            </value-dependent>
                            <dependent-models>
                                <model>model1</model>
                                <model>model2</model>
                            </dependent-models>
                            <dependent-instances>
                                <instance>instance1</instance>
                                <instance>instance2</instance>
                            </dependent-instances>
                        </analysis>
                    </itemset>
                </select>
                <model scope="" prefixed-id="model1" default-instance-prefixed-id="instance1" analyzed-binds="true"/>
                <model scope="" prefixed-id="model2" default-instance-prefixed-id="instance2" analyzed-binds="true"/>
            </request>
        </output>
    </test>

    <test description="Variable scope within XBL" name="oxf:java">
        <input name="config">
            <config sourcepath="oxf:/" class="org.orbeon.oxf.xforms.analysis.XPathAnalysisProcessor"/>
        </input>
        <input name="form">
            <xh:html xmlns:xxf="http://orbeon.org/oxf/xml/xforms" xmlns:fr="http://orbeon.org/oxf/xml/form-runner"
                     xmlns:xbl="http://www.w3.org/ns/xbl" xmlns:xxbl="http://orbeon.org/oxf/xml/xbl">
                <xh:head>
                    <xf:model xxf:xpath-analysis="true" id="model">
                        <xf:instance id="instance">
                            <instance/>
                        </xf:instance>
                    </xf:model>
                    <xbl:xbl>
                        <xbl:binding id="fr-foo" element="fr|foo">
                            <xbl:implementation>
                                <xf:model id="foo-model">
                                    <xf:instance id="foo-instance">
                                        <instance/>
                                    </xf:instance>
                                </xf:model>
                            </xbl:implementation>
                            <xbl:template>
                                <xf:group id="foo-group" xxbl:scope="outer">
                                    <!-- Pointing to the outer scope -->
                                    <xxf:variable id="v1" name="v1" select="."/>

                                    <xxf:variable id="v2" name="v2" xxbl:scope="inner">
                                        <xxf:sequence select="$v1" xxbl:scope="outer"/>
                                    </xxf:variable>
                                    <xf:output id="output1" value="$v2" xxbl:scope="inner"/>

                                    <!-- Pointing to the inner scope -->
                                    <xxf:variable id="v3" name="v3" select="." xxbl:scope="inner"/>

                                    <xxf:variable id="v4" name="v4">
                                        <xxf:sequence select="$v3" xxbl:scope="inner"/>
                                    </xxf:variable>
                                    <xf:output id="output2" value="$v4"/>
                                </xf:group>
                            </xbl:template>
                        </xbl:binding>
                    </xbl:xbl>
                </xh:head>
                <xh:body>
                    <fr:foo id="my-foo"/>
                </xh:body>
            </xh:html>
        </input>
        <output name="analysis">
            <request request-uri="/orbeon/doc/home-welcome" query-string="id=12&amp;print=false" method="GET">
                <foo scope="" prefixed-id="my-foo" model-prefixed-id="model" binding="false" value="false"/>
                <group scope="" prefixed-id="my-foo$foo-group" model-prefixed-id="model" binding="false" value="false"/>
                <variable scope="" prefixed-id="my-foo$v1" model-prefixed-id="model" binding="false" value="true" name="v1">
                    <value>
                        <analysis expression="." analyzed="true">
                            <returnable>
                                <path>instance('instance')</path>
                            </returnable>
                            <dependent-models>
                                <model>model</model>
                            </dependent-models>
                            <dependent-instances>
                                <instance>instance</instance>
                            </dependent-instances>
                            <returnable-instances>
                                <instance>instance</instance>
                            </returnable-instances>
                        </analysis>
                    </value>
                </variable>
                <variable scope="my-foo" prefixed-id="my-foo$v2" model-prefixed-id="my-foo$foo-model" binding="false" value="true" name="v2">
                    <value>
                        <analysis expression="$v1" analyzed="true">
                            <returnable>
                                <path>instance('instance')</path>
                            </returnable>
                            <dependent-models>
                                <model>model</model>
                            </dependent-models>
                            <dependent-instances>
                                <instance>instance</instance>
                            </dependent-instances>
                            <returnable-instances>
                                <instance>instance</instance>
                            </returnable-instances>
                        </analysis>
                    </value>
                </variable>
                <output scope="my-foo" prefixed-id="my-foo$output1" model-prefixed-id="my-foo$foo-model" binding="false" value="true">
                    <value>
                        <analysis expression="xs:string(($v2)[1])" analyzed="true">
                            <value-dependent>
                                <path>instance('instance')</path>
                            </value-dependent>
                            <dependent-models>
                                <model>model</model>
                            </dependent-models>
                            <dependent-instances>
                                <instance>instance</instance>
                            </dependent-instances>
                        </analysis>
                    </value>
                </output>
                <variable scope="my-foo" prefixed-id="my-foo$v3" model-prefixed-id="my-foo$foo-model" binding="false" value="true" name="v3">
                    <value>
                        <analysis expression="." analyzed="true">
                            <returnable>
                                <path>instance('my-foo$foo-instance')</path>
                            </returnable>
                            <dependent-models>
                                <model>my-foo$foo-model</model>
                            </dependent-models>
                            <dependent-instances>
                                <instance>my-foo$foo-instance</instance>
                            </dependent-instances>
                            <returnable-instances>
                                <instance>my-foo$foo-instance</instance>
                            </returnable-instances>
                        </analysis>
                    </value>
                </variable>
                <variable scope="" prefixed-id="my-foo$v4" model-prefixed-id="model" binding="false" value="true" name="v4">
                    <value>
                        <analysis expression="$v3" analyzed="true">
                            <returnable>
                                <path>instance('my-foo$foo-instance')</path>
                            </returnable>
                            <dependent-models>
                                <model>my-foo$foo-model</model>
                            </dependent-models>
                            <dependent-instances>
                                <instance>my-foo$foo-instance</instance>
                            </dependent-instances>
                            <returnable-instances>
                                <instance>my-foo$foo-instance</instance>
                            </returnable-instances>
                        </analysis>
                    </value>
                </variable>
                <output scope="" prefixed-id="my-foo$output2" model-prefixed-id="model" binding="false" value="true">
                    <value>
                        <analysis expression="xs:string(($v4)[1])" analyzed="true">
                            <value-dependent>
                                <path>instance('my-foo$foo-instance')</path>
                            </value-dependent>
                            <dependent-models>
                                <model>my-foo$foo-model</model>
                            </dependent-models>
                            <dependent-instances>
                                <instance>my-foo$foo-instance</instance>
                            </dependent-instances>
                        </analysis>
                    </value>
                </output>
                <model scope="" prefixed-id="model" default-instance-prefixed-id="instance" analyzed-binds="true"/>
                <model scope="my-foo" prefixed-id="my-foo$foo-model" default-instance-prefixed-id="my-foo$foo-instance" analyzed-binds="true"/>
            </request>
        </output>
    </test>

    <test description="Label output in different scope" name="oxf:java">
        <input name="config">
            <config sourcepath="oxf:/" class="org.orbeon.oxf.xforms.analysis.XPathAnalysisProcessor"/>
        </input>
        <input name="form">
            <xh:html xmlns:xxf="http://orbeon.org/oxf/xml/xforms" xmlns:fr="http://orbeon.org/oxf/xml/form-runner"
                     xmlns:xbl="http://www.w3.org/ns/xbl" xmlns:xxbl="http://orbeon.org/oxf/xml/xbl">
                <xh:head>
                    <xf:model xxf:xpath-analysis="true" id="model">
                        <xf:instance id="instance">
                            <instance>
                                <foo>42</foo>
                                <bar>43</bar>
                            </instance>
                        </xf:instance>
                    </xf:model>
                    <xbl:xbl>
                        <xbl:binding id="fr-foo" element="fr|foo">
                            <xbl:template>
                                <xf:group id="foo-group">
                                    <xf:label id="foo-label"><xf:output id="foo-output" xxbl:scope="outer" xbl:attr="ref=label-ref"/></xf:label>
                                </xf:group>
                            </xbl:template>
                        </xbl:binding>
                    </xbl:xbl>
                </xh:head>
                <xh:body>
                    <xxf:variable name="bar" select="instance()/bar"/>
                    <fr:foo id="my-foo" label-ref="$bar"/>
                </xh:body>
            </xh:html>
        </input>
        <output name="analysis">
            <request request-uri="/orbeon/doc/home-welcome" query-string="id=12&amp;print=false" method="GET">
                <variable scope="" prefixed-id="xf-2" model-prefixed-id="model" binding="false" value="true" name="bar">
                    <value>
                        <analysis expression="instance()/bar" analyzed="true">
                            <returnable>
                                <path>instance('instance')/bar</path>
                            </returnable>
                            <dependent-models>
                                <model>model</model>
                            </dependent-models>
                            <dependent-instances>
                                <instance>instance</instance>
                            </dependent-instances>
                            <returnable-instances>
                                <instance>instance</instance>
                            </returnable-instances>
                        </analysis>
                    </value>
                </variable>
                <foo scope="" prefixed-id="my-foo" model-prefixed-id="model" binding="false" value="false"/>
                <group scope="my-foo" prefixed-id="my-foo$foo-group" binding="false" value="false">
                    <label>
                        <analysis expression="xs:string(.[1])" analyzed="true">
                            <value-dependent>
                                <path>instance('instance')/bar</path>
                            </value-dependent>
                            <dependent-models>
                                <model>model</model>
                            </dependent-models>
                            <dependent-instances>
                                <instance>instance</instance>
                            </dependent-instances>
                        </analysis>
                    </label>
                </group>
                <model scope="" prefixed-id="model" default-instance-prefixed-id="instance" analyzed-binds="true"/>
            </request>
        </output>
    </test>

    <test description="Bind with name attribute" name="oxf:java">
        <input name="config">
            <config sourcepath="oxf:/" class="org.orbeon.oxf.xforms.analysis.XPathAnalysisProcessor"/>
        </input>
        <input name="form">
            <xh:html xmlns:xh="http://www.w3.org/1999/xhtml"
                     xmlns:xf="http://www.w3.org/2002/xforms"
                     xmlns:xxf="http://orbeon.org/oxf/xml/xforms">
                <xh:head>
                    <xf:model id="model" xxf:xpath-analysis="true">
                        <xf:instance id="instance">
                            <form source="" destination="" readonly=""/>
                        </xf:instance>
                        <xf:bind id="root-bind" ref="." name="root">
                            <xf:bind id="source-bind" ref="@source" name="source"/>
                            <xf:bind id="readonly-bind" ref="@readonly" readonly="$root + $destination mod 2 = 0"/>
                            <xf:bind id="destination-bind" ref="@destination" name="destination" calculate="$source"/>
                        </xf:bind>
                    </xf:model>
                </xh:head>
                <xh:body/>
            </xh:html>
        </input>
        <output name="analysis">
            <request request-uri="/orbeon/doc/home-welcome" query-string="id=12&amp;print=false" method="GET">
                <model scope="" prefixed-id="model" default-instance-prefixed-id="instance" analyzed-binds="true">
                    <binds>
                        <bind id="root-bind" ref=".">
                            <binding>
                                <analysis expression="." analyzed="true">
                                    <returnable>
                                        <path>instance('instance')</path>
                                    </returnable>
                                    <dependent-models>
                                        <model>model</model>
                                    </dependent-models>
                                    <dependent-instances>
                                        <instance>instance</instance>
                                    </dependent-instances>
                                    <returnable-instances>
                                        <instance>instance</instance>
                                    </returnable-instances>
                                </analysis>
                            </binding>
                            <bind id="source-bind" ref="@source">
                                <binding>
                                    <analysis expression="@source" analyzed="true">
                                        <returnable>
                                            <path>instance('instance')/@source</path>
                                        </returnable>
                                        <dependent-models>
                                            <model>model</model>
                                        </dependent-models>
                                        <dependent-instances>
                                            <instance>instance</instance>
                                        </dependent-instances>
                                        <returnable-instances>
                                            <instance>instance</instance>
                                        </returnable-instances>
                                    </analysis>
                                </binding>
                            </bind>
                            <bind id="readonly-bind" ref="@readonly">
                                <binding>
                                    <analysis expression="@readonly" analyzed="true">
                                        <returnable>
                                            <path>instance('instance')/@readonly</path>
                                        </returnable>
                                        <dependent-models>
                                            <model>model</model>
                                        </dependent-models>
                                        <dependent-instances>
                                            <instance>instance</instance>
                                        </dependent-instances>
                                        <returnable-instances>
                                            <instance>instance</instance>
                                        </returnable-instances>
                                    </analysis>
                                </binding>
                                <mip name="readonly" expression="$root + $destination mod 2 = 0">
                                    <analysis expression="xs:boolean(($root + $destination mod 2 = 0)[1])" analyzed="true">
                                        <value-dependent>
                                            <path>instance('instance')</path>
                                            <path>instance('instance')/@destination</path>
                                        </value-dependent>
                                        <dependent-models>
                                            <model>model</model>
                                        </dependent-models>
                                        <dependent-instances>
                                            <instance>instance</instance>
                                        </dependent-instances>
                                    </analysis>
                                </mip>
                            </bind>
                            <bind id="destination-bind" ref="@destination">
                                <binding>
                                    <analysis expression="@destination" analyzed="true">
                                        <returnable>
                                            <path>instance('instance')/@destination</path>
                                        </returnable>
                                        <dependent-models>
                                            <model>model</model>
                                        </dependent-models>
                                        <dependent-instances>
                                            <instance>instance</instance>
                                        </dependent-instances>
                                        <returnable-instances>
                                            <instance>instance</instance>
                                        </returnable-instances>
                                    </analysis>
                                </binding>
                                <mip name="calculate" expression="$source">
                                    <analysis expression="xs:string(($source)[1])" analyzed="true">
                                        <value-dependent>
                                            <path>instance('instance')/@source</path>
                                        </value-dependent>
                                        <dependent-models>
                                            <model>model</model>
                                        </dependent-models>
                                        <dependent-instances>
                                            <instance>instance</instance>
                                        </dependent-instances>
                                    </analysis>
                                </mip>
                            </bind>
                        </bind>
                    </binds>
                    <bind-instances>
                        <instance>instance</instance>
                    </bind-instances>
                    <computed-binds-instances>
                        <instance>instance</instance>
                    </computed-binds-instances>
                </model>
            </request>
        </output>
    </test>

    <test description="xxforms:instance id resolution across XBL scopes" name="oxf:java">
        <input name="config">
            <config sourcepath="oxf:/" class="org.orbeon.oxf.xforms.analysis.XPathAnalysisProcessor"/>
        </input>
        <input name="form">
            <xh:html xmlns:xh="http://www.w3.org/1999/xhtml"
                     xmlns:xf="http://www.w3.org/2002/xforms"
                     xmlns:xxf="http://orbeon.org/oxf/xml/xforms"
                     xmlns:xbl="http://www.w3.org/ns/xbl"
                     xmlns:xxbl="http://orbeon.org/oxf/xml/xbl"
                     xmlns:fr="http://orbeon.org/oxf/xml/form-runner">
                <xh:head>
                    <xf:model id="m1" xxf:xpath-analysis="true">
                        <xf:instance id="m1i1"><instance/></xf:instance>
                        <xf:instance id="m1i2"><instance/></xf:instance>
                    </xf:model>
                    <xf:model id="m2">
                        <xf:instance id="m2i1"><instance/></xf:instance>
                        <xf:instance id="m2i2"><instance/></xf:instance>
                    </xf:model>
                    <xbl:xbl>
                        <xbl:binding id="fr-foo" element="fr|foo">
                            <xbl:implementation>
                                <xf:model id="m1">
                                    <xf:instance id="m1i1"><instance/></xf:instance>
                                    <xf:instance id="m1i3"><instance/></xf:instance>
                                </xf:model>
                                <xf:model id="m2">
                                    <xf:instance id="m2i1"><instance/></xf:instance>
                                    <xf:instance id="m2i3"><instance/></xf:instance>
                                </xf:model>
                            </xbl:implementation>
                            <xbl:template>
                                <!-- Must reach local instances -->
                                <xf:output id="o1" value="xxf:instance('m1i1')"/>
                                <xf:output id="o2" value="xxf:instance('m2i1')"/>
                                <!-- Must reach top-level instances -->
                                <xf:output id="o3" value="xxf:instance('m1i2')"/>
                                <xf:output id="o4" value="xxf:instance('m2i2')"/>

                                <fr:bar id="bar1"/>

                                <!-- NOTE: We are playing with fire by specifying ids on outer scope elements here -->
                                <xf:group id="g1" xxbl:scope="outer">
                                    <!-- Must reach top-level instances -->
                                    <xf:output id="o5" value="xxf:instance('m1i1')"/>
                                    <xf:output id="o6" value="xxf:instance('m2i1')"/>
                                    <xf:output id="o7" value="xxf:instance('m1i2')"/>
                                    <xf:output id="o8" value="xxf:instance('m2i2')"/>

                                    <fr:bar id="bar2"/>
                                </xf:group>

                            </xbl:template>
                        </xbl:binding>
                    </xbl:xbl>
                    <xbl:xbl>
                        <xbl:binding id="fr-bar" element="fr|bar">
                            <xbl:implementation>
                                <xf:model id="m1">
                                    <xf:instance id="m1i1"><instance/></xf:instance>
                                </xf:model>
                                <xf:model id="m2">
                                    <xf:instance id="m2i1"><instance/></xf:instance>
                                </xf:model>
                            </xbl:implementation>
                            <xbl:template>
                                <!-- Must reach local instances -->
                                <xf:output id="o1" value="xxf:instance('m1i1')"/>
                                <xf:output id="o2" value="xxf:instance('m2i1')"/>
                                <!-- Must reach parent instances -->
                                <xf:output id="o3" value="xxf:instance('m1i3')"/>
                                <xf:output id="o4" value="xxf:instance('m2i3')"/>
                                <!-- Must reach top-level instances -->
                                <xf:output id="o5" value="xxf:instance('m1i2')"/>
                                <xf:output id="o6" value="xxf:instance('m2i2')"/>

                                <!-- NOTE: We are playing with fire by specifying ids on outer scope elements here -->
                                <xf:group id="g2" xxbl:scope="outer">
                                    <!-- Must reach outer scope instances -->
                                    <xf:output id="o9" value="xxf:instance('m1i1')"/>
                                    <xf:output id="o10" value="xxf:instance('m2i1')"/>
                                    <xf:output id="o11" value="xxf:instance('m1i3')"/>
                                    <xf:output id="o12" value="xxf:instance('m2i3')"/>
                                    <!-- Must reach top-level instances -->
                                    <xf:output id="o13" value="xxf:instance('m1i2')"/>
                                    <xf:output id="o14" value="xxf:instance('m2i2')"/>
                                </xf:group>
                            </xbl:template>
                        </xbl:binding>
                    </xbl:xbl>
                </xh:head>
                <xh:body>
                    <!-- Must reach top-level instances -->
                    <xf:output id="o1" value="xxf:instance('m1i1')"/>
                    <xf:output id="o2" value="xxf:instance('m2i1')"/>

                    <fr:foo id="foo1"/>
                </xh:body>
            </xh:html>
        </input>
        <output name="analysis">
            <request request-uri="/orbeon/doc/home-welcome" query-string="id=12&amp;print=false" method="GET">
                <output scope="" prefixed-id="o1" model-prefixed-id="m1" binding="false" value="true">
                    <value>
                        <analysis expression="xs:string((xxf:instance('m1i1'))[1])" analyzed="true">
                            <value-dependent>
                                <path>instance('m1i1')</path>
                            </value-dependent>
                            <dependent-models>
                                <model>m1</model>
                            </dependent-models>
                            <dependent-instances>
                                <instance>m1i1</instance>
                            </dependent-instances>
                        </analysis>
                    </value>
                </output>
                <output scope="" prefixed-id="o2" model-prefixed-id="m1" binding="false" value="true">
                    <value>
                        <analysis expression="xs:string((xxf:instance('m2i1'))[1])" analyzed="true">
                            <value-dependent>
                                <path>instance('m2i1')</path>
                            </value-dependent>
                            <dependent-models>
                                <model>m2</model>
                            </dependent-models>
                            <dependent-instances>
                                <instance>m2i1</instance>
                            </dependent-instances>
                        </analysis>
                    </value>
                </output>
                <foo scope="" prefixed-id="foo1" model-prefixed-id="m1" binding="false" value="false"/>
                <output scope="foo1" prefixed-id="foo1$o1" model-prefixed-id="foo1$m1" binding="false" value="true">
                    <value>
                        <analysis expression="xs:string((xxf:instance('m1i1'))[1])" analyzed="true">
                            <value-dependent>
                                <path>instance('foo1$m1i1')</path>
                            </value-dependent>
                            <dependent-models>
                                <model>foo1$m1</model>
                            </dependent-models>
                            <dependent-instances>
                                <instance>foo1$m1i1</instance>
                            </dependent-instances>
                        </analysis>
                    </value>
                </output>
                <output scope="foo1" prefixed-id="foo1$o2" model-prefixed-id="foo1$m1" binding="false" value="true">
                    <value>
                        <analysis expression="xs:string((xxf:instance('m2i1'))[1])" analyzed="true">
                            <value-dependent>
                                <path>instance('foo1$m2i1')</path>
                            </value-dependent>
                            <dependent-models>
                                <model>foo1$m2</model>
                            </dependent-models>
                            <dependent-instances>
                                <instance>foo1$m2i1</instance>
                            </dependent-instances>
                        </analysis>
                    </value>
                </output>
                <output scope="foo1" prefixed-id="foo1$o3" model-prefixed-id="foo1$m1" binding="false" value="true">
                    <value>
                        <analysis expression="xs:string((xxf:instance('m1i2'))[1])" analyzed="true">
                            <value-dependent>
                                <path>instance('m1i2')</path>
                            </value-dependent>
                            <dependent-models>
                                <model>m1</model>
                            </dependent-models>
                            <dependent-instances>
                                <instance>m1i2</instance>
                            </dependent-instances>
                        </analysis>
                    </value>
                </output>
                <output scope="foo1" prefixed-id="foo1$o4" model-prefixed-id="foo1$m1" binding="false" value="true">
                    <value>
                        <analysis expression="xs:string((xxf:instance('m2i2'))[1])" analyzed="true">
                            <value-dependent>
                                <path>instance('m2i2')</path>
                            </value-dependent>
                            <dependent-models>
                                <model>m2</model>
                            </dependent-models>
                            <dependent-instances>
                                <instance>m2i2</instance>
                            </dependent-instances>
                        </analysis>
                    </value>
                </output>
                <bar scope="foo1" prefixed-id="foo1$bar1" model-prefixed-id="foo1$m1" binding="false" value="false"/>
                <output scope="foo1$bar1" prefixed-id="foo1$bar1$o1" model-prefixed-id="foo1$bar1$m1" binding="false" value="true">
                    <value>
                        <analysis expression="xs:string((xxf:instance('m1i1'))[1])" analyzed="true">
                            <value-dependent>
                                <path>instance('foo1$bar1$m1i1')</path>
                            </value-dependent>
                            <dependent-models>
                                <model>foo1$bar1$m1</model>
                            </dependent-models>
                            <dependent-instances>
                                <instance>foo1$bar1$m1i1</instance>
                            </dependent-instances>
                        </analysis>
                    </value>
                </output>
                <output scope="foo1$bar1" prefixed-id="foo1$bar1$o2" model-prefixed-id="foo1$bar1$m1" binding="false" value="true">
                    <value>
                        <analysis expression="xs:string((xxf:instance('m2i1'))[1])" analyzed="true">
                            <value-dependent>
                                <path>instance('foo1$bar1$m2i1')</path>
                            </value-dependent>
                            <dependent-models>
                                <model>foo1$bar1$m2</model>
                            </dependent-models>
                            <dependent-instances>
                                <instance>foo1$bar1$m2i1</instance>
                            </dependent-instances>
                        </analysis>
                    </value>
                </output>
                <output scope="foo1$bar1" prefixed-id="foo1$bar1$o3" model-prefixed-id="foo1$bar1$m1" binding="false" value="true">
                    <value>
                        <analysis expression="xs:string((xxf:instance('m1i3'))[1])" analyzed="true">
                            <value-dependent>
                                <path>instance('foo1$m1i3')</path>
                            </value-dependent>
                            <dependent-models>
                                <model>foo1$m1</model>
                            </dependent-models>
                            <dependent-instances>
                                <instance>foo1$m1i3</instance>
                            </dependent-instances>
                        </analysis>
                    </value>
                </output>
                <output scope="foo1$bar1" prefixed-id="foo1$bar1$o4" model-prefixed-id="foo1$bar1$m1" binding="false" value="true">
                    <value>
                        <analysis expression="xs:string((xxf:instance('m2i3'))[1])" analyzed="true">
                            <value-dependent>
                                <path>instance('foo1$m2i3')</path>
                            </value-dependent>
                            <dependent-models>
                                <model>foo1$m2</model>
                            </dependent-models>
                            <dependent-instances>
                                <instance>foo1$m2i3</instance>
                            </dependent-instances>
                        </analysis>
                    </value>
                </output>
                <output scope="foo1$bar1" prefixed-id="foo1$bar1$o5" model-prefixed-id="foo1$bar1$m1" binding="false" value="true">
                    <value>
                        <analysis expression="xs:string((xxf:instance('m1i2'))[1])" analyzed="true">
                            <value-dependent>
                                <path>instance('m1i2')</path>
                            </value-dependent>
                            <dependent-models>
                                <model>m1</model>
                            </dependent-models>
                            <dependent-instances>
                                <instance>m1i2</instance>
                            </dependent-instances>
                        </analysis>
                    </value>
                </output>
                <output scope="foo1$bar1" prefixed-id="foo1$bar1$o6" model-prefixed-id="foo1$bar1$m1" binding="false" value="true">
                    <value>
                        <analysis expression="xs:string((xxf:instance('m2i2'))[1])" analyzed="true">
                            <value-dependent>
                                <path>instance('m2i2')</path>
                            </value-dependent>
                            <dependent-models>
                                <model>m2</model>
                            </dependent-models>
                            <dependent-instances>
                                <instance>m2i2</instance>
                            </dependent-instances>
                        </analysis>
                    </value>
                </output>
                <group scope="foo1" prefixed-id="foo1$bar1$g2" model-prefixed-id="foo1$m1" binding="false" value="false"/>
                <output scope="foo1" prefixed-id="foo1$bar1$o9" model-prefixed-id="foo1$m1" binding="false" value="true">
                    <value>
                        <analysis expression="xs:string((xxf:instance('m1i1'))[1])" analyzed="true">
                            <value-dependent>
                                <path>instance('foo1$m1i1')</path>
                            </value-dependent>
                            <dependent-models>
                                <model>foo1$m1</model>
                            </dependent-models>
                            <dependent-instances>
                                <instance>foo1$m1i1</instance>
                            </dependent-instances>
                        </analysis>
                    </value>
                </output>
                <output scope="foo1" prefixed-id="foo1$bar1$o10" model-prefixed-id="foo1$m1" binding="false" value="true">
                    <value>
                        <analysis expression="xs:string((xxf:instance('m2i1'))[1])" analyzed="true">
                            <value-dependent>
                                <path>instance('foo1$m2i1')</path>
                            </value-dependent>
                            <dependent-models>
                                <model>foo1$m2</model>
                            </dependent-models>
                            <dependent-instances>
                                <instance>foo1$m2i1</instance>
                            </dependent-instances>
                        </analysis>
                    </value>
                </output>
                <output scope="foo1" prefixed-id="foo1$bar1$o11" model-prefixed-id="foo1$m1" binding="false" value="true">
                    <value>
                        <analysis expression="xs:string((xxf:instance('m1i3'))[1])" analyzed="true">
                            <value-dependent>
                                <path>instance('foo1$m1i3')</path>
                            </value-dependent>
                            <dependent-models>
                                <model>foo1$m1</model>
                            </dependent-models>
                            <dependent-instances>
                                <instance>foo1$m1i3</instance>
                            </dependent-instances>
                        </analysis>
                    </value>
                </output>
                <output scope="foo1" prefixed-id="foo1$bar1$o12" model-prefixed-id="foo1$m1" binding="false" value="true">
                    <value>
                        <analysis expression="xs:string((xxf:instance('m2i3'))[1])" analyzed="true">
                            <value-dependent>
                                <path>instance('foo1$m2i3')</path>
                            </value-dependent>
                            <dependent-models>
                                <model>foo1$m2</model>
                            </dependent-models>
                            <dependent-instances>
                                <instance>foo1$m2i3</instance>
                            </dependent-instances>
                        </analysis>
                    </value>
                </output>
                <output scope="foo1" prefixed-id="foo1$bar1$o13" model-prefixed-id="foo1$m1" binding="false" value="true">
                    <value>
                        <analysis expression="xs:string((xxf:instance('m1i2'))[1])" analyzed="true">
                            <value-dependent>
                                <path>instance('m1i2')</path>
                            </value-dependent>
                            <dependent-models>
                                <model>m1</model>
                            </dependent-models>
                            <dependent-instances>
                                <instance>m1i2</instance>
                            </dependent-instances>
                        </analysis>
                    </value>
                </output>
                <output scope="foo1" prefixed-id="foo1$bar1$o14" model-prefixed-id="foo1$m1" binding="false" value="true">
                    <value>
                        <analysis expression="xs:string((xxf:instance('m2i2'))[1])" analyzed="true">
                            <value-dependent>
                                <path>instance('m2i2')</path>
                            </value-dependent>
                            <dependent-models>
                                <model>m2</model>
                            </dependent-models>
                            <dependent-instances>
                                <instance>m2i2</instance>
                            </dependent-instances>
                        </analysis>
                    </value>
                </output>
                <group scope="" prefixed-id="foo1$g1" model-prefixed-id="m1" binding="false" value="false"/>
                <output scope="" prefixed-id="foo1$o5" model-prefixed-id="m1" binding="false" value="true">
                    <value>
                        <analysis expression="xs:string((xxf:instance('m1i1'))[1])" analyzed="true">
                            <value-dependent>
                                <path>instance('m1i1')</path>
                            </value-dependent>
                            <dependent-models>
                                <model>m1</model>
                            </dependent-models>
                            <dependent-instances>
                                <instance>m1i1</instance>
                            </dependent-instances>
                        </analysis>
                    </value>
                </output>
                <output scope="" prefixed-id="foo1$o6" model-prefixed-id="m1" binding="false" value="true">
                    <value>
                        <analysis expression="xs:string((xxf:instance('m2i1'))[1])" analyzed="true">
                            <value-dependent>
                                <path>instance('m2i1')</path>
                            </value-dependent>
                            <dependent-models>
                                <model>m2</model>
                            </dependent-models>
                            <dependent-instances>
                                <instance>m2i1</instance>
                            </dependent-instances>
                        </analysis>
                    </value>
                </output>
                <output scope="" prefixed-id="foo1$o7" model-prefixed-id="m1" binding="false" value="true">
                    <value>
                        <analysis expression="xs:string((xxf:instance('m1i2'))[1])" analyzed="true">
                            <value-dependent>
                                <path>instance('m1i2')</path>
                            </value-dependent>
                            <dependent-models>
                                <model>m1</model>
                            </dependent-models>
                            <dependent-instances>
                                <instance>m1i2</instance>
                            </dependent-instances>
                        </analysis>
                    </value>
                </output>
                <output scope="" prefixed-id="foo1$o8" model-prefixed-id="m1" binding="false" value="true">
                    <value>
                        <analysis expression="xs:string((xxf:instance('m2i2'))[1])" analyzed="true">
                            <value-dependent>
                                <path>instance('m2i2')</path>
                            </value-dependent>
                            <dependent-models>
                                <model>m2</model>
                            </dependent-models>
                            <dependent-instances>
                                <instance>m2i2</instance>
                            </dependent-instances>
                        </analysis>
                    </value>
                </output>
                <bar scope="" prefixed-id="foo1$bar2" model-prefixed-id="m1" binding="false" value="false"/>
                <output scope="foo1$bar2" prefixed-id="foo1$bar2$o1" model-prefixed-id="foo1$bar2$m1" binding="false" value="true">
                    <value>
                        <analysis expression="xs:string((xxf:instance('m1i1'))[1])" analyzed="true">
                            <value-dependent>
                                <path>instance('foo1$bar2$m1i1')</path>
                            </value-dependent>
                            <dependent-models>
                                <model>foo1$bar2$m1</model>
                            </dependent-models>
                            <dependent-instances>
                                <instance>foo1$bar2$m1i1</instance>
                            </dependent-instances>
                        </analysis>
                    </value>
                </output>
                <output scope="foo1$bar2" prefixed-id="foo1$bar2$o2" model-prefixed-id="foo1$bar2$m1" binding="false" value="true">
                    <value>
                        <analysis expression="xs:string((xxf:instance('m2i1'))[1])" analyzed="true">
                            <value-dependent>
                                <path>instance('foo1$bar2$m2i1')</path>
                            </value-dependent>
                            <dependent-models>
                                <model>foo1$bar2$m2</model>
                            </dependent-models>
                            <dependent-instances>
                                <instance>foo1$bar2$m2i1</instance>
                            </dependent-instances>
                        </analysis>
                    </value>
                </output>
                <output scope="foo1$bar2" prefixed-id="foo1$bar2$o3" model-prefixed-id="foo1$bar2$m1" binding="false" value="true">
                    <value>
                        <analysis expression="xs:string((xxf:instance('m1i3'))[1])" analyzed="true">
                            <value-dependent>
                                <path>instance('foo1$m1i3')</path>
                            </value-dependent>
                            <dependent-models>
                                <model>foo1$m1</model>
                            </dependent-models>
                            <dependent-instances>
                                <instance>foo1$m1i3</instance>
                            </dependent-instances>
                        </analysis>
                    </value>
                </output>
                <output scope="foo1$bar2" prefixed-id="foo1$bar2$o4" model-prefixed-id="foo1$bar2$m1" binding="false" value="true">
                    <value>
                        <analysis expression="xs:string((xxf:instance('m2i3'))[1])" analyzed="true">
                            <value-dependent>
                                <path>instance('foo1$m2i3')</path>
                            </value-dependent>
                            <dependent-models>
                                <model>foo1$m2</model>
                            </dependent-models>
                            <dependent-instances>
                                <instance>foo1$m2i3</instance>
                            </dependent-instances>
                        </analysis>
                    </value>
                </output>
                <output scope="foo1$bar2" prefixed-id="foo1$bar2$o5" model-prefixed-id="foo1$bar2$m1" binding="false" value="true">
                    <value>
                        <analysis expression="xs:string((xxf:instance('m1i2'))[1])" analyzed="true">
                            <value-dependent>
                                <path>instance('m1i2')</path>
                            </value-dependent>
                            <dependent-models>
                                <model>m1</model>
                            </dependent-models>
                            <dependent-instances>
                                <instance>m1i2</instance>
                            </dependent-instances>
                        </analysis>
                    </value>
                </output>
                <output scope="foo1$bar2" prefixed-id="foo1$bar2$o6" model-prefixed-id="foo1$bar2$m1" binding="false" value="true">
                    <value>
                        <analysis expression="xs:string((xxf:instance('m2i2'))[1])" analyzed="true">
                            <value-dependent>
                                <path>instance('m2i2')</path>
                            </value-dependent>
                            <dependent-models>
                                <model>m2</model>
                            </dependent-models>
                            <dependent-instances>
                                <instance>m2i2</instance>
                            </dependent-instances>
                        </analysis>
                    </value>
                </output>
                <group scope="" prefixed-id="foo1$bar2$g2" model-prefixed-id="m1" binding="false" value="false"/>
                <output scope="" prefixed-id="foo1$bar2$o9" model-prefixed-id="m1" binding="false" value="true">
                    <value>
                        <analysis expression="xs:string((xxf:instance('m1i1'))[1])" analyzed="true">
                            <value-dependent>
                                <path>instance('m1i1')</path>
                            </value-dependent>
                            <dependent-models>
                                <model>m1</model>
                            </dependent-models>
                            <dependent-instances>
                                <instance>m1i1</instance>
                            </dependent-instances>
                        </analysis>
                    </value>
                </output>
                <output scope="" prefixed-id="foo1$bar2$o10" model-prefixed-id="m1" binding="false" value="true">
                    <value>
                        <analysis expression="xs:string((xxf:instance('m2i1'))[1])" analyzed="true">
                            <value-dependent>
                                <path>instance('m2i1')</path>
                            </value-dependent>
                            <dependent-models>
                                <model>m2</model>
                            </dependent-models>
                            <dependent-instances>
                                <instance>m2i1</instance>
                            </dependent-instances>
                        </analysis>
                    </value>
                </output>
                <output scope="" prefixed-id="foo1$bar2$o11" model-prefixed-id="m1" binding="false" value="true">
                    <value>
                        <analysis expression="xs:string((xxf:instance('m1i3'))[1])" analyzed="true"/>
                    </value>
                </output>
                <output scope="" prefixed-id="foo1$bar2$o12" model-prefixed-id="m1" binding="false" value="true">
                    <value>
                        <analysis expression="xs:string((xxf:instance('m2i3'))[1])" analyzed="true"/>
                    </value>
                </output>
                <output scope="" prefixed-id="foo1$bar2$o13" model-prefixed-id="m1" binding="false" value="true">
                    <value>
                        <analysis expression="xs:string((xxf:instance('m1i2'))[1])" analyzed="true">
                            <value-dependent>
                                <path>instance('m1i2')</path>
                            </value-dependent>
                            <dependent-models>
                                <model>m1</model>
                            </dependent-models>
                            <dependent-instances>
                                <instance>m1i2</instance>
                            </dependent-instances>
                        </analysis>
                    </value>
                </output>
                <output scope="" prefixed-id="foo1$bar2$o14" model-prefixed-id="m1" binding="false" value="true">
                    <value>
                        <analysis expression="xs:string((xxf:instance('m2i2'))[1])" analyzed="true">
                            <value-dependent>
                                <path>instance('m2i2')</path>
                            </value-dependent>
                            <dependent-models>
                                <model>m2</model>
                            </dependent-models>
                            <dependent-instances>
                                <instance>m2i2</instance>
                            </dependent-instances>
                        </analysis>
                    </value>
                </output>
                <model scope="" prefixed-id="m1" default-instance-prefixed-id="m1i1" analyzed-binds="true"/>
                <model scope="" prefixed-id="m2" default-instance-prefixed-id="m2i1" analyzed-binds="true"/>
                <model scope="foo1" prefixed-id="foo1$m1" default-instance-prefixed-id="foo1$m1i1" analyzed-binds="true"/>
                <model scope="foo1" prefixed-id="foo1$m2" default-instance-prefixed-id="foo1$m2i1" analyzed-binds="true"/>
                <model scope="foo1$bar1" prefixed-id="foo1$bar1$m1" default-instance-prefixed-id="foo1$bar1$m1i1" analyzed-binds="true"/>
                <model scope="foo1$bar1" prefixed-id="foo1$bar1$m2" default-instance-prefixed-id="foo1$bar1$m2i1" analyzed-binds="true"/>
                <model scope="foo1$bar2" prefixed-id="foo1$bar2$m1" default-instance-prefixed-id="foo1$bar2$m1i1" analyzed-binds="true"/>
                <model scope="foo1$bar2" prefixed-id="foo1$bar2$m2" default-instance-prefixed-id="foo1$bar2$m2i1" analyzed-binds="true"/>
            </request>
        </output>
    </test>

    <test description="NPE in NodeWrapper.getDocumentNumber()" name="oxf:pipeline">
        <!-- See: http://forge.ow2.org/tracker/index.php?func=detail&aid=315919&group_id=168&atid=350207 -->
        <input name="config" href="wrap-xforms-state.xpl"/>
        <input name="document">
            <xh:html xmlns:xxf="http://orbeon.org/oxf/xml/xforms" xmlns:xs="http://www.w3.org/2001/XMLSchema">
                <xh:head>
                    <xf:model xxf:xpath-analysis="true" id="model">
                        <xf:instance id="instance">
                            <instance>
                                <deleted>
                                    <inside>b</inside>
                                    <inside>a</inside>
                                </deleted>
                            </instance>
                        </xf:instance>
                        <xxf:variable name="deleted" select="deleted"/>
                        <xf:action ev:event="xforms-ready">
                            <!-- NOTE: setindex is needed to cause the NPE upon delete -->
                            <xf:setindex repeat="my-index" index="2"/>
                            <xf:delete ref="deleted"/>
                        </xf:action>
                    </xf:model>
                </xh:head>
                <xh:body>
                    <xf:repeat ref="$deleted/inside" id="my-repeat">
                        <xf:input ref="." id="my-input"/>
                    </xf:repeat>
                </xh:body>
            </xh:html>
        </input>
        <output name="response">
            <xxf:event-response xmlns:xxf="http://orbeon.org/oxf/xml/xforms">
                <xxf:dynamic-state>
                    <dynamic-state>
                        <instances>
                            <instance id="instance" model-id="model">
                                <instance> </instance>
                            </instance>
                        </instances>
                    </dynamic-state>
                </xxf:dynamic-state>
                <xxf:action>
                    <xxf:control-values/>
                </xxf:action>
            </xxf:event-response>
        </output>
    </test>

</group>
