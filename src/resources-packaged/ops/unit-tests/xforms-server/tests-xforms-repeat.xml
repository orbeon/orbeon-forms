<!--
  Copyright (C) 2010 Orbeon, Inc.

  This program is free software; you can redistribute it and/or modify it under the terms of the
  GNU Lesser General Public License as published by the Free Software Foundation; either version
  2.1 of the License, or (at your option) any later version.

  This program is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY;
  without even the implied warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.
  See the GNU Lesser General Public License for more details.

  The full text of the license is available at http://www.gnu.org/copyleft/lesser.html
  -->
<group description="XForms Repeat" xmlns:p="http://www.orbeon.com/oxf/pipeline"
    xmlns:xsl="http://www.w3.org/1999/XSL/Transform"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xmlns:xs="http://www.w3.org/2001/XMLSchema"
    xmlns:xhtml="http://www.w3.org/1999/xhtml"
    xmlns:xu="http://www.xmldb.org/xupdate"
    xmlns:oxf="http://www.orbeon.com/oxf/processors"
    xmlns:xi="http://www.w3.org/2001/XInclude"
    xmlns:xxi="http://orbeon.org/oxf/xml/xinclude"
    xmlns:xforms="http://www.w3.org/2002/xforms"
    xmlns:xf="http://www.w3.org/2002/xforms"
    xmlns:ev="http://www.w3.org/2001/xml-events"
    xmlns:xbl="http://www.w3.org/ns/xbl"
    xmlns:fr="http://orbeon.org/oxf/xml/form-runner">

    <test description="xforms:repeat initialization" name="oxf:pipeline">
        <input name="config">
            <p:config xmlns:oxf="http://www.orbeon.com/oxf/processors" xmlns:xxforms="http://orbeon.org/oxf/xml/xforms" xmlns:xforms="http://www.w3.org/2002/xforms">
                <p:param name="response" type="output"/>

                <p:processor name="oxf:pipeline">
                    <p:input name="config" href="wrap-xforms-state.xpl"/>
                    <p:input name="document">
                        <xhtml:html>
                            <xhtml:head>
                                <xforms:model>
                                    <xforms:instance>
                                        <form>
                                            <company>
                                                <department>
                                                    <employee first="f11" last="l11"/>
                                                    <employee first="f12" last="l12"/>
                                                </department>
                                                <department>
                                                    <employee first="f21" last="l21"/>
                                                </department>
                                                <department>
                                                    <employee first="f31" last="l31"/>
                                                    <employee first="f32" last="l32"/>
                                                    <employee first="f33" last="l33"/>
                                                    <employee first="f34" last="l34"/>
                                                </department>
                                            </company>
                                        </form>
                                    </xforms:instance>
                                </xforms:model>
                            </xhtml:head>
                            <xhtml:body>
                                <xforms:repeat nodeset="/form/company/department" id="id123">
                                    <xforms:action ev:event="DOMActivate">
                                        <xforms:insert nodeset="../department" at="2" position="after"/>
                                    </xforms:action>
                                    <xhtml:tr>
                                        <xhtml:td>
                                            <xhtml:table>
                                                <xforms:repeat nodeset="employee" id="id124" startindex="2">
                                                    <xforms:action ev:event="DOMActivate">
                                                        <xforms:insert nodeset="../../department[index('id123')]/employee" at="2" position="after"/>
                                                    </xforms:action>
                                                    <xhtml:tr>
                                                        <xhtml:td>
                                                            <xforms:output ref="@first" id="id125"/>
                                                        </xhtml:td>
                                                        <xhtml:td>
                                                            <xforms:output ref="@last" id="id126"/>
                                                        </xhtml:td>
                                                    </xhtml:tr>
                                                </xforms:repeat>
                                            </xhtml:table>
                                        </xhtml:td>
                                    </xhtml:tr>
                                </xforms:repeat>
                            </xhtml:body>
                        </xhtml:html>
                    </p:input>
                    <p:output name="response" ref="response"/>
                </p:processor>

            </p:config>
        </input>
        <output name="response">
            <xxf:event-response xmlns:xxf="http://orbeon.org/oxf/xml/xforms">
                <xxf:dynamic-state>
                    <dynamic-state>
                        <instances>
                            <instance id="xf-2" model-id="xf-1">
                                <form>
                                    <company>
                                        <department>
                                            <employee first="f11" last="l11"/>
                                            <employee first="f12" last="l12"/>
                                        </department>
                                        <department>
                                            <employee first="f21" last="l21"/>
                                        </department>
                                        <department>
                                            <employee first="f31" last="l31"/>
                                            <employee first="f32" last="l32"/>
                                            <employee first="f33" last="l33"/>
                                            <employee first="f34" last="l34"/>
                                        </department>
                                    </company>
                                </form>
                            </instance>
                        </instances>
                        <controls>
                        <control effective-id="id123" index="1"/>
                            <control effective-id="id124·1" index="2"/>
                            <control effective-id="id124·2" index="1"/>
                            <control effective-id="id124·3" index="2"/>
                        </controls>
                    </dynamic-state>
                </xxf:dynamic-state>
                <xxf:action xmlns:xxf="http://orbeon.org/oxf/xml/xforms">
                    <xxf:control-values>
                        <xxf:control id="id125·1-1">f11</xxf:control>
                        <xxf:control id="id126·1-1">l11</xxf:control>
                        <xxf:control id="id125·1-2">f12</xxf:control>
                        <xxf:control id="id126·1-2">l12</xxf:control>
                        <xxf:control id="id125·2-1">f21</xxf:control>
                        <xxf:control id="id126·2-1">l21</xxf:control>
                        <xxf:control id="id125·3-1">f31</xxf:control>
                        <xxf:control id="id126·3-1">l31</xxf:control>
                        <xxf:control id="id125·3-2">f32</xxf:control>
                        <xxf:control id="id126·3-2">l32</xxf:control>
                        <xxf:control id="id125·3-3">f33</xxf:control>
                        <xxf:control id="id126·3-3">l33</xxf:control>
                        <xxf:control id="id125·3-4">f34</xxf:control>
                        <xxf:control id="id126·3-4">l34</xxf:control>
                    </xxf:control-values>
                </xxf:action>
            </xxf:event-response>
        </output>
    </test>

    <test description="xforms:repeat insert action" name="oxf:pipeline">
        <input name="config" href="wrap-xforms-state.xpl"/>
        <input name="document">
            <xhtml:html xmlns:xxforms="http://orbeon.org/oxf/xml/xforms">
                <xhtml:head>
                    <xi:include href="repeat-model.xml" xxi:omit-xml-base="true"/>
                </xhtml:head>
                <xhtml:body>
                    <xforms:group id="my-dummy-group">
                        <xforms:dispatch ev:observer="main-model" ev:event="xforms-ready" name="DOMActivate" targetid="id127" xxforms:repeat-indexes="1 1"/>
                    </xforms:group>
                    <xforms:repeat nodeset="company/department" id="id123">
                        <xforms:action ev:event="DOMActivate">
                            <xforms:insert nodeset="../department" at="2" position="after"/>
                        </xforms:action>
                        <xforms:repeat nodeset="employee" id="id124" startindex="2">
                            <xforms:trigger id="id127">
                                <xforms:label>Insert</xforms:label>
                                <xforms:action ev:event="DOMActivate">
                                    <xforms:insert nodeset="../../department[index('id123')]/employee" at="2" position="after"/>
                                </xforms:action>
                            </xforms:trigger>
                            <xforms:output ref="@first" id="id125"/>
                            <xforms:output ref="@last" id="id126"/>
                        </xforms:repeat>
                    </xforms:repeat>
                </xhtml:body>
            </xhtml:html>
        </input>
        <output name="response">
            <xxf:event-response xmlns:xxf="http://orbeon.org/oxf/xml/xforms">
                <xxf:dynamic-state>
                    <dynamic-state>
                        <instances>
                            <instance id="main-instance" model-id="main-model">
                                <form>
                                    <company>
                                        <department>
                                            <employee first="f11" last="l11"/>
                                            <employee first="f12" last="l12"/>
                                            <employee first="f12" last="l12"/>
                                        </department>
                                        <department>
                                            <employee first="f21" last="l21"/>
                                        </department>
                                        <department>
                                            <employee first="f31" last="l31"/>
                                            <employee first="f32" last="l32"/>
                                            <employee first="f33" last="l33"/>
                                            <employee first="f34" last="l34"/>
                                        </department>
                                        <department>
                                            <employee first="f31" last="l31"/>
                                            <employee first="f32" last="l32"/>
                                            <employee first="f33" last="l33"/>
                                            <employee first="f34" last="l34"/>
                                        </department>
                                    </company>
                                </form>
                            </instance>
                        </instances>
                        <controls>
                            <control effective-id="id123" index="3"/>
                            <control effective-id="id124·1" index="3"/>
                            <control effective-id="id124·2" index="1"/>
                            <control effective-id="id124·3" index="2"/>
                            <control effective-id="id124·4" index="2"/>
                        </controls>
                    </dynamic-state>
                </xxf:dynamic-state>
                <xxf:action>
                    <xxf:control-values>
                        <xxf:control id="id127·1-1" label="Insert"/>
                        <xxf:control id="id125·1-1">f11</xxf:control>
                        <xxf:control id="id126·1-1">l11</xxf:control>
                        <xxf:control id="id127·1-2" label="Insert"/>
                        <xxf:control id="id125·1-2">f12</xxf:control>
                        <xxf:control id="id126·1-2">l12</xxf:control>
                        <xxf:control id="id127·1-3" label="Insert"/>
                        <xxf:control id="id125·1-3">f12</xxf:control>
                        <xxf:control id="id126·1-3">l12</xxf:control>
                        <xxf:control id="id127·2-1" label="Insert"/>
                        <xxf:control id="id125·2-1">f21</xxf:control>
                        <xxf:control id="id126·2-1">l21</xxf:control>
                        <xxf:control id="id127·3-1" label="Insert"/>
                        <xxf:control id="id125·3-1">f31</xxf:control>
                        <xxf:control id="id126·3-1">l31</xxf:control>
                        <xxf:control id="id127·3-2" label="Insert"/>
                        <xxf:control id="id125·3-2">f32</xxf:control>
                        <xxf:control id="id126·3-2">l32</xxf:control>
                        <xxf:control id="id127·3-3" label="Insert"/>
                        <xxf:control id="id125·3-3">f33</xxf:control>
                        <xxf:control id="id126·3-3">l33</xxf:control>
                        <xxf:control id="id127·3-4" label="Insert"/>
                        <xxf:control id="id125·3-4">f34</xxf:control>
                        <xxf:control id="id126·3-4">l34</xxf:control>
                        <xxf:control id="id127·4-1" label="Insert"/>
                        <xxf:control id="id125·4-1">f31</xxf:control>
                        <xxf:control id="id126·4-1">l31</xxf:control>
                        <xxf:control id="id127·4-2" label="Insert"/>
                        <xxf:control id="id125·4-2">f32</xxf:control>
                        <xxf:control id="id126·4-2">l32</xxf:control>
                        <xxf:control id="id127·4-3" label="Insert"/>
                        <xxf:control id="id125·4-3">f33</xxf:control>
                        <xxf:control id="id126·4-3">l33</xxf:control>
                        <xxf:control id="id127·4-4" label="Insert"/>
                        <xxf:control id="id125·4-4">f34</xxf:control>
                        <xxf:control id="id126·4-4">l34</xxf:control>
                    </xxf:control-values>
                </xxf:action>
            </xxf:event-response>
        </output>
    </test>

     <test description="xforms:repeat delete action" name="oxf:pipeline">
        <input name="config" href="wrap-xforms-state.xpl"/>
        <input name="document">
            <xhtml:html xmlns:xxforms="http://orbeon.org/oxf/xml/xforms">
                <xhtml:head>
                    <xi:include href="repeat-model.xml" xxi:omit-xml-base="true"/>
                </xhtml:head>
                <xhtml:body>
                    <xforms:group id="my-dummy-group">
                        <xforms:dispatch ev:observer="main-model" ev:event="xforms-ready" name="DOMActivate" targetid="id127" xxforms:repeat-indexes="1 1"/>
                    </xforms:group>
                    <xforms:repeat nodeset="company/department" id="id123">
                        <xforms:repeat nodeset="employee" id="id124" startindex="2">
                            <xforms:trigger id="id127">
                                <xforms:label>Delete</xforms:label>
                                <xforms:action ev:event="DOMActivate">
                                    <xforms:delete nodeset="../../department[index('id123')]/employee" at="2"/>
                                </xforms:action>
                            </xforms:trigger>
                            <xforms:output ref="@first" id="id125"/>
                            <xforms:output ref="@last" id="id126"/>
                        </xforms:repeat>
                    </xforms:repeat>
                </xhtml:body>
            </xhtml:html>
        </input>
        <output name="response">
            <xxf:event-response xmlns:xxf="http://orbeon.org/oxf/xml/xforms">
                <xxf:dynamic-state>
                    <dynamic-state>
                        <instances>
                            <instance id="main-instance" model-id="main-model">
                                <form>
                                    <company>
                                        <department>
                                            <employee first="f11" last="l11"/>
                                        </department>
                                        <department>
                                            <employee first="f21" last="l21"/>
                                        </department>
                                        <department>
                                            <employee first="f31" last="l31"/>
                                            <employee first="f32" last="l32"/>
                                            <employee first="f33" last="l33"/>
                                            <employee first="f34" last="l34"/>
                                        </department>
                                    </company>
                                </form>
                            </instance>
                        </instances>
                        <controls>
                            <control effective-id="id123" index="1"/>
                            <control effective-id="id124·1" index="1"/>
                            <control effective-id="id124·2" index="1"/>
                            <control effective-id="id124·3" index="2"/>
                        </controls>
                    </dynamic-state>
                </xxf:dynamic-state>
                <xxf:action>
                    <xxf:control-values>
                        <xxf:control id="id127·1-1" label="Delete"/>
                        <xxf:control id="id125·1-1">f11</xxf:control>
                        <xxf:control id="id126·1-1">l11</xxf:control>
                        <xxf:control id="id127·2-1" label="Delete"/>
                        <xxf:control id="id125·2-1">f21</xxf:control>
                        <xxf:control id="id126·2-1">l21</xxf:control>
                        <xxf:control id="id127·3-1" label="Delete"/>
                        <xxf:control id="id125·3-1">f31</xxf:control>
                        <xxf:control id="id126·3-1">l31</xxf:control>
                        <xxf:control id="id127·3-2" label="Delete"/>
                        <xxf:control id="id125·3-2">f32</xxf:control>
                        <xxf:control id="id126·3-2">l32</xxf:control>
                        <xxf:control id="id127·3-3" label="Delete"/>
                        <xxf:control id="id125·3-3">f33</xxf:control>
                        <xxf:control id="id126·3-3">l33</xxf:control>
                        <xxf:control id="id127·3-4" label="Delete"/>
                        <xxf:control id="id125·3-4">f34</xxf:control>
                        <xxf:control id="id126·3-4">l34</xxf:control>
                    </xxf:control-values>
                </xxf:action>
            </xxf:event-response>
        </output>
    </test>

    <test description="Simple xforms:repeat startindex" name="oxf:pipeline">
        <input name="config" href="wrap-xforms-state.xpl"/>
        <input name="document">
            <xhtml:html xmlns:xxforms="http://orbeon.org/oxf/xml/xforms">
                <xhtml:head>
                    <xforms:model id="model">
                        <xforms:instance id="instance">
                            <company>
                                <department>
                                    <employee/>
                                    <employee/>
                                </department>
                                <department>
                                    <employee/>
                                </department>
                                <department>
                                    <employee/>
                                    <employee/>
                                    <employee/>
                                    <employee/>
                                </department>
                            </company>
                        </xforms:instance>
                    </xforms:model>
                </xhtml:head>
                <xhtml:body>
                    <xforms:repeat nodeset="department" id="department-repeat" startindex="4">
                        <xforms:repeat nodeset="employee" id="employee-repeat" startindex="2">
                        </xforms:repeat>
                    </xforms:repeat>
                </xhtml:body>
            </xhtml:html>
        </input>
        <output name="response">
            <xxf:event-response xmlns:xxf="http://orbeon.org/oxf/xml/xforms">
                <xxf:dynamic-state>
                    <dynamic-state>
                        <instances>
                            <instance id="instance" model-id="model">
                                <company>
                                    <department>
                                        <employee/>
                                        <employee/>
                                    </department>
                                    <department>
                                        <employee/>
                                    </department>
                                    <department>
                                        <employee/>
                                        <employee/>
                                        <employee/>
                                        <employee/>
                                    </department>
                                </company>
                            </instance>
                        </instances>
                        <controls>
                            <control effective-id="department-repeat" index="3"/>
                            <control effective-id="employee-repeat·1" index="2"/>
                            <control effective-id="employee-repeat·2" index="1"/>
                            <control effective-id="employee-repeat·3" index="2"/>
                        </controls>
                    </dynamic-state>
                </xxf:dynamic-state>
                <xxf:action>
                    <xxf:control-values/>
                </xxf:action>
            </xxf:event-response>
        </output>
    </test>

    <test description="xforms:repeat setindex action in reaction to event dispatched to nested repeat" name="oxf:pipeline">
        <input name="config" href="wrap-xforms-state.xpl"/>
        <input name="document">
            <xhtml:html xmlns:xxforms="http://orbeon.org/oxf/xml/xforms">
                <xhtml:head>
                    <xforms:model id="main-model">
                        <xforms:instance id="main-instance">
                            <company>
                                <department>
                                    <employee/>
                                    <employee/>
                                </department>
                                <department>
                                    <employee/>
                                </department>
                                <department>
                                    <employee/>
                                    <employee/>
                                    <employee/>
                                    <employee/>
                                </department>
                            </company>
                        </xforms:instance>

                        <!-- Initial indexes are all "1"; dispatching will cause the nested repeat in position 3 to change, not that in position 2 -->
                        <xforms:dispatch ev:event="xforms-ready" name="DOMActivate" targetid="my-trigger" xxforms:repeat-indexes="3 2"/>

                    </xforms:model>
                </xhtml:head>
                <xhtml:body>
                    <xforms:repeat nodeset="department" id="department-repeat">
                        <xforms:repeat nodeset="employee" id="employee-repeat">
                            <xforms:trigger id="my-trigger">
                                <xforms:action id="a1" ev:event="DOMActivate">
                                    <xforms:setindex id="a2" repeat="department-repeat" index="2"/>
                                    <xforms:setindex id="a3" repeat="employee-repeat" index="4"/>
                                </xforms:action>
                            </xforms:trigger>
                        </xforms:repeat>
                    </xforms:repeat>
                </xhtml:body>
            </xhtml:html>
        </input>
        <output name="response">
            <xxf:event-response xmlns:xxf="http://orbeon.org/oxf/xml/xforms">
                <xxf:dynamic-state>
                    <dynamic-state>
                        <instances>
                            <instance id="main-instance" model-id="main-model">
                                <company>
                                    <department>
                                        <employee/>
                                        <employee/>
                                    </department>
                                    <department>
                                        <employee/>
                                    </department>
                                    <department>
                                        <employee/>
                                        <employee/>
                                        <employee/>
                                        <employee/>
                                    </department>
                                </company>
                            </instance>
                        </instances>
                        <controls>
                            <control effective-id="department-repeat" index="2"/>
                            <control effective-id="employee-repeat·1" index="1"/>
                            <control effective-id="employee-repeat·2" index="1"/>
                            <control effective-id="employee-repeat·3" index="4"/>
                        </controls>
                    </dynamic-state>
                </xxf:dynamic-state>
                <xxf:action>
                    <xxf:control-values/>
                </xxf:action>
            </xxf:event-response>
        </output>
    </test>

    <test description="Repeat index change upon focus change" name="oxf:pipeline">
        <input name="config">
            <p:config xmlns:oxf="http://www.orbeon.com/oxf/processors" xmlns:xxforms="http://orbeon.org/oxf/xml/xforms" xmlns:xforms="http://www.w3.org/2002/xforms">
                <p:param name="response" type="output"/>

                <p:processor name="oxf:pipeline">
                    <p:input name="config" href="wrap-server.xpl"/>
                    <p:input name="action">
                        <xxforms:action>
                            <xxforms:event name="DOMFocusIn" source-control-id="id125·3-2"/>
                        </xxforms:action>
                    </p:input>
                    <p:input name="controls">
                        <controls
                            xmlns:xforms="http://www.w3.org/2002/xforms"
                            xmlns:xxforms="http://orbeon.org/oxf/xml/xforms"
                            xmlns:ev="http://www.w3.org/2001/xml-events">
                            <xforms:repeat nodeset="/form/company/department" id="id123">
                                <xforms:repeat nodeset="employee" id="id124">
                                    <xforms:output ref="@first" id="id125"/>
                                    <xforms:output ref="@last" id="id126"/>
                                </xforms:repeat>
                            </xforms:repeat>
                        </controls>
                    </p:input>
                    <p:input name="models" href="aggregate('models', repeat-model.xml)"/>
                    <p:input name="instances">
                        <instances>
                            <instance model-id="main-model" id="main-instance">
                                <form>
                                    <company>
                                        <department>
                                            <employee first="f11" last="l11"/>
                                            <employee first="f12" last="l12"/>
                                        </department>
                                        <department>
                                            <employee first="f21" last="l21"/>
                                        </department>
                                        <department>
                                            <employee first="f31" last="l31"/>
                                            <employee first="f32" last="l32"/>
                                            <employee first="f33" last="l33"/>
                                            <employee first="f34" last="l34"/>
                                        </department>
                                    </company>
                                </form>
                            </instance>
                        </instances>
                    </p:input>
                    <p:output name="response" ref="response"/>
                </p:processor>
            </p:config>
        </input>
        <output name="response">
            <xxf:event-response xmlns:xxf="http://orbeon.org/oxf/xml/xforms">
                <xxf:dynamic-state>
                    <dynamic-state>
                        <instances>
                            <instance id="main-instance" model-id="main-model">
                                <form>
                                    <company>
                                        <department>
                                            <employee first="f11" last="l11"/>
                                            <employee first="f12" last="l12"/>
                                        </department>
                                        <department>
                                            <employee first="f21" last="l21"/>
                                        </department>
                                        <department>
                                            <employee first="f31" last="l31"/>
                                            <employee first="f32" last="l32"/>
                                            <employee first="f33" last="l33"/>
                                            <employee first="f34" last="l34"/>
                                        </department>
                                    </company>
                                </form>
                            </instance>
                        </instances>
                        <controls>
                            <control effective-id="id123" index="3"/>
                            <control effective-id="id124·1" index="1"/>
                            <control effective-id="id124·2" index="1"/>
                            <control effective-id="id124·3" index="2"/>
                        </controls>
                    </dynamic-state>
                </xxf:dynamic-state>
                <xxf:action>
                    <xxf:control-values/>
                    <xxf:repeat-indexes>
                        <xxf:repeat-index id="id123" old-index="0" new-index="3"/>
                        <xxf:repeat-index id="id124" old-index="0" new-index="2"/>
                    </xxf:repeat-indexes>
                </xxf:action>
            </xxf:event-response>
        </output>
    </test>

    <test description="xforms:insert with @context and @origin" name="oxf:pipeline">
        <input name="config" href="wrap-xforms-state.xpl"/>
        <input name="document">
            <xhtml:html xmlns:xxforms="http://orbeon.org/oxf/xml/xforms">
                <xhtml:head>
                    <xforms:model id="main-model">
                        <xforms:instance id="instance">
                            <form>
                                <employees/>
                            </form>
                        </xforms:instance>
                        <xforms:instance id="template">
                            <employee>
                                <first-name/>
                            </employee>
                        </xforms:instance>

                        <xforms:dispatch ev:event="xforms-ready" name="DOMActivate" targetid="test-trigger"/>

                    </xforms:model>
                </xhtml:head>
                <xhtml:body>
                    <xforms:trigger id="test-trigger">
                        <xforms:label id="test-trigger-label">Add</xforms:label>
                        <xforms:action ev:event="DOMActivate">
                            <!-- For the first insert, there is no employee element yet -->
                            <xforms:setvalue ref="instance('template')/first-name">Joe</xforms:setvalue>
                            <xforms:insert context="employees" nodeset="employee"
                                           origin="instance('template')"/>
                            <!-- For the second insert, there is an employee element, and we insert after that element -->
                            <xforms:setvalue ref="instance('template')/first-name">Mary</xforms:setvalue>
                            <xforms:insert context="employees" nodeset="employee"
                                           origin="instance('template')"/>
                            <!-- This should insert between the two existing employees -->
                            <xforms:setvalue ref="instance('template')/first-name">Billy</xforms:setvalue>
                            <xforms:insert context="employees" nodeset="employee" at="index('employee-repeat')" position="before"
                                           origin="instance('template')"/>
                        </xforms:action>

                    </xforms:trigger>
                    <xforms:repeat nodeset="employees/employee" id="employee-repeat">
                        <xforms:input id="first-name-input" ref="first-name"/>
                    </xforms:repeat>
                </xhtml:body>
            </xhtml:html>
        </input>
        <output name="response">
            <xxf:event-response xmlns:xxf="http://orbeon.org/oxf/xml/xforms">
                <xxf:dynamic-state>
                    <dynamic-state>
                        <instances>
                            <instance id="instance" model-id="main-model">
                                <form>
                                    <employees>
                                        <employee>
                                            <first-name>Joe</first-name>
                                        </employee>
                                        <employee>
                                            <first-name>Billy</first-name>
                                        </employee>
                                        <employee>
                                            <first-name>Mary</first-name>
                                        </employee>
                                    </employees>
                                </form>
                            </instance>
                            <instance id="template" model-id="main-model">
                                <employee>
                                    <first-name>Billy</first-name>
                                </employee>
                            </instance>
                        </instances>
                        <controls>
                            <control effective-id="employee-repeat" index="2"/>
                        </controls>
                    </dynamic-state>
                </xxf:dynamic-state>
                <xxf:action>
                    <xxf:control-values>
                        <xxf:control id="test-trigger" label="Add"/>
                        <xxf:control id="first-name-input·1">Joe</xxf:control>
                        <xxf:control id="first-name-input·2">Billy</xxf:control>
                        <xxf:control id="first-name-input·3">Mary</xxf:control>
                    </xxf:control-values>
                </xxf:action>
            </xxf:event-response>
        </output>
    </test>

    <test description="Index initialization" name="oxf:pipeline">
        <input name="config">
            <p:config xmlns:oxf="http://www.orbeon.com/oxf/processors" xmlns:xxforms="http://orbeon.org/oxf/xml/xforms">
                <p:param name="response" type="output"/>
                <p:processor name="oxf:pipeline">
                    <p:input name="config" href="wrap-xforms-state.xpl"/>
                    <p:input name="document">
                        <xhtml:html>
                            <xhtml:head>
                                <xforms:model id="main-model">
                                    <xforms:instance>
                                       <instance model-id="main-model">
                                           <r1/>
                                           <r1>
                                               <r2/>
                                               <r2/>
                                           </r1>
                                           <r1/>
                                           <r3/>
                                           <r4/>
                                           <r4>
                                               <r5/>
                                               <r5/>
                                           </r4>
                                           <r4/>
                                       </instance>
                                    </xforms:instance>
                                </xforms:model>
                            </xhtml:head>
                            <xhtml:body>
                                <!-- Check startindex in bounds, out of bounds, and 0 -->
                                <xforms:repeat nodeset="r1" id="repeat1" startindex="2">
                                    <xforms:repeat nodeset="r2" id="repeat2" startindex="4">
                                    </xforms:repeat>
                                </xforms:repeat>
                                <xforms:repeat nodeset="r3" id="repeat3">
                                </xforms:repeat>
                                <xforms:repeat nodeset="r4" id="repeat4">
                                    <xforms:repeat nodeset="r5" id="repeat5"/>
                                </xforms:repeat>
                            </xhtml:body>
                        </xhtml:html>
                    </p:input>
                    <p:output name="response" id="repeat-response"/>
                </p:processor>

                <!-- Just return repeat information -->
                <p:processor name="oxf:unsafe-xslt">
                    <p:input name="data" href="#repeat-response"/>
                    <p:input name="config">
                        <xsl:stylesheet version="2.0">
                            <xsl:template match="/">
                                <xsl:copy-of select="//controls"/>
                            </xsl:template>
                        </xsl:stylesheet>
                    </p:input>
                    <p:output name="data" ref="response"/>
                </p:processor>

            </p:config>
        </input>
        <output name="response">
            <controls>
                <control effective-id="repeat1" index="2"/>
                <control effective-id="repeat2·2" index="2"/>
                <control effective-id="repeat3" index="1"/>
                <control effective-id="repeat4" index="1"/>
                <control effective-id="repeat5·2" index="1"/>
            </controls>
        </output>
    </test>

    <test description="Reference to nested binds from repeat" name="oxf:pipeline">
        <input name="config">
            <p:config xmlns:oxf="http://www.orbeon.com/oxf/processors" xmlns:xxforms="http://orbeon.org/oxf/xml/xforms">
                <p:param name="response" type="output"/>

                <p:processor name="oxf:pipeline">
                    <p:input name="config" href="wrap-xforms-state.xpl"/>
                    <p:input name="document">
                        <xhtml:html>
                            <xhtml:head>
                                <xforms:model id="main-model">
                                    <xforms:instance id="main-instance">
                                        <instance xmlns="">
                                            <book>
                                                <title>Don Quixote de la Mancha</title>
                                                <author>Miguel de Cervantes Saavedra</author>
                                            </book>
                                            <book>
                                                <title>Jacques le fataliste et son maître</title>
                                                <author>Denis Diderot</author>
                                            </book>
                                            <book>
                                                <title>Childhood's End</title>
                                                <author>Arthur C. Clarke</author>
                                            </book>
                                        </instance>
                                    </xforms:instance>

                                    <xforms:bind nodeset="book">
                                        <xforms:bind id="title-bind" nodeset="title" required="true()"/>
                                        <xforms:bind id="author-bind" nodeset="author" required="true()"/>
                                    </xforms:bind>
                                </xforms:model>
                            </xhtml:head>
                            <xhtml:body>
                                <xforms:repeat nodeset="book" id="book-repeat">
                                    <xforms:input id="title-control" bind="title-bind">
                                        <xforms:label>Title</xforms:label>
                                    </xforms:input>
                                    <xforms:input id="author-control" bind="author-bind">
                                        <xforms:label>Author</xforms:label>
                                    </xforms:input>
                                </xforms:repeat>
                            </xhtml:body>
                        </xhtml:html>
                    </p:input>
                    <p:output name="response" ref="response"/>
                </p:processor>

            </p:config>
        </input>
        <output name="response">
            <xxf:event-response xmlns:xxf="http://orbeon.org/oxf/xml/xforms">
                <xxf:dynamic-state>
                    <dynamic-state>
                        <instances>
                            <instance id="main-instance" model-id="main-model">
                                <instance>
                                    <book>
                                        <title>Don Quixote de la Mancha</title>
                                        <author>Miguel de Cervantes Saavedra</author>
                                    </book>
                                    <book>
                                        <title>Jacques le fataliste et son maître</title>
                                        <author>Denis Diderot</author>
                                    </book>
                                    <book>
                                        <title>Childhood's End</title>
                                        <author>Arthur C. Clarke</author>
                                    </book>
                                </instance>
                            </instance>
                        </instances>
                        <controls>
                            <control effective-id="book-repeat" index="1"/>
                        </controls>
                    </dynamic-state>
                </xxf:dynamic-state>
                <xxf:action>
                    <xxf:control-values>
                        <xxf:control id="title-control·1" label="Title" required="true">Don Quixote de la Mancha</xxf:control>
                        <xxf:control id="author-control·1" label="Author" required="true">Miguel de Cervantes Saavedra</xxf:control>
                        <xxf:control id="title-control·2" label="Title" required="true">Jacques le fataliste et son maître</xxf:control>
                        <xxf:control id="author-control·2" label="Author" required="true">Denis Diderot</xxf:control>
                        <xxf:control id="title-control·3" label="Title" required="true">Childhood's End</xxf:control>
                        <xxf:control id="author-control·3" label="Author" required="true">Arthur C. Clarke</xxf:control>
                    </xxf:control-values>
                </xxf:action>
            </xxf:event-response>
        </output>
    </test>

    <test description="position() function within repeat" name="oxf:pipeline">
        <input name="config">
            <p:config xmlns:oxf="http://www.orbeon.com/oxf/processors" xmlns:xxforms="http://orbeon.org/oxf/xml/xforms">
                <p:param name="response" type="output"/>

                <p:processor name="oxf:pipeline">
                    <p:input name="config" href="wrap-xforms-state.xpl"/>
                    <p:input name="document">
                        <xhtml:html>
                            <xhtml:head>
                                <xforms:model>
                                    <xforms:instance id="cities-instance" xxforms:readonly="true">
                                        <cities>
                                            <city>San Francisco</city>
                                            <city>Los Angeles</city>
                                            <city>San Diego</city>
                                        </cities>
                                    </xforms:instance>
                                </xforms:model>
                            </xhtml:head>
                            <xhtml:body>
                                <xforms:repeat nodeset="city" id="city-repeat">
                                    <xforms:input id="my-input" ref=".">
                                        <xforms:label>City: </xforms:label>
                                    </xforms:input>
                                    <xforms:output id="my-output" value="position()">
                                        <xforms:label>Position: </xforms:label>
                                    </xforms:output>
                                </xforms:repeat>
                            </xhtml:body>
                        </xhtml:html>
                    </p:input>
                    <p:output name="response" ref="response"/>
                </p:processor>

            </p:config>
        </input>
        <output name="response">
            <xxf:event-response xmlns:xxf="http://orbeon.org/oxf/xml/xforms">
                <xxf:dynamic-state>
                    <dynamic-state>
                        <instances/>
                        <controls>
                            <control effective-id="city-repeat" index="1"/>
                        </controls>
                    </dynamic-state>
                </xxf:dynamic-state>
                <xxf:action>
                    <xxf:control-values>
                        <xxf:control id="my-input·1" label="City: " readonly="true">San Francisco</xxf:control>
                        <xxf:control id="my-output·1" label="Position: ">1</xxf:control>
                        <xxf:control id="my-input·2" label="City: " readonly="true">Los Angeles</xxf:control>
                        <xxf:control id="my-output·2" label="Position: ">2</xxf:control>
                        <xxf:control id="my-input·3" label="City: " readonly="true">San Diego</xxf:control>
                        <xxf:control id="my-output·3" label="Position: ">3</xxf:control>
                    </xxf:control-values>
                </xxf:action>
            </xxf:event-response>
        </output>
    </test>

    <test description="UI events upon repeat update" name="oxf:pipeline">
        <input name="config">
            <p:config xmlns:oxf="http://www.orbeon.com/oxf/processors" xmlns:xxforms="http://orbeon.org/oxf/xml/xforms">
                <p:param name="response" type="output"/>

                <p:processor name="oxf:pipeline">
                    <p:input name="config" href="wrap-xforms-state.xpl"/>
                    <p:input name="document">
                        <xhtml:html>
                            <xhtml:head>
                                <xhtml:title>UI events upon insert</xhtml:title>
                                <xforms:model xxforms:server.events.initial-refresh-events="true">

                                    <!-- Insert new iteration -->
                                    <xforms:insert ev:event="xforms-ready"
                                        nodeset="*" at="1" position="after" origin="instance('fruit-template')"/>

                                    <xforms:instance id="fruits">
                                        <fruits>
                                            <orange>bloody</orange>
                                            <apple>green</apple>
                                        </fruits>
                                    </xforms:instance>

                                    <xforms:instance id="fruit-template">
                                        <pear>yellow</pear>
                                    </xforms:instance>

                                    <xforms:instance id="events">
                                        <events/>
                                    </xforms:instance>
                                </xforms:model>
                            </xhtml:head>
                            <xhtml:body>
                                <xforms:repeat nodeset="*" id="my-repeat">
                                    <xforms:insert ev:event="xforms-value-changed xforms-enabled xforms-disabled xforms-required xforms-optional xforms-valid xforms-invalid xforms-readonly xforms-readwrite"
                                                   context="instance('events')" nodeset="*"
                                                   origin="xxforms:element('event',
                                                            (xxforms:attribute('type', event('xxforms:type')),
                                                             xxforms:attribute('target', event('xxforms:targetid')),
                                                             xxforms:attribute('indexes', string-join(event('xxforms:repeat-indexes'), ' '))))"/>
                                    <xforms:input ref="." id="my-input"/>
                                </xforms:repeat>
                            </xhtml:body>
                        </xhtml:html>
                    </p:input>
                    <p:output name="response" ref="response"/>
                </p:processor>

            </p:config>
        </input>
        <output name="response">
            <xxf:event-response xmlns:xxf="http://orbeon.org/oxf/xml/xforms">
                <xxf:dynamic-state>
                    <dynamic-state>
                        <instances>
                            <instance id="fruits" model-id="xf-2">
                                <fruits>
                                    <orange>bloody</orange>
                                    <pear>yellow</pear>
                                    <apple>green</apple>
                                </fruits>
                            </instance>
                            <instance id="fruit-template" model-id="xf-2">
                                <pear>yellow</pear>
                            </instance>
                            <instance id="events" model-id="xf-2">
                                <events>
                                    <event type="xforms-enabled" target="my-repeat" indexes=""/>
                                    <event type="xforms-enabled" target="my-input" indexes="1"/>
                                    <event type="xforms-enabled" target="my-input" indexes="2"/>
                                    <event type="xforms-enabled" target="my-input" indexes="2"/>
                                </events>
                            </instance>
                        </instances>
                        <controls>
                            <control effective-id="my-repeat" index="2"/>
                        </controls>
                    </dynamic-state>
                </xxf:dynamic-state>
                <xxf:action>
                    <xxf:control-values>
                        <xxf:control id="my-input·1">bloody</xxf:control>
                        <xxf:control id="my-input·2">yellow</xxf:control>
                        <xxf:control id="my-input·3">green</xxf:control>
                    </xxf:control-values>
                </xxf:action>
            </xxf:event-response>
        </output>
    </test>

    <test description="Repeat iteration relevance" name="oxf:pipeline">
        <input name="config">
            <p:config xmlns:oxf="http://www.orbeon.com/oxf/processors" xmlns:xxforms="http://orbeon.org/oxf/xml/xforms">
                <p:param name="response" type="output"/>

                <p:processor name="oxf:pipeline">
                    <p:input name="config" href="wrap-server.xpl"/>
                    <p:input name="action">
                        <xxforms:action>
                            <xxforms:event name="xxforms-value-change-with-focus-change" source-control-id="approvalStatus-input·2">bbb</xxforms:event>
                        </xxforms:action>
                    </p:input>
                    <p:input name="controls">
                        <controls>
                            <xforms:group ref="authorizations" id="authorization-group">
                                <xforms:repeat nodeset="authorization" id="authorization-repeat">
                                    <xforms:input ref="approvalStatus" id="approvalStatus-input"><xforms:label>Approval Status:</xforms:label></xforms:input>
                                    <xforms:repeat nodeset="conditions/condition" id="condition-repeat">
                                        <xforms:textarea ref="description" id="description-textarea"><xforms:label>Condition:</xforms:label></xforms:textarea>
                                    </xforms:repeat>
                                </xforms:repeat>
                            </xforms:group>
                        </controls>
                    </p:input>
                    <p:input name="models">
                        <models>
                            <xforms:model id="main-model">
                                <xforms:instance id="main-instance">
                                    <tea xmlns="">
                                        <authorizations>
                                            <authorization>
                                                <approvalStatus>aaa</approvalStatus>
                                                <conditions>
                                                    <condition>
                                                        <description/>
                                                        <resolution/>
                                                    </condition>
                                                    <condition>
                                                        <description/>
                                                        <resolution/>
                                                    </condition>
                                                </conditions>
                                            </authorization>
                                            <authorization>
                                                <approvalStatus/>
                                                <conditions>
                                                    <condition>
                                                        <description/>
                                                        <resolution/>
                                                    </condition>
                                                    <condition>
                                                        <description/>
                                                        <resolution/>
                                                    </condition>
                                                </conditions>
                                            </authorization>
                                        </authorizations>
                                    </tea>
                                </xforms:instance>

                                <xforms:bind id="bind1" nodeset="authorizations/authorization/conditions" relevant="../approvalStatus ne ''"/>

                            </xforms:model>
                        </models>
                    </p:input>
                    <p:input name="instances">
                        <instances>
                            <instance model-id="main-model" id="main-instance">
                                <tea xmlns="">
                                    <authorizations>
                                        <authorization>
                                            <approvalStatus>aaa</approvalStatus>
                                            <conditions>
                                                <condition>
                                                    <description/>
                                                    <resolution/>
                                                </condition>
                                                <condition>
                                                    <description/>
                                                    <resolution/>
                                                </condition>
                                            </conditions>
                                        </authorization>
                                        <authorization>
                                            <approvalStatus/>
                                            <conditions>
                                                <condition>
                                                    <description/>
                                                    <resolution/>
                                                </condition>
                                                <condition>
                                                    <description/>
                                                    <resolution/>
                                                </condition>
                                            </conditions>
                                        </authorization>
                                    </authorizations>
                                </tea>
                            </instance>
                        </instances>
                    </p:input>
                    <p:output name="response" ref="response"/>
                </p:processor>
            </p:config>
        </input>
        <output name="response">
            <xxf:event-response xmlns:xxf="http://orbeon.org/oxf/xml/xforms">
                <xxf:dynamic-state>
                    <dynamic-state>
                        <instances>
                            <instance id="main-instance" model-id="main-model">
                                <tea>
                                    <authorizations>
                                        <authorization>
                                            <approvalStatus>aaa</approvalStatus>
                                            <conditions>
                                                <condition>
                                                    <description/>
                                                    <resolution/>
                                                </condition>
                                                <condition>
                                                    <description/>
                                                    <resolution/>
                                                </condition>
                                            </conditions>
                                        </authorization>
                                        <authorization>
                                            <approvalStatus>bbb</approvalStatus>
                                            <conditions>
                                                <condition>
                                                    <description/>
                                                    <resolution/>
                                                </condition>
                                                <condition>
                                                    <description/>
                                                    <resolution/>
                                                </condition>
                                            </conditions>
                                        </authorization>
                                    </authorizations>
                                </tea>
                            </instance>
                        </instances>
                        <controls>
                            <control effective-id="authorization-repeat" index="2"/>
                            <control effective-id="condition-repeat·1" index="1"/>
                            <control effective-id="condition-repeat·2" index="1"/>
                        </controls>
                    </dynamic-state>
                </xxf:dynamic-state>
                <xxf:action>
                    <xxf:control-values>
                        <xxf:control id="approvalStatus-input·2">bbb</xxf:control>
                        <xxf:repeat-iteration id="condition-repeat·2" relevant="true" iteration="1"/>
                        <xxf:control id="description-textarea·2-1" label="Condition:" relevant="true"/>
                        <xxf:repeat-iteration id="condition-repeat·2" relevant="true" iteration="2"/>
                        <xxf:control id="description-textarea·2-2" label="Condition:" relevant="true"/>
                    </xxf:control-values>
                    <xxf:repeat-indexes>
                        <xxf:repeat-index id="authorization-repeat" old-index="0" new-index="2"/>
                        <xxf:repeat-index id="condition-repeat" old-index="0" new-index="1"/>
                    </xxf:repeat-indexes>
                </xxf:action>
            </xxf:event-response>
        </output>
    </test>

    <test description="Simple master-detail repeat initialization" name="oxf:pipeline">
        <input name="config">
            <p:config xmlns:oxf="http://www.orbeon.com/oxf/processors" xmlns:xxforms="http://orbeon.org/oxf/xml/xforms">
                <p:param name="response" type="output"/>

                <p:processor name="oxf:pipeline">
                    <p:input name="config" href="wrap-xforms-state.xpl"/>
                    <p:input name="document">
                        <xhtml:html>
                            <xhtml:head>
                                <xforms:model id="model">
                                    <xforms:instance id="instance">
                                        <oranges>
                                            <orange><type>Persian</type><id>1</id></orange>
                                            <orange><type>Navel</type><id>2</id></orange>
                                        </oranges>
                                    </xforms:instance>
                                </xforms:model>
                            </xhtml:head>
                            <xhtml:body>

                                <xforms:repeat nodeset="orange" id="orange-repeat">
                                    <xforms:output ref="type" id="orange-repeat-output">
                                        <xforms:label>Orange type:</xforms:label>
                                    </xforms:output>
                                </xforms:repeat>

                                <!-- This is the key of this test: index() here must return 1, not 0 -->
                                <xforms:group ref="orange[index('orange-repeat')]" id="my-group">
                                    <xforms:input ref="type" id="detail-type">
                                        <xforms:label>Orange type:</xforms:label>
                                    </xforms:input>
                                    <xforms:input ref="id" id="detail-id">
                                        <xforms:label>Orange id:</xforms:label>
                                    </xforms:input>
                                </xforms:group>
                            </xhtml:body>

                        </xhtml:html>
                    </p:input>
                    <p:output name="response" ref="response"/>
                </p:processor>

            </p:config>
        </input>
        <output name="response">
            <xxf:event-response xmlns:xxf="http://orbeon.org/oxf/xml/xforms">
                <xxf:dynamic-state>
                    <dynamic-state>
                        <instances>
                            <instance id="instance" model-id="model">
                                <oranges>
                                    <orange>
                                        <type>Persian</type>
                                        <id>1</id>
                                    </orange>
                                    <orange>
                                        <type>Navel</type>
                                        <id>2</id>
                                    </orange>
                                </oranges>
                            </instance>
                        </instances>
                        <controls>
                            <control effective-id="orange-repeat" index="1"/>
                        </controls>
                    </dynamic-state>
                </xxf:dynamic-state>
                <xxf:action>
                    <xxf:control-values>
                        <xxf:control id="orange-repeat-output·1" label="Orange type:">Persian</xxf:control>
                        <xxf:control id="orange-repeat-output·2" label="Orange type:">Navel</xxf:control>
                        <xxf:control id="detail-type" label="Orange type:">Persian</xxf:control>
                        <xxf:control id="detail-id" label="Orange id:">1</xxf:control>
                    </xxf:control-values>
                </xxf:action>
            </xxf:event-response>
        </output>
    </test>

    <test description="Repeat iterations updating only at time of refresh" name="oxf:pipeline">
        <input name="config">
            <p:config xmlns:oxf="http://www.orbeon.com/oxf/processors" xmlns:xxforms="http://orbeon.org/oxf/xml/xforms">
                <p:param name="response" type="output"/>

                <p:processor name="oxf:pipeline">
                    <p:input name="config" href="wrap-xforms-state.xpl"/>
                    <p:input name="document">
                        <xhtml:html>
                            <xhtml:head>
                                <xforms:model>
                                    <xforms:instance id="books-instance">
                                        <books/>
                                    </xforms:instance>
                                    <xforms:instance id="templates">
                                        <book xmlns="">
                                            <title/>
                                            <author/>
                                        </book>
                                    </xforms:instance>

                                    <xforms:action ev:event="xforms-ready">
                                        <xforms:insert context="." nodeset="book" origin="instance('templates')"/>
                                        <xforms:setvalue ref="book[last()]/title" value="'T3'"/>
                                        <xforms:setvalue ref="book[last()]/author" value="'A3'"/>
                                    </xforms:action>

                                </xforms:model>
                            </xhtml:head>
                            <xhtml:body>
                                <xforms:group ref=".[exists(book)]" id="my-group">
                                <!--<xforms:group ref=".">-->
                                    <xforms:repeat nodeset="book" id="my-repeat">
                                        <xforms:output value="title" id="my-title"/>
                                        <xforms:output value="author" id="my-author"/>
                                    </xforms:repeat>
                                </xforms:group>
                            </xhtml:body>
                        </xhtml:html>
                    </p:input>
                    <p:output name="response" ref="response"/>
                </p:processor>

            </p:config>
        </input>
        <output name="response">
            <xxf:event-response xmlns:xxf="http://orbeon.org/oxf/xml/xforms">
                <xxf:dynamic-state>
                    <dynamic-state>
                        <instances>
                            <instance id="books-instance" model-id="xf-1">
                                <books>
                                    <book>
                                        <title>T3</title>
                                        <author>A3</author>
                                    </book>
                                </books>
                            </instance>
                            <instance id="templates" model-id="xf-1">
                                <book>
                                    <title/>
                                    <author/>
                                </book>
                            </instance>
                        </instances>
                        <controls>
                            <control effective-id="my-repeat" index="1"/>
                        </controls>
                    </dynamic-state>
                </xxf:dynamic-state>
                <xxf:action>
                    <xxf:control-values>
                        <xxf:control id="my-title·1">T3</xxf:control>
                        <xxf:control id="my-author·1">A3</xxf:control>
                    </xxf:control-values>
                </xxf:action>
            </xxf:event-response>
        </output>
    </test>

    <test description="Dispatch events to all iterations of repeated controls" name="oxf:pipeline">
        <input name="config">
            <p:config xmlns:oxf="http://www.orbeon.com/oxf/processors" xmlns:xxforms="http://orbeon.org/oxf/xml/xforms">
                <p:param name="response" type="output"/>

                <p:processor name="oxf:pipeline">
                    <p:input name="config" href="wrap-xforms-state.xpl"/>
                    <p:input name="document">
                        <xhtml:html>
                            <xhtml:head>
                                <xforms:model id="model">
                                    <xforms:instance xmlns="" id="instance">
                                        <values>
                                            <value/>
                                            <value/>
                                            <value/>
                                            <value/>
                                        </values>
                                    </xforms:instance>
                                    <xforms:action ev:event="xforms-ready">
                                        <!-- Set initial index -->
                                        <xforms:setindex repeat="my-repeat" index="3"/>
                                        <!-- Save current index -->
                                        <xxforms:variable name="initial-index" select="index('my-repeat')"/>
                                        <!-- Iterate through all values -->
                                        <xforms:action xxforms:iterate="value">
                                            <!-- Set index and dispatch event -->
                                            <xforms:setindex repeat="my-repeat" index="count(preceding-sibling::*) + 1"/>
                                            <xforms:dispatch name="my-event" targetid="my-input"/>
                                        </xforms:action>
                                        <!-- Restore index -->
                                        <xforms:setindex repeat="my-repeat" index="$initial-index"/>
                                    </xforms:action>
                                </xforms:model>
                            </xhtml:head>
                            <xhtml:body>
                                <!-- Iterate over all the values -->
                                <xforms:repeat nodeset="value" id="my-repeat">
                                    <xforms:input id="my-input" ref=".">
                                        <!-- Upon receiving event "my-event", set the value of the control -->
                                        <xforms:setvalue ev:event="my-event" ref="." value="count(preceding-sibling::*) + 1"/>
                                    </xforms:input>
                                </xforms:repeat>
                            </xhtml:body>
                        </xhtml:html>
                    </p:input>
                    <p:output name="response" ref="response"/>
                </p:processor>

            </p:config>
        </input>
        <output name="response">
            <xxf:event-response xmlns:xxf="http://orbeon.org/oxf/xml/xforms">
                <xxf:dynamic-state>
                    <dynamic-state>
                        <instances>
                            <instance id="instance" model-id="model">
                                <values>
                                    <value>1</value>
                                    <value>2</value>
                                    <value>3</value>
                                    <value>4</value>
                                </values>
                            </instance>
                        </instances>
                        <controls>
                            <control effective-id="my-repeat" index="3"/>
                        </controls>
                    </dynamic-state>
                </xxf:dynamic-state>
                <xxf:action>
                    <xxf:control-values>
                        <xxf:control id="my-input·1">1</xxf:control>
                        <xxf:control id="my-input·2">2</xxf:control>
                        <xxf:control id="my-input·3">3</xxf:control>
                        <xxf:control id="my-input·4">4</xxf:control>
                    </xxf:control-values>
                </xxf:action>
            </xxf:event-response>
        </output>
    </test>

    <test description="xxforms-nodeset-changed event" name="oxf:pipeline">
        <input name="config">
            <p:config xmlns:oxf="http://www.orbeon.com/oxf/processors" xmlns:xxforms="http://orbeon.org/oxf/xml/xforms">
                <p:param name="response" type="output"/>

                <p:processor name="oxf:pipeline">
                    <p:input name="config" href="wrap-xforms-state.xpl"/>
                    <p:input name="document">
                        <xhtml:html>
                            <xhtml:head>
                                <xforms:model id="model">
                                    <xforms:instance xmlns="" id="instance">
                                        <values order="ascending">
                                            <value>1</value>
                                            <value>2</value>
                                            <value>3</value>
                                            <value>4</value>
                                        </values>
                                    </xforms:instance>
                                    <xforms:instance xmlns="" id="changes">
                                        <changes/>
                                    </xforms:instance>

                                    <xforms:action ev:event="xforms-ready">
                                        <!-- Insert a node: this will immediately cause a repeat nodeset change -->
                                        <xforms:insert nodeset="value" origin="xxforms:element('value', count(../value) + 1)"/>
                                        <!-- Delete a node: this will immediately cause a repeat nodeset change  -->
                                        <xforms:delete nodeset="value[1]"/>
                                        <!-- Change repeat nodeset order without changing instance: this will cause change during refresh -->
                                        <xforms:setvalue ref="@order">descending</xforms:setvalue>
                                        <xforms:refresh/>
                                        <!-- Remove all items ("going to 0" condition) must not dispatch event -->
                                        <xforms:delete nodeset="value"/>
                                        <!-- Insert a new item ("going from 0" condition) must not dispatch event  -->
                                        <xforms:insert context="." nodeset="value" origin="xxforms:element('value', 1)"/>
                                    </xforms:action>

                                </xforms:model>
                            </xhtml:head>
                            <xhtml:body>
                                <xforms:group id="my-group">
                                    <xforms:action ev:event="xxforms-nodeset-changed" ev:target="my-repeat">
                                        <xforms:insert context="instance('changes')" nodeset="*" origin="xxforms:element('change', count(instance('instance')/value))"/>
                                    </xforms:action>
                                    <xforms:repeat nodeset="xxforms:sort(value, string(.), 'text', @order)" id="my-repeat">
                                        <xforms:output id="my-output" value="."/>
                                    </xforms:repeat>
                                </xforms:group>
                            </xhtml:body>
                        </xhtml:html>
                    </p:input>
                    <p:output name="response" ref="response"/>
                </p:processor>

            </p:config>
        </input>
        <output name="response">
            <xxf:event-response xmlns:xxf="http://orbeon.org/oxf/xml/xforms">
                <xxf:dynamic-state>
                    <dynamic-state>
                        <instances>
                            <instance id="instance" model-id="model">
                                <values order="descending">
                                    <value>1</value>
                                </values>
                            </instance>
                            <instance id="changes" model-id="model">
                                <changes>
                                    <change>5</change>
                                    <change>4</change>
                                    <change>4</change>
                                </changes>
                            </instance>
                        </instances>
                        <controls>
                            <control effective-id="my-repeat" index="1"/>
                        </controls>
                    </dynamic-state>
                </xxf:dynamic-state>
                <xxf:action>
                    <xxf:control-values>
                        <xxf:control id="my-output·1">1</xxf:control>
                    </xxf:control-values>
                </xxf:action>
            </xxf:event-response>
        </output>
    </test>

    <test description="No dispatch of xxforms-nodeset-changed upon control becoming relevant" name="oxf:pipeline">
        <input name="config">
            <p:config xmlns:oxf="http://www.orbeon.com/oxf/processors" xmlns:xxforms="http://orbeon.org/oxf/xml/xforms">
                <p:param name="response" type="output"/>

                <p:processor name="oxf:pipeline">
                    <p:input name="config" href="wrap-xforms-state.xpl"/>
                    <p:input name="document">
                        <xhtml:html>
                            <xhtml:head>
                                <xforms:model id="model">
                                    <xforms:instance xmlns="" id="instance">
                                        <values show="false">
                                            <value>1</value>
                                            <value>2</value>
                                            <value>3</value>
                                            <value>4</value>
                                        </values>
                                    </xforms:instance>
                                    <xforms:instance xmlns="" id="changes">
                                        <changes/>
                                    </xforms:instance>

                                    <xforms:action ev:event="xforms-ready">
                                        <xforms:insert context="instance('changes')" nodeset="*" origin="xxforms:element('before-refresh')"/>
                                        <xforms:refresh/>
                                        <xforms:insert context="instance('changes')" nodeset="*" origin="xxforms:element('after-refresh')"/>
                                        <!-- Cause the group and its content to become relevant upon next refresh -->
                                        <xforms:setvalue ref="@show">true</xforms:setvalue>
                                        <xforms:insert context="instance('changes')" nodeset="*" origin="xxforms:element('before-refresh')"/>
                                        <xforms:refresh/>
                                        <xforms:insert context="instance('changes')" nodeset="*" origin="xxforms:element('after-refresh')"/>
                                        <!-- Cause the group and its content to become non-relevant upon next refresh -->
                                        <xforms:setvalue ref="@show">false</xforms:setvalue>
                                        <xforms:insert context="instance('changes')" nodeset="*" origin="xxforms:element('before-refresh')"/>
                                        <xforms:refresh/>
                                        <xforms:insert context="instance('changes')" nodeset="*" origin="xxforms:element('after-refresh')"/>
                                    </xforms:action>

                                </xforms:model>
                            </xhtml:head>
                            <xhtml:body>

                                <xforms:action ev:event="xforms-enabled xforms-disabled xxforms-nodeset-changed xxforms-index-changed">
                                    <xforms:insert context="instance('changes')" nodeset="*"
                                                   origin="xxforms:element(event('xxforms:type'), xxforms:attribute('id', event('xxforms:target')))"/>
                                </xforms:action>

                                <xforms:group id="my-group" ref=".[@show = 'true']">
                                    <xforms:repeat nodeset="value" id="my-repeat"/>
                                </xforms:group>
                            </xhtml:body>
                        </xhtml:html>
                    </p:input>
                    <p:output name="response" ref="response"/>
                </p:processor>

            </p:config>
        </input>
        <output name="response">
            <xxf:event-response xmlns:xxf="http://orbeon.org/oxf/xml/xforms">
                <xxf:dynamic-state>
                    <dynamic-state>
                        <instances>
                            <instance id="instance" model-id="model">
                                <values show="false">
                                    <value>1</value>
                                    <value>2</value>
                                    <value>3</value>
                                    <value>4</value>
                                </values>
                            </instance>
                            <instance id="changes" model-id="model">
                                <changes>
                                    <before-refresh/>
                                    <after-refresh/>
                                    <before-refresh/>
                                    <xforms-enabled id="my-group"/>
                                    <xforms-enabled id="my-repeat"/>
                                    <after-refresh/>
                                    <before-refresh/>
                                    <xforms-disabled id="my-group"/>
                                    <xforms-disabled id="my-repeat"/>
                                    <after-refresh/>
                                </changes>
                            </instance>
                        </instances>
                    </dynamic-state>
                </xxf:dynamic-state>
                <xxf:action>
                    <xxf:control-values>
                        <xxf:control id="my-group" relevant="false"/>
                    </xxf:control-values>
                </xxf:action>
            </xxf:event-response>
        </output>
    </test>

    <test description="Simple event dispatch to nested repeats following correct id resolution" name="oxf:pipeline">
        <input name="config" href="wrap-xforms-state.xpl"/>
        <input name="document">
            <xhtml:html xmlns:xxforms="http://orbeon.org/oxf/xml/xforms">
                <xhtml:head>
                    <xforms:model id="model">
                        <xforms:instance id="instance">
                            <instance>
                                <outer>
                                    <value/>
                                    <inner>
                                        <value/>
                                    </inner>
                                    <inner>
                                        <value/>
                                    </inner>
                                </outer>
                            </instance>
                        </xforms:instance>

                        <!-- TEST: Events to gather -->
                        <xforms:instance id="events">
                            <events/>
                        </xforms:instance>

                        <xforms:action ev:event="xforms-ready">
                            <xforms:dispatch name="my-event-1" targetid="my-outer-input" xxforms:repeat-indexes="1"/>
                        </xforms:action>

                    </xforms:model>
                </xhtml:head>
                <xhtml:body>
                    <xforms:group id="my-group">
                        <!-- TEST: Gather events. Insert on capture phase so we have sensible order -->
                        <xforms:insert ev:event="my-event-1 my-event-2 my-event-3 my-event-4" ev:phase="capture"
                                       context="instance('events')" nodeset="*"
                                       origin="xxforms:element('event',
                                                (xxforms:attribute('type', event('xxforms:type')),
                                                 xxforms:attribute('target', event('xxforms:targetid')),
                                                 xxforms:attribute('indexes', string-join(event('xxforms:repeat-indexes'), ' '))))"/>

                        <!-- Outer repeat -->
                        <xforms:repeat id="my-outer-repeat" nodeset="outer">
                            <!-- This receives the event on xforms-ready -->
                            <xforms:input id="my-outer-input" ref="value">
                                <xforms:action ev:event="my-event-1">
                                    <!-- Dispatch to inner control following indexes -->
                                    <xforms:dispatch name="my-event-2" targetid="my-inner-output"/>
                                    <!-- Move inner index -->
                                    <xforms:setindex repeat="my-inner-repeat" index="2"/>
                                    <!-- Event must reach new index -->
                                    <xforms:dispatch name="my-event-2" targetid="my-inner-output"/>
                                    <!-- Dispatch to next control -->
                                    <xforms:dispatch name="my-event-3" targetid="my-outer-output"/>
                                </xforms:action>
                            </xforms:input>
                            <xforms:output id="my-outer-output" ref="value"/>

                            <!-- Inner repeat -->
                            <xforms:repeat id="my-inner-repeat" nodeset="inner">
                                <xforms:input id="my-inner-input" ref="value"/>
                                <xforms:output id="my-inner-output" ref="value"/>
                            </xforms:repeat>
                        </xforms:repeat>
                    </xforms:group>
                </xhtml:body>
            </xhtml:html>
        </input>
        <output name="response">
            <xxf:event-response xmlns:xxf="http://orbeon.org/oxf/xml/xforms">
                <xxf:dynamic-state>
                    <dynamic-state>
                        <instances>
                            <instance id="instance" model-id="model">
                                <instance>
                                    <outer>
                                        <value/>
                                        <inner>
                                            <value/>
                                        </inner>
                                        <inner>
                                            <value/>
                                        </inner>
                                    </outer>
                                </instance>
                            </instance>
                            <instance id="events" model-id="model">
                                <events>
                                    <event type="my-event-1" target="my-outer-input" indexes="1"/>
                                    <event type="my-event-2" target="my-inner-output" indexes="1 1"/>
                                    <event type="my-event-2" target="my-inner-output" indexes="1 2"/>
                                    <event type="my-event-3" target="my-outer-output" indexes="1"/>
                                </events>
                            </instance>
                        </instances>
                        <controls>
                            <control effective-id="my-outer-repeat" index="1"/>
                            <control effective-id="my-inner-repeat·1" index="2"/>
                        </controls>
                    </dynamic-state>
                </xxf:dynamic-state>
                <xxf:action>
                    <xxf:control-values/>
                </xxf:action>
            </xxf:event-response>
        </output>
    </test>

    <test description="Complex dispatch to nested repeats following correct id resolution" name="oxf:pipeline">
        <input name="config" href="wrap-xforms-state.xpl"/>
        <input name="document">
            <xhtml:html xmlns:xxforms="http://orbeon.org/oxf/xml/xforms">
                <xhtml:head>
                    <xforms:model id="model">
                        <xforms:instance id="instance">
                            <instance>
                                <value/>
                                <outer>
                                    <value/>
                                    <inner>
                                        <value/>
                                    </inner>
                                    <inner>
                                        <value/>
                                    </inner>
                                </outer>
                                <outer><!-- Event #2 reaches associated input -->
                                    <value/>
                                    <inner>
                                        <value/>
                                    </inner>
                                    <inner>
                                        <value/>
                                    </inner>
                                </outer>
                                <outer>
                                    <value/>
                                    <inner>
                                        <value/>
                                    </inner>
                                    <inner><!-- Event #1 reaches associated input -->
                                        <value/>
                                    </inner>
                                    <inner>
                                        <value/>
                                    </inner>
                                </outer>
                            </instance>
                        </xforms:instance>

                        <!-- TEST: Events to gather -->
                        <xforms:instance id="events">
                            <events/>
                        </xforms:instance>

                        <xforms:action ev:event="xforms-ready">
                            <!-- Event #1 -->
                            <xforms:setindex repeat="my-inner-repeat" index="1"/>
                            <xforms:setindex repeat="my-outer-repeat" index="1"/>
                            <xforms:dispatch name="my-event-1" targetid="my-inner-input" xxforms:repeat-indexes="3 2"/>

                            <!-- Event #2 -->
                            <xforms:setindex repeat="my-inner-repeat" index="1"/>
                            <xforms:setindex repeat="my-outer-repeat" index="1"/>
                            <xforms:dispatch name="my-event-1" targetid="my-outer-input" xxforms:repeat-indexes="2"/>

                            <!-- Event #3 -->
                            <xforms:setindex repeat="my-inner-repeat" index="1"/>
                            <xforms:setindex repeat="my-outer-repeat" index="1"/>
                            <xforms:dispatch name="my-event-1" targetid="my-top-level-input"/>
                        </xforms:action>

                    </xforms:model>
                </xhtml:head>
                <xhtml:body>
                    <xforms:group id="my-group">
                        <!-- TEST: Gather events. Insert on capture phase so we have sensible order -->
                        <xforms:insert ev:event="my-event-1 my-event-2 my-event-3 my-event-4" ev:phase="capture"
                                       context="instance('events')" nodeset="*"
                                       origin="xxforms:element('event',
                                                (xxforms:attribute('type', event('xxforms:type')),
                                                 xxforms:attribute('target', event('xxforms:targetid')),
                                                 xxforms:attribute('indexes', string-join(event('xxforms:repeat-indexes'), ' '))))"/>

                        <!-- Top-level -->

                        <!-- This receives event #3 -->
                        <xforms:input id="my-top-level-input" ref="value">
                            <xforms:action ev:event="my-event-1">
                                <!-- Dispatch to inner control following indexes -->
                                <xforms:dispatch name="my-event-2" targetid="my-inner-output"/>
                                <!-- Move inner index -->
                                <xforms:setindex repeat="my-inner-repeat" index="2"/>
                                <!-- Event must reach new index -->
                                <xforms:dispatch name="my-event-2" targetid="my-inner-output"/>
                                <!-- Dispatch to outer control following indexes -->
                                <xforms:dispatch name="my-event-3" targetid="my-outer-output"/>
                                <!-- Move outer index  -->
                                <xforms:setindex repeat="my-outer-repeat" index="3"/>
                                <!-- Event must reach new index -->
                                <xforms:dispatch name="my-event-3" targetid="my-outer-output"/>
                                <!-- Dispatch to top-level -->
                                <xforms:dispatch name="my-event-4" targetid="my-top-level-output"/>
                            </xforms:action>
                        </xforms:input>
                        <xforms:output id="my-top-level-output" ref="value"/>

                        <!-- Outer repeat -->
                        <xforms:repeat id="my-outer-repeat" nodeset="outer">
                            <!-- This receives event #2 -->
                            <xforms:input id="my-outer-input" ref="value">
                                <xforms:action ev:event="my-event-1">
                                    <!-- Dispatch to inner control following indexes -->
                                    <xforms:dispatch name="my-event-2" targetid="my-inner-output"/>
                                    <!-- Move inner index -->
                                    <xforms:setindex repeat="my-inner-repeat" index="2"/>
                                    <!-- Event must reach new index -->
                                    <xforms:dispatch name="my-event-2" targetid="my-inner-output"/>
                                    <!-- Dispatch to next control -->
                                    <xforms:dispatch name="my-event-3" targetid="my-outer-output"/>
                                    <!-- Move outer index  -->
                                    <xforms:setindex repeat="my-outer-repeat" index="3"/>
                                    <!-- Even though the index moved, event must reach the same outer control -->
                                    <xforms:dispatch name="my-event-3" targetid="my-outer-output"/>
                                    <!-- Dispatch to top-level -->
                                    <xforms:dispatch name="my-event-4" targetid="my-top-level-output"/>
                                </xforms:action>
                            </xforms:input>
                            <xforms:output id="my-outer-output" ref="value"/>

                            <!-- Inner repeat -->
                            <xforms:repeat id="my-inner-repeat" nodeset="inner">
                                <!-- This receives event #1 -->
                                <xforms:input id="my-inner-input" ref="value">
                                    <xforms:action ev:event="my-event-1">
                                        <!-- Dispatch to next control -->
                                        <xforms:dispatch name="my-event-2" targetid="my-inner-output"/>
                                        <!-- Move inner index -->
                                        <xforms:setindex repeat="my-inner-repeat" index="2"/>
                                        <!-- Even though the index moved, event must reach the same inner control -->
                                        <xforms:dispatch name="my-event-2" targetid="my-inner-output"/>
                                        <!-- Dispatch to outer -->
                                        <xforms:dispatch name="my-event-3" targetid="my-outer-output"/>
                                        <!-- Move outer index  -->
                                        <xforms:setindex repeat="my-outer-repeat" index="2"/>
                                        <!-- Even though the index moved, event must reach the same outer control -->
                                        <xforms:dispatch name="my-event-3" targetid="my-outer-output"/>
                                        <!-- Dispatch to top-level -->
                                        <xforms:dispatch name="my-event-4" targetid="my-top-level-output"/>
                                    </xforms:action>
                                </xforms:input>
                                <xforms:output id="my-inner-output" ref="value"/>
                            </xforms:repeat>
                        </xforms:repeat>
                    </xforms:group>
                </xhtml:body>
            </xhtml:html>
        </input>
        <output name="response">
            <xxf:event-response xmlns:xxf="http://orbeon.org/oxf/xml/xforms">
                <xxf:dynamic-state>
                    <dynamic-state>
                        <instances>
                            <instance id="instance" model-id="model">
                                <instance>
                                    <value/>
                                    <outer>
                                        <value/>
                                        <inner>
                                            <value/>
                                        </inner>
                                        <inner>
                                            <value/>
                                        </inner>
                                    </outer>
                                    <outer>
                                        <!-- Event #2 reaches associated input -->
                                        <value/>
                                        <inner>
                                            <value/>
                                        </inner>
                                        <inner>
                                            <value/>
                                        </inner>
                                    </outer>
                                    <outer>
                                        <value/>
                                        <inner>
                                            <value/>
                                        </inner>
                                        <inner>
                                            <!-- Event #1 reaches associated input -->
                                            <value/>
                                        </inner>
                                        <inner>
                                            <value/>
                                        </inner>
                                    </outer>
                                </instance>
                            </instance>
                            <instance id="events" model-id="model">
                                <events>
                                    <event type="my-event-1" target="my-inner-input" indexes="3 2"/>
                                    <event type="my-event-2" target="my-inner-output" indexes="3 2"/>
                                    <event type="my-event-2" target="my-inner-output" indexes="3 2"/>
                                    <event type="my-event-3" target="my-outer-output" indexes="3"/>
                                    <event type="my-event-3" target="my-outer-output" indexes="3"/>
                                    <event type="my-event-4" target="my-top-level-output" indexes=""/>
                                    <event type="my-event-1" target="my-outer-input" indexes="2"/>
                                    <event type="my-event-2" target="my-inner-output" indexes="2 1"/>
                                    <event type="my-event-2" target="my-inner-output" indexes="2 2"/>
                                    <event type="my-event-3" target="my-outer-output" indexes="2"/>
                                    <event type="my-event-3" target="my-outer-output" indexes="2"/>
                                    <event type="my-event-4" target="my-top-level-output" indexes=""/>
                                    <event type="my-event-1" target="my-top-level-input" indexes=""/>
                                    <event type="my-event-2" target="my-inner-output" indexes="1 1"/>
                                    <event type="my-event-2" target="my-inner-output" indexes="1 2"/>
                                    <event type="my-event-3" target="my-outer-output" indexes="1"/>
                                    <event type="my-event-3" target="my-outer-output" indexes="3"/>
                                    <event type="my-event-4" target="my-top-level-output" indexes=""/>
                                </events>
                            </instance>
                        </instances>
                        <controls>
                            <control effective-id="my-outer-repeat" index="3"/>
                            <control effective-id="my-inner-repeat·1" index="2"/>
                            <control effective-id="my-inner-repeat·2" index="2"/>
                            <control effective-id="my-inner-repeat·3" index="1"/>
                        </controls>
                    </dynamic-state>
                </xxf:dynamic-state>
                <xxf:action>
                    <xxf:control-values/>
                </xxf:action>
            </xxf:event-response>
        </output>
    </test>

    <test description="xxforms:repeat-nodeset() function" name="oxf:pipeline">
        <input name="config" href="wrap-xforms-state.xpl"/>
        <input name="document">
            <xhtml:html xmlns:xxforms="http://orbeon.org/oxf/xml/xforms">
                <xhtml:head>
                    <xforms:model id="model">
                        <xforms:instance id="instance">
                            <company>
                                <department>
                                    <employee/>
                                    <employee/>
                                </department>
                                <department>
                                    <employee/>
                                </department>
                                <department>
                                    <employee/>
                                    <employee/>
                                    <employee/>
                                    <employee/>
                                </department>
                            </company>
                        </xforms:instance>
                    </xforms:model>
                </xhtml:head>
                <xhtml:body>
                    <xforms:repeat id="department-repeat" nodeset="department">
                        <xxforms:variable name="department-nodeset-1" select="xxforms:repeat-nodeset()" as="element*"/>
                        <xxforms:variable name="department-nodeset-2" select="xxforms:repeat-nodeset('department-repeat')" as="element*"/>
                        <xforms:output id="department-output-1" value="count($department-nodeset-1)"/>
                        <xforms:output id="department-output-2" value="count($department-nodeset-2)"/>
                        <xforms:repeat id="employee-repeat" nodeset="employee">
                            <xxforms:variable name="employee-nodeset-1" select="xxforms:repeat-nodeset()" as="element*"/>
                            <xxforms:variable name="employee-nodeset-2" select="xxforms:repeat-nodeset('employee-repeat')" as="element*"/>
                            <xforms:output id="employee-output-1" value="count($employee-nodeset-1)"/>
                            <xforms:output id="employee-output-2" value="count($employee-nodeset-2)"/>

                            <xxforms:variable name="department-nodeset-3" select="xxforms:repeat-nodeset('department-repeat')" as="element*"/>
                            <xforms:output id="department-output-3" value="count($department-nodeset-3)"/>

                            <!-- Make sure the function work from within an action as well -->
                            <xforms:action ev:event="xforms-enabled">
                                <xxforms:variable name="test-nodeset" select="xxforms:repeat-nodeset()"/>
                                <xforms:setvalue ref="." value="count($test-nodeset)"/>
                            </xforms:action>
                        </xforms:repeat>
                    </xforms:repeat>
                </xhtml:body>
            </xhtml:html>
        </input>
        <output name="response">
            <xxf:event-response xmlns:xxf="http://orbeon.org/oxf/xml/xforms">
                <xxf:dynamic-state>
                    <dynamic-state>
                        <instances>
                            <instance id="instance" model-id="model">
                                <company>
                                    <department>
                                        <employee>2</employee>
                                        <employee>2</employee>
                                    </department>
                                    <department>
                                        <employee>1</employee>
                                    </department>
                                    <department>
                                        <employee>4</employee>
                                        <employee>4</employee>
                                        <employee>4</employee>
                                        <employee>4</employee>
                                    </department>
                                </company>
                            </instance>
                        </instances>
                        <controls>
                            <control effective-id="department-repeat" index="1"/>
                            <control effective-id="employee-repeat·1" index="1"/>
                            <control effective-id="employee-repeat·2" index="1"/>
                            <control effective-id="employee-repeat·3" index="1"/>
                        </controls>
                    </dynamic-state>
                </xxf:dynamic-state>
                <xxf:action>
                    <xxf:control-values>
                        <xxf:control id="department-output-1·1">3</xxf:control>
                        <xxf:control id="department-output-2·1">3</xxf:control>
                        <xxf:control id="employee-output-1·1-1">2</xxf:control>
                        <xxf:control id="employee-output-2·1-1">2</xxf:control>
                        <xxf:control id="department-output-3·1-1">3</xxf:control>
                        <xxf:control id="employee-output-1·1-2">2</xxf:control>
                        <xxf:control id="employee-output-2·1-2">2</xxf:control>
                        <xxf:control id="department-output-3·1-2">3</xxf:control>
                        <xxf:control id="department-output-1·2">3</xxf:control>
                        <xxf:control id="department-output-2·2">3</xxf:control>
                        <xxf:control id="employee-output-1·2-1">1</xxf:control>
                        <xxf:control id="employee-output-2·2-1">1</xxf:control>
                        <xxf:control id="department-output-3·2-1">3</xxf:control>
                        <xxf:control id="department-output-1·3">3</xxf:control>
                        <xxf:control id="department-output-2·3">3</xxf:control>
                        <xxf:control id="employee-output-1·3-1">4</xxf:control>
                        <xxf:control id="employee-output-2·3-1">4</xxf:control>
                        <xxf:control id="department-output-3·3-1">3</xxf:control>
                        <xxf:control id="employee-output-1·3-2">4</xxf:control>
                        <xxf:control id="employee-output-2·3-2">4</xxf:control>
                        <xxf:control id="department-output-3·3-2">3</xxf:control>
                        <xxf:control id="employee-output-1·3-3">4</xxf:control>
                        <xxf:control id="employee-output-2·3-3">4</xxf:control>
                        <xxf:control id="department-output-3·3-3">3</xxf:control>
                        <xxf:control id="employee-output-1·3-4">4</xxf:control>
                        <xxf:control id="employee-output-2·3-4">4</xxf:control>
                        <xxf:control id="department-output-3·3-4">3</xxf:control>
                    </xxf:control-values>
                </xxf:action>
            </xxf:event-response>
        </output>
    </test>

    <test description="xxforms:index() function" name="oxf:pipeline">
        <input name="config" href="wrap-xforms-state.xpl"/>
        <input name="document">
            <xhtml:html xmlns:xxforms="http://orbeon.org/oxf/xml/xforms">
                <xhtml:head>
                    <xforms:model id="model">
                        <xforms:instance id="instance">
                            <company>
                                <department>
                                    <employee/>
                                    <employee/>
                                </department>
                                <department>
                                    <employee/>
                                </department>
                                <department>
                                    <employee/>
                                    <employee/>
                                    <employee/>
                                    <employee/>
                                </department>
                            </company>
                        </xforms:instance>
                    </xforms:model>
                    <xforms:model id="model2">
                        <xforms:instance id="instance2">
                            <form2/>
                        </xforms:instance>
                    </xforms:model>
                </xhtml:head>
                <xhtml:body>
                    <!-- Top-level variable with model change tests that source id for resolution doesn't break -->
                    <xxforms:variable name="top-level-1" model="model2" select="." as="element()"/>

                    <xforms:repeat id="department-repeat" nodeset="department" startindex="4">
                        <xxforms:variable name="department-index-1" select="xxforms:index()" as="element*"/>
                        <xxforms:variable name="department-index-2" select="xxforms:index('department-repeat')" as="element*"/>
                        <xforms:output id="department-output-1" value="$department-index-1"/>
                        <xforms:output id="department-output-2" value="$department-index-2"/>
                        <xforms:repeat id="employee-repeat" nodeset="employee" startindex="3">
                            <xxforms:variable name="employee-index-1" select="xxforms:index()" as="element*"/>
                            <xxforms:variable name="employee-index-2" select="xxforms:index('employee-repeat')" as="element*"/>
                            <xforms:output id="employee-output-1" value="$employee-index-1"/>
                            <xforms:output id="employee-output-2" value="$employee-index-2"/>

                            <xxforms:variable name="department-index-3" select="xxforms:index('department-repeat')" as="element*"/>
                            <xforms:output id="department-output-3" value="$department-index-3"/>

                            <!-- Make sure the function work from within an action as well -->
                            <xforms:action ev:event="xforms-enabled">
                                <xxforms:variable name="test-nodeset" select="xxforms:index()"/>
                                <xforms:setvalue ref="." value="$test-nodeset"/>
                            </xforms:action>
                        </xforms:repeat>
                    </xforms:repeat>
                </xhtml:body>
            </xhtml:html>
        </input>
        <output name="response">
            <xxf:event-response xmlns:xxf="http://orbeon.org/oxf/xml/xforms">
                <xxf:dynamic-state>
                    <dynamic-state>
                        <instances>
                            <instance id="instance" model-id="model">
                                <company>
                                    <department>
                                        <employee>2</employee>
                                        <employee>2</employee>
                                    </department>
                                    <department>
                                        <employee>1</employee>
                                    </department>
                                    <department>
                                        <employee>3</employee>
                                        <employee>3</employee>
                                        <employee>3</employee>
                                        <employee>3</employee>
                                    </department>
                                </company>
                            </instance>
                            <instance id="instance2" model-id="model2">
                                <form2/>
                            </instance>
                        </instances>
                        <controls>
                            <control effective-id="department-repeat" index="3"/>
                            <control effective-id="employee-repeat·1" index="2"/>
                            <control effective-id="employee-repeat·2" index="1"/>
                            <control effective-id="employee-repeat·3" index="3"/>
                        </controls>
                    </dynamic-state>
                </xxf:dynamic-state>
                <xxf:action>
                    <xxf:control-values>
                        <xxf:control id="department-output-1·1">3</xxf:control>
                        <xxf:control id="department-output-2·1">3</xxf:control>
                            <xxf:control id="employee-output-1·1-1">2</xxf:control>
                            <xxf:control id="employee-output-2·1-1">2</xxf:control>
                        <xxf:control id="department-output-3·1-1">3</xxf:control>
                            <xxf:control id="employee-output-1·1-2">2</xxf:control>
                            <xxf:control id="employee-output-2·1-2">2</xxf:control>
                        <xxf:control id="department-output-3·1-2">3</xxf:control>
                        <xxf:control id="department-output-1·2">3</xxf:control>
                        <xxf:control id="department-output-2·2">3</xxf:control>
                            <xxf:control id="employee-output-1·2-1">1</xxf:control>
                            <xxf:control id="employee-output-2·2-1">1</xxf:control>
                        <xxf:control id="department-output-3·2-1">3</xxf:control>
                        <xxf:control id="department-output-1·3">3</xxf:control>
                        <xxf:control id="department-output-2·3">3</xxf:control>
                            <xxf:control id="employee-output-1·3-1">3</xxf:control>
                            <xxf:control id="employee-output-2·3-1">3</xxf:control>
                        <xxf:control id="department-output-3·3-1">3</xxf:control>
                            <xxf:control id="employee-output-1·3-2">3</xxf:control>
                            <xxf:control id="employee-output-2·3-2">3</xxf:control>
                        <xxf:control id="department-output-3·3-2">3</xxf:control>
                            <xxf:control id="employee-output-1·3-3">3</xxf:control>
                            <xxf:control id="employee-output-2·3-3">3</xxf:control>
                        <xxf:control id="department-output-3·3-3">3</xxf:control>
                            <xxf:control id="employee-output-1·3-4">3</xxf:control>
                            <xxf:control id="employee-output-2·3-4">3</xxf:control>
                        <xxf:control id="department-output-3·3-4">3</xxf:control>
                    </xxf:control-values>
                </xxf:action>
            </xxf:event-response>
        </output>
    </test>

    <test description="xxforms:index() function" name="oxf:pipeline">
        <input name="config" href="wrap-xforms-state.xpl"/>
        <input name="document">
            <xhtml:html xmlns:xxforms="http://orbeon.org/oxf/xml/xforms">
                <xhtml:head>
                    <xforms:model>
                        <xforms:instance id="item-instance">
                            <item xmlns="">
                                <name>New item</name>
                            </item>
                        </xforms:instance>
                        <xforms:instance id="items-instance">
                            <items xmlns=""/>
                        </xforms:instance>
                        <!-- Insert upon initialization -->
                        <xforms:action ev:event="xforms-ready">
                            <xforms:insert origin="instance( 'item-instance' )" context="instance( 'items-instance' )" nodeset="*" />
                        </xforms:action>
                    </xforms:model>
                </xhtml:head>
                <xhtml:body>
                    <xforms:group id="outer-group" ref=".[count(instance('items-instance')/item) gt 0]">
                        <xforms:repeat nodeset="instance('items-instance')/item" id="items-item-repeat">
                            <xforms:output id="position-output" value="count(preceding-sibling::item) + 1" />
                            <xforms:output id="index-output-1" value="index('items-item-repeat')"/>
                            <xforms:group id="input-group" ref=".[count(preceding-sibling::item) + 1 = index('items-item-repeat')]">
                                <xforms:input id="input" ref="name"/>
                            </xforms:group>
                            <xforms:group id="output-group" ref=".[not(count(preceding-sibling::item) + 1 = index('items-item-repeat'))]">
                                <xforms:output id="output" ref="name"/>
                            </xforms:group>
                       </xforms:repeat>
                    </xforms:group>
                </xhtml:body>
            </xhtml:html>

        </input>
        <output name="response">
            <xxf:event-response xmlns:xxf="http://orbeon.org/oxf/xml/xforms">
                <xxf:dynamic-state>
                    <dynamic-state>
                        <instances>
                            <instance id="item-instance" model-id="xf-1">
                                <item>
                                    <name>New item</name>
                                </item>
                            </instance>
                            <instance id="items-instance" model-id="xf-1">
                                <items>
                                    <item>
                                        <name>New item</name>
                                    </item>
                                </items>
                            </instance>
                        </instances>
                        <controls>
                            <control effective-id="items-item-repeat" index="1"/>
                        </controls>
                    </dynamic-state>
                </xxf:dynamic-state>
                <xxf:action>
                    <xxf:control-values>
                        <xxf:control id="position-output·1">1</xxf:control>
                        <xxf:control id="index-output-1·1">1</xxf:control>
                        <xxf:control id="input·1">New item</xxf:control>
                        <xxf:control id="output-group·1" relevant="false"/>
                        <xxf:control id="output·1" relevant="false"/>
                    </xxf:control-values>
                </xxf:action>
            </xxf:event-response>
        </output>
    </test>

    <test description="Repeat iteration update upon nodeset shuffle with exf:sort()" name="oxf:pipeline">
        <input name="config" href="wrap-xforms-state.xpl"/>
        <input name="document">
            <xhtml:html xmlns:xxforms="http://orbeon.org/oxf/xml/xforms" xmlns:exf="http://www.exforms.org/exf/1-0">
                <xhtml:head>
                    <xforms:model id="model">
                        <xforms:instance id="instance">
                            <instance xmlns="">
                                <event>000000000000</event>
                                <event>000000000001</event>
                            </instance>
                        </xforms:instance>

                        <xforms:instance id="other">
                            <instance xmlns="">
                                <order>ascending</order>
                                <selection/>
                                <index/>
                            </instance>
                        </xforms:instance>

                        <xforms:action ev:event="xforms-ready">
                            <xforms:refresh/>
                            <xforms:setvalue ref="instance('other')/order">descending</xforms:setvalue>
                        </xforms:action>

                    </xforms:model>
                </xhtml:head>
                <xhtml:body>
                    <xforms:repeat nodeset="exf:sort(event, 'string(.)', 'text', instance('other')/order)" id="my-repeat">
                        <xforms:action ev:event="xxforms-nodeset-changed">
                            <xforms:setvalue ref="instance('other')/selection" value="xxforms:repeat-nodeset('my-repeat')[index('my-repeat')]"/>
                            <xforms:setvalue ref="instance('other')/index" value="index('my-repeat')"/>
                        </xforms:action>
                        <xforms:output ref="." id="my-output"/>
                    </xforms:repeat>
                </xhtml:body>
            </xhtml:html>
        </input>
        <output name="response">
            <xxf:event-response xmlns:xxf="http://orbeon.org/oxf/xml/xforms">
                <xxf:dynamic-state>
                    <dynamic-state>
                        <instances>
                            <instance id="instance" model-id="model">
                                <instance>
                                    <event>000000000000</event>
                                    <event>000000000001</event>
                                </instance>
                            </instance>
                            <instance id="other" model-id="model">
                                <instance>
                                    <order>descending</order>
                                    <selection>000000000000</selection>
                                    <index>2</index>
                                </instance>
                            </instance>
                        </instances>
                        <controls>
                            <control effective-id="my-repeat" index="2"/>
                        </controls>
                    </dynamic-state>
                </xxf:dynamic-state>
                <xxf:action>
                    <xxf:control-values>
                        <xxf:control id="my-output·1">000000000001</xxf:control>
                        <xxf:control id="my-output·2">000000000000</xxf:control>
                    </xxf:control-values>
                </xxf:action>
            </xxf:event-response>
        </output>da
    </test>

    <test description="xxforms-index-changed event" name="oxf:pipeline">
        <input name="config" href="wrap-xforms-state.xpl"/>
        <input name="document">
            <xhtml:html xmlns:xxforms="http://orbeon.org/oxf/xml/xforms" xmlns:exf="http://www.exforms.org/exf/1-0">
                <xhtml:head>
                    <xforms:model id="model">
                        <xforms:instance id="instance">
                            <values><value>1</value><value>2</value><value>3</value><value>4</value></values>
                        </xforms:instance>

                        <!-- TEST: Events to gather -->
                        <xforms:instance id="events">
                            <events/>
                        </xforms:instance>

                        <xforms:action ev:event="xforms-ready">
                            <xforms:setindex repeat="my-repeat" index="2"/>
                            <xforms:insert nodeset="value" origin="(xxforms:element('value', 5), xxforms:element('value', 6))"/>
                            <xforms:delete nodeset="value" at="6"/>
                            <xforms:delete nodeset="value"/>
                        </xforms:action>

                    </xforms:model>
                </xhtml:head>
                <xhtml:body>
                    <xforms:group id="my-group">
                        <xforms:insert ev:event="xxforms-index-changed"
                                       context="instance('events')" nodeset="*"
                                       origin="xxforms:element('event',
                                                (xxforms:attribute('type', event('xxforms:type')),
                                                 xxforms:attribute('target', event('xxforms:targetid')),
                                                 xxforms:attribute('old', event('xxforms:old-index')),
                                                 xxforms:attribute('new', event('xxforms:new-index'))
                                                 ))"/>

                        <xforms:repeat nodeset="value" id="my-repeat"/>
                    </xforms:group>
                </xhtml:body>
            </xhtml:html>
        </input>
        <output name="response">
            <xxf:event-response xmlns:xxf="http://orbeon.org/oxf/xml/xforms">
                <xxf:dynamic-state>
                    <dynamic-state>
                        <instances>
                            <instance id="instance" model-id="model">
                                <values/>
                            </instance>
                            <instance id="events" model-id="model">
                                <events>
                                    <event type="xxforms-index-changed" target="my-repeat" old="1" new="2"/>
                                    <event type="xxforms-index-changed" target="my-repeat" old="2" new="6"/>
                                    <event type="xxforms-index-changed" target="my-repeat" old="6" new="5"/>
                                </events>
                            </instance>
                        </instances>
                    </dynamic-state>
                </xxf:dynamic-state>
                <xxf:action>
                    <xxf:control-values/>
                </xxf:action>
            </xxf:event-response>
        </output>
    </test>

    <test description="xforms-enabled event on xforms:repeat" name="oxf:pipeline">
        <input name="config" href="wrap-xforms-state.xpl"/>
        <input name="document">
            <xhtml:html xmlns:xxforms="http://orbeon.org/oxf/xml/xforms" xmlns:exf="http://www.exforms.org/exf/1-0">
                <xhtml:head>
                    <xforms:model id="model">
                        <!-- All relevant -->
                        <xforms:instance id="instance-1">
                            <values><value>1</value><value>2</value><value>3</value><value>4</value></values>
                        </xforms:instance>

                        <!-- All non-relevant -->
                        <xforms:instance id="instance-2">
                            <values><value>1</value><value>2</value><value>3</value><value>4</value></values>
                        </xforms:instance>
                        <xforms:bind nodeset="instance('instance-2')/value" relevant="false()"/>

                        <!-- All non-relevant except last value -->
                        <xforms:instance id="instance-3">
                            <values><value>1</value><value>2</value><value>3</value><value>4</value></values>
                        </xforms:instance>
                        <xforms:bind nodeset="instance('instance-3')/value[position() != last()]" relevant="false()"/>

                        <!-- TEST: Events to gather -->
                        <xforms:instance id="events">
                            <events/>
                        </xforms:instance>

                        <xforms:action ev:event="xforms-ready">
                            <!--<xforms:setindex repeat="my-repeat" index="2"/>-->
                            <!--<xforms:insert nodeset="value" origin="(xxforms:element('value', 5), xxforms:element('value', 6))"/>-->
                            <!--<xforms:delete nodeset="value" at="6"/>-->
                            <!--<xforms:delete nodeset="value"/>-->
                        </xforms:action>

                    </xforms:model>
                </xhtml:head>
                <xhtml:body>
                    <xforms:group id="my-group">
                        <xforms:insert ev:event="xforms-enabled"
                                       context="instance('events')" nodeset="*"
                                       origin="xxforms:element('event',
                                                (xxforms:attribute('type', event('xxforms:type')),
                                                 xxforms:attribute('target', event('xxforms:targetid'))
                                                 ))"/>

                        <xforms:repeat nodeset="value" id="my-repeat-1a"/>
                        <xforms:repeat nodeset="()" id="my-repeat-1b"/>
                        <xforms:repeat nodeset="instance('instance-2')/value" id="my-repeat-2"/>
                        <xforms:repeat nodeset="instance('instance-3')/value" id="my-repeat-3">
                            <!-- Test handler with ev:target="#observer" -->
                            <xforms:insert ev:event="xforms-enabled" ev:target="#observer" ev:propagate="stop"
                                       context="instance('events')" nodeset="*"
                                       origin="xxforms:element('event',
                                                (xxforms:attribute('type', event('xxforms:type')),
                                                 xxforms:attribute('target', event('xxforms:targetid')),
                                                 xxforms:attribute('index', xxforms:index())
                                                 ))"/>
                        </xforms:repeat>

                        <!-- Test handler with ev:observer and ev:target -->
                        <xforms:insert ev:event="xforms-enabled" ev:observer="my-repeat-3" ev:target="my-repeat-3"
                                       context="instance('events')" nodeset="*"
                                       origin="xxforms:element('event',
                                                (xxforms:attribute('type', event('xxforms:type')),
                                                 xxforms:attribute('target', event('xxforms:targetid')),
                                                 xxforms:attribute('index', index('my-repeat-3'))
                                                 ))"/>

                        <xforms:group id="my-group-2" ref="()">
                            <xforms:repeat nodeset="instance('instance-1')/value" id="my-repeat-4"/>
                        </xforms:group>
                    </xforms:group>
                </xhtml:body>
            </xhtml:html>
        </input>
        <output name="response">
            <xxf:event-response xmlns:xxf="http://orbeon.org/oxf/xml/xforms">
                <xxf:dynamic-state>
                    <dynamic-state>
                        <instances>
                            <instance id="instance-1" model-id="model">
                                <values>
                                    <value>1</value>
                                    <value>2</value>
                                    <value>3</value>
                                    <value>4</value>
                                </values>
                            </instance>
                            <instance id="instance-2" model-id="model">
                                <values>
                                    <value>1</value>
                                    <value>2</value>
                                    <value>3</value>
                                    <value>4</value>
                                </values>
                            </instance>
                            <instance id="instance-3" model-id="model">
                                <values>
                                    <value>1</value>
                                    <value>2</value>
                                    <value>3</value>
                                    <value>4</value>
                                </values>
                            </instance>
                            <instance id="events" model-id="model">
                                <events>
                                    <event type="xforms-enabled" target="my-group"/>
                                    <event type="xforms-enabled" target="my-repeat-1a"/>
                                    <event type="xforms-enabled" target="my-repeat-3" index="1"/>
                                    <event type="xforms-enabled" target="my-repeat-3" index="1"/>
                                </events>
                            </instance>
                        </instances>
                        <controls>
                            <control effective-id="my-repeat-1a" index="1"/>
                            <control effective-id="my-repeat-3" index="1"/>
                        </controls>
                    </dynamic-state>
                </xxf:dynamic-state>
                <xxf:action>
                    <xxf:control-values>
                        <xxf:repeat-iteration id="my-repeat-2" relevant="false" iteration="1"/>
                        <xxf:repeat-iteration id="my-repeat-2" relevant="false" iteration="2"/>
                        <xxf:repeat-iteration id="my-repeat-2" relevant="false" iteration="3"/>
                        <xxf:repeat-iteration id="my-repeat-2" relevant="false" iteration="4"/>
                        <xxf:repeat-iteration id="my-repeat-3" relevant="false" iteration="1"/>
                        <xxf:repeat-iteration id="my-repeat-3" relevant="false" iteration="2"/>
                        <xxf:repeat-iteration id="my-repeat-3" relevant="false" iteration="3"/>
                        <xxf:control id="my-group-2" relevant="false"/>
                    </xxf:control-values>
                </xxf:action>
            </xxf:event-response>
        </output>
    </test>

    <test description="Repeat bound to items" name="oxf:pipeline">
        <input name="config" href="wrap-xforms-state.xpl"/>
        <input name="document">
            <xhtml:html xmlns:xxforms="http://orbeon.org/oxf/xml/xforms" xmlns:exf="http://www.exforms.org/exf/1-0">
                <xhtml:head>
                    <xforms:model id="model">
                        <xforms:instance id="instance">
                            <instance>
                                <order>ascending</order>
                            </instance>
                        </xforms:instance>
                        <xforms:action ev:event="xforms-ready">
                            <xforms:refresh/>
                            <xforms:setvalue ref="order">descending</xforms:setvalue>
                        </xforms:action>
                    </xforms:model>
                </xhtml:head>
                <xhtml:body>
                    <xforms:repeat id="my-repeat" nodeset="if (order = 'ascending') then (1 to 2) else reverse(1 to 2)">
                        <xforms:output id="my-position" value="position()"/>
                        <xforms:output id="my-value" ref="."/>
                    </xforms:repeat>
                </xhtml:body>
            </xhtml:html>
        </input>
        <output name="response">
            <xxf:event-response xmlns:xxf="http://orbeon.org/oxf/xml/xforms">
                <xxf:dynamic-state>
                    <dynamic-state>
                        <instances>
                            <instance id="instance" model-id="model">
                                <instance>
                                    <order>descending</order>
                                </instance>
                            </instance>
                        </instances>
                        <controls>
                            <control effective-id="my-repeat" index="2"/>
                        </controls>
                    </dynamic-state>
                </xxf:dynamic-state>
                <xxf:action>
                    <xxf:control-values>
                        <xxf:control id="my-position·1">1</xxf:control>
                        <xxf:control id="my-value·1">2</xxf:control>
                        <xxf:control id="my-position·2">2</xxf:control>
                        <xxf:control id="my-value·2">1</xxf:control>
                    </xxf:control-values>
                </xxf:action>
            </xxf:event-response>
        </output>
    </test>

    <test description="xforms-enabled dispatch when new iteration appears upon refresh" name="oxf:pipeline">
        <input name="config" href="wrap-xforms-state.xpl"/>
        <input name="document">
            <xhtml:html xmlns:xxforms="http://orbeon.org/oxf/xml/xforms" xmlns:exf="http://www.exforms.org/exf/1-0">
                <xhtml:head>
                    <xforms:model id="model">
                        <xforms:instance id="instance">
                            <values size="1">
                                <value>1</value>
                                <value>2</value>
                                <value>3</value>
                                <value>4</value>
                            </values>
                        </xforms:instance>

                        <!-- TEST: Events to gather -->
                        <xforms:instance id="events">
                            <events/>
                        </xforms:instance>

                        <xforms:insert ev:event="xforms-refresh" context="instance('events')" nodeset="*"
                                       origin="xxforms:element('refresh')"/>

                        <xforms:action ev:event="xforms-ready">
                            <!-- Clear until now -->
                            <xforms:refresh/>
                            <!-- This causes a change of repeat nodeset upon next refresh -->
                            <xforms:setvalue ref="@size">2</xforms:setvalue>
                        </xforms:action>
                    </xforms:model>
                </xhtml:head>
                <xhtml:body>
                    <xforms:insert ev:event="xforms-enabled"
                                   context="instance('events')" nodeset="*"
                                   origin="xxforms:element('event',
                                            (xxforms:attribute('type', event('xxforms:type')),
                                             xxforms:attribute('target', event('xxforms:targetid')),
                                             xxforms:attribute('indexes', string-join(event('xxforms:repeat-indexes'), ' '))
                                             ))"/>

                    <xforms:repeat id="my-repeat" nodeset="value[position() le xs:integer(../@size)]">
                        <xforms:input id="my-input" ref="."/>
                    </xforms:repeat>
                </xhtml:body>
            </xhtml:html>
        </input>
        <output name="response">
            <xxf:event-response xmlns:xxf="http://orbeon.org/oxf/xml/xforms">
                <xxf:dynamic-state>
                    <dynamic-state>
                        <instances>
                            <instance id="instance" model-id="model">
                                <values size="2">
                                    <value>1</value>
                                    <value>2</value>
                                    <value>3</value>
                                    <value>4</value>
                                </values>
                            </instance>
                            <instance id="events" model-id="model">
                                <events>
                                    <event type="xforms-enabled" target="my-repeat" indexes=""/>
                                    <event type="xforms-enabled" target="my-input" indexes="1"/>
                                    <refresh/>
                                    <event type="xforms-enabled" target="my-input" indexes="2"/>
                                </events>
                            </instance>
                        </instances>
                        <controls>
                            <control effective-id="my-repeat" index="1"/>
                        </controls>
                    </dynamic-state>
                </xxf:dynamic-state>
                <xxf:action>
                    <xxf:control-values>
                        <xxf:control id="my-input·1">1</xxf:control>
                        <xxf:control id="my-input·2">2</xxf:control>
                    </xxf:control-values>
                </xxf:action>
            </xxf:event-response>
        </output>
    </test>

    <test description="xxforms-iteration-changed event" name="oxf:pipeline">
        <input name="config" href="wrap-xforms-state.xpl"/>
        <input name="document">
            <xhtml:html xmlns:xxforms="http://orbeon.org/oxf/xml/xforms" xmlns:exf="http://www.exforms.org/exf/1-0">
                <xhtml:head>
                    <xforms:model id="model">
                        <xforms:instance id="instance">
                            <instance order="0">
                                <state>
                                    <name>CA</name>
                                    <value>222</value>
                                </state>
                                <state>
                                    <name>WA</name>
                                    <value>111</value>
                                </state>
                            </instance>
                        </xforms:instance>

                        <!-- TEST: Events to gather -->
                        <xforms:instance id="events">
                            <events/>
                        </xforms:instance>

                        <xforms:action ev:event="xforms-ready">
                            <!-- Clear until now -->
                            <xforms:refresh/>
                            <!-- This causes a change of repeat nodeset upon next refresh -->
                            <xforms:setvalue ev:event="DOMActivate" ref="@order" value="(. + 1) mod 2"/>
                        </xforms:action>
                    </xforms:model>
                </xhtml:head>
                <xhtml:body>
                    <xforms:repeat nodeset="if (@order = '0') then (state[1], state[2]) else (state[2], state[1])">
                        <xhtml:div>
                            <xforms:output id="my-name" value="name">
                                <xforms:insert ev:event="xxforms-iteration-moved"
                                   context="instance('events')" nodeset="*"
                                   origin="xxforms:element('event',
                                            (xxforms:attribute('type', event('xxforms:type')),
                                             xxforms:attribute('target', event('xxforms:targetid')),
                                             xxforms:attribute('indexes', string-join(event('xxforms:repeat-indexes'), ' '))
                                             ))"/>
                            </xforms:output>
                            <xforms:output id="my-value" value="value"/>
                        </xhtml:div>
                    </xforms:repeat>
                </xhtml:body>
            </xhtml:html>
        </input>
        <output name="response">
            <xxf:event-response xmlns:xxf="http://orbeon.org/oxf/xml/xforms">
                <xxf:dynamic-state>
                    <dynamic-state>
                        <instances>
                            <instance id="instance" model-id="model">
                                <instance order="1">
                                    <state>
                                        <name>CA</name>
                                        <value>222</value>
                                    </state>
                                    <state>
                                        <name>WA</name>
                                        <value>111</value>
                                    </state>
                                </instance>
                            </instance>
                            <instance id="events" model-id="model">
                                <events>
                                    <event type="xxforms-iteration-moved" target="my-name" indexes="1"/>
                                    <event type="xxforms-iteration-moved" target="my-name" indexes="2"/>
                                </events>
                            </instance>
                        </instances>
                        <controls>
                            <control effective-id="xf-4" index="2"/>
                        </controls>
                    </dynamic-state>
                </xxf:dynamic-state>
                <xxf:action>
                    <xxf:control-values>
                        <xxf:control id="my-name·1">WA</xxf:control>
                        <xxf:control id="my-value·1">111</xxf:control>
                        <xxf:control id="my-name·2">CA</xxf:control>
                        <xxf:control id="my-value·2">222</xxf:control>
                    </xxf:control-values>
                </xxf:action>
            </xxf:event-response>
        </output>
    </test>

    <test description="index() function resolves nested repeats as per XForms 1.1" name="oxf:pipeline">
        <!-- See http://forge.ow2.org/tracker/index.php?func=detail&aid=313774&group_id=168&atid=350207 -->
        <input name="config" href="wrap-xforms-state.xpl"/>
        <input name="document">
            <xhtml:html xmlns:xxforms="http://orbeon.org/oxf/xml/xforms">
                <head>
                    <xforms:model id="model">
                        <xforms:instance id="instance">
                            <instance xmlns="">
                                <department>
                                    <employee/>
                                    <employee/>
                                </department>
                                <department>
                                    <employee/>
                                    <employee/>
                                    <employee/>
                                </department>
                            </instance>
                        </xforms:instance>
                        <xforms:action ev:event="xforms-ready">
                            <xforms:setindex repeat="repeat-department" index="1"/>
                            <xforms:setindex repeat="repeat-employee" index="2"/>
                            <xforms:setindex repeat="repeat-department" index="2"/>
                            <xforms:setindex repeat="repeat-employee" index="3"/>
                        </xforms:action>
                    </xforms:model>
                </head>
                <body>
                    <xforms:repeat nodeset="department" id="repeat-department">
                        <xxforms:variable name="department-position" select="position()"/>
                        <xforms:repeat nodeset="employee" id="repeat-employee">
                            <xxforms:variable name="employee-position" select="position()"/>
                            <xforms:output id="my-output"
                                           value="string-join(for $v in ($department-position, $employee-position,
                                                    index('repeat-department'), index('repeat-employee')) return xs:string($v), ' ')"/>
                        </xforms:repeat>
                    </xforms:repeat>
                </body>
            </xhtml:html>
        </input>
        <output name="response">
            <xxf:event-response xmlns:xxf="http://orbeon.org/oxf/xml/xforms">
                <xxf:dynamic-state>
                    <dynamic-state>
                        <instances>
                            <instance id="instance" model-id="model">
                                <instance>
                                    <department>
                                        <employee/>
                                        <employee/>
                                    </department>
                                    <department>
                                        <employee/>
                                        <employee/>
                                        <employee/>
                                    </department>
                                </instance>
                            </instance>
                        </instances>
                        <controls>
                            <control effective-id="repeat-department" index="2"/>
                            <control effective-id="repeat-employee·1" index="2"/>
                            <control effective-id="repeat-employee·2" index="3"/>
                        </controls>
                    </dynamic-state>
                </xxf:dynamic-state>
                <xxf:action>
                    <xxf:control-values>
                        <xxf:control id="my-output·1-1">1 1 2 2</xxf:control>
                        <xxf:control id="my-output·1-2">1 2 2 2</xxf:control>
                        <xxf:control id="my-output·2-1">2 1 2 3</xxf:control>
                        <xxf:control id="my-output·2-2">2 2 2 3</xxf:control>
                        <xxf:control id="my-output·2-3">2 3 2 3</xxf:control>
                    </xxf:control-values>
                </xxf:action>
            </xxf:event-response>
        </output>
    </test>

    <test description="Delete action deletes detached node upon xforms-disabled" name="oxf:pipeline">
        <!-- See http://forge.ow2.org/tracker/index.php?func=detail&aid=314760&group_id=168&atid=350207 -->
        <input name="config" href="wrap-xforms-state.xpl"/>
        <input name="document">
            <xhtml:html xmlns:xxforms="http://orbeon.org/oxf/xml/xforms">
                <xhtml:head>
                    <xforms:model id="model">
                        <xforms:instance id="instance">
                            <instance>
                                <company>
                                    <employee>Mary</employee>
                                </company>
                            </instance>
                        </xforms:instance>
                        <!-- Delete company element -->
                        <xforms:delete ev:event="xforms-ready" nodeset="company"/>
                    </xforms:model>
                </xhtml:head>
                <xhtml:body>

                    <xforms:repeat id="my-repeat" nodeset="company">
                        <xforms:input id="my-input" ref="employee">
                            <!-- Attempt to re-delete company element when we disappear -->
                            <xforms:delete ev:event="xforms-disabled" nodeset=".."/>
                        </xforms:input>
                    </xforms:repeat>

                </xhtml:body>
            </xhtml:html>
        </input>
        <output name="response">
            <xxf:event-response xmlns:xxf="http://orbeon.org/oxf/xml/xforms">
                <xxf:dynamic-state>
                    <dynamic-state>
                        <instances>
                            <instance id="instance" model-id="model">
                                <instance> </instance>
                            </instance>
                        </instances>
                    </dynamic-state>
                </xxf:dynamic-state>
                <xxf:action>
                    <xxf:control-values/>
                </xxf:action>
            </xxf:event-response>
        </output>
    </test>

    <test description="AVT on xforms:insert/@position" name="oxf:pipeline">
        <!-- See http://forge.ow2.org/tracker/?func=detail&atid=350207&aid=314804&group_id=168 -->
        <input name="config" href="wrap-xforms-state.xpl"/>
        <input name="document">
            <xhtml:html xmlns:xxforms="http://orbeon.org/oxf/xml/xforms">
                <xhtml:head>
                    <xforms:model id="model">
                        <xforms:instance id="instance">
                            <values>
                                <value>1</value>
                                <value>3</value>
                                <value>5</value>
                            </values>
                        </xforms:instance>

                        <xforms:action ev:event="xforms-ready">
                            <xforms:insert nodeset="value[. = 3]" position="{'before'}" origin="xxforms:element('value', 2)"/>
                            <xforms:insert nodeset="value[. = 3]" position="{'after'}" origin="xxforms:element('value', 4)"/>
                            <!-- Invalid position defaults to "after" -->
                            <xforms:insert nodeset="value[. = 5]" position="{''}" origin="xxforms:element('value', '6')"/>
                        </xforms:action>
                    </xforms:model>
                </xhtml:head>
                <xhtml:body>
                </xhtml:body>
            </xhtml:html>
        </input>
        <output name="response">
            <xxf:event-response xmlns:xxf="http://orbeon.org/oxf/xml/xforms">
                <xxf:dynamic-state>
                    <dynamic-state>
                        <instances>
                            <instance id="instance" model-id="model">
                                <values>
                                    <value>1</value>
                                    <value>2</value>
                                    <value>3</value>
                                    <value>4</value>
                                    <value>5</value>
                                    <value>6</value>
                                </values>
                            </instance>
                        </instances>
                    </dynamic-state>
                </xxf:dynamic-state>
                <xxf:action>
                    <xxf:control-values/>
                </xxf:action>
            </xxf:event-response>
        </output>
    </test>

    <test description="Comparison of various item types in repeat nodeset change" name="oxf:pipeline">
        <!-- See http://forge.ow2.org/tracker/index.php?func=detail&aid=314831&group_id=168&atid=350207 -->
        <input name="config" href="wrap-xforms-state.xpl"/>
        <input name="document">
            <xhtml:html xmlns:xxforms="http://orbeon.org/oxf/xml/xforms">
                <xhtml:head>
                    <xforms:model id="model">
                        <xforms:instance id="instance">
                            <values mode="string">
                                <value>1</value>
                            </values>
                        </xforms:instance>

                        <xforms:action ev:event="xforms-ready">
                            <xforms:setvalue ref="@mode">number</xforms:setvalue>
                            <xforms:refresh/>
                            <xforms:setvalue ref="@mode">node</xforms:setvalue>
                            <xforms:refresh/>
                            <xforms:setvalue ref="@mode">number</xforms:setvalue>
                            <xforms:refresh/>
                            <xforms:setvalue ref="@mode">string</xforms:setvalue>
                        </xforms:action>
                    </xforms:model>
                </xhtml:head>
                <xhtml:body>
                    <xforms:repeat id="my-repeat"
                                   nodeset="if (@mode = 'string') then ('1') else if (@mode = 'number') then 1 else value"/>
                </xhtml:body>
            </xhtml:html>
        </input>
        <output name="response">
            <xxf:event-response xmlns:xxf="http://orbeon.org/oxf/xml/xforms">
                <xxf:dynamic-state>
                    <dynamic-state>
                        <instances>
                            <instance id="instance" model-id="model">
                                <values mode="string">
                                    <value>1</value>
                                </values>
                            </instance>
                        </instances>
                        <controls>
                            <control effective-id="my-repeat" index="1"/>
                        </controls>
                    </dynamic-state>
                </xxf:dynamic-state>
                <xxf:action>
                    <xxf:control-values/>
                </xxf:action>
            </xxf:event-response>
        </output>
    </test>

    <test description="Insert upon Ajax request causes repeat iteration creation without error" name="oxf:pipeline">
        <!-- See http://forge.ow2.org/tracker/index.php?func=detail&aid=315081&group_id=168&atid=350207 -->
        <input name="config" href="wrap-server.xpl"/>
        <input name="action">
            <xxforms:action xmlns:xxforms="http://orbeon.org/oxf/xml/xforms">
                <xxforms:event name="DOMActivate" source-control-id="insert-trigger"/>
            </xxforms:action>
        </input>
        <input name="controls">
            <controls
                xmlns:xforms="http://www.w3.org/2002/xforms"
                xmlns:xxforms="http://orbeon.org/oxf/xml/xforms"
                xmlns:ev="http://www.w3.org/2001/xml-events">

                <xforms:repeat id="company-repeat" ref="company"/>

                <xforms:trigger id="insert-trigger">
                    <xforms:insert id="insert" ev:event="DOMActivate" context="instance()" origin="xxforms:element('company')"/>
                </xforms:trigger>
            </controls>
        </input>
        <input name="models">
            <models>
                <xforms:model id="model">
                    <xforms:instance id="instance">
                        <companies/>
                    </xforms:instance>
                </xforms:model>
            </models>
        </input>
        <input name="instances">
            <instances>
                <instance model-id="model" id="instance">
                    <companies/>
                </instance>
            </instances>
        </input>
        <output name="response">
            <xxf:event-response xmlns:xxf="http://orbeon.org/oxf/xml/xforms">
                <xxf:dynamic-state>
                    <dynamic-state>
                        <instances>
                            <instance id="instance" model-id="model">
                                <companies>
                                    <company/>
                                </companies>
                            </instance>
                        </instances>
                        <controls>
                            <control effective-id="company-repeat" index="1"/>
                        </controls>
                    </dynamic-state>
                </xxf:dynamic-state>
                <xxf:action>
                    <xxf:control-values>
                        <xxf:copy-repeat-template id="company-repeat" parent-indexes="" start-suffix="1" end-suffix="1"/>
                    </xxf:control-values>
                    <xxf:repeat-indexes>
                        <xxf:repeat-index id="company-repeat" old-index="0" new-index="1"/>
                    </xxf:repeat-indexes>
                </xxf:action>
            </xxf:event-response>
        </output>
    </test>

    <test description="Insert causes repeat update with top-level preceding variables" name="oxf:pipeline">
        <!-- See http://forge.ow2.org/tracker/index.php?func=detail&aid=315434&group_id=168&atid=350207 -->
        <input name="config" href="wrap-xforms-state.xpl"/>
        <input name="document">
            <xhtml:html xmlns:xxforms="http://orbeon.org/oxf/xml/xforms">
                <xhtml:head>
                    <xforms:model id="model">
                        <xforms:instance id="instance">
                            <values>
                                <value>1</value>
                            </values>
                        </xforms:instance>

                        <xforms:action ev:event="xforms-ready">
                            <xforms:insert nodeset="*"/>
                        </xforms:action>
                    </xforms:model>
                </xhtml:head>
                <xhtml:body>
                    <xxforms:variable name="values" select="value"/>
                    <xforms:repeat id="my-repeat" ref="$values"/>
                </xhtml:body>
            </xhtml:html>
        </input>
        <output name="response">
            <xxf:event-response xmlns:xxf="http://orbeon.org/oxf/xml/xforms">
                <xxf:dynamic-state>
                    <dynamic-state>
                        <instances>
                            <instance id="instance" model-id="model">
                                <values>
                                    <value>1</value>
                                    <value>1</value>
                                </values>
                            </instance>
                        </instances>
                        <controls>
                            <control effective-id="my-repeat" index="1"/>
                        </controls>
                    </dynamic-state>
                </xxf:dynamic-state>
                <xxf:action>
                    <xxf:control-values/>
                </xxf:action>
            </xxf:event-response>
        </output>
    </test>

    <!--

    TODO:

    * test xforms-enabled events upon new repeat iteration
    * test same but with changes between new repeat iteration and next refresh
    * test init events
    * index() on capture vs. bubbling (old vs. new index)
    * index() in xf:label/xf:output

    -->

</group>
