<!--
  Copyright (C) 2010 Orbeon, Inc.

  This program is free software; you can redistribute it and/or modify it under the terms of the
  GNU Lesser General Public License as published by the Free Software Foundation; either version
  2.1 of the License, or (at your option) any later version.

  This program is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY;
  without even the implied warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.
  See the GNU Lesser General Public License for more details.

  The full text of the license is available at http://www.gnu.org/copyleft/lesser.html
  -->
<group description="XForms MIPs" xmlns:p="http://www.orbeon.com/oxf/pipeline"
    xmlns:xsl="http://www.w3.org/1999/XSL/Transform"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xmlns:xs="http://www.w3.org/2001/XMLSchema"
    xmlns:xhtml="http://www.w3.org/1999/xhtml"
    xmlns:oxf="http://www.orbeon.com/oxf/processors"
    xmlns:xi="http://www.w3.org/2001/XInclude"
    xmlns:xxi="http://orbeon.org/oxf/xml/xinclude"
    xmlns:xforms="http://www.w3.org/2002/xforms"
    xmlns:xf="http://www.w3.org/2002/xforms"
    xmlns:ev="http://www.w3.org/2001/xml-events"
    xmlns:xbl="http://www.w3.org/ns/xbl"
    xmlns:fr="http://orbeon.org/oxf/xml/form-runner">

    <test description="Calculate upon initialization" name="oxf:pipeline">
        <input name="config">
            <p:config xmlns:oxf="http://www.orbeon.com/oxf/processors" xmlns:xxforms="http://orbeon.org/oxf/xml/xforms" xmlns:xforms="http://www.w3.org/2002/xforms">
                <p:param name="response" type="output"/>

                <p:processor name="oxf:pipeline">
                    <p:input name="config" href="wrap-xforms-state.xpl"/>
                    <p:input name="document">
                        <xhtml:html>
                            <xhtml:head>
                                <xforms:model id="main-model">
                                    <xforms:instance id="tests">
                                        <instance>
                                            <noFoundData>0</noFoundData>
                                        </instance>
                                    </xforms:instance>
                                    <xforms:bind nodeset="instance('tests')">
                                        <xforms:bind nodeset="noFoundData" calculate=". + 1"/>
                                    </xforms:bind>
                                </xforms:model>
                            </xhtml:head>
                            <xhtml:body>
                                <xforms:group ref="instance('tests')" id="id1">
                                    <xforms:input ref="noFoundData" id="id2">
                                        <xforms:label class="fixed-width">test noFoundData:</xforms:label>
                                    </xforms:input>
                                </xforms:group>
                            </xhtml:body>
                        </xhtml:html>
                    </p:input>
                    <p:output name="response" ref="response"/>
                </p:processor>
            </p:config>
        </input>
        <output name="response">
            <xxf:event-response xmlns:xxf="http://orbeon.org/oxf/xml/xforms">
                <xxf:dynamic-state>
                    <dynamic-state>
                        <instances>
                            <instance id="tests" model-id="main-model">
                                <instance>
                                    <noFoundData>1</noFoundData>
                                </instance>
                            </instance>
                        </instances>
                    </dynamic-state>
                </xxf:dynamic-state>
                <xxf:action>
                    <xxf:control-values>
                        <xxf:control id="id2" label="test noFoundData:" readonly="true">1</xxf:control>
                    </xxf:control-values>
                </xxf:action>
            </xxf:event-response>
        </output>
    </test>

    <test description="Non-relevant controls when bound to empty node-set" name="oxf:pipeline">
        <input name="config">
            <p:config xmlns:oxf="http://www.orbeon.com/oxf/processors" xmlns:xxforms="http://orbeon.org/oxf/xml/xforms" xmlns:xforms="http://www.w3.org/2002/xforms">
                <p:param name="response" type="output"/>

                <p:processor name="oxf:pipeline">
                    <p:input name="config" href="wrap-xforms-state.xpl"/>
                    <p:input name="document">
                        <xhtml:html>
                            <xhtml:head>
                                <xforms:model id="main-model">
                                    <xforms:instance id="main-instance">
                                        <instance>
                                            <this-is-an-existing-node/>
                                        </instance>
                                    </xforms:instance>
                                </xforms:model>
                            </xhtml:head>
                            <xhtml:body>
                                <xforms:group ref="instance('main-instance')" id="id1">
                                    <xforms:input ref="this-is-an-existing-node" id="id2"/>
                                    <xforms:input ref="this-is-a-non-existing-node" id="id3"/>
                                </xforms:group>
                            </xhtml:body>
                        </xhtml:html>
                    </p:input>
                    <p:output name="response" ref="response"/>
                </p:processor>
            </p:config>
        </input>
        <output name="response">
            <xxf:event-response xmlns:xxf="http://orbeon.org/oxf/xml/xforms">
                <xxf:dynamic-state>
                    <dynamic-state>
                        <instances>
                            <instance id="main-instance" model-id="main-model">
                                <instance>
                                    <this-is-an-existing-node/>
                                </instance>
                            </instance>
                        </instances>
                    </dynamic-state>
                </xxf:dynamic-state>
                <xxf:action>
                    <xxf:control-values>
                        <xxf:control id="id3" relevant="false"/>
                    </xxf:control-values>
                </xxf:action>
            </xxf:event-response>
        </output>
    </test>

    <test description="Bind readonly and relevant inheritance" name="oxf:pipeline">
        <input name="config">
            <p:config xmlns:oxf="http://www.orbeon.com/oxf/processors" xmlns:xxforms="http://orbeon.org/oxf/xml/xforms" xmlns:xforms="http://www.w3.org/2002/xforms">
                <p:param name="response" type="output"/>

                <p:processor name="oxf:pipeline">
                    <p:input name="config" href="wrap-xforms-state.xpl"/>
                    <p:input name="document">
                        <xhtml:html>
                            <xhtml:head>
                                <xforms:model id="main-model">
                                    <xforms:instance id="instance">
                                        <e1 gege="gigi1">
                                            <e2>
                                                <e3>
                                                    <gege>gigi2</gege>
                                                </e3>
                                            </e2>
                                            <e4>
                                                <e5>
                                                    <gege>gigi3</gege>
                                                </e5>
                                            </e4>
                                        </e1>
                                    </xforms:instance>
                                    <xforms:bind nodeset="e2" relevant="false()"/>
                                    <xforms:bind nodeset="e4" readonly="true()"/>
                                </xforms:model>
                            </xhtml:head>
                            <xhtml:body>
                                <xforms:input id="id1" ref="@gege"/>
                                <xforms:input id="id2" ref="e2/e3/gege"/>
                                <xforms:input id="id3" ref="e4/e5/gege"/>
                            </xhtml:body>
                        </xhtml:html>
                    </p:input>
                    <p:output name="response" ref="response"/>
                </p:processor>
            </p:config>
        </input>
        <output name="response">
            <xxf:event-response xmlns:xxf="http://orbeon.org/oxf/xml/xforms">
                <xxf:dynamic-state>
                    <dynamic-state>
                        <instances>
                            <instance id="instance" model-id="main-model">
                                <e1 gege="gigi1">
                                    <e2>
                                        <e3>
                                            <gege>gigi2</gege>
                                        </e3>
                                    </e2>
                                    <e4>
                                        <e5>
                                            <gege>gigi3</gege>
                                        </e5>
                                    </e4>
                                </e1>
                            </instance>
                        </instances>
                    </dynamic-state>
                </xxf:dynamic-state>
                <xxf:action>
                    <xxf:control-values>
                        <xxf:control id="id1">gigi1</xxf:control>
                        <xxf:control id="id2" relevant="false"/>
                        <xxf:control id="id3" readonly="true">gigi3</xxf:control>
                    </xxf:control-values>
                </xxf:action>
            </xxf:event-response>
        </output>
    </test>

    <test description="Boolean MIP values conversion" name="oxf:pipeline">
        <input name="config" href="wrap-xforms-state.xpl"/>
        <input name="document">
            <xhtml:html xmlns:xxforms="http://orbeon.org/oxf/xml/xforms">
                <xhtml:head>
                    <xforms:model id="model">

                        <xforms:instance id="instance">
                            <instance>
                                <a/>
                                <b/>
                                <c/>
                                <d/>
                                <e/>
                                <f/>
                                <g/>
                                <h/>
                                <i/>
                                <j/>

                                <false>false</false>
                                <true>true</true>
                            </instance>
                        </xforms:instance>

                        <xforms:bind nodeset="a" constraint="'false'"/>
                        <xforms:bind nodeset="b" constraint="false()"/>
                        <xforms:bind nodeset="c" constraint="'true'"/>
                        <xforms:bind nodeset="d" constraint="true()"/>
                        <xforms:bind nodeset="e" constraint="../true"/>
                        <xforms:bind nodeset="f" constraint="../false"/>
                        <xforms:bind nodeset="g" constraint="non-existing"/>
                        <xforms:bind nodeset="h" constraint="0"/>
                        <xforms:bind nodeset="i" constraint="1000"/>
                        <xforms:bind nodeset="j" constraint="number('NaN')"/>

                        <xforms:instance id="result">
                            <result/>
                        </xforms:instance>

                        <!-- Result for "a" might change in the future if instead the xs:boolean() logic is used -->

                        <xforms:action ev:event="xforms-ready" xxforms:iterate="*">
                            <xxforms:variable name="current" select="."/>
                            <xforms:insert context="instance('result')" nodeset="*" origin="xxforms:element(name($current), xxforms:valid($current))"/>
                        </xforms:action>

                    </xforms:model>
                </xhtml:head>
            </xhtml:html>
        </input>
        <output name="response">
            <xxf:event-response xmlns:xxf="http://orbeon.org/oxf/xml/xforms">
                <xxf:dynamic-state>
                    <dynamic-state>
                        <instances>
                            <instance id="instance" model-id="model">
                                <instance>
                                    <a/>
                                    <b/>
                                    <c/>
                                    <d/>
                                    <e/>
                                    <f/>
                                    <g/>
                                    <h/>
                                    <i/>
                                    <j/>
                                    <false>false</false>
                                    <true>true</true>
                                </instance>
                            </instance>
                            <instance id="result" model-id="model">
                                <result>
                                    <a>true</a>
                                    <b>false</b>
                                    <c>true</c>
                                    <d>true</d>
                                    <e>true</e>
                                    <f>true</f>
                                    <g>false</g>
                                    <h>false</h>
                                    <i>true</i>
                                    <j>false</j>
                                    <false>true</false>
                                    <true>true</true>
                                </result>
                            </instance>
                        </instances>
                    </dynamic-state>
                </xxf:dynamic-state>
                <xxf:action>
                    <xxf:control-values/>
                </xxf:action>
            </xxf:event-response>
        </output>
    </test>

    <test description="Built-in Schema Types" name="oxf:pipeline">
        <input name="config">
            <p:config xmlns:oxf="http://www.orbeon.com/oxf/processors" xmlns:xxforms="http://orbeon.org/oxf/xml/xforms">
                <p:param name="response" type="output"/>

                <p:processor name="oxf:pipeline">
                    <p:input name="config" href="wrap-xforms-state.xpl"/>
                    <p:input name="document">
                        <xhtml:html>
                            <xhtml:head>
                                <xforms:model>

                                    <xforms:instance id="instance">
                                        <instance>
                                            <emails>
                                                <email/>
                                                <email>editors@example.com</email>>
                                                <email>~my_mail+{nospam}$?@sub-domain.example.info</email>
                                                <email>editors@(this is a comment)example.info</email>
                                                <email>editors{at}example{dot}info</email>
                                                <email>mailto:editors@example.com</email>
                                                <email>a</email>
                                                <email>a@</email>
                                                <email>a@b</email>
                                                <email>a@b.</email>
                                                <email>a@b..</email>
                                            </emails>
                                        </instance>
                                    </xforms:instance>

                                    <xforms:bind nodeset="emails/email" type="xforms:email"/>

                                    <xforms:instance id="result">
                                        <result/>
                                    </xforms:instance>

                                    <xforms:action ev:event="xforms-ready" xxforms:iterate="*/*">
                                        <xxforms:variable name="current" select="."/>
                                        <xforms:insert context="instance('result')" nodeset="*" origin="xxforms:element(name($current), xxforms:valid($current))"/>
                                    </xforms:action>

                                </xforms:model>
                            </xhtml:head>
                        </xhtml:html>
                    </p:input>
                    <p:output name="response" ref="response"/>
                </p:processor>

            </p:config>
        </input>
        <output name="response">
            <xxf:event-response xmlns:xxf="http://orbeon.org/oxf/xml/xforms">
                <xxf:dynamic-state>
                    <dynamic-state>
                        <instances>
                            <instance id="instance" model-id="xf-1">
                                <instance>
                                    <emails>
                                        <email/>
                                        <email>editors@example.com</email>>
                                        <email>~my_mail+{nospam}$?@sub-domain.example.info</email>
                                        <email>editors@(this is a comment)example.info</email>
                                        <email>editors{at}example{dot}info</email>
                                        <email>mailto:editors@example.com</email>
                                        <email>a</email>
                                        <email>a@</email>
                                        <email>a@b</email>
                                        <email>a@b.</email>
                                        <email>a@b..</email>
                                    </emails>
                                </instance>
                            </instance>
                            <instance id="result" model-id="xf-1">
                                <result>
                                    <email>true</email>
                                    <email>true</email>
                                    <email>true</email>
                                    <email>false</email>
                                    <email>false</email>
                                    <email>false</email>
                                    <email>false</email>
                                    <email>false</email>
                                    <email>true</email>
                                    <email>false</email>
                                    <email>false</email>
                                </result>
                            </instance>
                        </instances>
                    </dynamic-state>
                </xxf:dynamic-state>
                <xxf:action>
                    <xxf:control-values/>
                </xxf:action>
            </xxf:event-response>
        </output>
    </test>

    <test description="Custom MIPs" name="oxf:pipeline">
        <input name="config">
            <p:config xmlns:oxf="http://www.orbeon.com/oxf/processors" xmlns:xxforms="http://orbeon.org/oxf/xml/xforms">
                <p:param name="response" type="output"/>

                <p:processor name="oxf:pipeline">
                    <p:input name="config" href="wrap-xforms-state.xpl"/>
                    <p:input name="document">
                        <xhtml:html xmlns:fr="http://orbeon.org/oxf/xml/form-runner">
                            <xhtml:head>
                                <xforms:model xmlns:foo="http://orbeon.org/oxf/xml/foo" id="my-model">
                                    <xforms:instance id="my-instance">
                                        <fruits>
                                            <orange>bloody</orange>
                                            <orange>valencia</orange>
                                            <apple>green</apple>
                                            <apple>red</apple>
                                            <apple>iPod</apple>
                                            <pear>green</pear>
                                            <pear>williams</pear>
                                            <pear>yellow</pear>
                                        </fruits>
                                    </xforms:instance>
                                    <!-- This is the key: set a custom MIP depending on the value -->
                                    <xforms:bind nodeset="*" foo:bar="if (starts-with(., 'g')) then 'is-g' else 'is-not-g'"/>
                                </xforms:model>
                            </xhtml:head>
                            <xhtml:body>
                                <xforms:repeat id="my-repeat" nodeset="*">
                                    <xforms:input id="my-control" ref="."/>
                                </xforms:repeat>
                            </xhtml:body>
                        </xhtml:html>
                    </p:input>
                    <p:output name="response" ref="response"/>
                </p:processor>

            </p:config>
        </input>
        <output name="response">
           <xxf:event-response xmlns:xxf="http://orbeon.org/oxf/xml/xforms">
                <xxf:dynamic-state>
                    <dynamic-state>
                        <instances>
                            <instance id="my-instance" model-id="my-model">
                                <fruits>
                                    <orange>bloody</orange>
                                    <orange>valencia</orange>
                                    <apple>green</apple>
                                    <apple>red</apple>
                                    <apple>iPod</apple>
                                    <pear>green</pear>
                                    <pear>williams</pear>
                                    <pear>yellow</pear>
                                </fruits>
                            </instance>
                        </instances>
                        <controls>
                            <control effective-id="my-repeat" index="1"/>
                        </controls>
                    </dynamic-state>
                </xxf:dynamic-state>
                <xxf:action>
                    <xxf:control-values>
                        <xxf:control id="my-control·1" class="foo-bar-is-not-g">bloody</xxf:control>
                        <xxf:control id="my-control·2" class="foo-bar-is-not-g">valencia</xxf:control>
                        <xxf:control id="my-control·3" class="foo-bar-is-g">green</xxf:control>
                        <xxf:control id="my-control·4" class="foo-bar-is-not-g">red</xxf:control>
                        <xxf:control id="my-control·5" class="foo-bar-is-not-g">iPod</xxf:control>
                        <xxf:control id="my-control·6" class="foo-bar-is-g">green</xxf:control>
                        <xxf:control id="my-control·7" class="foo-bar-is-not-g">williams</xxf:control>
                        <xxf:control id="my-control·8" class="foo-bar-is-not-g">yellow</xxf:control>
                    </xxf:control-values>
                </xxf:action>
            </xxf:event-response>
        </output>
    </test>

    <test description="Extension MIP XPath functions" name="oxf:pipeline">
        <input name="config">
            <p:config xmlns:oxf="http://www.orbeon.com/oxf/processors"
                      xmlns:xxforms="http://orbeon.org/oxf/xml/xforms">
                <p:param name="response" type="output"/>

                <p:processor name="oxf:pipeline">
                    <p:input name="config" href="wrap-xforms-state.xpl"/>
                    <p:input name="document">
                        <xhtml:html>
                            <xhtml:head>
                                <xforms:model id="model">
                                    <xforms:instance id="instance">
                                        <instance xmlns="">
                                            <readonly/>
                                            <required/>
                                            <relevant/>
                                            <valid/>
                                        </instance>
                                    </xforms:instance>

                                    <xforms:bind nodeset="readonly" readonly="true()"/>
                                    <xforms:bind nodeset="required" required="true()"/>

                                    <xforms:bind nodeset="relevant" relevant="false()"/>
                                    <xforms:bind nodeset="valid" constraint="false()"/>
                                </xforms:model>
                            </xhtml:head>
                            <xhtml:body xmlns:exforms="http://www.exforms.org/exf/1-0">

                                <!-- Test a few possibilities -->
                                <xforms:output id="output-readonly-1" ref=".[exforms:readonly(readonly)]" value="'I am readonly'"/>
                                <xforms:output id="output-readonly-2" ref="readonly[exforms:readonly()]" value="'I am readonly'"/>
                                <xforms:output id="output-required-1" ref=".[exforms:required(required)]" value="'I am required'"/>
                                <xforms:output id="output-required-2" ref="required[exforms:required()]" value="'I am required'"/>

                                <xforms:output id="output-relevant" ref=".[not(exforms:relevant(relevant))]" value="'I am not relevant'"/>

                                <xforms:output id="output-valid-1" ref=".[not(xxforms:valid(valid))]" value="'I am not valid'"/>
                                <xforms:output id="output-valid-2" ref="valid[not(xxforms:valid())]" value="'I am not valid'"/>

                            </xhtml:body>
                        </xhtml:html>
                    </p:input>
                    <p:output name="response" ref="response"/>
                </p:processor>

            </p:config>
        </input>
        <output name="response">
            <xxf:event-response xmlns:xxf="http://orbeon.org/oxf/xml/xforms">
                <xxf:dynamic-state>
                    <dynamic-state>
                        <instances>
                            <instance id="instance" model-id="model">
                                <instance>
                                    <readonly/>
                                    <required/>
                                    <relevant/>
                                    <valid/>
                                </instance>
                            </instance>
                        </instances>
                    </dynamic-state>
                </xxf:dynamic-state>
                <xxf:action>
                    <xxf:control-values>
                        <xxf:control id="output-readonly-1">I am readonly</xxf:control>
                        <xxf:control id="output-readonly-2" readonly="true">I am readonly</xxf:control>
                        <xxf:control id="output-required-1">I am required</xxf:control>
                        <xxf:control id="output-required-2" required="true" valid="false">I am required</xxf:control>
                        <xxf:control id="output-relevant">I am not relevant</xxf:control>
                        <xxf:control id="output-valid-1">I am not valid</xxf:control>
                        <xxf:control id="output-valid-2" valid="false">I am not valid</xxf:control>
                    </xxf:control-values>
                </xxf:action>
            </xxf:event-response>
        </output>
    </test>

    <test description="Inter-model dependency fix with xforms:recalculate action" name="oxf:pipeline">
        <input name="config">
            <p:config xmlns:oxf="http://www.orbeon.com/oxf/processors"
                      xmlns:xxforms="http://orbeon.org/oxf/xml/xforms">
                <p:param name="response" type="output"/>

                <p:processor name="oxf:pipeline">
                    <p:input name="config" href="wrap-xforms-state.xpl"/>
                    <p:input name="document">
                        <xhtml:html>
                            <xhtml:head>
                                <xforms:model id="form-model">
                                    <!-- Form instance -->
                                    <xforms:instance id="form-instance">
                                        <first-name xmlns=""/>
                                    </xforms:instance>
                                    <!-- Value is always invalid -->
                                    <xforms:bind nodeset="." constraint="false()"/>
                                </xforms:model>

                                <xforms:model id="errors-model">

                                    <!-- This will be set to "false" during initial refresh -->
                                    <xforms:instance id="form-valid-instance">
                                        <valid xmlns="">true</valid>
                                    </xforms:instance>

                                </xforms:model>

                                <xforms:model id="persistence-model">

                                    <xforms:instance id="triggers-instance">
                                        <submit xmlns=""/>
                                    </xforms:instance>
                                    <!-- Cross-model dependency with xxforms:instance() won't update without explicit xf:recalculate -->
                                    <xforms:bind nodeset="." readonly="xxforms:instance('form-valid-instance') = 'false'"/>

                                </xforms:model>
                            </xhtml:head>
                            <xhtml:body>

                                <xforms:group>
                                    <xforms:action ev:event="xforms-invalid">
                                        <xforms:setvalue model="errors-model" ref="instance('form-valid-instance')">false</xforms:setvalue>
                                        <!-- Force recalculate -->
                                        <xforms:recalculate model="persistence-model"/>
                                    </xforms:action>

                                    <!-- Data will be invalid -->
                                    <xforms:input id="first-name-control" ref=".">
                                        <xforms:label>First name</xforms:label>
                                    </xforms:input>

                                    <!-- This must be read-only -->
                                    <xforms:trigger id="submit-trigger" model="persistence-model" ref=".">
                                        <xforms:label>Submit</xforms:label>
                                    </xforms:trigger>
                                </xforms:group>

                            </xhtml:body>
                        </xhtml:html>
                    </p:input>
                    <p:output name="response" ref="response"/>
                </p:processor>

            </p:config>
        </input>
        <output name="response">
            <xxf:event-response xmlns:xxf="http://orbeon.org/oxf/xml/xforms">
                <xxf:dynamic-state>
                    <dynamic-state>
                        <instances>
                            <instance id="form-instance" model-id="form-model">
                                <first-name/>
                            </instance>
                            <instance id="form-valid-instance" model-id="errors-model">
                                <valid>false</valid>
                            </instance>
                            <instance id="triggers-instance" model-id="persistence-model">
                                <submit/>
                            </instance>
                        </instances>
                    </dynamic-state>
                </xxf:dynamic-state>
                <xxf:action>
                    <xxf:control-values>
                        <xxf:control id="first-name-control" label="First name" valid="false"/>
                        <xxf:control id="submit-trigger" label="Submit" readonly="true"/>
                    </xxf:control-values>
                </xxf:action>
            </xxf:event-response>
        </output>
    </test>

    <test description="xxforms:type() function" name="oxf:pipeline">
        <input name="config">
            <p:config xmlns:oxf="http://www.orbeon.com/oxf/processors"
                      xmlns:xxforms="http://orbeon.org/oxf/xml/xforms"
                      xmlns:xs="http://www.w3.org/2001/XMLSchema"
                      xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">
                <p:param name="response" type="output"/>

                <p:processor name="oxf:pipeline">
                    <p:input name="config" href="wrap-xforms-state.xpl"/>
                    <p:input name="document">
                        <xhtml:html>
                            <xhtml:head>
                                <xforms:model id="form-model">
                                    <xforms:instance id="values">
                                        <values xmlns="" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">
                                            <value nodetype="" valuetype="">Lucy</value>
                                            <value xsi:type="xs:integer" nodetype="" valuetype="">35</value>
                                            <value xsi:type="xs:boolean" nodetype="" valuetype="">false</value>
                                            <value xsi:type="xs:date" nodetype="" valuetype="">1980-01-01</value>
                                            <value xsi:type="xs:time" nodetype="" valuetype="">12:00:00</value>
                                            <value xsi:type="xs:double" nodetype="" valuetype="">12E1</value>
                                            <value xsi:type="xs:string" nodetype="" valuetype="">Lucy</value>
                                        </values>
                                    </xforms:instance>

                                    <xforms:action ev:event="xforms-ready">

                                        <xforms:action xxforms:iterate="*">
                                            <xforms:setvalue ref="@nodetype" value="xxforms:type(context())"/>
                                        </xforms:action>

                                        <xforms:setvalue ref="*[1]/@valuetype" value="xxforms:type('Lucy')"/>
                                        <xforms:setvalue ref="*[2]/@valuetype" value="xxforms:type(35)"/>
                                        <xforms:setvalue ref="*[3]/@valuetype" value="xxforms:type(false())"/>
                                        <xforms:setvalue ref="*[4]/@valuetype" value="xxforms:type(xs:date('1980-01-01'))"/>
                                        <xforms:setvalue ref="*[5]/@valuetype" value="xxforms:type(xs:time('12:00:00'))"/>
                                        <xforms:setvalue ref="*[6]/@valuetype" value="xxforms:type(12E1)"/>
                                        <xforms:setvalue ref="*[7]/@valuetype" value="xxforms:type('Lucy')"/>
                                    </xforms:action>

                                </xforms:model>
                            </xhtml:head>
                            <xhtml:body>
                            </xhtml:body>
                        </xhtml:html>
                    </p:input>
                    <p:output name="response" ref="response"/>
                </p:processor>

            </p:config>
        </input>
        <output name="response">
            <xxf:event-response xmlns:xxf="http://orbeon.org/oxf/xml/xforms">
                <xxf:dynamic-state>
                    <dynamic-state>
                        <instances>
                            <instance id="values" model-id="form-model">
                                <values xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">
                                    <value nodetype="" valuetype="xs:string">Lucy</value>
                                    <value xsi:type="xs:integer" nodetype="integer" valuetype="xs:integer">35</value>
                                    <value xsi:type="xs:boolean" nodetype="boolean" valuetype="xs:boolean">false</value>
                                    <value xsi:type="xs:date" nodetype="date" valuetype="xs:date">1980-01-01</value>
                                    <value xsi:type="xs:time" nodetype="time" valuetype="xs:time">12:00:00</value>
                                    <value xsi:type="xs:double" nodetype="double" valuetype="xs:double">12E1</value>
                                    <value xsi:type="xs:string" nodetype="string" valuetype="xs:string">Lucy</value>
                                </values>
                            </instance>
                        </instances>
                    </dynamic-state>
                </xxf:dynamic-state>
                <xxf:action>
                    <xxf:control-values/>
                </xxf:action>
            </xxf:event-response>
        </output>
    </test>

    <test description="Test type annotations" name="oxf:pipeline">
        <input name="config">
            <p:config xmlns:oxf="http://www.orbeon.com/oxf/processors"
                      xmlns:xxforms="http://orbeon.org/oxf/xml/xforms"
                      xmlns:xs="http://www.w3.org/2001/XMLSchema"
                      xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">
                <p:param name="response" type="output"/>

                <p:processor name="oxf:pipeline">
                    <p:input name="config" href="wrap-xforms-state.xpl"/>
                    <p:input name="document">
                        <xhtml:html>
                            <xhtml:head>
                                <xforms:model id="form-model" xxforms:expose-xpath-types="true">
                                    <xforms:instance id="values">
                                        <values xmlns="" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">
                                            <value>Lucy</value>
                                            <value xsi:type="xs:integer">35</value>
                                            <value xsi:type="xs:boolean">false</value>
                                            <value xsi:type="xs:date">1980-01-01</value>
                                            <value xsi:type="xs:time">12:00:00</value>
                                            <value xsi:type="xs:double">12.5E0</value>
                                            <value xsi:type="xs:string">Lucy</value>
                                        </values>
                                    </xforms:instance>
                                </xforms:model>
                            </xhtml:head>
                            <xhtml:body>
                                <xforms:output id="output-string" value="value[1]"/>
                                <xforms:output id="output-integer" value="value[2] + 1"/>
                                <xforms:output id="output-boolean" value="false() != value[3]"/>
                                <xforms:output id="output-date" value="value[4] + xs:dayTimeDuration('P1D')"/>
                                <xforms:output id="output-time" value="value[5] + xs:dayTimeDuration('PT10H30M')"/>
                                <xforms:output id="output-double" value="value[6] + .5"/>
                                <xforms:output id="output-string-2" value="value[7]"/>
                            </xhtml:body>
                        </xhtml:html>
                    </p:input>
                    <p:output name="response" ref="response"/>
                </p:processor>

            </p:config>
        </input>
        <output name="response">
            <xxf:event-response xmlns:xxf="http://orbeon.org/oxf/xml/xforms">
                <xxf:dynamic-state>
                    <dynamic-state>
                        <instances>
                            <instance id="values" model-id="form-model" types="true">
                                <values xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">
                                    <value>Lucy</value>
                                    <value xsi:type="xs:integer">35</value>
                                    <value xsi:type="xs:boolean">false</value>
                                    <value xsi:type="xs:date">1980-01-01</value>
                                    <value xsi:type="xs:time">12:00:00</value>
                                    <value xsi:type="xs:double">12.5E0</value>
                                    <value xsi:type="xs:string">Lucy</value>
                                </values>
                            </instance>
                        </instances>
                    </dynamic-state>
                </xxf:dynamic-state>
                <xxf:action>
                    <xxf:control-values>
                        <xxf:control id="output-string">Lucy</xxf:control>
                        <xxf:control id="output-integer">36</xxf:control>
                        <xxf:control id="output-boolean">false</xxf:control>
                        <xxf:control id="output-date">1980-01-02</xxf:control>
                        <xxf:control id="output-time">22:30:00</xxf:control>
                        <xxf:control id="output-double">13</xxf:control>
                        <xxf:control id="output-string-2">Lucy</xxf:control>
                    </xxf:control-values>
                </xxf:action>
            </xxf:event-response>
        </output>
    </test>

    <test description="xxforms-valid/xxforms-invalid" name="oxf:pipeline">
        <input name="config">
            <p:config xmlns:oxf="http://www.orbeon.com/oxf/processors"
                      xmlns:xxforms="http://orbeon.org/oxf/xml/xforms"
                      xmlns:xs="http://www.w3.org/2001/XMLSchema"
                      xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">
                <p:param name="response" type="output"/>

                <p:processor name="oxf:pipeline">
                    <p:input name="config" href="wrap-xforms-state.xpl"/>
                    <p:input name="document">
                        <xhtml:html>
                            <xhtml:head>
                                <xforms:model id="model">

                                    <xforms:instance id="value" xmlns="">
                                        <value/>
                                    </xforms:instance>
                                    <xforms:bind nodeset="instance('value')" required="true()" />

                                    <xforms:instance id="validity">
                                        <validity/>
                                    </xforms:instance>

                                    <xforms:action ev:event="xxforms-valid" ev:observer="value">
                                        <xforms:insert context="instance('validity')" nodeset="*" origin="xxforms:element('valid')" />
                                    </xforms:action>
                                    <xforms:action ev:event="xxforms-invalid" ev:observer="value">
                                        <xforms:insert context="instance('validity')" nodeset="*" origin="xxforms:element('invalid')" />
                                    </xforms:action>

                                    <xforms:setvalue ev:event="xforms-ready" ref="instance('value')">42</xforms:setvalue>

                                </xforms:model>
                            </xhtml:head>
                            <xhtml:body>
                                <xforms:input id="my-input" ref="instance('value')"/>
                            </xhtml:body>
                        </xhtml:html>
                    </p:input>
                    <p:output name="response" ref="response"/>
                </p:processor>

            </p:config>
        </input>
        <output name="response">
            <xxf:event-response xmlns:xxf="http://orbeon.org/oxf/xml/xforms">
                <xxf:dynamic-state>
                    <dynamic-state>
                        <instances>
                            <instance id="value" model-id="model">
                                <value>42</value>
                            </instance>
                            <instance id="validity" model-id="model">
                                <validity>
                                    <invalid/>
                                    <valid/>
                                </validity>
                            </instance>
                        </instances>
                    </dynamic-state>
                </xxf:dynamic-state>
                <xxf:action>
                    <xxf:control-values>
                        <xxf:control id="my-input" required="true">42</xxf:control>
                    </xxf:control-values>
                </xxf:action>
            </xxf:event-response>
        </output>
    </test>
    
    <test description="Simple use of xxforms:evaluate-bind-property function" name="oxf:pipeline">
        <input name="config" href="wrap-xforms-state.xpl"/>
        <input name="document">
            <xhtml:html xmlns:xxforms="http://orbeon.org/oxf/xml/xforms" xmlns:xs="http://www.w3.org/2001/XMLSchema">
                <xhtml:head>
                    <xforms:model id="model">
                        <xforms:instance id="instance">
                            <instance>
                                <foo/>
                                <bar>43</bar>
                            </instance>
                        </xforms:instance>
                        <xforms:bind id="foo-bind" nodeset="foo"
                                     xxforms:default="42"
                                     relevant=". = 86"
                                     calculate="xs:integer(../bar) * 2"
                                     readonly="false()"
                                     required="true()"
                                     type="xs:integer"/>
                    </xforms:model>
                </xhtml:head>
                <xhtml:body>
                    <xforms:output id="output-relevant" value="xxforms:evaluate-bind-property('foo-bind', 'relevant')"/>
                    <xforms:output id="output-readonly" value="xxforms:evaluate-bind-property('foo-bind', 'readonly')"/>
                    <xforms:output id="output-required" value="xxforms:evaluate-bind-property('foo-bind', 'required')"/>
                    <xforms:output id="output-type" value="xxforms:evaluate-bind-property('foo-bind', 'type')"/>
                    <xforms:output id="output-constraint" value="xxforms:evaluate-bind-property('foo-bind', 'constraint')"/>
                    <xforms:output id="output-calculate" value="xxforms:evaluate-bind-property('foo-bind', 'calculate')"/>
                    <xforms:output id="output-default" value="xxforms:evaluate-bind-property('foo-bind', 'xxforms:default')"/>
                </xhtml:body>
            </xhtml:html>
        </input>
        <output name="response">
           <xxf:event-response xmlns:xxf="http://orbeon.org/oxf/xml/xforms">
                <xxf:dynamic-state>
                    <dynamic-state>
                        <instances>
                            <instance id="instance" model-id="model">
                                <instance>
                                    <foo>86</foo>
                                    <bar>43</bar>
                                </instance>
                            </instance>
                        </instances>
                    </dynamic-state>
                </xxf:dynamic-state>
                <xxf:action>
                    <xxf:control-values>
                        <xxf:control id="output-relevant">true</xxf:control>
                        <xxf:control id="output-readonly">false</xxf:control>
                        <xxf:control id="output-required">true</xxf:control>
                        <xxf:control id="output-type">xs:integer</xxf:control>
                        <xxf:control id="output-calculate">86</xxf:control>
                        <xxf:control id="output-default">42</xxf:control>
                    </xxf:control-values>
                </xxf:action>
            </xxf:event-response>
        </output>
    </test>

    <test description="xxforms:evaluate-bind-property function within nested nested binds with repeat" name="oxf:pipeline">
        <input name="config" href="wrap-xforms-state.xpl"/>
        <input name="document">
            <xhtml:html xmlns:xxforms="http://orbeon.org/oxf/xml/xforms" xmlns:xs="http://www.w3.org/2001/XMLSchema"
                        xmlns:foo="http://orbeon.org/oxf/xml/foo">
                <xhtml:head>
                    <xforms:model id="model">
                        <xforms:instance id="instance">
                            <instance>
                                <foo bar=""/>
                                <foo bar=""/>
                                <foo bar=""/>
                                <foo bar=""/>
                            </instance>
                        </xforms:instance>
                        <xforms:bind id="foo-bind" nodeset="foo">
                            <xforms:bind id="value-bind" nodeset="."
                                         xxforms:default="count(preceding-sibling::foo) + 42"
                                         relevant="count(preceding-sibling::foo) mod 2 = 0"
                                         readonly="count(preceding-sibling::foo) mod 3 = 0"
                                         required="count(preceding-sibling::foo) mod 4 = 0"
                                         type="xs:integer"
                                         constraint="xs:integer(.) le 43"
                                         foo:bar="string-join((., @bar), ', ')"
                                         />
                            <xforms:bind id="bar-bind" nodeset="@bar" calculate=".. + 1"/>

                        </xforms:bind>
                    </xforms:model>
                </xhtml:head>
                <xhtml:body>
                    <xforms:repeat bind="foo-bind" id="repeat">
                        <xforms:output id="output-relevant" value="xxforms:evaluate-bind-property('value-bind', 'relevant')"/>
                        <xforms:output id="output-readonly" value="xxforms:evaluate-bind-property('value-bind', 'readonly')"/>
                        <xforms:output id="output-required" value="xxforms:evaluate-bind-property('value-bind', 'required')"/>
                        <xforms:output id="output-type" value="xxforms:evaluate-bind-property('value-bind', 'type')"/>
                        <xforms:output id="output-constraint" value="xxforms:evaluate-bind-property('value-bind', 'constraint')"/>
                        <xforms:output id="output-default" value="xxforms:evaluate-bind-property('value-bind', 'xxforms:default')"/>
                        <xforms:output id="output-custom" value="xxforms:evaluate-bind-property('value-bind', 'foo:bar')"/>

                        <xforms:output id="output-calculate" value="xxforms:evaluate-bind-property('bar-bind', 'calculate')"/>
                    </xforms:repeat>
                </xhtml:body>
            </xhtml:html>
        </input>
        <output name="response">
           <xxf:event-response xmlns:xxf="http://orbeon.org/oxf/xml/xforms">
                <xxf:dynamic-state>
                    <dynamic-state>
                        <instances>
                            <instance id="instance" model-id="model">
                                <instance>
                                    <foo bar="43">42</foo>
                                    <foo bar="44">43</foo>
                                    <foo bar="45">44</foo>
                                    <foo bar="46">45</foo>
                                </instance>
                            </instance>
                        </instances>
                        <controls>
                            <control effective-id="repeat" index="1"/>
                        </controls>
                    </dynamic-state>
                </xxf:dynamic-state>
                <xxf:action>
                    <xxf:control-values>
                        <xxf:control id="output-relevant·1">true</xxf:control>
                        <xxf:control id="output-readonly·1">true</xxf:control>
                        <xxf:control id="output-required·1">true</xxf:control>
                        <xxf:control id="output-type·1">xs:integer</xxf:control>
                        <xxf:control id="output-constraint·1">true</xxf:control>
                        <xxf:control id="output-default·1">42</xxf:control>
                        <xxf:control id="output-custom·1">42, 43</xxf:control>
                        <xxf:control id="output-calculate·1">43</xxf:control>
                        <xxf:repeat-iteration id="repeat" relevant="false" iteration="2"/>
                        <xxf:control id="output-relevant·2" relevant="false"/>
                        <xxf:control id="output-readonly·2" relevant="false"/>
                        <xxf:control id="output-required·2" relevant="false"/>
                        <xxf:control id="output-type·2" relevant="false"/>
                        <xxf:control id="output-constraint·2" relevant="false"/>
                        <xxf:control id="output-default·2" relevant="false"/>
                        <xxf:control id="output-custom·2" relevant="false"/>
                        <xxf:control id="output-calculate·2" relevant="false"/>
                        <xxf:control id="output-relevant·3">true</xxf:control>
                        <xxf:control id="output-readonly·3">false</xxf:control>
                        <xxf:control id="output-required·3">false</xxf:control>
                        <xxf:control id="output-type·3">xs:integer</xxf:control>
                        <xxf:control id="output-constraint·3">false</xxf:control>
                        <xxf:control id="output-default·3">44</xxf:control>
                        <xxf:control id="output-custom·3">44, 45</xxf:control>
                        <xxf:control id="output-calculate·3">45</xxf:control>
                        <xxf:repeat-iteration id="repeat" relevant="false" iteration="4"/>
                        <xxf:control id="output-relevant·4" relevant="false"/>
                        <xxf:control id="output-readonly·4" relevant="false"/>
                        <xxf:control id="output-required·4" relevant="false"/>
                        <xxf:control id="output-type·4" relevant="false"/>
                        <xxf:control id="output-constraint·4" relevant="false"/>
                        <xxf:control id="output-default·4" relevant="false"/>
                        <xxf:control id="output-custom·4" relevant="false"/>
                        <xxf:control id="output-calculate·4" relevant="false"/>
                    </xxf:control-values>
                </xxf:action>
            </xxf:event-response>
        </output>
    </test>
    
    <test description="Initial build of controls may use out of date binds" name="oxf:pipeline">
        <input name="config" href="wrap-xforms-state.xpl"/>
        <input name="document">
            <xhtml:html xmlns:xxforms="http://orbeon.org/oxf/xml/xforms" xmlns:xs="http://www.w3.org/2001/XMLSchema">
                <xhtml:head>
                    <xforms:model id="fr-persistence-model">
                        <xforms:instance id="fr-persistence-instance">
                            <save xmlns="">
                                <data-status>clean</data-status>
                            </save>
                        </xforms:instance>
                        <xforms:instance id="fr-triggers-instance">
                            <triggers xmlns="">
                                <save/>
                            </triggers>
                        </xforms:instance>
                        <xforms:bind nodeset="instance('fr-triggers-instance')">
                            <xforms:bind nodeset="save" readonly="instance('fr-persistence-instance')/data-status = 'clean'"/>
                        </xforms:bind>

                        <xforms:submission id="fr-get-document-submission" serialization="none"
                                           method="get" resource="oxf:/apps/xforms-sandbox/samples/bugs/bug-events-data.xml"
                                           replace="instance" xxforms:instance="fr-form-instance"/>

                        <xforms:action ev:event="xforms-model-construct-done">
                            <xforms:send submission="fr-get-document-submission"/>
                        </xforms:action>

                        <xforms:action ev:event="xforms-ready">
                            <xforms:rebuild/>
                            <xforms:recalculate/>
                            <xforms:revalidate/>
                            <xforms:refresh/>

                            <xforms:setvalue ref="instance('fr-persistence-instance')/data-status" value="'clean'"/>
                        </xforms:action>
                    </xforms:model>
                    <xforms:model id="fr-form-model">
                        <xforms:instance id="fr-form-instance">
                            <book>
                                <title/>
                            </book>
                        </xforms:instance>
                        <xforms:bind id="title-bind" nodeset="title"/>
                    </xforms:model>
                </xhtml:head>
                <xhtml:body>
                    <xhtml:p>
                        See <a
                        href="http://forge.objectweb.org/tracker/index.php?func=detail&amp;aid=312406&amp;group_id=168&amp;atid=350207">fixed</a>.
                        Proper behavior is that the Save button is disabled upon page load.
                    </xhtml:p>
                    <xforms:group model="fr-form-model">
                        <xforms:input id="title-input" bind="title-bind">
                            <xforms:label>Note</xforms:label>
                        </xforms:input>
                        <xforms:setvalue ev:event="xforms-value-changed xforms-enabled" model="fr-persistence-model" ref="instance('fr-persistence-instance')/data-status" value="'dirty'"/>
                    </xforms:group>
                    <xforms:trigger id="save-trigger" ref="instance('fr-triggers-instance')/save">
                        <xforms:label>Save</xforms:label>
                    </xforms:trigger>
                </xhtml:body>
            </xhtml:html>
        </input>
        <output name="response">
           <xxf:event-response xmlns:xxf="http://orbeon.org/oxf/xml/xforms">
                <xxf:dynamic-state>
                    <dynamic-state>
                        <instances>
                            <instance id="fr-persistence-instance" model-id="fr-persistence-model">
                                <save>
                                    <data-status>clean</data-status>
                                </save>
                            </instance>
                            <instance id="fr-triggers-instance" model-id="fr-persistence-model">
                                <triggers>
                                    <save/>
                                </triggers>
                            </instance>
                            <instance id="fr-form-instance" model-id="fr-form-model" source-uri="oxf:/apps/xforms-sandbox/samples/bugs/bug-events-data.xml" replaced="true">
                                <!--
  Copyright (C) 2009 Orbeon, Inc.

  This program is free software; you can redistribute it and/or modify it under the terms of the
  GNU Lesser General Public License as published by the Free Software Foundation; either version
  2.1 of the License, or (at your option) any later version.

  This program is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY;
  without even the implied warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.
  See the GNU Lesser General Public License for more details.

  The full text of the license is available at http://www.gnu.org/copyleft/lesser.html
  -->
                                <book>
                                    <title>Cool title</title>
                                </book>
                            </instance>
                        </instances>
                    </dynamic-state>
                </xxf:dynamic-state>
                <xxf:action>
                    <xxf:control-values>
                        <xxf:control id="title-input" label="Note">Cool title</xxf:control>
                        <xxf:control id="save-trigger" label="Save" readonly="true"/>
                    </xxf:control-values>
                </xxf:action>
            </xxf:event-response>
        </output>
    </test>

    <test description="Reference to nested bind within empty nodeset" name="oxf:pipeline">
        <input name="config">
            <p:config xmlns:oxf="http://www.orbeon.com/oxf/processors" xmlns:xxforms="http://orbeon.org/oxf/xml/xforms" xmlns:xforms="http://www.w3.org/2002/xforms">
                <p:param name="response" type="output"/>

                <p:processor name="oxf:pipeline">
                    <p:input name="config" href="wrap-xforms-state.xpl"/>
                    <p:input name="document">
                        <xhtml:html>
                            <xhtml:head>
                                <xforms:model>
                                    <xforms:instance>
                                        <instance>
                                            <company>
                                                <employee/>
                                                <employee/>
                                            </company>
                                            <company>
                                                <employee/>
                                                <employee/>
                                            </company>
                                        </instance>
                                    </xforms:instance>
                                    <xforms:bind nodeset="company" id="companies">
                                        <xforms:bind nodeset="employee" id="employees"/>
                                    </xforms:bind>
                                    <xforms:bind nodeset="foo" id="foos">
                                        <xforms:bind nodeset="bar" id="bars"/>
                                    </xforms:bind>
                                </xforms:model>
                            </xhtml:head>
                            <xhtml:body>
                                <!-- Must be non-relevant because the context item does not match -->
                                <xforms:input bind="employees" id="input1"/>
                                <!-- Must be non-relevant because the node-set is empty -->
                                <xforms:input bind="foos" id="input2"/>

                                <!-- Must be relevant because the context item matches -->
                                <xforms:group bind="companies" id="group1">
                                    <xforms:input bind="employees" id="input3"/>
                                </xforms:group>

                                <!-- Must be non-relevant -->
                                <xforms:group bind="foos" id="group2">
                                    <xforms:input bind="bars" id="input4"/>
                                </xforms:group>
                            </xhtml:body>
                        </xhtml:html>
                    </p:input>
                    <p:output name="response" ref="response"/>
                </p:processor>
            </p:config>
        </input>
        <output name="response">
            <xxf:event-response xmlns:xxf="http://orbeon.org/oxf/xml/xforms">
                <xxf:dynamic-state>
                    <dynamic-state>
                        <instances>
                            <instance id="xf-2" model-id="xf-1">
                                <instance>
                                    <company>
                                        <employee/>
                                        <employee/>
                                    </company>
                                    <company>
                                        <employee/>
                                        <employee/>
                                    </company>
                                </instance>
                            </instance>
                        </instances>
                    </dynamic-state>
                </xxf:dynamic-state>
                <xxf:action>
                    <xxf:control-values>
                        <xxf:control id="input1" relevant="false"/>
                        <xxf:control id="input2" relevant="false"/>
                        <xxf:control id="group2" relevant="false"/>
                        <xxf:control id="input4" relevant="false"/>
                    </xxf:control-values>
                </xxf:action>
            </xxf:event-response>
        </output>
    </test>

    <test description="Use of xforms:bind/@ref and xforms:repeat/@ref" name="oxf:pipeline">
        <input name="config">
            <p:config xmlns:oxf="http://www.orbeon.com/oxf/processors" xmlns:xxforms="http://orbeon.org/oxf/xml/xforms" xmlns:xforms="http://www.w3.org/2002/xforms">
                <p:param name="response" type="output"/>

                <p:processor name="oxf:pipeline">
                    <p:input name="config" href="wrap-xforms-state.xpl"/>
                    <p:input name="document">
                        <xhtml:html>
                            <xhtml:head>
                                <xforms:model id="model">
                                    <xforms:instance id="instance">
                                        <instance>
                                            <company>
                                                <employee>Mickey</employee>
                                                <employee>Minnie</employee>
                                            </company>
                                            <company>
                                                <employee>Donald</employee>
                                                <employee>Daisy</employee>
                                            </company>
                                        </instance>
                                    </xforms:instance>
                                    <xforms:bind ref="company" id="companies">
                                        <xforms:bind ref="employee" id="employees"/>
                                    </xforms:bind>
                                </xforms:model>
                            </xhtml:head>
                            <xhtml:body>
                                <xforms:repeat bind="companies" id="repeat1">
                                    <xforms:repeat bind="employees" id="repeat2">
                                        <xforms:input ref="." id="input1"/>
                                    </xforms:repeat>
                                </xforms:repeat>

                                <xforms:group bind="companies" id="group1">
                                    <xforms:input bind="employees" id="input2"/>
                                </xforms:group>
                            </xhtml:body>
                        </xhtml:html>
                    </p:input>
                    <p:output name="response" ref="response"/>
                </p:processor>
            </p:config>
        </input>
        <output name="response">
            <xxf:event-response xmlns:xxf="http://orbeon.org/oxf/xml/xforms">
                <xxf:dynamic-state>
                    <dynamic-state>
                        <instances>
                            <instance id="instance" model-id="model">
                                <instance>
                                    <company>
                                        <employee>Mickey</employee>
                                        <employee>Minnie</employee>
                                    </company>
                                    <company>
                                        <employee>Donald</employee>
                                        <employee>Daisy</employee>
                                    </company>
                                </instance>
                            </instance>
                        </instances>
                        <controls>
                            <control effective-id="repeat1" index="1"/>
                            <control effective-id="repeat2·1" index="1"/>
                            <control effective-id="repeat2·2" index="1"/>
                        </controls>
                    </dynamic-state>
                </xxf:dynamic-state>
                <xxf:action>
                    <xxf:control-values>
                        <xxf:control id="input1·1-1">Mickey</xxf:control>
                        <xxf:control id="input1·1-2">Minnie</xxf:control>
                        <xxf:control id="input1·2-1">Donald</xxf:control>
                        <xxf:control id="input1·2-2">Daisy</xxf:control>
                        <xxf:control id="input2">Mickey</xxf:control>
                    </xxf:control-values>
                </xxf:action>
            </xxf:event-response>
        </output>
    </test>

    <test description="Output classes for custom types" name="oxf:pipeline">
        <input name="config" href="wrap-xforms-controls.xpl"/>
        <input name="document">
            <xhtml:html xmlns:xxforms="http://orbeon.org/oxf/xml/xforms" xmlns:foo="http://orbeon.org/oxf/xml/foo">
                <xhtml:head>
                    <xforms:model id="model">

                        <xs:schema targetNamespace="http://orbeon.org/oxf/xml/foo" attributeFormDefault="unqualified" elementFormDefault="qualified">
                            <xs:element name="myElement" type="foo:myType"/>
                            <xs:complexType name="myType">
                                <xs:simpleContent>
                                    <xs:restriction base="xs:string">
                                        <xs:minLength value="1"/>
                                    </xs:restriction>
                                </xs:simpleContent>
                            </xs:complexType>
                        </xs:schema>

                        <xforms:instance id="instance">
                            <instance>
                                <!-- Will be picked by LAX validation -->
                                <foo:myElement>cA</foo:myElement>
                                <!-- Explicitly associated with type -->
                                <bar>CA</bar>
                            </instance>
                        </xforms:instance>
                        <xforms:bind id="bind1" nodeset="bar" type="foo:myType"/>
                    </xforms:model>
                </xhtml:head>
                <xhtml:body>
                    <!-- NOTE: A possible MSV bug: it doesn't return the type name in this case. So we don't get the right class name on my-input1 -->
                    <xforms:input ref="foo:myElement" id="my-input1"/>
                    <xforms:input ref="bar" id="my-input2"/>
                </xhtml:body>
            </xhtml:html>
        </input>
        <output name="response">
            <controls xmlns:xhtml="http://www.w3.org/1999/xhtml">
                <xhtml:span id="my-input1" class="xforms-control xforms-input">
                    <xhtml:input id="my-input1$xforms-input-1" type="text" name="my-input1$xforms-input-1" value="cA" class="xforms-input-input"/>
                </xhtml:span>
                <xhtml:span id="my-input2" class="xforms-control xforms-input xforms-type-custom-myType">
                    <xhtml:input id="my-input2$xforms-input-1" type="text" name="my-input2$xforms-input-1" value="CA" class="xforms-input-input"/>
                </xhtml:span>
            </controls>
        </output>
    </test>

    <test description="xforms:recalculate/action forcing recalculation of initial values" name="oxf:pipeline">
        <input name="config" href="wrap-xforms-state.xpl"/>
        <input name="document">
            <xhtml:html xmlns:xxforms="http://orbeon.org/oxf/xml/xforms" xmlns:xs="http://www.w3.org/2001/XMLSchema">
                <xhtml:head>
                    <xforms:model id="model">
                        <xforms:instance id="instance">
                            <instance>
                                <date/>
                                <date1/>
                                <date2/>
                            </instance>
                        </xforms:instance>
                        <xforms:bind id="date-bind" ref="date" type="xs:date" xxforms:default="xs:date('2001-01-01')"/>

                        <xforms:action ev:event="xforms-ready">
                            <!-- Copy first initial value -->
                            <xforms:setvalue ref="date1" value="xxforms:bind('date-bind')"/>
                            <!-- Override initial value and copy it -->
                            <xforms:setvalue bind="date-bind" value="xs:date('2010-05-28')"/>
                            <xforms:setvalue ref="date2" value="xxforms:bind('date-bind')"/>
                            <!-- Recalculate must restore initial value -->
                            <xforms:recalculate xxforms:defaults="true"/>
                        </xforms:action>

                    </xforms:model>
                </xhtml:head>
                <xhtml:body>
                    <xforms:input bind="date-bind" id="my-input"/>
                </xhtml:body>
            </xhtml:html>
        </input>
        <output name="response">
            <xxf:event-response xmlns:xxf="http://orbeon.org/oxf/xml/xforms">
                <xxf:dynamic-state>
                    <dynamic-state>
                        <instances>
                            <instance id="instance" model-id="model">
                                <instance>
                                    <date>2001-01-01</date>
                                    <date1>2001-01-01</date1>
                                    <date2>2010-05-28</date2>
                                </instance>
                            </instance>
                        </instances>
                    </dynamic-state>
                </xxf:dynamic-state>
                <xxf:action>
                    <xxf:control-values>
                        <xxf:control id="my-input" type="{http://www.w3.org/2001/XMLSchema}date">2001-01-01</xxf:control>
                    </xxf:control-values>
                </xxf:action>
            </xxf:event-response>
        </output>
    </test>

    <test description="xxf:invalid-binds() returns correct bind id with required-but-empty and constraint" name="oxf:pipeline">
        <!-- See http://forge.ow2.org/tracker/index.php?func=detail&aid=315460&group_id=168&atid=350207 -->
        <input name="config" href="wrap-xforms-state.xpl"/>
        <input name="document">
            <xhtml:html xmlns:xxforms="http://orbeon.org/oxf/xml/xforms" xmlns:xs="http://www.w3.org/2001/XMLSchema">
                <xhtml:head>
                    <xforms:model id="model">
                        <xforms:instance id="instance">
                            <instance>
                                <value1/>
                                <value2/>
                            </instance>
                        </xforms:instance>
                        <xforms:bind id="constraint-bind1" ref="value1" constraint="true()"/>
                        <xforms:bind id="required-bind1" ref="value1" required="true()"/>

                        <xforms:bind id="required-bind2" ref="value2" required="true()"/>
                        <xforms:bind id="constraint-bind2" ref="value2" constraint="true()"/>
                    </xforms:model>
                </xhtml:head>
                <xhtml:body>
                    <xforms:output id="output1" value="string-join(xxforms:invalid-binds(value1), ', ')"/>
                    <xforms:output id="output2" value="string-join(xxforms:invalid-binds(value2), ', ')"/>
                </xhtml:body>
            </xhtml:html>
        </input>
        <output name="response">
            <xxf:event-response xmlns:xxf="http://orbeon.org/oxf/xml/xforms">
                <xxf:dynamic-state>
                    <dynamic-state>
                        <instances>
                            <instance id="instance" model-id="model">
                                <instance>
                                    <value1/>
                                    <value2/>
                                </instance>
                            </instance>
                        </instances>
                    </dynamic-state>
                </xxf:dynamic-state>
                <xxf:action>
                    <xxf:control-values>
                        <xxf:control id="output1">required-bind1</xxf:control>
                        <xxf:control id="output2">required-bind2</xxf:control>
                    </xxf:control-values>
                </xxf:action>
            </xxf:event-response>
        </output>
    </test>

    <test description="Don't throw exception with bind on non-NodeWrapper NodeInfo" name="oxf:pipeline">
        <!-- See http://forge.ow2.org/tracker/index.php?func=detail&aid=315728&group_id=168&atid=350207 -->
        <input name="config" href="wrap-xforms-state.xpl"/>
        <input name="document">
            <xhtml:html xmlns:xxf="http://orbeon.org/oxf/xml/xforms" xmlns:xs="http://www.w3.org/2001/XMLSchema">
                <xhtml:head>
                    <xf:model id="model">
                        <!-- Mark instance as readonly -->
                        <xf:instance id="instance" xxf:readonly="true">
                            <instance>
                                <value/>
                            </instance>
                        </xf:instance>
                        <xf:bind ref="instance()">
                            <!-- Use nested bind to trigger creation of BindNode object-->
                            <xf:bind ref="."/>
                        </xf:bind>
                    </xf:model>
                </xhtml:head>
                <xhtml:body/>
            </xhtml:html>
        </input>
        <output name="response">
            <xxf:event-response xmlns:xxf="http://orbeon.org/oxf/xml/xforms">
                <xxf:dynamic-state>
                    <dynamic-state>
                        <instances/>
                    </dynamic-state>
                </xxf:dynamic-state>
                <xxf:action>
                    <xxf:control-values/>
                </xxf:action>
            </xxf:event-response>
        </output>
    </test>

    <test description="Elements containing other elements supports @constraint" name="oxf:pipeline">
        <!-- See: http://forge.ow2.org/tracker/index.php?func=detail&aid=315821&group_id=168&atid=350207 -->
        <input name="config" href="wrap-xforms-controls.xpl"/>
        <input name="document">
            <xh:html xmlns:xh="http://www.w3.org/1999/xhtml"
                  xmlns:xf="http://www.w3.org/2002/xforms"
                  xmlns:xs="http://www.w3.org/2001/XMLSchema"
                  xmlns:xxf="http://orbeon.org/oxf/xml/xforms">
                <xh:head>
                    <xf:model>
                        <xf:instance>
                            <instance>
                                <outer><inner>Foo</inner></outer>
                                <outer><inner>Foo</inner></outer>
                                <outer><inner/></outer>
                            </instance>
                        </xf:instance>
                        <!-- Constraint applies -->
                        <xf:bind nodeset="outer[1]" constraint="false()"/>
                        <!-- Type and required doesn't apply -->
                        <xf:bind nodeset="outer[2]" type="xs:integer"/>
                        <xf:bind nodeset="outer[3]" required="true()"/>
                    </xf:model>
                </xh:head>
                <xh:body>
                    <xf:group ref="outer[1]" id="constraint"/>
                    <xf:group ref="outer[2]" id="type"/>
                    <xf:group ref="outer[3]" id="required"/>
                </xh:body>
            </xh:html>
        </input>
        <output name="response">
            <controls xmlns:xhtml="http://www.w3.org/1999/xhtml">
                <xh:span xmlns:xh="http://www.w3.org/1999/xhtml" id="constraint" class="xforms-group xforms-invalid"/>
                <xh:span xmlns:xh="http://www.w3.org/1999/xhtml" id="type" class="xforms-group"/>
                <xh:span xmlns:xh="http://www.w3.org/1999/xhtml" id="required" class="xforms-group xforms-required"/>
            </controls>
        </output>
    </test>

</group>
