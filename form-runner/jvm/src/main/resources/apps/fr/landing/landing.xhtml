<xh:html xmlns:xh="http://www.w3.org/1999/xhtml"
         xmlns:xs="http://www.w3.org/2001/XMLSchema"
         xmlns:xf="http://www.w3.org/2002/xforms"
         xmlns:xxf="http://orbeon.org/oxf/xml/xforms"
         xmlns:xi="http://www.w3.org/2001/XInclude"
         xmlns:xxi="http://orbeon.org/oxf/xml/xinclude"
         xmlns:fr="http://orbeon.org/oxf/xml/form-runner"
         xmlns:frf="java:org.orbeon.oxf.fr.FormRunner"
         xmlns:version="java:org.orbeon.oxf.common.Version"

         class="orbeon"
         lang="{xxf:instance('fr-fr-language-instance')}"
         xml:lang="{xxf:instance('fr-fr-language-instance')}">

    <xh:head>
        <xh:title><xf:output ref="$fr-resources/landing/title"/></xh:title>
        <xh:link rel="stylesheet" href="/apps/fr/style/form-runner-landing.css" type="text/css" media="all"/>

        <!-- This page needs access to Form Builder permission -->
        <xi:include href="oxf:/apps/fr/includes/permissions-model.xml" xxi:omit-xml-base="true"/>
        <!-- FR Home page XForms model -->
        <xf:model id="fr-form-model" xxf:xpath-analysis="true" xxf:expose-xpath-types="true">

            <xf:var
                name="tz"
                value="
                    for $offset in frf:defaultTimezoneToOffsetString()
                    return xs:dayTimeDuration($offset)"/>

            <xf:var
                name="page-size"
                value="xs:integer(xxf:property('oxf.fr.landing.page-size'))"/>


            <xf:var
                name="link-to-tokens"
                value="xxf:split(xxf:property('oxf.fr.home.table.link-to'))"/>

            <xf:var
                name="fb-permissions"
                value="xxf:instance('fb-permissions')"/>

            <xf:var
                name="has-any-matching-roles"
                value="not($fb-permissions/@has-roles = 'false')"/>

            <xf:var
                name="is-form-builder-available"
                value="doc-available('oxf:/forms/orbeon/builder/form/form.xhtml')"/>

            <!-- Similar logic in Form Builder model.xml -->
            <xf:var
                name="is-allow-form-builder"
                value="
                    $is-form-builder-available and (
                        not($has-any-matching-roles)    or
                        $fb-permissions/app/@name = '*' or
                        exists($fb-permissions/app[1]/@name[xxf:non-blank()])
                    )
                "/>

            <xf:var
                name="is-allow-admin"
                value="
                    $fb-permissions/app/@name = '*' or exists($fb-permissions/app[1]/@name[xxf:non-blank()])"/>

            <!-- Q: Why do we need this? "Published Forms" doesn't work if missing. -->
            <xf:instance id="fr-form-instance" xxf:exclude-result-prefixes="#all">
                <_/>
            </xf:instance>

            <xf:instance id="fr-landing-form-metadata-instance" xxf:exclude-result-prefixes="#all">
                <_ state="initial"/>
            </xf:instance>

            <xf:instance id="fr-landing-form-builder-instance" xxf:exclude-result-prefixes="#all">
                <_ state="initial"/>
            </xf:instance>

            <!-- Don't use `xxf:exclude-result-prefixes="#all"` as eXist search needs the `xh` and `xf` namespaces -->
            <!-- TODO: Could we now get rid of the `<query>` elements since eXist support is no longer needed? -->
            <xf:instance id="fr-search-instance">
                <search xmlns="" return-all-indexed-fields="true">
                    <query/>
                    <query name="application-name"
                           path="xh:head/xf:model[@id = 'fr-form-model']/xf:instance[@id = 'fr-form-metadata']/*/application-name"
                           match="substring"/>
                    <query name="form-name"
                           path="xh:head/xf:model[@id = 'fr-form-model']/xf:instance[@id = 'fr-form-metadata']/*/form-name"
                           match="substring"/>
                    <query name="title"
                           path="xh:head/xf:model[@id = 'fr-form-model']/xf:instance[@id = 'fr-form-metadata']/*/title"
                           match="substring"/>
                    <query name="description"
                           path="xh:head/xf:model[@id = 'fr-form-model']/xf:instance[@id = 'fr-form-metadata']/*/description"
                           match="substring"/>
                    <page-size/>
                    <page-number>1</page-number>
                    <lang/>
                </search>
            </xf:instance>

            <xf:instance id="fr-cards-config-xml" xxf:exclude-result-prefixes="#all">
                <_/>
            </xf:instance>

            <xf:action event="xforms-model-construct-done">
                <xf:var
                    name="cards-config-xml"
                    value="frf:landingCardsXml()/*"/>
                <xf:action if="empty($cards-config-xml)" type="xpath">
                    frf:sendError(404)
                </xf:action>
                <xf:action if="exists($cards-config-xml)">
                    <xf:insert ref="instance('fr-cards-config-xml')" origin="$cards-config-xml"/>
                </xf:action>
            </xf:action>

        </xf:model>
    </xh:head>
    <xh:body>
        <fr:view fluid="true">
            <fr:navbar/>
            <fr:config-check/>
            <xh:div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 row-cols-xxl-4 gx-2 gy-2">

                <xh:div class="p-2 {'xforms-hidden'[not(instance('fr-cards-config-xml')/_/card-type = 'quick-links')]}">
                    <xh:div class="card h-100 fr-landing-quick-links-card">
                        <xh:h5 class="card-title card-header text-center"><xf:output value="xxf:r('landing.titles.quick-links', '|fr-fr-resources|')"/></xh:h5>
                        <xh:div>
                            <xh:a href="/fr/orbeon/builder/new" class="text-center {'xforms-hidden'[not($is-allow-form-builder)]}">
                                <xh:figure>
                                    <xh:img src="/apps/fr/style/images/orbeon/crane.svg" class="img-thumbnail w-100"/>
                                    <xh:figcaption><xf:output value="xxf:r('landing.titles.form-builder-new', '|fr-fr-resources|')"/></xh:figcaption>
                                </xh:figure>
                            </xh:a>
                            <xh:a href="/fr/orbeon/builder/summary" class="text-center {'xforms-hidden'[not($is-allow-form-builder)]}">
                                <xh:figure>
                                    <xh:img src="/apps/fr/style/images/orbeon/library.svg" class="img-thumbnail w-100"/>
                                    <xh:figcaption><xf:output value="xxf:r('landing.titles.form-builder-summary', '|fr-fr-resources|')"/></xh:figcaption>
                                </xh:figure>
                            </xh:a>
                            <xh:a href="/fr/forms" class="text-center">
                                <xh:figure>
                                    <xh:img src="/apps/fr/style/images/orbeon/book.svg" class="img-thumbnail w-100"/>
                                    <xh:figcaption><xf:output value="xxf:r('landing.titles.published-forms', '|fr-fr-resources|')"/></xh:figcaption>
                                </xh:figure>
                            </xh:a>
                            <xh:a href="/fr/admin" class="text-center {'xforms-hidden'[not($is-allow-admin)]}">
                                <xh:figure>
                                    <xh:img src="/apps/fr/style/images/orbeon/cogwheels.svg" class="img-thumbnail w-100"/>
                                    <xh:figcaption><xf:output value="xxf:r('landing.titles.form-runner-admin', '|fr-fr-resources|')"/></xh:figcaption>
                                </xh:figure>
                            </xh:a>
                        </xh:div>
                    </xh:div>
                </xh:div>

                <xf:repeat ref="instance('fr-cards-config-xml')/_[card-type = 'published-forms']">
                    <fr:card-published-forms
                        id="published-form-card"
                        ref="."
                        app="{app}"
                        thumbnail="{thumbnail}">
                        <xf:label
                            ref="
                                if (title/@type = 'object') then
                                    title/(*[local-name() = xxf:lang()], *[local-name() = '_'], *)[1]
                                else
                                    xxf:r(title, '|fr-fr-resources|')"/>
                        <xf:help
                            ref="
                                if (description/@type = 'object') then
                                    description/(*[local-name() = xxf:lang()], *[local-name() = '_'], *)[1]
                                else
                                    xxf:r(description, '|fr-fr-resources|')"/>
                    </fr:card-published-forms>
                </xf:repeat>

                <xf:repeat ref="instance('fr-cards-config-xml')/_[card-type = 'form-data' and ($is-allow-form-builder or not(app = 'orbeon' and form = 'builder'))]">
                    <fr:card-form-data
                        id="form-data-card"
                        app="{app}"
                        form="{form}"
                        version="{version}"
                        thumbnail="{thumbnail}"
                    />
                </xf:repeat>
            </xh:div>
        </fr:view>
    </xh:body>
</xh:html>
