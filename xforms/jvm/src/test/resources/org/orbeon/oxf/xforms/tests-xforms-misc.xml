<!--
  Copyright (C) 2010 Orbeon, Inc.

  This program is free software; you can redistribute it and/or modify it under the terms of the
  GNU Lesser General Public License as published by the Free Software Foundation; either version
  2.1 of the License, or (at your option) any later version.

  This program is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY;
  without even the implied warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.
  See the GNU Lesser General Public License for more details.

  The full text of the license is available at http://www.gnu.org/copyleft/lesser.html
  -->
<group description="XForms Misc"
    xmlns:p="http://www.orbeon.com/oxf/pipeline"
    xmlns:xsl="http://www.w3.org/1999/XSL/Transform"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xmlns:xs="http://www.w3.org/2001/XMLSchema"
    xmlns:xh="http://www.w3.org/1999/xhtml"
    xmlns:oxf="http://www.orbeon.com/oxf/processors"
    xmlns:xi="http://www.w3.org/2001/XInclude"
    xmlns:xxi="http://orbeon.org/oxf/xml/xinclude"
    xmlns:xf="http://www.w3.org/2002/xforms"
    xmlns:xxf="http://orbeon.org/oxf/xml/xforms"
    xmlns:exf="http://www.exforms.org/exf/1-0"
    xmlns:ev="http://www.w3.org/2001/xml-events"
    xmlns:xbl="http://www.w3.org/ns/xbl"
    xmlns:fr="http://orbeon.org/oxf/xml/form-runner">

    <test description="Calculator" name="oxf:pipeline">
        <input name="config" href="wrap-xforms-state.xpl"/>
        <input name="document">
            <xh:html>
                <xh:head>
                    <xf:model id="main-model">
                        <xf:instance id="main-instance">
                            <equation>
                                <screen>0</screen>
                                <screenbuffer>0</screenbuffer>
                                <first>0</first>
                                <second>0</second>
                                <memory>0</memory>
                                <result/>
                            </equation>
                        </xf:instance>

                        <xf:dispatch ev:event="xforms-ready" name="DOMActivate" targetid="5"/>

                    </xf:model>
                </xh:head>
                <xh:body>
                    <xi:include href="forms/xforms-calculator-controls.xml" xxi:omit-xml-base="true"/>
                </xh:body>
            </xh:html>
        </input>
        <output name="response">
            <xxf:event-response>
                <xxf:dynamic-state>
                    <dynamic-state>
                        <instances>
                            <instance id="main-instance" model-id="main-model">
                                <equation>
                                    <screen>7</screen>
                                    <screenbuffer>7</screenbuffer>
                                    <first>0</first>
                                    <second>0</second>
                                    <memory>0</memory>
                                    <result/>
                                </equation>
                            </instance>
                        </instances>
                        <controls>
                            <control effective-id="23a" case-id="add"/>
                        </controls>
                    </dynamic-state>
                </xxf:dynamic-state>
                <xxf:action>
                    <xxf:control-values>
                        <xxf:control id="1">
                            <xxf:value>7</xxf:value>
                        </xxf:control>
                        <xxf:control id="2" label="M:">
                            <xxf:value>0</xxf:value>
                        </xxf:control>
                        <xxf:control id="3" label="Clear"/>
                        <xxf:control id="4" label="MC"/>
                        <xxf:control id="5" label="7"/>
                        <xxf:control id="6" label="8"/>
                        <xxf:control id="7" label="9"/>
                        <xxf:control id="8" label="/"/>
                        <xxf:control id="9" label="MR"/>
                        <xxf:control id="10" label="4"/>
                        <xxf:control id="11" label="5"/>
                        <xxf:control id="12" label="6"/>
                        <xxf:control id="13" label="*"/>
                        <xxf:control id="14" label="MS"/>
                        <xxf:control id="15" label="1"/>
                        <xxf:control id="16" label="2"/>
                        <xxf:control id="17" label="3"/>
                        <xxf:control id="18" label="-"/>
                        <xxf:control id="19" label="1/x"/>
                        <xxf:control id="20" label="M+"/>
                        <xxf:control id="21" label="0"/>
                        <xxf:control id="22" label="+/-"/>
                        <xxf:control id="23" label="+"/>
                        <xxf:control id="23a">
                            <xxf:case id="add" visibility="visible"/>
                            <xxf:case id="subtract" visibility="hidden"/>
                            <xxf:case id="multiply" visibility="hidden"/>
                            <xxf:case id="divide" visibility="hidden"/>
                        </xxf:control>
                        <xxf:control id="24" label="="/>
                        <xxf:control id="25" label="="/>
                        <xxf:control id="26" label="="/>
                        <xxf:control id="27" label="="/>
                    </xxf:control-values>
                </xxf:action>
            </xxf:event-response>
        </output>
    </test>

    <test description="Default instances" name="oxf:pipeline">
        <input name="config" href="wrap-xforms-state.xpl"/>
        <input name="document">
            <xh:html>
                <xh:head>
                    <xf:model id="main-model">
                        <xf:instance id="main-instance">
                            <equation>
                                <screen>0</screen>
                                <screenbuffer>0</screenbuffer>
                                <first>0</first>
                                <second>0</second>
                                <memory>12</memory>
                                <result/>
                            </equation>
                        </xf:instance>

                        <xf:dispatch ev:event="xforms-ready" name="DOMActivate" targetid="5"/>

                    </xf:model>
                </xh:head>
                <xh:body>
                    <xi:include href="forms/xforms-calculator-controls.xml" xxi:omit-xml-base="true"/>
                </xh:body>
            </xh:html>
        </input>
        <output name="response">
            <xxf:event-response>
                <xxf:dynamic-state>
                    <dynamic-state>
                        <instances>
                            <instance id="main-instance" model-id="main-model">
                                <equation>
                                    <screen>7</screen>
                                    <screenbuffer>7</screenbuffer>
                                    <first>0</first>
                                    <second>0</second>
                                    <memory>12</memory>
                                    <result/>
                                </equation>
                            </instance>
                        </instances>
                        <controls>
                            <control effective-id="23a" case-id="add"/>
                        </controls>
                    </dynamic-state>
                </xxf:dynamic-state>
                <xxf:action>
                    <xxf:control-values>
                        <xxf:control id="1">
                            <xxf:value>7</xxf:value>
                        </xxf:control>
                        <xxf:control id="2" label="M:">
                            <xxf:value>12</xxf:value>
                        </xxf:control>
                        <xxf:control id="3" label="Clear"/>
                        <xxf:control id="4" label="MC"/>
                        <xxf:control id="5" label="7"/>
                        <xxf:control id="6" label="8"/>
                        <xxf:control id="7" label="9"/>
                        <xxf:control id="8" label="/"/>
                        <xxf:control id="9" label="MR"/>
                        <xxf:control id="10" label="4"/>
                        <xxf:control id="11" label="5"/>
                        <xxf:control id="12" label="6"/>
                        <xxf:control id="13" label="*"/>
                        <xxf:control id="14" label="MS"/>
                        <xxf:control id="15" label="1"/>
                        <xxf:control id="16" label="2"/>
                        <xxf:control id="17" label="3"/>
                        <xxf:control id="18" label="-"/>
                        <xxf:control id="19" label="1/x"/>
                        <xxf:control id="20" label="M+"/>
                        <xxf:control id="21" label="0"/>
                        <xxf:control id="22" label="+/-"/>
                        <xxf:control id="23" label="+"/>
                        <xxf:control id="23a">
                            <xxf:case id="add" visibility="visible"/>
                            <xxf:case id="subtract" visibility="hidden"/>
                            <xxf:case id="multiply" visibility="hidden"/>
                            <xxf:case id="divide" visibility="hidden"/>
                        </xxf:control>
                        <xxf:control id="24" label="="/>
                        <xxf:control id="25" label="="/>
                        <xxf:control id="26" label="="/>
                        <xxf:control id="27" label="="/>
                    </xxf:control-values>
                </xxf:action>
            </xxf:event-response>
        </output>
    </test>

    <test description="Nested refs with multiple models and instances" name="oxf:pipeline">
        <input name="config">
            <p:config>
                <p:param name="response" type="output"/>

                <p:processor name="oxf:pipeline">
                    <p:input name="config" href="wrap-xforms-state.xpl"/>
                    <p:input name="document">
                        <xh:html>
                            <xh:head>
                                <xf:model id="main-model">
                                    <xf:instance id="instance11">
                                        <nested111>
                                            <nested112>
                                                <first>111</first>
                                                <second>112</second>
                                                <third>113</third>
                                                <fourth>114</fourth>
                                            </nested112>
                                        </nested111>
                                    </xf:instance>
                                    <xf:instance id="instance12">
                                        <nested121>
                                            <nested122>
                                                <first>121</first>
                                                <second>122</second>
                                                <third>123</third>
                                                <fourth>124</fourth>
                                            </nested122>
                                        </nested121>
                                    </xf:instance>
                                </xf:model>
                                <xf:model id="model2">
                                    <xf:instance id="instance21">
                                        <nested211>
                                            <nested212>
                                                <first>211</first>
                                                <second>212</second>
                                                <third>213</third>
                                                <fourth>214</fourth>
                                            </nested212>
                                        </nested211>
                                    </xf:instance>
                                    <xf:instance id="instance22">
                                        <nested221>
                                            <nested222>
                                                <first>221</first>
                                                <second>222</second>
                                                <third>223</third>
                                                <fourth>224</fourth>
                                            </nested222>
                                        </nested221>
                                    </xf:instance>
                                </xf:model>
                            </xh:head>
                            <xh:body>
                                <!-- First model, first instance -->
                                <xf:group ref="/" id="group111">
                                    <xf:group ref="nested111" id="group112">
                                        <xf:group ref="nested112" id="group113">
                                            <xf:output ref="first" id="id111"/>
                                            <xf:output ref="second" id="id112"/>
                                            <xf:output ref="third" id="id113"/>
                                            <xf:output ref="fourth" id="id114"/>
                                        </xf:group>
                                    </xf:group>
                                </xf:group>
                                <!-- First model, second instance -->
                                <xf:group ref="instance('instance12')" id="group121">
                                    <xf:group ref="nested122" id="group122">
                                        <xf:output ref="first" id="id121"/>
                                        <xf:output ref="second" id="id122"/>
                                        <xf:output ref="third" id="id123"/>
                                        <xf:output ref="fourth" id="id124"/>
                                    </xf:group>
                                </xf:group>
                                <!-- Mixed models -->
                                <xf:group model="model2" ref="/" id="group211">
                                    <xf:group ref="nested211" id="group212">
                                        <xf:group ref="nested212" id="group213">
                                            <xf:output ref="first" id="id211"/>
                                            <xf:output ref="second" id="id212"/>
                                            <xf:output ref="third" id="id213"/>
                                            <xf:output ref="fourth" id="id214"/>
                                        </xf:group>
                                        <xf:group ref="instance('instance22')" id="group214">
                                            <xf:group ref="nested222" id="group8">
                                                <xf:output ref="first" id="id221"/>
                                                <xf:output ref="second" id="id222"/>
                                                <xf:output ref="third" id="id223"/>
                                                <xf:output ref="fourth" id="id224"/>
                                                <xf:group ref="instance('instance21')" id="group215">
                                                    <xf:group ref="nested212" id="group10">
                                                        <xf:output ref="first" id="id211b"/>
                                                        <xf:output ref="second" id="id212b"/>
                                                        <xf:output ref="third" id="id213b"/>
                                                        <xf:output ref="fourth" id="id214b"/>
                                                    </xf:group>
                                                </xf:group>
                                            </xf:group>
                                        </xf:group>
                                    </xf:group>
                                </xf:group>
                            </xh:body>
                        </xh:html>
                    </p:input>
                    <p:output name="response" ref="response"/>
                </p:processor>
            </p:config>
        </input>
        <output name="response">
            <xxf:event-response>
                <xxf:dynamic-state>
                    <dynamic-state/>
                </xxf:dynamic-state>
                <xxf:action>
                    <xxf:control-values>
                        <xxf:control id="id111">
                            <xxf:value>111</xxf:value>
                        </xxf:control>
                        <xxf:control id="id112">
                            <xxf:value>112</xxf:value>
                        </xxf:control>
                        <xxf:control id="id113">
                            <xxf:value>113</xxf:value>
                        </xxf:control>
                        <xxf:control id="id114">
                            <xxf:value>114</xxf:value>
                        </xxf:control>
                        <xxf:control id="id121">
                            <xxf:value>121</xxf:value>
                        </xxf:control>
                        <xxf:control id="id122">
                            <xxf:value>122</xxf:value>
                        </xxf:control>
                        <xxf:control id="id123">
                            <xxf:value>123</xxf:value>
                        </xxf:control>
                        <xxf:control id="id124">
                            <xxf:value>124</xxf:value>
                        </xxf:control>
                        <xxf:control id="id211">
                            <xxf:value>211</xxf:value>
                        </xxf:control>
                        <xxf:control id="id212">
                            <xxf:value>212</xxf:value>
                        </xxf:control>
                        <xxf:control id="id213">
                            <xxf:value>213</xxf:value>
                        </xxf:control>
                        <xxf:control id="id214">
                            <xxf:value>214</xxf:value>
                        </xxf:control>
                        <xxf:control id="id221">
                            <xxf:value>221</xxf:value>
                        </xxf:control>
                        <xxf:control id="id222">
                            <xxf:value>222</xxf:value>
                        </xxf:control>
                        <xxf:control id="id223">
                            <xxf:value>223</xxf:value>
                        </xxf:control>
                        <xxf:control id="id224">
                            <xxf:value>224</xxf:value>
                        </xxf:control>
                        <xxf:control id="id211b">
                            <xxf:value>211</xxf:value>
                        </xxf:control>
                        <xxf:control id="id212b">
                            <xxf:value>212</xxf:value>
                        </xxf:control>
                        <xxf:control id="id213b">
                            <xxf:value>213</xxf:value>
                        </xxf:control>
                        <xxf:control id="id214b">
                            <xxf:value>214</xxf:value>
                        </xxf:control>
                    </xxf:control-values>
                </xxf:action>
            </xxf:event-response>
        </output>
    </test>

    <test description="xxf:format attribute" name="oxf:pipeline">
        <input name="config" href="wrap-xforms-state.xpl"/>
        <input name="document">
            <xh:html>
                <xh:head>
                    <xf:model id="model">
                        <xf:instance id="instance">
                            <date>2005-10-11</date>
                        </xf:instance>
                        <xf:bind ref="instance()" type="xs:date"/>
                    </xf:model>
                </xh:head>
                <xh:body>
                    <xf:input id="id1" ref="instance()" xxf:format="format-date(xs:date(.), '[MNn] [D], [Y]', 'en', (), ())"/>
                    <xf:output id="id2" ref="instance()" xxf:format="format-date(xs:date(.), '[D]. [MNn] [Y]', 'de', (), ())"/>
                </xh:body>
            </xh:html>
        </input>
        <output name="response">
            <xxf:event-response>
                <xxf:dynamic-state>
                    <dynamic-state/>
                </xxf:dynamic-state>
                <xxf:action>
                    <xxf:control-values>
                        <xxf:control id="id1" type="{http://www.w3.org/2001/XMLSchema}date">
                            <xxf:value>October 11, 2005</xxf:value>
                        </xxf:control>
                        <xxf:control id="id2">
                            <xxf:value>11. Oktober 2005</xxf:value>
                        </xxf:control>
                    </xxf:control-values>
                </xxf:action>
            </xxf:event-response>
        </output>
    </test>

    <!-- This test makes sure that in case the value of a control is changed by the client, but then
         an action resets that value to the same value as the original value, then the proper response is sent. -->
    <test description="xf:setvalue to same initial value" name="oxf:pipeline">
        <input name="config" href="wrap-server.xpl"/>
        <input name="action">
            <xxf:action>
                <xxf:event name="xxforms-value" source-control-id="id123"><xxf:property name="value">Hello!</xxf:property></xxf:event>
                <xxf:event name="DOMActivate" source-control-id="id124"/>
            </xxf:action>
        </input>
        <input name="controls">
            <controls>
                <xf:input ref="instance('main')" id="id123"/>
                <xf:trigger id="id124">
                    <xf:label/>
                    <xf:setvalue ev:event="DOMActivate" ref="instance('main')" id="id125">existing value</xf:setvalue>
                </xf:trigger>
            </controls>
        </input>
        <input name="models">
            <models>
                <xf:model id="main-model">
                    <xf:instance id="main"/>
                </xf:model>
            </models>
        </input>
        <input name="instances">
            <instances>
                <instance id="main" model-id="main-model">
                    <value>existing value</value>
                </instance>
            </instances>
        </input>
        <output name="response">
            <xxf:event-response>
                <xxf:dynamic-state>
                    <dynamic-state>
                        <instances>
                            <instance id="main" model-id="main-model">
                                <value>existing value</value>
                            </instance>
                        </instances>
                    </dynamic-state>
                </xxf:dynamic-state>
                <xxf:action>
                    <xxf:control-values>
                        <xxf:control id="id123">
                            <xxf:value>existing value</xxf:value>
                        </xxf:control>
                    </xxf:control-values>
                </xxf:action>
            </xxf:event-response>
        </output>
    </test>

    <test description="Incorrect evaluation of trigger in refresh processing with multiple models" name="oxf:pipeline">
        <input name="config">
            <p:config>
                <p:param name="response" type="output"/>

                <p:processor name="oxf:pipeline">
                    <p:input name="config" href="wrap-xforms-state.xpl"/>
                    <p:input name="document">
                        <xh:html>
                            <xh:head>
                                <xf:model id="model1">

                                    <xf:action ev:event="xforms-ready">
                                        <xf:dispatch name="xxforms-repeat-activate" targetid="my-trigger" xxf:repeat-indexes="2"/>
                                    </xf:action>

                                </xf:model>
                                <xf:model id="model2">
                                    <xf:instance id="instance2">
                                        <instance>
                                            <record/>
                                            <record/>
                                        </instance>
                                    </xf:instance>
                                    <xf:bind ref="record" readonly="(count(preceding-sibling::*) + 1) = index('my-repeat')"/>
                                </xf:model>
                            </xh:head>
                            <xh:body>
                                <xf:repeat model="model2" ref="record" id="my-repeat">
                                     <xf:trigger id="my-trigger" ref=".">
                                        <xf:label>Do Stuff</xf:label>
                                         <!-- Add event handler so that refresh goes through event dispatching -->
                                         <xf:action ev:event="#all"/>
                                    </xf:trigger>
                                </xf:repeat>
                            </xh:body>
                        </xh:html>
                    </p:input>
                    <p:output name="response" ref="response"/>
                </p:processor>

            </p:config>
        </input>
        <output name="response">
            <xxf:event-response>
                <xxf:dynamic-state>
                    <dynamic-state>
                        <controls>
                            <control effective-id="my-repeat" index="2"/>
                        </controls>
                    </dynamic-state>
                </xxf:dynamic-state>
                <xxf:action>
                    <xxf:control-values>
                        <xxf:control id="my-trigger⊙1" label="Do Stuff"/>
                        <xxf:control id="my-trigger⊙2" label="Do Stuff" readonly="true"/>
                    </xxf:control-values>
                </xxf:action>
            </xxf:event-response>
        </output>
    </test>

    <test description="Label change on xxf:dialog" name="oxf:pipeline">
        <input name="config" href="wrap-xforms-state.xpl"/>
        <input name="document">
            <xh:html>
                <xh:head>
                    <xf:model id="model">
                        <xf:instance id="instance">
                            <label>Banana</label>
                        </xf:instance>

                        <xf:action ev:event="xforms-ready">
                            <xxf:show dialog="dialog-1"/>
                            <xf:setvalue ref=".">Potato</xf:setvalue>
                        </xf:action>

                    </xf:model>
                </xh:head>
                <xh:body>
                    <xxf:dialog id="dialog-1">
                        <xf:label ref="."/>
                    </xxf:dialog>
                    <xxf:dialog id="dialog-2">
                        <xf:label>Strawberry</xf:label>
                    </xxf:dialog>
                </xh:body>
            </xh:html>
        </input>
        <output name="response">
            <xxf:event-response>
                <xxf:dynamic-state>
                    <dynamic-state>
                        <instances>
                            <instance id="instance" model-id="model">
                                <label>Potato</label>
                            </instance>
                        </instances>
                        <controls>
                            <control effective-id="dialog-1" visible="true" constrain="true"/>
                            <control effective-id="dialog-2" visible="false"/>
                        </controls>
                    </dynamic-state>
                </xxf:dynamic-state>
                <xxf:action>
                    <xxf:control-values>
                        <xxf:control id="dialog-1" label="Potato"/>
                        <xxf:dialog id="dialog-1" visibility="visible" constrain="true"/>
                        <xxf:control id="dialog-2" label="Strawberry"/>
                        <xxf:dialog id="dialog-2" visibility="hidden"/>
                    </xxf:control-values>
                </xxf:action>
            </xxf:event-response>
        </output>
    </test>

    <test description="xxf:dialog within repeat" name="oxf:pipeline">
        <input name="config" href="wrap-xforms-state.xpl"/>
        <input name="document">
            <xh:html>
                <xh:head>
                    <xf:model id="model">
                        <xf:instance id="instance">
                            <labels>
                                <label>Banana</label>
                                <label>Strawberry</label>
                            </labels>
                        </xf:instance>

                        <xf:action ev:event="xforms-ready">
                            <xxf:show dialog="dialog-1"/>
                            <xf:insert ref="label" origin="xf:element('label', 'Vanilla')"/>
                        </xf:action>

                    </xf:model>
                </xh:head>
                <xh:body>
                    <xf:repeat ref="label">
                        <xxf:dialog id="dialog-1">
                            <xf:label ref="."/>
                        </xxf:dialog>
                    </xf:repeat>
                </xh:body>
            </xh:html>
        </input>
        <output name="response">
            <xxf:event-response>
                <xxf:dynamic-state>
                    <dynamic-state>
                        <instances>
                            <instance id="instance" model-id="model">
                                <labels>
                                    <label>Banana</label>
                                    <label>Strawberry</label>
                                    <label>Vanilla</label>
                                </labels>
                            </instance>
                        </instances>
                        <controls>
                            <control effective-id="xf-4" index="3"/>
                            <control effective-id="dialog-1⊙1" visible="true" constrain="true"/>
                            <control effective-id="dialog-1⊙2" visible="false"/>
                            <control effective-id="dialog-1⊙3" visible="false"/>
                        </controls>
                    </dynamic-state>
                </xxf:dynamic-state>
                <xxf:action>
                    <xxf:control-values>
                        <xxf:control id="dialog-1⊙1" label="Banana"/>
                        <xxf:dialog id="dialog-1⊙1" visibility="visible" constrain="true"/>
                        <xxf:control id="dialog-1⊙2" label="Strawberry"/>
                        <xxf:dialog id="dialog-1⊙2" visibility="hidden"/>
                        <xxf:control id="dialog-1⊙3" label="Vanilla"/>
                        <xxf:dialog id="dialog-1⊙3" visibility="hidden"/>
                    </xxf:control-values>
                </xxf:action>
            </xxf:event-response>
        </output>
    </test>

    <test description="Comments in XForms document are not propagated" name="oxf:pipeline">
        <input name="config" href="wrap-xforms-init-nohead.xpl"/>
        <input name="document">
            <xh:html>
                <!-- Comment 1 -->
                <xh:head>
                    <!-- Comment 2 -->
                    <xf:model id="model">
                        <!-- Comment 3 -->
                        <xf:instance id="instance">
                            <labels>
                                <!-- Comment 4 -->
                                <label>Banana</label>
                                <label>Strawberry</label>
                            </labels>
                        </xf:instance>
                    </xf:model>
                </xh:head>
                <!-- Comment 5 -->
                <xh:body>
                    <!-- Comment 6 -->
                    <xf:repeat ref="label">
                        <!-- Comment 7 -->
                    </xf:repeat>
                </xh:body>
            </xh:html>
        </input>
        <output name="response">
            <xh:html>
                <xh:body class="yui-skin-sam">
                    <xh:form id="xforms-form" class="xforms-form xforms-initially-hidden xforms-label-appearance-full xforms-hint-appearance-full xforms-disable-hint-as-tooltip xforms-help-appearance-dialog" action="/doc/home-welcome" method="POST" onsubmit="return false">
                        <xh:input type="hidden" name="$uuid" value="4A00AF98-7464-2F85-9AF6-291447DCC6F8"/>
                        <xh:input type="hidden" name="$static-state" value="X29xIUN8Mudjr..."/>
                        <xh:input type="hidden" name="$dynamic-state" value="X29xIUN8Mudjr..."/>
                        <xh:span id="xforms-select-full-template" class="xforms-template">
                            <xh:span class="xforms-deselected">
                                <xh:label class="checkbox">
                                    <xh:input id="$xforms-item-id-select$" type="checkbox" name="$xforms-item-name$" value="$xforms-template-value$"/>
                                    <xh:span class="xforms-hint-region">$xforms-template-label$</xh:span>
                                    <xh:span class="xforms-help">$xforms-template-help$</xh:span>
                                    <xh:span class="xforms-hint">$xforms-template-hint$</xh:span>
                                </xh:label>
                            </xh:span>
                        </xh:span>
                        <xh:span id="xforms-select1-full-template" class="xforms-template">
                            <xh:span class="xforms-deselected">
                                <xh:label class="radio">
                                    <xh:input id="$xforms-item-id-select1$" type="radio" name="$xforms-item-name$" value="$xforms-template-value$"/>
                                    <xh:span class="xforms-hint-region">$xforms-template-label$</xh:span>
                                    <xh:span class="xforms-help">$xforms-template-help$</xh:span>
                                    <xh:span class="xforms-hint">$xforms-template-hint$</xh:span>
                                </xh:label>
                            </xh:span>
                        </xh:span>
                        <noscript xmlns="http://www.w3.org/1999/xhtml">
                            <div class="xforms-noscript-panel">
                                <p>Your browser does not appear to support JavaScript. You may want to try one of the following:</p>
                                <ul>
                                    <li>Turn on JavaScript in your browser if it supports it.</li>
                                    <li>Use a browser that supports JavaScript.</li>
                                    <li>Try a JavaScript-free version of this page, if made available by the application author.</li>
                                </ul>
                            </div>
                        </noscript>
                        <div xmlns="http://www.w3.org/1999/xhtml" class="xforms-error-dialogs">
                            <div class="xforms-error-panel xforms-initially-hidden" role="dialog" aria-labelledby="error-dialog-title">
                                <div class="hd" id="error-dialog-title">An error has occurred</div>
                                <div class="bd">
                                    <p>You may want to try one of the following:</p>
                                    <ul>
                                        <li>
                                            <a class="xforms-error-panel-close">Close this dialog</a>and continue to use this page.
                                        </li>
                                        <li>
                                            <a class="xforms-error-panel-reload">Reload this page</a>. Note that you will lose any unsaved changes.
                                        </li>
                                        <li>
                                            <p>If the above does not work, try reloading the page yourself. Note that you will lose any unsaved changes:</p>
                                            <ul>
                                                <li>With Firefox: hold down the
                                                    <code>shift</code>key and click the Reload button in your browser toolbar.
                                                </li>
                                                <li>With Safari and Chrome: click the Reload button in your browser toolbar.</li>
                                                <li>With Internet Explorer: hold down the
                                                    <code>control</code>key and click the Reload button in your browser toolbar.
                                                </li>
                                            </ul>
                                        </li>
                                        <li>Return
                                            <a href="/">home</a>.
                                        </li>
                                    </ul>
                                    <div class="xforms-error-panel-details-hidden">
                                        <p>
                                            <a class="xforms-error-panel-show-details">
                                                <img src="/ops/images/xforms/section-closed.png" alt="Show Details"/>
                                                <span>Show details</span>
                                            </a>
                                        </p>
                                    </div>
                                    <div class="xforms-error-panel-details-shown xforms-disabled">
                                        <p>
                                            <a class="xforms-error-panel-hide-details">
                                                <img src="/ops/images/xforms/section-opened.png" alt="Hide Details"/>
                                                <span>Hide details</span>
                                            </a>
                                        </p>
                                        <div class="xforms-error-panel-details"/>
                                    </div>
                                </div>
                            </div>
                            <div class="xforms-login-detected-dialog modal hide fade" tabindex="-1" role="dialog" aria-hidden="true">
                                <div class="modal-header">
                                    <h4>Reloading form</h4>
                                </div>
                                <div class="modal-body">
                                    <p>This form has to be reloaded. This most likely happened because your session has expired, which might take to the login page. (If you think that you shouldn't see this message and that the problem persists, please contact support.)</p>
                                </div>
                                <div class="modal-footer">
                                    <button class="btn btn-primary">OK</button>
                                </div>
                            </div>
                        </div>
                        <div xmlns="http://www.w3.org/1999/xhtml" class="xforms-help-panel xforms-initially-hidden">
                            <div class="hd">Help</div>
                            <div class="bd">
                                <div class="xforms-help-panel-message"/>
                                <div class="xforms-help-panel-close">
                                    <button class="btn btn-small">Close</button>
                                </div>
                            </div>
                        </div>
                        <xh:span id="repeat-begin-xf-1" class="xforms-repeat-begin-end xforms-update-full"/>
                        <xh:span class="xforms-repeat-delimiter"/>
                        <xh:span class="xforms-repeat-selected-item-1 xforms-update-full"/>
                        <xh:span class="xforms-repeat-delimiter"/>
                        <xh:span class="xforms-update-full"/>
                        <xh:span id="repeat-end-xf-1" class="xforms-repeat-begin-end"/>
                    </xh:form>
                </xh:body>
            </xh:html>
        </output>
    </test>

    <test description="Comments in inline instance are preserved" name="oxf:pipeline">
        <input name="config" href="wrap-xforms-state.xpl"/>
        <input name="document">
            <xh:html>
                <xh:head>
                    <xf:model id="model">
                        <xf:instance id="instance">
                            <!-- This comment is ignored for now -->
                            <labels>
                                <!-- Comment 2 -->
                                <label>Banana</label>
                                <!-- Comment 3 --><!-- Comment 4 -->
                                <label>Strawberry</label>
                            </labels>
                        </xf:instance>
                    </xf:model>
                </xh:head>
                <xh:body>
                    <xf:output id="output" value="string-join(//comment(), ' - ')"/>
                </xh:body>
            </xh:html>
        </input>
        <output name="response">
            <xxf:event-response>
                <xxf:dynamic-state>
                    <dynamic-state/>
                </xxf:dynamic-state>
                <xxf:action>
                    <xxf:control-values>
                        <xxf:control id="output">
                            <xxf:value>Comment 2  -  Comment 3  -  Comment 4</xxf:value>
                        </xxf:control>
                    </xxf:control-values>
                </xxf:action>
            </xxf:event-response>
        </output>
    </test>

    <test description="Comments in external instances are preserved" name="oxf:pipeline">
        <input name="config" href="wrap-xforms-state.xpl"/>
        <input name="document">
            <xh:html>
                <xh:head>
                    <xf:model id="model">
                        <xf:instance id="instance-readwrite" src="oxf:/ops/unit-tests/comments.xml"/>
                        <xf:instance id="instance-readonly" src="oxf:/ops/unit-tests/comments.xml" xxf:readonly="true"/>
                    </xf:model>
                </xh:head>
                <xh:body>
                    <xf:output id="output-readwrite" value="string-join(//comment(), ' - ')"/>
                    <xf:output id="output-readonly" value="string-join(instance('instance-readonly')//comment(), ' - ')"/>
                </xh:body>
            </xh:html>
        </input>
        <output name="response">
            <xxf:event-response>
                <xxf:dynamic-state>
                    <dynamic-state>
                        <instances>
                            <instance id="instance-readwrite" model-id="model">
                                <document>
                                    <!-- Comment 1 -->
                                    <element/>
                                    <!-- Multi-line
         comment -->
                                    <element/>
                                </document>
                            </instance>
                            <instance readonly="true" id="instance-readonly" model-id="model">
                                <document>
                                    <!-- Comment 1 -->
                                    <element/>
                                    <!-- Multi-line
         comment -->
                                    <element/>
                                </document>
                            </instance>
                        </instances>
                    </dynamic-state>
                </xxf:dynamic-state>
                <xxf:action>
                    <xxf:control-values>
                        <xxf:control id="output-readwrite">
                            <xxf:value>Comment 1  -  Multi-line
         comment</xxf:value>
                        </xxf:control>
                        <xxf:control id="output-readonly">
                            <xxf:value>Comment 1  -  Multi-line
         comment</xxf:value>
                        </xxf:control>
                    </xxf:control-values>
                </xxf:action>
            </xxf:event-response>
        </output>
    </test>

    <test description="Comments in instance loaded by submission are preserved" name="oxf:pipeline">
        <input name="config" href="wrap-xforms-state.xpl"/>
        <input name="document">
            <xh:html>
                <xh:head>
                    <xf:model id="model">
                        <xf:instance id="instance-readwrite"><dummy/></xf:instance>
                        <xf:instance id="instance-readonly"><dummy/></xf:instance>

                        <xf:submission id="readwrite" method="get" resource="oxf:/ops/unit-tests/comments.xml" replace="instance" instance="instance-readwrite"/>
                        <xf:submission id="readonly" method="get" resource="oxf:/ops/unit-tests/comments.xml" replace="instance" instance="instance-readonly" xxf:readonly="true"/>

                        <xf:action ev:event="xforms-model-construct-done">
                            <xf:send submission="readwrite"/>
                            <xf:send submission="readonly"/>
                        </xf:action>

                    </xf:model>
                </xh:head>
                <xh:body>
                    <xf:output id="output-readwrite" value="string-join(//comment(), ' - ')"/>
                    <xf:output id="output-readonly" value="string-join(instance('instance-readonly')//comment(), ' - ')"/>
                </xh:body>
            </xh:html>
        </input>
        <output name="response">
            <xxf:event-response>
                <xxf:dynamic-state>
                    <dynamic-state>
                        <instances>
                            <instance id="instance-readwrite" model-id="model">
                                <document>
                                    <!-- Comment 1 -->
                                    <element/>
                                    <!-- Multi-line
         comment -->
                                    <element/>
                                </document>
                            </instance>
                            <instance readonly="true" id="instance-readonly" model-id="model">
                                <document>
                                    <!-- Comment 1 -->
                                    <element/>
                                    <!-- Multi-line
         comment -->
                                    <element/>
                                </document>
                            </instance>
                        </instances>
                    </dynamic-state>
                </xxf:dynamic-state>
                <xxf:action>
                    <xxf:control-values>
                        <xxf:control id="output-readwrite">
                            <xxf:value>Comment 1  -  Multi-line
         comment</xxf:value>
                        </xxf:control>
                        <xxf:control id="output-readonly">
                            <xxf:value>Comment 1  -  Multi-line
         comment</xxf:value>
                        </xxf:control>
                    </xxf:control-values>
                </xxf:action>
            </xxf:event-response>
        </output>
    </test>

    <test description="Instance comments preserved in state deserialization" name="oxf:pipeline">
        <input name="config" href="wrap-server.xpl"/>
        <input name="action">
            <xxf:action>
                <xxf:event name="update" source-control-id="model"/>
            </xxf:action>
        </input>
        <input name="controls">
            <controls/>
        </input>
        <input name="models">
            <models>
                <xf:model id="model" xxf:external-events="update">
                    <xf:instance id="instance-readwrite"/>
                    <xf:instance id="instance-readonly"/>
                    <xf:instance id="results"/>

                    <xf:submission id="replace-readwrite" ref="instance()" action="echo:" method="post" replace="instance"/>
                    <xf:submission id="replace-readonly" ref="instance('instance-readonly')" action="echo:" method="post" replace="instance" xxf:readonly="true"/>

                    <xf:action id="action-1" ev:event="update">
                        <!-- Replace instances so that the dynamic state includes them even though they are inline and readonly -->
                        <xf:send submission="replace-readwrite"/>
                        <xf:send submission="replace-readonly"/>
                        <!-- Extract comments -->
                        <xf:setvalue id="setvalue-1" ref="instance('results')/comments[1]" value="string-join(instance()//comment(), ' - ')"/>
                        <xf:setvalue id="setvalue-2" ref="instance('results')/comments[2]" value="string-join(instance('instance-readonly')//comment(), ' - ')"/>
                    </xf:action>

                </xf:model>
            </models>
        </input>
        <input name="instances">
            <instances>
                <instance id="instance-readwrite" model-id="model">
                    <document>
                        <!-- Comment 1 -->
                        <element/>
                        <!-- Comment 2 -->
                        <element/>
                    </document>
                </instance>
                <instance id="instance-readonly" model-id="model">
                    <document>
                        <!-- Comment 1 -->
                        <element/>
                        <!-- Comment 2 -->
                        <element/>
                    </document>
                </instance>
                <instance id="results" model-id="model">
                    <results>
                        <comments/>
                        <comments/>
                    </results>
                </instance>
            </instances>
        </input>
        <output name="response">
            <xxf:event-response>
                <xxf:dynamic-state>
                    <dynamic-state>
                        <instances>
                            <instance id="instance-readwrite" model-id="model">
                                <document>
                                    <!-- Comment 1 -->
                                    <element/>
                                    <!-- Comment 2 -->
                                    <element/>
                                </document>
                            </instance>
                            <instance readonly="true" id="instance-readonly" model-id="model">
                                <document>
                                    <!-- Comment 1 -->
                                    <element/>
                                    <!-- Comment 2 -->
                                    <element/>
                                </document>
                            </instance>
                            <instance id="results" model-id="model">
                                <results>
                                    <comments>Comment 1  -  Comment 2</comments>
                                    <comments>Comment 1  -  Comment 2</comments>
                                </results>
                            </instance>
                        </instances>
                    </dynamic-state>
                </xxf:dynamic-state>
                <xxf:action>
                    <xxf:control-values/>
                </xxf:action>
            </xxf:event-response>
        </output>
    </test>

    <!-- NOTE: This is NOT full model scoping [1]: we are just making sure that a nested model is accessible with the
         @model attribute.

         [1] http://wiki.orbeon.com/forms/projects/xforms-model-scoping-rules
     -->
    <test description="Scoping of model nested within controls" name="oxf:pipeline">
        <input name="config" href="wrap-xforms-state.xpl"/>
        <input name="document">
            <xh:html>
                <xh:head>
                    <xf:model id="foo-model">
                        <xf:instance id="foo-instance">
                            <value>foo</value>
                        </xf:instance>
                    </xf:model>
                </xh:head>
                <xh:body>
                    <!-- Must use default: foo-model -->
                    <xf:output id="output-1" value="instance()"/>
                    <xf:group model="bar-model">
                        <xf:model id="bar-model">
                            <xf:instance id="bar-instance">
                                <value>bar</value>
                            </xf:instance>
                        </xf:model>

                        <!-- Must use model scoped on group: bar-model -->
                        <xf:output id="output-2" value="instance()"/>

                        <!-- Must use model scoped: foo-model -->
                        <xf:output id="output-3" model="foo-model" value="instance()"/>

                    </xf:group>
                    <!-- Must use default: foo-model -->
                    <xf:output id="output-4" value="instance()"/>
                </xh:body>
            </xh:html>
        </input>
        <output name="response">
            <xxf:event-response>
                <xxf:dynamic-state>
                    <dynamic-state/>
                </xxf:dynamic-state>
                <xxf:action>
                    <xxf:control-values>
                        <xxf:control id="output-1">
                            <xxf:value>foo</xxf:value>
                        </xxf:control>
                        <xxf:control id="output-2">
                            <xxf:value>bar</xxf:value>
                        </xxf:control>
                        <xxf:control id="output-3">
                            <xxf:value>foo</xxf:value>
                        </xxf:control>
                        <xxf:control id="output-4">
                            <xxf:value>foo</xxf:value>
                        </xxf:control>
                    </xxf:control-values>
                </xxf:action>
            </xxf:event-response>
        </output>
    </test>

    <test description="Control becomes relevant and sends label to client" name="oxf:pipeline">
        <input name="config" href="wrap-server.xpl"/>
        <input name="action">
            <xxf:action>
                <xxf:event name="xxforms-value" source-control-id="input1"><xxf:property name="value">true</xxf:property></xxf:event>
            </xxf:action>
        </input>
        <input name="controls">
            <controls>
                <xf:input id="input1" ref="@show"/>
                <xf:input id="input2" ref="name">
                    <xf:label>Name:</xf:label>
                </xf:input>
            </controls>
        </input>
        <input name="models">
            <models>
                <xf:model id="model">
                    <xf:instance id="instance"/>
                    <xf:bind id="bind" ref="name" relevant="../@show = 'true'"/>
                </xf:model>
            </models>
        </input>
        <input name="instances">
            <instances>
                <instance model-id="model" id="instance">
                    <form show="false">
                        <name/>
                    </form>
                </instance>
            </instances>
        </input>
        <output name="response">
            <xxf:event-response>
                <xxf:dynamic-state>
                    <dynamic-state>
                        <instances>
                            <instance id="instance" model-id="model">
                                <form xmlns:saxon="http://saxon.sf.net/" show="true">
                                    <name/>
                                </form>
                            </instance>
                        </instances>
                    </dynamic-state>
                </xxf:dynamic-state>
                <xxf:action>
                    <xxf:control-values>
                        <xxf:control id="input2" label="Name:" relevant="true">
                            <xxf:value/>
                        </xxf:control>
                    </xxf:control-values>
                </xxf:action>
            </xxf:event-response>
        </output>
    </test>

    <test description="#418: Prefix for xxf:separator is not declared" name="oxf:pipeline">
        <!-- See: https://github.com/orbeon/orbeon-forms/issues/418 -->
        <input name="config" href="wrap-xforms-state.xpl"/>
        <!-- Put in external file to make sure we control namespaces -->
        <input name="document" href="forms/418.xhtml"/>
        <output name="response">
            <xxf:event-response>
                <xxf:dynamic-state>
                    <dynamic-state/>
                </xxf:dynamic-state>
                <xxf:action>
                    <xxf:control-values/>
                </xxf:action>
            </xxf:event-response>
        </output>
    </test>

    <test description="Control with missing required single-node binding is marked as non-relevant" name="oxf:pipeline">
        <input name="config" href="wrap-xforms-state.xpl"/>
        <input name="document">
            <xh:html>
                <xh:head>
                    <xf:model id="foo-model">
                        <xf:instance id="foo-instance">
                            <value>foo</value>
                        </xf:instance>
                    </xf:model>
                </xh:head>
                <xh:body>
                    <xf:input id="my-relevant-input" ref="instance()"/>
                    <xf:input id="my-non-relevant-input"/>
                </xh:body>
            </xh:html>
        </input>
        <output name="response">
            <xxf:event-response>
                <xxf:dynamic-state>
                    <dynamic-state/>
                </xxf:dynamic-state>
                <xxf:action>
                    <xxf:control-values>
                        <xxf:control id="my-relevant-input">
                            <xxf:value>foo</xxf:value>
                        </xxf:control>
                        <xxf:control id="my-non-relevant-input" relevant="false"/>
                    </xxf:control-values>
                </xxf:action>
            </xxf:event-response>
        </output>
    </test>

    <test description="Control within newly shown dialog re-evaluates binding and values (dependencies)" name="oxf:pipeline">
        <input name="config" href="wrap-xforms-state.xpl"/>
        <input name="document">
            <xh:html>
                <xh:head>
                    <xf:model xxf:xpath-analysis="true">
                        <xf:instance>
                            <resources>
                                <message>My message</message>
                            </resources>
                        </xf:instance>
                        <xf:var name="fr-resources" value="instance()"/>
                        <xxf:show ev:event="xforms-ready" dialog="my-dialog"/>
                    </xf:model>
                </xh:head>
                <xh:body>
                    <xxf:dialog level="modal" id="my-dialog">
                        <xf:output value="$fr-resources/message" id="my-output"/>
                    </xxf:dialog>
                </xh:body>
            </xh:html>
        </input>
        <output name="response">
            <xxf:event-response>
                <xxf:dynamic-state>
                    <dynamic-state>
                        <controls>
                            <control effective-id="my-dialog" visible="true" constrain="true"/>
                        </controls>
                    </dynamic-state>
                </xxf:dynamic-state>
                <xxf:action>
                    <xxf:control-values>
                        <xxf:dialog id="my-dialog" visibility="visible" constrain="true"/>
                        <xxf:control id="my-output">
                            <xxf:value>My message</xxf:value>
                        </xxf:control>
                    </xxf:control-values>
                </xxf:action>
            </xxf:event-response>
        </output>
    </test>

    <test description="#1340: XML Schema xs:import doesn't support relative paths" name="oxf:pipeline">
        <input name="config" href="wrap-xforms-state.xpl"/>
        <input name="document">
            <xh:html xmlns:test1="http://orbeon.org/oxf/examples/test1" xmlns:test2="http://orbeon.org/oxf/examples/test2">
                <xh:head>
                    <xf:model xxf:xpath-analysis="true" schema="oxf:/org/orbeon/oxf/xforms/schema-importing.xsd">
                        <xf:instance>
                            <form>
                                <zip1>12345</zip1>
                                <zip2>12345</zip2>
                                <zip3>123456</zip3>
                                <zip4>123456</zip4>
                            </form>
                        </xf:instance>

                        <xf:bind ref="zip1 | zip3" type="test1:zip"/>
                        <xf:bind ref="zip2 | zip4" type="test2:zip"/>

                    </xf:model>
                </xh:head>
                <xh:body>
                    <xf:output id="validities" value="string-join(*/string(valid()), '-')"/>
                </xh:body>
            </xh:html>
        </input>
        <output name="response">
            <xxf:event-response>
                <xxf:dynamic-state>
                    <dynamic-state/>
                </xxf:dynamic-state>
                <xxf:action>
                    <xxf:control-values>
                        <xxf:control id="validities">
                            <xxf:value>true-true-false-false</xxf:value>
                        </xxf:control>
                    </xxf:control-values>
                </xxf:action>
            </xxf:event-response>
        </output>
    </test>

    <test description="#1683: fr:case: support AVT on selected attribute" name="oxf:pipeline">
        <input name="config" href="wrap-xforms-state.xpl"/>
        <input name="document">
            <xh:html>
                <xh:head>
                    <xf:model xxf:xpath-analysis="true">
                        <xf:instance>
                            <value>42</value>
                        </xf:instance>
                    </xf:model>
                </xh:head>
                <xh:body>
                    <xf:switch id="switch-1">
                        <xf:case id="case-11" selected="false"/>
                        <xf:case id="case-12" selected="{true()}"/>
                        <xf:case id="case-13" selected="true"/>
                    </xf:switch>
                    <xf:switch id="switch-2">
                        <xf:case id="case-21"/>
                        <xf:case id="case-22"/>
                        <xf:case id="case-23" selected="{instance() = '42'}"/>
                    </xf:switch>
                </xh:body>
            </xh:html>
        </input>
        <output name="response">
            <xxf:event-response>
                <xxf:dynamic-state>
                    <dynamic-state>
                        <controls>
                            <control effective-id="switch-1" case-id="case-12"/>
                            <control effective-id="switch-2" case-id="case-23"/>
                        </controls>
                    </dynamic-state>
                </xxf:dynamic-state>
                <xxf:action>
                    <xxf:control-values>
                        <xxf:control id="switch-1">
                            <xxf:case id="case-12" visibility="visible"/>
                            <xxf:case id="case-11" visibility="hidden"/>
                            <xxf:case id="case-13" visibility="hidden"/>
                        </xxf:control>
                        <xxf:control id="switch-2">
                            <xxf:case id="case-23" visibility="visible"/>
                            <xxf:case id="case-21" visibility="hidden"/>
                            <xxf:case id="case-22" visibility="hidden"/>
                        </xxf:control>
                    </xxf:control-values>
                </xxf:action>
            </xxf:event-response>
        </output>
    </test>

    <test description="#1089: XForms 2.0 caseref support: basic operations" name="oxf:pipeline">
        <input name="config" href="wrap-xforms-state.xpl"/>
        <input name="document">
            <xh:html>
                <xh:head>
                    <xf:model id="model">
                        <xf:instance id="instance" xxf:exclude-result-prefixes="#all">
                            <form>
                                <value/>
                                <case>case1-3</case>
                            </form>
                        </xf:instance>

                        <xf:action event="xforms-ready">
                            <!-- Test initial value -->
                            <xf:message value="concat(case('my-switch-1'), ' - ', case)"/>

                            <!-- Test change via caseref -->
                            <xf:setvalue ref="case" value="'case1-2'"/>
                            <xf:refresh/>
                            <xf:message value="concat(case('my-switch-1'), ' - ', case)"/>

                            <!-- Test default to first case -->
                            <xf:setvalue ref="case" value="'WRONG'"/>
                            <xf:refresh/>
                            <xf:message value="concat(case('my-switch-1'), ' - ', case)"/>

                            <!-- Test toggle -->
                            <xf:toggle case="case1-3"/>
                            <xf:refresh/>
                            <xf:message value="concat(case('my-switch-1'), ' - ', case)"/>

                            <!-- Test toggle of controls with unbound caseref -->
                            <xf:toggle case="case2-3"/>
                            <xf:refresh/>
                            <xf:message value="case('my-switch-2')"/>

                            <!-- Test initial state of caseref bound to atomic value -->
                            <xf:message value="case('my-switch-3')"/>

                            <!-- Test toggle of caseref bound to atomic value -->
                            <xf:toggle case="case3-2"/>
                            <xf:refresh/>
                            <xf:message value="case('my-switch-3')"/>
                        </xf:action>

                    </xf:model>
                </xh:head>
                <xh:body>
                    <xf:switch id="my-switch-1" ref="value" caseref="../case">
                        <xf:case id="case1-1">1</xf:case>
                        <xf:case id="case1-2" selected="true">2</xf:case>
                        <xf:case id="case1-3">3</xf:case>
                    </xf:switch>

                    <xf:switch id="my-switch-2" caseref="instance()">
                        <xf:case id="case2-1">1</xf:case>
                        <xf:case id="case2-2" selected="true">2</xf:case>
                        <xf:case id="case2-3">3</xf:case>
                    </xf:switch>

                    <xf:switch id="my-switch-3" caseref="'case3-3'">
                        <xf:case id="case3-1">1</xf:case>
                        <xf:case id="case3-2" selected="true">2</xf:case>
                        <xf:case id="case3-3">3</xf:case>
                    </xf:switch>
                </xh:body>
            </xh:html>
        </input>
        <output name="response">
            <xxf:event-response>
                <xxf:dynamic-state>
                    <dynamic-state>
                        <instances>
                            <instance id="instance" model-id="model">
                                <form>
                                    <value/>
                                    <case>case1-3</case>
                                </form>
                            </instance>
                        </instances>
                        <controls>
                            <control effective-id="my-switch-1" case-id="case1-3"/>
                            <control effective-id="my-switch-2" case-id="case2-1"/>
                            <control effective-id="my-switch-3" case-id="case3-3"/>
                        </controls>
                    </dynamic-state>
                </xxf:dynamic-state>
                <xxf:action>
                    <xxf:control-values>
                        <xxf:control id="my-switch-1">
                            <xxf:case id="case1-3" visibility="visible"/>
                            <xxf:case id="case1-1" visibility="hidden"/>
                            <xxf:case id="case1-2" visibility="hidden"/>
                        </xxf:control>
                        <xxf:control id="my-switch-2">
                            <xxf:case id="case2-1" visibility="visible"/>
                            <xxf:case id="case2-2" visibility="hidden"/>
                            <xxf:case id="case2-3" visibility="hidden"/>
                        </xxf:control>
                        <xxf:control id="my-switch-3">
                            <xxf:case id="case3-3" visibility="visible"/>
                            <xxf:case id="case3-1" visibility="hidden"/>
                            <xxf:case id="case3-2" visibility="hidden"/>
                        </xxf:control>
                    </xxf:control-values>
                    <xxf:message level="modal">case1-3 - case1-3</xxf:message>
                    <xxf:message level="modal">case1-2 - case1-2</xxf:message>
                    <xxf:message level="modal">case1-1 - WRONG</xxf:message>
                    <xxf:message level="modal">case1-3 - case1-3</xxf:message>
                    <xxf:message level="modal">case2-1</xxf:message>
                    <xxf:message level="modal">case3-3</xxf:message>
                    <xxf:message level="modal">case3-3</xxf:message>
                </xxf:action>
            </xxf:event-response>
        </output>
    </test>

    <test description="#1089: XForms 2.0 caseref support: value support" name="oxf:pipeline">
        <input name="config" href="wrap-xforms-state.xpl"/>
        <input name="document">
            <xh:html>
                <xh:head>
                    <xf:model id="model">
                        <xf:instance id="instance" xxf:exclude-result-prefixes="#all">
                            <form>
                                <case>case3</case>
                                <case3-value>case3</case3-value>
                            </form>
                        </xf:instance>

                        <xf:action event="xforms-ready">
                            <!-- Test initial value -->
                            <xf:message value="concat(case('my-switch-1'), ' - ', case)"/>

                            <!-- Test change via caseref -->
                            <xf:setvalue ref="case" value="'case2'"/>
                            <xf:refresh/>
                            <xf:message value="concat(case('my-switch-1'), ' - ', case)"/>

                            <!-- Test default to first case -->
                            <xf:setvalue ref="case" value="'WRONG'"/>
                            <xf:refresh/>
                            <xf:message value="concat(case('my-switch-1'), ' - ', case)"/>

                            <!-- Test toggle -->
                            <xf:toggle case="case1-3"/>
                            <xf:refresh/>
                            <xf:message value="concat(case('my-switch-1'), ' - ', case)"/>
                        </xf:action>

                    </xf:model>
                </xh:head>
                <xh:body>
                    <xf:switch id="my-switch-1" caseref="case">
                        <xf:case id="case1-1" value="'case1'">1</xf:case>
                        <xf:case id="case1-2" value="'case2'" selected="true">2</xf:case>
                        <xf:case id="case1-3" value="case3-value">3</xf:case>
                    </xf:switch>
                </xh:body>
            </xh:html>
        </input>
        <output name="response">
            <xxf:event-response>
                <xxf:dynamic-state>
                    <dynamic-state>
                        <instances>
                            <instance id="instance" model-id="model">
                                <form>
                                    <case>case3</case>
                                    <case3-value>case3</case3-value>
                                </form>
                            </instance>
                        </instances>
                        <controls>
                            <control effective-id="my-switch-1" case-id="case1-3"/>
                        </controls>
                    </dynamic-state>
                </xxf:dynamic-state>
                <xxf:action>
                    <xxf:control-values>
                        <xxf:control id="my-switch-1">
                            <xxf:case id="case1-3" visibility="visible"/>
                            <xxf:case id="case1-1" visibility="hidden"/>
                            <xxf:case id="case1-2" visibility="hidden"/>
                        </xxf:control>
                    </xxf:control-values>
                    <xxf:message level="modal">case1-3 - case3</xxf:message>
                    <xxf:message level="modal">case1-2 - case2</xxf:message>
                    <xxf:message level="modal">case1-1 - WRONG</xxf:message>
                    <xxf:message level="modal">case1-3 - case3</xxf:message>
                </xxf:action>
            </xxf:event-response>
        </output>
    </test>

    <test description="#3976: Newly-relevant controls after repeat fail to update" name="oxf:pipeline">
        <input name="config" href="wrap-xforms-state.xpl"/>
        <input name="document">
            <xh:html>
                <xh:head>
                    <xf:model id="my-model" xxf:xpath-analysis="true">
                        <xf:instance id="my-instance">
                            <form>
                                <show>false</show>
                                <my-group>
                                    <my-repeat/>
                                </my-group>
                            </form>
                        </xf:instance>
                        <xf:bind
                            id="my-group-bind"
                            ref="my-group"
                            relevant="../show = 'true'"/>
                        <xf:setvalue
                            event="xforms-ready"
                            ref="show"
                            value="true()"/>
                    </xf:model>
                </xh:head>
                <xh:body>
                    <xf:group id="my-group" ref="my-group">
                        <xf:output id="my-output-41" value="41"/>
                        <xf:repeat id="my-repeat" ref="my-repeat"/>
                        <xf:output id="my-output-42" value="42"/>
                    </xf:group>
                </xh:body>
            </xh:html>

        </input>
        <output name="response">
            <xxf:event-response>
                <xxf:dynamic-state>
                    <dynamic-state>
                        <instances>
                            <instance id="my-instance" model-id="my-model">
                                <form>
                                    <show>true</show>
                                    <my-group>
                                        <my-repeat/>
                                    </my-group>
                                </form>
                            </instance>
                        </instances>
                        <controls>
                            <control effective-id="my-repeat" index="1"/>
                        </controls>
                    </dynamic-state>
                </xxf:dynamic-state>
                <xxf:action>
                    <xxf:control-values>
                        <xxf:control id="my-output-41">
                            <xxf:value>41</xxf:value>
                        </xxf:control>
                        <xxf:control id="my-output-42">
                            <xxf:value>42</xxf:value>
                        </xxf:control>
                    </xxf:control-values>
                </xxf:action>
           </xxf:event-response>
        </output>
    </test>

</group>
