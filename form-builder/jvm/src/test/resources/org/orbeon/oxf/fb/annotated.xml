<xh:html
        xmlns:xh="http://www.w3.org/1999/xhtml"
        xmlns:xf="http://www.w3.org/2002/xforms"
        xmlns:ev="http://www.w3.org/2001/xml-events"
        xmlns:xxf="http://orbeon.org/oxf/xml/xforms"
        xmlns:fr="http://orbeon.org/oxf/xml/form-runner">
    <xh:head>
        <xh:title/>
        <xf:model xmlns:fb="http://orbeon.org/oxf/xml/form-builder" xxf:custom-mips="" fb:added-empty-custom-mips="true" id="fr-form-model">
            <xf:instance id="fr-form-instance" xxf:index="id">
                <form>
                    <section-1>
                        <grid-1>
                            <control-1/>
                        </grid-1>
                        <grid-3>
                            <grid-3-iteration>
                                <control-5/>
                                <control-16 filename="" mediatype="" size=""/>
                            </grid-3-iteration>
                        </grid-3>
                        <grid-6>
                            <grid-6-iteration>
                                <control-8/>
                                <control-17 filename="" mediatype="" size=""/>
                            </grid-6-iteration>
                        </grid-6>
                    </section-1>
                    <section-9>
                        <section-9-iteration>
                            <grid-2>
                                <control-10/>
                            </grid-2>
                        </section-9-iteration>
                    </section-9>
                    <section-11>
                        <grid-12>
                            <grid-12-iteration>
                                <control-13/>
                            </grid-12-iteration>
                            <grid-12-iteration>
                                <control-13/>
                            </grid-12-iteration>
                        </grid-12>
                        <grid-14/>
                    </section-11>
                    <section-18>
                        <grid-19>
                            <grid-19-iteration foo=""/>
                            <grid-19-iteration foo=""/>
                        </grid-19>
                        <grid-22>
                            <grid-22-iteration bar=""/>
                            <grid-22-iteration bar=""/>
                        </grid-22>
                    </section-18>
                </form>
            </xf:instance>
            <xf:bind id="fr-form-binds" ref="instance('fr-form-instance')">
                <xf:bind id="section-1-bind" name="section-1" ref="section-1">
                    <xf:bind id="grid-1-bind" ref="grid-1" name="grid-1">
                        <xf:bind id="control-1-bind" name="control-1" ref="control-1" fb:constraint="true()" fb:default="42" type="xf:string">
                            <fb:default value="43"/>
                            <fb:constraint value="string-length() le 100" id="validation-1-validation"/>
                            <fb:constraint value="string-length() ge 10" id="validation-2-validation"/>
                            <xf:type id="validation-3-validation">xf:string</xf:type>
                            <xf:required value="true()" id="validation-4-validation"/>
                            <fb:default value="43"/>
                            <fb:constraint value="string-length() le 100" id="validation-5-validation"/>
                            <fb:constraint value="string-length() ge 10" id="validation-6-validation"/>
                            <xf:type id="validation-7-validation">xf:string</xf:type>
                            <xf:required value="true()" id="validation-8-validation"/>
                        </xf:bind>
                    </xf:bind>
                    <xf:bind id="grid-3-bind" ref="grid-3" name="grid-3">
                        <xf:bind id="grid-3-iteration-bind" ref="grid-3-iteration" name="grid-3-iteration">
                            <xf:bind id="control-5-bind" ref="control-5" name="control-5"/>
                            <xf:bind id="control-16-bind" ref="control-16" name="control-16" type="xf:anyURI"/>
                        </xf:bind>
                    </xf:bind>
                    <xf:bind id="grid-6-bind" ref="grid-6" name="grid-6">
                        <xf:bind id="grid-6-iteration-bind" ref="grid-6-iteration" name="grid-6-iteration">
                            <xf:bind id="control-8-bind" ref="control-8" name="control-8"/>
                            <xf:bind id="control-17-bind" ref="control-17" name="control-17" type="xf:anyURI"/>
                        </xf:bind>
                    </xf:bind>
                </xf:bind>
                <xf:bind id="section-9-bind" ref="section-9" name="section-9">
                    <xf:bind id="section-9-iteration-bind" ref="section-9-iteration" name="section-9-iteration">
                        <xf:bind id="grid-2-bind" ref="grid-2" name="grid-2">
                            <xf:bind id="control-10-bind" ref="control-10" name="control-10"/>
                        </xf:bind>
                    </xf:bind>
                </xf:bind>
                <xf:bind id="section-11-bind" ref="section-11" name="section-11">
                    <xf:bind id="grid-12-bind" ref="grid-12" name="grid-12">
                        <xf:bind id="grid-12-iteration-bind" ref="grid-12-iteration" name="grid-12-iteration">
                            <xf:bind id="control-13-bind" ref="control-13" name="control-13"/>
                        </xf:bind>
                    </xf:bind>
                    <xf:bind id="grid-14-bind" ref="grid-14" name="grid-14">
                        <xf:bind id="grid-14-iteration-bind" ref="grid-14-iteration" name="grid-14-iteration">
                            <xf:bind id="control-15-bind" ref="control-15" name="control-15"/>
                        </xf:bind>
                    </xf:bind>
                </xf:bind>
                <xf:bind id="section-18-bind" ref="section-18" name="section-18">
                    <xf:bind id="grid-19-bind" ref="grid-19" name="grid-19">
                        <xf:bind id="control-19-iteration-bind" ref="control-19-iteration" name="control-19-iteration">
                            <xf:bind id="control-20-bind" ref="@foo" name="control-20"/>
                            <xf:bind id="control-21-bind" ref="." name="control-21"/>
                        </xf:bind>
                    </xf:bind>
                    <xf:bind id="grid-22-bind" ref="grid-22" name="grid-22">
                        <xf:bind id="grid-22-iteration-bind" ref="grid-22-iteration" name="grid-22-iteration">
                            <xf:bind id="control-23-bind" ref="@bar" name="control-23"/>
                            <xf:bind id="control-24-bind" ref="." name="control-24"/>
                        </xf:bind>
                    </xf:bind>
                </xf:bind>
            </xf:bind>
            <xf:instance id="fr-form-resources" xxf:readonly="false">
                <resources>
                    <resource xml:lang="">
                        <section-1>
                            <label/>
                        </section-1>
                        <control-1>
                            <label/>
                            <hint/>
                            <alert/>
                        </control-1>
                        <control-5>
                            <label/>
                            <hint/>
                        </control-5>
                        <control-16>
                            <label/>
                            <hint/>
                        </control-16>
                        <control-8>
                            <label/>
                            <hint/>
                        </control-8>
                        <control-17>
                            <label/>
                            <hint/>
                        </control-17>
                        <control-10>
                            <label/>
                            <hint/>
                        </control-10>
                        <section-9>
                            <label/>
                            <help/>
                        </section-9>
                        <section-11>
                            <label/>
                            <help/>
                        </section-11>
                        <control-13>
                            <label/>
                            <hint/>
                        </control-13>
                        <control-15>
                            <label/>
                            <hint/>
                        </control-15>
                    </resource>
                </resources>
            </xf:instance>
            <xf:instance xxf:exclude-result-prefixes="#all" fb:readonly="true" id="grid-3-template">
                <grid-3-iteration>
                    <control-5/>
                    <control-16 filename="" mediatype="" size=""/>
                </grid-3-iteration>
            </xf:instance>
            <xf:instance xxf:exclude-result-prefixes="#all" fb:readonly="true" id="grid-6-template">
                <grid-6-iteration>
                    <control-8/>
                    <control-17 filename="" mediatype="" size=""/>
                </grid-6-iteration>
            </xf:instance>
            <xf:instance xxf:exclude-result-prefixes="#all" fb:readonly="true" id="section-9-template">
                <section-9-iteration>
                    <grid-2>
                        <control-10/>
                    </grid-2>
                </section-9-iteration>
            </xf:instance>
            <xf:instance xxf:exclude-result-prefixes="#all" fb:readonly="true" id="grid-12-template">
                <grid-12-iteration>
                    <control-13/>
                </grid-12-iteration>
            </xf:instance>
            <xf:instance xxf:exclude-result-prefixes="#all" fb:readonly="true" id="grid-14-template">
                <grid-14-iteration>
                    <control-15/>
                </grid-14-iteration>
            </xf:instance>
            <xf:instance xxf:exclude-result-prefixes="#all" fb:readonly="true" id="grid-19-template">
                <control-19-iteration foo=""/>
            </xf:instance>
            <xf:instance xxf:exclude-result-prefixes="#all" fb:readonly="true" id="grid-22-template">
                <grid-22-iteration bar=""/>
            </xf:instance>
            <xf:instance fb:readonly="true" id="my-custom-template">
                <my-custom-template-content/>
            </xf:instance>
            <xf:action fb:event="xforms-ready"/>
            <xf:action fb:event="xforms-model-construct-done"/>
            <fb:instance id="echo-instance" class="fr-service" xxf:exclude-result-prefixes="#all">
                <body>&lt;request/&gt;</body>
            </fb:instance>
            <fb:submission id="echo-submission" class="fr-service" ref="instance('fr-service-request-instance')" resource="/fr/service/custom/orbeon/echo" method="post" serialization="application/xml" mediatype="application/xml" replace="instance" instance="fr-service-response-instance"/>
            <fb:action id="fill-dropdown-binding">
                <!-- React to event... on control... -->
                <xf:action fb:event="fr-run-form-load-action-after-controls" ev:observer="fr-form-model" if="true()">
                    <!-- Service to call -->
                    <xf:send submission="echo-submission"/>
                </xf:action>
                <!-- Request actions -->
                <xf:action fb:event="xforms-submit" ev:observer="echo-submission">
                    <!-- Get reference to initial request -->
                    <xf:var name="request-instance-name" value="'echo-instance'" as="xs:string"/>
                    <!-- Copy over to read-write request instance -->
                    <xf:insert ref="instance('fr-service-request-instance')" origin="xf:parse(instance($request-instance-name))"/>
                    <!-- Set values if needed -->
                    <xf:action context="instance('fr-service-request-instance')">
                        <!-- Setvalue actions will be here -->
                    </xf:action>
                </xf:action>
                <!-- Response actions -->
                <xf:action fb:event="xforms-submit-done" ev:observer="echo-submission" context="instance('fr-service-response-instance')">
                    <xf:action class="fr-itemset-action">
                        <xf:var name="control-name" value="'dropdown'"/>
                        <xf:var name="response-items" value="/*/item"/>
                        <xf:var name="item-label" value="label"/>
                        <xf:var name="item-value" value="value"/>
                    </xf:action>
                    <xf:action class="fr-set-control-value-action">
                        <xf:var name="control-name" value="'dropdown'"/>
                        <xf:var name="control-value" value="/*/value"/>
                    </xf:action>
                    <xf:action class="fr-save-to-dataset-action">
                        <xf:var name="dataset-name">my-itemset</xf:var>
                    </xf:action>
                    <!-- Response actions will be here -->
                </xf:action>
            </fb:action>
            <xf:action event="xforms-model-construct" target="#observer" class="fb-annotation">
                <xf:dispatch name="fb-xforms-model-construct" targetid="|fr-form-model|"/>
            </xf:action>
            <xf:action event="xforms-recalculate" target="#observer" class="fb-annotation">
                <xf:dispatch name="fb-xforms-recalculate" targetid="|fr-form-model|"/>
            </xf:action>
            <xf:action event="xforms-revalidate" target="#observer" class="fb-annotation">
                <xf:dispatch name="fb-xforms-revalidate" targetid="|fr-form-model|"/>
            </xf:action>
            <xf:action event="xxforms-xpath-error" target="#observer" class="fb-annotation" defaultAction="cancel">
                <xf:dispatch name="fb-xxforms-xpath-error" targetid="|fr-form-model|"/>
            </xf:action>
            <xf:var xmlns:ev="http://www.w3.org/2001/xml-events" name="fr-roles" value="''" class="fb-annotation"/>
            <xf:var xmlns:ev="http://www.w3.org/2001/xml-events" name="fr-mode" value="'edit'" class="fb-annotation"/>
        </xf:model>
    </xh:head>
    <xh:body>
        <fr:view width="800px" appearance="custom">
            <xf:group id="fb-body" class="fb-body">
                <xf:var name="lang" value="xxf:get-variable('fr-form-model', 'fb-lang')" as="element()" class="fb-annotation"/>
                <xf:var name="form-resources" value="instance('fr-form-resources')/(resource[@xml:lang = $lang], resource[1])[1]" as="element(resource)?" class="fb-annotation"/>
                <xf:var name="fr-resources" value="xxf:get-variable('fr-resources-model', 'fr-fr-resources')" as="element(resource)?" class="fb-annotation"/>
                <xf:var name="fb-resources" value="xxf:get-variable('fr-resources-model', 'fr-form-resources')" as="element(resource)?" class="fb-annotation"/>
                <fr:section edit-ref="" xxf:update="full" id="section-1-control" bind="section-1-bind">
                   <xf:label ref="$form-resources/section-1/label"/>
                   <fr:grid edit-ref="" id="grid-1-grid" bind="grid-1-bind">
                       <fr:c y="1" x="1" w="6">
                           <xf:input id="control-1-control" bind="control-1-bind">
                               <xf:label ref="$form-resources/control-1/label"/>
                               <xf:hint ref="$form-resources/control-1/hint"/>
                               <xf:alert ref="$fr-resources/detail/labels/alert"/>
                           </xf:input>
                       </fr:c>
                       <fr:c y="1" x="7" w="6"/>
                   </fr:grid>
                   <fr:grid edit-ref="" id="grid-3-grid" bind="grid-3-bind" repeat="content" min="1" template="instance('grid-3-template')">
                       <fr:c y="1" x="1" w="6">
                           <xf:input id="control-5-control" bind="control-5-bind">
                               <xf:label ref="$form-resources/control-5/label"/>
                               <xf:hint ref="$form-resources/control-5/hint"/>
                               <xf:alert ref="$fr-resources/detail/labels/alert"/>
                           </xf:input>
                       </fr:c>
                       <fr:c y="1" x="7" w="6">
                           <fr:attachment id="control-16-control" bind="control-16-bind" class="fr-attachment">
                               <xf:label ref="$form-resources/control-16/label"/>
                               <xf:hint ref="$form-resources/control-16/hint"/>
                               <xf:alert ref="$fr-resources/detail/labels/alert"/>
                               <xf:filename ref="@filename"/>
                               <xf:mediatype ref="@mediatype"/>
                               <xxf:size ref="@size"/>
                           </fr:attachment>
                       </fr:c>
                   </fr:grid>
                   <fr:grid edit-ref="" id="grid-6-grid" bind="grid-6-bind" repeat="content" min="1" template="instance('grid-6-template')">
                       <fr:c y="1" x="1" w="6">
                           <xf:input id="control-8-control" bind="control-8-bind">
                               <xf:label ref="$form-resources/control-8/label"/>
                               <xf:hint ref="$form-resources/control-8/hint"/>
                               <xf:alert ref="$fr-resources/detail/labels/alert"/>
                           </xf:input>
                       </fr:c>
                       <fr:c y="1" x="7" w="6">
                           <fr:image-attachment id="control-17-control" bind="control-17-bind" class="fr-attachment">
                               <xf:label ref="$form-resources/control-17/label"/>
                               <xf:hint ref="$form-resources/control-17/hint"/>
                               <xf:alert ref="$fr-resources/detail/labels/alert"/>
                               <xf:filename ref="@filename"/>
                               <xf:mediatype ref="@mediatype"/>
                               <xxf:size ref="@size"/>
                           </fr:image-attachment>
                       </fr:c>
                   </fr:grid>
               </fr:section>
                <fr:section edit-ref="" xxf:update="full" id="section-9-control" bind="section-9-bind" repeat="content" min="1" template="instance('section-9-template')">
                    <xf:label ref="$form-resources/section-9/label"/>
                    <fr:grid edit-ref="" id="grid-2-grid" bind="grid-2-bind">
                        <fr:c y="1" x="1" w="12">
                            <xf:input id="control-10-control" bind="control-10-bind">
                                <xf:label ref="$form-resources/control-10/label"/>
                                <xf:hint ref="$form-resources/control-10/hint"/>
                                <xf:alert ref="$fr-resources/detail/labels/alert"/>
                            </xf:input>
                        </fr:c>
                    </fr:grid>
                </fr:section>
                <fr:section edit-ref="" xxf:update="full" id="section-11-control" bind="section-11-bind">
                    <xf:label ref="$form-resources/section-11/label"/>
                    <fr:grid edit-ref="" id="grid-12-grid" bind="grid-12-bind" repeat="content" template="instance('grid-12-template')">
                        <fr:c y="1" x="1" w="12">
                            <xf:input id="control-13-control" bind="control-13-bind">
                                <xf:label ref="$form-resources/control-13/label"/>
                                <xf:hint ref="$form-resources/control-13/hint"/>
                                <xf:alert ref="$fr-resources/detail/labels/alert"/>
                            </xf:input>
                        </fr:c>
                    </fr:grid>
                    <fr:grid edit-ref="" id="grid-14-grid" bind="grid-14-bind" repeat="content" template="instance('grid-14-template')">
                        <fr:c y="1" x="1" w="12">
                            <xf:input id="control-15-control" bind="control-15-bind">
                                <xf:label ref="$form-resources/control-15/label"/>
                                <xf:hint ref="$form-resources/control-15/hint"/>
                                <xf:alert ref="$fr-resources/detail/labels/alert"/>
                            </xf:input>
                        </fr:c>
                    </fr:grid>
                </fr:section>
                <fr:section edit-ref="" xxf:update="full" id="section-18-control" bind="section-18-bind">
                    <xf:label ref="$form-resources/section-18/label"/>
                    <fr:grid edit-ref="" id="grid-19-grid" bind="grid-19-bind" repeat="content" template="instance('grid-19-template')">
                        <fr:c y="1" x="1" w="6">
                            <xf:input id="control-20-control" bind="control-20-bind">
                                <xf:label ref="$form-resources/control-20/label"/>
                                <xf:hint ref="$form-resources/control-20/hint"/>
                            </xf:input>
                        </fr:c>
                        <fr:c y="1" x="7" w="6">
                            <xf:input id="control-21-control" bind="control-21-bind">
                                <xf:label ref="$form-resources/control-21/label"/>
                                <xf:hint ref="$form-resources/control-21/hint"/>
                            </xf:input>
                        </fr:c>
                    </fr:grid>
                    <fr:grid edit-ref="" id="grid-22-grid" bind="grid-22-bind" repeat="content" template="instance('grid-22-template')">
                        <fr:c y="1" x="1" w="6">
                            <xf:input id="control-23-control" bind="control-23-bind">
                                <xf:label ref="$form-resources/control-23/label"/>
                                <xf:hint ref="$form-resources/control-23/hint"/>
                            </xf:input>
                        </fr:c>
                        <fr:c y="1" x="7" w="6">
                            <xf:input id="control-24-control" bind="control-24-bind">
                                <xf:label ref="$form-resources/control-24/label"/>
                                <xf:hint ref="$form-resources/control-24/hint"/>
                            </xf:input>
                        </fr:c>
                    </fr:grid>
                </fr:section>
                <xf:action event="DOMActivate" xxf:phantom="true" class="fb-annotation">
                    <xf:var
                        name="control-element"
                        value="xxf:control-element(event('xxf:absolute-targetid'))"/>

                    <xf:action if="xxf:split($control-element/@class) = 'xforms-activable'">
                        <xf:var
                            name="new-selected-cell-id"
                            value="
                                        if ($control-element/@xxf:element = 'xh:th') then
                                            (: Q: Is this still working? What is it trying to do exactly? :)
                                            ($control-element/following-sibling::xf:repeat//*[@xxf:element = 'xh:td'])[
                                                count($control-element/preceding-sibling::*[@xxf:element = 'xh:th']) + 1
                                            ]/@id
                                        else
                                            $control-element/@id"/>
                        <xf:setvalue
                            ref="xxf:get-variable('fr-form-model', 'selected-cell')"
                            value="$new-selected-cell-id"/>
                    </xf:action>
                </xf:action>
                <xf:action
                    xmlns:fbf="java:org.orbeon.oxf.fb.FormBuilderXPathApi"
                    event="fr-iteration-added fr-iteration-removed"
                    class="fb-annotation"
                    type="xpath">fbf:updateTemplatesFromDynamicIterationChange(event('target'))</xf:action>
            </xf:group>
            <xf:group class="fr-buttons" ref="()">Custom buttons here</xf:group>
        </fr:view>
    </xh:body>
</xh:html>