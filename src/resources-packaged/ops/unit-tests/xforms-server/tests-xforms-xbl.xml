<!--
  Copyright (C) 2010 Orbeon, Inc.

  This program is free software; you can redistribute it and/or modify it under the terms of the
  GNU Lesser General Public License as published by the Free Software Foundation; either version
  2.1 of the License, or (at your option) any later version.

  This program is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY;
  without even the implied warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.
  See the GNU Lesser General Public License for more details.

  The full text of the license is available at http://www.gnu.org/copyleft/lesser.html
  -->
<group description="XForms XBL" xmlns:p="http://www.orbeon.com/oxf/pipeline"
    xmlns:xsl="http://www.w3.org/1999/XSL/Transform"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xmlns:xs="http://www.w3.org/2001/XMLSchema"
    xmlns:xhtml="http://www.w3.org/1999/xhtml"
    xmlns:oxf="http://www.orbeon.com/oxf/processors"
    xmlns:xi="http://www.w3.org/2001/XInclude"
    xmlns:xxi="http://orbeon.org/oxf/xml/xinclude"
    xmlns:xforms="http://www.w3.org/2002/xforms"
    xmlns:xf="http://www.w3.org/2002/xforms"
    xmlns:ev="http://www.w3.org/2001/xml-events"
    xmlns:xbl="http://www.w3.org/ns/xbl"
    xmlns:fr="http://orbeon.org/oxf/xml/form-runner">

    <test description="Event handler observing XBL bound element" name="oxf:pipeline">
        <input name="config" href="wrap-xforms-state.xpl"/>
        <input name="document">
            <xhtml:html xmlns:xxforms="http://orbeon.org/oxf/xml/xforms" xmlns:fr="http://orbeon.org/oxf/xml/form-runner"
                        xmlns:xbl="http://www.w3.org/ns/xbl" xmlns:xxbl="http://orbeon.org/oxf/xml/xbl">
                <xhtml:head>
                    <xforms:model id="model">
                        <xforms:instance id="instance">
                            <instance>
                                <foo1>42</foo1>
                            </instance>
                        </xforms:instance>
                    </xforms:model>
                    <xbl:xbl>
                        <xbl:binding id="fr-foo" element="fr|foo">
                            <xbl:template>
                                <xforms:model id="model">
                                    <xforms:instance id="instance">
                                        <instance/>
                                    </xforms:instance>
                                </xforms:model>
                                <xforms:group xbl:attr="model context ref bind" xxbl:scope="outer">
                                    <xbl:content includes="xforms|label,xforms|help,xforms|hint,xforms|alert"/>

                                    <xforms:group id="component-inner-group" appearance="xxforms:internal" xxbl:scope="inner">

                                        <xxforms:variable name="result" as="node()?">
                                            <xxforms:sequence select="." xxbl:scope="outer"/>
                                        </xxforms:variable>

                                        <!--<xxforms:variable name="inner" select="." as="node()?"/>-->

                                        <!-- React to update to bound node -->
                                        <xforms:group ref="$result" appearance="xxforms:internal" id="component-result-group">
                                            <xforms:action ev:event="xforms-value-changed xforms-enabled" if="$result castable as xs:integer">
                                                <xforms:setvalue ref="instance('instance')" value="xs:integer($result) + 1"/>
                                            </xforms:action>
                                        </xforms:group>

                                        <!-- Local controls -->
                                        <xforms:group appearance="xxforms:internal" id="component-controls-group">
                                            <xforms:input id="my-input" ref="."/>
                                            <xforms:setvalue ev:event="xforms-value-changed" if="context() castable as xs:integer" ref="$result" value="xs:integer(context()) - 1"/>
                                        </xforms:group>

                                        <!-- Stop propagation of all UI events -->
                                        <xforms:action ev:event="#all" ev:propagate="stop"/>

                                    </xforms:group>
                                </xforms:group>
                            </xbl:template>
                        </xbl:binding>
                    </xbl:xbl>
                </xhtml:head>
                <xhtml:body>
                    <fr:foo id="my-foo" ref="foo1">
                        <xforms:label>My label</xforms:label>
                    </fr:foo>
                </xhtml:body>
            </xhtml:html>
        </input>
        <output name="response">
            <xxf:event-response xmlns:xxf="http://orbeon.org/oxf/xml/xforms">
                <xxf:dynamic-state>
                    <dynamic-state>
                        <instances>
                            <instance id="instance" model-id="model">
                                <instance>
                                    <foo1>42</foo1>
                                </instance>
                            </instance>
                            <instance id="instance" model-id="my-foo$model">
                                <instance>43</instance>
                            </instance>
                        </instances>
                    </dynamic-state>
                </xxf:dynamic-state>
                <xxf:action>
                    <xxf:control-values>
                        <xxf:control id="my-foo$xf-3" label="My label"/>
                        <xxf:control id="my-foo$my-input">43</xxf:control>
                    </xxf:control-values>
                </xxf:action>
            </xxf:event-response>
        </output>
    </test>

    <test description="XBL Component in Repeat: Events Upon New Iteration" name="oxf:pipeline">
        <input name="config">
            <p:config xmlns:oxf="http://www.orbeon.com/oxf/processors" xmlns:xxforms="http://orbeon.org/oxf/xml/xforms">
                <p:param name="response" type="output"/>

                <p:processor name="oxf:pipeline">
                    <p:input name="config" href="wrap-xforms-state.xpl"/>
                    <p:input name="document">
                        <xhtml:html xmlns:fr="http://orbeon.org/oxf/xml/form-runner" xmlns:xxbl="http://orbeon.org/oxf/xml/xbl">
                            <xhtml:head>
                                <xforms:model id="main-model" xxforms:encrypt-item-values="false">
                                    <xforms:instance id="main-instance">
                                        <instance xmlns="">
                                            <date>2009-01-02</date>
                                            <date>2008-02-01</date>
                                        </instance>
                                    </xforms:instance>
                                    <xforms:bind nodeset="date1 | date2" type="xforms:date"/>

                                    <!-- TEST: Action to take on xforms-ready -->
                                    <xforms:action ev:event="xforms-ready">
                                        <!-- Tricky: add second refresh because first refresh causes a series of values set into nested components -->
                                        <xforms:refresh/>
                                        <xforms:refresh/>
                                        <xforms:delete nodeset="instance('events')/*"/>
                                        <xforms:dispatch name="DOMActivate" target="add-row-trigger"/>
                                    </xforms:action>

                                    <!-- TEST: Events to gather -->
                                    <xforms:instance id="events">
                                        <events/>
                                    </xforms:instance>
                                </xforms:model>

                                <xbl:xbl>
                                    <xbl:binding id="fr-dropdown-date-binding" element="fr|dropdown-date">
                                        <xbl:template>
                                            <!-- Local model -->
                                            <xforms:model id="date-model">
                                                <xforms:instance id="date-instance">
                                                    <date>
                                                        <year/>
                                                        <month/>
                                                        <day/>
                                                    </date>
                                                </xforms:instance>

                                                <xforms:instance id="years-itemset">
                                                    <years/>
                                                </xforms:instance>

                                                <xforms:instance id="months-itemset">
                                                    <months/>
                                                </xforms:instance>

                                                <xforms:instance id="days-itemset">
                                                    <days/>
                                                </xforms:instance>

                                                <!-- Initialize itemsets upon initialization -->
                                                <xforms:action ev:event="xforms-model-construct-done">
                                                    <xforms:action xxforms:iterate="(2007 to 2009)">
                                                        <xxforms:variable name="year" select="." as="xs:string"/>
                                                        <xforms:insert context="instance('years-itemset')" origin="xxforms:element('year', $year)"/>
                                                    </xforms:action>
                                                    <xforms:action xxforms:iterate="(1 to 3)">
                                                        <xxforms:variable name="month" select="." as="xs:string"/>
                                                        <xforms:insert context="instance('months-itemset')" nodeset="*" origin="xxforms:element('month', $month)"/>
                                                    </xforms:action>
                                                    <xforms:action xxforms:iterate="(1 to 3)">
                                                        <xxforms:variable name="day" select="." as="xs:string"/>
                                                        <xforms:insert context="instance('days-itemset')" nodeset="*" origin="xxforms:element('day', $day)"/>
                                                    </xforms:action>
                                                </xforms:action>
                                            </xforms:model>
                                            <!-- Local controls -->
                                            <xforms:group xbl:attr="model context ref bind" xxbl:scope="outer">
                                                <xbl:content includes="xforms|label,xforms|help,xforms|hint,xforms|alert"/>

                                                <xforms:group id="component-inner-group" appearance="xxforms:internal" xxbl:scope="inner">

                                                    <xxforms:variable id="result-variable" name="result" as="node()?">
                                                        <xxforms:sequence select="." xxbl:scope="outer"/>
                                                    </xxforms:variable>

                                                    <!-- React to update to bound node -->
                                                    <xforms:group ref="$result" appearance="xxforms:internal" id="component-result-group">
                                                        <!-- Only set local values if the bound node is an xs:date -->
                                                        <xforms:action ev:event="xforms-value-changed xforms-enabled" if="$result castable as xs:date" context="instance('date-instance')">
                                                            <xforms:setvalue ref="year" value="year-from-date($result)"/>
                                                            <xforms:setvalue ref="month" value="month-from-date($result)"/>
                                                            <xforms:setvalue ref="day" value="day-from-date($result)"/>
                                                        </xforms:action>
                                                    </xforms:group>

                                                    <xforms:group model="date-model" id="component-controls-group">
                                                        <xforms:select1 ref="year" xxforms:refresh-items="false" id="year-select">
                                                            <xforms:item>
                                                                <xforms:label>Year</xforms:label>
                                                                <xforms:value/>
                                                            </xforms:item>
                                                            <xforms:itemset nodeset="instance('years-itemset')/year">
                                                                <xforms:label ref="."/>
                                                                <xforms:value ref="."/>
                                                            </xforms:itemset>
                                                        </xforms:select1>
                                                        <xforms:select1 ref="month" xxforms:refresh-items="false" id="month-select">
                                                            <xforms:item>
                                                                <xforms:label>Month</xforms:label>
                                                                <xforms:value/>
                                                            </xforms:item>
                                                            <xforms:itemset nodeset="instance('months-itemset')/month">
                                                                <xforms:label ref="."/>
                                                                <xforms:value ref="."/>
                                                            </xforms:itemset>
                                                        </xforms:select1>
                                                        <xforms:select1 ref="day" xxforms:refresh-items="true" id="day-select">
                                                            <xforms:item>
                                                                <xforms:label>Day</xforms:label>
                                                                <xforms:value/>
                                                            </xforms:item>
                                                            <xforms:itemset nodeset="instance('days-itemset')/day">
                                                                <xforms:label ref="."/>
                                                                <xforms:value ref="."/>
                                                            </xforms:itemset>
                                                        </xforms:select1>

                                                        <!-- React to update to local values -->
                                                        <xforms:action ev:event="xforms-value-changed">
                                                            <!-- Only proceed if all parts are integers -->
                                                            <xforms:action if="year castable as xs:integer and month castable as xs:integer and day castable as xs:integer">
                                                                <xxforms:variable name="date-string" select="concat(year, '-', format-number(xs:integer(month), '00'), '-', format-number(xs:integer(day), '00'))" as="xs:string"/>
                                                                <!-- Only set value if the result is castable as a date -->
                                                                <xforms:setvalue if="$date-string castable as xs:date" ref="$result" value="$date-string"/>
                                                            </xforms:action>
                                                        </xforms:action>
                                                    </xforms:group>
                                                </xforms:group>

                                            </xforms:group>
                                        </xbl:template>
                                    </xbl:binding>
                                </xbl:xbl>

                            </xhtml:head>
                            <xhtml:body>
                                <xforms:group>
                                    <!-- TEST: Event listener -->
                                    <xforms:insert ev:event="xforms-value-changed xforms-enabled xforms-disabled"
                                                   context="instance('events')" nodeset="*"
                                                   origin="xxforms:element('event',
                                                            (xxforms:attribute('type', xxforms:event('xxforms:type')),
                                                             xxforms:attribute('target', xxforms:event('xxforms:targetid')),
                                                             xxforms:attribute('indexes', string-join(xxforms:event('xxforms:repeat-indexes'), ' '))))"/>

                                    <xforms:repeat nodeset="date" id="date-repeat">
                                        <fr:dropdown-date ref="." id="fr-dropdown-date">
                                            <xforms:label>Date: </xforms:label>
                                        </fr:dropdown-date>
                                    </xforms:repeat>

                                    <xforms:trigger id="add-row-trigger">
                                        <xforms:label>Add</xforms:label>
                                        <xforms:insert ev:event="DOMActivate" nodeset="date" at="index('date-repeat')"/>
                                    </xforms:trigger>

                                    <xforms:trigger id="remove-row-trigger">
                                        <xforms:label>Remove</xforms:label>
                                        <xforms:delete ev:event="DOMActivate" nodeset="date" at="index('date-repeat')"/>
                                    </xforms:trigger>
                                </xforms:group>

                            </xhtml:body>
                        </xhtml:html>
                    </p:input>
                    <p:output name="response" ref="response"/>
                </p:processor>

            </p:config>
        </input>
        <output name="response">
           <xxf:event-response xmlns:xxf="http://orbeon.org/oxf/xml/xforms">
                <xxf:dynamic-state>
                    <dynamic-state>
                        <instances>
                            <instance id="main-instance" model-id="main-model">
                                <instance>
                                    <date>2009-01-02</date>
                                    <date>2008-02-01</date>
                                    <date>2008-02-01</date>
                                </instance>
                            </instance>
                            <instance id="events" model-id="main-model">
                                <events>
                                    <event type="xforms-enabled" target="xf-25" indexes="2"/>
                                    <event type="xforms-enabled" target="component-inner-group" indexes="2"/>
                                    <event type="xforms-enabled" target="result-variable" indexes="2"/>
                                    <event type="xforms-enabled" target="component-result-group" indexes="2"/>
                                    <event type="xforms-enabled" target="component-controls-group" indexes="2"/>
                                    <event type="xforms-enabled" target="year-select" indexes="2"/>
                                    <event type="xforms-enabled" target="month-select" indexes="2"/>
                                    <event type="xforms-enabled" target="day-select" indexes="2"/>
                                    <event type="xforms-value-changed" target="year-select" indexes="2"/>
                                    <event type="xforms-value-changed" target="month-select" indexes="2"/>
                                    <event type="xforms-value-changed" target="day-select" indexes="2"/>
                                </events>
                            </instance>
                            <instance id="date-instance" model-id="fr-dropdown-date$date-model·1">
                                <date>
                                    <year>2009</year>
                                    <month>1</month>
                                    <day>2</day>
                                </date>
                            </instance>
                            <instance id="years-itemset" model-id="fr-dropdown-date$date-model·1">
                                <years>
                                    <year>2009</year>
                                    <year>2008</year>
                                    <year>2007</year>
                                </years>
                            </instance>
                            <instance id="months-itemset" model-id="fr-dropdown-date$date-model·1">
                                <months>
                                    <month>1</month>
                                    <month>2</month>
                                    <month>3</month>
                                </months>
                            </instance>
                            <instance id="days-itemset" model-id="fr-dropdown-date$date-model·1">
                                <days>
                                    <day>1</day>
                                    <day>2</day>
                                    <day>3</day>
                                </days>
                            </instance>
                            <instance id="date-instance" model-id="fr-dropdown-date$date-model·2">
                                <date>
                                    <year>2008</year>
                                    <month>2</month>
                                    <day>1</day>
                                </date>
                            </instance>
                            <instance id="years-itemset" model-id="fr-dropdown-date$date-model·2">
                                <years>
                                    <year>2009</year>
                                    <year>2008</year>
                                    <year>2007</year>
                                </years>
                            </instance>
                            <instance id="months-itemset" model-id="fr-dropdown-date$date-model·2">
                                <months>
                                    <month>1</month>
                                    <month>2</month>
                                    <month>3</month>
                                </months>
                            </instance>
                            <instance id="days-itemset" model-id="fr-dropdown-date$date-model·2">
                                <days>
                                    <day>1</day>
                                    <day>2</day>
                                    <day>3</day>
                                </days>
                            </instance>
                            <instance id="date-instance" model-id="fr-dropdown-date$date-model·3">
                                <date>
                                    <year>2008</year>
                                    <month>2</month>
                                    <day>1</day>
                                </date>
                            </instance>
                            <instance id="years-itemset" model-id="fr-dropdown-date$date-model·3">
                                <years>
                                    <year>2009</year>
                                    <year>2008</year>
                                    <year>2007</year>
                                </years>
                            </instance>
                            <instance id="months-itemset" model-id="fr-dropdown-date$date-model·3">
                                <months>
                                    <month>1</month>
                                    <month>2</month>
                                    <month>3</month>
                                </months>
                            </instance>
                            <instance id="days-itemset" model-id="fr-dropdown-date$date-model·3">
                                <days>
                                    <day>1</day>
                                    <day>2</day>
                                    <day>3</day>
                                </days>
                            </instance>
                        </instances>
                        <controls>
                            <control effective-id="date-repeat" index="2"/>
                        </controls>
                    </dynamic-state>
                </xxf:dynamic-state>
                <xxf:action>
                     <xxf:control-values>
                        <xxf:control id="fr-dropdown-date$xf-25·1" label="Date: "/>
                        <xxf:control id="fr-dropdown-date$year-select·1">2009</xxf:control>
                        <xxf:itemset id="fr-dropdown-date$year-select·1">[{"label":"Year","value":""},{"label":"2009","value":"2009"},{"label":"2008","value":"2008"},{"label":"2007","value":"2007"}]</xxf:itemset>
                        <xxf:control id="fr-dropdown-date$month-select·1">1</xxf:control>
                        <xxf:itemset id="fr-dropdown-date$month-select·1">[{"label":"Month","value":""},{"label":"1","value":"1"},{"label":"2","value":"2"},{"label":"3","value":"3"}]</xxf:itemset>
                        <xxf:control id="fr-dropdown-date$day-select·1">2</xxf:control>
                        <xxf:itemset id="fr-dropdown-date$day-select·1">[{"label":"Day","value":""},{"label":"1","value":"1"},{"label":"2","value":"2"},{"label":"3","value":"3"}]</xxf:itemset>
                        <xxf:control id="fr-dropdown-date$xf-25·2" label="Date: "/>
                        <xxf:control id="fr-dropdown-date$year-select·2">2008</xxf:control>
                        <xxf:itemset id="fr-dropdown-date$year-select·2">[{"label":"Year","value":""},{"label":"2009","value":"2009"},{"label":"2008","value":"2008"},{"label":"2007","value":"2007"}]</xxf:itemset>
                        <xxf:control id="fr-dropdown-date$month-select·2">2</xxf:control>
                        <xxf:itemset id="fr-dropdown-date$month-select·2">[{"label":"Month","value":""},{"label":"1","value":"1"},{"label":"2","value":"2"},{"label":"3","value":"3"}]</xxf:itemset>
                        <xxf:control id="fr-dropdown-date$day-select·2">1</xxf:control>
                        <xxf:itemset id="fr-dropdown-date$day-select·2">[{"label":"Day","value":""},{"label":"1","value":"1"},{"label":"2","value":"2"},{"label":"3","value":"3"}]</xxf:itemset>
                        <xxf:control id="fr-dropdown-date$xf-25·3" label="Date: "/>
                        <xxf:control id="fr-dropdown-date$year-select·3">2008</xxf:control>
                        <xxf:itemset id="fr-dropdown-date$year-select·3">[{"label":"Year","value":""},{"label":"2009","value":"2009"},{"label":"2008","value":"2008"},{"label":"2007","value":"2007"}]</xxf:itemset>
                        <xxf:control id="fr-dropdown-date$month-select·3">2</xxf:control>
                        <xxf:itemset id="fr-dropdown-date$month-select·3">[{"label":"Month","value":""},{"label":"1","value":"1"},{"label":"2","value":"2"},{"label":"3","value":"3"}]</xxf:itemset>
                        <xxf:control id="fr-dropdown-date$day-select·3">1</xxf:control>
                        <xxf:itemset id="fr-dropdown-date$day-select·3">[{"label":"Day","value":""},{"label":"1","value":"1"},{"label":"2","value":"2"},{"label":"3","value":"3"}]</xxf:itemset>
                        <xxf:control id="add-row-trigger" label="Add"/>
                        <xxf:control id="remove-row-trigger" label="Remove"/>
                    </xxf:control-values>
                </xxf:action>
            </xxf:event-response>
        </output>
    </test>

    <test description="XBL component with local model variables" name="oxf:pipeline">
        <input name="config">
            <p:config xmlns:oxf="http://www.orbeon.com/oxf/processors" xmlns:xxforms="http://orbeon.org/oxf/xml/xforms">
                <p:param name="response" type="output"/>

                <p:processor name="oxf:pipeline">
                    <p:input name="config" href="wrap-xforms-state.xpl"/>
                    <p:input name="document">
                        <xhtml:html xmlns:fr="http://orbeon.org/oxf/xml/form-runner" xmlns:exforms="http://www.exforms.org/exf/1-0" xmlns:xxbl="http://orbeon.org/oxf/xml/xbl">
                            <xhtml:head>
                                <xforms:model id="main-model">
                                    <xforms:instance id="main-instance">
                                        <values xmlns="">
                                            <value1>foo-value</value1>
                                            <value2>bar-value</value2>
                                        </values>
                                    </xforms:instance>
                                    <xforms:bind nodeset="value1" readonly="../value2 = '42'"/>
                                </xforms:model>
                                <xbl:xbl>
                                    <xbl:binding id="fr-super-control-binding" element="fr|super-control">
                                        <xbl:template>
                                            <xforms:model id="super-control-model">
                                                <xforms:instance id="super-control-instance">
                                                    <instance xmlns="">
                                                        <value/>
                                                        <name/>
                                                    </instance>
                                                </xforms:instance>
                                                <!-- TEST: The variable below must be found and not cause an error -->
                                                <xxforms:variable name="ctx" context="xxforms:component-context()" xbl:attr="select=ref" as="node()*"/>
                                                <xforms:bind nodeset="value" readonly="exforms:readonly($ctx)"/>
                                                <!-- TEST: The variable must point to the outer element -->
                                                <xforms:bind nodeset="name" calculate="name($ctx[1])"/>
                                            </xforms:model>

                                            <xforms:group xbl:attr="model context ref bind" xxbl:scope="outer">
                                                <xbl:content includes="xforms|label,xforms|help,xforms|hint,xforms|alert"/>

                                                <xforms:group id="component-inner-group" appearance="xxforms:internal" xxbl:scope="inner">

                                                    <xxforms:variable name="result" as="node()?">
                                                        <xxforms:sequence select="." xxbl:scope="outer"/>
                                                    </xxforms:variable>

                                                    <!-- React to update to bound node -->
                                                    <xforms:group ref="$result" appearance="xxforms:internal" id="component-result-group">
                                                        <xforms:action ev:event="xforms-value-changed xforms-enabled">
                                                            <xforms:setvalue ref="instance('super-control-instance')/value" value="$result"/>
                                                        </xforms:action>
                                                    </xforms:group>

                                                    <!-- Local controls -->
                                                    <xforms:group model="super-control-model" id="component-controls-group">

                                                        <xforms:input ref="value" id="my-input"/>

                                                        <!-- React to update to local controls -->
                                                        <xforms:action ev:event="xforms-value-changed">
                                                            <xforms:setvalue ref="$result" value="context()/value"/>
                                                        </xforms:action>
                                                    </xforms:group>
                                                </xforms:group>

                                            </xforms:group>
                                        </xbl:template>
                                    </xbl:binding>
                                </xbl:xbl>
                            </xhtml:head>
                            <xhtml:body>
                                <fr:super-control ref="value1" id="fr-super-control-1">
                                    <xforms:label>Internal value 1: </xforms:label>
                                </fr:super-control>
                                <fr:super-control ref="value2" id="fr-super-control-2">
                                    <xforms:label>Internal value 2: </xforms:label>
                                </fr:super-control>
                                <xforms:input ref="value1" id="input-1">
                                    <xforms:label>External value 1: </xforms:label>
                                </xforms:input>
                                <xforms:input ref="value2" id="input-2">
                                    <xforms:label>External value 2: </xforms:label>
                                </xforms:input>
                            </xhtml:body>
                        </xhtml:html>
                    </p:input>
                    <p:output name="response" ref="response"/>
                </p:processor>

            </p:config>
        </input>
        <output name="response">
           <xxf:event-response xmlns:xxf="http://orbeon.org/oxf/xml/xforms">
                <xxf:dynamic-state>
                    <dynamic-state>
                        <instances>
                            <instance id="main-instance" model-id="main-model">
                                <values>
                                    <value1>foo-value</value1>
                                    <value2>bar-value</value2>
                                </values>
                            </instance>
                            <instance id="super-control-instance" model-id="fr-super-control-1$super-control-model">
                                <instance>
                                    <value>foo-value</value>
                                    <name>value1</name>
                                </instance>
                            </instance>
                            <instance id="super-control-instance" model-id="fr-super-control-2$super-control-model">
                                <instance>
                                    <value>bar-value</value>
                                    <name>value2</name>
                                </instance>
                            </instance>
                        </instances>
                    </dynamic-state>
                </xxf:dynamic-state>
                <xxf:action>
                    <xxf:control-values>
                        <xxf:control id="fr-super-control-1$xf-9" label="Internal value 1: "/>
                        <xxf:control id="fr-super-control-1$my-input">foo-value</xxf:control>
                        <xxf:control id="fr-super-control-2$xf-21" label="Internal value 2: "/>
                        <xxf:control id="fr-super-control-2$my-input">bar-value</xxf:control>
                        <xxf:control id="input-1" label="External value 1: ">foo-value</xxf:control>
                        <xxf:control id="input-2" label="External value 2: ">bar-value</xxf:control>
                    </xxf:control-values>
                </xxf:action>
            </xxf:event-response>
        </output>
    </test>

    <test description="Dispatch event to model within XBL" name="oxf:pipeline">
        <input name="config">
            <p:config xmlns:oxf="http://www.orbeon.com/oxf/processors" xmlns:xxforms="http://orbeon.org/oxf/xml/xforms">
                <p:param name="response" type="output"/>

                <p:processor name="oxf:pipeline">
                    <p:input name="config" href="wrap-xforms-state.xpl"/>
                    <p:input name="document">
                        <xhtml:html xmlns:fr="http://orbeon.org/oxf/xml/form-runner">
                            <xhtml:head>
                                <!-- Model just so we get XForms processing -->
                                <xforms:model/>
                                <!-- XBL -->
                                <xbl:xbl xmlns:xbl="http://www.w3.org/ns/xbl">
                                    <xbl:binding id="component" element="fr|component">
                                        <xbl:template>
                                            <xforms:model id="xbl-model">
                                                <xforms:instance id="xbl-instance">
                                                    <value/>
                                                </xforms:instance>
                                                <!-- Dispatch event -->
                                                <xforms:dispatch ev:event="xforms-model-construct-done" name="doit" target="xbl-model"/>
                                                <!-- React to dispatched event -->
                                                <xforms:setvalue ev:event="doit" ref=".">gotit</xforms:setvalue>
                                            </xforms:model>
                                            <xforms:output id="xbl-output" model="xbl-model" ref="."/>
                                        </xbl:template>
                                    </xbl:binding>
                                </xbl:xbl>
                            </xhtml:head>
                            <xhtml:body>
                                <!-- Use component -->
                                <fr:component id="my-component"/>
                            </xhtml:body>
                        </xhtml:html>
                    </p:input>
                    <p:output name="response" ref="response"/>
                </p:processor>

            </p:config>
        </input>
        <output name="response">
           <xxf:event-response xmlns:xxf="http://orbeon.org/oxf/xml/xforms">
                <xxf:dynamic-state>
                    <dynamic-state>
                        <instances>
                            <instance id="xbl-instance" model-id="my-component$xbl-model">
                                <value>gotit</value>
                            </instance>
                        </instances>
                    </dynamic-state>
                </xxf:dynamic-state>
                <xxf:action>
                    <xxf:control-values>
                        <xxf:control id="my-component$xbl-output">gotit</xxf:control>
                    </xxf:control-values>
                </xxf:action>
            </xxf:event-response>
        </output>
    </test>

    <test description="Namespace in attribute in XBL" name="oxf:pipeline">
        <input name="config">
            <p:config xmlns:oxf="http://www.orbeon.com/oxf/processors" xmlns:xxforms="http://orbeon.org/oxf/xml/xforms">
                <p:param name="response" type="output"/>

                <p:processor name="oxf:pipeline">
                    <p:input name="config" href="wrap-xforms-state.xpl"/>
                    <p:input name="document">
                        <xhtml:html xmlns:fr="http://orbeon.org/oxf/xml/form-runner">
                            <xhtml:head>
                                <!-- Model just so we get XForms processing -->
                                <xforms:model/>
                            </xhtml:head>
                            <xhtml:body>
                                <!-- XBL -->
                                <xbl:xbl xmlns:xbl="http://www.w3.org/ns/xbl">
                                    <xbl:binding id="fr-data-bound-select1" element="fr|foobar">
                                        <xbl:template>
                                            <xforms:model id="xbl-model">
                                                <!-- Check that the namespace for xxforms:* is in scope: this must not cause a Java exception -->
                                                <xforms:message ev:event="xforms-model-construct-done" level="xxforms:log-info">Done!</xforms:message>
                                            </xforms:model>
                                        </xbl:template>
                                    </xbl:binding>
                                </xbl:xbl>
                                <!-- Use component -->
                                <fr:foobar id="my-component"/>
                            </xhtml:body>
                        </xhtml:html>
                    </p:input>
                    <p:output name="response" ref="response"/>
                </p:processor>

            </p:config>
        </input>
        <output name="response">
           <xxf:event-response xmlns:xxf="http://orbeon.org/oxf/xml/xforms">
                <xxf:dynamic-state>
                    <dynamic-state>
                        <instances/>
                    </dynamic-state>
                </xxf:dynamic-state>
                <xxf:action>
                    <xxf:control-values/>
                </xxf:action>
            </xxf:event-response>
        </output>
    </test>

    <test description="Send submission upon xforms-model-construct-done within XBL" name="oxf:pipeline">
        <input name="config">
            <p:config xmlns:oxf="http://www.orbeon.com/oxf/processors" xmlns:xxforms="http://orbeon.org/oxf/xml/xforms">
                <p:param name="response" type="output"/>

                <p:processor name="oxf:pipeline">
                    <p:input name="config" href="wrap-xforms-state.xpl"/>
                    <p:input name="document">
                        <xhtml:html xmlns:fr="http://orbeon.org/oxf/xml/form-runner">
                            <xhtml:head>
                                <!-- Model just so we get XForms processing -->
                                <xforms:model/>
                                <!-- XBL -->
                                <xbl:xbl xmlns:xbl="http://www.w3.org/ns/xbl">
                                    <xbl:binding id="component" element="fr|component">
                                        <xbl:template>
                                            <xforms:model id="xbl-model">

                                                <xforms:instance id="initial-instance">
                                                    <instance>
                                                        <value>1</value>
                                                    </instance>
                                                </xforms:instance>

                                                <xforms:instance id="new-instance">
                                                    <instance>
                                                        <value>2</value>
                                                    </instance>
                                                </xforms:instance>

                                                <xforms:submission id="replace-submission"
                                                                   ref="instance('new-instance')" method="post" resource="echo:"
                                                                   replace="instance" instance="initial-instance"
                                                                   xxforms:readonly="false"/>

                                                <!-- When this is called on xforms-ready, controls must update properly -->
                                                <xforms:send ev:event="xforms-model-construct-done" submission="replace-submission"/>

                                            </xforms:model>
                                            <xforms:output id="xbl-output" model="xbl-model" ref="."/>
                                        </xbl:template>
                                    </xbl:binding>
                                </xbl:xbl>
                            </xhtml:head>
                            <xhtml:body>
                                <!-- Use component -->
                                <fr:component id="my-component"/>
                            </xhtml:body>
                        </xhtml:html>
                    </p:input>
                    <p:output name="response" ref="response"/>
                </p:processor>

            </p:config>
        </input>
        <output name="response">
           <xxf:event-response xmlns:xxf="http://orbeon.org/oxf/xml/xforms">
                <xxf:dynamic-state>
                    <dynamic-state>
                        <instances>
                            <instance id="initial-instance" model-id="my-component$xbl-model" replaced="true">
                                <instance>
                                    <value>2</value>
                                </instance>
                            </instance>
                            <instance id="new-instance" model-id="my-component$xbl-model">
                                <instance>
                                    <value>2</value>
                                </instance>
                            </instance>
                        </instances>
                    </dynamic-state>
                </xxf:dynamic-state>
                <xxf:action>
                    <xxf:control-values>
                        <xxf:control id="my-component$xbl-output">2</xxf:control>
                    </xxf:control-values>
                </xxf:action>
            </xxf:event-response>
        </output>
    </test>

    <test description="Prefixing of @id and @for on HTML elements within XBL and repeats" name="oxf:pipeline">
        <input name="config">
            <p:config xmlns:oxf="http://www.orbeon.com/oxf/processors" xmlns:xxforms="http://orbeon.org/oxf/xml/xforms">
                <p:param name="response" type="output"/>

                <p:processor name="oxf:pipeline">
                    <p:input name="config" href="wrap-xforms-state.xpl"/>
                    <p:input name="document">
                        <xhtml:html xmlns:fr="http://orbeon.org/oxf/xml/form-runner" xmlns:xxbl="http://orbeon.org/oxf/xml/xbl">
                            <xhtml:head>
                                <xforms:model id="model">
                                    <xforms:instance id="instance">
                                        <values xmlns="">
                                            <value1>color: red</value1>
                                            <value2>font-weight: bold</value2>
                                        </values>
                                    </xforms:instance>
                                    <xforms:bind nodeset="value1" readonly="../value2 = '42'"/>
                                </xforms:model>
                                <xbl:xbl>
                                    <xbl:binding id="fr-super-control-binding" element="fr|super-control">
                                        <xbl:template>
                                            <xforms:group xbl:attr="ref" xxbl:scope="outer">
                                                <xhtml:div style="{.}">
                                                    Div 3
                                                </xhtml:div>
                                                <xhtml:input id="my-html-input" name="my-html-input"/>
                                                <xhtml:label for="my-html-input">This is an HTML control</xhtml:label>
                                            </xforms:group>
                                        </xbl:template>
                                    </xbl:binding>
                                </xbl:xbl>
                            </xhtml:head>
                            <xhtml:body>

                                <fr:super-control ref="value1" id="fr-super-control-1"/>
                                <fr:super-control ref="value2" id="fr-super-control-2"/>
                                <xforms:repeat id="repeat" nodeset="value1 | value2">
                                    <xhtml:div id="my-repeated-id">
                                        <fr:super-control ref="." id="fr-super-control-3"/>
                                    </xhtml:div>
                                </xforms:repeat>

                            </xhtml:body>
                        </xhtml:html>
                    </p:input>
                    <p:output name="response" ref="response"/>
                </p:processor>

            </p:config>
        </input>
        <output name="response">
<xxf:event-response xmlns:xxf="http://orbeon.org/oxf/xml/xforms">
    <xxf:dynamic-state>
        <dynamic-state>
            <instances>
                <instance id="instance" model-id="model">
                    <values>
                        <value1>color: red</value1>
                        <value2>font-weight: bold</value2>
                    </values>
                </instance>
            </instances>
            <controls>
                <control effective-id="repeat" index="1"/>
            </controls>
        </dynamic-state>
    </xxf:dynamic-state>
    <xxf:action>
        <xxf:control-values>
            <xxf:attribute id="fr-super-control-1$xf-6" for="fr-super-control-1$xf-5" name="style">color: red</xxf:attribute>
            <xxf:attribute id="fr-super-control-2$xf-10" for="fr-super-control-2$xf-9" name="style">font-weight: bold</xxf:attribute>
            <xxf:attribute id="fr-super-control-3$xf-14·1" for="fr-super-control-3$xf-13·1" name="style">color: red</xxf:attribute>
            <xxf:attribute id="fr-super-control-3$xf-14·2" for="fr-super-control-3$xf-13·2" name="style">font-weight: bold</xxf:attribute>
        </xxf:control-values>
    </xxf:action>
</xxf:event-response>
        </output>
    </test>

    <test description="XBL event retargeting and dispatch to bound node" name="oxf:pipeline">
        <input name="config">
            <p:config xmlns:oxf="http://www.orbeon.com/oxf/processors" xmlns:xxforms="http://orbeon.org/oxf/xml/xforms">
                <p:param name="response" type="output"/>

                <p:processor name="oxf:pipeline">
                    <p:input name="config" href="wrap-xforms-state.xpl"/>
                    <p:input name="document">
                        <xhtml:html xmlns:fr="http://orbeon.org/oxf/xml/form-runner">
                            <xhtml:head>
                                <xforms:model id="model">

                                    <!-- TEST: Events to gather -->
                                    <xforms:instance id="events">
                                        <events/>
                                    </xforms:instance>

                                </xforms:model>

                                <xbl:xbl>
                                    <xbl:binding id="foobar-component" element="fr|foobar">
                                        <xbl:template>
                                            <!-- Local model -->
                                            <xforms:model id="internal-model">
                                            </xforms:model>
                                            <!-- Local controls -->
                                            <xforms:group id="internal-group">
                                                <!-- React to creation of group -->
                                                <xforms:action ev:event="xforms-enabled" ev:target="internal-group">
                                                    <!-- Simulate user click on all triggers -->
                                                    <xforms:dispatch name="DOMActivate" target="internal-trigger-1"/>
                                                    <xforms:dispatch name="DOMActivate" target="internal-trigger-2"/>
                                                    <xforms:dispatch name="DOMActivate" target="internal-trigger-3"/>
                                                </xforms:action>

                                                <xforms:trigger id="internal-trigger-1">
                                                    <xforms:label>Dispatch outside</xforms:label>
                                                    <!-- Dispatch to bound node -->
                                                    <xforms:dispatch ev:event="DOMActivate" name="fr:my-event" target="foobar-component">
                                                        <xxforms:context name="fr:my-context" select="42"/>
                                                    </xforms:dispatch>
                                                </xforms:trigger>
                                                <xforms:trigger id="internal-trigger-2">
                                                    <xforms:label>Dispatch inside group</xforms:label>
                                                    <!-- Dispatch to local group -->
                                                    <xforms:dispatch ev:event="DOMActivate" name="fr:my-event" target="internal-group">
                                                        <xxforms:context name="fr:my-context" select="43"/>
                                                    </xforms:dispatch>
                                                </xforms:trigger>
                                                <xforms:trigger id="internal-trigger-3">
                                                    <xforms:label>Dispatch inside model</xforms:label>
                                                    <!-- Dispatch to local model -->
                                                    <xforms:dispatch ev:event="DOMActivate" name="fr:my-event" target="internal-model">
                                                        <xxforms:context name="fr:my-context" select="44"/>
                                                    </xforms:dispatch>
                                                </xforms:trigger>
                                            </xforms:group>
                                        </xbl:template>
                                    </xbl:binding>
                                </xbl:xbl>
                            </xhtml:head>
                            <xhtml:body>

                                <xforms:group id="external-group">
                                    <!-- Record all events -->
                                    <xforms:insert ev:event="#all"
                                                   context="instance('events')" nodeset="*"
                                                   origin="xxforms:element('event',
                                                            (xxforms:attribute('type', event('xxforms:type')),
                                                             xxforms:attribute('target', event('xxforms:targetid')),
                                                             xxforms:attribute('phase', event('xxforms:phase')),
                                                             xxforms:attribute('original-target', xxforms:event('xxforms:targetid')),
                                                             xxforms:attribute('indexes', string-join(event('xxforms:repeat-indexes'), ' ')),
                                                             xxforms:attribute('original-indexes', string-join(xxforms:event('xxforms:repeat-indexes'), ' '))))"/>

                                    <xforms:insert ev:event="#all" ev:phase="capture"
                                                   context="instance('events')" nodeset="*"
                                                   origin="xxforms:element('event',
                                                            (xxforms:attribute('type', event('xxforms:type')),
                                                             xxforms:attribute('target', event('xxforms:targetid')),
                                                             xxforms:attribute('phase', event('xxforms:phase')),
                                                             xxforms:attribute('original-target', xxforms:event('xxforms:targetid')),
                                                             xxforms:attribute('indexes', string-join(event('xxforms:repeat-indexes'), ' ')),
                                                             xxforms:attribute('original-indexes', string-join(xxforms:event('xxforms:repeat-indexes'), ' '))))"/>

                                    <fr:foobar id="my-foobar">
                                        <xforms:message ev:event="fr:my-event"><xforms:output value="concat('Got it: ', event('fr:my-context'))"/></xforms:message>
                                    </fr:foobar>
                                </xforms:group>
                            </xhtml:body>
                        </xhtml:html>
                    </p:input>
                    <p:output name="response" ref="response"/>
                </p:processor>

            </p:config>
        </input>
        <output name="response">
            <xxf:event-response xmlns:xxf="http://orbeon.org/oxf/xml/xforms">
                <xxf:dynamic-state>
                    <dynamic-state>
                        <instances>
                            <instance id="events" model-id="model">
                                <events>
                                    <event type="xforms-enabled" target="external-group" phase="target" original-target="external-group" indexes="" original-indexes=""/>
                                    <event type="xforms-enabled" target="my-foobar" phase="capture" original-target="internal-group" indexes="" original-indexes=""/>
                                    <event type="DOMActivate" target="my-foobar" phase="capture" original-target="internal-trigger-1" indexes="" original-indexes=""/>
                                    <event type="fr:my-event" target="my-foobar" phase="capture" original-target="my-foobar" indexes="" original-indexes=""/>
                                    <event type="fr:my-event" target="my-foobar" phase="bubbling" original-target="my-foobar" indexes="" original-indexes=""/>
                                    <event type="DOMActivate" target="my-foobar" phase="bubbling" original-target="internal-trigger-1" indexes="" original-indexes=""/>
                                    <event type="DOMActivate" target="my-foobar" phase="capture" original-target="internal-trigger-2" indexes="" original-indexes=""/>
                                    <event type="DOMActivate" target="my-foobar" phase="bubbling" original-target="internal-trigger-2" indexes="" original-indexes=""/>
                                    <event type="DOMActivate" target="my-foobar" phase="capture" original-target="internal-trigger-3" indexes="" original-indexes=""/>
                                    <event type="DOMActivate" target="my-foobar" phase="bubbling" original-target="internal-trigger-3" indexes="" original-indexes=""/>
                                    <event type="xforms-enabled" target="my-foobar" phase="bubbling" original-target="internal-group" indexes="" original-indexes=""/>
                                    <event type="xforms-enabled" target="my-foobar" phase="capture" original-target="internal-trigger-1" indexes="" original-indexes=""/>
                                    <event type="xforms-enabled" target="my-foobar" phase="bubbling" original-target="internal-trigger-1" indexes="" original-indexes=""/>
                                    <event type="xforms-enabled" target="my-foobar" phase="capture" original-target="internal-trigger-2" indexes="" original-indexes=""/>
                                    <event type="xforms-enabled" target="my-foobar" phase="bubbling" original-target="internal-trigger-2" indexes="" original-indexes=""/>
                                    <event type="xforms-enabled" target="my-foobar" phase="capture" original-target="internal-trigger-3" indexes="" original-indexes=""/>
                                    <event type="xforms-enabled" target="my-foobar" phase="bubbling" original-target="internal-trigger-3" indexes="" original-indexes=""/>
                                </events>
                            </instance>
                        </instances>
                    </dynamic-state>
                </xxf:dynamic-state>
                <xxf:action>
                    <xxf:control-values>
                        <xxf:control id="my-foobar$internal-trigger-1" label="Dispatch outside"/>
                        <xxf:control id="my-foobar$internal-trigger-2" label="Dispatch inside group"/>
                        <xxf:control id="my-foobar$internal-trigger-3" label="Dispatch inside model"/>
                    </xxf:control-values>
                    <xxf:message level="modal">Got it: 42</xxf:message>
                </xxf:action>
            </xxf:event-response>
        </output>
    </test>

    <test description="XBL namespace mapping clashes" name="oxf:pipeline">
        <input name="config">
            <p:config xmlns:oxf="http://www.orbeon.com/oxf/processors" xmlns:xxforms="http://orbeon.org/oxf/xml/xforms">
                <p:param name="response" type="output"/>

                <p:processor name="oxf:pipeline">
                    <p:input name="config" href="wrap-xforms-state.xpl"/>
                    <p:input name="document">
                        <xhtml:html xmlns:fr="http://orbeon.org/oxf/xml/form-runner" xmlns:xxbl="http://orbeon.org/oxf/xml/xbl">
                            <xhtml:head>
                                <xforms:model id="model">
                                    <xforms:instance id="instance">
                                        <value>Hello, world!</value>
                                    </xforms:instance>
                                </xforms:model>
                                <!-- First component -->
                                <xbl:xbl xmlns:exf="http://www.exforms.org/exf/1-0">
                                    <xbl:binding id="foo-component" element="fr|foo">
                                        <xbl:template>
                                            <xforms:group xxbl:scope="outer">
                                                <xxforms:variable name="result" as="node()?" xxbl:scope="inner">
                                                    <xxforms:sequence select="." xxbl:scope="outer"/>
                                                </xxforms:variable>
                                                <!-- Use prefix exf declared only in this XBL binding, and use on element with id "clash" -->
                                                <xforms:output id="clash" value="exf:readonly($result)" xxbl:scope="inner">
                                                    <xforms:label>Read-only: </xforms:label>
                                                </xforms:output>
                                            </xforms:group>
                                        </xbl:template>
                                    </xbl:binding>
                                </xbl:xbl>
                                <!-- Second component -->
                                <xbl:xbl>
                                    <xbl:binding id="bar-component" element="fr|bar">
                                        <xbl:template>
                                            <xforms:group xxbl:scope="outer">
                                                <xxforms:variable name="result" as="node()?" xxbl:scope="inner">
                                                    <xxforms:sequence select="." xxbl:scope="outer"/>
                                                </xxforms:variable>
                                                <!-- Element with id "clash" doesn't have the exf prefix used by the other component -->
                                                <xforms:output id="clash" ref="$result" xxbl:scope="inner">
                                                    <xforms:label>Message: </xforms:label>
                                                </xforms:output>
                                            </xforms:group>
                                        </xbl:template>
                                    </xbl:binding>
                                </xbl:xbl>
                            </xhtml:head>
                            <xhtml:body>

                                <!-- Use the XBL components: this must not cause an exception! -->
                                <fr:foo id="my-foo"/>
                                <fr:bar id="my-bar"/>

                            </xhtml:body>
                        </xhtml:html>
                    </p:input>
                    <p:output name="response" ref="response"/>
                </p:processor>

            </p:config>
        </input>
        <output name="response">
            <xxf:event-response xmlns:xxf="http://orbeon.org/oxf/xml/xforms">
                <xxf:dynamic-state>
                    <dynamic-state>
                        <instances>
                            <instance id="instance" model-id="model">
                                <value>Hello, world!</value>
                            </instance>
                        </instances>
                    </dynamic-state>
                </xxf:dynamic-state>
                <xxf:action>
                    <xxf:control-values>
                        <xxf:control id="my-foo$clash" label="Read-only: ">false</xxf:control>
                        <xxf:control id="my-bar$clash" label="Message: ">Hello, world!</xxf:control>
                    </xxf:control-values>
                </xxf:action>
            </xxf:event-response>
        </output>
    </test>

    <test description="Insert yields correct repeat index in XBL" name="oxf:pipeline">
        <input name="config">
            <p:config xmlns:oxf="http://www.orbeon.com/oxf/processors" xmlns:xxforms="http://orbeon.org/oxf/xml/xforms">
                <p:param name="response" type="output"/>

                <p:processor name="oxf:pipeline">
                    <p:input name="config" href="wrap-xforms-state.xpl"/>
                    <p:input name="document">
                        <xhtml:html xmlns:fr="http://orbeon.org/oxf/xml/form-runner">
                            <xhtml:head>
                                <xforms:model id="model">
                                    <xforms:instance id="instance">
                                        <instance xmlns="">
                                            <record/>
                                        </instance>
                                    </xforms:instance>

                                    <!-- Insert globally upon ready -->
                                    <xforms:insert ev:event="xforms-ready" nodeset="instance('instance')/record" at="1"/>

                                </xforms:model>

                                <xbl:xbl script-type="application/xhtml+xml">
                                    <xbl:binding id="fr-foo" element="fr|foo">
                                        <xbl:template>
                                            <xbl:content/>
                                        </xbl:template>
                                    </xbl:binding>
                                </xbl:xbl>

                                <xbl:xbl script-type="application/xhtml+xml">
                                    <xbl:binding id="fr-bar" element="fr|bar">
                                        <xbl:template>
                                            <xforms:model id="model">
                                                <xforms:instance id="instance">
                                                    <instance xmlns="">
                                                        <record/>
                                                    </instance>
                                                </xforms:instance>
                                                <!-- Insert locally upon xforms-enabled of the group -->
                                                <xforms:insert ev:event="xforms-enabled" ev:observer="bar-group" ev:target="bar-group" nodeset="instance('instance')/record" at="1"/>
                                            </xforms:model>
                                            <xforms:group id="bar-group" model="model" appearance="xxforms:internal">
                                                <xbl:content/>
                                            </xforms:group>
                                        </xbl:template>
                                    </xbl:binding>
                                </xbl:xbl>
                            </xhtml:head>
                            <xhtml:body>

                                <!-- Without XBL (update to global instance) -->
                                <xforms:repeat nodeset="record" id="repeat-no-xbl">
                                    <xforms:output id="my-output" value="index('repeat-no-xbl')"/>
                                </xforms:repeat>

                                <!-- With XBL (update to global instance) -->
                                <fr:foo id="my-foo">
                                    <xforms:repeat nodeset="record" id="repeat-xbl-foo">
                                        <xforms:output id="my-output-foo" value="index('repeat-xbl-foo')"/>
                                    </xforms:repeat>
                                </fr:foo>

                                <!-- With XBL (update to local instance) -->
                                <fr:bar id="my-bar">
                                    <xforms:repeat nodeset="record" id="repeat-xbl-bar">
                                        <xforms:output id="my-output-bar" value="index('repeat-xbl-bar')"/>
                                    </xforms:repeat>
                                </fr:bar>
                            </xhtml:body>
                        </xhtml:html>
                    </p:input>
                    <p:output name="response" ref="response"/>
                </p:processor>

            </p:config>
        </input>
        <output name="response">
            <xxf:event-response xmlns:xxf="http://orbeon.org/oxf/xml/xforms">
                <xxf:dynamic-state>
                    <dynamic-state>
                        <instances>
                            <instance id="instance" model-id="model">
                                <instance>
                                    <record/>
                                    <record/>
                                </instance>
                            </instance>
                            <instance id="instance" model-id="my-bar$model">
                                <instance>
                                    <record/>
                                    <record/>
                                </instance>
                            </instance>
                        </instances>
                        <controls>
                            <control effective-id="repeat-no-xbl" index="2"/>
                            <control effective-id="my-foo$repeat-xbl-foo" index="2"/>
                            <control effective-id="my-bar$repeat-xbl-bar" index="2"/>
                        </controls>
                    </dynamic-state>
                </xxf:dynamic-state>
                <xxf:action>
                    <xxf:control-values>
                        <xxf:control id="my-output·1">2</xxf:control>
                        <xxf:control id="my-output·2">2</xxf:control>
                        <xxf:control id="my-foo$my-output-foo·1">2</xxf:control>
                        <xxf:control id="my-foo$my-output-foo·2">2</xxf:control>
                        <xxf:control id="my-bar$my-output-bar·1">2</xxf:control>
                        <xxf:control id="my-bar$my-output-bar·2">2</xxf:control>
                    </xxf:control-values>
                </xxf:action>
            </xxf:event-response>
        </output>
    </test>

    <test description="Repeat index updates through user interaction inside and outside XBL" name="oxf:pipeline">
        <input name="config">
            <p:config xmlns:oxf="http://www.orbeon.com/oxf/processors" xmlns:xxforms="http://orbeon.org/oxf/xml/xforms">
                <p:param name="response" type="output"/>

                <p:processor name="oxf:pipeline">
                    <p:input name="config" href="wrap-xforms-state.xpl"/>
                    <p:input name="document">
                        <xhtml:html xmlns:fr="http://orbeon.org/oxf/xml/form-runner" xmlns:xxbl="http://orbeon.org/oxf/xml/xbl">
                            <xhtml:head>
                                <xforms:model id="model">
                                    <xforms:instance id="instance">
                                        <instance xmlns="">
                                            <record/>
                                        </instance>
                                    </xforms:instance>

                                    <xforms:action ev:event="xforms-ready">
                                        <!-- Insert one element, this takes index to 2 -->
                                        <xforms:insert nodeset="instance('instance')/record" at="1"/>
                                        <xforms:refresh/>
                                        <!-- Dispatch repeat focus to change the index back to 1 -->
                                        <xforms:dispatch name="xxforms-repeat-focus" target="my-output" xxforms:repeat-indexes="1"/>
                                    </xforms:action>

                                </xforms:model>

                                <xbl:xbl script-type="application/xhtml+xml">
                                    <xbl:binding id="fr-foo" element="fr|foo">
                                        <xbl:template>
                                            <xbl:content/>
                                        </xbl:template>
                                    </xbl:binding>
                                </xbl:xbl>

                                <xbl:xbl script-type="application/xhtml+xml">
                                    <xbl:binding id="fr-bar" element="fr|bar">
                                        <xbl:template>
                                            <xforms:model id="model">
                                                <xforms:instance id="instance">
                                                    <instance xmlns="">
                                                        <record/>
                                                    </instance>
                                                </xforms:instance>
                                                <xforms:action ev:event="xforms-model-construct-done">
                                                    <!-- Insert two element, this takes index to 3 -->
                                                    <xforms:insert nodeset="instance('instance')/record"/>
                                                    <xforms:insert nodeset="instance('instance')/record"/>
                                                </xforms:action>
                                                <xforms:action ev:event="xforms-enabled" ev:observer="bar-group" ev:target="bar-group">
                                                    <!-- Dispatch repeat focus to change the index back to 2 -->
                                                    <xforms:dispatch name="xxforms-repeat-focus" target="my-output-bar" xxforms:repeat-indexes="2"/>
                                                </xforms:action>
                                            </xforms:model>
                                            <xforms:group id="bar-group" model="model" appearance="xxforms:internal">
                                                <!-- You wouldn't usually set back the scope to "inner", but this is for testing only -->
                                                <xbl:content xxbl:scope="inner"/>
                                            </xforms:group>
                                        </xbl:template>
                                    </xbl:binding>
                                </xbl:xbl>
                            </xhtml:head>
                            <xhtml:body>
                                <!-- Without XBL (update to global instance) -->
                                <xforms:repeat nodeset="record" id="repeat-no-xbl">
                                    <xforms:output id="my-output" value="index('repeat-no-xbl')"/>
                                </xforms:repeat>

                                <!-- With XBL (update to global instance) -->
                                <fr:foo id="my-foo">
                                    <xforms:repeat nodeset="record" id="repeat-xbl-foo">
                                        <xforms:output id="my-output-foo" value="index('repeat-xbl-foo')"/>
                                    </xforms:repeat>
                                </fr:foo>

                                <!-- With XBL (update to local instance) -->
                                <fr:bar id="my-bar">
                                    <xforms:repeat nodeset="record" id="repeat-xbl-bar">
                                        <xforms:output id="my-output-bar" value="index('repeat-xbl-bar')"/>
                                    </xforms:repeat>
                                </fr:bar>
                            </xhtml:body>
                        </xhtml:html>
                    </p:input>
                    <p:output name="response" ref="response"/>
                </p:processor>

            </p:config>
        </input>
        <output name="response">
            <xxf:event-response xmlns:xxf="http://orbeon.org/oxf/xml/xforms">
                <xxf:dynamic-state>
                    <dynamic-state>
                        <instances>
                            <instance id="instance" model-id="model">
                                <instance>
                                    <record/>
                                    <record/>
                                </instance>
                            </instance>
                            <instance id="instance" model-id="my-bar$model">
                                <instance>
                                    <record/>
                                    <record/>
                                    <record/>
                                </instance>
                            </instance>
                        </instances>
                        <controls>
                            <control effective-id="repeat-no-xbl" index="1"/>
                            <control effective-id="my-foo$repeat-xbl-foo" index="2"/>
                            <control effective-id="my-bar$repeat-xbl-bar" index="2"/>
                        </controls>
                    </dynamic-state>
                </xxf:dynamic-state>
                <xxf:action>
                    <xxf:control-values>
                        <xxf:control id="my-output·1">1</xxf:control>
                        <xxf:control id="my-output·2">1</xxf:control>
                        <xxf:control id="my-foo$my-output-foo·1">2</xxf:control>
                        <xxf:control id="my-foo$my-output-foo·2">2</xxf:control>
                        <xxf:control id="my-bar$my-output-bar·1">2</xxf:control>
                        <xxf:control id="my-bar$my-output-bar·2">2</xxf:control>
                        <xxf:control id="my-bar$my-output-bar·3">2</xxf:control>
                    </xxf:control-values>
                </xxf:action>
            </xxf:event-response>
        </output>
    </test>

    <!-- NOTE: This was testing for id clash, but it is no longer possible use the same static id within a given scope. Remove? -->
    <!--<test description="Id clash between repeat in XBL with same id as non-repeat control outside XBL" name="oxf:pipeline">-->
        <!--<input name="config">-->
            <!--<p:config xmlns:oxf="http://www.orbeon.com/oxf/processors" xmlns:xxforms="http://orbeon.org/oxf/xml/xforms">-->
                <!--<p:param name="response" type="output"/>-->

                <!--<p:processor name="oxf:pipeline">-->
                    <!--<p:input name="config" href="wrap-xforms-state.xpl"/>-->
                    <!--<p:input name="document">-->
                        <!--<xhtml:html xmlns:fr="http://orbeon.org/oxf/xml/form-runner" xmlns:xxbl="http://orbeon.org/oxf/xml/xbl">-->
                            <!--<xhtml:head>-->
                                <!--<xforms:model id="model">-->
                                    <!--<xforms:instance id="instance">-->
                                        <!--<values>-->
                                            <!--<value/><value/>-->
                                        <!--</values>-->
                                    <!--</xforms:instance>-->
                                <!--</xforms:model>-->
                                <!--<xbl:xbl>-->
                                    <!--<xbl:binding id="foobar-component" element="fr|foobar">-->
                                        <!--<xbl:template>-->
                                            <!--<xforms:repeat xxbl:scope="outer" nodeset="value" id="clash">-->
                                                <!--<xforms:output value="xxforms:index()"/>-->
                                            <!--</xforms:repeat>-->
                                        <!--</xbl:template>-->
                                    <!--</xbl:binding>-->
                                <!--</xbl:xbl>-->
                            <!--</xhtml:head>-->
                            <!--<xhtml:body>-->
                                <!--<xforms:trigger id="clash">-->
                                    <!--<xforms:label>NOP</xforms:label>-->
                                <!--</xforms:trigger>-->
                                <!--<fr:foobar id="my-foobar" ref="."/>-->
                            <!--</xhtml:body>-->
                        <!--</xhtml:html>-->
                    <!--</p:input>-->
                    <!--<p:output name="response" ref="response"/>-->
                <!--</p:processor>-->
            <!--</p:config>-->
        <!--</input>-->
        <!--<output name="response">-->
            <!--<xxf:event-response xmlns:xxf="http://orbeon.org/oxf/xml/xforms">-->
                <!--<xxf:dynamic-state>-->
                    <!--<dynamic-state>-->
                        <!--<instances>-->
                            <!--<instance id="instance" model-id="model">-->
                                <!--<values>-->
                                    <!--<value/>-->
                                    <!--<value/>-->
                                <!--</values>-->
                            <!--</instance>-->
                        <!--</instances>-->
                        <!--<controls>-->
                            <!--<control effective-id="my-foobar$clash" index="1"/>-->
                        <!--</controls>-->
                    <!--</dynamic-state>-->
                <!--</xxf:dynamic-state>-->
                <!--<xxf:action>-->
                    <!--<xxf:control-values>-->
                        <!--<xxf:control id="clash" label="NOP"/>-->
                        <!--<xxf:control id="my-foobar$xf-4·1">1</xxf:control>-->
                        <!--<xxf:control id="my-foobar$xf-4·2">1</xxf:control>-->
                    <!--</xxf:control-values>-->
                <!--</xxf:action>-->
            <!--</xxf:event-response>-->
        <!--</output>-->
    <!--</test>-->

    <test description="XBL xxforms:instance() scoping" name="oxf:pipeline">
        <input name="config">
            <p:config xmlns:oxf="http://www.orbeon.com/oxf/processors" xmlns:xxforms="http://orbeon.org/oxf/xml/xforms">
                <p:param name="response" type="output"/>

                <p:processor name="oxf:pipeline">
                    <p:input name="config" href="wrap-xforms-state.xpl"/>
                    <p:input name="document">
                        <xhtml:html xmlns:fr="http://orbeon.org/oxf/xml/form-runner" xmlns:xxbl="http://orbeon.org/oxf/xml/xbl">
                            <xhtml:head>
                                <xforms:model id="model">
                                    <xforms:instance id="global-instance-1">
                                        <global-instance-1/>
                                    </xforms:instance>
                                    <xforms:instance id="global-instance-2">
                                        <global-instance-2/>
                                    </xforms:instance>
                                </xforms:model>

                                <xbl:xbl script-type="application/xhtml+xml">
                                    <xbl:binding id="fr-foobar" element="fr|foobar">
                                        <xbl:template>
                                            <xforms:model id="local-model">
                                                <xforms:instance id="local-instance">
                                                    <local-instance/>
                                                </xforms:instance>
                                            </xforms:model>

                                            <xforms:output value="name()" xxbl:scope="outer"/>
                                            <xforms:group>
                                                <xforms:output id="output-2" value="name()"/>
                                            </xforms:group>
                                            <xforms:output id="output-3" value="name(instance('local-instance'))"/>
                                            <xforms:output id="output-4" value="name(xxforms:instance('local-instance'))"/>
                                            <xforms:output id="output-5" value="name(xxforms:instance('global-instance-1'))"/>
                                            <xforms:output id="output-6" value="name(xxforms:instance('global-instance-2'))"/>
                                        </xbl:template>
                                    </xbl:binding>
                                </xbl:xbl>
                            </xhtml:head>
                            <xhtml:body>

                                <fr:foobar id="my-foobar"/>

                                <xforms:group id="my-group" context="instance('global-instance-2')">
                                    <fr:foobar id="my-foobar2"/>
                                </xforms:group>

                            </xhtml:body>
                        </xhtml:html>
                    </p:input>
                    <p:output name="response" ref="response"/>
                </p:processor>

            </p:config>
        </input>
        <output name="response">
            <xxf:event-response xmlns:xxf="http://orbeon.org/oxf/xml/xforms">
                <xxf:dynamic-state>
                    <dynamic-state>
                        <instances>
                            <instance id="global-instance-1" model-id="model">
                                <global-instance-1/>
                            </instance>
                            <instance id="global-instance-2" model-id="model">
                                <global-instance-2/>
                            </instance>
                            <instance id="local-instance" model-id="my-foobar$local-model">
                                <local-instance/>
                            </instance>
                            <instance id="local-instance" model-id="my-foobar2$local-model">
                                <local-instance/>
                            </instance>
                        </instances>
                    </dynamic-state>
                </xxf:dynamic-state>
                <xxf:action>
                    <xxf:control-values>
                        <xxf:control id="my-foobar$xf-3">global-instance-1</xxf:control>
                        <xxf:control id="my-foobar$output-2">local-instance</xxf:control>
                        <xxf:control id="my-foobar$output-3">local-instance</xxf:control>
                        <xxf:control id="my-foobar$output-4">local-instance</xxf:control>
                        <xxf:control id="my-foobar$output-5">global-instance-1</xxf:control>
                        <xxf:control id="my-foobar$output-6">global-instance-2</xxf:control>
                        <xxf:control id="my-foobar2$xf-6">global-instance-2</xxf:control>
                        <xxf:control id="my-foobar2$output-2">local-instance</xxf:control>
                        <xxf:control id="my-foobar2$output-3">local-instance</xxf:control>
                        <xxf:control id="my-foobar2$output-4">local-instance</xxf:control>
                        <xxf:control id="my-foobar2$output-5">global-instance-1</xxf:control>
                        <xxf:control id="my-foobar2$output-6">global-instance-2</xxf:control>
                    </xxf:control-values>
                </xxf:action>
            </xxf:event-response>
        </output>
    </test>

    <test description="XBL xbl:implementation and xbl:handler" name="oxf:pipeline">
        <input name="config">
            <p:config xmlns:oxf="http://www.orbeon.com/oxf/processors" xmlns:xxforms="http://orbeon.org/oxf/xml/xforms">
                <p:param name="response" type="output"/>

                <p:processor name="oxf:pipeline">
                    <p:input name="config" href="wrap-xforms-state.xpl"/>
                    <p:input name="document">
                        <xhtml:html xmlns:fr="http://orbeon.org/oxf/xml/form-runner">
                            <xhtml:head>
                                <xforms:model id="model">
                                    <xforms:instance id="instance">
                                        <instance xmlns=""/>
                                    </xforms:instance>

                                    <xforms:action ev:event="xforms-ready">
                                        <xforms:dispatch name="my-event" targetid="my-bar-1">
                                            <xxforms:context name="fr:one" select="'Red'"/>
                                            <xxforms:context name="fr:two" select="'Blue'"/>
                                        </xforms:dispatch>
                                        <xforms:dispatch name="my-event" targetid="my-bar-2">
                                            <xxforms:context name="fr:one" select="'Cat'"/>
                                            <xxforms:context name="fr:two" select="'Mouse'"/>
                                        </xforms:dispatch>
                                    </xforms:action>

                                </xforms:model>

                                <xbl:xbl script-type="application/xhtml+xml">
                                    <xbl:binding id="fr-bar" element="fr|bar">

                                        <xbl:handlers>
                                            <!-- Handlers are attached to the bound node -->
                                            <xbl:handler event="my-event" phase="target">
                                                <xforms:setvalue model="model" ref="value1" value="event('fr:one')"/>
                                                <xforms:setvalue model="model" ref="value2" value="event('fr:two')"/>
                                            </xbl:handler>

                                            <!-- TEST: Record all events -->
                                            <xbl:handler event="#all">
                                                <xforms:insert model="model"
                                                   context="instance('events')" nodeset="*"
                                                   origin="xxforms:element('event',
                                                            (xxforms:attribute('type', event('xxforms:type')),
                                                             xxforms:attribute('target', event('xxforms:targetid')),
                                                             xxforms:attribute('phase', event('xxforms:phase')),
                                                             xxforms:attribute('original-target', xxforms:event('xxforms:targetid')),
                                                             xxforms:attribute('indexes', string-join(event('xxforms:repeat-indexes'), ' ')),
                                                             xxforms:attribute('original-indexes', string-join(xxforms:event('xxforms:repeat-indexes'), ' '))))"/>
                                            </xbl:handler>
                                        </xbl:handlers>

                                        <!-- Test model placement within xbl:implementation -->
                                        <xbl:implementation>
                                            <!-- Local model with local data -->
                                            <xforms:model id="model">
                                                <xforms:instance id="instance">
                                                    <instance xmlns="">
                                                        <value1/>
                                                        <value2/>
                                                    </instance>
                                                </xforms:instance>
                                                <!-- TEST: Events to gather -->
                                                <xforms:instance id="events">
                                                    <events/>
                                                </xforms:instance>
                                            </xforms:model>
                                        </xbl:implementation>

                                        <!-- Template with just the controls -->
                                        <xbl:template>
                                            <xforms:group id="bar-group" model="model" appearance="xxforms:internal">
                                                <xforms:input id="input1" ref="value1"/>
                                                <xforms:input id="input2" ref="value2"/>
                                            </xforms:group>
                                        </xbl:template>
                                    </xbl:binding>
                                </xbl:xbl>
                            </xhtml:head>
                            <xhtml:body>
                                <fr:bar id="my-bar-1"/>
                                <fr:bar id="my-bar-2"/>
                            </xhtml:body>
                        </xhtml:html>
                    </p:input>
                    <p:output name="response" ref="response"/>
                </p:processor>

            </p:config>
        </input>
        <output name="response">
            <xxf:event-response xmlns:xxf="http://orbeon.org/oxf/xml/xforms">
                <xxf:dynamic-state>
                    <dynamic-state>
                        <instances>
                            <instance id="instance" model-id="model">
                                <instance/>
                            </instance>
                            <instance id="instance" model-id="my-bar-1$model">
                                <instance>
                                    <value1>Red</value1>
                                    <value2>Blue</value2>
                                </instance>
                            </instance>
                            <instance id="events" model-id="my-bar-1$model">
                                <events>
                                    <event type="xforms-enabled" target="my-bar-1" phase="bubbling" original-target="bar-group" indexes="" original-indexes=""/>
                                    <event type="xforms-enabled" target="my-bar-1" phase="bubbling" original-target="input1" indexes="" original-indexes=""/>
                                    <event type="xforms-enabled" target="my-bar-1" phase="bubbling" original-target="input2" indexes="" original-indexes=""/>
                                    <event type="my-event" target="my-bar-1" phase="target" original-target="my-bar-1" indexes="" original-indexes=""/>
                                    <event type="xforms-value-changed" target="my-bar-1" phase="bubbling" original-target="input1" indexes="" original-indexes=""/>
                                    <event type="xforms-value-changed" target="my-bar-1" phase="bubbling" original-target="input2" indexes="" original-indexes=""/>
                                </events>
                            </instance>
                            <instance id="instance" model-id="my-bar-2$model">
                                <instance>
                                    <value1>Cat</value1>
                                    <value2>Mouse</value2>
                                </instance>
                            </instance>
                            <instance id="events" model-id="my-bar-2$model">
                                <events>
                                    <event type="xforms-enabled" target="my-bar-2" phase="bubbling" original-target="bar-group" indexes="" original-indexes=""/>
                                    <event type="xforms-enabled" target="my-bar-2" phase="bubbling" original-target="input1" indexes="" original-indexes=""/>
                                    <event type="xforms-enabled" target="my-bar-2" phase="bubbling" original-target="input2" indexes="" original-indexes=""/>
                                    <event type="my-event" target="my-bar-2" phase="target" original-target="my-bar-2" indexes="" original-indexes=""/>
                                    <event type="xforms-value-changed" target="my-bar-2" phase="bubbling" original-target="input1" indexes="" original-indexes=""/>
                                    <event type="xforms-value-changed" target="my-bar-2" phase="bubbling" original-target="input2" indexes="" original-indexes=""/>
                                </events>
                            </instance>
                        </instances>
                    </dynamic-state>
                </xxf:dynamic-state>
                <xxf:action>
                    <xxf:control-values>
                        <xxf:control id="my-bar-1$input1">Red</xxf:control>
                        <xxf:control id="my-bar-1$input2">Blue</xxf:control>
                        <xxf:control id="my-bar-2$input1">Cat</xxf:control>
                        <xxf:control id="my-bar-2$input2">Mouse</xxf:control>
                    </xxf:control-values>
                </xxf:action>
            </xxf:event-response>
        </output>
    </test>

    <test description="XBL nested XBL references" name="oxf:pipeline">
        <input name="config">
            <p:config xmlns:oxf="http://www.orbeon.com/oxf/processors" xmlns:xxforms="http://orbeon.org/oxf/xml/xforms">
                <p:param name="response" type="output"/>

                <p:processor name="oxf:pipeline">
                    <p:input name="config" href="wrap-xforms-state.xpl"/>
                    <p:input name="document">
                        <xhtml:html xmlns:fr="http://orbeon.org/oxf/xml/form-runner">
                            <xhtml:head>
                                <xforms:model id="model">
                                    <xforms:instance id="main-instance">
                                            <instance xmlns="">42</instance>
                                        </xforms:instance>
                                    </xforms:model>

                                    <xbl:xbl script-type="application/xhtml+xml">
                                        <xbl:binding id="fr-foo" element="fr|foo">
                                            <xbl:template>
                                                <xhtml:fieldset>
                                                    <xhtml:legend>Foo 1</xhtml:legend>
                                                    <xbl:content/>
                                                </xhtml:fieldset>
                                                <xhtml:h2>Foo 2</xhtml:h2>
                                                <xbl:content/>
                                            </xbl:template>
                                        </xbl:binding>
                                    </xbl:xbl>

                                    <xbl:xbl script-type="application/xhtml+xml">
                                        <xbl:binding id="fr-bar" element="fr|bar">
                                            <xbl:template>
                                                <xhtml:fieldset>
                                                    <xhtml:legend>Bar 1</xhtml:legend>
                                                    <xbl:content/>
                                                </xhtml:fieldset>
                                                <xhtml:h2>Bar 2</xhtml:h2>
                                                <xbl:content/>
                                            </xbl:template>
                                        </xbl:binding>
                                    </xbl:xbl>
                                </xhtml:head>
                                <xhtml:body>

                                    <fr:foo id="my-foo">
                                        <fr:bar>
                                            <xforms:output value=".">
                                                <xforms:label>Life, etc.: </xforms:label>
                                            </xforms:output>
                                        </fr:bar>
                                    </fr:foo>

                                </xhtml:body>
                            </xhtml:html>
                    </p:input>
                    <p:output name="response" ref="response"/>
                </p:processor>

            </p:config>
        </input>
        <output name="response">
            <xxf:event-response xmlns:xxf="http://orbeon.org/oxf/xml/xforms">
                <xxf:dynamic-state>
                    <dynamic-state>
                        <instances>
                            <instance id="main-instance" model-id="model">
                                <instance>42</instance>
                            </instance>
                        </instances>
                    </dynamic-state>
                </xxf:dynamic-state>
                <xxf:action>
                    <xxf:control-values>
                        <xxf:control id="my-foo$xf-4$xf-7" label="Life, etc.: ">42</xxf:control>
                        <xxf:control id="my-foo$xf-4$xf-9" label="Life, etc.: ">42</xxf:control>
                        <xxf:control id="my-foo$xf-5$xf-12" label="Life, etc.: ">42</xxf:control>
                        <xxf:control id="my-foo$xf-5$xf-14" label="Life, etc.: ">42</xxf:control>
                    </xxf:control-values>
                </xxf:action>
            </xxf:event-response>
        </output>
    </test>

    <test description="XBL events through xbl:handler" name="oxf:pipeline">
        <input name="config">
            <p:config xmlns:oxf="http://www.orbeon.com/oxf/processors" xmlns:xxforms="http://orbeon.org/oxf/xml/xforms">
                <p:param name="response" type="output"/>

                <p:processor name="oxf:pipeline">
                    <p:input name="config" href="wrap-xforms-state.xpl"/>
                    <p:input name="document">
                        <xhtml:html xmlns:fr="http://orbeon.org/oxf/xml/form-runner" xmlns:xxbl="http://orbeon.org/oxf/xml/xbl">
                            <xhtml:head>
                                <xforms:model id="model">
                                    <xforms:dispatch ev:event="xforms-ready" name="up-value1" targetid="level1-component">
                                        <xxforms:context name="title-value1" select="'Cool title'"/>
                                    </xforms:dispatch>

                                    <!-- TEST: Events to gather -->
                                    <xforms:instance id="events">
                                        <events/>
                                    </xforms:instance>

                                    <xforms:instance xmlns="" id="main-instance">
                                        <root>
                                            <level1>
                                                <level2>
                                                    <level3>
                                                        <title/>
                                                    </level3>
                                                </level2>
                                            </level1>
                                        </root>
                                    </xforms:instance>

                                </xforms:model>
                                <xbl:xbl>
                                    <xbl:binding id="fr-level1-binding" element="fr|level1">
                                        <xbl:handlers>
                                            <xbl:handler event="#all" xxbl:scope="outer">
                                                <!-- TEST: Event listener -->
                                                <xforms:insert if="not(xxforms:event('xxforms:type') = 'xxforms-index-changed')" context="xxforms:instance('events')" nodeset="*"
                                                   origin="xxforms:element('event',
                                                            (xxforms:attribute('observer', 'fr-level1-binding'),
                                                             xxforms:attribute('type', xxforms:event('xxforms:type')),
                                                             xxforms:attribute('target', event('xxforms:targetid')),
                                                             xxforms:attribute('phase', event('xxforms:phase')),
                                                             xxforms:attribute('original-target', xxforms:event('xxforms:targetid')),
                                                             xxforms:attribute('indexes', string-join(xxforms:event('xxforms:repeat-indexes'), ' '))))"/>
                                            </xbl:handler>
                                            <xbl:handler event="up-value1" phase="target" xxbl:scope="outer">
                                                <xforms:dispatch name="up-value2" targetid="level2-component">
                                                    <xxforms:context name="title-value2" select="event('title-value1')"/>
                                                </xforms:dispatch>
                                            </xbl:handler>
                                        </xbl:handlers>
                                        <xbl:template>
                                            <xforms:repeat id="level1-repeat" nodeset="level1" xxbl:scope="outer">
                                                <fr:level2 id="level2-component">
                                                    <xforms:dispatch ev:event="down-2" name="down-1" targetid="fr-level1-binding" xxbl:scope="inner"/>
                                                </fr:level2>
                                            </xforms:repeat>
                                        </xbl:template>
                                    </xbl:binding>
                                </xbl:xbl>
                                <xbl:xbl>
                                    <xbl:binding id="fr-level2-binding" element="fr|level2">
                                        <xbl:handlers>
                                            <xbl:handler event="#all" xxbl:scope="outer">
                                                <!-- TEST: Event listener -->
                                                <xforms:insert if="not(xxforms:event('xxforms:type') = 'xxforms-index-changed')" context="xxforms:instance('events')" nodeset="*"
                                                   origin="xxforms:element('event',
                                                            (xxforms:attribute('observer', 'fr-level2-binding'),
                                                             xxforms:attribute('type', xxforms:event('xxforms:type')),
                                                             xxforms:attribute('target', event('xxforms:targetid')),
                                                             xxforms:attribute('phase', event('xxforms:phase')),
                                                             xxforms:attribute('original-target', xxforms:event('xxforms:targetid')),
                                                             xxforms:attribute('indexes', string-join(xxforms:event('xxforms:repeat-indexes'), ' '))))"/>
                                            </xbl:handler>
                                            <xbl:handler event="up-value2" phase="target" xxbl:scope="outer">
                                                <xforms:dispatch name="up-value3" targetid="level3-component">
                                                    <xxforms:context name="title-value3" select="event('title-value2')"/>
                                                </xforms:dispatch>
                                            </xbl:handler>
                                        </xbl:handlers>
                                        <xbl:template>
                                            <xforms:repeat id="level2-repeat" nodeset="level2" xxbl:scope="outer">
                                                <fr:level3 id="level3-component">
                                                    <xforms:dispatch ev:event="down-3" name="down-2" targetid="fr-level2-binding" xxbl:scope="inner"/>
                                                </fr:level3>
                                            </xforms:repeat>
                                        </xbl:template>
                                    </xbl:binding>
                                </xbl:xbl>
                                <xbl:xbl>
                                    <xbl:binding id="fr-level3-binding" element="fr|level3">
                                        <xbl:handlers>
                                            <xbl:handler event="#all" xxbl:scope="outer">
                                                <!-- TEST: Event listener -->
                                                <xforms:insert if="not(xxforms:event('xxforms:type') = 'xxforms-index-changed')" context="xxforms:instance('events')" nodeset="*"
                                                   origin="xxforms:element('event',
                                                            (xxforms:attribute('observer', 'fr-level3-binding'),
                                                             xxforms:attribute('type', xxforms:event('xxforms:type')),
                                                             xxforms:attribute('target', event('xxforms:targetid')),
                                                             xxforms:attribute('phase', event('xxforms:phase')),
                                                             xxforms:attribute('original-target', xxforms:event('xxforms:targetid')),
                                                             xxforms:attribute('indexes', string-join(xxforms:event('xxforms:repeat-indexes'), ' '))))"/>
                                            </xbl:handler>
                                            <xbl:handler event="up-value3" phase="target" xxbl:scope="outer">
                                                <!-- Set title value -->
                                                <xforms:setvalue ref="level3/title" value="event('title-value3')"/>

                                                <!-- Dispatch focus event to see it retarget/bubble to the top -->
                                                <xforms:dispatch name="DOMFocusIn" targetid="title-control"/>
                                            </xbl:handler>
                                        </xbl:handlers>
                                        <xbl:template>
                                            <xforms:repeat id="level3-repeat" nodeset="level3" xxbl:scope="outer">
                                                <xforms:input id="title-control" ref="title">
                                                    <xforms:dispatch ev:event="DOMFocusIn" name="down-3" targetid="fr-level3-binding" xxbl:scope="inner"/>
                                                </xforms:input>
                                            </xforms:repeat>
                                        </xbl:template>
                                    </xbl:binding>
                                </xbl:xbl>
                            </xhtml:head>
                            <xhtml:body>

                                <xforms:group context="instance('main-instance')" id="main-group">
                                    <!-- TEST: Event listener -->
                                    <xforms:insert if="not(xxforms:event('xxforms:type') = 'xxforms-index-changed')" ev:event="#all" context="instance('events')" nodeset="*"
                                                   origin="xxforms:element('event',
                                                            (xxforms:attribute('observer', 'main-group'),
                                                             xxforms:attribute('type', xxforms:event('xxforms:type')),
                                                             xxforms:attribute('target', event('xxforms:targetid')),
                                                             xxforms:attribute('phase', event('xxforms:phase')),
                                                             xxforms:attribute('original-target', xxforms:event('xxforms:targetid')),
                                                             xxforms:attribute('indexes', string-join(xxforms:event('xxforms:repeat-indexes'), ' '))))"/>

                                    <!-- Top-level component -->
                                    <fr:level1 id="level1-component"/>
                                </xforms:group>
                            </xhtml:body>
                        </xhtml:html>
                    </p:input>
                    <p:output name="response" ref="response"/>
                </p:processor>

            </p:config>
        </input>
        <output name="response">
            <xxf:event-response xmlns:xxf="http://orbeon.org/oxf/xml/xforms">
                <xxf:dynamic-state>
                    <dynamic-state>
                        <instances>
                            <instance id="events" model-id="model">
                                <events>
                                    <event observer="main-group" type="xforms-enabled" target="main-group" phase="target" original-target="main-group" indexes=""/>
                                    <event observer="fr-level1-binding" type="xforms-enabled" target="level1-component" phase="bubbling" original-target="level1-repeat" indexes=""/>
                                    <event observer="main-group" type="xforms-enabled" target="level1-component" phase="bubbling" original-target="level1-repeat" indexes=""/>
                                    <event observer="fr-level2-binding" type="xforms-enabled" target="level2-component" phase="bubbling" original-target="level2-repeat" indexes="1"/>
                                    <event observer="fr-level1-binding" type="xforms-enabled" target="level1-component" phase="bubbling" original-target="level2-repeat" indexes="1"/>
                                    <event observer="main-group" type="xforms-enabled" target="level1-component" phase="bubbling" original-target="level2-repeat" indexes="1"/>
                                    <event observer="fr-level3-binding" type="xforms-enabled" target="level3-component" phase="bubbling" original-target="level3-repeat" indexes="1 1"/>
                                    <event observer="fr-level2-binding" type="xforms-enabled" target="level2-component" phase="bubbling" original-target="level3-repeat" indexes="1 1"/>
                                    <event observer="fr-level1-binding" type="xforms-enabled" target="level1-component" phase="bubbling" original-target="level3-repeat" indexes="1 1"/>
                                    <event observer="main-group" type="xforms-enabled" target="level1-component" phase="bubbling" original-target="level3-repeat" indexes="1 1"/>
                                    <event observer="fr-level3-binding" type="xforms-enabled" target="level3-component" phase="bubbling" original-target="title-control" indexes="1 1 1"/>
                                    <event observer="fr-level2-binding" type="xforms-enabled" target="level2-component" phase="bubbling" original-target="title-control" indexes="1 1 1"/>
                                    <event observer="fr-level1-binding" type="xforms-enabled" target="level1-component" phase="bubbling" original-target="title-control" indexes="1 1 1"/>
                                    <event observer="main-group" type="xforms-enabled" target="level1-component" phase="bubbling" original-target="title-control" indexes="1 1 1"/>
                                    <event observer="fr-level1-binding" type="up-value1" target="level1-component" phase="target" original-target="level1-component" indexes=""/>
                                    <event observer="fr-level2-binding" type="up-value2" target="level2-component" phase="target" original-target="level2-component" indexes="1"/>
                                    <event observer="fr-level3-binding" type="up-value3" target="level3-component" phase="target" original-target="level3-component" indexes="1 1"/>
                                    <event observer="fr-level3-binding" type="down-3" target="level3-component" phase="target" original-target="level3-component" indexes="1 1"/>
                                    <event observer="fr-level2-binding" type="down-2" target="level2-component" phase="target" original-target="level2-component" indexes="1"/>
                                    <event observer="fr-level1-binding" type="down-1" target="level1-component" phase="target" original-target="level1-component" indexes=""/>
                                    <event observer="main-group" type="down-1" target="level1-component" phase="bubbling" original-target="level1-component" indexes=""/>
                                    <event observer="fr-level3-binding" type="DOMFocusIn" target="level3-component" phase="bubbling" original-target="title-control" indexes="1 1 1"/>
                                    <event observer="fr-level2-binding" type="DOMFocusIn" target="level2-component" phase="bubbling" original-target="title-control" indexes="1 1 1"/>
                                    <event observer="fr-level1-binding" type="DOMFocusIn" target="level1-component" phase="bubbling" original-target="title-control" indexes="1 1 1"/>
                                    <event observer="main-group" type="DOMFocusIn" target="level1-component" phase="bubbling" original-target="title-control" indexes="1 1 1"/>
                                    <event observer="main-group" type="up-value1" target="level1-component" phase="bubbling" original-target="level1-component" indexes=""/>
                                    <event observer="fr-level3-binding" type="xforms-value-changed" target="level3-component" phase="bubbling" original-target="title-control" indexes="1 1 1"/>
                                    <event observer="fr-level2-binding" type="xforms-value-changed" target="level2-component" phase="bubbling" original-target="title-control" indexes="1 1 1"/>
                                    <event observer="fr-level1-binding" type="xforms-value-changed" target="level1-component" phase="bubbling" original-target="title-control" indexes="1 1 1"/>
                                    <event observer="main-group" type="xforms-value-changed" target="level1-component" phase="bubbling" original-target="title-control" indexes="1 1 1"/>
                                </events>
                            </instance>
                            <instance id="main-instance" model-id="model">
                                <root>
                                    <level1>
                                        <level2>
                                            <level3>
                                                <title>Cool title</title>
                                            </level3>
                                        </level2>
                                    </level1>
                                </root>
                            </instance>
                        </instances>
                        <controls>
                            <control effective-id="level1-component$level1-repeat" index="1"/>
                            <control effective-id="level1-component$level2-component$level2-repeat·1" index="1"/>
                            <control effective-id="level1-component$level2-component$level3-component$level3-repeat·1-1" index="1"/>
                        </controls>
                    </dynamic-state>
                </xxf:dynamic-state>
                <xxf:action>
                    <xxf:control-values>
                        <xxf:control id="level1-component$level2-component$level3-component$title-control·1-1-1">Cool title</xxf:control>
                    </xxf:control-values>
                </xxf:action>
            </xxf:event-response>
        </output>
    </test>

    <test description="Simple toggle to XBL outer scope" name="oxf:pipeline">
        <input name="config" href="wrap-xforms-state.xpl"/>
        <input name="document">
            <xhtml:html xmlns:xxforms="http://orbeon.org/oxf/xml/xforms" xmlns:fr="http://orbeon.org/oxf/xml/form-runner">
                <xhtml:head>
                    <xforms:model id="model">
                        <xforms:instance id="instance">
                            <instance/>
                        </xforms:instance>

                        <!-- my-case-2 is copied via xbl:content, so must be visible to this toggle -->
                        <xforms:toggle ev:event="xforms-ready" case="my-case-2"/>

                    </xforms:model>
                    <xbl:xbl xmlns:xbl="http://www.w3.org/ns/xbl">
                        <xbl:binding id="fr-foobar" element="fr|foobar">
                            <xbl:template>
                                <xbl:content/>
                            </xbl:template>
                        </xbl:binding>
                    </xbl:xbl>
                </xhtml:head>
                <xhtml:body>
                    <fr:foobar id="my-foobar">
                        <xforms:switch id="my-switch">
                            <xforms:case id="my-case-1"/>
                            <xforms:case id="my-case-2"/>
                        </xforms:switch>
                    </fr:foobar>
                </xhtml:body>
            </xhtml:html>
        </input>
        <output name="response">
            <xxf:event-response xmlns:xxf="http://orbeon.org/oxf/xml/xforms">
                <xxf:dynamic-state>
                    <dynamic-state>
                        <instances>
                            <instance id="instance" model-id="model">
                                <instance/>
                            </instance>
                        </instances>
                        <controls>
                            <control effective-id="my-foobar$my-switch" case-id="my-case-2"/>
                        </controls>
                    </dynamic-state>
                </xxf:dynamic-state>
                <xxf:action>
                    <xxf:control-values>
                        <xxf:div id="my-foobar$my-case-2" visibility="visible"/>
                        <xxf:div id="my-foobar$my-case-1" visibility="hidden"/>
                    </xxf:control-values>
                </xxf:action>
            </xxf:event-response>
        </output>
    </test>

    <test description="Toggle through two levels of XBL outer scope" name="oxf:pipeline">
        <input name="config" href="wrap-xforms-state.xpl"/>
        <input name="document">
            <xhtml:html xmlns:xxforms="http://orbeon.org/oxf/xml/xforms" xmlns:fr="http://orbeon.org/oxf/xml/form-runner"
                        xmlns:xbl="http://www.w3.org/ns/xbl" xmlns:xxbl="http://orbeon.org/oxf/xml/xbl">
                <xhtml:head>
                    <xforms:model id="model">
                        <xforms:instance id="instance">
                            <instance/>
                        </xforms:instance>

                        <!-- my-case-2 is copied via xbl:content, so must be visible to this toggle -->
                        <xforms:toggle ev:event="xforms-ready" case="my-case-2"/>

                    </xforms:model>
                    <xbl:xbl>
                        <xbl:binding id="fr-foo" element="fr|foo">
                            <xbl:template>
                                <!-- Outer scope must be specified here; id will be generated automatically to be unique -->
                                <fr:bar xxbl:scope="outer">
                                    <xbl:content/>
                                </fr:bar>
                            </xbl:template>
                        </xbl:binding>
                    </xbl:xbl>
                    <xbl:xbl>
                        <xbl:binding id="fr-bar" element="fr|bar">
                            <xbl:template>
                                <xbl:content/>
                            </xbl:template>
                        </xbl:binding>
                    </xbl:xbl>
                </xhtml:head>
                <xhtml:body>
                    <fr:foo id="my-foo">
                        <xforms:switch id="my-switch">
                            <xforms:case id="my-case-1"/>
                            <xforms:case id="my-case-2"/>
                        </xforms:switch>
                    </fr:foo>
                </xhtml:body>
            </xhtml:html>
        </input>
        <output name="response">
            <xxf:event-response xmlns:xxf="http://orbeon.org/oxf/xml/xforms">
                <xxf:dynamic-state>
                    <dynamic-state>
                        <instances>
                            <instance id="instance" model-id="model">
                                <instance/>
                            </instance>
                        </instances>
                        <controls>
                            <control effective-id="my-foo$xf-5$my-switch" case-id="my-case-2"/>
                        </controls>
                    </dynamic-state>
                </xxf:dynamic-state>
                <xxf:action>
                    <xxf:control-values>
                        <xxf:div id="my-foo$xf-5$my-case-2" visibility="visible"/>
                        <xxf:div id="my-foo$xf-5$my-case-1" visibility="hidden"/>
                    </xxf:control-values>
                </xxf:action>
            </xxf:event-response>
        </output>
    </test>

    <test description="Automatic generation of unique id through outer scope" name="oxf:pipeline">
        <input name="config" href="wrap-xforms-state.xpl"/>
        <input name="document">
            <xhtml:html xmlns:xxforms="http://orbeon.org/oxf/xml/xforms" xmlns:fr="http://orbeon.org/oxf/xml/form-runner"
                        xmlns:xbl="http://www.w3.org/ns/xbl" xmlns:xxbl="http://orbeon.org/oxf/xml/xbl">
                <xhtml:head>
                    <xforms:model id="model">
                        <xforms:instance id="instance">
                            <instance>42</instance>
                        </xforms:instance>
                    </xforms:model>
                    <xbl:xbl>
                        <xbl:binding id="fr-foo" element="fr|foo">
                            <xbl:template>
                                <!-- group and input will get automatic unique ids in outer scope -->
                                <xforms:group xxbl:scope="outer">
                                    <xforms:input ref="."/>
                                </xforms:group>
                            </xbl:template>
                        </xbl:binding>
                    </xbl:xbl>
                </xhtml:head>
                <xhtml:body>
                    <!-- Use ids likely to cause clashes -->
                    <xforms:input ref="." id="xf-2"/>
                    <xforms:input ref="." id="xf-3"/>
                    <xforms:input ref="." id="xf-4"/>
                    <xforms:input ref="." id="xf-5"/>
                    <xforms:input ref="." id="xf-6"/>
                    <xforms:input ref="." id="xf-7"/>
                    <xforms:input ref="." id="xf-8"/>
                    <fr:foo id="my-foo-1"/>
                    <fr:foo id="my-foo-2"/>
                </xhtml:body>
            </xhtml:html>
        </input>
        <output name="response">
            <xxf:event-response xmlns:xxf="http://orbeon.org/oxf/xml/xforms">
                <xxf:dynamic-state>
                    <dynamic-state>
                        <instances>
                            <instance id="instance" model-id="model">
                                <instance>42</instance>
                            </instance>
                        </instances>
                    </dynamic-state>
                </xxf:dynamic-state>
                <xxf:action>
                    <xxf:control-values>
                        <xxf:control id="xf-2">42</xxf:control>
                        <xxf:control id="xf-3">42</xxf:control>
                        <xxf:control id="xf-4">42</xxf:control>
                        <xxf:control id="xf-5">42</xxf:control>
                        <xxf:control id="xf-6">42</xxf:control>
                        <xxf:control id="xf-7">42</xxf:control>
                        <xxf:control id="xf-8">42</xxf:control>
                        <xxf:control id="my-foo-1$xf-11">42</xxf:control>
                        <xxf:control id="my-foo-2$xf-14">42</xxf:control>
                    </xxf:control-values>
                </xxf:action>
            </xxf:event-response>
        </output>
    </test>

    <test description="Separation of inner/outer scope for id resolution" name="oxf:pipeline">
        <input name="config" href="wrap-xforms-state.xpl"/>
        <input name="document">
            <xhtml:html xmlns:xxforms="http://orbeon.org/oxf/xml/xforms" xmlns:fr="http://orbeon.org/oxf/xml/form-runner"
                        xmlns:xbl="http://www.w3.org/ns/xbl" xmlns:xxbl="http://orbeon.org/oxf/xml/xbl">
                <xhtml:head>
                    <xforms:model id="model">
                        <xforms:instance id="instance">
                            <instance/>
                        </xforms:instance>
                    </xforms:model>
                    <xbl:xbl>
                        <xbl:binding id="fr-foo" element="fr|foo">
                            <xbl:template>
                                <xforms:switch id="my-switch">
                                    <xforms:toggle ev:event="xforms-enabled" case="my-case-2"/>
                                    <xforms:case id="my-case-1"/>
                                    <xforms:case id="my-case-2"/>
                                    <xforms:case id="my-case-3"/>
                                </xforms:switch>
                            </xbl:template>
                        </xbl:binding>
                        <xbl:binding id="fr-bar" element="fr|bar">
                            <xbl:template>
                                <xforms:switch id="my-switch">
                                    <xforms:toggle ev:event="xforms-enabled" case="my-case-3"/>
                                    <xforms:case id="my-case-1"/>
                                    <xforms:case id="my-case-2"/>
                                    <xforms:case id="my-case-3"/>
                                </xforms:switch>
                            </xbl:template>
                        </xbl:binding>
                    </xbl:xbl>
                </xhtml:head>
                <xhtml:body>
                    <fr:foo id="my-foo-1"/>
                    <fr:foo id="my-foo-2"/>
                    <fr:bar id="my-bar-1"/>
                    <fr:bar id="my-bar-2"/>
                    <xforms:switch id="my-switch">
                        <xforms:toggle ev:event="xforms-enabled" case="my-case-1"/>
                        <xforms:case id="my-case-1"/>
                        <xforms:case id="my-case-2"/>
                        <xforms:case id="my-case-3" selected="true"/>
                    </xforms:switch>
                </xhtml:body>
            </xhtml:html>
        </input>
        <output name="response">
            <xxf:event-response xmlns:xxf="http://orbeon.org/oxf/xml/xforms">
                <xxf:dynamic-state>
                    <dynamic-state>
                        <instances>
                            <instance id="instance" model-id="model">
                                <instance/>
                            </instance>
                        </instances>
                        <controls>
                            <control effective-id="my-foo-1$my-switch" case-id="my-case-2"/>
                            <control effective-id="my-foo-2$my-switch" case-id="my-case-2"/>
                            <control effective-id="my-bar-1$my-switch" case-id="my-case-3"/>
                            <control effective-id="my-bar-2$my-switch" case-id="my-case-3"/>
                            <control effective-id="my-switch" case-id="my-case-1"/>
                        </controls>
                    </dynamic-state>
                </xxf:dynamic-state>
                <xxf:action>
                    <xxf:control-values>
                        <xxf:div id="my-foo-1$my-case-2" visibility="visible"/>
                        <xxf:div id="my-foo-1$my-case-1" visibility="hidden"/>
                        <xxf:div id="my-foo-1$my-case-3" visibility="hidden"/>
                        <xxf:div id="my-foo-2$my-case-2" visibility="visible"/>
                        <xxf:div id="my-foo-2$my-case-1" visibility="hidden"/>
                        <xxf:div id="my-foo-2$my-case-3" visibility="hidden"/>
                        <xxf:div id="my-bar-1$my-case-3" visibility="visible"/>
                        <xxf:div id="my-bar-1$my-case-1" visibility="hidden"/>
                        <xxf:div id="my-bar-1$my-case-2" visibility="hidden"/>
                        <xxf:div id="my-bar-2$my-case-3" visibility="visible"/>
                        <xxf:div id="my-bar-2$my-case-1" visibility="hidden"/>
                        <xxf:div id="my-bar-2$my-case-2" visibility="hidden"/>
                        <xxf:div id="my-case-1" visibility="visible"/>
                        <xxf:div id="my-case-2" visibility="hidden"/>
                        <xxf:div id="my-case-3" visibility="hidden"/>
                    </xxf:control-values>
                </xxf:action>
            </xxf:event-response>
        </output>
    </test>

    <test description="xforms:setindex causes outer model to be recalculated/revalidated" name="oxf:pipeline">
        <input name="config" href="wrap-xforms-state.xpl"/>
        <input name="document">
            <xhtml:html xmlns:xxforms="http://orbeon.org/oxf/xml/xforms" xmlns:fr="http://orbeon.org/oxf/xml/form-runner"
                        xmlns:xbl="http://www.w3.org/ns/xbl" xmlns:xxbl="http://orbeon.org/oxf/xml/xbl">
                <xhtml:head>
                    <xforms:model id="model">
                        <xforms:instance id="instance">
                            <instance>
                                <value>1</value>
                                <value>2</value>
                                <index/>
                            </instance>
                        </xforms:instance>

                        <xforms:bind nodeset="index" calculate="index('my-repeat')"/>

                        <xforms:setindex ev:event="xforms-ready" repeat="my-repeat" index="2"/>

                    </xforms:model>
                    <xbl:xbl>
                        <xbl:binding id="fr-foo" element="fr|foo">
                            <xbl:template>
                                <xforms:model id="foo-model">
                                    <xforms:instance id="foo-instance">
                                        <instance/>
                                    </xforms:instance>
                                </xforms:model>
                                <xbl:content/>
                            </xbl:template>
                        </xbl:binding>
                    </xbl:xbl>
                </xhtml:head>
                <xhtml:body>
                    <fr:foo id="my-foo">
                        <xforms:repeat id="my-repeat" nodeset="value">

                        </xforms:repeat>
                    </fr:foo>
                </xhtml:body>
            </xhtml:html>
        </input>
        <output name="response">
            <xxf:event-response xmlns:xxf="http://orbeon.org/oxf/xml/xforms">
                <xxf:dynamic-state>
                    <dynamic-state>
                        <instances>
                            <instance id="instance" model-id="model">
                                <instance>
                                    <value>1</value>
                                    <value>2</value>
                                    <index>2</index>
                                </instance>
                            </instance>
                            <instance id="foo-instance" model-id="my-foo$foo-model">
                                <instance/>
                            </instance>
                        </instances>
                        <controls>
                            <control effective-id="my-foo$my-repeat" index="2"/>
                        </controls>
                    </dynamic-state>
                </xxf:dynamic-state>
                <xxf:action>
                    <xxf:control-values/>
                </xxf:action>
            </xxf:event-response>
        </output>
    </test>

    <test description="Event handler observing XBL bound element" name="oxf:pipeline">
        <input name="config" href="wrap-xforms-state.xpl"/>
        <input name="document">
            <xhtml:html xmlns:xxforms="http://orbeon.org/oxf/xml/xforms" xmlns:fr="http://orbeon.org/oxf/xml/form-runner"
                        xmlns:xbl="http://www.w3.org/ns/xbl" xmlns:xxbl="http://orbeon.org/oxf/xml/xbl">
                <xhtml:head>
                    <xforms:model id="model">
                        <xforms:instance id="instance">
                            <instance/>
                        </xforms:instance>

                        <!-- TEST: Events to gather -->
                        <xforms:instance id="events">
                            <events/>
                        </xforms:instance>

                        <xforms:insert ev:event="my-event-1 my-event-2" context="instance('events')" nodeset="*"
                                       origin="xxforms:element('event',
                                                (xxforms:attribute('type', xxforms:event('xxforms:type')),
                                                 xxforms:attribute('target', xxforms:event('xxforms:targetid'))
                                                 ))"/>

                    </xforms:model>
                    <xbl:xbl>
                        <xbl:binding id="fr-foo" element="fr|foo">
                            <xbl:template>
                                <xbl:content includes="xforms|input" xmlns:xforms="http://www.w3.org/2002/xforms"/>
                            </xbl:template>
                        </xbl:binding>
                    </xbl:xbl>
                </xhtml:head>
                <xhtml:body>
                    <fr:foo id="my-foo">
                        <!-- Don't put an id on the action -->
                        <xforms:action ev:event="xforms-enabled xforms-disabled">
                            <xforms:insert context="instance('events')" nodeset="*"
                                           origin="xxforms:element('event',
                                                    (xxforms:attribute('type', xxforms:event('xxforms:type')),
                                                     xxforms:attribute('target', xxforms:event('xxforms:targetid'))
                                                     ))"/>
                            <xforms:dispatch name="my-event-1" targetid="model"/>
                        </xforms:action>
                        <xforms:input id="my-foo-input" ref="."/>
                    </fr:foo>
                    <fr:foo id="my-foo-2">
                        <!-- Put an id on the action -->
                        <xforms:action ev:event="xforms-enabled xforms-disabled" id="my-event">
                            <xforms:insert context="instance('events')" nodeset="*"
                                           origin="xxforms:element('event',
                                                    (xxforms:attribute('type', xxforms:event('xxforms:type')),
                                                     xxforms:attribute('target', xxforms:event('xxforms:targetid'))
                                                     ))"/>
                            <xforms:dispatch name="my-event-2" targetid="model"/>
                        </xforms:action>
                        <xforms:input id="my-foo-input-2" ref="."/>
                    </fr:foo>
                </xhtml:body>
            </xhtml:html>
        </input>
        <output name="response">
            <xxf:event-response xmlns:xxf="http://orbeon.org/oxf/xml/xforms">
                <xxf:dynamic-state>
                    <dynamic-state>
                        <instances>
                            <instance id="instance" model-id="model">
                                <instance/>
                            </instance>
                            <instance id="events" model-id="model">
                                <events>
                                    <event type="xforms-enabled" target="my-foo-input"/>
                                    <event type="my-event-1" target="model"/>
                                    <event type="xforms-enabled" target="my-foo-input-2"/>
                                    <event type="my-event-2" target="model"/>
                                </events>
                            </instance>
                        </instances>
                    </dynamic-state>
                </xxf:dynamic-state>
                <xxf:action>
                    <xxf:control-values/>
                </xxf:action>
            </xxf:event-response>
        </output>
    </test>

    <test description="Simple variable/sequence inner/outer scoping" name="oxf:pipeline">
        <input name="config" href="wrap-xforms-state.xpl"/>
        <input name="document">
            <xhtml:html xmlns:xxforms="http://orbeon.org/oxf/xml/xforms" xmlns:fr="http://orbeon.org/oxf/xml/form-runner"
                        xmlns:xbl="http://www.w3.org/ns/xbl" xmlns:xxbl="http://orbeon.org/oxf/xml/xbl">
                <xhtml:head>
                    <xforms:model id="model">
                        <xforms:instance id="instance">
                            <instance>
                                <foo>42</foo>
                                <bar>43</bar>
                            </instance>
                        </xforms:instance>
                    </xforms:model>
                    <xbl:xbl>
                        <xbl:binding id="fr-foo" element="fr|foo">
                            <xbl:template>
                                <!-- Outer group -->
                                <xforms:group xxbl:scope="outer" xbl:attr="model context ref bind">
                                    <xforms:output ref="."/>
                                    <!-- Inner group -->
                                    <xforms:group id="component-inner-group" appearance="xxforms:internal" xxbl:scope="inner">

                                        <!-- Variable pointing to external single-node binding -->
                                        <xxforms:variable name="result" as="node()?">
                                            <xxforms:sequence select="." xxbl:scope="outer"/>
                                        </xxforms:variable>

                                        <xforms:output id="my-inner-output" ref="$result"/>

                                    </xforms:group>
                                </xforms:group>
                            </xbl:template>
                        </xbl:binding>
                    </xbl:xbl>
                </xhtml:head>
                <xhtml:body>
                    <fr:foo id="my-foo-1" ref="foo"/>
                    <fr:foo id="my-foo-2" ref="bar"/>
                </xhtml:body>
            </xhtml:html>
        </input>
        <output name="response">
            <xxf:event-response xmlns:xxf="http://orbeon.org/oxf/xml/xforms">
                <xxf:dynamic-state>
                    <dynamic-state>
                        <instances>
                            <instance id="instance" model-id="model">
                                <instance>
                                    <foo>42</foo>
                                    <bar>43</bar>
                                </instance>
                            </instance>
                        </instances>
                    </dynamic-state>
                </xxf:dynamic-state>
                <xxf:action>
                    <xxf:control-values>
                        <xxf:control id="my-foo-1$xf-4">42</xxf:control>
                        <xxf:control id="my-foo-1$my-inner-output">42</xxf:control>
                        <xxf:control id="my-foo-2$xf-9">43</xxf:control>
                        <xxf:control id="my-foo-2$my-inner-output">43</xxf:control>
                    </xxf:control-values>
                </xxf:action>
            </xxf:event-response>
        </output>
    </test>

    <test description="Copied items have access to outer scope" name="oxf:pipeline">
        <input name="config" href="wrap-xforms-state.xpl"/>
        <input name="document">
            <xhtml:html xmlns:xxforms="http://orbeon.org/oxf/xml/xforms" xmlns:fr="http://orbeon.org/oxf/xml/form-runner"
                        xmlns:xbl="http://www.w3.org/ns/xbl" xmlns:xxbl="http://orbeon.org/oxf/xml/xbl">
                <xhtml:head>
                    <xforms:model id="model" xxforms:encrypt-item-values="false">
                        <xforms:instance id="instance">
                            <instance>
                                <foo>42</foo>
                                <bar>43</bar>
                            </instance>
                        </xforms:instance>
                        <xforms:instance id="items">
                            <items>
                                <item label="Apple" value="apple"/>
                                <item label="Orange" value="orange"/>
                                <item label="Banana" value="banana"/>
                                <item label="Kiwi" value="kiwi"/>
                            </items>
                        </xforms:instance>
                    </xforms:model>
                    <xbl:xbl>
                        <xbl:binding id="fr-foo" element="fr|foo">
                            <xbl:template>
                                <!-- Outer group -->
                                <xforms:group xxbl:scope="outer" xbl:attr="model context ref bind">
                                    <xforms:output ref="."/>
                                    <!-- Inner group -->
                                    <xforms:group id="component-inner-group" appearance="xxforms:internal" xxbl:scope="inner">

                                        <!-- Variable pointing to external single-node binding -->
                                        <xxforms:variable name="result" as="node()?">
                                            <xxforms:sequence select="." xxbl:scope="outer"/>
                                        </xxforms:variable>

                                        <xforms:select1 id="my-inner-select1" ref="$result">
                                            <xbl:content includes="fr|foo > xforms|itemset, fr|foo > xforms|choices, fr|foo > xforms:item"/>
                                        </xforms:select1>

                                    </xforms:group>
                                </xforms:group>
                            </xbl:template>
                        </xbl:binding>
                    </xbl:xbl>
                </xhtml:head>
                <xhtml:body>
                    <!-- Itemset -->
                    <fr:foo id="my-foo-1" ref="foo">
                        <xforms:itemset nodeset="instance('items')/item[position() mod 2 = 1]">
                            <xforms:label ref="@label"/>
                            <xforms:value ref="@value"/>
                        </xforms:itemset>
                    </fr:foo>
                    <!-- Choices and item -->
                    <fr:foo id="my-foo-2" ref="bar">
                        <xforms:choices>
                            <xforms:label ref="."/>
                            <xforms:item>
                                <xforms:label>Pear</xforms:label>
                                <xforms:value>pear</xforms:value>
                            </xforms:item>
                        </xforms:choices>
                        <xforms:choices>
                            <xforms:label ref="../foo"/>
                            <xforms:itemset nodeset="instance('items')/item[position() mod 2 = 0]">
                                <xforms:label ref="@label"/>
                                <xforms:value ref="@value"/>
                            </xforms:itemset>
                        </xforms:choices>
                        <xforms:item>
                            <xforms:label ref="instance('items')/item[1]/@label"/>
                            <xforms:value ref="instance('items')/item[1]/@value"/>
                        </xforms:item>
                    </fr:foo>
                </xhtml:body>
            </xhtml:html>
        </input>
        <output name="response">
            <xxf:event-response xmlns:xxf="http://orbeon.org/oxf/xml/xforms">
                <xxf:dynamic-state>
                    <dynamic-state>
                        <instances>
                            <instance id="instance" model-id="model">
                                <instance>
                                    <foo>42</foo>
                                    <bar>43</bar>
                                </instance>
                            </instance>
                            <instance id="items" model-id="model">
                                <items>
                                    <item label="Apple" value="apple"/>
                                    <item label="Orange" value="orange"/>
                                    <item label="Banana" value="banana"/>
                                    <item label="Kiwi" value="kiwi"/>
                                </items>
                            </instance>
                        </instances>
                    </dynamic-state>
                </xxf:dynamic-state>
                <xxf:action>
                    <xxf:control-values>
                        <xxf:control id="my-foo-1$xf-4">42</xxf:control>
                        <xxf:control id="my-foo-1$my-inner-select1">42</xxf:control>
                        <xxf:itemset id="my-foo-1$my-inner-select1">[{"label":"Apple","value":"apple"},{"label":"Banana","value":"banana"}]</xxf:itemset>
                        <xxf:control id="my-foo-2$xf-12">43</xxf:control>
                        <xxf:control id="my-foo-2$my-inner-select1">43</xxf:control>
                        <xxf:itemset id="my-foo-2$my-inner-select1">[{"label":"43","value":"","children":[{"label":"Pear","value":"pear"}]},{"label":"42","value":"","children":[{"label":"Orange","value":"orange"},{"label":"Kiwi","value":"kiwi"}]},{"label":"Apple","value":"apple"}]</xxf:itemset>
                    </xxf:control-values>
                </xxf:action>
            </xxf:event-response>
        </output>
    </test>

    <test description="Variable scoping doesn't affect following controls scoping" name="oxf:pipeline">
        <input name="config" href="wrap-xforms-state.xpl"/>
        <input name="document">
            <xhtml:html xmlns:xxforms="http://orbeon.org/oxf/xml/xforms" xmlns:fr="http://orbeon.org/oxf/xml/form-runner"
                        xmlns:xbl="http://www.w3.org/ns/xbl" xmlns:xxbl="http://orbeon.org/oxf/xml/xbl">
                <xhtml:head>
                    <xforms:model id="model">
                        <xforms:instance id="instance">
                            <instance>
                                <foo>42</foo>
                                <bar>43</bar>
                            </instance>
                        </xforms:instance>
                    </xforms:model>
                    <xbl:xbl>
                        <xbl:binding id="fr-foo" element="fr|foo">
                            <xbl:template>
                                <xforms:group xxbl:scope="outer" xbl:attr="model context ref bind">

                                    <xforms:output value="."/>

                                    <xxforms:variable name="result" as="node()?" xxbl:scope="inner">
                                        <xxforms:sequence select="." xxbl:scope="outer"/>
                                    </xxforms:variable>

                                    <xforms:group>
                                        <xxforms:variable name="result" as="node()?" select="."/>
                                        <xforms:output value="."/>
                                        <xforms:output value="$result"/>
                                    </xforms:group>

                                    <xforms:group id="my-inner-group" xxbl:scope="inner">
                                        <xforms:output id="my-output-1" value="."/>
                                        <xforms:output id="my-output-2" value="$result"/>
                                    </xforms:group>

                                </xforms:group>
                            </xbl:template>
                        </xbl:binding>
                    </xbl:xbl>
                </xhtml:head>
                <xhtml:body>
                    <fr:foo id="my-foo-1" ref="foo"/>
                </xhtml:body>
            </xhtml:html>
        </input>
        <output name="response">
            <xxf:event-response xmlns:xxf="http://orbeon.org/oxf/xml/xforms">
                <xxf:dynamic-state>
                    <dynamic-state>
                        <instances>
                            <instance id="instance" model-id="model">
                                <instance>
                                    <foo>42</foo>
                                    <bar>43</bar>
                                </instance>
                            </instance>
                        </instances>
                    </dynamic-state>
                </xxf:dynamic-state>
                <xxf:action>
                    <xxf:control-values>
                        <xxf:control id="my-foo-1$xf-4">42</xxf:control>
                        <xxf:control id="my-foo-1$xf-9">42</xxf:control>
                        <xxf:control id="my-foo-1$xf-10">42</xxf:control>
                        <xxf:control id="my-foo-1$my-output-2">42</xxf:control>
                    </xxf:control-values>
                </xxf:action>
            </xxf:event-response>
        </output>
    </test>

    <test description="Scoping of model variables upon model change" name="oxf:pipeline">
        <input name="config" href="wrap-xforms-state.xpl"/>
        <input name="document">
            <xhtml:html xmlns:xxforms="http://orbeon.org/oxf/xml/xforms" xmlns:fr="http://orbeon.org/oxf/xml/form-runner"
                        xmlns:xbl="http://www.w3.org/ns/xbl" xmlns:xxbl="http://orbeon.org/oxf/xml/xbl">
                <xhtml:head>
                    <xforms:model id="model1">
                        <xforms:instance id="instance1">
                            <instance>
                                <foo>42</foo>
                                <bar>43</bar>
                            </instance>
                        </xforms:instance>
                        <xxforms:variable name="foo" select="foo"/>
                        <xxforms:variable name="bar" select="bar"/>
                    </xforms:model>
                    <xforms:model id="model2">
                        <xforms:instance id="instance2">
                            <instance>
                                <foo>44</foo>
                                <bar>45</bar>
                            </instance>
                        </xforms:instance>
                        <xxforms:variable name="foo" select="foo"/>
                        <xxforms:variable name="bar" select="bar"/>
                    </xforms:model>
                    <xbl:xbl>
                        <xbl:binding id="fr-foo" element="fr|foo">
                            <xbl:template>
                                <xbl:content/>
                            </xbl:template>
                        </xbl:binding>
                    </xbl:xbl>
                </xhtml:head>
                <xhtml:body>
                    <!-- Top-level -->
                    <xforms:output id="output1" value="string-join((foo, bar, $foo, $bar), ', ')"/>
                    <xforms:group model="model2">
                        <xforms:output id="output2" value="string-join((foo, bar, $foo, $bar), ', ')"/>
                        <xforms:group model="model1">
                            <xforms:output id="output3" value="string-join((foo, bar, $foo, $bar), ', ')"/>
                        </xforms:group>
                    </xforms:group>
                    <xforms:group model="model2" context="bar">
                        <xforms:output id="output4" value="string-join((../foo, ., $foo, $bar), ', ')"/>
                        <xforms:group model="model1" context="foo">
                            <xforms:output id="output5" value="string-join((., ../bar, $foo, $bar), ', ')"/>
                        </xforms:group>
                    </xforms:group>
                    <!-- Nested within XBL -->
                    <fr:foo id="my-foo">
                        <xforms:output id="output6" value="string-join((foo, bar, $foo, $bar), ', ')"/>
                        <xforms:group model="model2">
                            <xforms:output id="output7" value="string-join((foo, bar, $foo, $bar), ', ')"/>
                            <xforms:group model="model1">
                                <xforms:output id="output8" value="string-join((foo, bar, $foo, $bar), ', ')"/>
                            </xforms:group>
                        </xforms:group>
                        <xforms:group model="model2" context="bar">
                            <xforms:output id="output9" value="string-join((../foo, ., $foo, $bar), ', ')"/>
                            <xforms:group model="model1" context="foo">
                                <xforms:output id="output10" value="string-join((., ../bar, $foo, $bar), ', ')"/>
                            </xforms:group>
                        </xforms:group>
                    </fr:foo>
                </xhtml:body>
            </xhtml:html>
        </input>
        <output name="response">
            <xxf:event-response xmlns:xxf="http://orbeon.org/oxf/xml/xforms">
                <xxf:dynamic-state>
                    <dynamic-state>
                        <instances>
                            <instance id="instance1" model-id="model1">
                                <instance>
                                    <foo>42</foo>
                                    <bar>43</bar>
                                </instance>
                            </instance>
                            <instance id="instance2" model-id="model2">
                                <instance>
                                    <foo>44</foo>
                                    <bar>45</bar>
                                </instance>
                            </instance>
                        </instances>
                    </dynamic-state>
                </xxf:dynamic-state>
                <xxf:action>
                    <xxf:control-values>
                        <xxf:control id="output1">42, 43, 42, 43</xxf:control>
                        <xxf:control id="output2">44, 45, 44, 45</xxf:control>
                        <xxf:control id="output3">42, 43, 44, 45</xxf:control>
                        <xxf:control id="output4">44, 45, 42, 43</xxf:control>
                        <xxf:control id="output5">42, 43, 42, 43</xxf:control>
                        <xxf:control id="my-foo$output6">42, 43, 42, 43</xxf:control>
                        <xxf:control id="my-foo$output7">44, 45, 44, 45</xxf:control>
                        <xxf:control id="my-foo$output8">42, 43, 42, 43</xxf:control>
                        <xxf:control id="my-foo$output9">44, 45, 42, 43</xxf:control>
                        <xxf:control id="my-foo$output10">42, 43, 42, 43</xxf:control>
                    </xxf:control-values>
                </xxf:action>
            </xxf:event-response>
        </output>
    </test>

    <test description="XBL outer group binding attributes" name="oxf:pipeline">
        <input name="config" href="wrap-xforms-state.xpl"/>
        <input name="document">
            <xhtml:html xmlns:xxforms="http://orbeon.org/oxf/xml/xforms" xmlns:fr="http://orbeon.org/oxf/xml/form-runner"
                        xmlns:xbl="http://www.w3.org/ns/xbl" xmlns:xxbl="http://orbeon.org/oxf/xml/xbl">
                <xhtml:head>
                    <xforms:model id="model1">
                        <xforms:instance id="instance1">
                            <instance>
                                <foo>42</foo>
                                <bar>43</bar>
                            </instance>
                        </xforms:instance>
                        <xforms:bind id="foo-bind1" nodeset="foo"/>
                        <xforms:bind id="bar-bind1" nodeset="bar"/>
                        <xxforms:variable name="foo" select="foo"/>
                        <xxforms:variable name="bar" select="bar"/>
                    </xforms:model>
                    <xforms:model id="model2">
                        <xforms:instance id="instance2">
                            <instance>
                                <foo>44</foo>
                                <bar>45</bar>
                            </instance>
                        </xforms:instance>
                        <xforms:bind id="foo-bind2" nodeset="foo"/>
                        <xforms:bind id="bar-bind2" nodeset="bar"/>
                        <xxforms:variable name="foo" select="foo"/>
                        <xxforms:variable name="bar" select="bar"/>
                    </xforms:model>
                    <xbl:xbl>
                        <xbl:binding id="fr-foo" element="fr|foo">
                            <xbl:template>
                                <xforms:group xbl:attr="model context ref bind" xxbl:scope="outer">
                                    <xforms:output value="."/>
                                </xforms:group>
                            </xbl:template>
                        </xbl:binding>
                    </xbl:xbl>
                </xhtml:head>
                <xhtml:body>
                    <fr:foo id="foo10"/>
                    <fr:foo id="foo11" ref="bar"/>
                    <fr:foo id="foo12" ref="$bar"/>
                    <fr:foo id="foo13" bind="foo-bind1"/>
                    <fr:foo id="foo14" bind="bar-bind1"/>
                    <fr:foo id="foo15" bind="foo-bind2"/>
                    <fr:foo id="foo16" bind="bar-bind2"/>

                    <fr:foo id="foo20" model="model2"/>
                    <fr:foo id="foo21" model="model2" ref="bar"/>
                    <fr:foo id="foo22" model="model2" ref="$bar"/>
                    <fr:foo id="foo23" model="model2" bind="foo-bind1"/>
                    <fr:foo id="foo24" model="model2" bind="bar-bind1"/>
                    <fr:foo id="foo25" model="model2" bind="foo-bind2"/>
                    <fr:foo id="foo26" model="model2" bind="bar-bind2"/>

                </xhtml:body>
            </xhtml:html>
        </input>
        <output name="response">
            <xxf:event-response xmlns:xxf="http://orbeon.org/oxf/xml/xforms">
                <xxf:dynamic-state>
                    <dynamic-state>
                        <instances>
                            <instance id="instance1" model-id="model1">
                                <instance>
                                    <foo>42</foo>
                                    <bar>43</bar>
                                </instance>
                            </instance>
                            <instance id="instance2" model-id="model2">
                                <instance>
                                    <foo>44</foo>
                                    <bar>45</bar>
                                </instance>
                            </instance>
                        </instances>
                    </dynamic-state>
                </xxf:dynamic-state>
                <xxf:action>
                    <xxf:control-values>
                        <xxf:control id="foo10$xf-8">42 43</xxf:control>
                        <xxf:control id="foo11$xf-11">43</xxf:control>
                        <xxf:control id="foo12$xf-14">43</xxf:control>
                        <xxf:control id="foo13$xf-17">42</xxf:control>
                        <xxf:control id="foo14$xf-20">43</xxf:control>
                        <xxf:control id="foo15$xf-23">44</xxf:control>
                        <xxf:control id="foo16$xf-26">45</xxf:control>
                        <xxf:control id="foo20$xf-29">44 45</xxf:control>
                        <xxf:control id="foo21$xf-32">45</xxf:control>
                        <xxf:control id="foo22$xf-35">45</xxf:control>
                        <xxf:control id="foo23$xf-38">42</xxf:control>
                        <xxf:control id="foo24$xf-41">43</xxf:control>
                        <xxf:control id="foo25$xf-44">44</xxf:control>
                        <xxf:control id="foo26$xf-47">45</xxf:control>
                    </xxf:control-values>
                </xxf:action>
            </xxf:event-response>
        </output>
    </test>

    <test description="Event handler in component observes object in outer scope" name="oxf:pipeline">
        <input name="config" href="wrap-xforms-state.xpl"/>
        <input name="document">
            <xhtml:html xmlns:xxforms="http://orbeon.org/oxf/xml/xforms" xmlns:fr="http://orbeon.org/oxf/xml/form-runner"
                        xmlns:xbl="http://www.w3.org/ns/xbl" xmlns:xxbl="http://orbeon.org/oxf/xml/xbl">
                <xhtml:head>
                    <xforms:model id="model1">
                        <xforms:instance id="instance1">
                            <instance>
                                <foo>42</foo>
                            </instance>
                        </xforms:instance>
                        <xforms:dispatch ev:event="xforms-ready" name="foobar" targetid="my-input"/>
                    </xforms:model>
                    <xbl:xbl>
                        <xbl:binding id="fr-foo" element="fr|foo">
                            <xbl:template>
                                <!-- NOTE: Put the entire group in outer scope, as we can't yet deal with different
                                     scopes for control and nested action -->
                                <xforms:group id="my-group" xxbl:scope="outer">
                                    <!-- Observe object in outer scope -->
                                    <xforms:setvalue ev:event="foobar" ev:observer="my-input" ref="foo">43</xforms:setvalue>
                                </xforms:group>
                            </xbl:template>
                        </xbl:binding>
                    </xbl:xbl>
                </xhtml:head>
                <xhtml:body>

                    <!-- Just a control to dispatch events to -->
                    <xforms:input id="my-input" ref="foo"/>
                    <!-- Instantiate component -->
                    <fr:foo/>

                </xhtml:body>
            </xhtml:html>
        </input>
        <output name="response">
            <xxf:event-response xmlns:xxf="http://orbeon.org/oxf/xml/xforms">
                <xxf:dynamic-state>
                    <dynamic-state>
                        <instances>
                            <instance id="instance1" model-id="model1">
                                <instance>
                                    <foo>43</foo>
                                </instance>
                            </instance>
                        </instances>
                    </dynamic-state>
                </xxf:dynamic-state>
                <xxf:action>
                    <xxf:control-values>
                        <xxf:control id="my-input">43</xxf:control>
                    </xxf:control-values>
                </xxf:action>
            </xxf:event-response>
        </output>
    </test>

    <!-- THIS TEST DOESN'T WORK, BUT IT SHOULD! -->
    <test description="Event handler outside component observes object within component" name="oxf:pipeline" exclude="true">
        <input name="config" href="wrap-xforms-state.xpl"/>
        <input name="document">
            <xhtml:html xmlns:xxforms="http://orbeon.org/oxf/xml/xforms" xmlns:fr="http://orbeon.org/oxf/xml/form-runner"
                        xmlns:xbl="http://www.w3.org/ns/xbl" xmlns:xxbl="http://orbeon.org/oxf/xml/xbl">
                <xhtml:head>
                    <xforms:model id="model1">
                        <xforms:instance id="instance1">
                            <instance>
                                <foo>42</foo>
                            </instance>
                        </xforms:instance>
                        <xforms:dispatch ev:event="xforms-ready" name="foobar" targetid="my-input"/>
                    </xforms:model>
                    <xbl:xbl>
                        <xbl:binding id="fr-foo" element="fr|foo">
                            <xbl:template>
                                <xforms:group id="my-group">
                                    <!-- Insert content in outer scope -->
                                    <xbl:content/>
                                </xforms:group>
                            </xbl:template>
                        </xbl:binding>
                    </xbl:xbl>
                </xhtml:head>
                <xhtml:body>
                    <xforms:group id="my-group">
                        <!-- Observe object within component -->
                        <xforms:setvalue ev:event="foobar" ev:observer="my-input" ref="foo">43</xforms:setvalue>

                        <!-- Instantiate component -->
                        <fr:foo id="my-foo">
                            <xforms:input id="my-input" ref="foo"/>
                        </fr:foo>
                    </xforms:group>
                </xhtml:body>
            </xhtml:html>
        </input>
        <output name="response">
            <xxf:event-response xmlns:xxf="http://orbeon.org/oxf/xml/xforms">
                <xxf:dynamic-state>
                    <dynamic-state>
                        <instances>
                            <instance id="instance1" model-id="model1">
                                <instance>
                                    <foo>43</foo>
                                </instance>
                            </instance>
                        </instances>
                    </dynamic-state>
                </xxf:dynamic-state>
                <xxf:action>
                    <xxf:control-values>
                        <xxf:control id="my-foo$my-input">43</xxf:control>
                    </xxf:control-values>
                </xxf:action>
            </xxf:event-response>
        </output>
    </test>

    <test description="Event handler child of bound node" name="oxf:pipeline">
        <input name="config" href="wrap-xforms-state.xpl"/>
        <input name="document">
            <xhtml:html xmlns:xxforms="http://orbeon.org/oxf/xml/xforms" xmlns:fr="http://orbeon.org/oxf/xml/form-runner"
                        xmlns:xbl="http://www.w3.org/ns/xbl" xmlns:xxbl="http://orbeon.org/oxf/xml/xbl">
                <xhtml:head>
                    <xforms:model id="model1">
                        <xforms:instance id="instance1">
                            <instance>
                                <foo>42</foo>
                            </instance>
                        </xforms:instance>
                        <xforms:dispatch ev:event="xforms-ready" name="my-event" targetid="my-foo"/>
                    </xforms:model>
                    <xbl:xbl>
                        <xbl:binding id="fr-foo" element="fr|foo">
                            <xbl:template>
                                <xhtml:div/>
                            </xbl:template>
                        </xbl:binding>
                    </xbl:xbl>
                </xhtml:head>
                <xhtml:body>
                    <!-- Instantiate component -->
                    <fr:foo id="my-foo">
                        <xforms:setvalue ev:event="my-event" ref="foo">43</xforms:setvalue>
                    </fr:foo>

                </xhtml:body>
            </xhtml:html>
        </input>
        <output name="response">
            <xxf:event-response xmlns:xxf="http://orbeon.org/oxf/xml/xforms">
                <xxf:dynamic-state>
                    <dynamic-state>
                        <instances>
                            <instance id="instance1" model-id="model1">
                                <instance>
                                    <foo>43</foo>
                                </instance>
                            </instance>
                        </instances>
                    </dynamic-state>
                </xxf:dynamic-state>
                <xxf:action>
                    <xxf:control-values/>
                </xxf:action>
            </xxf:event-response>
        </output>
    </test>

    <test description="Event handler with @ev:observer and child of bound node" name="oxf:pipeline">
        <input name="config" href="wrap-xforms-state.xpl"/>
        <input name="document">
            <xhtml:html xmlns:xxforms="http://orbeon.org/oxf/xml/xforms" xmlns:fr="http://orbeon.org/oxf/xml/form-runner"
                        xmlns:xbl="http://www.w3.org/ns/xbl" xmlns:xxbl="http://orbeon.org/oxf/xml/xbl">
                <xhtml:head>
                    <xforms:model id="model1">
                        <xforms:instance id="instance1">
                            <instance>
                                <foo>42</foo>
                            </instance>
                        </xforms:instance>
                        <xforms:dispatch ev:event="xforms-ready" name="my-event" targetid="my-input"/>
                    </xforms:model>
                    <xbl:xbl>
                        <xbl:binding id="fr-foo" element="fr|foo">
                            <xbl:template>
                                <xhtml:div/>
                            </xbl:template>
                        </xbl:binding>
                    </xbl:xbl>
                </xhtml:head>
                <xhtml:body>
                    <!-- Instantiate component -->
                    <fr:foo id="my-foo">
                        <xforms:setvalue ev:event="my-event" ev:observer="my-input" ref="foo">43</xforms:setvalue>
                    </fr:foo>

                    <xforms:input id="my-input" ref="foo"/>

                </xhtml:body>
            </xhtml:html>
        </input>
        <output name="response">
            <xxf:event-response xmlns:xxf="http://orbeon.org/oxf/xml/xforms">
                <xxf:dynamic-state>
                    <dynamic-state>
                        <instances>
                            <instance id="instance1" model-id="model1">
                                <instance>
                                    <foo>43</foo>
                                </instance>
                            </instance>
                        </instances>
                    </dynamic-state>
                </xxf:dynamic-state>
                <xxf:action>
                    <xxf:control-values>
                        <xxf:control id="my-input">43</xxf:control>
                    </xxf:control-values>
                </xxf:action>
            </xxf:event-response>
        </output>
    </test>

    <test description="Nested action with different resolution scope than outer action" name="oxf:pipeline">
        <input name="config" href="wrap-xforms-state.xpl"/>
        <input name="document">
            <xhtml:html xmlns:xxforms="http://orbeon.org/oxf/xml/xforms" xmlns:fr="http://orbeon.org/oxf/xml/form-runner"
                        xmlns:xbl="http://www.w3.org/ns/xbl" xmlns:xxbl="http://orbeon.org/oxf/xml/xbl">
                <xhtml:head>
                    <xforms:model id="model">
                        <xforms:instance id="instance">
                            <instance xmlns=""/>
                        </xforms:instance>
                    </xforms:model>
                    <xbl:xbl>
                        <xbl:binding id="foobar-component" element="fr|foobar">
                            <xbl:template>
                                <xforms:trigger id="my-trigger" xxbl:scope="outer">
                                    <!-- Outer action in outer scope -->
                                    <xforms:action id="my-action" ev:event="xforms-enabled">
                                        <!-- Resolution/dispatch in inner scope -->
                                        <xforms:dispatch id="my-dispatch" name="foobar" targetid="my-inner-group" xxbl:scope="inner"/>
                                    </xforms:action>
                                </xforms:trigger>
                                <!-- Group in inner scope -->
                                <xforms:group id="my-inner-group">
                                    <!-- Set value in outer scope -->
                                    <xforms:setvalue ev:event="foobar" ref="." xxbl:scope="outer">foobar</xforms:setvalue>
                                </xforms:group>
                            </xbl:template>
                        </xbl:binding>
                    </xbl:xbl>
                </xhtml:head>
                <xhtml:body>
                    <!-- Instantiate component -->
                    <fr:foobar id="my-foobar" />
                </xhtml:body>
            </xhtml:html>
        </input>
        <output name="response">
            <xxf:event-response xmlns:xxf="http://orbeon.org/oxf/xml/xforms">
                <xxf:dynamic-state>
                    <dynamic-state>
                        <instances>
                            <instance id="instance" model-id="model">
                                <instance>foobar</instance>
                            </instance>
                        </instances>
                    </dynamic-state>
                </xxf:dynamic-state>
                <xxf:action>
                    <xxf:control-values/>
                </xxf:action>
            </xxf:event-response>
        </output>
    </test>

    <test description="Use of context-sensitive XPath function in @if attribute within repeat with different scopes" name="oxf:pipeline">
        <input name="config" href="wrap-xforms-state.xpl"/>
        <input name="document">
            <xhtml:html xmlns:xxforms="http://orbeon.org/oxf/xml/xforms" xmlns:fr="http://orbeon.org/oxf/xml/form-runner"
                        xmlns:xbl="http://www.w3.org/ns/xbl" xmlns:xxbl="http://orbeon.org/oxf/xml/xbl">
                <xhtml:head>
                    <xforms:model id="model">
                        <xforms:instance id="instance">
                            <instance xmlns="">
                                <fruit>Apple</fruit>
                                <fruit>Orange</fruit>
                            </instance>
                        </xforms:instance>
                    </xforms:model>
                    <xbl:xbl>
                        <xbl:binding id="foobar-component" element="fr|foobar">
                            <xbl:template>
                                <!-- Repeat in outer scope -->
                                <xforms:repeat id="my-repeat" nodeset="fruit" xxbl:scope="outer" startindex="2">
                                    <xxforms:variable name="p" select="position()" as="xs:integer"/>
                                    <!-- Group in inner scope -->
                                    <xforms:group id="my-group" xxbl:scope="inner">
                                        <!-- Action in outer scope -->
                                        <xforms:action ev:event="xforms-enabled" if="xxforms:index() = $p" xxbl:scope="outer">
                                            <xforms:setvalue ref=".">Banana</xforms:setvalue>
                                        </xforms:action>
                                    </xforms:group>
                                </xforms:repeat>
                            </xbl:template>
                        </xbl:binding>
                    </xbl:xbl>
                </xhtml:head>
                <xhtml:body>
                    <!-- Instantiate component -->
                    <fr:foobar id="my-foobar" />
                </xhtml:body>
            </xhtml:html>
        </input>
        <output name="response">
            <xxf:event-response xmlns:xxf="http://orbeon.org/oxf/xml/xforms">
                <xxf:dynamic-state>
                    <dynamic-state>
                        <instances>
                            <instance id="instance" model-id="model">
                                <instance>
                                    <fruit>Apple</fruit>
                                    <fruit>Banana</fruit>
                                </instance>
                            </instance>
                        </instances>
                        <controls>
                            <control effective-id="my-foobar$my-repeat" index="2"/>
                        </controls>
                    </dynamic-state>
                </xxf:dynamic-state>
                <xxf:action>
                    <xxf:control-values/>
                </xxf:action>
            </xxf:event-response>
        </output>
    </test>

    <test description="Use of context-sensitive XPath function on xxforms:context within repeat with different scopes" name="oxf:pipeline">
        <input name="config" href="wrap-xforms-state.xpl"/>
        <input name="document">
            <xhtml:html xmlns:xxforms="http://orbeon.org/oxf/xml/xforms" xmlns:fr="http://orbeon.org/oxf/xml/form-runner"
                        xmlns:xbl="http://www.w3.org/ns/xbl" xmlns:xxbl="http://orbeon.org/oxf/xml/xbl">
                <xhtml:head>
                    <xforms:model id="model">
                        <xforms:instance id="instance">
                            <instance xmlns="">
                                <fruit>Apple</fruit>
                                <fruit>Orange</fruit>
                            </instance>
                        </xforms:instance>
                    </xforms:model>
                    <xbl:xbl>
                        <xbl:binding id="foobar-component" element="fr|foobar">
                            <xbl:template>
                                <!-- Repeat in outer scope -->
                                <xforms:repeat id="my-repeat" nodeset="fruit" xxbl:scope="outer" startindex="2">
                                    <xxforms:variable name="p" select="position()" as="xs:integer"/>
                                    <!-- Group in inner scope -->
                                    <xforms:group id="my-group" xxbl:scope="inner">
                                        <!-- Action in outer scope -->
                                        <xforms:action ev:event="xforms-enabled" if="xxforms:index() = $p" xxbl:scope="outer">
                                            <xforms:dispatch name="foobar" targetid="my-group" xxbl:scope="inner">
                                                <xxforms:context name="index" select="xxforms:index()" xxbl:scope="outer"/>
                                            </xforms:dispatch>
                                            <xforms:dispatch name="foobar" targetid="my-other-group" xxbl:scope="inner">
                                                <xxforms:context name="index" select="xxforms:index()" xxbl:scope="outer"/>
                                            </xforms:dispatch>
                                        </xforms:action>

                                        <!-- Event handler in inner scope -->
                                        <xforms:action ev:event="foobar">
                                            <xforms:setvalue ref="." xxbl:scope="outer" value="concat(., ' ', event('index'))"/>
                                        </xforms:action>

                                    </xforms:group>
                                </xforms:repeat>
                                <xforms:group id="my-other-group">
                                    <!-- Event handler in inner scope -->
                                    <xforms:action ev:event="foobar">
                                        <xforms:setvalue ref="fruit[event('index')]" xxbl:scope="outer" value="concat(., ' ', event('index'))"/>
                                    </xforms:action>
                                </xforms:group>
                            </xbl:template>
                        </xbl:binding>
                    </xbl:xbl>
                </xhtml:head>
                <xhtml:body>
                    <!-- Instantiate component -->
                    <fr:foobar id="my-foobar" />
                </xhtml:body>
            </xhtml:html>
        </input>
        <output name="response">
            <xxf:event-response xmlns:xxf="http://orbeon.org/oxf/xml/xforms">
                <xxf:dynamic-state>
                    <dynamic-state>
                        <instances>
                            <instance id="instance" model-id="model">
                                <instance>
                                    <fruit>Apple</fruit>
                                    <fruit>Orange 2 2</fruit>
                                </instance>
                            </instance>
                        </instances>
                        <controls>
                            <control effective-id="my-foobar$my-repeat" index="2"/>
                        </controls>
                    </dynamic-state>
                </xxf:dynamic-state>
                <xxf:action>
                    <xxf:control-values/>
                </xxf:action>
            </xxf:event-response>
        </output>
    </test>

    <test description="Separate LHHA element in XBL content" name="oxf:pipeline">
        <input name="config" href="wrap-xforms-state.xpl"/>
        <input name="document">
            <xhtml:html xmlns:xxforms="http://orbeon.org/oxf/xml/xforms" xmlns:fr="http://orbeon.org/oxf/xml/form-runner"
                        xmlns:xbl="http://www.w3.org/ns/xbl" xmlns:xxbl="http://orbeon.org/oxf/xml/xbl">
                <xhtml:head>
                    <xforms:model id="model">
                        <xforms:instance id="instance">
                            <instance>
                                <foo1 label="My label">42</foo1>
                            </instance>
                        </xforms:instance>
                    </xforms:model>
                    <xbl:xbl>
                        <xbl:binding id="fr-foo" element="fr|foo">
                            <xbl:template>
                                <xforms:group xbl:attr="ref" xxbl:scope="outer">
                                    <!-- Here xforms:label and xforms:input are copied within an outer group -->
                                    <xbl:content includes="xforms|label,xforms|input"/>
                                </xforms:group>
                            </xbl:template>
                        </xbl:binding>
                    </xbl:xbl>
                </xhtml:head>
                <xhtml:body>
                    <fr:foo id="my-foo" ref="foo1">
                        <xforms:label id="gaga-label" for="gaga" ref="@label"/>
                        <xforms:input ref="." id="gaga"/>
                    </fr:foo>
                </xhtml:body>
            </xhtml:html>
        </input>
        <output name="response">
            <xxf:event-response xmlns:xxf="http://orbeon.org/oxf/xml/xforms">
                <xxf:dynamic-state>
                    <dynamic-state>
                        <instances>
                            <instance id="instance" model-id="model">
                                <instance>
                                    <foo1 label="My label">42</foo1>
                                </instance>
                            </instance>
                        </instances>
                    </dynamic-state>
                </xxf:dynamic-state>
                <xxf:action>
                    <xxf:control-values>
                        <xxf:control id="my-foo$gaga" label="My label">42</xxf:control>
                    </xxf:control-values>
                </xxf:action>
            </xxf:event-response>
        </output>
    </test>

    <test description="Separate LHHA element in XBL content in inner-scoped group" name="oxf:pipeline">
        <input name="config" href="wrap-xforms-state.xpl"/>
        <input name="document">
            <xhtml:html xmlns:xxforms="http://orbeon.org/oxf/xml/xforms" xmlns:fr="http://orbeon.org/oxf/xml/form-runner"
                        xmlns:xbl="http://www.w3.org/ns/xbl" xmlns:xxbl="http://orbeon.org/oxf/xml/xbl">
                <xhtml:head>
                    <xforms:model id="model">
                        <xforms:instance id="instance">
                            <instance>
                                <foo1 label="My label">42</foo1>
                            </instance>
                        </xforms:instance>
                    </xforms:model>
                    <xbl:xbl>
                        <xbl:binding id="fr-foo" element="fr|foo">
                            <xbl:template>
                                <xforms:group xbl:attr="ref" xxbl:scope="outer" id="outer-group">
                                    <xxforms:variable name="result" xxbl:scope="inner">
                                        <xxforms:sequence select="." xxbl:scope="outer"/>
                                    </xxforms:variable>
                                    <xforms:group xxbl:scope="inner" ref="$result" id="inner-group">
                                        <!-- Here xforms:label and xforms:input are copied within an inner group -->
                                        <xbl:content includes="xforms|label,xforms|input"/>
                                    </xforms:group>
                                </xforms:group>
                            </xbl:template>
                        </xbl:binding>
                    </xbl:xbl>
                </xhtml:head>
                <xhtml:body>
                    <fr:foo id="my-foo" ref="foo1">
                        <xforms:label id="gaga-label" for="gaga" ref="@label"/>
                        <xforms:input ref="." id="gaga"/>
                    </fr:foo>
                </xhtml:body>
            </xhtml:html>
        </input>
        <output name="response">
            <xxf:event-response xmlns:xxf="http://orbeon.org/oxf/xml/xforms">
                <xxf:dynamic-state>
                    <dynamic-state>
                        <instances>
                            <instance id="instance" model-id="model">
                                <instance>
                                    <foo1 label="My label">42</foo1>
                                </instance>
                            </instance>
                        </instances>
                    </dynamic-state>
                </xxf:dynamic-state>
                <xxf:action>
                    <xxf:control-values>
                        <xxf:control id="my-foo$gaga" label="My label">42</xxf:control>
                    </xxf:control-values>
                </xxf:action>
            </xxf:event-response>
        </output>
    </test>

    <test description="Separate LHHA element with LHHA element outside copied XBL content" name="oxf:pipeline">
        <input name="config" href="wrap-xforms-state.xpl"/>
        <input name="document">
            <xhtml:html xmlns:xxforms="http://orbeon.org/oxf/xml/xforms" xmlns:fr="http://orbeon.org/oxf/xml/form-runner"
                        xmlns:xbl="http://www.w3.org/ns/xbl" xmlns:xxbl="http://orbeon.org/oxf/xml/xbl">
                <xhtml:head>
                    <xforms:model id="model">
                        <xforms:instance id="instance">
                            <instance>
                                <foo1 label="My label">42</foo1>
                            </instance>
                        </xforms:instance>
                    </xforms:model>
                    <xbl:xbl>
                        <xbl:binding id="fr-foo" element="fr|foo">
                            <xbl:template>
                                <xforms:group xbl:attr="ref" xxbl:scope="outer">
                                    <!-- xforms:input is copied within an outer group -->
                                    <xbl:content includes="xforms|input"/>
                                </xforms:group>
                            </xbl:template>
                        </xbl:binding>
                    </xbl:xbl>
                </xhtml:head>
                <xhtml:body>
                    <xforms:label id="gaga-label" for="gaga" ref="foo1/@label"/>
                    <fr:foo id="my-foo" ref="foo1">
                        <xforms:input ref="." id="gaga"/>
                    </fr:foo>
                </xhtml:body>
            </xhtml:html>
        </input>
        <output name="response">
            <xxf:event-response xmlns:xxf="http://orbeon.org/oxf/xml/xforms">
                <xxf:dynamic-state>
                    <dynamic-state>
                        <instances>
                            <instance id="instance" model-id="model">
                                <instance>
                                    <foo1 label="My label">42</foo1>
                                </instance>
                            </instance>
                        </instances>
                    </dynamic-state>
                </xxf:dynamic-state>
                <xxf:action>
                    <xxf:control-values>
                        <xxf:control id="my-foo$gaga" label="My label">42</xxf:control>
                    </xxf:control-values>
                </xxf:action>
            </xxf:event-response>
        </output>
    </test>

    <test description="xforms:output within xforms:message in XBL doesn't throw an exception" name="oxf:pipeline">
        <input name="config" href="wrap-xforms-state.xpl"/>
        <input name="document">
            <xhtml:html xmlns:xxforms="http://orbeon.org/oxf/xml/xforms" xmlns:fr="http://orbeon.org/oxf/xml/form-runner">
                <xhtml:head>
                    <xforms:model id="model"/>
                    <xbl:xbl>
                        <xbl:binding id="fr-foo" element="fr|foo">
                            <xbl:template>
                                <xforms:group id="my-group">
                                    <xforms:message ev:event="xforms-enabled" id="my-message"
                                                    level="xxforms:log-debug">Message: <xforms:output id="my-output" value="xxforms:event('xxforms:type')"/>.</xforms:message>
                                </xforms:group>
                            </xbl:template>
                        </xbl:binding>
                    </xbl:xbl>
                </xhtml:head>
                <xhtml:body>
                    <fr:foo/>
                </xhtml:body>
            </xhtml:html>
        </input>
        <output name="response">
            <xxf:event-response xmlns:xxf="http://orbeon.org/oxf/xml/xforms">
                <xxf:dynamic-state>
                    <dynamic-state>
                        <instances/>
                    </dynamic-state>
                </xxf:dynamic-state>
                <xxf:action>
                    <xxf:control-values/>
                </xxf:action>
            </xxf:event-response>
        </output>
    </test>

    <test description="XBL components within non-relevant control doesn't throw an exception" name="oxf:pipeline">
        <input name="config" href="wrap-xforms-state.xpl"/>
        <input name="document">
            <xhtml:html xmlns:xxforms="http://orbeon.org/oxf/xml/xforms" xmlns:fr="http://orbeon.org/oxf/xml/form-runner">
                <xhtml:head>
                    <xforms:model id="model"/>
                </xhtml:head>
                <xhtml:body>
                    <xforms:group ref="()" id="my-group">
                        <fr:button id="my-button"/>
                    </xforms:group>
                </xhtml:body>
            </xhtml:html>
        </input>
        <output name="response">
            <xxf:event-response xmlns:xxf="http://orbeon.org/oxf/xml/xforms">
                <xxf:dynamic-state>
                    <dynamic-state>
                        <instances/>
                    </dynamic-state>
                </xxf:dynamic-state>
                <xxf:action>
                    <xxf:control-values>
                        <xxf:control id="my-group" relevant="false"/>
                        <xxf:control id="my-button$container" class="yui-button yui-push-button" relevant="false"/>
                        <xxf:control id="my-button$trigger" relevant="false"/>
                    </xxf:control-values>
                </xxf:action>
            </xxf:event-response>
        </output>
    </test>

    <test description="Handling of namespaces with xbl:attr" name="oxf:pipeline">
        <input name="config" href="wrap-xforms-state.xpl"/>
        <input name="document">
            <xhtml:html xmlns:xxforms="http://orbeon.org/oxf/xml/xforms"
                        xmlns:fr="http://orbeon.org/oxf/xml/form-runner"
                        xmlns:xxbl="http://orbeon.org/oxf/xml/xbl">
                <xhtml:head>
                    <xforms:model id="model">
                        <xforms:instance id="instance">
                            <my:value xmlns:my="http://orbeon.org/oxf/xml/my">42</my:value>
                        </xforms:instance>
                    </xforms:model>
                    <xbl:xbl>
                        <xbl:binding id="fr-foo" element="fr|foo">
                            <xbl:template>
                                <xforms:output id="my-output" xbl:attr="value" xxbl:scope="outer"/>
                            </xbl:template>
                        </xbl:binding>
                    </xbl:xbl>
                </xhtml:head>
                <xhtml:body xmlns:my="http://orbeon.org/oxf/xml/my">
                    <fr:foo id="my-foo" value="/my:value"/>
                </xhtml:body>
            </xhtml:html>
        </input>
        <output name="response">
            <xxf:event-response xmlns:xxf="http://orbeon.org/oxf/xml/xforms">
                <xxf:dynamic-state>
                    <dynamic-state>
                        <instances>
                            <instance id="instance" model-id="model">
                                <my:value xmlns:my="http://orbeon.org/oxf/xml/my">42</my:value>
                            </instance>
                        </instances>
                    </dynamic-state>
                </xxf:dynamic-state>
                <xxf:action>
                    <xxf:control-values>
                        <xxf:control id="my-foo$my-output">42</xxf:control>
                    </xxf:control-values>
                </xxf:action>
            </xxf:event-response>
        </output>
    </test>

    <test description="Non-relevant XBL control containing models and instances" name="oxf:pipeline">
        <input name="config" href="wrap-xforms-state.xpl"/>
        <input name="document">
            <xhtml:html xmlns:xxforms="http://orbeon.org/oxf/xml/xforms"
                        xmlns:fr="http://orbeon.org/oxf/xml/form-runner"
                        xmlns:xxbl="http://orbeon.org/oxf/xml/xbl">
                <xhtml:head>
                    <xforms:model id="model">
                        <xforms:instance id="instance">
                            <instance>42</instance>
                        </xforms:instance>
                        <xforms:action ev:event="xforms-ready">
                            <xforms:message value="string-join(for $m in xxforms:list-models() return xxforms:list-instances($m), ', ')"/>
                            <xforms:setvalue ref=".">43</xforms:setvalue>
                            <xforms:refresh/>
                            <xforms:message value="string-join(for $m in xxforms:list-models() return xxforms:list-instances($m), ', ')"/>
                        </xforms:action>
                    </xforms:model>
                    <xbl:xbl>
                        <xbl:binding id="fr-foo" element="fr|foo">
                            <xbl:implementation>
                                <xforms:model id="my-xbl-model">
                                    <xforms:instance id="my-xbl-instance">
                                        <instance/>
                                    </xforms:instance>
                                </xforms:model>
                            </xbl:implementation>
                            <xbl:template>
                                <xforms:output id="my-output"/>
                            </xbl:template>
                        </xbl:binding>
                    </xbl:xbl>
                </xhtml:head>
                <xhtml:body>
                    <fr:foo id="my-foo1"/>
                    <xforms:group ref="()" id="my-group1">
                        <fr:foo id="my-foo2"/>
                    </xforms:group>
                    <xforms:group ref=".[. = '43']" id="my-group2">
                        <fr:foo id="my-foo3"/>
                    </xforms:group>
                </xhtml:body>
            </xhtml:html>
        </input>
        <output name="response">
            <xxf:event-response xmlns:xxf="http://orbeon.org/oxf/xml/xforms">
                <xxf:dynamic-state>
                    <dynamic-state>
                        <instances>
                            <instance id="instance" model-id="model">
                                <instance>43</instance>
                            </instance>
                            <instance id="my-xbl-instance" model-id="my-foo1$my-xbl-model">
                                <instance/>
                            </instance>
                            <instance id="my-xbl-instance" model-id="my-foo3$my-xbl-model">
                                <instance/>
                            </instance>
                        </instances>
                    </dynamic-state>
                </xxf:dynamic-state>
                <xxf:action>
                    <xxf:control-values>
                        <xxf:control id="my-group1" relevant="false"/>
                        <xxf:control id="my-foo2$my-output" relevant="false"/>
                    </xxf:control-values>
                    <xxf:message level="modal">instance, my-foo1$my-xbl-instance</xxf:message>
                    <xxf:message level="modal">instance, my-foo1$my-xbl-instance, my-foo3$my-xbl-instance</xxf:message>
                </xxf:action>
            </xxf:event-response>
        </output>
    </test>

    <test description="xforms:label/xforms:output within XBL" name="oxf:pipeline">
        <!-- See: http://forge.ow2.org/tracker/index.php?func=detail&aid=315244&group_id=168&atid=350207 -->
        <input name="config" href="wrap-xforms-state.xpl"/>
        <input name="document">
            <xhtml:html xmlns:xxforms="http://orbeon.org/oxf/xml/xforms"
                        xmlns:fr="http://orbeon.org/oxf/xml/form-runner"
                        xmlns:xxbl="http://orbeon.org/oxf/xml/xbl">
                <xhtml:head>
                    <xforms:model id="model"/>
                    <xbl:xbl>
                        <xbl:binding id="fr-foo" element="fr|foo">
                            <xbl:template>
                                <xforms:trigger id="xbl-trigger">
                                    <xforms:label id="xbl-label"><xforms:output id="xbl-output" value="'Press Me!'"/></xforms:label>
                                </xforms:trigger>
                            </xbl:template>
                        </xbl:binding>
                    </xbl:xbl>
                </xhtml:head>
                <xhtml:body>
                    <fr:foo id="my-foo1"/>
                </xhtml:body>
            </xhtml:html>
        </input>
        <output name="response">
            <xxf:event-response xmlns:xxf="http://orbeon.org/oxf/xml/xforms">
                <xxf:dynamic-state>
                    <dynamic-state>
                        <instances/>
                    </dynamic-state>
                </xxf:dynamic-state>
                <xxf:action>
                    <xxf:control-values>
                        <xxf:control id="my-foo1$xbl-trigger" label="Press Me!"/>
                    </xxf:control-values>
                </xxf:action>
            </xxf:event-response>
        </output>
    </test>

    <test description="xforms:label/AVT within XBL" name="oxf:pipeline">
        <!-- See: http://forge.ow2.org/tracker/index.php?func=detail&aid=315244&group_id=168&atid=350207 -->
        <input name="config" href="wrap-xforms-state.xpl"/>
        <input name="document">
            <xhtml:html xmlns:xxforms="http://orbeon.org/oxf/xml/xforms"
                        xmlns:fr="http://orbeon.org/oxf/xml/form-runner"
                        xmlns:xxbl="http://orbeon.org/oxf/xml/xbl">
                <xhtml:head>
                    <xforms:model id="model"/>
                    <xbl:xbl>
                        <xbl:binding id="fr-foo" element="fr|foo">
                            <xbl:template>
                                <xforms:trigger id="xbl-trigger">
                                    <xforms:label id="xbl-label"><xhtml:div id="xbl-avt" style="{'background-color: red'}"/></xforms:label>
                                </xforms:trigger>
                            </xbl:template>
                        </xbl:binding>
                    </xbl:xbl>
                </xhtml:head>
                <xhtml:body>
                    <fr:foo id="my-foo1"/>
                </xhtml:body>
            </xhtml:html>
        </input>
        <output name="response">
            <xxf:event-response xmlns:xxf="http://orbeon.org/oxf/xml/xforms">
                <xxf:dynamic-state>
                    <dynamic-state>
                        <instances/>
                    </dynamic-state>
                </xxf:dynamic-state>
                <xxf:action>
                    <xxf:control-values>
                        <xxf:control id="my-foo1$xbl-trigger" label="&lt;div id=&quot;xbl-avt&quot; style=&quot;background-color: red&quot;&gt;&lt;/div&gt;"/>
                    </xxf:control-values>
                </xxf:action>
            </xxf:event-response>
        </output>
    </test>

    <test description="Test that automatic include occurs" name="oxf:pipeline">
        <input name="config" href="wrap-xforms-controls.xpl"/>
        <input name="document">
            <xhtml:html xmlns:xxforms="http://orbeon.org/oxf/xml/xforms"
                        xmlns:fr="http://orbeon.org/oxf/xml/form-runner"
                        xmlns:xxbl="http://orbeon.org/oxf/xml/xbl">
                <xhtml:head>
                    <xforms:model id="model">
                        <xforms:instance>
                            <instance/>
                        </xforms:instance>
                    </xforms:model>
                </xhtml:head>
                <xhtml:body>
                    <fr:tutorial-input id="my-input" ref="."/>
                </xhtml:body>
            </xhtml:html>
        </input>
        <output name="response">
            <controls xmlns:xhtml="http://www.w3.org/1999/xhtml">
                <xhtml:span id="my-input$xf-3" class="xforms-group">
                    <xhtml:span id="my-input$xf-4" class="xforms-group">
                        <xhtml:span id="my-input$xf-7" class="xforms-control xforms-input">
                            <xhtml:input id="my-input$xf-7$xforms-input-1" type="text" name="my-input$xf-7$xforms-input-1" value="" class="xforms-input-input"/>
                        </xhtml:span>
                    </xhtml:span>
                </xhtml:span>
            </controls>
        </output>
    </test>

    <test description="Inline model in XBL template does not cause incorrect scoping of following controls" name="oxf:pipeline">
        <!-- See: http://forge.ow2.org/tracker/?func=detail&atid=350207&aid=315613&group_id=168 -->
        <input name="config" href="wrap-xforms-controls.xpl"/>
        <input name="document">
            <xh:html xmlns:xh="http://www.w3.org/1999/xhtml" xmlns:xf="http://www.w3.org/2002/xforms"
                     xmlns:xxf="http://orbeon.org/oxf/xml/xforms" xmlns:fr="http://orbeon.org/oxf/xml/form-runner"
                 xmlns:xbl="http://www.w3.org/ns/xbl" xmlns:xxbl="http://orbeon.org/oxf/xml/xbl">
                <xh:head>
                    <xf:model id="model">
                        <xf:instance id="instance">
                            <instance>Hello</instance>
                        </xf:instance>
                    </xf:model>
                    <xbl:xbl>
                        <xbl:binding id="fr-foo" element="fr|foo">
                            <xbl:template>
                                <xf:group id="foo-group" xxbl:scope="outer">
                                    <xf:model id="datatable-model" xxbl:scope="inner">
                                        <xf:instance>
                                            <instance>world!</instance>
                                        </xf:instance>
                                    </xf:model>
                                    <xxf:variable id="v1" name="v1" select="."/>
                                    <xxf:variable id="v2" name="v2" xxbl:scope="inner">
                                        <xxf:sequence select="$v1" xxbl:scope="outer"/>
                                    </xxf:variable>
                                    <xf:output id="my-output" value="$v2" xxbl:scope="inner"/>
                                </xf:group>
                            </xbl:template>
                        </xbl:binding>
                    </xbl:xbl>
                </xh:head>
                <xh:body>
                    <fr:foo id="my-foo"/>
                </xh:body>
            </xh:html>
        </input>
        <output name="response">
            <controls xmlns:xhtml="http://www.w3.org/1999/xhtml">
                <xh:span xmlns:xh="http://www.w3.org/1999/xhtml" id="my-foo$foo-group" class="xforms-group">
                    <xh:span id="my-foo$my-output" class="xforms-control xforms-output">Hello</xh:span>
                </xh:span>
            </controls>
        </output>
    </test>

    <test description="AVTs within XBL with inner and outer scope are processed" name="oxf:pipeline">
        <!-- See: http://forge.ow2.org/tracker/index.php?func=detail&aid=315635&group_id=168&atid=350207 -->
        <input name="config" href="wrap-xforms-controls.xpl"/>
        <input name="document">
            <xhtml:html xmlns:xxforms="http://orbeon.org/oxf/xml/xforms"
                        xmlns:fr="http://orbeon.org/oxf/xml/form-runner"
                        xmlns:xxbl="http://orbeon.org/oxf/xml/xbl">
                <xhtml:head>
                    <xforms:model id="model"/>
                    <xbl:xbl>
                        <xbl:binding id="fr-foo" element="fr|foo">
                            <xbl:template>
                                <!-- NOTE: xxforms-test-preserve-content is handled by wrap-xforms-controls.xpl -->
                                <xhtml:div class="xxforms-test-preserve-content">
                                    <xhtml:a id="outer-a" href="/outer/{count(.)}" xxbl:scope="outer"/>
                                    <xhtml:a id="inner-a" href="/inner/{count(.)}"/>
                                </xhtml:div>
                            </xbl:template>
                        </xbl:binding>
                    </xbl:xbl>
                </xhtml:head>
                <xhtml:body>
                    <fr:foo id="my-foo"/>
                </xhtml:body>
            </xhtml:html>
        </input>
        <output name="response">
            <controls xmlns:xhtml="http://www.w3.org/1999/xhtml">
                <xhtml:div xmlns:xxbl="http://orbeon.org/oxf/xml/xbl" class="xxforms-test-preserve-content">
                    <xhtml:a id="my-foo$outer-a" href="/outer/1" xxbl:scope="outer"/>
                    <xhtml:a id="my-foo$inner-a" href="/inner/1"/>
                </xhtml:div>
            </controls>
        </output>
    </test>

    <test description="xbl:content" name="oxf:pipeline">
        <!-- See: http://www.w3.org/TR/xbl/#the-content -->
        <input name="config" href="wrap-xforms-state.xpl"/>
        <input name="document">
            <xhtml:html xmlns:xxforms="http://orbeon.org/oxf/xml/xforms"
                        xmlns:fr="http://orbeon.org/oxf/xml/form-runner"
                        xmlns:xxbl="http://orbeon.org/oxf/xml/xbl">
                <xhtml:head>
                    <xforms:model id="model"/>
                    <xbl:xbl>
                        <xbl:binding id="fr-foo" element="fr|foo">
                            <xbl:template>
                                <xbl:content includes="nothing *">
                                    <xforms:output id="output-foo1" value="'Nothing!'"/>
                                </xbl:content>
                                <xbl:content includes="something *">
                                    <xforms:output id="output-foo2" value="'Nothing either!'"/>
                                </xbl:content>
                            </xbl:template>
                        </xbl:binding>
                    </xbl:xbl>
                </xhtml:head>
                <xhtml:body>
                    <fr:foo id="my-foo">
                        <something>
                            <xforms:output id="output-foo3" value="'Something!'"/>
                        </something>
                    </fr:foo>
                </xhtml:body>
            </xhtml:html>
        </input>
        <output name="response">
            <xxf:event-response xmlns:xxf="http://orbeon.org/oxf/xml/xforms">
                <xxf:dynamic-state>
                    <dynamic-state>
                        <instances/>
                    </dynamic-state>
                </xxf:dynamic-state>
                <xxf:action>
                    <xxf:control-values>
                        <xxf:control id="my-foo$output-foo1">Nothing!</xxf:control>
                        <xxf:control id="my-foo$output-foo3">Something!</xxf:control>
                    </xxf:control-values>
                </xxf:action>
            </xxf:event-response>
        </output>
    </test>

    <test description="NPE with submit within repeat within tabs" name="oxf:pipeline">
        <!-- See: http://forge.ow2.org/tracker/index.php?func=detail&aid=315848&group_id=168&atid=350207 -->
        <input name="config" href="wrap-xforms-state.xpl"/>
        <input name="document">
            <xhtml:html xmlns:xxforms="http://orbeon.org/oxf/xml/xforms"
                        xmlns:fr="http://orbeon.org/oxf/xml/form-runner"
                        xmlns:xxbl="http://orbeon.org/oxf/xml/xbl">
                <xhtml:head>
                    <xforms:model id="model">
                        <xforms:dispatch ev:event="xforms-ready" name="DOMActivate" targetid="my-submit"/>
                        <xforms:instance id="instance">
                            <item/>
                        </xforms:instance>
                        <xforms:submission id="my-submission" method="get" action="echo:" replace="instance"/>
                    </xforms:model>
                    <xbl:xbl>
                        <xbl:binding id="fr-foo" element="fr|foo">
                            <xbl:template>
                                <xbl:content/>
                            </xbl:template>
                        </xbl:binding>
                    </xbl:xbl>
                </xhtml:head>
                <xhtml:body>
                    <fr:foo id="my-foo">
                        <xforms:repeat ref="." id="my-repeat">
                            <xforms:submit id="my-submit" submission="my-submission"/>
                        </xforms:repeat>
                    </fr:foo>
                </xhtml:body>
            </xhtml:html>
        </input>
        <output name="response">
            <xxf:event-response xmlns:xxf="http://orbeon.org/oxf/xml/xforms">
                <xxf:dynamic-state>
                    <dynamic-state>
                        <instances>
                            <instance id="instance" model-id="model">
                                <item/>
                            </instance>
                        </instances>
                        <controls>
                            <control effective-id="my-foo$my-repeat" index="1"/>
                        </controls>
                    </dynamic-state>
                </xxf:dynamic-state>
                <xxf:action>
                    <xxf:control-values/>
                </xxf:action>
            </xxf:event-response>
        </output>
    </test>

    <test description="xxbl:global" name="oxf:pipeline">
        <input name="config" href="wrap-xforms-state.xpl"/>
        <input name="document">
            <xhtml:html xmlns:xforms="http://www.w3.org/2002/xforms"
                    xmlns:xhtml="http://www.w3.org/1999/xhtml"
                    xmlns:xxforms="http://orbeon.org/oxf/xml/xforms"
                    xmlns:ev="http://www.w3.org/2001/xml-events"
                    xmlns:xs="http://www.w3.org/2001/XMLSchema"
                    xmlns:xbl="http://www.w3.org/ns/xbl"
                    xmlns:xxbl="http://orbeon.org/oxf/xml/xbl"
                    xmlns:fr="http://orbeon.org/oxf/xml/form-runner">

                <xhtml:head>
                    <xforms:model id="model">
                        <!-- Upon ready, simulate click on button + close dialog for both XBL controls -->
                        <xforms:action ev:event="xforms-ready">
                            <xforms:dispatch name="DOMActivate" targetid="my-foo1$foo-trigger"/>
                            <xxforms:hide dialog="my-dialog"/>
                            <xforms:dispatch name="DOMActivate" targetid="my-foo2$foo-trigger"/>
                            <xxforms:hide dialog="my-dialog"/>
                        </xforms:action>
                    </xforms:model>
                    <xbl:xbl>
                        <xbl:binding element="fr|foo">
                            <xxbl:global>
                                <!-- The single global dialog -->
                                <xxforms:dialog id="my-dialog" level="modal" model="my-dialog-model">
                                    <xforms:label>My Dialog</xforms:label>

                                    <!-- Dialog model -->
                                    <xforms:model id="my-dialog-model">
                                        <xforms:instance id="my-dialog-instance">
                                            <count>0</count>
                                        </xforms:instance>
                                    </xforms:model>

                                    <!-- Dialog keeps track of # of times it is open, and sends current count back to caller -->
                                    <xforms:action ev:event="xxforms-dialog-open">
                                        <xforms:setvalue ref="instance()" value="xs:integer(.) + 1"/>
                                        <xforms:dispatch name="my-callback" targetid="{event('my-id')}">
                                            <xxforms:context name="my-value" select="instance()"/>
                                        </xforms:dispatch>
                                    </xforms:action>

                                </xxforms:dialog>
                            </xxbl:global>
                            <xbl:template>
                                <!-- Local model state -->
                                <xforms:model id="model">
                                    <xforms:instance id="instance">
                                        <count/>
                                    </xforms:instance>
                                </xforms:model>
                                <xforms:trigger id="foo-trigger">
                                    <xforms:label>Open me</xforms:label>
                                    <!-- Open global dialog upon click -->
                                    <xxforms:show ev:event="DOMActivate" dialog="my-dialog" xxbl:scope="outer">
                                        <xxforms:context name="my-id" select="event('xxforms:effective-targetid')"/>
                                    </xxforms:show>
                                    <!-- Upon callback, store value received -->
                                    <xforms:setvalue ev:event="my-callback" ref="instance()" value="event('my-value')"/>
                                </xforms:trigger>
                            </xbl:template>
                        </xbl:binding>
                    </xbl:xbl>
                </xhtml:head>
                <xhtml:body>
                    <fr:foo id="my-foo1"/>
                    <fr:foo id="my-foo2"/>
                </xhtml:body>
            </xhtml:html>
        </input>
        <output name="response">
            <xxf:event-response xmlns:xxf="http://orbeon.org/oxf/xml/xforms">
                <xxf:dynamic-state>
                    <dynamic-state>
                        <instances>
                            <instance id="my-dialog-instance" model-id="my-dialog-model">
                                <count>2</count>
                            </instance>
                            <instance id="instance" model-id="my-foo1$model">
                                <count>1</count>
                            </instance>
                            <instance id="instance" model-id="my-foo2$model">
                                <count>2</count>
                            </instance>
                        </instances>
                        <controls>
                            <control effective-id="my-dialog" visible="false"/>
                        </controls>
                    </dynamic-state>
                </xxf:dynamic-state>
                <xxf:action>
                    <xxf:control-values>
                        <xxf:control id="my-foo1$foo-trigger" label="Open me"/>
                        <xxf:control id="my-foo2$foo-trigger" label="Open me"/>
                        <xxf:control id="my-dialog" label="My Dialog"/>
                        <xxf:div id="my-dialog" visibility="hidden"/>
                    </xxf:control-values>
                </xxf:action>
            </xxf:event-response>
        </output>
    </test>

    <!--

    TODO: more XBL ids tests:

    * test that LHHA with @for resolve ids in proper context
    * test scoping with ev:observer and repeats/XBL scope
    * test change of scope in inner action, e.g.:
    * test xxforms:repeat-indexes resolution on actions, y.c. from within XBL component within repeat, and to tested repeat controls

    -->

</group>
