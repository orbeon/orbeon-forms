<!--
  Copyright (C) 2010 Orbeon, Inc.

  This program is free software; you can redistribute it and/or modify it under the terms of the
  GNU Lesser General Public License as published by the Free Software Foundation; either version
  2.1 of the License, or (at your option) any later version.

  This program is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY;
  without even the implied warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.
  See the GNU Lesser General Public License for more details.

  The full text of the license is available at http://www.gnu.org/copyleft/lesser.html
  -->
<group description="XForms Submission" xmlns:p="http://www.orbeon.com/oxf/pipeline"
    xmlns:xsl="http://www.w3.org/1999/XSL/Transform"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xmlns:xs="http://www.w3.org/2001/XMLSchema"
    xmlns:xh="http://www.w3.org/1999/xhtml"
    xmlns:oxf="http://www.orbeon.com/oxf/processors"
    xmlns:xi="http://www.w3.org/2001/XInclude"
    xmlns:xxi="http://orbeon.org/oxf/xml/xinclude"
    xmlns:xf="http://www.w3.org/2002/xforms"
    xmlns:xxf="http://orbeon.org/oxf/xml/xforms"
    xmlns:ev="http://www.w3.org/2001/xml-events"
    xmlns:xbl="http://www.w3.org/ns/xbl"
    xmlns:fr="http://orbeon.org/oxf/xml/form-runner">

    <test description="Instance replacement with index updates" name="oxf:pipeline">
        <input name="config" href="wrap-xforms-state.xpl"/>
        <input name="document">
            <xh:html>
                <xh:head>
                    <xf:model id="main-model">
                        <xf:instance id="main-instance">
                            <instance>
                               <r1/>
                               <r1>
                                   <r2/>
                                   <r2/>
                               </r1>
                               <r1/>
                               <r3/>
                               <r4/>
                               <r4>
                                   <r5/>
                                   <r5/>
                               </r4>
                               <r4/>
                           </instance>
                        </xf:instance>
                        <xf:instance id="new-instance">
                           <instance>
                               <r1/>
                               <r1>
                                   <r2/><!-- Force repeat2 from 2 to 1 -->
                               </r1>
                               <r1/>
                               <!-- Force repeat3 from 1 to 0 -->
                               <r4>
                                   <r5/><!-- Force repeat5 from 0 to 1 -->
                               </r4>
                               <r4>
                                   <r5/>
                                   <r5/>
                               </r4>
                               <r4/>
                           </instance>
                        </xf:instance>
                        <xf:submission
                            id="test-submission"
                            ref="instance('new-instance')"
                            action="echo:"
                            replace="instance"
                            instance="main-instance"
                            method="post"/>

                        <xf:dispatch
                            event="xforms-ready"
                            name="DOMActivate"
                            targetid="test-trigger"/>
                    </xf:model>
                </xh:head>
                <xh:body>
                    <xf:repeat ref="r1" id="repeat1" startindex="2">
                        <xf:repeat ref="r2" id="repeat2" startindex="4">
                        </xf:repeat>
                    </xf:repeat>
                    <xf:repeat ref="r3" id="repeat3">
                    </xf:repeat>
                    <xf:repeat ref="r4" id="repeat4">
                        <xf:repeat ref="r5" id="repeat5"/>
                    </xf:repeat>
                    <xf:trigger id="test-trigger">
                        <xf:label>Test</xf:label>
                        <xf:send id="my-submission" submission="test-submission" event="DOMActivate"/>
                    </xf:trigger>
                </xh:body>
            </xh:html>
        </input>
        <output name="response">
            <xxf:event-response>
                <xxf:dynamic-state>
                    <dynamic-state>
                        <instances>
                            <instance id="main-instance" model-id="main-model">
                                <instance>
                                    <r1/>
                                    <r1>
                                        <r2/>
                                        <!-- Force repeat2 from 2 to 1 -->
                                    </r1>
                                    <r1/>
                                    <!-- Force repeat3 from 1 to 0 -->
                                    <r4>
                                        <r5/>
                                        <!-- Force repeat5 from 0 to 1 -->
                                    </r4>
                                    <r4>
                                        <r5/>
                                        <r5/>
                                    </r4>
                                    <r4/>
                                </instance>
                            </instance>
                        </instances>
                        <controls>
                            <control effective-id="repeat1" index="3"/>
                            <control effective-id="repeat2⊙2" index="1"/>
                            <control effective-id="repeat4" index="3"/>
                            <control effective-id="repeat5⊙1" index="1"/>
                            <control effective-id="repeat5⊙2" index="1"/>
                        </controls>
                    </dynamic-state>
                </xxf:dynamic-state>
                <xxf:action>
                    <xxf:control-values>
                        <xxf:control id="test-trigger" label="Test"/>
                    </xxf:control-values>
                </xxf:action>
            </xxf:event-response>
        </output>
    </test>

    <test description="Submitting required but empty values fails submission" name="oxf:pipeline">
        <input name="config" href="wrap-xforms-state.xpl"/>
        <input name="document">
            <xh:html>
                <xh:head>
                    <xf:model id="main-model">
                        <xf:instance id="main-instance">
                            <instance>
                                <required-but-emtpy-element/>
                                <other-element required-but-emtpy-attribute=""/>
                                <submission-serialized>false</submission-serialized>
                                <submission-result/>
                            </instance>
                        </xf:instance>

                        <xf:bind ref="required-but-emtpy-element" required="true()"/>
                        <xf:bind ref="other-element/@required-but-emtpy-attribute" required="true()"/>

                        <xf:submission id="test-submission" method="post" action="echo:" replace="instance">
                            <xf:setvalue ev:event="xforms-submit-error" ref="submission-result">error</xf:setvalue>
                            <xf:setvalue ev:event="xforms-submit-done" ref="submission-result">done</xf:setvalue>
                            <xf:setvalue ev:event="xforms-submit-serialize" ref="submission-serialized">true</xf:setvalue>
                        </xf:submission>
                        <xf:send ev:event="xforms-ready" submission="test-submission"/>
                    </xf:model>
                </xh:head>
                <xh:body>
                </xh:body>
            </xh:html>
        </input>
        <output name="response">
            <xxf:event-response>
                <xxf:dynamic-state>
                    <dynamic-state>
                        <instances>
                            <instance id="main-instance" model-id="main-model">
                                <instance>
                                    <required-but-emtpy-element/>
                                    <other-element required-but-emtpy-attribute=""/>
                                    <submission-serialized>false</submission-serialized>
                                    <submission-result>error</submission-result>
                                </instance>
                            </instance>
                        </instances>
                    </dynamic-state>
                </xxf:dynamic-state>
                <xxf:action>
                    <xxf:control-values/>
                </xxf:action>
            </xxf:event-response>
        </output>
    </test>

    <test description="Instance replacement on xforms-ready with read-only instance properly updates controls" name="oxf:pipeline">
        <input name="config" href="wrap-xforms-state.xpl"/>
        <input name="document">
            <xh:html>
                <xh:head>
                    <xf:model>
                        <xf:instance id="initial-instance">
                            <instance>
                                <value>1</value>
                            </instance>
                        </xf:instance>

                        <xf:instance id="new-instance" xxf:readonly="true">
                            <instance>
                                <value>2</value>
                            </instance>
                        </xf:instance>

                        <xf:submission id="replace-submission"
                                           ref="instance('new-instance')" method="post" resource="echo:"
                                           replace="instance" instance="initial-instance"
                                           xxf:readonly="true"/>

                        <!-- When this is called on xforms-ready, controls must update properly -->
                        <xf:send ev:event="xforms-ready" submission="replace-submission"/>

                    </xf:model>
                </xh:head>
                <xh:body>
                    <xf:input ref="value" id="my-input">
                        <xf:label>Value:</xf:label>
                    </xf:input>
                </xh:body>
            </xh:html>
        </input>
        <output name="response">
           <xxf:event-response>
                <xxf:dynamic-state>
                    <dynamic-state>
                        <instances>
                            <instance readonly="true" id="initial-instance" model-id="xf-1">
                                <instance>
                                    <value>2</value>
                                </instance>
                            </instance>
                        </instances>
                    </dynamic-state>
                </xxf:dynamic-state>
                <xxf:action>
                    <xxf:control-values>
                        <xxf:control id="my-input" label="Value:" readonly="true">
                            <xxf:value>2</xxf:value>
                        </xxf:control>
                    </xxf:control-values>
                </xxf:action>
            </xxf:event-response>
        </output>
    </test>

    <test description="XInclude upon replacement of cached instance" name="oxf:pipeline">
        <input name="config" href="wrap-xforms-state.xpl"/>
        <input name="document">
            <xh:html>
                <xh:head>
                    <xf:model id="model">
                        <!-- Instance with XInclude -->
                        <xf:instance id="instance-xinclude">
                            <dummy/>
                        </xf:instance>
                        <!-- Load instance upon init -->
                        <xf:send ev:event="xforms-model-construct-done" submission="get-instance-xinclude"/>
                        <xf:submission id="get-instance-xinclude" method="get" serialization="none"
                                resource="oxf:/ops/unit-tests/url-generator/included-1.xml"
                                replace="instance" instance="instance-xinclude" xxf:readonly="true" xxf:shared="application" xxf:xinclude="true"/>

                        <!-- Instance without XInclude -->
                        <xf:instance id="instance-no-xinclude">
                            <dummy/>
                        </xf:instance>
                        <!-- Load instance upon init -->
                        <xf:send ev:event="xforms-model-construct-done" submission="get-instance-no-xinclude"/>
                        <xf:submission id="get-instance-no-xinclude" method="get" serialization="none"
                                resource="oxf:/ops/unit-tests/url-generator/included-1.xml"
                                replace="instance" instance="instance-no-xinclude" xxf:readonly="true" xxf:cache="true" xxf:xinclude="false"/>
                    </xf:model>
                </xh:head>
                <xh:body>
                    <!-- The title is found under the XIncluded content and it must be readonly -->
                    <xf:output id="my-output-xinclude" ref="instance('instance-xinclude')//xh:title"/>

                    <xf:output id="my-output-no-xinclude" ref="instance('instance-no-xinclude')//xh:title"/>
                </xh:body>
            </xh:html>
        </input>
        <output name="response">
            <xxf:event-response>
                <xxf:dynamic-state>
                    <dynamic-state>
                        <instances>
                            <instance readonly="true" cache="true" id="instance-xinclude" model-id="model" source-uri="oxf:/ops/unit-tests/url-generator/included-1.xml" xinclude="true"/>
                            <instance readonly="true" cache="true" id="instance-no-xinclude" model-id="model" source-uri="oxf:/ops/unit-tests/url-generator/included-1.xml"/>
                        </instances>
                    </dynamic-state>
                </xxf:dynamic-state>
                <xxf:action>
                    <xxf:control-values>
                        <xxf:control id="my-output-xinclude" readonly="true">
                            <xxf:value>Summary</xxf:value>
                        </xxf:control>
                        <xxf:control id="my-output-no-xinclude" relevant="false"/>
                    </xxf:control-values>
                </xxf:action>
            </xxf:event-response>
        </output>
    </test>

    <test description="Instance replacement: replace submitted instance" name="oxf:pipeline">
        <input name="config" href="wrap-xforms-state.xpl"/>
        <input name="document">
            <xh:html>
                <xh:head>
                    <xf:model id="model">

                        <xf:instance id="source-instance">
                            <dummy/>
                        </xf:instance>

                        <xf:send ev:event="xforms-model-construct-done" submission="replace-instance"/>
                        <xf:submission id="replace-instance" method="get" serialization="none"
                                resource="oxf:/org/orbeon/oxf/xforms/data/sample-instance.xml"
                                replace="instance"/>

                        <!-- TEST: Events to gather -->
                        <xf:instance id="events">
                            <events/>
                        </xf:instance>
                        <xf:insert ev:event="xforms-insert xforms-delete" ev:target="source-instance destination-instance"
                                       context="instance('events')" ref="*"
                                       origin="xf:element('event',
                                                (xf:attribute('type', event('xxf:type')),
                                                 xf:attribute('target', event('xxf:targetid')),
                                                 for $c in event('inserted-nodes')[1] return xf:attribute('inserted-nodes', name($c)),
                                                 for $c in event('deleted-nodes')[1] return xf:attribute('deleted-nodes', name($c))
                                                 ))"/>
                        <xf:insert ev:event="xforms-submit-done xforms-submit-error"
                                       context="instance('events')" ref="*"
                                       origin="xf:element('event',
                                                (xf:attribute('type', event('xxf:type')),
                                                 xf:attribute('target', event('xxf:targetid')),
                                                 for $c in event('error-type') return xf:attribute('inserted-nodes', $c)
                                                 ))"/>

                    </xf:model>
                </xh:head>
                <xh:body>

                </xh:body>
            </xh:html>
        </input>
        <output name="response">
            <xxf:event-response>
                <xxf:dynamic-state>
                    <dynamic-state>
                        <instances>
                            <instance id="source-instance" model-id="model">
                                <book>
                                    <title lang="en">Pale Blue Dot</title>
                                    <author>Carl Sagan</author>
                                </book>
                            </instance>
                            <instance id="events" model-id="model">
                                <events>
                                    <event type="xforms-insert" target="source-instance" inserted-nodes="book"/>
                                    <event type="xforms-submit-done" target="replace-instance"/>
                                </events>
                            </instance>
                        </instances>
                    </dynamic-state>
                </xxf:dynamic-state>
                <xxf:action>
                    <xxf:control-values/>
                </xxf:action>
            </xxf:event-response>
        </output>
    </test>

    <test description="Instance replacement: replace submitted instance using @targetref" name="oxf:pipeline">
        <input name="config" href="wrap-xforms-state.xpl"/>
        <input name="document">
            <xh:html>
                <xh:head>
                    <xf:model id="model">

                        <xf:instance id="source-instance">
                            <dummy/>
                        </xf:instance>

                        <xf:send ev:event="xforms-model-construct-done" submission="replace-instance"/>
                        <xf:submission id="replace-instance" method="get" serialization="none"
                                resource="oxf:/org/orbeon/oxf/xforms/data/sample-instance.xml"
                                replace="instance" targetref="instance('source-instance')"/>

                        <!-- TEST: Events to gather -->
                        <xf:instance id="events">
                            <events/>
                        </xf:instance>
                        <xf:insert ev:event="xforms-insert xforms-delete" ev:target="source-instance destination-instance"
                                       context="instance('events')" ref="*"
                                       origin="xf:element('event',
                                                (xf:attribute('type', event('xxf:type')),
                                                 xf:attribute('target', event('xxf:targetid')),
                                                 for $c in event('inserted-nodes')[1] return xf:attribute('inserted-nodes', name($c)),
                                                 for $c in event('deleted-nodes')[1] return xf:attribute('deleted-nodes', name($c))
                                                 ))"/>
                        <xf:insert ev:event="xforms-submit-done xforms-submit-error"
                                       context="instance('events')" ref="*"
                                       origin="xf:element('event',
                                                (xf:attribute('type', event('xxf:type')),
                                                 xf:attribute('target', event('xxf:targetid')),
                                                 for $c in event('error-type') return xf:attribute('error-type', $c)
                                                 ))"/>

                    </xf:model>
                </xh:head>
                <xh:body>

                </xh:body>
            </xh:html>
        </input>
        <output name="response">
            <xxf:event-response>
                <xxf:dynamic-state>
                    <dynamic-state>
                        <instances>
                            <instance id="source-instance" model-id="model">
                                <book>
                                    <title lang="en">Pale Blue Dot</title>
                                    <author>Carl Sagan</author>
                                </book>
                            </instance>
                            <instance id="events" model-id="model">
                                <events>
                                    <event type="xforms-insert" target="source-instance" inserted-nodes="book"/>
                                    <event type="xforms-submit-done" target="replace-instance"/>
                                </events>
                            </instance>
                        </instances>
                    </dynamic-state>
                </xxf:dynamic-state>
                <xxf:action>
                    <xxf:control-values/>
                </xxf:action>
            </xxf:event-response>
        </output>
    </test>

    <test description="Instance replacement: replace subset of submitted instance using @targetref" name="oxf:pipeline">
        <input name="config" href="wrap-xforms-state.xpl"/>
        <input name="document">
            <xh:html>
                <xh:head>
                    <xf:model id="model">

                        <xf:instance id="source-instance">
                            <books>
                                <before/>
                                <here/>
                                <after/>
                            </books>
                        </xf:instance>

                        <xf:send ev:event="xforms-model-construct-done" submission="replace-instance"/>
                        <xf:submission id="replace-instance" method="get" serialization="none"
                                resource="oxf:/org/orbeon/oxf/xforms/data/sample-instance.xml"
                                replace="instance" targetref="instance('source-instance')/here"/>

                        <!-- TEST: Events to gather -->
                        <xf:instance id="events">
                            <events/>
                        </xf:instance>
                        <xf:insert ev:event="xforms-insert xforms-delete" ev:target="source-instance destination-instance"
                                       context="instance('events')" ref="*"
                                       origin="xf:element('event',
                                                (xf:attribute('type', event('xxf:type')),
                                                 xf:attribute('target', event('xxf:targetid')),
                                                 for $c in event('inserted-nodes')[1] return xf:attribute('inserted-nodes', name($c)),
                                                 for $c in event('deleted-nodes')[1] return xf:attribute('deleted-nodes', name($c))
                                                 ))"/>
                        <xf:insert ev:event="xforms-submit-done xforms-submit-error"
                                       context="instance('events')" ref="*"
                                       origin="xf:element('event',
                                                (xf:attribute('type', event('xxf:type')),
                                                 xf:attribute('target', event('xxf:targetid')),
                                                 for $c in event('error-type') return xf:attribute('error-type', $c)
                                                 ))"/>

                    </xf:model>
                </xh:head>
                <xh:body>

                </xh:body>
            </xh:html>
        </input>
        <output name="response">
            <xxf:event-response>
                <xxf:dynamic-state>
                    <dynamic-state>
                        <instances>
                            <instance id="source-instance" model-id="model">
                                <books>
                                    <before/>
                                    <book>
                                        <title lang="en">Pale Blue Dot</title>
                                        <author>Carl Sagan</author>
                                    </book>
                                    <after/>
                                </books>
                            </instance>
                            <instance id="events" model-id="model">
                                <events>
                                    <event type="xforms-insert" target="source-instance" inserted-nodes="book"/>
                                    <event type="xforms-delete" target="source-instance" deleted-nodes="here"/>
                                    <event type="xforms-submit-done" target="replace-instance"/>
                                </events>
                            </instance>
                        </instances>
                    </dynamic-state>
                </xxf:dynamic-state>
                <xxf:action>
                    <xxf:control-values/>
                </xxf:action>
            </xxf:event-response>
        </output>
    </test>

    <test description="Instance replacement: replace other instance" name="oxf:pipeline">
        <input name="config" href="wrap-xforms-state.xpl"/>
        <input name="document">
            <xh:html>
                <xh:head>
                    <xf:model id="model">

                        <xf:instance id="source-instance">
                            <dummy/>
                        </xf:instance>

                        <xf:instance id="destination-instance">
                            <dummy/>
                        </xf:instance>

                        <xf:send ev:event="xforms-model-construct-done" submission="replace-instance"/>
                        <xf:submission id="replace-instance" method="get" serialization="none"
                                resource="oxf:/org/orbeon/oxf/xforms/data/sample-instance.xml"
                                replace="instance" instance="destination-instance"/>

                        <!-- TEST: Events to gather -->
                        <xf:instance id="events">
                            <events/>
                        </xf:instance>
                        <xf:insert ev:event="xforms-insert xforms-delete" ev:target="source-instance destination-instance"
                                       context="instance('events')" ref="*"
                                       origin="xf:element('event',
                                                (xf:attribute('type', event('xxf:type')),
                                                 xf:attribute('target', event('xxf:targetid')),
                                                 for $c in event('inserted-nodes')[1] return xf:attribute('inserted-nodes', name($c)),
                                                 for $c in event('deleted-nodes')[1] return xf:attribute('deleted-nodes', name($c))
                                                 ))"/>
                        <xf:insert ev:event="xforms-submit-done xforms-submit-error"
                                       context="instance('events')" ref="*"
                                       origin="xf:element('event',
                                                (xf:attribute('type', event('xxf:type')),
                                                 xf:attribute('target', event('xxf:targetid')),
                                                 for $c in event('error-type') return xf:attribute('error-type', $c)
                                                 ))"/>

                    </xf:model>
                </xh:head>
                <xh:body>

                </xh:body>
            </xh:html>
        </input>
        <output name="response">
            <xxf:event-response>
                <xxf:dynamic-state>
                    <dynamic-state>
                        <instances>
                            <instance id="destination-instance" model-id="model">
                                <book>
                                    <title lang="en">Pale Blue Dot</title>
                                    <author>Carl Sagan</author>
                                </book>
                            </instance>
                            <instance id="events" model-id="model">
                                <events>
                                    <event type="xforms-insert" target="destination-instance" inserted-nodes="book"/>
                                    <event type="xforms-submit-done" target="replace-instance"/>
                                </events>
                            </instance>
                        </instances>
                    </dynamic-state>
                </xxf:dynamic-state>
                <xxf:action>
                    <xxf:control-values/>
                </xxf:action>
            </xxf:event-response>
        </output>
    </test>

    <test description="Instance replacement: replace other instance using @instance and @targetref" name="oxf:pipeline">
        <input name="config" href="wrap-xforms-state.xpl"/>
        <input name="document">
            <xh:html>
                <xh:head>
                    <xf:model id="model">

                        <xf:instance id="source-instance">
                            <dummy/>
                        </xf:instance>

                        <xf:instance id="destination-instance">
                            <dummy/>
                        </xf:instance>

                        <xf:send ev:event="xforms-model-construct-done" submission="replace-instance"/>
                        <xf:submission id="replace-instance" method="get" serialization="none"
                                resource="oxf:/org/orbeon/oxf/xforms/data/sample-instance.xml"
                                replace="instance" instance="destination-instance" targetref="."/>

                        <!-- TEST: Events to gather -->
                        <xf:instance id="events">
                            <events/>
                        </xf:instance>
                        <xf:insert ev:event="xforms-insert xforms-delete" ev:target="source-instance destination-instance"
                                       context="instance('events')" ref="*"
                                       origin="xf:element('event',
                                                (xf:attribute('type', event('xxf:type')),
                                                 xf:attribute('target', event('xxf:targetid')),
                                                 for $c in event('inserted-nodes')[1] return xf:attribute('inserted-nodes', name($c)),
                                                 for $c in event('deleted-nodes')[1] return xf:attribute('deleted-nodes', name($c))
                                                 ))"/>
                        <xf:insert ev:event="xforms-submit-done xforms-submit-error"
                                       context="instance('events')" ref="*"
                                       origin="xf:element('event',
                                                (xf:attribute('type', event('xxf:type')),
                                                 xf:attribute('target', event('xxf:targetid')),
                                                 for $c in event('error-type') return xf:attribute('error-type', $c)
                                                 ))"/>

                    </xf:model>
                </xh:head>
                <xh:body>

                </xh:body>
            </xh:html>
        </input>
        <output name="response">
            <xxf:event-response>
                <xxf:dynamic-state>
                    <dynamic-state>
                        <instances>
                            <instance id="destination-instance" model-id="model">
                                <book>
                                    <title lang="en">Pale Blue Dot</title>
                                    <author>Carl Sagan</author>
                                </book>
                            </instance>
                            <instance id="events" model-id="model">
                                <events>
                                    <event type="xforms-insert" target="destination-instance" inserted-nodes="book"/>
                                    <event type="xforms-submit-done" target="replace-instance"/>
                                </events>
                            </instance>
                        </instances>
                    </dynamic-state>
                </xxf:dynamic-state>
                <xxf:action>
                    <xxf:control-values/>
                </xxf:action>
            </xxf:event-response>
        </output>
    </test>

    <test description="Instance replacement: replace other instance using @targetref only" name="oxf:pipeline">
        <input name="config" href="wrap-xforms-state.xpl"/>
        <input name="document">
            <xh:html>
                <xh:head>
                    <xf:model id="model">

                        <xf:instance id="source-instance">
                            <dummy/>
                        </xf:instance>

                        <xf:instance id="destination-instance">
                            <dummy/>
                        </xf:instance>

                        <xf:send ev:event="xforms-model-construct-done" submission="replace-instance"/>
                        <xf:submission id="replace-instance" method="get" serialization="none"
                                resource="oxf:/org/orbeon/oxf/xforms/data/sample-instance.xml"
                                replace="instance" targetref="instance('destination-instance')"/>

                        <!-- TEST: Events to gather -->
                        <xf:instance id="events">
                            <events/>
                        </xf:instance>
                        <xf:insert ev:event="xforms-insert xforms-delete" ev:target="source-instance destination-instance"
                                       context="instance('events')" ref="*"
                                       origin="xf:element('event',
                                                (xf:attribute('type', event('xxf:type')),
                                                 xf:attribute('target', event('xxf:targetid')),
                                                 for $c in event('inserted-nodes')[1] return xf:attribute('inserted-nodes', name($c)),
                                                 for $c in event('deleted-nodes')[1] return xf:attribute('deleted-nodes', name($c))
                                                 ))"/>
                        <xf:insert ev:event="xforms-submit-done xforms-submit-error"
                                       context="instance('events')" ref="*"
                                       origin="xf:element('event',
                                                (xf:attribute('type', event('xxf:type')),
                                                 xf:attribute('target', event('xxf:targetid')),
                                                 for $c in event('error-type') return xf:attribute('error-type', $c)
                                                 ))"/>

                    </xf:model>
                </xh:head>
                <xh:body>

                </xh:body>
            </xh:html>
        </input>
        <output name="response">
            <xxf:event-response>
                <xxf:dynamic-state>
                    <dynamic-state>
                        <instances>
                            <instance id="destination-instance" model-id="model">
                                <book>
                                    <title lang="en">Pale Blue Dot</title>
                                    <author>Carl Sagan</author>
                                </book>
                            </instance>
                            <instance id="events" model-id="model">
                                <events>
                                    <event type="xforms-insert" target="destination-instance" inserted-nodes="book"/>
                                    <event type="xforms-submit-done" target="replace-instance"/>
                                </events>
                            </instance>
                        </instances>
                    </dynamic-state>
                </xxf:dynamic-state>
                <xxf:action>
                    <xxf:control-values/>
                </xxf:action>
            </xxf:event-response>
        </output>
    </test>

    <test description="Instance replacement: replace subset of other instance using @targetref only" name="oxf:pipeline">
        <input name="config" href="wrap-xforms-state.xpl"/>
        <input name="document">
            <xh:html>
                <xh:head>
                    <xf:model id="model">

                        <xf:instance id="source-instance">
                            <dummy/>
                        </xf:instance>

                        <xf:instance id="destination-instance">
                            <books>
                                <before/>
                                <here/>
                                <after/>
                            </books>
                        </xf:instance>

                        <xf:send ev:event="xforms-model-construct-done" submission="replace-instance"/>
                        <xf:submission id="replace-instance" method="get" serialization="none"
                                resource="oxf:/org/orbeon/oxf/xforms/data/sample-instance.xml"
                                replace="instance" targetref="instance('destination-instance')/here"/>

                        <!-- TEST: Events to gather -->
                        <xf:instance id="events">
                            <events/>
                        </xf:instance>
                        <xf:insert ev:event="xforms-insert xforms-delete" ev:target="source-instance destination-instance"
                                       context="instance('events')" ref="*"
                                       origin="xf:element('event',
                                                (xf:attribute('type', event('xxf:type')),
                                                 xf:attribute('target', event('xxf:targetid')),
                                                 for $c in event('inserted-nodes')[1] return xf:attribute('inserted-nodes', name($c)),
                                                 for $c in event('deleted-nodes')[1] return xf:attribute('deleted-nodes', name($c))
                                                 ))"/>
                        <xf:insert ev:event="xforms-submit-done xforms-submit-error"
                                       context="instance('events')" ref="*"
                                       origin="xf:element('event',
                                                (xf:attribute('type', event('xxf:type')),
                                                 xf:attribute('target', event('xxf:targetid')),
                                                 for $c in event('error-type') return xf:attribute('error-type', $c)
                                                 ))"/>

                    </xf:model>
                </xh:head>
                <xh:body>

                </xh:body>
            </xh:html>
        </input>
        <output name="response">
            <xxf:event-response>
                <xxf:dynamic-state>
                    <dynamic-state>
                        <instances>
                            <instance id="destination-instance" model-id="model">
                                <books>
                                    <before/>
                                    <book>
                                        <title lang="en">Pale Blue Dot</title>
                                        <author>Carl Sagan</author>
                                    </book>
                                    <after/>
                                </books>
                            </instance>
                            <instance id="events" model-id="model">
                                <events>
                                    <event type="xforms-insert" target="destination-instance" inserted-nodes="book"/>
                                    <event type="xforms-delete" target="destination-instance" deleted-nodes="here"/>
                                    <event type="xforms-submit-done" target="replace-instance"/>
                                </events>
                            </instance>
                        </instances>
                    </dynamic-state>
                </xxf:dynamic-state>
                <xxf:action>
                    <xxf:control-values/>
                </xxf:action>
            </xxf:event-response>
        </output>
    </test>

    <test description="Instance replacement: destination points to instance element node" name="oxf:pipeline">
        <input name="config" href="wrap-xforms-state.xpl"/>
        <input name="document">
            <xh:html>
                <xh:head>
                    <xf:model id="model">

                        <xf:instance id="source-instance">
                            <dummy foo="bar"/>
                        </xf:instance>

                        <xf:action ev:event="xforms-model-construct-done">
                            <xf:send submission="replace-instance-1"/>
                            <xf:send submission="replace-instance-2"/>
                            <xf:send submission="replace-instance-3"/>
                        </xf:action>
                        <!-- Attribute node -->
                        <xf:submission id="replace-instance-1" method="get" serialization="none"
                                resource="oxf:/org/orbeon/oxf/xforms/data/sample-instance.xml"
                                replace="instance" targetref="/*/@bar"/>
                        <!-- Document node -->
                        <xf:submission id="replace-instance-2" method="get" serialization="none"
                                resource="oxf:/org/orbeon/oxf/xforms/data/sample-instance.xml"
                                replace="instance" targetref="/"/>
                        <!-- Non-instance element -->
                        <xf:submission id="replace-instance-3" method="get" serialization="none"
                                resource="oxf:/org/orbeon/oxf/xforms/data/sample-instance.xml"
                                replace="instance" targetref="xf:element('foobar')"/>

                        <!-- TEST: Events to gather -->
                        <xf:instance id="events">
                            <events/>
                        </xf:instance>
                        <xf:insert ev:event="xforms-insert xforms-delete" ev:target="source-instance destination-instance"
                                       context="instance('events')" ref="*"
                                       origin="xf:element('event',
                                                (xf:attribute('type', event('xxf:type')),
                                                 xf:attribute('target', event('xxf:targetid')),
                                                 for $c in event('inserted-nodes')[1] return xf:attribute('inserted-nodes', name($c)),
                                                 for $c in event('deleted-nodes')[1] return xf:attribute('deleted-nodes', name($c))
                                                 ))"/>
                        <xf:insert ev:event="xforms-submit-done xforms-submit-error"
                                       context="instance('events')" ref="*"
                                       origin="xf:element('event',
                                                (xf:attribute('type', event('xxf:type')),
                                                 xf:attribute('target', event('xxf:targetid')),
                                                 for $c in event('error-type') return xf:attribute('error-type', $c)
                                                 ))"/>

                    </xf:model>
                </xh:head>
                <xh:body>

                </xh:body>
            </xh:html>
        </input>
        <output name="response">
            <xxf:event-response>
                <xxf:dynamic-state>
                    <dynamic-state>
                         <instances>
                            <instance id="events" model-id="model">
                                <events>
                                    <event type="xforms-submit-error" target="replace-instance-1" error-type="target-error"/>
                                    <event type="xforms-submit-error" target="replace-instance-2" error-type="target-error"/>
                                    <event type="xforms-submit-error" target="replace-instance-3" error-type="target-error"/>
                                </events>
                            </instance>
                        </instances>
                    </dynamic-state>
                </xxf:dynamic-state>
                <xxf:action>
                    <xxf:control-values/>
                </xxf:action>
            </xxf:event-response>
        </output>
    </test>

    <test description="Instance replacement: replace dispatches events for controls bound to replaced subset" name="oxf:pipeline">
        <input name="config" href="wrap-xforms-state.xpl"/>
        <input name="document">
            <xh:html>
                <xh:head>
                    <xf:model id="model">

                        <xf:instance id="source-instance">
                            <books>
                                <book/>
                                <book>
                                    <title lang="fr">Jacques le fataliste et son maître</title>
                                    <author>Diderot</author>
                                </book>
                            </books>
                        </xf:instance>

                        <xf:action ev:event="xforms-ready">
                            <!-- Refresh will cause UI events dispatch -->
                            <xf:refresh/>
                            <!-- Clear all events recorded so far -->
                            <xf:delete ref="instance('events')/*"/>
                            <!-- Start submission -->
                            <xf:send submission="replace-instance"/>
                        </xf:action>
                        <xf:submission id="replace-instance" method="get" serialization="none"
                                resource="oxf:/org/orbeon/oxf/xforms/data/sample-instance.xml"
                                replace="instance" targetref="instance('source-instance')/book"/>

                        <!-- TEST: Events to gather -->
                        <xf:instance id="events">
                            <events/>
                        </xf:instance>
                        <xf:insert ev:event="xforms-insert xforms-delete" ev:target="source-instance destination-instance"
                                       context="instance('events')" ref="*"
                                       origin="xf:element('event',
                                                (xf:attribute('type', event('xxf:type')),
                                                 xf:attribute('target', event('xxf:targetid')),
                                                 for $c in event('inserted-nodes')[1] return xf:attribute('inserted-nodes', name($c)),
                                                 for $c in event('deleted-nodes')[1] return xf:attribute('deleted-nodes', name($c))
                                                 ))"/>
                        <xf:insert ev:event="xforms-submit-done xforms-submit-error"
                                       context="instance('events')" ref="*"
                                       origin="xf:element('event',
                                                (xf:attribute('type', event('xxf:type')),
                                                 xf:attribute('target', event('xxf:targetid')),
                                                 for $c in event('error-type') return xf:attribute('error-type', $c)
                                                 ))"/>

                    </xf:model>
                </xh:head>
                <xh:body>

                    <xf:group id="group">
                        <xf:insert ev:event="xforms-insert xforms-delete xforms-submit-done xforms-enabled"
                                       context="instance('events')" ref="*"
                                       origin="xf:element('event',
                                                (xf:attribute('type', event('xxf:type')),
                                                 xf:attribute('target', event('xxf:targetid')),
                                                 for $c in event('error-type') return xf:attribute('error-type', $c)
                                                 ))"/>

                        <!-- This must change -->
                        <xf:input id="title1" ref="book[1]/title"/>
                        <xf:input id="lang1" ref="book[1]/title/@lang"/>
                        <!-- This must not -->
                        <xf:input id="title2" ref="book[2]/title"/>
                        <xf:input id="lang2" ref="book[2]/title/@lang"/>
                    </xf:group>
                </xh:body>
            </xh:html>
        </input>
        <output name="response">
            <xxf:event-response>
                <xxf:dynamic-state>
                    <dynamic-state>
                        <instances>
                            <instance id="source-instance" model-id="model">
                                <books>
                                    <book>
                                        <title lang="en">Pale Blue Dot</title>
                                        <author>Carl Sagan</author>
                                    </book>
                                    <book>
                                        <title lang="fr">Jacques le fataliste et son maître</title>
                                        <author>Diderot</author>
                                    </book>
                                </books>
                            </instance>
                            <instance id="events" model-id="model">
                                <events>
                                    <event type="xforms-insert" target="source-instance" inserted-nodes="book"/>
                                    <event type="xforms-delete" target="source-instance" deleted-nodes="book"/>
                                    <event type="xforms-submit-done" target="replace-instance"/>
                                    <event type="xforms-enabled" target="title1"/>
                                    <event type="xforms-enabled" target="lang1"/>
                                </events>
                            </instance>
                        </instances>
                    </dynamic-state>
                </xxf:dynamic-state>
                <xxf:action>
                    <xxf:control-values>
                        <xxf:control id="title1">
                            <xxf:value>Pale Blue Dot</xxf:value>
                        </xxf:control>
                        <xxf:control id="lang1">
                            <xxf:value>en</xxf:value>
                        </xxf:control>
                        <xxf:control id="title2">
                            <xxf:value>Jacques le fataliste et son maître</xxf:value>
                        </xxf:control>
                        <xxf:control id="lang2">
                            <xxf:value>fr</xxf:value>
                        </xxf:control>
                    </xxf:control-values>
                </xxf:action>
            </xxf:event-response>
        </output>
    </test>

    <test description="Instance replacement: replace text" name="oxf:pipeline">
        <input name="config" href="wrap-xforms-state.xpl"/>
        <input name="document">
            <xh:html>
                <xh:head>
                    <xf:model id="model">

                        <xf:instance id="source-instance">
                            <book/>
                        </xf:instance>

                        <xf:send ev:event="xforms-model-construct-done" submission="replace-instance"/>
                        <xf:submission id="replace-instance" method="get" serialization="none"
                                resource="oxf:/org/orbeon/oxf/xforms/data/sample-instance.xml"
                                replace="text" targetref="instance('source-instance')"/>

                        <!-- TEST: Events to gather -->
                        <xf:instance id="events">
                            <events/>
                        </xf:instance>
                        <xf:insert ev:event="xforms-insert xforms-delete" ev:target="source-instance destination-instance"
                                       context="instance('events')" ref="*"
                                       origin="xf:element('event',
                                                (xf:attribute('type', event('xxf:type')),
                                                 xf:attribute('target', event('xxf:targetid')),
                                                 for $c in event('inserted-nodes')[1] return xf:attribute('inserted-nodes', name($c)),
                                                 for $c in event('deleted-nodes')[1] return xf:attribute('deleted-nodes', name($c))
                                                 ))"/>
                        <xf:insert ev:event="xforms-submit-done xforms-submit-error"
                                       context="instance('events')" ref="*"
                                       origin="xf:element('event',
                                                (xf:attribute('type', event('xxf:type')),
                                                 xf:attribute('target', event('xxf:targetid')),
                                                 for $c in event('error-type') return xf:attribute('error-type', $c)
                                                 ))"/>

                    </xf:model>
                </xh:head>
                <xh:body>

                </xh:body>
            </xh:html>
        </input>
        <output name="response">
            <xxf:event-response>
                <xxf:dynamic-state>
                    <dynamic-state>
                        <instances>
                            <instance id="source-instance" model-id="model">
                                <book>&lt;book&gt;
    &lt;title lang="en"&gt;Pale Blue Dot&lt;/title&gt;
    &lt;author&gt;Carl Sagan&lt;/author&gt;
&lt;/book&gt;</book>
                            </instance>
                            <instance id="events" model-id="model">
                                <events>
                                    <event type="xforms-submit-done" target="replace-instance"/>
                                </events>
                            </instance>
                        </instances>
                    </dynamic-state>
                </xxf:dynamic-state>
                <xxf:action>
                    <xxf:control-values/>
                </xxf:action>
            </xxf:event-response>
        </output>
    </test>

    <test description="Instance replacement: errors when using xxf:readonly and/or xxf:shared" name="oxf:pipeline">
        <input name="config" href="wrap-xforms-state.xpl"/>
        <input name="document">
            <xh:html>
                <xh:head>
                    <xf:model id="model">

                        <xf:instance id="source-instance">
                            <dummy>
                                <nested-element/>
                            </dummy>
                        </xf:instance>

                        <xf:action ev:event="xforms-model-construct-done">
                            <xf:send submission="replace-instance-1"/>
                            <xf:send submission="replace-instance-2"/>
                            <xf:send submission="replace-instance-3"/>
                        </xf:action>
                        <!-- xxf:readonly -->
                        <xf:submission id="replace-instance-1" method="get" serialization="none"
                                resource="oxf:/org/orbeon/oxf/xforms/data/sample-instance.xml"
                                replace="instance" targetref="/*/nested-element" xxf:readonly="true"/>
                        <!-- xxf:shared -->
                        <xf:submission id="replace-instance-2" method="get" serialization="none"
                                resource="oxf:/org/orbeon/oxf/xforms/data/sample-instance.xml"
                                replace="instance" targetref="/*/nested-element" xxf:readonly="true" xxf:shared="application"/>
                        <!-- Regular case -->
                        <xf:submission id="replace-instance-3" method="get" serialization="none"
                                resource="oxf:/org/orbeon/oxf/xforms/data/sample-instance.xml"
                                replace="instance" targetref="/*/nested-element" />

                        <!-- TEST: Events to gather -->
                        <xf:instance id="events">
                            <events/>
                        </xf:instance>
                        <xf:insert ev:event="xforms-insert xforms-delete" ev:target="source-instance destination-instance"
                                       context="instance('events')" ref="*"
                                       origin="xf:element('event',
                                                (xf:attribute('type', event('xxf:type')),
                                                 xf:attribute('target', event('xxf:targetid')),
                                                 for $c in event('inserted-nodes')[1] return xf:attribute('inserted-nodes', name($c)),
                                                 for $c in event('deleted-nodes')[1] return xf:attribute('deleted-nodes', name($c))
                                                 ))"/>
                        <xf:insert ev:event="xforms-submit-done xforms-submit-error"
                                       context="instance('events')" ref="*"
                                       origin="xf:element('event',
                                                (xf:attribute('type', event('xxf:type')),
                                                 xf:attribute('target', event('xxf:targetid')),
                                                 for $c in event('error-type') return xf:attribute('error-type', $c)
                                                 ))"/>

                    </xf:model>
                </xh:head>
                <xh:body>

                </xh:body>
            </xh:html>
        </input>
        <output name="response">
            <xxf:event-response>
                <xxf:dynamic-state>
                    <dynamic-state>
                        <instances>
                            <instance id="source-instance" model-id="model">
                                <dummy>
                                    <book>
                                        <title lang="en">Pale Blue Dot</title>
                                        <author>Carl Sagan</author>
                                    </book>
                                </dummy>
                            </instance>
                            <instance id="events" model-id="model">
                                <events>
                                    <event type="xforms-submit-error" target="replace-instance-1" error-type="target-error"/>
                                    <event type="xforms-submit-error" target="replace-instance-2" error-type="target-error"/>
                                    <event type="xforms-insert" target="source-instance" inserted-nodes="book"/>
                                    <event type="xforms-delete" target="source-instance" deleted-nodes="nested-element"/>
                                    <event type="xforms-submit-done" target="replace-instance-3"/>
                                </events>
                            </instance>
                        </instances>
                    </dynamic-state>
                </xxf:dynamic-state>
                <xxf:action>
                    <xxf:control-values/>
                </xxf:action>
            </xxf:event-response>
        </output>
    </test>

    <test description="Replacement of read-write cached instance keeps instances separate" name="oxf:pipeline">
        <input name="config" href="wrap-xforms-state.xpl"/>
        <input name="document">
            <xh:html>
                <xh:head>
                    <xf:model id="model">

                        <xf:instance id="instance-1">
                            <dummy/>
                        </xf:instance>
                        <xf:instance id="instance-2">
                            <dummy/>
                        </xf:instance>

                        <!-- Load instances upon init -->
                        <xf:action ev:event="xforms-model-construct-done">
                            <xf:send submission="get-instance-1"/>
                            <xf:send submission="get-instance-2"/>
                        </xf:action>
                        <xf:submission id="get-instance-1" method="get" serialization="none"
                                resource="oxf:/ops/unit-tests/test-data/book-diderot.xml"
                                replace="instance" targetref="instance('instance-1')" xxf:readonly="false" xxf:cache="true">
                            <xf:setvalue ev:event="xforms-submit-done" ref="details/link">http://en.wikipedia.org/wiki/Jacques_le_fataliste_et_son_ma%C3%AEtre</xf:setvalue>
                        </xf:submission>
                        <xf:submission id="get-instance-2" method="get" serialization="none"
                                resource="oxf:/ops/unit-tests/test-data/book-diderot.xml"
                                replace="instance" targetref="instance('instance-2')" xxf:cache="true">
                            <xf:setvalue ev:event="xforms-submit-done" ref="instance('instance-2')/details/link">http://fr.wikipedia.org/wiki/Jacques_le_fataliste_et_son_ma%C3%AEtre</xf:setvalue>
                        </xf:submission>

                    </xf:model>
                </xh:head>
                <xh:body>
                    <xf:output id="my-output-1" ref="instance('instance-1')/details/link"/>
                    <xf:output id="my-output-2" ref="instance('instance-2')/details/link"/>
                </xh:body>
            </xh:html>
        </input>
        <output name="response">
            <xxf:event-response>
                <xxf:dynamic-state>
                    <dynamic-state>
                        <instances>
                            <instance cache="true" id="instance-1" model-id="model" source-uri="oxf:/ops/unit-tests/test-data/book-diderot.xml"/>
                            <instance cache="true" id="instance-2" model-id="model" source-uri="oxf:/ops/unit-tests/test-data/book-diderot.xml"/>
                        </instances>
                    </dynamic-state>
                </xxf:dynamic-state>
                <xxf:action>
                    <xxf:control-values>
                        <xxf:control id="my-output-1">
                            <xxf:value>http://en.wikipedia.org/wiki/Jacques_le_fataliste_et_son_ma%C3%AEtre</xxf:value>
                        </xxf:control>
                        <xxf:control id="my-output-2">
                            <xxf:value>http://fr.wikipedia.org/wiki/Jacques_le_fataliste_et_son_ma%C3%AEtre</xxf:value>
                        </xxf:control>
                    </xxf:control-values>
                </xxf:action>
            </xxf:event-response>
        </output>
    </test>

    <test description="xf:submission/@xxf:recalculate" name="oxf:pipeline">
        <input name="config" href="wrap-xforms-state.xpl"/>
        <input name="document">
            <xh:html>
                <xh:head>
                    <xf:model id="model">

                        <xf:instance id="request">
                            <request/>
                        </xf:instance>

                        <xf:instance id="response-calculate-norebuild">
                            <response/>
                        </xf:instance>

                        <xf:instance id="response-calculate-rebuild">
                            <response/>
                        </xf:instance>

                        <xf:instance id="response-nocalculate-norebuild1">
                            <response/>
                        </xf:instance>

                        <xf:instance id="response-nocalculate-norebuild2">
                            <response/>
                        </xf:instance>

                        <xf:instance id="template" xxf:readonly="true">
                            <request>
                                <value/>
                                <value/>
                                <position>1</position>
                                <source>42</source>
                            </request>
                        </xf:instance>

                        <xf:bind ref="instance()/value[position() = instance()/position]" calculate="instance()/source"/>

                        <!-- Run submissions upon init -->
                        <xf:action ev:event="xforms-model-construct-done">
                            <xf:send submission="calculate-norebuild"/>
                            <xf:send submission="calculate-rebuild"/>
                            <xf:send submission="nocalculate-norebuild1"/>
                            <xf:send submission="nocalculate-norebuild2"/>
                            <!-- TODO: case of serialization="none" -->
                        </xf:action>

                        <xf:submission id="calculate-norebuild" ref="instance()" method="post" resource="echo:"
                                           replace="instance" instance="response-calculate-norebuild"
                                           validate="false" relevant="false">

                            <xf:action ev:event="xforms-submit">
                                <!-- Restore state -->
                                <xf:insert ref="instance()" origin="instance('template')"/>
                                <xf:rebuild/>
                                <xf:recalculate/>
                                <!-- setvalue: expecting just recalculate -->
                                <xf:setvalue ref="instance()/source">888</xf:setvalue>
                                <xf:setvalue ref="instance()/position">2</xf:setvalue>
                            </xf:action>
                        </xf:submission>

                        <xf:submission id="calculate-rebuild" ref="instance()" method="post" resource="echo:"
                                           replace="instance" instance="response-calculate-rebuild"
                                           validate="false" relevant="false">

                            <xf:action ev:event="xforms-submit">
                                <!-- Restore state but don't refresh -->
                                <xf:insert ref="instance()" origin="instance('template')"/>

                                <!-- Because of insert above, expecting: rebuild, recalculate -->
                                <xf:setvalue ref="instance()/source">888</xf:setvalue>
                                <xf:setvalue ref="instance()/position">2</xf:setvalue>
                            </xf:action>
                        </xf:submission>

                        <xf:submission id="nocalculate-norebuild1" ref="instance()" method="post" resource="echo:"
                                           replace="instance" instance="response-nocalculate-norebuild1"
                                           validate="false" relevant="false" xxf:calculate="false">

                            <xf:action ev:event="xforms-submit">
                                <!-- Restore state -->
                                <xf:insert ref="instance()" origin="instance('template')"/>
                                <xf:rebuild/>
                                <xf:recalculate/>
                                <!-- NOT expecting rebuild or recalculate, binds point to new instance -->
                                <xf:setvalue ref="instance()/source">888</xf:setvalue>
                                <xf:setvalue ref="instance()/position">2</xf:setvalue>
                            </xf:action>
                        </xf:submission>

                        <xf:submission id="nocalculate-norebuild2" ref="instance()" method="post" resource="echo:"
                                           replace="instance" instance="response-nocalculate-norebuild2"
                                           validate="false" relevant="false" xxf:calculate="false">

                            <xf:action ev:event="xforms-submit">
                                <!-- Restore state but don't refresh -->
                                <xf:insert ref="instance()" origin="instance('template')"/>

                                <!-- NOT expecting rebuild or recalculate, and binds point to old instance -->
                                <xf:setvalue ref="instance()/source">888</xf:setvalue>
                                <xf:setvalue ref="instance()/position">2</xf:setvalue>
                            </xf:action>
                        </xf:submission>

                    </xf:model>
                </xh:head>
            </xh:html>
        </input>
        <output name="response">
            <xxf:event-response>
                <xxf:dynamic-state>
                    <dynamic-state>
                        <instances>
                            <instance id="request" model-id="model">
                                <request>
                                    <value/>
                                    <value>888</value>
                                    <position>2</position>
                                    <source>888</source>
                                </request>
                            </instance>
                            <instance id="response-calculate-norebuild" model-id="model">
                                <request>
                                    <value>888</value>
                                    <value/>
                                    <position>2</position>
                                    <source>888</source>
                                </request>
                            </instance>
                            <instance id="response-calculate-rebuild" model-id="model">
                                <request>
                                    <value/>
                                    <value>888</value>
                                    <position>2</position>
                                    <source>888</source>
                                </request>
                            </instance>
                            <instance id="response-nocalculate-norebuild1" model-id="model">
                                <request>
                                    <value>42</value>
                                    <value/>
                                    <position>2</position>
                                    <source>888</source>
                                </request>
                            </instance>
                            <instance id="response-nocalculate-norebuild2" model-id="model">
                                <request>
                                    <value/>
                                    <value/>
                                    <position>2</position>
                                    <source>888</source>
                                </request>
                            </instance>
                        </instances>
                    </dynamic-state>
                </xxf:dynamic-state>
                <xxf:action>
                    <xxf:control-values/>
                </xxf:action>
            </xxf:event-response>
        </output>
    </test>

    <test description="Test xf:submission/@validate" name="oxf:pipeline">
        <input name="config" href="wrap-xforms-state.xpl"/>
        <input name="document">
            <xh:html>
                <xh:head>
                    <xf:model id="model">

                        <xf:instance id="request">
                            <request/>
                        </xf:instance>

                        <xf:instance id="response-validate-norebuild">
                            <response>
                                <type/>
                                <type/>
                            </response>
                        </xf:instance>

                        <xf:instance id="response-validate-rebuild">
                            <response>
                                <type/>
                                <type/>
                            </response>
                        </xf:instance>

                        <xf:instance id="response-novalidate-norebuild1">
                            <response>
                                <type/>
                                <type/>
                            </response>
                        </xf:instance>

                        <xf:instance id="response-novalidate-norebuild2">
                            <response>
                                <type/>
                                <type/>
                            </response>
                        </xf:instance>

                        <xf:instance id="template" xxf:readonly="true">
                            <request>
                                <value/>
                                <value/>
                                <position>1</position>
                            </request>
                        </xf:instance>

                        <xf:bind ref="instance()/value[position() = instance()/position]" type="xf:integer"/>

                        <!-- Run submissions upon init -->
                        <xf:action ev:event="xforms-model-construct-done">
                            <xf:send submission="validate-norebuild"/>
                            <xf:send submission="validate-rebuild"/>
                            <xf:send submission="novalidate-norebuild1"/>
                            <xf:send submission="novalidate-norebuild2"/>
                            <!-- TODO: case of serialization="none" -->
                        </xf:action>

                        <xf:submission id="validate-norebuild" ref="instance()" method="post" resource="echo:"
                                           replace="none" validate="true" relevant="false" xxf:calculate="false">

                            <xf:action ev:event="xforms-submit">
                                <!-- Restore state -->
                                <xf:insert ref="instance()" origin="instance('template')"/>
                                <xf:rebuild/>
                                <xf:recalculate/>
                                <!-- setvalue: expecting just revalidate; integer type points to value[1] -->
                                <xf:setvalue ref="instance()/position">2</xf:setvalue>
                            </xf:action>
                            <xf:action ev:event="xforms-submit-done">
                                <xf:setvalue ref="instance('response-validate-norebuild')/type[1]" value="xxf:type(instance()/value[1])"/>
                                <xf:setvalue ref="instance('response-validate-norebuild')/type[2]" value="xxf:type(instance()/value[2])"/>
                            </xf:action>
                        </xf:submission>

                        <xf:submission id="validate-rebuild" ref="instance()" method="post" resource="echo:"
                                           replace="none" validate="true" relevant="false" xxf:calculate="false">

                            <xf:action ev:event="xforms-submit">
                                <!-- Restore state but don't refresh -->
                                <xf:insert ref="instance()" origin="instance('template')"/>

                                <!-- Because of insert above, expecting: rebuild, revalidate; integer type points to value[2] -->
                                <xf:setvalue ref="instance()/position">2</xf:setvalue>
                            </xf:action>
                            <xf:action ev:event="xforms-submit-done">
                                <xf:setvalue ref="instance('response-validate-rebuild')/type[1]" value="xxf:type(instance()/value[1])"/>
                                <xf:setvalue ref="instance('response-validate-rebuild')/type[2]" value="xxf:type(instance()/value[2])"/>
                            </xf:action>
                        </xf:submission>

                        <xf:submission id="novalidate-norebuild1" ref="instance()" method="post" resource="echo:"
                                           replace="none" validate="false" relevant="false" xxf:calculate="false">

                            <xf:action ev:event="xforms-submit">
                                <!-- Restore state -->
                                <xf:insert ref="instance()" origin="instance('template')"/>
                                <xf:rebuild/>
                                <xf:recalculate/>
                                <!-- NOT expecting rebuild or revalidate, binds point to new instance -->
                                <xf:setvalue ref="instance()/position">2</xf:setvalue>
                            </xf:action>
                            <xf:action ev:event="xforms-submit-done">
                                <xf:setvalue ref="instance('response-novalidate-norebuild1')/type[1]" value="xxf:type(instance()/value[1])"/>
                                <xf:setvalue ref="instance('response-novalidate-norebuild1')/type[2]" value="xxf:type(instance()/value[2])"/>
                            </xf:action>
                        </xf:submission>

                        <xf:submission id="novalidate-norebuild2" ref="instance()" method="post" resource="echo:"
                                           replace="none" validate="false" relevant="false" xxf:calculate="false">

                            <xf:action ev:event="xforms-submit">
                                <!-- Restore state but don't refresh -->
                                <xf:insert ref="instance()" origin="instance('template')"/>

                                <!-- NOT expecting rebuild or revalidate, and binds point to old instance -->
                                <xf:setvalue ref="instance()/position">2</xf:setvalue>
                            </xf:action>
                            <xf:action ev:event="xforms-submit-done">
                                <xf:setvalue ref="instance('response-novalidate-norebuild2')/type[1]" value="xxf:type(instance()/value[1])"/>
                                <xf:setvalue ref="instance('response-novalidate-norebuild2')/type[2]" value="xxf:type(instance()/value[2])"/>
                            </xf:action>
                        </xf:submission>

                    </xf:model>
                </xh:head>
            </xh:html>
        </input>
        <output name="response">
            <xxf:event-response>
                <xxf:dynamic-state>
                    <dynamic-state>
                        <instances>
                            <instance id="request" model-id="model">
                                <request>
                                    <value/>
                                    <value/>
                                    <position>2</position>
                                </request>
                            </instance>
                            <instance id="response-validate-norebuild" model-id="model">
                                <response>
                                    <type>integer</type>
                                    <type/>
                                </response>
                            </instance>
                            <instance id="response-validate-rebuild" model-id="model">
                                <response>
                                    <type/>
                                    <type>integer</type>
                                </response>
                            </instance>
                            <instance id="response-novalidate-norebuild1" model-id="model">
                                <response>
                                    <type>integer</type>
                                    <type/>
                                </response>
                            </instance>
                        </instances>
                    </dynamic-state>
                </xxf:dynamic-state>
                <xxf:action>
                    <xxf:control-values/>
                </xxf:action>
            </xxf:event-response>
        </output>
    </test>

    <test description="oxf:xforms-submission with actions upon successful result" name="oxf:xforms-submission">
        <input name="submission">
            <xf:submission method="get" resource="oxf:/org/orbeon/oxf/xforms/data/sample-instance.xml">
                <!-- Try some actions -->
                <xf:action ev:event="xforms-submit-done">
                    <xf:insert ref="/*" origin="xf:element('envelope', /*)"/>
                </xf:action>
            </xf:submission>
        </input>
        <input name="request">
            <dummy/>
        </input>
        <output name="response">
            <envelope>
                <book>
                    <title lang="en">Pale Blue Dot</title>
                    <author>Carl Sagan</author>
                </book>
            </envelope>
        </output>
    </test>

    <test description="oxf:xforms-submission with actions upon error result" name="oxf:xforms-submission">
        <input name="submission">
            <xf:submission method="get" resource="oxf:/ops/unit-tests/xforms-server/i-don't-exist.xml">
                <!-- Try some actions -->
                <xf:action ev:event="xforms-submit-done">
                    <xf:insert ref="/*" origin="xf:element('success')"/>
                </xf:action>
                <xf:action ev:event="xforms-submit-error">
                    <xf:insert ref="/*" origin="xf:element('failure')"/>
                </xf:action>
            </xf:submission>
        </input>
        <input name="request">
            <dummy/>
        </input>
        <output name="response">
            <failure/>
        </output>
    </test>

    <test description="xf:submit within XBL outer scope resolves submission" name="oxf:pipeline">
        <!-- See: http://forge.ow2.org/tracker/index.php?func=detail&aid=315509&group_id=168&atid=350207 -->
        <input name="config" href="wrap-xforms-state.xpl"/>
        <input name="document">
            <xh:html>
                <xh:head>
                    <xf:model id="model">
                        <xf:instance id="instance">
                            <instance/>
                        </xf:instance>
                        <!-- Simulate activation of submit button -->
                        <xf:dispatch ev:event="xforms-ready" name="DOMActivate" targetid="my-submit"/>
                        <xf:submission id="my-submission" method="get" resource="oxf:/org/orbeon/oxf/xforms/data/sample-instance.xml" replace="instance"/>
                    </xf:model>
                    <xbl:xbl>
                        <xbl:binding id="fr-foo" element="fr|foo">
                            <xbl:template>
                                <xbl:content/>
                            </xbl:template>
                        </xbl:binding>
                    </xbl:xbl>
                </xh:head>
                <xh:body>
                    <fr:foo id="my-foo">
                        <xf:submit id="my-submit" submission="my-submission"/>
                    </fr:foo>
                </xh:body>
            </xh:html>
        </input>
        <output name="response">
            <xxf:event-response>
                <xxf:dynamic-state>
                    <dynamic-state>
                        <instances>
                            <instance id="instance" model-id="model">
                                <book>
                                    <title lang="en">Pale Blue Dot</title>
                                    <author>Carl Sagan</author>
                                </book>
                            </instance>
                        </instances>
                    </dynamic-state>
                </xxf:dynamic-state>
                <xxf:action>
                    <xxf:control-values/>
                </xxf:action>
            </xxf:event-response>
        </output>
    </test>

    <test description="Submission replace=&#34;all&#34; upon initialization with content response" name="oxf:pipeline">
        <!-- See: http://forge.ow2.org/tracker/index.php?func=detail&aid=306918&group_id=168&atid=350207 -->
        <input name="config" href="wrap-xforms-init.xpl"/>
        <input name="document">
            <xh:html>
                <xh:head>
                    <xf:model id="model" xxf:optimize-get-all="false">
                        <xf:instance id="instance">
                            <instance/>
                        </xf:instance>
                        <xf:send
                            ev:event="xforms-model-construct-done"
                            submission="submission"/>
                        <xf:submission
                            id="submission"
                            serialization="none"
                            method="get"
                            action="oxf:/ops/unit-tests/test-data/book-diderot.xml"/>
                    </xf:model>
                </xh:head>
            </xh:html>
        </input>
        <output name="response">
            <document xsi:type="xs:base64Binary" content-type="application/xml" status-code="200">PGJvb2s+CiAgICA8ZGV0YWlscz4KICAgICAgICA8dGl0bGU+SmFjcXVlcyBsZSBmYXRhbGlzdGUg
ZXQgc29uIG1hw650cmU8L3RpdGxlPgogICAgICAgIDxhdXRob3I+RGVuaXMgRGlkZXJvdDwvYXV0
aG9yPgogICAgICAgIDxsYW5ndWFnZT5mcjwvbGFuZ3VhZ2U+CiAgICAgICAgPGxpbmsvPgogICAg
ICAgIDxyYXRpbmcvPgogICAgICAgIDxwdWJsaWNhdGlvbi15ZWFyLz4KICAgICAgICA8cmV2aWV3
Lz4KICAgICAgICA8aW1hZ2UgZmlsZW5hbWU9IiIgbWVkaWF0eXBlPSIiIHNpemU9IiIvPgogICAg
PC9kZXRhaWxzPgogICAgPG5vdGVzPgogICAgICAgIDxub3RlLz4KICAgIDwvbm90ZXM+CjwvYm9v<?orbeon-serializer flush?>
az4K</document>
        </output>
    </test>

    <test description="Submission replace=&#34;all&#34; upon initialization with redirect response" name="oxf:pipeline">
        <!-- See: http://forge.ow2.org/tracker/index.php?func=detail&aid=306918&group_id=168&atid=350207 -->
        <input name="config" href="wrap-xforms-state.xpl"/>
        <input name="document">
            <xh:html>
                <xh:head>
                    <xf:model id="model" xxf:optimize-get-all="true">
                        <xf:instance id="instance">
                            <instance/>
                        </xf:instance>
                        <xf:send ev:event="xforms-model-construct-done" submission="submission"/>
                        <xf:submission id="submission" serialization="none" method="get" action="http://www.google.com/"/>
                    </xf:model>
                </xh:head>
            </xh:html>
        </input>
        <output name="response">
            <xxf:event-response>
                <xxf:dynamic-state>
                    <dynamic-state/>
                </xxf:dynamic-state>
                <xxf:action>
                    <xxf:control-values/>
                    <xxf:load resource="http://www.google.com/" show="replace"/>
                </xxf:action>
            </xxf:event-response>
        </output>
    </test>

    <test description="#122: Submission: XPath context is incorrect for xforms-submit handler" name="oxf:pipeline">
        <!-- See: https://github.com/orbeon/orbeon-forms/issues/122 -->
        <input name="config" href="wrap-xforms-state.xpl"/>
        <input name="document">
            <xh:html>
                <xh:head>
                    <xf:model id="model">
                        <xf:instance id="instance1">
                            <value/>
                        </xf:instance>
                        <xf:instance id="instance2">
                            <value/>
                        </xf:instance>
                        <xf:send ev:event="xforms-model-construct-done" submission="submission"/>
                        <xf:submission ref="instance('instance2')" id="submission" method="post" action="echo:" replace="none">
                            <xf:setvalue ev:event="xforms-submit" ref="." value="42"/>
                        </xf:submission>
                    </xf:model>
                </xh:head>
            </xh:html>
        </input>
        <output name="response">
            <xxf:event-response>
                <xxf:dynamic-state>
                    <dynamic-state>
                        <instances>
                            <instance id="instance2" model-id="model">
                                <value>42</value>
                            </instance>
                        </instances>
                    </dynamic-state>
                </xxf:dynamic-state>
                <xxf:action>
                    <xxf:control-values/>
                </xxf:action>
            </xxf:event-response>
        </output>
    </test>

    <test description="JSON: application/json converts JSON to and from XML" name="oxf:pipeline">
        <input name="config" href="wrap-xforms-state.xpl"/>
        <input name="document">
            <xh:html>
                <xh:head>
                    <xf:model id="model">
                        <xf:instance id="json-source-instance">
                            <json>{"father": {"given": "Mark", "family": "Smith"}, "mother": {"given": "Mary", "family": "Smith"}}</json>
                        </xf:instance>
                        <xf:instance id="xml-result-instance">
                            <dummy/>
                        </xf:instance>
                        <xf:instance id="json-result-instance">
                            <json/>
                        </xf:instance>
                        <xf:submission
                            ref="instance('json-source-instance')"
                            id="send-json-submission"
                            serialization="text/plain"
                            mediatype="application/json"
                            method="post"
                            action="echo:"
                            replace="instance"
                            instance="xml-result-instance"/>
                        <xf:submission
                            ref="instance('xml-result-instance')"
                            id="send-xml-submission"
                            serialization="application/json"
                            method="post"
                            action="echo:"
                            replace="text"
                            targetref="instance('json-result-instance')"/>

                        <xf:send event="xforms-model-construct-done" submission="send-json-submission"/>
                        <xf:send event="xforms-model-construct-done" submission="send-xml-submission"/>
                    </xf:model>
                </xh:head>
            </xh:html>
        </input>
        <output name="response">
            <xxf:event-response>
                <xxf:dynamic-state>
                    <dynamic-state>
                        <instances>
                            <instance id="xml-result-instance" model-id="model">
                                <json type="object">
                                    <father type="object">
                                        <given>Mark</given>
                                        <family>Smith</family>
                                    </father>
                                    <mother type="object">
                                        <given>Mary</given>
                                        <family>Smith</family>
                                    </mother>
                                </json>
                            </instance>
                            <instance id="json-result-instance" model-id="model">
                                <json>{"father":{"given":"Mark","family":"Smith"},"mother":{"given":"Mary","family":"Smith"}}</json>
                            </instance>
                        </instances>
                    </dynamic-state>
                </xxf:dynamic-state>
                <xxf:action>
                    <xxf:control-values/>
                </xxf:action>
            </xxf:event-response>
        </output>
    </test>

    <test description="#1179 and #3065: Clear/annotate non-relevant data" name="oxf:pipeline">
        <input name="config" href="wrap-xforms-state.xpl"/>
        <input name="document">
            <xh:html>
                <xh:head>
                    <xf:model id="model">
                        <xf:instance id="instance">
                            <form>
                                <section-1>
                                    <control-1 xxf:relevant="foo">value1</control-1>
                                    <grid-3>
                                        <grid-3-iteration>
                                            <control-5>value5</control-5>
                                            <control-16 filename="control-16.pdf" mediatype="application/pdf" size="1">value16</control-16>
                                        </grid-3-iteration>
                                    </grid-3>
                                    <grid-6>
                                        <grid-6-iteration>
                                            <control-8>value8</control-8>
                                            <control-17 filename="control-17.png" mediatype="image/png" size="2">value17</control-17>
                                        </grid-6-iteration>
                                    </grid-6>
                                </section-1>
                                <section-9>
                                    <section-9-iteration>
                                        <control-10 xxf:relevant="false">value10</control-10>
                                    </section-9-iteration>
                                </section-9>
                                <section-11>
                                    <grid-12>
                                        <grid-12-iteration>
                                            extra.1
                                            <control-13>value13.1</control-13>
                                            <control-23 filename="control-23.pdf" mediatype="application/pdf" size="1"/>
                                        </grid-12-iteration>
                                        extra.2
                                        <grid-12-iteration>
                                            extra.3
                                            <control-13>value13.2</control-13>
                                            <control-23 filename="image-23.png" mediatype="image/png" size="2"/>
                                        </grid-12-iteration>
                                    </grid-12>
                                    <grid-14/>
                                </section-11>
                                <section-18>
                                    <grid-19>
                                        <grid-19-iteration foo="foo.1">grid19.1</grid-19-iteration>
                                        <grid-19-iteration foo="foo.2">grid19.2</grid-19-iteration>
                                    </grid-19>
                                    <grid-22>
                                        <grid-22-iteration foo="foo.1">grid22.1</grid-22-iteration>
                                        <grid-22-iteration foo="foo.2">grid22.2</grid-22-iteration>
                                    </grid-22>
                                </section-18>
                            </form>
                        </xf:instance>

                        <xf:bind ref="//section-11 | //control-5 | //grid-19//@foo" relevant="false"/>

                        <xf:instance id="blank-result-instance"><dummy/></xf:instance>
                        <xf:instance id="annotate-result-instance"><dummy/></xf:instance>
                        <xf:instance id="blank-annotate-result-instance"><dummy/></xf:instance>

                        <xf:submission
                            ref="instance('instance')"
                            id="send-blank-submission"
                            method="post"
                            action="echo:"
                            replace="instance"
                            instance="blank-result-instance"
                            nonrelevant="empty"
                            xxf:relevant-attribute="xxf:relevant"
                            />

                        <xf:submission
                            ref="instance('instance')"
                            id="send-annotate-submission"
                            method="post"
                            action="echo:"
                            replace="instance"
                            instance="annotate-result-instance"
                            nonrelevant="keep"
                            xxf:annotate="relevant"
                            xxf:relevant-attribute="xxf:relevant"
                            />

                        <xf:submission
                            ref="instance('instance')"
                            id="send-blank-annotate-submission"
                            method="post"
                            action="echo:"
                            replace="instance"
                            instance="blank-annotate-result-instance"
                            nonrelevant="empty"
                            xxf:annotate="relevant"
                            xxf:relevant-attribute="xxf:relevant"
                            />

                        <xf:send event="xforms-model-construct-done" submission="send-blank-submission"/>
                        <xf:send event="xforms-model-construct-done" submission="send-annotate-submission"/>
                        <xf:send event="xforms-model-construct-done" submission="send-blank-annotate-submission"/>
                    </xf:model>
                </xh:head>
            </xh:html>
        </input>
        <output name="response">
            <xxf:event-response>
                <xxf:dynamic-state>
                    <dynamic-state>
                        <instances>
                            <instance id="blank-result-instance" model-id="model">
                                <form>
                                    <section-1>
                                        <control-1>value1</control-1>
                                        <grid-3>
                                            <grid-3-iteration>
                                                <control-5/>
                                                <control-16 filename="control-16.pdf" mediatype="application/pdf" size="1">value16</control-16>
                                            </grid-3-iteration>
                                        </grid-3>
                                        <grid-6>
                                            <grid-6-iteration>
                                                <control-8>value8</control-8>
                                                <control-17 filename="control-17.png" mediatype="image/png" size="2">value17</control-17>
                                            </grid-6-iteration>
                                        </grid-6>
                                    </section-1>
                                    <section-9>
                                        <section-9-iteration>
                                            <control-10/>
                                        </section-9-iteration>
                                    </section-9>
                                    <section-11>
                                        <grid-12>
                                            <grid-12-iteration>extra.1
                                                <control-13/>
                                                <control-23 filename="" mediatype="" size=""/>
                                            </grid-12-iteration>
                                            extra.2
                                            <grid-12-iteration>extra.3
                                                <control-13/>
                                                <control-23 filename="" mediatype="" size=""/>
                                            </grid-12-iteration>
                                        </grid-12>
                                        <grid-14/>
                                    </section-11>
                                    <section-18>
                                        <grid-19>
                                            <grid-19-iteration foo="">grid19.1</grid-19-iteration>
                                            <grid-19-iteration foo="">grid19.2</grid-19-iteration>
                                        </grid-19>
                                        <grid-22>
                                            <grid-22-iteration foo="foo.1">grid22.1</grid-22-iteration>
                                            <grid-22-iteration foo="foo.2">grid22.2</grid-22-iteration>
                                        </grid-22>
                                    </section-18>
                                </form>
                            </instance>
                            <instance id="annotate-result-instance" model-id="model">
                                <form>
                                    <section-1>
                                        <control-1>value1</control-1>
                                        <grid-3>
                                            <grid-3-iteration>
                                                <control-5 xxf:relevant="false">value5</control-5>
                                                <control-16 filename="control-16.pdf" mediatype="application/pdf" size="1">value16</control-16>
                                            </grid-3-iteration>
                                        </grid-3>
                                        <grid-6>
                                            <grid-6-iteration>
                                                <control-8>value8</control-8>
                                                <control-17 filename="control-17.png" mediatype="image/png" size="2">value17</control-17>
                                            </grid-6-iteration>
                                        </grid-6>
                                    </section-1>
                                    <section-9>
                                        <section-9-iteration>
                                            <control-10 xxf:relevant="false">value10</control-10>
                                        </section-9-iteration>
                                    </section-9>
                                   <section-11 xxf:relevant="false">
                                       <grid-12>
                                           <grid-12-iteration>extra.1
                                               <control-13>value13.1</control-13>
                                               <control-23 filename="control-23.pdf" mediatype="application/pdf" size="1"/>
                                           </grid-12-iteration>extra.2
                                           <grid-12-iteration>extra.3
                                               <control-13>value13.2</control-13>
                                               <control-23 filename="image-23.png" mediatype="image/png" size="2"/>
                                           </grid-12-iteration>
                                       </grid-12>
                                       <grid-14/>
                                   </section-11>
                                    <section-18>
                                        <grid-19>
                                            <grid-19-iteration foo="foo.1">grid19.1</grid-19-iteration>
                                            <grid-19-iteration foo="foo.2">grid19.2</grid-19-iteration>
                                        </grid-19>
                                        <grid-22>
                                            <grid-22-iteration foo="foo.1">grid22.1</grid-22-iteration>
                                            <grid-22-iteration foo="foo.2">grid22.2</grid-22-iteration>
                                        </grid-22>
                                    </section-18>
                                </form>
                            </instance>
                            <instance id="blank-annotate-result-instance" model-id="model">
                                <form>
                                    <section-1>
                                        <control-1>value1</control-1>
                                        <grid-3>
                                            <grid-3-iteration>
                                                <control-5 xxf:relevant="false"/>
                                                <control-16 filename="control-16.pdf" mediatype="application/pdf" size="1">value16</control-16>
                                            </grid-3-iteration>
                                        </grid-3>
                                        <grid-6>
                                            <grid-6-iteration>
                                                <control-8>value8</control-8>
                                                <control-17 filename="control-17.png" mediatype="image/png" size="2">value17</control-17>
                                            </grid-6-iteration>
                                        </grid-6>
                                    </section-1>
                                    <section-9>
                                        <section-9-iteration>
                                            <control-10 xxf:relevant="false"/>
                                        </section-9-iteration>
                                    </section-9>
                                    <section-11 xxf:relevant="false">
                                        <grid-12>
                                            <grid-12-iteration>extra.1
                                                <control-13/>
                                                <control-23 filename="" mediatype="" size=""/>
                                            </grid-12-iteration>
                                            extra.2
                                            <grid-12-iteration>extra.3
                                                <control-13/>
                                                <control-23 filename="" mediatype="" size=""/>
                                            </grid-12-iteration>
                                        </grid-12>
                                        <grid-14/>
                                    </section-11>
                                    <section-18>
                                        <grid-19>
                                            <grid-19-iteration foo="">grid19.1</grid-19-iteration>
                                            <grid-19-iteration foo="">grid19.2</grid-19-iteration>
                                        </grid-19>
                                        <grid-22>
                                            <grid-22-iteration foo="foo.1">grid22.1</grid-22-iteration>
                                            <grid-22-iteration foo="foo.2">grid22.2</grid-22-iteration>
                                        </grid-22>
                                    </section-18>
                                </form>
                            </instance>
                        </instances>
                    </dynamic-state>
                </xxf:dynamic-state>
                <xxf:action>
                    <xxf:control-values/>
                </xxf:action>
            </xxf:event-response>
        </output>
    </test>

    <test description="#3860/#3829: prune non-relevant nodes" name="oxf:pipeline">
        <input name="config" href="wrap-xforms-state.xpl"/>
        <input name="document">
            <xh:html>
                <xh:head>
                    <xf:model id="model">
                        <xf:instance id="instance">
                            <search>
                                <query search-field="true" summary-field="false" match="substring" html-label="false"/>
                            </search>
                        </xf:instance>

                        <xf:bind ref="query/(@search-field | @summary-field)" relevant=". = 'true'"/>

                        <xf:instance id="result-instance"><dummy/></xf:instance>

                        <xf:submission
                            id="submission"
                            ref="instance()"
                            validate="false"
                            method="post"
                            resource="echo:"
                            replace="instance"
                            instance="result-instance"/>

                        <xf:send event="xforms-model-construct-done" submission="submission"/>

                        <xf:message event="xforms-submit-error">error</xf:message>
                        <xf:message event="xforms-submit-done">done</xf:message>
                    </xf:model>
                </xh:head>
            </xh:html>
        </input>
        <output name="response">
            <xxf:event-response>
                <xxf:dynamic-state>
                    <dynamic-state>
                        <instances>
                            <instance id="result-instance" model-id="model">
                                <search>
                                    <query search-field="true" match="substring" html-label="false"/>
                                </search>
                            </instance>
                        </instances>
                    </dynamic-state>
                </xxf:dynamic-state>
                <xxf:action>
                    <xxf:control-values/>
                    <xxf:message level="modal">done</xxf:message>
                </xxf:action>
            </xxf:event-response>
        </output>
    </test>

    <test description="#3945: xf:submission: support binary response" name="oxf:pipeline">
        <input name="config" href="wrap-xforms-state.xpl"/>
        <input name="document">
            <xh:html>
                <xh:head>
                    <xf:model id="model">

                        <xf:instance id="result-instance">
                            <file mediatype="" size=""/>
                        </xf:instance>

                        <xf:submission
                            id="submission"
                            method="get"
                            serialization="none"
                            resource="https://httpbin.org/image/png"
                            replace="xxf:binary"
                            targetref="instance('result-instance')"/>

                        <xf:send
                            event="xforms-model-construct-done"
                            submission="submission"/>

                        <xf:action event="xforms-submit-done">
                            <xf:setvalue ref="instance('result-instance')/@mediatype" value="uri-param-values(.., 'mediatype')[1]"/>
                            <xf:setvalue ref="instance('result-instance')/@size"      value="uri-param-values(.., 'size')[1]"/>
                            <!-- Remove temp URL as it changes every time -->
                            <xf:setvalue ref="instance('result-instance')"/>
                        </xf:action>
                    </xf:model>
                </xh:head>
            </xh:html>
        </input>
        <output name="response">
            <xxf:event-response>
                <xxf:dynamic-state>
                    <dynamic-state>
                        <instances>
                            <instance id="result-instance" model-id="model">
                                <file mediatype="image/png" size="8090"/>
                            </instance>
                        </instances>
                    </dynamic-state>
                </xxf:dynamic-state>
                <xxf:action>
                    <xxf:control-values/>
                </xxf:action>
            </xxf:event-response>
        </output>
    </test>

    <test description="Instance replacement: replace text error conditions" name="oxf:pipeline">
        <input name="config" href="wrap-xforms-state.xpl"/>
        <input name="document">
            <xh:html>
                <xh:head>
                    <xf:model id="model">

                        <xf:instance id="result-instance">
                            <_>
                                <result/>
                            </_>
                        </xf:instance>

                        <xf:send
                            event="xforms-model-construct-done"
                            submission="replace-instance-empty"/>
                        <xf:submission
                            id="replace-instance-empty"
                            method="get"
                            serialization="none"
                            resource="oxf:/org/orbeon/oxf/xforms/data/sample-instance.xml"
                            replace="text"
                            targetref="instance('this-instance-does-not-exist')/result"/>

                        <xf:send
                            event="xforms-model-construct-done"
                            submission="replace-instance-atomic"/>
                        <xf:submission
                            id="replace-instance-atomic"
                            method="get"
                            serialization="none"
                            resource="oxf:/org/orbeon/oxf/xforms/data/sample-instance.xml"
                            replace="text"
                            targetref="42"/>

                        <xf:send
                            event="xforms-model-construct-done"
                            submission="replace-instance-complex"/>
                        <xf:submission
                            id="replace-instance-complex"
                            method="get"
                            serialization="none"
                            resource="oxf:/org/orbeon/oxf/xforms/data/sample-instance.xml"
                            replace="text"
                            targetref="instance('result-instance')"/>

                        <!-- TEST: Events to gather -->
                        <xf:instance id="events">
                            <events/>
                        </xf:instance>
                        <xf:insert
                            event="xforms-submit-done xforms-submit-error"
                            context="instance('events')"
                            ref="*"
                            origin="
                                xf:element(
                                    'event',
                                    (
                                        xf:attribute('type', event('xxf:type')),
                                        xf:attribute('target', event('xxf:targetid')),
                                        for $c in event('error-type')
                                        return xf:attribute('error-type', $c)
                                    )
                                )"/>

                    </xf:model>
                </xh:head>
                <xh:body>

                </xh:body>
            </xh:html>
        </input>
        <output name="response">
            <xxf:event-response>
                <xxf:dynamic-state>
                    <dynamic-state>
                        <instances>
                            <instance id="events" model-id="model">
                                <events>
                                    <event type="xforms-submit-error" target="replace-instance-empty" error-type="target-error"/>
                                    <event type="xforms-submit-error" target="replace-instance-atomic" error-type="target-error"/>
                                    <event type="xforms-submit-error" target="replace-instance-complex" error-type="target-error"/>
                                </events>
                            </instance>
                        </instances>
                    </dynamic-state>
                </xxf:dynamic-state>
                <xxf:action>
                    <xxf:control-values/>
                </xxf:action>
            </xxf:event-response>
        </output>
    </test>

    <test description="Instance replacement: replace text to default instance" name="oxf:pipeline">
        <input name="config" href="wrap-xforms-state.xpl"/>
        <input name="document">
            <xh:html>
                <xh:head>
                    <xf:model id="model">

                        <xf:instance id="result-instance-default">
                            <_/>
                        </xf:instance>

                        <xf:instance id="result-instance-explicit">
                            <_/>
                        </xf:instance>

                        <xf:send
                            event="xforms-model-construct-done"
                            submission="replace-instance-default"/>
                        <xf:submission
                            id="replace-instance-default"
                            method="get"
                            serialization="none"
                            resource="oxf:/org/orbeon/oxf/xforms/data/sample-instance.xml"
                            replace="text"/>

                        <xf:send
                            event="xforms-model-construct-done"
                            submission="replace-instance-explicit"/>
                        <xf:submission
                            id="replace-instance-explicit"
                            method="get"
                            serialization="none"
                            resource="oxf:/org/orbeon/oxf/xforms/data/sample-instance.xml"
                            replace="text"
                            targetref="instance('result-instance-explicit')"/>

                        <!-- TEST: Events to gather -->
                        <xf:instance id="events">
                            <events/>
                        </xf:instance>
                        <xf:insert
                            event="xforms-submit-done xforms-submit-error"
                            context="instance('events')"
                            ref="*"
                            origin="
                                xf:element(
                                    'event',
                                    (
                                        xf:attribute('type', event('xxf:type')),
                                        xf:attribute('target', event('xxf:targetid')),
                                        for $c in event('error-type')
                                        return xf:attribute('error-type', $c)
                                    )
                                )"/>

                    </xf:model>
                </xh:head>
                <xh:body>

                </xh:body>
            </xh:html>
        </input>
        <output name="response">
            <xxf:event-response xmlns:xxf="http://orbeon.org/oxf/xml/xforms">
                <xxf:dynamic-state>
                    <dynamic-state>
                        <instances>
                            <instance id="result-instance-default" model-id="model">
                                <_>&lt;book&gt; &lt;title lang="en"&gt;Pale
                                    Blue Dot&lt;/title&gt; &lt;author&gt;Carl Sagan&lt;/author&gt; &lt;/book&gt;
                                </_>
                            </instance>
                            <instance id="result-instance-explicit" model-id="model">
                                <_>&lt;book&gt; &lt;title lang="en"&gt;Pale
                                    Blue Dot&lt;/title&gt; &lt;author&gt;Carl Sagan&lt;/author&gt; &lt;/book&gt;
                                </_>
                            </instance>
                            <instance id="events" model-id="model">
                                <events>
                                    <event type="xforms-submit-done" target="replace-instance-default"/>
                                    <event type="xforms-submit-done" target="replace-instance-explicit"/>
                                </events>
                            </instance>
                        </instances>
                    </dynamic-state>
                </xxf:dynamic-state>
                <xxf:action>
                    <xxf:control-values/>
                </xxf:action>
            </xxf:event-response>
        </output>
    </test>

    <test description="#4069: Ability to tunnel context information to submission events" name="oxf:pipeline">
        <input name="config" href="wrap-xforms-state.xpl"/>
        <input name="document">
            <xh:html>
                <xh:head>
                    <xf:model id="model" xxf:allow-error-recovery-on-init="true">

                        <xf:instance id="my-instance">
                            <_/>
                        </xf:instance>

                        <xf:send
                            event="xforms-model-construct-done"
                            iterate="'sample-instance.xml', 'i-dont-exist.xml'"

                            submission="my-submission">
                            <xf:property name="filename" value="."/>
                            <xf:property name="p1" value="42"/>
                            <xf:property name="p2" value="43"/>
                            <xf:property name="p3" value="44" xxf:tunnel="true"/>
                            <xf:property name="p4" value="45" xxf:tunnel="true"/>
                        </xf:send>

                        <xf:submission
                            id="my-submission"
                            method="get"
                            serialization="none"
                            resource="oxf:/org/orbeon/oxf/xforms/data/{event('filename')}"
                            replace="instance">

                            <!-- Also test action error within submission -->
                            <xf:action event="xforms-submit-done">
                                <xf:setvalue ref="title" value="1 div 0"/>
                            </xf:action>
                        </xf:submission>

                        <!-- Also test action error -->
                        <xf:dispatch
                            event="xforms-model-construct-done"

                            targetid="model"
                            name="my-action-event">
                            <xf:property name="p1" value="42"/>
                            <xf:property name="p2" value="43"/>
                            <xf:property name="p3" value="44" xxf:tunnel="true"/>
                            <xf:property name="p4" value="45" xxf:tunnel="true"/>
                        </xf:dispatch>

                        <xf:action event="my-action-event">
                            <xf:setvalue ref="title" value="1 div 0"/>
                        </xf:action>

                        <!-- TEST: Events to gather -->
                        <xf:instance id="events">
                            <events/>
                        </xf:instance>
                        <xf:insert
                            event="xforms-submit xforms-submit-done xforms-submit-error xxforms-action-error"
                            context="instance('events')"
                            ref="*"
                            origin="
                                xf:element(
                                    'event',
                                    (
                                        xf:attribute('type', event('xxf:type')),
                                        xf:attribute('target', event('xxf:targetid')),
                                        for $c in event('error-type')
                                        return xf:attribute('error-type', $c),
                                        for $i in 1 to 4,
                                            $p in concat('p', $i),
                                            $v in event($p)
                                        return
                                            xf:attribute($p, $v)
                                    )
                                )"/>

                    </xf:model>
                </xh:head>
                <xh:body/>
            </xh:html>
        </input>
        <output name="response">
            <xxf:event-response xmlns:xxf="http://orbeon.org/oxf/xml/xforms">
                <xxf:dynamic-state>
                    <dynamic-state>
                        <instances>
                            <instance id="my-instance" model-id="model">
                                <book>
                                    <title lang="en">Pale Blue Dot</title>
                                    <author>Carl Sagan</author>
                                </book>
                            </instance>
                            <instance id="events" model-id="model">
                                <events>
                                    <event type="xforms-submit"        target="my-submission" p1="42" p2="43" p3="44" p4="45"/>
                                    <event type="xxforms-action-error" target="my-submission" p3="44" p4="45"/>
                                    <event type="xforms-submit-done"   target="my-submission" p3="44" p4="45"/>
                                    <event type="xforms-submit"        target="my-submission" p1="42" p2="43" p3="44" p4="45"/>
                                    <event type="xforms-submit-error"  target="my-submission" error-type="xxforms-internal-error" p3="44" p4="45"/>
                                    <event type="xxforms-action-error" target="model" p3="44" p4="45"/>
                                </events>
                            </instance>
                        </instances>
                    </dynamic-state>
                </xxf:dynamic-state>
                <xxf:action>
                    <xxf:control-values/>
                </xxf:action>
            </xxf:event-response>
        </output>
    </test>

    <test description="Chained async submission awaiting response" name="oxf:pipeline" only="true">
        <input name="config" href="wrap-xforms-state.xpl"/>
        <input name="document">
            <xh:html>
                <xh:head>
                    <xf:model id="model" xxf:allow-error-recovery-on-init="true">

                        <xf:instance id="my-instance">
                            <_>
                                <result/>
                                <result/>
                            </_>
                        </xf:instance>

                        <xf:send
                            event="xforms-model-construct-done"

                            submission="my-submission">
                            <xf:property name="q" value="123"/>
                        </xf:send>

                        <xf:action
                            event="xforms-submit-done"
                            observer="my-submission">

                            <xf:setvalue
                                ref="instance()/result[xxf:is-blank()]"
                                value="xxf:json-to-xml(event('response-body'))//q"/>

                            <xf:send
                                if="exists(instance()/result[xxf:is-blank()])"
                                submission="my-submission">
                                <xf:property name="q" value="456"/>
                            </xf:send>
                        </xf:action>

                        <xf:submission
                            id="my-submission"
                            resource="https://httpbin.org/delay/2?q={event('q')}"
                            method="get"
                            serialization="none"
                            mode="asynchronous"
                            xxf:response-must-await="forever"
                            replace="none"/>

                    </xf:model>
                </xh:head>
                <xh:body/>
            </xh:html>
        </input>
        <output name="response">
            <xxf:event-response xmlns:xxf="http://orbeon.org/oxf/xml/xforms">
               <xxf:dynamic-state>
                   <dynamic-state>
                       <instances>
                           <instance id="my-instance" model-id="model">
                               <_>
                                   <result>123</result>
                                   <result>456</result>
                               </_>
                           </instance>
                       </instances>
                   </dynamic-state>
               </xxf:dynamic-state>
               <xxf:action>
                   <xxf:control-values/>
               </xxf:action>
           </xxf:event-response>
        </output>
    </test>

    <test description="Failing async submission dispatches error event" name="oxf:pipeline">
        <input name="config" href="wrap-xforms-state.xpl"/>
        <input name="document">
            <xh:html>
                <xh:head>
                    <xf:model id="model">

                        <xf:instance id="my-instance">
                            <_>
                                <result/>
                                <result/>
                            </_>
                        </xf:instance>

                        <xf:send
                            event="xforms-model-construct-done"

                            submission="my-submission">
                            <xf:property name="p1" value="42"/>
                            <xf:property name="p2" value="43"/>
                            <xf:property name="p3" value="44" xxf:tunnel="true"/>
                            <xf:property name="p4" value="45" xxf:tunnel="true"/>
                        </xf:send>

                        <xf:submission
                            id="my-submission"
                            resource="oxf:/org/orbeon/oxf/xforms/data/i-dont-exist.xml"
                            method="get"
                            serialization="none"
                            mode="asynchronous"
                            xxf:response-must-await="forever"
                            replace="none"/>

                        <!-- TEST: Events to gather -->
                        <xf:instance id="events">
                            <events/>
                        </xf:instance>
                        <xf:insert
                            event="xforms-submit xforms-submit-done xforms-submit-error xxforms-action-error"

                            context="instance('events')"
                            ref="*"
                            origin="
                                xf:element(
                                    'event',
                                    (
                                        xf:attribute('type', event('xxf:type')),
                                        xf:attribute('target', event('xxf:targetid')),
                                        for $c in event('error-type')
                                        return xf:attribute('error-type', $c),
                                        for $i in 1 to 4,
                                            $p in concat('p', $i),
                                            $v in event($p)
                                        return
                                            xf:attribute($p, $v)
                                    )
                                )"/>

                    </xf:model>
                </xh:head>
                <xh:body/>
            </xh:html>
        </input>
        <output name="response">
            <xxf:event-response xmlns:xxf="http://orbeon.org/oxf/xml/xforms">
               <xxf:dynamic-state>
                   <dynamic-state>
                       <instances>
                           <instance id="events" model-id="model">
                               <events>
                                   <event type="xforms-submit" target="my-submission" p1="42" p2="43" p3="44" p4="45"/>
                                   <event type="xforms-submit-error" target="my-submission" error-type="xxforms-internal-error" p3="44" p4="45"/>
                               </events>
                           </instance>
                       </instances>
                   </dynamic-state>
               </xxf:dynamic-state>
               <xxf:action>
                   <xxf:control-values/>
               </xxf:action>
           </xxf:event-response>
        </output>
    </test>
</group>
