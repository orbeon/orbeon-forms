<xh:html xmlns:xh="http://www.w3.org/1999/xhtml"
         xmlns:xxf="http://orbeon.org/oxf/xml/xforms"
         xmlns:xxi="http://orbeon.org/oxf/xml/xinclude"
         xmlns:fr="http://orbeon.org/oxf/xml/form-runner"
         xmlns:xf="http://www.w3.org/2002/xforms"
         xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xmlns:sql="http://orbeon.org/oxf/xml/sql"
         xmlns:ev="http://www.w3.org/2001/xml-events"
         xmlns:xi="http://www.w3.org/2001/XInclude"
         xmlns:exf="http://www.exforms.org/exf/1-0"
         xmlns:xs="http://www.w3.org/2001/XMLSchema"
         xmlns:fb="http://orbeon.org/oxf/xml/form-builder"
         xmlns:soap="http://schemas.xmlsoap.org/soap/envelope/">
    <xh:head>
        <xh:title>Itemsets and Actions</xh:title>
        <xf:model id="fr-form-model" xxf:expose-xpath-types="true"
                  xxf:encrypt-item-values="false">

            <!-- Main instance -->
            <xf:instance id="fr-form-instance" xxf:exclude-result-prefixes="#all" xxf:index="id">
                <form>
                    <general-section>
                        <global-button/>
                    </general-section>
                    <states-section>
                        <states-section-iteration>
                            <state/>
                            <city-zip-grid>
                                <city-zip-grid-iteration>
                                    <city/>
                                    <zip/>
                                </city-zip-grid-iteration>
                            </city-zip-grid>
                        </states-section-iteration>
                    </states-section>
                </form>
            </xf:instance>

            <!-- Bindings -->
            <xf:bind id="fr-form-binds" ref="instance('fr-form-instance')">
                <xf:bind id="general-section-bind" ref="general-section" name="general-section">
                    <xf:bind id="global-button-bind" ref="global-button" name="global-button"/>
                </xf:bind>
                <xf:bind id="states-section-bind" name="states-section" ref="states-section">
                    <xf:bind id="states-section-iteration-bind" ref="states-section-iteration"
                             name="states-section-iteration">
                        <xf:bind id="city-zip-grid-bind" ref="city-zip-grid" name="city-zip-grid">
                            <xf:bind id="city-zip-grid-iteration-bind" ref="city-zip-grid-iteration"
                                     name="city-zip-grid-iteration">
                                <xf:bind id="city-bind" ref="city" name="city"/>
                                <xf:bind id="zip-bind" ref="zip" name="zip"/>
                            </xf:bind>
                        </xf:bind>
                        <xf:bind id="state-bind" ref="state" name="state"/>
                    </xf:bind>
                </xf:bind>
            </xf:bind>

            <!-- Metadata -->
            <xf:instance xxf:readonly="true" id="fr-form-metadata" xxf:exclude-result-prefixes="#all">
                <metadata>
                    <application-name>tests</application-name>
                    <form-name>itemset-action</form-name>
                    <title xml:lang="en">Itemsets and Actions</title>
                    <description xml:lang="en"/>
                    <title xml:lang="fr">Actions et itemsets</title>
                    <description xml:lang="fr"/>
                </metadata>
            </xf:instance>

            <!-- Attachments -->
            <xf:instance id="fr-form-attachments" xxf:exclude-result-prefixes="#all">
                <attachments>
                    <css mediatype="text/css" filename="" size=""/>
                    <pdf mediatype="application/pdf" filename="" size=""/>
                </attachments>
            </xf:instance>

            <!-- All form resources -->
            <xf:instance xxf:readonly="true" id="fr-form-resources" xxf:exclude-result-prefixes="#all">
                <resources>
                    <resource xml:lang="en">
                        <global-button>
                            <label>Remplir valeurs globales</label>
                            <hint/>
                        </global-button>
                        <state>
                            <label>Etat</label>
                            <hint/>
                            <item>
                                <label>First choice</label>
                                <value>1</value>
                            </item>
                            <item>
                                <label>Second choice</label>
                                <value>2</value>
                            </item>
                            <item>
                                <label>Third choice</label>
                                <value>3</value>
                            </item>
                        </state>
                        <city>
                            <label>Ville</label>
                            <hint/>
                        </city>
                        <zip>
                            <label>Code postal (zip)</label>
                            <hint/>
                        </zip>
                        <states-section>
                            <label>Etats</label>
                        </states-section>
                        <general-section>
                            <label>Général</label>
                            <help/>
                        </general-section>
                    </resource>
                    <resource xml:lang="fr">
                        <global-button>
                            <label>Remplir valeurs globales</label>
                            <hint/>
                        </global-button>
                        <state>
                            <label>Etat</label>
                            <hint/>
                            <item>
                                <label>First choice</label>
                                <value>1</value>
                            </item>
                            <item>
                                <label>Second choice</label>
                                <value>2</value>
                            </item>
                            <item>
                                <label>Third choice</label>
                                <value>3</value>
                            </item>
                        </state>
                        <city>
                            <label>Ville</label>
                            <hint/>
                        </city>
                        <zip>
                            <label>Code postal (zip)</label>
                            <hint/>
                        </zip>
                        <states-section>
                            <label>Etats</label>
                        </states-section>
                        <general-section>
                            <label>Général</label>
                            <help/>
                        </general-section>
                    </resource>
                </resources>
            </xf:instance>
            <xf:instance xxf:readonly="true" xxf:exclude-result-prefixes="#all"
                         id="city-zip-grid-template">
                <city-zip-grid-iteration>
                    <city/>
                    <zip/>
                </city-zip-grid-iteration>
            </xf:instance>
            <xf:instance id="load-states-instance" class="fr-service" xxf:exclude-result-prefixes="#all">
                <body xmlns:fbf="java:org.orbeon.oxf.fb.FormBuilderXPathApi"
                      xmlns:secure="java:org.orbeon.oxf.util.SecureUtils"
                      xmlns:p="http://www.orbeon.com/oxf/pipeline"
                      xmlns:frf="java:org.orbeon.oxf.fr.FormRunner">&lt;params/&gt;</body>
            </xf:instance>
            <xf:submission id="load-states-submission" class="fr-service"
                           ref="instance('fr-service-request-instance')"
                           resource="/fr/service/custom/orbeon/zip-states"
                           method="get"
                           serialization="none"
                           mediatype="none"
                           replace="instance"
                           instance="fr-service-response-instance"/>
            <xf:instance id="load-cities-instance" class="fr-service" xxf:exclude-result-prefixes="#all">
                <body>&lt;params&gt;
    &lt;state-abbreviation/&gt;
    &lt;max&gt;20&lt;/max&gt;
&lt;/params&gt;</body>
            </xf:instance>
            <xf:submission id="load-cities-submission" class="fr-service"
                           ref="instance('fr-service-request-instance')"
                           resource="/fr/service/custom/orbeon/zip-cities"
                           method="get"
                           serialization="application/x-www-form-urlencoded"
                           mediatype="application/x-www-form-urlencoded"
                           replace="instance"
                           instance="fr-service-response-instance"/>

            <xf:instance id="load-zips-instance" class="fr-service" xxf:exclude-result-prefixes="#all">
                <body xmlns:fbf="java:org.orbeon.oxf.fb.FormBuilderXPathApi"
                      xmlns:secure="java:org.orbeon.oxf.util.SecureUtils"
                      xmlns:p="http://www.orbeon.com/oxf/pipeline"
                      xmlns:frf="java:org.orbeon.oxf.fr.FormRunner">&lt;params&gt;
    &lt;state-abbreviation/&gt;
    &lt;city/&gt;
    &lt;max&gt;20&lt;/max&gt;
&lt;/params&gt;</body>
            </xf:instance>
            <xf:instance xxf:readonly="true" xxf:exclude-result-prefixes="#all"
                         id="states-section-template">
                <states-section-iteration>
                    <city-zip-grid>
                        <city-zip-grid-iteration>
                            <city/>
                            <zip/>
                        </city-zip-grid-iteration>
                    </city-zip-grid>
                    <state/>
                </states-section-iteration>
            </xf:instance>
            <xf:submission id="load-zips-submission" class="fr-service"
                           ref="instance('fr-service-request-instance')"
                           resource="/fr/service/custom/orbeon/zip-zips"
                           method="get"
                           serialization="application/x-www-form-urlencoded"
                           mediatype="application/x-www-form-urlencoded"
                           replace="instance"
                           instance="fr-service-response-instance"/>
            <xf:action id="load-cities-binding">
                <!-- React to event... on control... -->
                <xf:action event="xforms-value-changed" ev:observer="state-control" if="true()">
                    <!-- Service to call -->
                    <xf:send submission="load-cities-submission"/>
                </xf:action>
                <!-- Request actions -->
                <xf:action event="xforms-submit" ev:observer="load-cities-submission">
                    <!-- Get reference to initial request -->
                    <xf:var name="request-instance-name" value="'load-cities-instance'" as="xs:string"/>
                    <!-- Copy over to read-write request instance -->
                    <xf:insert ref="instance('fr-service-request-instance')"
                               origin="xf:parse(instance($request-instance-name))"/>
                    <!--<xf:insert ref="instance('fr-service-request-instance')" origin="instance($request-instance-name)"/>-->
                    <!-- Set values if needed -->
                    <xf:action context="instance('fr-service-request-instance')">
                        <xf:action class="fr-set-service-value-action">
                            <xf:var name="control-name" value="'state'"/>
                            <xf:var name="path" value="/*/state-abbreviation"/>
                        </xf:action>
                        <!-- Setvalue actions will be here -->
                    </xf:action>
                </xf:action>
                <!-- Response actions -->
                <xf:action event="xforms-submit-done" ev:observer="load-cities-submission"
                           context="instance('fr-service-response-instance')">
                    <xf:action class="fr-itemset-action">
                        <xf:var name="control-name" value="'city'"/>
                        <xf:var name="response-items" value="/cities/city"/>
                        <xf:var name="item-label" value="@name"/>
                        <xf:var name="item-value" value="@name"/>
                    </xf:action>
                    <!-- Response actions will be here -->
                </xf:action>
            </xf:action>
            <xf:action id="load-zips-binding">
                <!-- React to event... on control... -->
                <xf:action event="xforms-value-changed" ev:observer="city-control" if="true()">
                    <!-- Service to call -->
                    <xf:send submission="load-zips-submission"/>
                </xf:action>
                <!-- Request actions -->
                <xf:action event="xforms-submit" ev:observer="load-zips-submission">
                    <!-- Get reference to initial request -->
                    <xf:var name="request-instance-name" value="'load-zips-instance'" as="xs:string"/>
                    <!-- Copy over to read-write request instance -->
                    <xf:insert ref="instance('fr-service-request-instance')"
                               origin="xf:parse(instance($request-instance-name))"/>
                    <!--<xf:insert ref="instance('fr-service-request-instance')" origin="instance($request-instance-name)"/>-->
                    <!-- Set values if needed -->
                    <xf:action context="instance('fr-service-request-instance')">
                        <xf:action class="fr-set-service-value-action">
                            <xf:var name="control-name" value="'state'"/>
                            <xf:var name="path" value="/*/state-abbreviation"/>
                        </xf:action>
                        <xf:action class="fr-set-service-value-action">
                            <xf:var name="control-name" value="'city'"/>
                            <xf:var name="path" value="/*/city"/>
                        </xf:action>
                        <!-- Setvalue actions will be here -->
                    </xf:action>
                </xf:action>
                <!-- Response actions -->
                <xf:action event="xforms-submit-done" ev:observer="load-zips-submission"
                           context="instance('fr-service-response-instance')">
                    <xf:action class="fr-itemset-action">
                        <xf:var name="control-name" value="'zip'"/>
                        <xf:var name="response-items" value="/zips/zip"/>
                        <xf:var name="item-label" value="@code"/>
                        <xf:var name="item-value" value="@code"/>
                    </xf:action>
                    <!-- Response actions will be here -->
                </xf:action>
            </xf:action>
            <xf:action id="load-states-binding">
                <!-- React to event... on control... -->
                <xf:action event="xforms-ready" ev:observer="fr-form-model" if="true()">
                    <!-- Service to call -->
                    <xf:send submission="load-states-submission"/>
                </xf:action>
                <!-- Request actions -->
                <xf:action event="xforms-submit" ev:observer="load-states-submission">
                    <!-- Get reference to initial request -->
                    <xf:var name="request-instance-name" value="'load-states-instance'" as="xs:string"/>
                    <!-- Copy over to read-write request instance -->
                    <xf:insert ref="instance('fr-service-request-instance')"
                               origin="xf:parse(instance($request-instance-name))"/>
                    <!--<xf:insert ref="instance('fr-service-request-instance')" origin="instance($request-instance-name)"/>-->
                    <!-- Set values if needed -->
                    <xf:action context="instance('fr-service-request-instance')">
                        <!-- Setvalue actions will be here -->
                    </xf:action>
                </xf:action>
                <!-- Response actions -->
                <xf:action event="xforms-submit-done" ev:observer="load-states-submission"
                           context="instance('fr-service-response-instance')">
                    <xf:action class="fr-itemset-action">
                        <xf:var name="control-name" value="'state'"/>
                        <xf:var name="response-items" value="/states/state"/>
                        <xf:var name="item-label" value="if ($fr-lang = 'fr') then @name-fr else @name"/>
                        <xf:var name="item-value" value="@abbreviation"/>
                    </xf:action>
                    <!-- Response actions will be here -->
                </xf:action>
            </xf:action>
        </xf:model>
    </xh:head>
    <xh:body>
        <fr:view>
            <fr:body xmlns:xbl="http://www.w3.org/ns/xbl" xmlns:p="http://www.orbeon.com/oxf/pipeline"
                     xmlns:oxf="http://www.orbeon.com/oxf/processors">
                <fr:section id="general-section-control" bind="general-section-bind">
                    <xf:label ref="$form-resources/general-section/label"/>
                    <fr:grid>
                        <xh:tr>
                            <xh:td>
                                <xf:trigger id="global-button-control" bind="global-button-bind">
                                    <xf:label ref="$form-resources/global-button/label"/>
                                    <xf:hint ref="$form-resources/global-button/hint"/>
                                    <xf:alert ref="$fr-resources/detail/labels/alert"/>
                                </xf:trigger>
                            </xh:td>
                            <xh:td/>
                        </xh:tr>
                    </fr:grid>
                </fr:section>
                <fr:section id="states-section-control" bind="states-section-bind" repeat="content" min="1"
                            template="instance('states-section-template')"
                            apply-defaults="true"
                            fb:initial-iterations="first">
                    <xf:label ref="$form-resources/states-section/label"/>
                    <fr:grid>
                        <xh:tr>
                            <xh:td>
                                <xf:select1 id="state-control" bind="state-bind" appearance="dropdown">
                                    <xf:label ref="$form-resources/state/label"/>
                                    <xf:hint ref="$form-resources/state/hint"/>
                                    <xf:alert ref="$fr-resources/detail/labels/alert"/>
                                    <xf:itemset ref="$form-resources/state/item">
                                        <xf:label ref="label"/>
                                        <xf:value ref="value"/>
                                    </xf:itemset>
                                </xf:select1>
                            </xh:td>
                            <xh:td/>
                        </xh:tr>
                    </fr:grid>
                    <fr:grid id="city-zip-grid-control" bind="city-zip-grid-bind" repeat="content" min="1"
                             template="instance('city-zip-grid-template')"
                             apply-defaults="true"
                             fb:initial-iterations="first">
                        <xh:tr>
                            <xh:td>
                                <xf:select1 id="city-control" bind="city-bind" appearance="dropdown">
                                    <xf:label ref="$form-resources/city/label"/>
                                    <xf:hint ref="$form-resources/city/hint"/>
                                    <xf:alert ref="$fr-resources/detail/labels/alert"/>
                                    <xf:itemset ref="$form-resources/city/item">
                                        <xf:label ref="label"/>
                                        <xf:value ref="value"/>
                                    </xf:itemset>
                                </xf:select1>
                            </xh:td>
                            <xh:td>
                                <xf:select1 id="zip-control" bind="zip-bind" appearance="dropdown">
                                    <xf:label ref="$form-resources/zip/label"/>
                                    <xf:hint ref="$form-resources/zip/hint"/>
                                    <xf:alert ref="$fr-resources/detail/labels/alert"/>
                                    <xf:itemset ref="$form-resources/zip/item">
                                        <xf:label ref="label"/>
                                        <xf:value ref="value"/>
                                    </xf:itemset>
                                </xf:select1>
                            </xh:td>
                        </xh:tr>
                    </fr:grid>
                </fr:section>
            </fr:body>
        </fr:view>
    </xh:body>
</xh:html>