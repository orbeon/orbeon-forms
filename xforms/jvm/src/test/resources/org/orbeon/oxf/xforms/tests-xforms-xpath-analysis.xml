<!--
  Copyright (C) 2010 Orbeon, Inc.

  This program is free software; you can redistribute it and/or modify it under the terms of the
  GNU Lesser General Public License as published by the Free Software Foundation; either version
  2.1 of the License, or (at your option) any later version.

  This program is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY;
  without even the implied warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.
  See the GNU Lesser General Public License for more details.

  The full text of the license is available at http://www.gnu.org/copyleft/lesser.html
  -->
<group
    xmlns:p="http://www.orbeon.com/oxf/pipeline"
    xmlns:xsl="http://www.w3.org/1999/XSL/Transform"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xmlns:xs="http://www.w3.org/2001/XMLSchema"
    xmlns:xh="http://www.w3.org/1999/xhtml"
    xmlns:oxf="http://www.orbeon.com/oxf/processors"
    xmlns:xf="http://www.w3.org/2002/xforms"
    xmlns:ev="http://www.w3.org/2001/xml-events"
    xmlns:xbl="http://www.w3.org/ns/xbl"
    xmlns:fr="http://orbeon.org/oxf/xml/form-runner"
    xmlns:xxf="http://orbeon.org/oxf/xml/xforms"

    description="XForms XPath Analysis"
    edition="pe">

    <test description="Simple xf:bind dependencies" name="oxf:xforms-xpath-analysis">
        <input name="form">
            <xh:html>
                <xh:head>
                    <xf:model id="model" xxf:xpath-analysis="true">
                        <xf:instance id="i1">
                            <instance/>
                        </xf:instance>
                        <xf:instance id="i2">
                            <instance/>
                        </xf:instance>
                        <xf:instance id="i3">
                            <instance/>
                        </xf:instance>
                        <xf:instance id="i4">
                            <instance/>
                        </xf:instance>
                        <xf:instance id="i5">
                            <instance/>
                        </xf:instance>
                        <xf:instance id="i6">
                            <instance/>
                        </xf:instance>
                        <xf:instance id="i7">
                            <instance/>
                        </xf:instance>

                        <xf:bind ref="instance('i1')" id="bv1" type="xs:integer"/>
                        <xf:bind ref="instance('i2')" id="bv2" constraint="true()"/>
                        <xf:bind ref="instance('i3')" id="bv3" required="true()"/>

                        <xf:bind ref="instance('i4')" id="bc1" relevant="false()"/>
                        <xf:bind ref="instance('i5')" id="bc2" calculate="42"/>
                        <xf:bind ref="instance('i6')" id="bc3" readonly="true()"/>
                        <xf:bind ref="instance('i7')" id="bc4" xxf:default="42"/>

                    </xf:model>
                </xh:head>
            </xh:html>
        </input>
        <output name="analysis">
            <root scope="" prefixed-id="#document" model-prefixed-id="model" binding="false" value="false">
                <model scope="" prefixed-id="model" default-instance-prefixed-id="i1" analyzed-binds="true">
                    <instance scope="" prefixed-id="i1" model-prefixed-id="model" binding="false" value="false"/>
                    <instance scope="" prefixed-id="i2" model-prefixed-id="model" binding="false" value="false"/>
                    <instance scope="" prefixed-id="i3" model-prefixed-id="model" binding="false" value="false"/>
                    <instance scope="" prefixed-id="i4" model-prefixed-id="model" binding="false" value="false"/>
                    <instance scope="" prefixed-id="i5" model-prefixed-id="model" binding="false" value="false"/>
                    <instance scope="" prefixed-id="i6" model-prefixed-id="model" binding="false" value="false"/>
                    <instance scope="" prefixed-id="i7" model-prefixed-id="model" binding="false" value="false"/>
                    <binds>
                        <bind id="bv1" ref="instance('i1')">
                            <binding>
                                <analysis expression="instance('i1')" analyzed="true">
                                    <returnable>
                                        <path>instance('i1')</path>
                                    </returnable>
                                    <dependent-models>
                                        <model>model</model>
                                    </dependent-models>
                                    <dependent-instances>
                                        <instance>i1</instance>
                                    </dependent-instances>
                                    <returnable-instances>
                                        <instance>i1</instance>
                                    </returnable-instances>
                                </analysis>
                            </binding>
                            <value>
                                <analysis expression="string((.)[1])" analyzed="true">
                                    <value-dependent>
                                        <path>instance('i1')</path>
                                    </value-dependent>
                                    <dependent-models>
                                        <model>model</model>
                                    </dependent-models>
                                    <dependent-instances>
                                        <instance>i1</instance>
                                    </dependent-instances>
                                </analysis>
                            </value>
                        </bind>
                        <bind id="bv2" ref="instance('i2')">
                            <binding>
                                <analysis expression="instance('i2')" analyzed="true">
                                    <returnable>
                                        <path>instance('i2')</path>
                                    </returnable>
                                    <dependent-models>
                                        <model>model</model>
                                    </dependent-models>
                                    <dependent-instances>
                                        <instance>i2</instance>
                                    </dependent-instances>
                                    <returnable-instances>
                                        <instance>i2</instance>
                                    </returnable-instances>
                                </analysis>
                            </binding>
                            <mip name="constraint" expression="boolean(true())">
                                <analysis expression="boolean(true())" analyzed="true"/>
                            </mip>
                        </bind>
                        <bind id="bv3" ref="instance('i3')">
                            <binding>
                                <analysis expression="instance('i3')" analyzed="true">
                                    <returnable>
                                        <path>instance('i3')</path>
                                    </returnable>
                                    <dependent-models>
                                        <model>model</model>
                                    </dependent-models>
                                    <dependent-instances>
                                        <instance>i3</instance>
                                    </dependent-instances>
                                    <returnable-instances>
                                        <instance>i3</instance>
                                    </returnable-instances>
                                </analysis>
                            </binding>
                            <mip name="required" expression="boolean(true())">
                                <analysis expression="boolean(true())" analyzed="true"/>
                            </mip>
                        </bind>
                        <bind id="bc1" ref="instance('i4')">
                            <binding>
                                <analysis expression="instance('i4')" analyzed="true">
                                    <returnable>
                                        <path>instance('i4')</path>
                                    </returnable>
                                    <dependent-models>
                                        <model>model</model>
                                    </dependent-models>
                                    <dependent-instances>
                                        <instance>i4</instance>
                                    </dependent-instances>
                                    <returnable-instances>
                                        <instance>i4</instance>
                                    </returnable-instances>
                                </analysis>
                            </binding>
                            <mip name="relevant" expression="boolean(false())">
                                <analysis expression="boolean(false())" analyzed="true"/>
                            </mip>
                        </bind>
                        <bind id="bc2" ref="instance('i5')">
                            <binding>
                                <analysis expression="instance('i5')" analyzed="true">
                                    <returnable>
                                        <path>instance('i5')</path>
                                    </returnable>
                                    <dependent-models>
                                        <model>model</model>
                                    </dependent-models>
                                    <dependent-instances>
                                        <instance>i5</instance>
                                    </dependent-instances>
                                    <returnable-instances>
                                        <instance>i5</instance>
                                    </returnable-instances>
                                </analysis>
                            </binding>
                            <mip name="calculate" expression="string((42)[1])">
                                <analysis expression="string((42)[1])" analyzed="true"/>
                            </mip>
                        </bind>
                        <bind id="bc3" ref="instance('i6')">
                            <binding>
                                <analysis expression="instance('i6')" analyzed="true">
                                    <returnable>
                                        <path>instance('i6')</path>
                                    </returnable>
                                    <dependent-models>
                                        <model>model</model>
                                    </dependent-models>
                                    <dependent-instances>
                                        <instance>i6</instance>
                                    </dependent-instances>
                                    <returnable-instances>
                                        <instance>i6</instance>
                                    </returnable-instances>
                                </analysis>
                            </binding>
                            <mip name="readonly" expression="boolean(true())">
                                <analysis expression="boolean(true())" analyzed="true"/>
                            </mip>
                        </bind>
                        <bind id="bc4" ref="instance('i7')">
                            <binding>
                                <analysis expression="instance('i7')" analyzed="true">
                                    <returnable>
                                        <path>instance('i7')</path>
                                    </returnable>
                                    <dependent-models>
                                        <model>model</model>
                                    </dependent-models>
                                    <dependent-instances>
                                        <instance>i7</instance>
                                    </dependent-instances>
                                    <returnable-instances>
                                        <instance>i7</instance>
                                    </returnable-instances>
                                </analysis>
                            </binding>
                            <mip name="default" expression="string((42)[1])">
                                <analysis expression="string((42)[1])" analyzed="true"/>
                            </mip>
                        </bind>
                    </binds>
                    <bind-instances>
                        <instance>i1</instance>
                        <instance>i2</instance>
                        <instance>i3</instance>
                        <instance>i4</instance>
                        <instance>i5</instance>
                        <instance>i6</instance>
                        <instance>i7</instance>
                    </bind-instances>
                    <computed-binds-instances>
                        <instance>i3</instance>
                        <instance>i4</instance>
                        <instance>i5</instance>
                        <instance>i6</instance>
                        <instance>i7</instance>
                    </computed-binds-instances>
                    <validation-binds-instances>
                        <instance>i1</instance>
                        <instance>i2</instance>
                        <instance>i3</instance>
                    </validation-binds-instances>
                </model>
            </root>
        </output>
    </test>

    <test description="MIP xf:bind dependencies" name="oxf:xforms-xpath-analysis">
        <input name="form">
            <xh:html>
                <xh:head>
                    <xf:model id="model" xxf:xpath-analysis="true">
                        <xf:instance id="i1">
                            <instance>
                                <a/>
                                <b/>
                                <c/>
                            </instance>
                        </xf:instance>

                        <xf:instance id="i2">
                            <instance>
                                <a/>
                                <b/>
                                <c/>
                            </instance>
                        </xf:instance>

                        <xf:bind id="b1" ref="instance('i1')">
                            <xf:bind id="b11" ref="a" constraint="../b = 'x'"/>
                            <xf:bind id="b12" ref="b" readonly="instance('i2')/a"/>
                            <xf:bind id="b13" ref="instance()/c" required=". = 'y'"/>
                            <xf:bind id="b14" context="a"/>
                        </xf:bind>
                        <xf:bind id="b2" ref="instance('i2')">
                            <xf:bind id="b21" ref="a" calculate="concat(../b, ../c)"/>
                            <xf:bind id="b22" ref="b" xxf:default="concat(../a, ../c)"/>
                        </xf:bind>

                    </xf:model>
                </xh:head>
            </xh:html>
        </input>
        <output name="analysis">
            <root scope="" prefixed-id="#document" model-prefixed-id="model" binding="false" value="false">
                <model scope="" prefixed-id="model" default-instance-prefixed-id="i1" analyzed-binds="true">
                    <instance scope="" prefixed-id="i1" model-prefixed-id="model" binding="false" value="false"/>
                    <instance scope="" prefixed-id="i2" model-prefixed-id="model" binding="false" value="false"/>
                    <binds>
                        <bind id="b1" ref="instance('i1')">
                            <binding>
                                <analysis expression="instance('i1')" analyzed="true">
                                    <returnable>
                                        <path>instance('i1')</path>
                                    </returnable>
                                    <dependent-models>
                                        <model>model</model>
                                    </dependent-models>
                                    <dependent-instances>
                                        <instance>i1</instance>
                                    </dependent-instances>
                                    <returnable-instances>
                                        <instance>i1</instance>
                                    </returnable-instances>
                                </analysis>
                            </binding>
                            <bind id="b11" ref="a">
                                <binding>
                                    <analysis expression="a" analyzed="true">
                                        <returnable>
                                            <path>instance('i1')/a</path>
                                        </returnable>
                                        <dependent-models>
                                            <model>model</model>
                                        </dependent-models>
                                        <dependent-instances>
                                            <instance>i1</instance>
                                        </dependent-instances>
                                        <returnable-instances>
                                            <instance>i1</instance>
                                        </returnable-instances>
                                    </analysis>
                                </binding>
                                <mip name="constraint" expression="boolean(../b = 'x')">
                                    <analysis expression="boolean(../b = 'x')" analyzed="true">
                                        <value-dependent>
                                            <path>instance('i1')/b</path>
                                        </value-dependent>
                                        <dependent-models>
                                            <model>model</model>
                                        </dependent-models>
                                        <dependent-instances>
                                            <instance>i1</instance>
                                        </dependent-instances>
                                    </analysis>
                                </mip>
                            </bind>
                            <bind id="b12" ref="b">
                                <binding>
                                    <analysis expression="b" analyzed="true">
                                        <returnable>
                                            <path>instance('i1')/b</path>
                                        </returnable>
                                        <dependent-models>
                                            <model>model</model>
                                        </dependent-models>
                                        <dependent-instances>
                                            <instance>i1</instance>
                                        </dependent-instances>
                                        <returnable-instances>
                                            <instance>i1</instance>
                                        </returnable-instances>
                                    </analysis>
                                </binding>
                                <mip name="readonly" expression="boolean(instance('i2')/a)">
                                    <analysis expression="boolean(instance('i2')/a)" analyzed="true">
                                        <dependent-models>
                                            <model>model</model>
                                        </dependent-models>
                                        <dependent-instances>
                                            <instance>i2</instance>
                                        </dependent-instances>
                                    </analysis>
                                </mip>
                            </bind>
                            <bind id="b13" ref="instance()/c">
                                <binding>
                                    <analysis expression="instance()/c" analyzed="true">
                                        <returnable>
                                            <path>instance('i1')/c</path>
                                        </returnable>
                                        <dependent-models>
                                            <model>model</model>
                                        </dependent-models>
                                        <dependent-instances>
                                            <instance>i1</instance>
                                        </dependent-instances>
                                        <returnable-instances>
                                            <instance>i1</instance>
                                        </returnable-instances>
                                    </analysis>
                                </binding>
                                <mip name="required" expression="boolean(. = 'y')">
                                    <analysis expression="boolean(. = 'y')" analyzed="true">
                                        <value-dependent>
                                            <path>instance('i1')/c</path>
                                        </value-dependent>
                                        <dependent-models>
                                            <model>model</model>
                                        </dependent-models>
                                        <dependent-instances>
                                            <instance>i1</instance>
                                        </dependent-instances>
                                    </analysis>
                                </mip>
                            </bind>
                            <bind id="b14" context="a"/>
                        </bind>
                        <bind id="b2" ref="instance('i2')">
                            <binding>
                                <analysis expression="instance('i2')" analyzed="true">
                                    <returnable>
                                        <path>instance('i2')</path>
                                    </returnable>
                                    <dependent-models>
                                        <model>model</model>
                                    </dependent-models>
                                    <dependent-instances>
                                        <instance>i2</instance>
                                    </dependent-instances>
                                    <returnable-instances>
                                        <instance>i2</instance>
                                    </returnable-instances>
                                </analysis>
                            </binding>
                            <bind id="b21" ref="a">
                                <binding>
                                    <analysis expression="a" analyzed="true">
                                        <returnable>
                                            <path>instance('i2')/a</path>
                                        </returnable>
                                        <dependent-models>
                                            <model>model</model>
                                        </dependent-models>
                                        <dependent-instances>
                                            <instance>i2</instance>
                                        </dependent-instances>
                                        <returnable-instances>
                                            <instance>i2</instance>
                                        </returnable-instances>
                                    </analysis>
                                </binding>
                                <mip name="calculate" expression="string((concat(../b, ../c))[1])">
                                    <analysis expression="string((concat(../b, ../c))[1])" analyzed="true">
                                        <value-dependent>
                                            <path>instance('i2')/b</path>
                                            <path>instance('i2')/c</path>
                                        </value-dependent>
                                        <dependent-models>
                                            <model>model</model>
                                        </dependent-models>
                                        <dependent-instances>
                                            <instance>i2</instance>
                                        </dependent-instances>
                                    </analysis>
                                </mip>
                            </bind>
                            <bind id="b22" ref="b">
                                <binding>
                                    <analysis expression="b" analyzed="true">
                                        <returnable>
                                            <path>instance('i2')/b</path>
                                        </returnable>
                                        <dependent-models>
                                            <model>model</model>
                                        </dependent-models>
                                        <dependent-instances>
                                            <instance>i2</instance>
                                        </dependent-instances>
                                        <returnable-instances>
                                            <instance>i2</instance>
                                        </returnable-instances>
                                    </analysis>
                                </binding>
                                <mip name="default" expression="string((concat(../a, ../c))[1])">
                                    <analysis expression="string((concat(../a, ../c))[1])" analyzed="true">
                                        <value-dependent>
                                            <path>instance('i2')/a</path>
                                            <path>instance('i2')/c</path>
                                        </value-dependent>
                                        <dependent-models>
                                            <model>model</model>
                                        </dependent-models>
                                        <dependent-instances>
                                            <instance>i2</instance>
                                        </dependent-instances>
                                    </analysis>
                                </mip>
                            </bind>
                        </bind>
                    </binds>
                    <bind-instances>
                        <instance>i1</instance>
                        <instance>i2</instance>
                    </bind-instances>
                    <computed-binds-instances>
                        <instance>i1</instance>
                        <instance>i2</instance>
                    </computed-binds-instances>
                    <validation-binds-instances>
                        <instance>i1</instance>
                    </validation-binds-instances>
                </model>
            </root>
        </output>
    </test>

    <test description="Rejection of unsupported attributes" name="oxf:xforms-xpath-analysis">
        <input name="form">
            <xh:html>
                <xh:head>
                    <xf:model id="model" xxf:xpath-analysis="true">
                        <xf:instance id="instance">
                            <instance/>
                        </xf:instance>
                        <xf:bind ref="." id="my-bind"/>
                    </xf:model>
                </xh:head>
                <xh:body>
                    <!-- NOTE: @bind now supported -->
                    <xf:input id="u1" bind="my-bind"/>
                    <!-- NOTE: @context now supported -->
                    <xf:input id="u2" context="." ref="b"/>
                </xh:body>
            </xh:html>
        </input>
        <output name="analysis">
            <root scope="" prefixed-id="#document" model-prefixed-id="model" binding="false" value="false">
                <model scope="" prefixed-id="model" default-instance-prefixed-id="instance" analyzed-binds="true">
                    <instance scope="" prefixed-id="instance" model-prefixed-id="model" binding="false" value="false"/>
                    <binds>
                        <bind id="my-bind" ref=".">
                            <binding>
                                <analysis expression="." analyzed="true">
                                    <returnable>
                                        <path>instance('instance')</path>
                                    </returnable>
                                    <dependent-models>
                                        <model>model</model>
                                    </dependent-models>
                                    <dependent-instances>
                                        <instance>instance</instance>
                                    </dependent-instances>
                                    <returnable-instances>
                                        <instance>instance</instance>
                                    </returnable-instances>
                                </analysis>
                            </binding>
                        </bind>
                    </binds>
                    <bind-instances>
                        <instance>instance</instance>
                    </bind-instances>
                </model>
                <input scope="" prefixed-id="u1" model-prefixed-id="model" binding="true" value="true">
                    <binding>
                        <analysis expression="." analyzed="true">
                            <returnable>
                                <path>instance('instance')</path>
                            </returnable>
                            <dependent-models>
                                <model>model</model>
                            </dependent-models>
                            <dependent-instances>
                                <instance>instance</instance>
                            </dependent-instances>
                            <returnable-instances>
                                <instance>instance</instance>
                            </returnable-instances>
                        </analysis>
                    </binding>
                    <value>
                        <analysis expression="string((.)[1])" analyzed="true">
                            <value-dependent>
                                <path>instance('instance')</path>
                            </value-dependent>
                            <dependent-models>
                                <model>model</model>
                            </dependent-models>
                            <dependent-instances>
                                <instance>instance</instance>
                            </dependent-instances>
                        </analysis>
                    </value>
                </input>
                <input scope="" prefixed-id="u2" model-prefixed-id="model" binding="true" value="true">
                    <binding>
                        <analysis expression="b" analyzed="true">
                            <returnable>
                                <path>instance('instance')/b</path>
                            </returnable>
                            <dependent-models>
                                <model>model</model>
                            </dependent-models>
                            <dependent-instances>
                                <instance>instance</instance>
                            </dependent-instances>
                            <returnable-instances>
                                <instance>instance</instance>
                            </returnable-instances>
                        </analysis>
                    </binding>
                    <value>
                        <analysis expression="string((.)[1])" analyzed="true">
                            <value-dependent>
                                <path>instance('instance')/b</path>
                            </value-dependent>
                            <dependent-models>
                                <model>model</model>
                            </dependent-models>
                            <dependent-instances>
                                <instance>instance</instance>
                            </dependent-instances>
                        </analysis>
                    </value>
                </input>
            </root>
        </output>
    </test>

    <test description="Rejection of unsupported expressions" name="oxf:xforms-xpath-analysis">
        <input name="form">
            <xh:html>
                <xh:head>
                    <xf:model id="model" xxf:xpath-analysis="true">
                        <xf:instance id="instance">
                            <instance/>
                        </xf:instance>
                    </xf:model>
                </xh:head>
                <xh:body>
                    <xf:input id="u1" ref="instance('instance')/a/*"/>
                    <xf:input id="u2" ref="instance('instance')/*/b"/>
                    <!-- TODO: This could be reliably analyzed w/o schema -->
                    <xf:input id="u3" ref="instance('instance')/a/*/parent::a"/>
                    <!-- TODO: This could be reliably analyzed w/o schema -->
                    <xf:input id="u4" ref="instance('instance')/a/*/ancestor::a"/>
                    <xf:input id="u5" ref="instance('instance')/a//parent::a"/>
                    <!-- Can't analyze w/o schema: e.g. if data is instance('instance')/a/b/a/c/ancestor::a -->
                    <xf:input id="u6" ref="instance('instance')/a//ancestor::a"/>

                    <!-- TODO: This should be supported -->
                    <xf:input id="u7" ref="/a/b"/>
                    <xf:input id="u8" ref="../a/b"/>
                    <!-- TODO: This should be supported -->
                    <xf:input id="u9" ref="root()/a/b"/>

                </xh:body>
            </xh:html>
        </input>
        <output name="analysis">
            <root scope="" prefixed-id="#document" model-prefixed-id="model" binding="false" value="false">
                <model scope="" prefixed-id="model" default-instance-prefixed-id="instance" analyzed-binds="true">
                    <instance scope="" prefixed-id="instance" model-prefixed-id="model" binding="false" value="false"/>
                </model>
                <input scope="" prefixed-id="u1" model-prefixed-id="model" binding="true" value="true">
                    <binding>
                        <analysis expression="instance('instance')/a/*" analyzed="false"/>
                    </binding>
                    <value>
                        <analysis expression="string((.)[1])" analyzed="false"/>
                    </value>
                </input>
                <input scope="" prefixed-id="u2" model-prefixed-id="model" binding="true" value="true">
                    <binding>
                        <analysis expression="instance('instance')/*/b" analyzed="false"/>
                    </binding>
                    <value>
                        <analysis expression="string((.)[1])" analyzed="false"/>
                    </value>
                </input>
                <input scope="" prefixed-id="u3" model-prefixed-id="model" binding="true" value="true">
                    <binding>
                        <analysis expression="instance('instance')/a/*/parent::a" analyzed="false"/>
                    </binding>
                    <value>
                        <analysis expression="string((.)[1])" analyzed="false"/>
                    </value>
                </input>
                <input scope="" prefixed-id="u4" model-prefixed-id="model" binding="true" value="true">
                    <binding>
                        <analysis expression="instance('instance')/a/*/ancestor::a" analyzed="false"/>
                    </binding>
                    <value>
                        <analysis expression="string((.)[1])" analyzed="false"/>
                    </value>
                </input>
                <input scope="" prefixed-id="u5" model-prefixed-id="model" binding="true" value="true">
                    <binding>
                        <analysis expression="instance('instance')/a//parent::a" analyzed="false"/>
                    </binding>
                    <value>
                        <analysis expression="string((.)[1])" analyzed="false"/>
                    </value>
                </input>
                <input scope="" prefixed-id="u6" model-prefixed-id="model" binding="true" value="true">
                    <binding>
                        <analysis expression="instance('instance')/a//ancestor::a" analyzed="false"/>
                    </binding>
                    <value>
                        <analysis expression="string((.)[1])" analyzed="false"/>
                    </value>
                </input>
                <input scope="" prefixed-id="u7" model-prefixed-id="model" binding="true" value="true">
                    <binding>
                        <analysis expression="/a/b" analyzed="false"/>
                    </binding>
                    <value>
                        <analysis expression="string((.)[1])" analyzed="false"/>
                    </value>
                </input>
                <input scope="" prefixed-id="u8" model-prefixed-id="model" binding="true" value="true">
                    <binding>
                        <analysis expression="../a/b" analyzed="false"/>
                    </binding>
                    <value>
                        <analysis expression="string((.)[1])" analyzed="false"/>
                    </value>
                </input>
                <input scope="" prefixed-id="u9" model-prefixed-id="model" binding="true" value="true">
                    <binding>
                        <analysis expression="root()/a/b" analyzed="false"/>
                    </binding>
                    <value>
                        <analysis expression="string((.)[1])" analyzed="false"/>
                    </value>
                </input>
            </root>
        </output>
    </test>

    <test description="Handling of parent:: and ancestor:: axes" name="oxf:xforms-xpath-analysis">
        <input name="form">
            <xh:html>
                <xh:head>
                    <xf:model id="model" xxf:xpath-analysis="true">
                        <xf:instance id="instance">
                            <instance/>
                        </xf:instance>
                    </xf:model>
                </xh:head>
                <xh:body>
                    <!-- parent:: -->
                    <xf:input id="p1" ref="instance('instance')/a/b"/>
                    <xf:input id="p2" ref="instance('instance')/a/.."/>
                    <xf:input id="p3" ref="instance('instance')/a/../b"/>

                    <!-- ancestor:: -->
                    <xf:input id="a1" ref="instance('instance')/a/b/ancestor::a"/>
                    <xf:input id="a2" ref="instance('instance')/a/b/ancestor::a/c"/>
                    <xf:input id="a3" ref="instance('instance')/a/b/a/c/ancestor::a"/>
                    <xf:input id="a4" ref="instance('instance')/a/b/a/(c/ancestor::a | d)"/>
                </xh:body>
            </xh:html>
        </input>
        <output name="analysis">
            <root scope="" prefixed-id="#document" model-prefixed-id="model" binding="false" value="false">
                <model scope="" prefixed-id="model" default-instance-prefixed-id="instance" analyzed-binds="true">
                    <instance scope="" prefixed-id="instance" model-prefixed-id="model" binding="false" value="false"/>
                </model>
                <input scope="" prefixed-id="p1" model-prefixed-id="model" binding="true" value="true">
                    <binding>
                        <analysis expression="instance('instance')/a/b" analyzed="true">
                            <returnable>
                                <path>instance('instance')/a/b</path>
                            </returnable>
                            <dependent-models>
                                <model>model</model>
                            </dependent-models>
                            <dependent-instances>
                                <instance>instance</instance>
                            </dependent-instances>
                            <returnable-instances>
                                <instance>instance</instance>
                            </returnable-instances>
                        </analysis>
                    </binding>
                    <value>
                        <analysis expression="string((.)[1])" analyzed="true">
                            <value-dependent>
                                <path>instance('instance')/a/b</path>
                            </value-dependent>
                            <dependent-models>
                                <model>model</model>
                            </dependent-models>
                            <dependent-instances>
                                <instance>instance</instance>
                            </dependent-instances>
                        </analysis>
                    </value>
                </input>
                <input scope="" prefixed-id="p2" model-prefixed-id="model" binding="true" value="true">
                    <binding>
                        <analysis expression="instance('instance')/a/.." analyzed="true">
                            <returnable>
                                <path>instance('instance')</path>
                            </returnable>
                            <dependent-models>
                                <model>model</model>
                            </dependent-models>
                            <dependent-instances>
                                <instance>instance</instance>
                            </dependent-instances>
                            <returnable-instances>
                                <instance>instance</instance>
                            </returnable-instances>
                        </analysis>
                    </binding>
                    <value>
                        <analysis expression="string((.)[1])" analyzed="true">
                            <value-dependent>
                                <path>instance('instance')</path>
                            </value-dependent>
                            <dependent-models>
                                <model>model</model>
                            </dependent-models>
                            <dependent-instances>
                                <instance>instance</instance>
                            </dependent-instances>
                        </analysis>
                    </value>
                </input>
                <input scope="" prefixed-id="p3" model-prefixed-id="model" binding="true" value="true">
                    <binding>
                        <analysis expression="instance('instance')/a/../b" analyzed="true">
                            <returnable>
                                <path>instance('instance')/b</path>
                            </returnable>
                            <dependent-models>
                                <model>model</model>
                            </dependent-models>
                            <dependent-instances>
                                <instance>instance</instance>
                            </dependent-instances>
                            <returnable-instances>
                                <instance>instance</instance>
                            </returnable-instances>
                        </analysis>
                    </binding>
                    <value>
                        <analysis expression="string((.)[1])" analyzed="true">
                            <value-dependent>
                                <path>instance('instance')/b</path>
                            </value-dependent>
                            <dependent-models>
                                <model>model</model>
                            </dependent-models>
                            <dependent-instances>
                                <instance>instance</instance>
                            </dependent-instances>
                        </analysis>
                    </value>
                </input>
                <input scope="" prefixed-id="a1" model-prefixed-id="model" binding="true" value="true">
                    <binding>
                        <analysis expression="instance('instance')/a/b/ancestor::a" analyzed="true">
                            <returnable>
                                <path>instance('instance')/a</path>
                            </returnable>
                            <dependent-models>
                                <model>model</model>
                            </dependent-models>
                            <dependent-instances>
                                <instance>instance</instance>
                            </dependent-instances>
                            <returnable-instances>
                                <instance>instance</instance>
                            </returnable-instances>
                        </analysis>
                    </binding>
                    <value>
                        <analysis expression="string((.)[1])" analyzed="true">
                            <value-dependent>
                                <path>instance('instance')/a</path>
                            </value-dependent>
                            <dependent-models>
                                <model>model</model>
                            </dependent-models>
                            <dependent-instances>
                                <instance>instance</instance>
                            </dependent-instances>
                        </analysis>
                    </value>
                </input>
                <input scope="" prefixed-id="a2" model-prefixed-id="model" binding="true" value="true">
                    <binding>
                        <analysis expression="instance('instance')/a/b/ancestor::a/c" analyzed="true">
                            <returnable>
                                <path>instance('instance')/a/c</path>
                            </returnable>
                            <dependent-models>
                                <model>model</model>
                            </dependent-models>
                            <dependent-instances>
                                <instance>instance</instance>
                            </dependent-instances>
                            <returnable-instances>
                                <instance>instance</instance>
                            </returnable-instances>
                        </analysis>
                    </binding>
                    <value>
                        <analysis expression="string((.)[1])" analyzed="true">
                            <value-dependent>
                                <path>instance('instance')/a/c</path>
                            </value-dependent>
                            <dependent-models>
                                <model>model</model>
                            </dependent-models>
                            <dependent-instances>
                                <instance>instance</instance>
                            </dependent-instances>
                        </analysis>
                    </value>
                </input>
                <input scope="" prefixed-id="a3" model-prefixed-id="model" binding="true" value="true">
                    <binding>
                        <analysis expression="instance('instance')/a/b/a/c/ancestor::a" analyzed="true">
                            <returnable>
                                <path>instance('instance')/a</path>
                                <path>instance('instance')/a/b/a</path>
                            </returnable>
                            <dependent-models>
                                <model>model</model>
                            </dependent-models>
                            <dependent-instances>
                                <instance>instance</instance>
                            </dependent-instances>
                            <returnable-instances>
                                <instance>instance</instance>
                            </returnable-instances>
                        </analysis>
                    </binding>
                    <value>
                        <analysis expression="string((.)[1])" analyzed="true">
                            <value-dependent>
                                <path>instance('instance')/a</path>
                                <path>instance('instance')/a/b/a</path>
                            </value-dependent>
                            <dependent-models>
                                <model>model</model>
                            </dependent-models>
                            <dependent-instances>
                                <instance>instance</instance>
                            </dependent-instances>
                        </analysis>
                    </value>
                </input>
                <input scope="" prefixed-id="a4" model-prefixed-id="model" binding="true" value="true">
                    <binding>
                        <analysis expression="instance('instance')/a/b/a/(c/ancestor::a | d)" analyzed="true">
                            <returnable>
                                <path>instance('instance')/a</path>
                                <path>instance('instance')/a/b/a</path>
                                <path>instance('instance')/a/b/a/d</path>
                            </returnable>
                            <dependent-models>
                                <model>model</model>
                            </dependent-models>
                            <dependent-instances>
                                <instance>instance</instance>
                            </dependent-instances>
                            <returnable-instances>
                                <instance>instance</instance>
                            </returnable-instances>
                        </analysis>
                    </binding>
                    <value>
                        <analysis expression="string((.)[1])" analyzed="true">
                            <value-dependent>
                                <path>instance('instance')/a</path>
                                <path>instance('instance')/a/b/a</path>
                                <path>instance('instance')/a/b/a/d</path>
                            </value-dependent>
                            <dependent-models>
                                <model>model</model>
                            </dependent-models>
                            <dependent-instances>
                                <instance>instance</instance>
                            </dependent-instances>
                        </analysis>
                    </value>
                </input>
            </root>
        </output>
    </test>

    <test description="Dependencies on other nodes" name="oxf:xforms-xpath-analysis">
        <input name="form">
            <xh:html>
                <xh:head>
                    <xf:model id="model" xxf:xpath-analysis="true">
                        <xf:instance id="instance">
                            <instance/>
                        </xf:instance>
                    </xf:model>
                </xh:head>
                <xh:body>
                    <xf:input id="d1" ref="instance('instance')/a[b]"/>
                    <xf:input id="d2" ref="instance('instance')/a[b = 42]"/>
                    <xf:input id="d3" ref="instance('instance')/a[../b = 42]"/>
                </xh:body>
            </xh:html>
        </input>
        <output name="analysis">
            <root scope="" prefixed-id="#document" model-prefixed-id="model" binding="false" value="false">
                <model scope="" prefixed-id="model" default-instance-prefixed-id="instance" analyzed-binds="true">
                    <instance scope="" prefixed-id="instance" model-prefixed-id="model" binding="false" value="false"/>
                </model>
                <input scope="" prefixed-id="d1" model-prefixed-id="model" binding="true" value="true">
                    <binding>
                        <analysis expression="instance('instance')/a[b]" analyzed="true">
                            <returnable>
                                <path>instance('instance')/a</path>
                            </returnable>
                            <dependent-models>
                                <model>model</model>
                            </dependent-models>
                            <dependent-instances>
                                <instance>instance</instance>
                            </dependent-instances>
                            <returnable-instances>
                                <instance>instance</instance>
                            </returnable-instances>
                        </analysis>
                    </binding>
                    <value>
                        <analysis expression="string((.)[1])" analyzed="true">
                            <value-dependent>
                                <path>instance('instance')/a</path>
                            </value-dependent>
                            <dependent-models>
                                <model>model</model>
                            </dependent-models>
                            <dependent-instances>
                                <instance>instance</instance>
                            </dependent-instances>
                        </analysis>
                    </value>
                </input>
                <input scope="" prefixed-id="d2" model-prefixed-id="model" binding="true" value="true">
                    <binding>
                        <analysis expression="instance('instance')/a[b = 42]" analyzed="true">
                            <value-dependent>
                                <path>instance('instance')/a/b</path>
                            </value-dependent>
                            <returnable>
                                <path>instance('instance')/a</path>
                            </returnable>
                            <dependent-models>
                                <model>model</model>
                            </dependent-models>
                            <dependent-instances>
                                <instance>instance</instance>
                            </dependent-instances>
                            <returnable-instances>
                                <instance>instance</instance>
                            </returnable-instances>
                        </analysis>
                    </binding>
                    <value>
                        <analysis expression="string((.)[1])" analyzed="true">
                            <value-dependent>
                                <path>instance('instance')/a</path>
                                <path>instance('instance')/a/b</path>
                            </value-dependent>
                            <dependent-models>
                                <model>model</model>
                            </dependent-models>
                            <dependent-instances>
                                <instance>instance</instance>
                            </dependent-instances>
                        </analysis>
                    </value>
                </input>
                <input scope="" prefixed-id="d3" model-prefixed-id="model" binding="true" value="true">
                    <binding>
                        <analysis expression="instance('instance')/a[../b = 42]" analyzed="true">
                            <value-dependent>
                                <path>instance('instance')/b</path>
                            </value-dependent>
                            <returnable>
                                <path>instance('instance')/a</path>
                            </returnable>
                            <dependent-models>
                                <model>model</model>
                            </dependent-models>
                            <dependent-instances>
                                <instance>instance</instance>
                            </dependent-instances>
                            <returnable-instances>
                                <instance>instance</instance>
                            </returnable-instances>
                        </analysis>
                    </binding>
                    <value>
                        <analysis expression="string((.)[1])" analyzed="true">
                            <value-dependent>
                                <path>instance('instance')/a</path>
                                <path>instance('instance')/b</path>
                            </value-dependent>
                            <dependent-models>
                                <model>model</model>
                            </dependent-models>
                            <dependent-instances>
                                <instance>instance</instance>
                            </dependent-instances>
                        </analysis>
                    </value>
                </input>
            </root>
        </output>
    </test>

    <test description="Simple model variable accessed by view" name="oxf:xforms-xpath-analysis">
        <input name="form">
            <xh:html>
                <xh:head>
                    <xf:model id="model" xxf:xpath-analysis="true">
                        <xf:instance id="instance">
                            <instance/>
                        </xf:instance>
                        <xf:var name="mv" value="instance()"/>
                    </xf:model>
                </xh:head>
                <xh:body>
                    <xf:output id="output1" value="$mv"/>
                </xh:body>
            </xh:html>
        </input>
        <output name="analysis">
            <root scope="" prefixed-id="#document" model-prefixed-id="model" binding="false" value="false">
                <model scope="" prefixed-id="model" default-instance-prefixed-id="instance" analyzed-binds="true">
                    <instance scope="" prefixed-id="instance" model-prefixed-id="model" binding="false" value="false"/>
                    <var scope="" prefixed-id="xf-1" model-prefixed-id="model" binding="false" value="false" name="mv">
                        <value>
                            <analysis expression="instance()" analyzed="true">
                                <returnable>
                                    <path>instance('instance')</path>
                                </returnable>
                                <dependent-models>
                                    <model>model</model>
                                </dependent-models>
                                <dependent-instances>
                                    <instance>instance</instance>
                                </dependent-instances>
                                <returnable-instances>
                                    <instance>instance</instance>
                                </returnable-instances>
                            </analysis>
                        </value>
                    </var>
                </model>
                <output scope="" prefixed-id="output1" model-prefixed-id="model" binding="false" value="true">
                    <value>
                        <analysis expression="string(($mv)[1])" analyzed="true">
                            <value-dependent>
                                <path>instance('instance')</path>
                            </value-dependent>
                            <dependent-models>
                                <model>model</model>
                            </dependent-models>
                            <dependent-instances>
                                <instance>instance</instance>
                            </dependent-instances>
                        </analysis>
                    </value>
                </output>
            </root>
        </output>
    </test>

    <test description="Simple model variables with 2 models" name="oxf:xforms-xpath-analysis">
        <input name="form">
            <xh:html>
                <xh:head>
                    <xf:model id="model1" xxf:xpath-analysis="true">
                        <xf:instance id="instance1">
                            <instance/>
                        </xf:instance>
                        <xf:var name="mv" value="instance()"/>
                    </xf:model>
                    <xf:model id="model2">
                        <xf:instance id="instance2">
                            <instance/>
                        </xf:instance>
                        <xf:var name="mv" value="instance()"/>
                    </xf:model>
                </xh:head>
                <xh:body>
                    <xf:output id="output1" model="model2" value="$mv"/>
                </xh:body>
            </xh:html>
        </input>
        <output name="analysis">
            <root scope="" prefixed-id="#document" model-prefixed-id="model1" binding="false" value="false">
                <model scope="" prefixed-id="model1" default-instance-prefixed-id="instance1" analyzed-binds="true">
                    <instance scope="" prefixed-id="instance1" model-prefixed-id="model1" binding="false" value="false"/>
                    <var scope="" prefixed-id="xf-1" model-prefixed-id="model1" binding="false" value="false" name="mv">
                        <value>
                            <analysis expression="instance()" analyzed="true">
                                <returnable>
                                    <path>instance('instance1')</path>
                                </returnable>
                                <dependent-models>
                                    <model>model1</model>
                                </dependent-models>
                                <dependent-instances>
                                    <instance>instance1</instance>
                                </dependent-instances>
                                <returnable-instances>
                                    <instance>instance1</instance>
                                </returnable-instances>
                            </analysis>
                        </value>
                    </var>
                </model>
                <model scope="" prefixed-id="model2" default-instance-prefixed-id="instance2" analyzed-binds="true">
                    <instance scope="" prefixed-id="instance2" model-prefixed-id="model2" binding="false" value="false"/>
                    <var scope="" prefixed-id="xf-2" model-prefixed-id="model2" binding="false" value="false" name="mv">
                        <value>
                            <analysis expression="instance()" analyzed="true">
                                <returnable>
                                    <path>instance('instance2')</path>
                                </returnable>
                                <dependent-models>
                                    <model>model2</model>
                                </dependent-models>
                                <dependent-instances>
                                    <instance>instance2</instance>
                                </dependent-instances>
                                <returnable-instances>
                                    <instance>instance2</instance>
                                </returnable-instances>
                            </analysis>
                        </value>
                    </var>
                </model>
                <output scope="" prefixed-id="output1" model-prefixed-id="model2" binding="false" value="true">
                    <value>
                        <analysis expression="string(($mv)[1])" analyzed="true">
                            <value-dependent>
                                <path>instance('instance2')</path>
                            </value-dependent>
                            <dependent-models>
                                <model>model2</model>
                            </dependent-models>
                            <dependent-instances>
                                <instance>instance2</instance>
                            </dependent-instances>
                        </analysis>
                    </value>
                </output>
            </root>
        </output>
    </test>

    <test description="Model variables" name="oxf:xforms-xpath-analysis">
        <input name="form" href="oxf:/org/orbeon/oxf/xforms/analysis/model-variables.xhtml"/>
        <output name="analysis">
            <root scope="" prefixed-id="#document" model-prefixed-id="model1" binding="false" value="false">
                <model scope="" prefixed-id="model1" default-instance-prefixed-id="instance1" analyzed-binds="true">
                    <instance scope="" prefixed-id="instance1" model-prefixed-id="model1" binding="false" value="false"/>
                    <var scope="" prefixed-id="xf-1" model-prefixed-id="model1" binding="false" value="false" name="mv">
                        <value>
                            <analysis expression="instance()" analyzed="true">
                                <returnable>
                                    <path>instance('instance1')</path>
                                </returnable>
                                <dependent-models>
                                    <model>model1</model>
                                </dependent-models>
                                <dependent-instances>
                                    <instance>instance1</instance>
                                </dependent-instances>
                                <returnable-instances>
                                    <instance>instance1</instance>
                                </returnable-instances>
                            </analysis>
                        </value>
                    </var>
                </model>
                <model scope="" prefixed-id="model2" default-instance-prefixed-id="instance2" analyzed-binds="true">
                    <instance scope="" prefixed-id="instance2" model-prefixed-id="model2" binding="false" value="false"/>
                    <var scope="" prefixed-id="xf-2" model-prefixed-id="model2" binding="false" value="false" name="mv">
                        <value>
                            <analysis expression="instance()" analyzed="true">
                                <returnable>
                                    <path>instance('instance2')</path>
                                </returnable>
                                <dependent-models>
                                    <model>model2</model>
                                </dependent-models>
                                <dependent-instances>
                                    <instance>instance2</instance>
                                </dependent-instances>
                                <returnable-instances>
                                    <instance>instance2</instance>
                                </returnable-instances>
                            </analysis>
                        </value>
                    </var>
                </model>
                <output scope="" prefixed-id="output1" model-prefixed-id="model1" binding="false" value="true">
                    <value>
                        <analysis expression="string(($mv)[1])" analyzed="true">
                            <value-dependent>
                                <path>instance('instance1')</path>
                            </value-dependent>
                            <dependent-models>
                                <model>model1</model>
                            </dependent-models>
                            <dependent-instances>
                                <instance>instance1</instance>
                            </dependent-instances>
                        </analysis>
                    </value>
                </output>
                <group scope="" prefixed-id="group2" model-prefixed-id="model2" binding="false" value="false">
                    <output scope="" prefixed-id="output2a" model-prefixed-id="model2" binding="false" value="true">
                        <value>
                            <analysis expression="string(($mv)[1])" analyzed="true">
                                <value-dependent>
                                    <path>instance('instance2')</path>
                                </value-dependent>
                                <dependent-models>
                                    <model>model2</model>
                                </dependent-models>
                                <dependent-instances>
                                    <instance>instance2</instance>
                                </dependent-instances>
                            </analysis>
                        </value>
                    </output>
                    <output scope="" prefixed-id="output2b" model-prefixed-id="model1" binding="false" value="true">
                        <value>
                            <analysis expression="string(($mv)[1])" analyzed="true">
                                <value-dependent>
                                    <path>instance('instance1')</path>
                                </value-dependent>
                                <dependent-models>
                                    <model>model1</model>
                                </dependent-models>
                                <dependent-instances>
                                    <instance>instance1</instance>
                                </dependent-instances>
                            </analysis>
                        </value>
                    </output>
                </group>
                <group scope="" prefixed-id="group3" model-prefixed-id="model1" binding="true" value="false">
                    <binding>
                        <analysis expression="xxf:instance('instance2')" analyzed="true">
                            <returnable>
                                <path>instance('instance2')</path>
                            </returnable>
                            <dependent-models>
                                <model>model2</model>
                            </dependent-models>
                            <dependent-instances>
                                <instance>instance2</instance>
                            </dependent-instances>
                            <returnable-instances>
                                <instance>instance2</instance>
                            </returnable-instances>
                        </analysis>
                    </binding>
                    <output scope="" prefixed-id="output3a" model-prefixed-id="model1" binding="false" value="true">
                        <value>
                            <analysis expression="string(($mv)[1])" analyzed="true">
                                <value-dependent>
                                    <path>instance('instance1')</path>
                                </value-dependent>
                                <dependent-models>
                                    <model>model1</model>
                                </dependent-models>
                                <dependent-instances>
                                    <instance>instance1</instance>
                                </dependent-instances>
                            </analysis>
                        </value>
                    </output>
                    <output scope="" prefixed-id="output3b" model-prefixed-id="model1" binding="false" value="true">
                        <value>
                            <analysis expression="string(($mv)[1])" analyzed="true">
                                <value-dependent>
                                    <path>instance('instance1')</path>
                                </value-dependent>
                                <dependent-models>
                                    <model>model1</model>
                                </dependent-models>
                                <dependent-instances>
                                    <instance>instance1</instance>
                                </dependent-instances>
                            </analysis>
                        </value>
                    </output>
                    <output scope="" prefixed-id="output3c" model-prefixed-id="model2" binding="false" value="true">
                        <value>
                            <analysis expression="string(($mv)[1])" analyzed="true">
                                <value-dependent>
                                    <path>instance('instance2')</path>
                                </value-dependent>
                                <dependent-models>
                                    <model>model2</model>
                                </dependent-models>
                                <dependent-instances>
                                    <instance>instance2</instance>
                                </dependent-instances>
                            </analysis>
                        </value>
                    </output>
                </group>
                <group scope="" prefixed-id="group4" model-prefixed-id="model1" binding="false" value="false">
                    <output scope="" prefixed-id="output4a" model-prefixed-id="model1" binding="false" value="true">
                        <value>
                            <analysis expression="string(($mv)[1])" analyzed="true">
                                <value-dependent>
                                    <path>instance('instance1')</path>
                                </value-dependent>
                                <dependent-models>
                                    <model>model1</model>
                                </dependent-models>
                                <dependent-instances>
                                    <instance>instance1</instance>
                                </dependent-instances>
                            </analysis>
                        </value>
                    </output>
                    <output scope="" prefixed-id="output4b" model-prefixed-id="model1" binding="false" value="true">
                        <value>
                            <analysis expression="string(($mv)[1])" analyzed="true">
                                <value-dependent>
                                    <path>instance('instance1')</path>
                                </value-dependent>
                                <dependent-models>
                                    <model>model1</model>
                                </dependent-models>
                                <dependent-instances>
                                    <instance>instance1</instance>
                                </dependent-instances>
                            </analysis>
                        </value>
                    </output>
                    <output scope="" prefixed-id="output4c" model-prefixed-id="model2" binding="false" value="true">
                        <value>
                            <analysis expression="string(($mv)[1])" analyzed="true">
                                <value-dependent>
                                    <path>instance('instance2')</path>
                                </value-dependent>
                                <dependent-models>
                                    <model>model2</model>
                                </dependent-models>
                                <dependent-instances>
                                    <instance>instance2</instance>
                                </dependent-instances>
                            </analysis>
                        </value>
                    </output>
                </group>
                <var scope="" prefixed-id="xf-3" model-prefixed-id="model1" binding="false" value="false" name="mv1">
                    <value>
                        <analysis expression="$mv" analyzed="true">
                            <returnable>
                                <path>instance('instance1')</path>
                            </returnable>
                            <dependent-models>
                                <model>model1</model>
                            </dependent-models>
                            <dependent-instances>
                                <instance>instance1</instance>
                            </dependent-instances>
                            <returnable-instances>
                                <instance>instance1</instance>
                            </returnable-instances>
                        </analysis>
                    </value>
                </var>
                <var scope="" prefixed-id="xf-4" model-prefixed-id="model2" binding="false" value="false" name="mv2">
                    <value>
                        <analysis expression="$mv" analyzed="true">
                            <returnable>
                                <path>instance('instance2')</path>
                            </returnable>
                            <dependent-models>
                                <model>model2</model>
                            </dependent-models>
                            <dependent-instances>
                                <instance>instance2</instance>
                            </dependent-instances>
                            <returnable-instances>
                                <instance>instance2</instance>
                            </returnable-instances>
                        </analysis>
                    </value>
                </var>
                <output scope="" prefixed-id="output5a" model-prefixed-id="model1" binding="false" value="true">
                    <value>
                        <analysis expression="string(($mv1)[1])" analyzed="true">
                            <value-dependent>
                                <path>instance('instance1')</path>
                            </value-dependent>
                            <dependent-models>
                                <model>model1</model>
                            </dependent-models>
                            <dependent-instances>
                                <instance>instance1</instance>
                            </dependent-instances>
                        </analysis>
                    </value>
                </output>
                <output scope="" prefixed-id="output5b" model-prefixed-id="model1" binding="false" value="true">
                    <value>
                        <analysis expression="string(($mv2)[1])" analyzed="true">
                            <value-dependent>
                                <path>instance('instance2')</path>
                            </value-dependent>
                            <dependent-models>
                                <model>model2</model>
                            </dependent-models>
                            <dependent-instances>
                                <instance>instance2</instance>
                            </dependent-instances>
                        </analysis>
                    </value>
                </output>
            </root>
        </output>
    </test>

    <test description="Simple xxf:instance function within models" name="oxf:xforms-xpath-analysis">
        <input name="form">
            <xh:html>
                <xh:head>
                    <xf:model id="model1" xxf:xpath-analysis="true">
                        <xf:instance id="instance1">
                            <instance>42</instance>
                        </xf:instance>
                        <xf:var name="mv" value="xxf:instance('instance2')"/>
                    </xf:model>
                    <xf:model id="model2">
                        <xf:instance id="instance2">
                            <instance>43</instance>
                        </xf:instance>
                        <xf:var name="mv" value="xxf:instance('instance1')"/>
                    </xf:model>
                </xh:head>
            </xh:html>
        </input>
        <output name="analysis">
            <root scope="" prefixed-id="#document" model-prefixed-id="model1" binding="false" value="false">
                <model scope="" prefixed-id="model1" default-instance-prefixed-id="instance1" analyzed-binds="true">
                    <instance scope="" prefixed-id="instance1" model-prefixed-id="model1" binding="false" value="false"/>
                    <var scope="" prefixed-id="xf-1" model-prefixed-id="model1" binding="false" value="false" name="mv">
                        <value>
                            <analysis expression="xxf:instance('instance2')" analyzed="true">
                                <returnable>
                                    <path>instance('instance2')</path>
                                </returnable>
                                <dependent-models>
                                    <model>model2</model>
                                </dependent-models>
                                <dependent-instances>
                                    <instance>instance2</instance>
                                </dependent-instances>
                                <returnable-instances>
                                    <instance>instance2</instance>
                                </returnable-instances>
                            </analysis>
                        </value>
                    </var>
                </model>
                <model scope="" prefixed-id="model2" default-instance-prefixed-id="instance2" analyzed-binds="true">
                    <instance scope="" prefixed-id="instance2" model-prefixed-id="model2" binding="false" value="false"/>
                    <var scope="" prefixed-id="xf-2" model-prefixed-id="model2" binding="false" value="false" name="mv">
                        <value>
                            <analysis expression="xxf:instance('instance1')" analyzed="true">
                                <returnable>
                                    <path>instance('instance1')</path>
                                </returnable>
                                <dependent-models>
                                    <model>model1</model>
                                </dependent-models>
                                <dependent-instances>
                                    <instance>instance1</instance>
                                </dependent-instances>
                                <returnable-instances>
                                    <instance>instance1</instance>
                                </returnable-instances>
                            </analysis>
                        </value>
                    </var>
                </model>
            </root>
        </output>
    </test>

    <test description="Complex cross-models instance references" name="oxf:xforms-xpath-analysis">
        <input name="form">
            <xh:html>
                <xh:head>
                    <xf:model xxf:xpath-analysis="true" id="model1">
                        <xf:instance id="instance11">
                            <instance/>
                        </xf:instance>
                        <xf:instance id="instance12">
                            <instance/>
                        </xf:instance>

                        <xf:var name="v11a" value="instance()"/>
                        <xf:var name="v11b" value="instance('instance11')"/>
                        <xf:var name="v12" value="instance('instance12')"/>

                        <xf:var name="v13" value="xxf:instance('instance21')"/>
                        <xf:var name="v14" value="xxf:instance('instance22')"/>

                        <xf:var name="v15a" model="model2" value="instance()"/>
                        <xf:var name="v15b" model="model2" value="instance('instance21')"/>
                        <xf:var name="v16" model="model2" value="instance('instance22')"/>

                    </xf:model>
                    <xf:model id="model2">
                        <xf:instance id="instance21">
                            <instance/>
                        </xf:instance>
                        <xf:instance id="instance22">
                            <instance/>
                        </xf:instance>

                        <xf:var name="v21" value="instance()"/>
                        <xf:var name="v22" value="instance('instance22')"/>

                        <xf:var name="v23" value="xxf:instance('instance11')"/>
                        <xf:var name="v24" value="xxf:instance('instance12')"/>

                        <xf:var name="v25a" model="model1" value="instance()"/>
                        <xf:var name="v25b" model="model1" value="instance('instance11')"/>
                        <xf:var name="v26" model="model1" value="instance('instance12')"/>

                    </xf:model>
                </xh:head>
            </xh:html>
        </input>
        <output name="analysis">
            <root scope="" prefixed-id="#document" model-prefixed-id="model1" binding="false" value="false">
                <model scope="" prefixed-id="model1" default-instance-prefixed-id="instance11" analyzed-binds="true">
                    <instance scope="" prefixed-id="instance11" model-prefixed-id="model1" binding="false" value="false"/>
                    <instance scope="" prefixed-id="instance12" model-prefixed-id="model1" binding="false" value="false"/>
                    <var scope="" prefixed-id="xf-1" model-prefixed-id="model1" binding="false" value="false" name="v11a">
                        <value>
                            <analysis expression="instance()" analyzed="true">
                                <returnable>
                                    <path>instance('instance11')</path>
                                </returnable>
                                <dependent-models>
                                    <model>model1</model>
                                </dependent-models>
                                <dependent-instances>
                                    <instance>instance11</instance>
                                </dependent-instances>
                                <returnable-instances>
                                    <instance>instance11</instance>
                                </returnable-instances>
                            </analysis>
                        </value>
                    </var>
                    <var scope="" prefixed-id="xf-2" model-prefixed-id="model1" binding="false" value="false" name="v11b">
                        <value>
                            <analysis expression="instance('instance11')" analyzed="true">
                                <returnable>
                                    <path>instance('instance11')</path>
                                </returnable>
                                <dependent-models>
                                    <model>model1</model>
                                </dependent-models>
                                <dependent-instances>
                                    <instance>instance11</instance>
                                </dependent-instances>
                                <returnable-instances>
                                    <instance>instance11</instance>
                                </returnable-instances>
                            </analysis>
                        </value>
                    </var>
                    <var scope="" prefixed-id="xf-3" model-prefixed-id="model1" binding="false" value="false" name="v12">
                        <value>
                            <analysis expression="instance('instance12')" analyzed="true">
                                <returnable>
                                    <path>instance('instance12')</path>
                                </returnable>
                                <dependent-models>
                                    <model>model1</model>
                                </dependent-models>
                                <dependent-instances>
                                    <instance>instance12</instance>
                                </dependent-instances>
                                <returnable-instances>
                                    <instance>instance12</instance>
                                </returnable-instances>
                            </analysis>
                        </value>
                    </var>
                    <var scope="" prefixed-id="xf-4" model-prefixed-id="model1" binding="false" value="false" name="v13">
                        <value>
                            <analysis expression="xxf:instance('instance21')" analyzed="true">
                                <returnable>
                                    <path>instance('instance21')</path>
                                </returnable>
                                <dependent-models>
                                    <model>model2</model>
                                </dependent-models>
                                <dependent-instances>
                                    <instance>instance21</instance>
                                </dependent-instances>
                                <returnable-instances>
                                    <instance>instance21</instance>
                                </returnable-instances>
                            </analysis>
                        </value>
                    </var>
                    <var scope="" prefixed-id="xf-5" model-prefixed-id="model1" binding="false" value="false" name="v14">
                        <value>
                            <analysis expression="xxf:instance('instance22')" analyzed="true">
                                <returnable>
                                    <path>instance('instance22')</path>
                                </returnable>
                                <dependent-models>
                                    <model>model2</model>
                                </dependent-models>
                                <dependent-instances>
                                    <instance>instance22</instance>
                                </dependent-instances>
                                <returnable-instances>
                                    <instance>instance22</instance>
                                </returnable-instances>
                            </analysis>
                        </value>
                    </var>
                    <var scope="" prefixed-id="xf-6" model-prefixed-id="model2" binding="false" value="false" name="v15a">
                        <value>
                            <analysis expression="instance()" analyzed="true">
                                <returnable>
                                    <path>instance('instance21')</path>
                                </returnable>
                                <dependent-models>
                                    <model>model2</model>
                                </dependent-models>
                                <dependent-instances>
                                    <instance>instance21</instance>
                                </dependent-instances>
                                <returnable-instances>
                                    <instance>instance21</instance>
                                </returnable-instances>
                            </analysis>
                        </value>
                    </var>
                    <var scope="" prefixed-id="xf-7" model-prefixed-id="model2" binding="false" value="false" name="v15b">
                        <value>
                            <analysis expression="instance('instance21')" analyzed="true">
                                <returnable>
                                    <path>instance('instance21')</path>
                                </returnable>
                                <dependent-models>
                                    <model>model2</model>
                                </dependent-models>
                                <dependent-instances>
                                    <instance>instance21</instance>
                                </dependent-instances>
                                <returnable-instances>
                                    <instance>instance21</instance>
                                </returnable-instances>
                            </analysis>
                        </value>
                    </var>
                    <var scope="" prefixed-id="xf-8" model-prefixed-id="model2" binding="false" value="false" name="v16">
                        <value>
                            <analysis expression="instance('instance22')" analyzed="true">
                                <returnable>
                                    <path>instance('instance22')</path>
                                </returnable>
                                <dependent-models>
                                    <model>model2</model>
                                </dependent-models>
                                <dependent-instances>
                                    <instance>instance22</instance>
                                </dependent-instances>
                                <returnable-instances>
                                    <instance>instance22</instance>
                                </returnable-instances>
                            </analysis>
                        </value>
                    </var>
                </model>
                <model scope="" prefixed-id="model2" default-instance-prefixed-id="instance21" analyzed-binds="true">
                    <instance scope="" prefixed-id="instance21" model-prefixed-id="model2" binding="false" value="false"/>
                    <instance scope="" prefixed-id="instance22" model-prefixed-id="model2" binding="false" value="false"/>
                    <var scope="" prefixed-id="xf-9" model-prefixed-id="model2" binding="false" value="false" name="v21">
                        <value>
                            <analysis expression="instance()" analyzed="true">
                                <returnable>
                                    <path>instance('instance21')</path>
                                </returnable>
                                <dependent-models>
                                    <model>model2</model>
                                </dependent-models>
                                <dependent-instances>
                                    <instance>instance21</instance>
                                </dependent-instances>
                                <returnable-instances>
                                    <instance>instance21</instance>
                                </returnable-instances>
                            </analysis>
                        </value>
                    </var>
                    <var scope="" prefixed-id="xf-10" model-prefixed-id="model2" binding="false" value="false" name="v22">
                        <value>
                            <analysis expression="instance('instance22')" analyzed="true">
                                <returnable>
                                    <path>instance('instance22')</path>
                                </returnable>
                                <dependent-models>
                                    <model>model2</model>
                                </dependent-models>
                                <dependent-instances>
                                    <instance>instance22</instance>
                                </dependent-instances>
                                <returnable-instances>
                                    <instance>instance22</instance>
                                </returnable-instances>
                            </analysis>
                        </value>
                    </var>
                    <var scope="" prefixed-id="xf-11" model-prefixed-id="model2" binding="false" value="false" name="v23">
                        <value>
                            <analysis expression="xxf:instance('instance11')" analyzed="true">
                                <returnable>
                                    <path>instance('instance11')</path>
                                </returnable>
                                <dependent-models>
                                    <model>model1</model>
                                </dependent-models>
                                <dependent-instances>
                                    <instance>instance11</instance>
                                </dependent-instances>
                                <returnable-instances>
                                    <instance>instance11</instance>
                                </returnable-instances>
                            </analysis>
                        </value>
                    </var>
                    <var scope="" prefixed-id="xf-12" model-prefixed-id="model2" binding="false" value="false" name="v24">
                        <value>
                            <analysis expression="xxf:instance('instance12')" analyzed="true">
                                <returnable>
                                    <path>instance('instance12')</path>
                                </returnable>
                                <dependent-models>
                                    <model>model1</model>
                                </dependent-models>
                                <dependent-instances>
                                    <instance>instance12</instance>
                                </dependent-instances>
                                <returnable-instances>
                                    <instance>instance12</instance>
                                </returnable-instances>
                            </analysis>
                        </value>
                    </var>
                    <var scope="" prefixed-id="xf-13" model-prefixed-id="model1" binding="false" value="false" name="v25a">
                        <value>
                            <analysis expression="instance()" analyzed="true">
                                <returnable>
                                    <path>instance('instance11')</path>
                                </returnable>
                                <dependent-models>
                                    <model>model1</model>
                                </dependent-models>
                                <dependent-instances>
                                    <instance>instance11</instance>
                                </dependent-instances>
                                <returnable-instances>
                                    <instance>instance11</instance>
                                </returnable-instances>
                            </analysis>
                        </value>
                    </var>
                    <var scope="" prefixed-id="xf-14" model-prefixed-id="model1" binding="false" value="false" name="v25b">
                        <value>
                            <analysis expression="instance('instance11')" analyzed="true">
                                <returnable>
                                    <path>instance('instance11')</path>
                                </returnable>
                                <dependent-models>
                                    <model>model1</model>
                                </dependent-models>
                                <dependent-instances>
                                    <instance>instance11</instance>
                                </dependent-instances>
                                <returnable-instances>
                                    <instance>instance11</instance>
                                </returnable-instances>
                            </analysis>
                        </value>
                    </var>
                    <var scope="" prefixed-id="xf-15" model-prefixed-id="model1" binding="false" value="false" name="v26">
                        <value>
                            <analysis expression="instance('instance12')" analyzed="true">
                                <returnable>
                                    <path>instance('instance12')</path>
                                </returnable>
                                <dependent-models>
                                    <model>model1</model>
                                </dependent-models>
                                <dependent-instances>
                                    <instance>instance12</instance>
                                </dependent-instances>
                                <returnable-instances>
                                    <instance>instance12</instance>
                                </returnable-instances>
                            </analysis>
                        </value>
                    </var>
                </model>
            </root>
        </output>
    </test>

    <test description="Basic xf:var/xxf:value" name="oxf:xforms-xpath-analysis">
        <input name="form">
            <xh:html>
                <xh:head>

                    <xf:model xxf:xpath-analysis="true" id="model">

                        <xf:instance id="instance">
                            <instance>
                                <foo>42</foo>
                                <bar>43</bar>
                            </instance>
                        </xf:instance>

                        <xf:var id="vfoo" name="foo" value="foo"/>
                        <xf:var id="vbar" name="bar" value="bar"/>

                    </xf:model>
                </xh:head>
                <xh:body>

                    <xf:var id="vsum" name="sum">
                        <xxf:value value="$foo + $bar"/>
                    </xf:var>
                    <xf:var id="vproduct" name="product">
                        <xxf:value ref="foo" value=". * $bar"/>
                    </xf:var>
                    <xf:var id="vdifference" name="difference" ref="foo">
                        <xxf:value value=". - $bar"/>
                    </xf:var>

                    <xf:output id="osum" value="$sum"/>
                    <xf:output id="oproduct" value="$product"/>
                    <xf:output id="odifference" value="$difference"/>
                </xh:body>
            </xh:html>
        </input>
        <output name="analysis">
            <root scope="" prefixed-id="#document" model-prefixed-id="model" binding="false" value="false">
                <model scope="" prefixed-id="model" default-instance-prefixed-id="instance" analyzed-binds="true">
                    <instance scope="" prefixed-id="instance" model-prefixed-id="model" binding="false" value="false"/>
                    <var scope="" prefixed-id="vfoo" model-prefixed-id="model" binding="false" value="false" name="foo">
                        <value>
                            <analysis expression="foo" analyzed="true">
                                <returnable>
                                    <path>instance('instance')/foo</path>
                                </returnable>
                                <dependent-models>
                                    <model>model</model>
                                </dependent-models>
                                <dependent-instances>
                                    <instance>instance</instance>
                                </dependent-instances>
                                <returnable-instances>
                                    <instance>instance</instance>
                                </returnable-instances>
                            </analysis>
                        </value>
                    </var>
                    <var scope="" prefixed-id="vbar" model-prefixed-id="model" binding="false" value="false" name="bar">
                        <value>
                            <analysis expression="bar" analyzed="true">
                                <returnable>
                                    <path>instance('instance')/bar</path>
                                </returnable>
                                <dependent-models>
                                    <model>model</model>
                                </dependent-models>
                                <dependent-instances>
                                    <instance>instance</instance>
                                </dependent-instances>
                                <returnable-instances>
                                    <instance>instance</instance>
                                </returnable-instances>
                            </analysis>
                        </value>
                    </var>
                </model>
                <var scope="" prefixed-id="vsum" model-prefixed-id="model" binding="false" value="false" name="sum">
                    <value>
                        <analysis expression="$foo + $bar" analyzed="true">
                            <value-dependent>
                                <path>instance('instance')/foo</path>
                                <path>instance('instance')/bar</path>
                            </value-dependent>
                            <dependent-models>
                                <model>model</model>
                            </dependent-models>
                            <dependent-instances>
                                <instance>instance</instance>
                            </dependent-instances>
                        </analysis>
                    </value>
                </var>
                <var scope="" prefixed-id="vproduct" model-prefixed-id="model" binding="false" value="false" name="product">
                    <value>
                        <analysis expression=". * $bar" analyzed="true">
                            <value-dependent>
                                <path>instance('instance')/foo</path>
                                <path>instance('instance')/bar</path>
                            </value-dependent>
                            <dependent-models>
                                <model>model</model>
                            </dependent-models>
                            <dependent-instances>
                                <instance>instance</instance>
                            </dependent-instances>
                        </analysis>
                    </value>
                </var>
                <var scope="" prefixed-id="vdifference" model-prefixed-id="model" binding="true" value="false" name="difference">
                    <binding>
                        <analysis expression="foo" analyzed="true">
                            <returnable>
                                <path>instance('instance')/foo</path>
                            </returnable>
                            <dependent-models>
                                <model>model</model>
                            </dependent-models>
                            <dependent-instances>
                                <instance>instance</instance>
                            </dependent-instances>
                            <returnable-instances>
                                <instance>instance</instance>
                            </returnable-instances>
                        </analysis>
                    </binding>
                    <value>
                        <analysis expression=". - $bar" analyzed="true">
                            <value-dependent>
                                <path>instance('instance')/foo</path>
                                <path>instance('instance')/bar</path>
                            </value-dependent>
                            <dependent-models>
                                <model>model</model>
                            </dependent-models>
                            <dependent-instances>
                                <instance>instance</instance>
                            </dependent-instances>
                        </analysis>
                    </value>
                </var>
                <output scope="" prefixed-id="osum" model-prefixed-id="model" binding="false" value="true">
                    <value>
                        <analysis expression="string(($sum)[1])" analyzed="true">
                            <value-dependent>
                                <path>instance('instance')/foo</path>
                                <path>instance('instance')/bar</path>
                            </value-dependent>
                            <dependent-models>
                                <model>model</model>
                            </dependent-models>
                            <dependent-instances>
                                <instance>instance</instance>
                            </dependent-instances>
                        </analysis>
                    </value>
                </output>
                <output scope="" prefixed-id="oproduct" model-prefixed-id="model" binding="false" value="true">
                    <value>
                        <analysis expression="string(($product)[1])" analyzed="true">
                            <value-dependent>
                                <path>instance('instance')/foo</path>
                                <path>instance('instance')/bar</path>
                            </value-dependent>
                            <dependent-models>
                                <model>model</model>
                            </dependent-models>
                            <dependent-instances>
                                <instance>instance</instance>
                            </dependent-instances>
                        </analysis>
                    </value>
                </output>
                <output scope="" prefixed-id="odifference" model-prefixed-id="model" binding="false" value="true">
                    <value>
                        <analysis expression="string(($difference)[1])" analyzed="true">
                            <value-dependent>
                                <path>instance('instance')/foo</path>
                                <path>instance('instance')/bar</path>
                            </value-dependent>
                            <dependent-models>
                                <model>model</model>
                            </dependent-models>
                            <dependent-instances>
                                <instance>instance</instance>
                            </dependent-instances>
                        </analysis>
                    </value>
                </output>
            </root>
        </output>
    </test>

    <test description="XBL xf:var/xxf:value" name="oxf:xforms-xpath-analysis">
        <input name="form">
            <xh:html xmlns:exf="http://www.exforms.org/exf/1-0" xmlns:xxbl="http://orbeon.org/oxf/xml/xbl">
                <xh:head>

                    <xf:model xxf:xpath-analysis="true" id="model">

                        <xf:instance id="instance">
                            <instance>
                                <foo>42</foo>
                                <bar>43</bar>
                            </instance>
                        </xf:instance>

                        <xf:var id="vfoo" name="foo">
                            <xxf:value value="foo"/>
                        </xf:var>
                        <xf:var id="vbar" name="bar">
                            <xxf:value value="bar"/>
                        </xf:var>
                    </xf:model>
                    <xbl:xbl>
                        <xbl:binding id="fr-foo" element="fr|foo">
                            <xbl:implementation>
                                <xf:model id="model">
                                    <xf:instance id="instance">
                                        <instance/>
                                    </xf:instance>
                                </xf:model>
                            </xbl:implementation>
                            <xbl:template>

                                <xf:var id="iv" name="internal" value="."/>
                                <xf:var id="ov" name="external">
                                    <xxf:value xbl:attr="value=ref" xxbl:scope="outer"/>
                                </xf:var>
                                <xf:var id="ro" name="readonly" value="exf:readonly($external)"/>

                                <xf:group ref="$external" id="group-external"/>
                                <xf:output id="oexternal" value="$external"/>
                                <xf:output id="oro" value="$readonly"/>
                            </xbl:template>
                        </xbl:binding>
                    </xbl:xbl>
                </xh:head>
                <xh:body>
                    <fr:foo id="my-foo" ref="foo"/>
                </xh:body>
            </xh:html>
        </input>
        <output name="analysis">
            <root scope="" prefixed-id="#document" model-prefixed-id="model" binding="false" value="false">
                <model scope="" prefixed-id="model" default-instance-prefixed-id="instance" analyzed-binds="true">
                    <instance scope="" prefixed-id="instance" model-prefixed-id="model" binding="false" value="false"/>
                    <var scope="" prefixed-id="vfoo" model-prefixed-id="model" binding="false" value="false" name="foo">
                        <value>
                            <analysis expression="foo" analyzed="true">
                                <returnable>
                                    <path>instance('instance')/foo</path>
                                </returnable>
                                <dependent-models>
                                    <model>model</model>
                                </dependent-models>
                                <dependent-instances>
                                    <instance>instance</instance>
                                </dependent-instances>
                                <returnable-instances>
                                    <instance>instance</instance>
                                </returnable-instances>
                            </analysis>
                        </value>
                    </var>
                    <var scope="" prefixed-id="vbar" model-prefixed-id="model" binding="false" value="false" name="bar">
                        <value>
                            <analysis expression="bar" analyzed="true">
                                <returnable>
                                    <path>instance('instance')/bar</path>
                                </returnable>
                                <dependent-models>
                                    <model>model</model>
                                </dependent-models>
                                <dependent-instances>
                                    <instance>instance</instance>
                                </dependent-instances>
                                <returnable-instances>
                                    <instance>instance</instance>
                                </returnable-instances>
                            </analysis>
                        </value>
                    </var>
                </model>
                <foo scope="" prefixed-id="my-foo" model-prefixed-id="model" binding="false" value="false">
                    <model scope="my-foo" prefixed-id="my-foomodel" default-instance-prefixed-id="my-fooinstance" analyzed-binds="true">
                        <instance scope="my-foo" prefixed-id="my-fooinstance" model-prefixed-id="my-foomodel" binding="false" value="false"/>
                    </model>
                    <template scope="my-foo" prefixed-id="my-fooxf-4" model-prefixed-id="my-foomodel" binding="false" value="false">
                        <var scope="my-foo" prefixed-id="my-fooiv" model-prefixed-id="my-foomodel" binding="false" value="false" name="internal">
                            <value>
                                <analysis expression="." analyzed="true">
                                    <returnable>
                                        <path>instance('my-fooinstance')</path>
                                    </returnable>
                                    <dependent-models>
                                        <model>my-foomodel</model>
                                    </dependent-models>
                                    <dependent-instances>
                                        <instance>my-fooinstance</instance>
                                    </dependent-instances>
                                    <returnable-instances>
                                        <instance>my-fooinstance</instance>
                                    </returnable-instances>
                                </analysis>
                            </value>
                        </var>
                        <var scope="my-foo" prefixed-id="my-fooov" model-prefixed-id="my-foomodel" binding="false" value="false" name="external">
                            <value>
                                <analysis expression="foo" analyzed="true">
                                    <returnable>
                                        <path>instance('instance')/foo</path>
                                    </returnable>
                                    <dependent-models>
                                        <model>model</model>
                                    </dependent-models>
                                    <dependent-instances>
                                        <instance>instance</instance>
                                    </dependent-instances>
                                    <returnable-instances>
                                        <instance>instance</instance>
                                    </returnable-instances>
                                </analysis>
                            </value>
                        </var>
                        <var scope="my-foo" prefixed-id="my-fooro" model-prefixed-id="my-foomodel" binding="false" value="false" name="readonly">
                            <value>
                                <analysis expression="exf:readonly($external)" analyzed="false"/>
                            </value>
                        </var>
                        <group scope="my-foo" prefixed-id="my-foogroup-external" model-prefixed-id="my-foomodel" binding="true" value="false">
                            <binding>
                                <analysis expression="$external" analyzed="true">
                                    <returnable>
                                        <path>instance('instance')/foo</path>
                                    </returnable>
                                    <dependent-models>
                                        <model>model</model>
                                    </dependent-models>
                                    <dependent-instances>
                                        <instance>instance</instance>
                                    </dependent-instances>
                                    <returnable-instances>
                                        <instance>instance</instance>
                                    </returnable-instances>
                                </analysis>
                            </binding>
                        </group>
                        <output scope="my-foo" prefixed-id="my-foooexternal" model-prefixed-id="my-foomodel" binding="false" value="true">
                            <value>
                                <analysis expression="string(($external)[1])" analyzed="true">
                                    <value-dependent>
                                        <path>instance('instance')/foo</path>
                                    </value-dependent>
                                    <dependent-models>
                                        <model>model</model>
                                    </dependent-models>
                                    <dependent-instances>
                                        <instance>instance</instance>
                                    </dependent-instances>
                                </analysis>
                            </value>
                        </output>
                        <output scope="my-foo" prefixed-id="my-foooro" model-prefixed-id="my-foomodel" binding="false" value="true">
                            <value>
                                <analysis expression="string(($readonly)[1])" analyzed="false"/>
                            </value>
                        </output>
                    </template>
                </foo>
            </root>
        </output>
    </test>

    <test description="Expression both returning a node and using the node value in predicate" name="oxf:xforms-xpath-analysis">
        <input name="form">
            <xh:html>
                <xh:head>
                    <xf:model id="model" xxf:xpath-analysis="true">
                        <xf:instance id="instance">
                            <instance><name/></instance>
                        </xf:instance>
                    </xf:model>
                </xh:head>
                <xh:body>
                    <xf:input id="input" ref="name[. = 42]"/>
                </xh:body>
            </xh:html>
        </input>
        <output name="analysis">
            <root scope="" prefixed-id="#document" model-prefixed-id="model" binding="false" value="false">
                <model scope="" prefixed-id="model" default-instance-prefixed-id="instance" analyzed-binds="true">
                    <instance scope="" prefixed-id="instance" model-prefixed-id="model" binding="false" value="false"/>
                </model>
                <input scope="" prefixed-id="input" model-prefixed-id="model" binding="true" value="true">
                    <binding>
                        <analysis expression="name[. = 42]" analyzed="true">
                            <value-dependent>
                                <path>instance('instance')/name</path>
                            </value-dependent>
                            <returnable>
                                <path>instance('instance')/name</path>
                            </returnable>
                            <dependent-models>
                                <model>model</model>
                            </dependent-models>
                            <dependent-instances>
                                <instance>instance</instance>
                            </dependent-instances>
                            <returnable-instances>
                                <instance>instance</instance>
                            </returnable-instances>
                        </analysis>
                    </binding>
                    <value>
                        <analysis expression="string((.)[1])" analyzed="true">
                            <value-dependent>
                                <path>instance('instance')/name</path>
                            </value-dependent>
                            <dependent-models>
                                <model>model</model>
                            </dependent-models>
                            <dependent-instances>
                                <instance>instance</instance>
                            </dependent-instances>
                        </analysis>
                    </value>
                </input>
            </root>
        </output>
    </test>

    <test description="Binding depending on variable scoped in parent container" name="oxf:xforms-xpath-analysis">
        <input name="form">
            <xh:html>
                <xh:head>
                    <xf:model id="model" xxf:xpath-analysis="true">
                        <xf:instance id="instance">
                            <instance><value/></instance>
                        </xf:instance>
                    </xf:model>
                </xh:head>
                <xh:body>
                    <xf:var id="show-variable" name="show" value="value = 'true'"/>
                    <xf:group id="enclosing-group">
                        <xf:group id="nested-group" ref=".[$show]"/>
                    </xf:group>

                </xh:body>
            </xh:html>
        </input>
        <output name="analysis">
            <root scope="" prefixed-id="#document" model-prefixed-id="model" binding="false" value="false">
                <model scope="" prefixed-id="model" default-instance-prefixed-id="instance" analyzed-binds="true">
                    <instance scope="" prefixed-id="instance" model-prefixed-id="model" binding="false" value="false"/>
                </model>
                <var scope="" prefixed-id="show-variable" model-prefixed-id="model" binding="false" value="false" name="show">
                    <value>
                        <analysis expression="value = 'true'" analyzed="true">
                            <value-dependent>
                                <path>instance('instance')/value</path>
                            </value-dependent>
                            <dependent-models>
                                <model>model</model>
                            </dependent-models>
                            <dependent-instances>
                                <instance>instance</instance>
                            </dependent-instances>
                        </analysis>
                    </value>
                </var>
                <group scope="" prefixed-id="enclosing-group" model-prefixed-id="model" binding="false" value="false">
                    <group scope="" prefixed-id="nested-group" model-prefixed-id="model" binding="true" value="false">
                        <binding>
                            <analysis expression=".[$show]" analyzed="true">
                                <value-dependent>
                                    <path>instance('instance')/value</path>
                                </value-dependent>
                                <returnable>
                                    <path>instance('instance')</path>
                                </returnable>
                                <dependent-models>
                                    <model>model</model>
                                </dependent-models>
                                <dependent-instances>
                                    <instance>instance</instance>
                                </dependent-instances>
                                <returnable-instances>
                                    <instance>instance</instance>
                                </returnable-instances>
                            </analysis>
                        </binding>
                    </group>
                </group>
            </root>
        </output>
    </test>

    <test description="Top-level model with no instance" name="oxf:xforms-xpath-analysis">
        <input name="form">
            <xh:html>
                <xh:head>
                    <xf:model id="model" xxf:xpath-analysis="true"/>
                </xh:head>
                <xh:body>
                    <xf:output id="output" value="current-date()"/>
                </xh:body>
            </xh:html>
        </input>
        <output name="analysis">
            <root scope="" prefixed-id="#document" model-prefixed-id="model" binding="false" value="false">
                <model scope="" prefixed-id="model" analyzed-binds="true"/>
                <output scope="" prefixed-id="output" model-prefixed-id="model" binding="false" value="true">
                    <value>
                        <analysis expression="string((current-date())[1])" analyzed="true"/>
                    </value>
                </output>
            </root>
        </output>
    </test>

    <test description="XBL with no local model" name="oxf:xforms-xpath-analysis">
        <input name="form">
            <xh:html xmlns:exf="http://www.exforms.org/exf/1-0" xmlns:xxbl="http://orbeon.org/oxf/xml/xbl">
                <xh:head>
                    <xf:model xxf:xpath-analysis="true" id="model"/>
                    <xbl:xbl>
                        <xbl:binding id="fr-foo" element="fr|foo">
                            <xbl:template>
                                <xf:output id="output" value="current-date()"/>
                            </xbl:template>
                        </xbl:binding>
                    </xbl:xbl>
                </xh:head>
                <xh:body>
                    <fr:foo id="my-foo"/>
                </xh:body>
            </xh:html>
        </input>
        <output name="analysis">
            <root scope="" prefixed-id="#document" model-prefixed-id="model" binding="false" value="false">
                <model scope="" prefixed-id="model" analyzed-binds="true"/>
                <foo scope="" prefixed-id="my-foo" model-prefixed-id="model" binding="false" value="false">
                    <template scope="my-foo" prefixed-id="my-fooxf-2" binding="false" value="false">
                        <output scope="my-foo" prefixed-id="my-foooutput" binding="false" value="true">
                            <value>
                                <analysis expression="string((current-date())[1])" analyzed="true"/>
                            </value>
                        </output>
                    </template>
                </foo>
            </root>
        </output>
    </test>

    <test description="Simple change of control validity based on MIP" name="oxf:pipeline">
        <input name="config" href="wrap-xforms-state.xpl"/>
        <input name="document">
            <xh:html>
                <xh:head>
                    <xf:model id="model" xxf:xpath-analysis="true">
                        <xf:instance id="i1">
                            <instance>
                                <a/>
                                <b/>
                            </instance>
                        </xf:instance>

                        <xf:bind id="b1" ref="instance()/a" constraint="../b = 'x'"/>

                        <xf:action ev:event="xforms-ready">
                            <xf:refresh/>
                            <xf:delete model="events-model" ref="*"/>

                            <!-- Cause a to become valid -->
                            <xf:setvalue ref="b">x</xf:setvalue>
                            <xf:refresh/>

                        </xf:action>

                    </xf:model>
                    <xf:model id="events-model">
                        <!-- TEST: Events to gather -->
                        <xf:instance id="events-instance">
                            <events/>
                        </xf:instance>
                    </xf:model>
                </xh:head>
                <xh:body>
                    <xf:insert
                        event="xforms-valid xxforms-constraints-changed"
                        model="events-model"
                        context="."
                        ref="*"
                        origin="
                            xf:element(
                                'event',
                                (
                                    xf:attribute('type', event('xxf:type')),
                                    xf:attribute('target', event('xxf:targetid'))
                                )
                            )"/>

                    <xf:output id="g11" ref="a"/>

                </xh:body>
            </xh:html>
        </input>
        <output name="response">
            <xxf:event-response>
                <xxf:dynamic-state>
                    <dynamic-state>
                        <instances>
                            <instance id="i1" model-id="model">
                                <instance>
                                    <a/>
                                    <b>x</b>
                                </instance>
                            </instance>
                            <instance id="events-instance" model-id="events-model">
                                <events>
                                    <event type="xforms-valid" target="g11"/>
                                    <event type="xxforms-constraints-changed" target="g11"/>
                                </events>
                            </instance>
                        </instances>
                    </dynamic-state>
                </xxf:dynamic-state>
                <xxf:action>
                    <xxf:control-values/>
                </xxf:action>
            </xxf:event-response>
        </output>
    </test>

    <test description="PO example: analysis" name="oxf:xforms-xpath-analysis">
        <!-- NOTE: As of 2012-08-07, there is an extra value dependency on the value instance('po')/items/item/total
             following the fix for #331. It doesn't seem like this dependency should be there. -->
        <input name="form" href="forms/po.xhtml"/>
        <output name="analysis">
            <root scope="" prefixed-id="#document" model-prefixed-id="model" binding="false" value="false">
                <model scope="" prefixed-id="model" default-instance-prefixed-id="po" analyzed-binds="true">
                    <instance scope="" prefixed-id="po" model-prefixed-id="model" binding="false" value="false"/>
                    <action scope="" prefixed-id="xf-1" model-prefixed-id="model" binding="false" value="false">
                        <refresh scope="" prefixed-id="xf-2" model-prefixed-id="model" binding="false" value="false"/>
                        <delete scope="" prefixed-id="xf-3" model-prefixed-id="events-model" binding="true" value="false">
                            <binding>
                                <analysis expression="*" analyzed="false"/>
                            </binding>
                        </delete>
                        <setvalue scope="" prefixed-id="xf-4" model-prefixed-id="model" binding="true" value="false">
                            <binding>
                                <analysis expression="items/item/price" analyzed="true">
                                    <returnable>
                                        <path>instance('po')/items/item/price</path>
                                    </returnable>
                                    <dependent-models>
                                        <model>model</model>
                                    </dependent-models>
                                    <dependent-instances>
                                        <instance>po</instance>
                                    </dependent-instances>
                                    <returnable-instances>
                                        <instance>po</instance>
                                    </returnable-instances>
                                </analysis>
                            </binding>
                        </setvalue>
                        <refresh scope="" prefixed-id="xf-5" model-prefixed-id="model" binding="false" value="false"/>
                        <setvalue scope="" prefixed-id="xf-6" model-prefixed-id="model" binding="true" value="false">
                            <binding>
                                <analysis expression="items/item/price" analyzed="true">
                                    <returnable>
                                        <path>instance('po')/items/item/price</path>
                                    </returnable>
                                    <dependent-models>
                                        <model>model</model>
                                    </dependent-models>
                                    <dependent-instances>
                                        <instance>po</instance>
                                    </dependent-instances>
                                    <returnable-instances>
                                        <instance>po</instance>
                                    </returnable-instances>
                                </analysis>
                            </binding>
                        </setvalue>
                        <refresh scope="" prefixed-id="xf-7" model-prefixed-id="model" binding="false" value="false"/>
                    </action>
                    <binds>
                        <bind id="item-bind" ref="items/item">
                            <binding>
                                <analysis expression="items/item" analyzed="true">
                                    <returnable>
                                        <path>instance('po')/items/item</path>
                                    </returnable>
                                    <dependent-models>
                                        <model>model</model>
                                    </dependent-models>
                                    <dependent-instances>
                                        <instance>po</instance>
                                    </dependent-instances>
                                    <returnable-instances>
                                        <instance>po</instance>
                                    </returnable-instances>
                                </analysis>
                            </binding>
                            <bind id="name-bind" ref="name">
                                <binding>
                                    <analysis expression="name" analyzed="true">
                                        <returnable>
                                            <path>instance('po')/items/item/name</path>
                                        </returnable>
                                        <dependent-models>
                                            <model>model</model>
                                        </dependent-models>
                                        <dependent-instances>
                                            <instance>po</instance>
                                        </dependent-instances>
                                        <returnable-instances>
                                            <instance>po</instance>
                                        </returnable-instances>
                                    </analysis>
                                </binding>
                                <mip name="constraint" expression="boolean(normalize-space())">
                                    <analysis expression="boolean(normalize-space())" analyzed="true">
                                        <value-dependent>
                                            <path>instance('po')/items/item/name</path>
                                        </value-dependent>
                                        <dependent-models>
                                            <model>model</model>
                                        </dependent-models>
                                        <dependent-instances>
                                            <instance>po</instance>
                                        </dependent-instances>
                                    </analysis>
                                </mip>
                                <mip name="required" expression="boolean(true())">
                                    <analysis expression="boolean(true())" analyzed="true"/>
                                </mip>
                            </bind>
                            <bind id="units-bind" ref="units">
                                <binding>
                                    <analysis expression="units" analyzed="true">
                                        <returnable>
                                            <path>instance('po')/items/item/units</path>
                                        </returnable>
                                        <dependent-models>
                                            <model>model</model>
                                        </dependent-models>
                                        <dependent-instances>
                                            <instance>po</instance>
                                        </dependent-instances>
                                        <returnable-instances>
                                            <instance>po</instance>
                                        </returnable-instances>
                                    </analysis>
                                </binding>
                                <value>
                                    <analysis expression="string((.)[1])" analyzed="true">
                                        <value-dependent>
                                            <path>instance('po')/items/item/units</path>
                                        </value-dependent>
                                        <dependent-models>
                                            <model>model</model>
                                        </dependent-models>
                                        <dependent-instances>
                                            <instance>po</instance>
                                        </dependent-instances>
                                    </analysis>
                                </value>
                                <mip name="constraint" expression="boolean(. &gt; 0)">
                                    <analysis expression="boolean(. &gt; 0)" analyzed="true">
                                        <value-dependent>
                                            <path>instance('po')/items/item/units</path>
                                        </value-dependent>
                                        <dependent-models>
                                            <model>model</model>
                                        </dependent-models>
                                        <dependent-instances>
                                            <instance>po</instance>
                                        </dependent-instances>
                                    </analysis>
                                </mip>
                            </bind>
                            <bind id="price-bind" ref="price">
                                <binding>
                                    <analysis expression="price" analyzed="true">
                                        <returnable>
                                            <path>instance('po')/items/item/price</path>
                                        </returnable>
                                        <dependent-models>
                                            <model>model</model>
                                        </dependent-models>
                                        <dependent-instances>
                                            <instance>po</instance>
                                        </dependent-instances>
                                        <returnable-instances>
                                            <instance>po</instance>
                                        </returnable-instances>
                                    </analysis>
                                </binding>
                                <value>
                                    <analysis expression="string((.)[1])" analyzed="true">
                                        <value-dependent>
                                            <path>instance('po')/items/item/price</path>
                                        </value-dependent>
                                        <dependent-models>
                                            <model>model</model>
                                        </dependent-models>
                                        <dependent-instances>
                                            <instance>po</instance>
                                        </dependent-instances>
                                    </analysis>
                                </value>
                                <mip name="constraint" expression="boolean(. &gt; 0)">
                                    <analysis expression="boolean(. &gt; 0)" analyzed="true">
                                        <value-dependent>
                                            <path>instance('po')/items/item/price</path>
                                        </value-dependent>
                                        <dependent-models>
                                            <model>model</model>
                                        </dependent-models>
                                        <dependent-instances>
                                            <instance>po</instance>
                                        </dependent-instances>
                                    </analysis>
                                </mip>
                            </bind>
                            <bind id="line-total-bind" ref="total">
                                <binding>
                                    <analysis expression="total" analyzed="true">
                                        <returnable>
                                            <path>instance('po')/items/item/total</path>
                                        </returnable>
                                        <dependent-models>
                                            <model>model</model>
                                        </dependent-models>
                                        <dependent-instances>
                                            <instance>po</instance>
                                        </dependent-instances>
                                        <returnable-instances>
                                            <instance>po</instance>
                                        </returnable-instances>
                                    </analysis>
                                </binding>
                                <value>
                                    <analysis expression="string((.)[1])" analyzed="true">
                                        <value-dependent>
                                            <path>instance('po')/items/item/total</path>
                                        </value-dependent>
                                        <dependent-models>
                                            <model>model</model>
                                        </dependent-models>
                                        <dependent-instances>
                                            <instance>po</instance>
                                        </dependent-instances>
                                    </analysis>
                                </value>
                                <mip name="calculate" expression="string((if (string(../units) castable as xs:integer and string(../price) castable as xs:decimal) then ../units * ../price else '-')[1])">
                                    <analysis expression="string((if (string(../units) castable as xs:integer and string(../price) castable as xs:decimal) then ../units * ../price else '-')[1])" analyzed="true">
                                        <value-dependent>
                                            <path>instance('po')/items/item/units</path>
                                            <path>instance('po')/items/item/price</path>
                                        </value-dependent>
                                        <dependent-models>
                                            <model>model</model>
                                        </dependent-models>
                                        <dependent-instances>
                                            <instance>po</instance>
                                        </dependent-instances>
                                    </analysis>
                                </mip>
                                <mip name="relevant" expression="boolean(for $u in ../units return string($u) castable as xs:decimal and $u &gt; 0)">
                                    <analysis expression="boolean(for $u in ../units return string($u) castable as xs:decimal and $u &gt; 0)" analyzed="true">
                                        <value-dependent>
                                            <path>instance('po')/items/item/units</path>
                                        </value-dependent>
                                        <dependent-models>
                                            <model>model</model>
                                        </dependent-models>
                                        <dependent-instances>
                                            <instance>po</instance>
                                        </dependent-instances>
                                    </analysis>
                                </mip>
                            </bind>
                        </bind>
                        <bind id="totals-bind" ref="totals">
                            <binding>
                                <analysis expression="totals" analyzed="true">
                                    <returnable>
                                        <path>instance('po')/totals</path>
                                    </returnable>
                                    <dependent-models>
                                        <model>model</model>
                                    </dependent-models>
                                    <dependent-instances>
                                        <instance>po</instance>
                                    </dependent-instances>
                                    <returnable-instances>
                                        <instance>po</instance>
                                    </returnable-instances>
                                </analysis>
                            </binding>
                            <bind id="subtotal-bind" ref="subtotal">
                                <binding>
                                    <analysis expression="subtotal" analyzed="true">
                                        <returnable>
                                            <path>instance('po')/totals/subtotal</path>
                                        </returnable>
                                        <dependent-models>
                                            <model>model</model>
                                        </dependent-models>
                                        <dependent-instances>
                                            <instance>po</instance>
                                        </dependent-instances>
                                        <returnable-instances>
                                            <instance>po</instance>
                                        </returnable-instances>
                                    </analysis>
                                </binding>
                                <value>
                                    <analysis expression="string((.)[1])" analyzed="true">
                                        <value-dependent>
                                            <path>instance('po')/totals/subtotal</path>
                                        </value-dependent>
                                        <dependent-models>
                                            <model>model</model>
                                        </dependent-models>
                                        <dependent-instances>
                                            <instance>po</instance>
                                        </dependent-instances>
                                    </analysis>
                                </value>
                                <mip name="calculate" expression="string((sum(for $t in ../../items/item/total[string(.) castable as xs:decimal] return $t))[1])">
                                    <analysis expression="string((sum(for $t in ../../items/item/total[string(.) castable as xs:decimal] return $t))[1])" analyzed="true">
                                        <value-dependent>
                                            <path>instance('po')/items/item/total</path>
                                        </value-dependent>
                                        <dependent-models>
                                            <model>model</model>
                                        </dependent-models>
                                        <dependent-instances>
                                            <instance>po</instance>
                                        </dependent-instances>
                                    </analysis>
                                </mip>
                            </bind>
                            <bind id="tax-bind" ref="tax">
                                <binding>
                                    <analysis expression="tax" analyzed="true">
                                        <returnable>
                                            <path>instance('po')/totals/tax</path>
                                        </returnable>
                                        <dependent-models>
                                            <model>model</model>
                                        </dependent-models>
                                        <dependent-instances>
                                            <instance>po</instance>
                                        </dependent-instances>
                                        <returnable-instances>
                                            <instance>po</instance>
                                        </returnable-instances>
                                    </analysis>
                                </binding>
                                <value>
                                    <analysis expression="string((.)[1])" analyzed="true">
                                        <value-dependent>
                                            <path>instance('po')/totals/tax</path>
                                        </value-dependent>
                                        <dependent-models>
                                            <model>model</model>
                                        </dependent-models>
                                        <dependent-instances>
                                            <instance>po</instance>
                                        </dependent-instances>
                                    </analysis>
                                </value>
                                <mip name="calculate" expression="string((../subtotal * ../../info/tax)[1])">
                                    <analysis expression="string((../subtotal * ../../info/tax)[1])" analyzed="true">
                                        <value-dependent>
                                            <path>instance('po')/totals/subtotal</path>
                                            <path>instance('po')/info/tax</path>
                                        </value-dependent>
                                        <dependent-models>
                                            <model>model</model>
                                        </dependent-models>
                                        <dependent-instances>
                                            <instance>po</instance>
                                        </dependent-instances>
                                    </analysis>
                                </mip>
                            </bind>
                            <bind id="total-bind" ref="total">
                                <binding>
                                    <analysis expression="total" analyzed="true">
                                        <returnable>
                                            <path>instance('po')/totals/total</path>
                                        </returnable>
                                        <dependent-models>
                                            <model>model</model>
                                        </dependent-models>
                                        <dependent-instances>
                                            <instance>po</instance>
                                        </dependent-instances>
                                        <returnable-instances>
                                            <instance>po</instance>
                                        </returnable-instances>
                                    </analysis>
                                </binding>
                                <value>
                                    <analysis expression="string((.)[1])" analyzed="true">
                                        <value-dependent>
                                            <path>instance('po')/totals/total</path>
                                        </value-dependent>
                                        <dependent-models>
                                            <model>model</model>
                                        </dependent-models>
                                        <dependent-instances>
                                            <instance>po</instance>
                                        </dependent-instances>
                                    </analysis>
                                </value>
                                <mip name="calculate" expression="string((for $t in ../subtotal + ../tax return if ($t &gt; 4000) then $t else $t * 0.9)[1])">
                                    <analysis expression="string((for $t in ../subtotal + ../tax return if ($t &gt; 4000) then $t else $t * 0.9)[1])" analyzed="true">
                                        <value-dependent>
                                            <path>instance('po')/totals/subtotal</path>
                                            <path>instance('po')/totals/tax</path>
                                        </value-dependent>
                                        <dependent-models>
                                            <model>model</model>
                                        </dependent-models>
                                        <dependent-instances>
                                            <instance>po</instance>
                                        </dependent-instances>
                                    </analysis>
                                </mip>
                            </bind>
                        </bind>
                        <bind id="info-tax-bind" ref="info/tax">
                            <binding>
                                <analysis expression="info/tax" analyzed="true">
                                    <returnable>
                                        <path>instance('po')/info/tax</path>
                                    </returnable>
                                    <dependent-models>
                                        <model>model</model>
                                    </dependent-models>
                                    <dependent-instances>
                                        <instance>po</instance>
                                    </dependent-instances>
                                    <returnable-instances>
                                        <instance>po</instance>
                                    </returnable-instances>
                                </analysis>
                            </binding>
                            <value>
                                <analysis expression="string((.)[1])" analyzed="true">
                                    <value-dependent>
                                        <path>instance('po')/info/tax</path>
                                    </value-dependent>
                                    <dependent-models>
                                        <model>model</model>
                                    </dependent-models>
                                    <dependent-instances>
                                        <instance>po</instance>
                                    </dependent-instances>
                                </analysis>
                            </value>
                        </bind>
                    </binds>
                    <bind-instances>
                        <instance>po</instance>
                    </bind-instances>
                    <computed-binds-instances>
                        <instance>po</instance>
                    </computed-binds-instances>
                    <validation-binds-instances>
                        <instance>po</instance>
                    </validation-binds-instances>
                    <action scope="" prefixed-id="xf-1" model-prefixed-id="model" binding="false" value="false">
                        <refresh scope="" prefixed-id="xf-2" model-prefixed-id="model" binding="false" value="false"/>
                        <delete scope="" prefixed-id="xf-3" model-prefixed-id="events-model" binding="true" value="false">
                            <binding>
                                <analysis expression="*" analyzed="false"/>
                            </binding>
                        </delete>
                        <setvalue scope="" prefixed-id="xf-4" model-prefixed-id="model" binding="true" value="false">
                            <binding>
                                <analysis expression="items/item/price" analyzed="true">
                                    <returnable>
                                        <path>instance('po')/items/item/price</path>
                                    </returnable>
                                    <dependent-models>
                                        <model>model</model>
                                    </dependent-models>
                                    <dependent-instances>
                                        <instance>po</instance>
                                    </dependent-instances>
                                    <returnable-instances>
                                        <instance>po</instance>
                                    </returnable-instances>
                                </analysis>
                            </binding>
                        </setvalue>
                        <refresh scope="" prefixed-id="xf-5" model-prefixed-id="model" binding="false" value="false"/>
                        <setvalue scope="" prefixed-id="xf-6" model-prefixed-id="model" binding="true" value="false">
                            <binding>
                                <analysis expression="items/item/price" analyzed="true">
                                    <returnable>
                                        <path>instance('po')/items/item/price</path>
                                    </returnable>
                                    <dependent-models>
                                        <model>model</model>
                                    </dependent-models>
                                    <dependent-instances>
                                        <instance>po</instance>
                                    </dependent-instances>
                                    <returnable-instances>
                                        <instance>po</instance>
                                    </returnable-instances>
                                </analysis>
                            </binding>
                        </setvalue>
                        <refresh scope="" prefixed-id="xf-7" model-prefixed-id="model" binding="false" value="false"/>
                    </action>
                </model>
                <model scope="" prefixed-id="events-model" default-instance-prefixed-id="events-instance" analyzed-binds="true">
                    <instance scope="" prefixed-id="events-instance" model-prefixed-id="events-model" binding="false" value="false"/>
                </model>
                <insert scope="" prefixed-id="my-insert" model-prefixed-id="events-model" binding="true" value="false">
                    <binding>
                        <analysis expression="*" analyzed="false"/>
                    </binding>
                </insert>
                <repeat scope="" prefixed-id="item-repeat" model-prefixed-id="model" binding="true" value="false">
                    <binding>
                        <analysis expression="items/item" analyzed="true">
                            <returnable>
                                <path>instance('po')/items/item</path>
                            </returnable>
                            <dependent-models>
                                <model>model</model>
                            </dependent-models>
                            <dependent-instances>
                                <instance>po</instance>
                            </dependent-instances>
                            <returnable-instances>
                                <instance>po</instance>
                            </returnable-instances>
                        </analysis>
                    </binding>
                    <repeat-iteration scope="" prefixed-id="item-repeat~iteration" model-prefixed-id="model" binding="false" value="false">
                        <input scope="" prefixed-id="name" model-prefixed-id="model" binding="true" value="true">
                            <binding>
                                <analysis expression="name" analyzed="true">
                                    <returnable>
                                        <path>instance('po')/items/item/name</path>
                                    </returnable>
                                    <dependent-models>
                                        <model>model</model>
                                    </dependent-models>
                                    <dependent-instances>
                                        <instance>po</instance>
                                    </dependent-instances>
                                    <returnable-instances>
                                        <instance>po</instance>
                                    </returnable-instances>
                                </analysis>
                            </binding>
                            <value>
                                <analysis expression="string((.)[1])" analyzed="true">
                                    <value-dependent>
                                        <path>instance('po')/items/item/name</path>
                                    </value-dependent>
                                    <dependent-models>
                                        <model>model</model>
                                    </dependent-models>
                                    <dependent-instances>
                                        <instance>po</instance>
                                    </dependent-instances>
                                </analysis>
                            </value>
                        </input>
                        <input scope="" prefixed-id="units" model-prefixed-id="model" binding="true" value="true">
                            <binding>
                                <analysis expression="units" analyzed="true">
                                    <returnable>
                                        <path>instance('po')/items/item/units</path>
                                    </returnable>
                                    <dependent-models>
                                        <model>model</model>
                                    </dependent-models>
                                    <dependent-instances>
                                        <instance>po</instance>
                                    </dependent-instances>
                                    <returnable-instances>
                                        <instance>po</instance>
                                    </returnable-instances>
                                </analysis>
                            </binding>
                            <value>
                                <analysis expression="string((.)[1])" analyzed="true">
                                    <value-dependent>
                                        <path>instance('po')/items/item/units</path>
                                    </value-dependent>
                                    <dependent-models>
                                        <model>model</model>
                                    </dependent-models>
                                    <dependent-instances>
                                        <instance>po</instance>
                                    </dependent-instances>
                                </analysis>
                            </value>
                        </input>
                        <input scope="" prefixed-id="price" model-prefixed-id="model" binding="true" value="true">
                            <binding>
                                <analysis expression="price" analyzed="true">
                                    <returnable>
                                        <path>instance('po')/items/item/price</path>
                                    </returnable>
                                    <dependent-models>
                                        <model>model</model>
                                    </dependent-models>
                                    <dependent-instances>
                                        <instance>po</instance>
                                    </dependent-instances>
                                    <returnable-instances>
                                        <instance>po</instance>
                                    </returnable-instances>
                                </analysis>
                            </binding>
                            <value>
                                <analysis expression="string((.)[1])" analyzed="true">
                                    <value-dependent>
                                        <path>instance('po')/items/item/price</path>
                                    </value-dependent>
                                    <dependent-models>
                                        <model>model</model>
                                    </dependent-models>
                                    <dependent-instances>
                                        <instance>po</instance>
                                    </dependent-instances>
                                </analysis>
                            </value>
                        </input>
                        <output scope="" prefixed-id="line-total" model-prefixed-id="model" binding="true" value="true">
                            <binding>
                                <analysis expression="total" analyzed="true">
                                    <returnable>
                                        <path>instance('po')/items/item/total</path>
                                    </returnable>
                                    <dependent-models>
                                        <model>model</model>
                                    </dependent-models>
                                    <dependent-instances>
                                        <instance>po</instance>
                                    </dependent-instances>
                                    <returnable-instances>
                                        <instance>po</instance>
                                    </returnable-instances>
                                </analysis>
                            </binding>
                            <value>
                                <analysis expression="string((.)[1])" analyzed="true">
                                    <value-dependent>
                                        <path>instance('po')/items/item/total</path>
                                    </value-dependent>
                                    <dependent-models>
                                        <model>model</model>
                                    </dependent-models>
                                    <dependent-instances>
                                        <instance>po</instance>
                                    </dependent-instances>
                                </analysis>
                            </value>
                        </output>
                    </repeat-iteration>
                </repeat>
                <output scope="" prefixed-id="subtotal" model-prefixed-id="model" binding="true" value="true">
                    <binding>
                        <analysis expression="totals/subtotal" analyzed="true">
                            <returnable>
                                <path>instance('po')/totals/subtotal</path>
                            </returnable>
                            <dependent-models>
                                <model>model</model>
                            </dependent-models>
                            <dependent-instances>
                                <instance>po</instance>
                            </dependent-instances>
                            <returnable-instances>
                                <instance>po</instance>
                            </returnable-instances>
                        </analysis>
                    </binding>
                    <value>
                        <analysis expression="string((.)[1])" analyzed="true">
                            <value-dependent>
                                <path>instance('po')/totals/subtotal</path>
                            </value-dependent>
                            <dependent-models>
                                <model>model</model>
                            </dependent-models>
                            <dependent-instances>
                                <instance>po</instance>
                            </dependent-instances>
                        </analysis>
                    </value>
                </output>
                <output scope="" prefixed-id="tax" model-prefixed-id="model" binding="true" value="true">
                    <binding>
                        <analysis expression="totals/tax" analyzed="true">
                            <returnable>
                                <path>instance('po')/totals/tax</path>
                            </returnable>
                            <dependent-models>
                                <model>model</model>
                            </dependent-models>
                            <dependent-instances>
                                <instance>po</instance>
                            </dependent-instances>
                            <returnable-instances>
                                <instance>po</instance>
                            </returnable-instances>
                        </analysis>
                    </binding>
                    <value>
                        <analysis expression="string((.)[1])" analyzed="true">
                            <value-dependent>
                                <path>instance('po')/totals/tax</path>
                            </value-dependent>
                            <dependent-models>
                                <model>model</model>
                            </dependent-models>
                            <dependent-instances>
                                <instance>po</instance>
                            </dependent-instances>
                        </analysis>
                    </value>
                </output>
                <output scope="" prefixed-id="total" model-prefixed-id="model" binding="true" value="true">
                    <binding>
                        <analysis expression="totals/total" analyzed="true">
                            <returnable>
                                <path>instance('po')/totals/total</path>
                            </returnable>
                            <dependent-models>
                                <model>model</model>
                            </dependent-models>
                            <dependent-instances>
                                <instance>po</instance>
                            </dependent-instances>
                            <returnable-instances>
                                <instance>po</instance>
                            </returnable-instances>
                        </analysis>
                    </binding>
                    <value>
                        <analysis expression="string((.)[1])" analyzed="true">
                            <value-dependent>
                                <path>instance('po')/totals/total</path>
                            </value-dependent>
                            <dependent-models>
                                <model>model</model>
                            </dependent-models>
                            <dependent-instances>
                                <instance>po</instance>
                            </dependent-instances>
                        </analysis>
                    </value>
                </output>
            </root>
        </output>
    </test>

    <test description="PO example: change to values causing change to MIPs" name="oxf:pipeline">
        <input name="config" href="wrap-xforms-state.xpl"/>
        <input name="document" href="forms/po.xhtml"/>
        <output name="response">
            <xxf:event-response>
                <xxf:dynamic-state>
                    <dynamic-state>
                        <instances>
                            <instance id="po" model-id="model">
                                <purchaseOrder>
                                    <items>
                                        <item>
                                            <name>Item 1</name>
                                            <units>3</units>
                                            <price>60</price>
                                            <total>180</total>
                                        </item>
                                        <item>
                                            <name>Item 2</name>
                                            <units>1</units>
                                            <price>500</price>
                                            <total>500</total>
                                        </item>
                                        <item>
                                            <name>Item 3</name>
                                            <units>1</units>
                                            <price>1500</price>
                                            <total>1500</total>
                                        </item>
                                    </items>
                                    <totals>
                                        <subtotal>2180</subtotal>
                                        <tax>479.6</tax>
                                        <total>2393.64</total>
                                    </totals>
                                    <info>
                                        <tax>0.22</tax>
                                    </info>
                                </purchaseOrder>
                            </instance>
                            <instance id="events-instance" model-id="events-model">
                                <events>
                                    <event type="xforms-value-changed" target="price" indexes="1"/>
                                    <event type="xforms-invalid" target="price" indexes="1"/>
                                    <event type="xxforms-constraints-changed" target="price" indexes="1"/>
                                    <event type="xforms-value-changed" target="line-total" indexes="1"/>
                                    <event type="xforms-invalid" target="line-total" indexes="1"/>
                                    <event type="xxforms-constraints-changed" target="line-total" indexes="1"/>
                                    <event type="xforms-value-changed" target="subtotal" indexes=""/>
                                    <event type="xforms-value-changed" target="tax" indexes=""/>
                                    <event type="xforms-value-changed" target="total" indexes=""/>
                                    <event type="xforms-value-changed" target="price" indexes="1"/>
                                    <event type="xforms-valid" target="price" indexes="1"/>
                                    <event type="xxforms-constraints-changed" target="price" indexes="1"/>
                                    <event type="xforms-value-changed" target="line-total" indexes="1"/>
                                    <event type="xforms-valid" target="line-total" indexes="1"/>
                                    <event type="xxforms-constraints-changed" target="line-total" indexes="1"/>
                                    <event type="xforms-value-changed" target="subtotal" indexes=""/>
                                    <event type="xforms-value-changed" target="tax" indexes=""/>
                                    <event type="xforms-value-changed" target="total" indexes=""/>
                                </events>
                            </instance>
                        </instances>
                        <controls>
                            <control effective-id="item-repeat" index="1"/>
                        </controls>
                    </dynamic-state>
                </xxf:dynamic-state>
                <xxf:action>
                    <xxf:control-values>
                        <xxf:control id="name1" required="true" empty="false">
                            <xxf:value>Item 1</xxf:value>
                        </xxf:control>
                        <xxf:control id="units1" type="{http://www.w3.org/2001/XMLSchema}integer">
                            <xxf:value>3</xxf:value>
                        </xxf:control>
                        <xxf:control id="price1" type="{http://www.w3.org/2001/XMLSchema}decimal">
                            <xxf:value>60</xxf:value>
                        </xxf:control>
                        <xxf:control id="line-total1" readonly="true">
                            <xxf:value>180.00</xxf:value>
                        </xxf:control>
                        <xxf:control id="name2" required="true" empty="false">
                            <xxf:value>Item 2</xxf:value>
                        </xxf:control>
                        <xxf:control id="units2" type="{http://www.w3.org/2001/XMLSchema}integer">
                            <xxf:value>1</xxf:value>
                        </xxf:control>
                        <xxf:control id="price2" type="{http://www.w3.org/2001/XMLSchema}decimal">
                            <xxf:value>500</xxf:value>
                        </xxf:control>
                        <xxf:control id="line-total2" readonly="true">
                            <xxf:value>500.00</xxf:value>
                        </xxf:control>
                        <xxf:control id="name3" required="true" empty="false">
                            <xxf:value>Item 3</xxf:value>
                        </xxf:control>
                        <xxf:control id="units3" type="{http://www.w3.org/2001/XMLSchema}integer">
                            <xxf:value>1</xxf:value>
                        </xxf:control>
                        <xxf:control id="price3" type="{http://www.w3.org/2001/XMLSchema}decimal">
                            <xxf:value>1500</xxf:value>
                        </xxf:control>
                        <xxf:control id="line-total3" readonly="true">
                            <xxf:value>1,500.00</xxf:value>
                        </xxf:control>
                        <xxf:control id="subtotal" readonly="true">
                            <xxf:value>2,180.00</xxf:value>
                        </xxf:control>
                        <xxf:control id="tax" readonly="true">
                            <xxf:value>479.60</xxf:value>
                        </xxf:control>
                        <xxf:control id="total" readonly="true">
                            <xxf:value>2,393.64</xxf:value>
                        </xxf:control>
                    </xxf:control-values>
                </xxf:action>
            </xxf:event-response>
        </output>
    </test>

    <test description="Simple use of last() function" name="oxf:xforms-xpath-analysis">
        <input name="form">
            <xh:html xmlns:exf="http://www.exforms.org/exf/1-0" xmlns:xxbl="http://orbeon.org/oxf/xml/xbl">
                <xh:head>
                    <xf:model xxf:xpath-analysis="true" id="model">
                        <xf:instance id="i1">
                            <instance/>
                        </xf:instance>
                    </xf:model>
                </xh:head>
                <xh:body>
                    <xf:output id="01" value="a[last()]/b"/>
                </xh:body>
            </xh:html>
        </input>
        <output name="analysis">
            <root scope="" prefixed-id="#document" model-prefixed-id="model" binding="false" value="false">
                <model scope="" prefixed-id="model" default-instance-prefixed-id="i1" analyzed-binds="true">
                    <instance scope="" prefixed-id="i1" model-prefixed-id="model" binding="false" value="false"/>
                </model>
                <output scope="" prefixed-id="01" model-prefixed-id="model" binding="false" value="true">
                    <value>
                        <analysis expression="string((a[last()]/b)[1])" analyzed="true">
                            <value-dependent>
                                <path>instance('i1')/a/b</path>
                            </value-dependent>
                            <dependent-models>
                                <model>model</model>
                            </dependent-models>
                            <dependent-instances>
                                <instance>i1</instance>
                            </dependent-instances>
                        </analysis>
                    </value>
                </output>
            </root>
        </output>
    </test>

    <test description="Simple use of xxf:context() function" name="oxf:xforms-xpath-analysis">
        <input name="form">
            <xh:html xmlns:exf="http://www.exforms.org/exf/1-0" xmlns:xxbl="http://orbeon.org/oxf/xml/xbl">
                <xh:head>
                    <xf:model xxf:xpath-analysis="true" id="model">
                        <xf:instance id="i1">
                            <instance>
                                <foo/>
                                <bar/>
                            </instance>
                        </xf:instance>
                        <xf:instance id="i2">
                            <instance>
                                <foo/>
                                <bar/>
                            </instance>
                        </xf:instance>
                        <xf:instance id="i3">
                            <instance>
                                <foo/>
                                <bar/>
                            </instance>
                        </xf:instance>
                    </xf:model>
                </xh:head>
                <xh:body>
                    <xf:group id="g1" ref="instance()/foo">
                        <xf:group id="g2" ref="instance('i2')/foo">
                            <xf:group id="g3" ref="instance('i3')/foo">
                                <xf:output id="o1" value="xxf:context('g1')/../bar"/>
                                <xf:output id="o2" value="xxf:context('g2')/../bar"/>
                                <xf:output id="o3" value="xxf:context('g3')/../bar"/>

                                <xf:output id="o4" value="xxf:context('o4')/../bar"/>
                            </xf:group>
                        </xf:group>
                    </xf:group>
                </xh:body>
            </xh:html>
        </input>
        <output name="analysis">
            <root scope="" prefixed-id="#document" model-prefixed-id="model" binding="false" value="false">
                <model scope="" prefixed-id="model" default-instance-prefixed-id="i1" analyzed-binds="true">
                    <instance scope="" prefixed-id="i1" model-prefixed-id="model" binding="false" value="false"/>
                    <instance scope="" prefixed-id="i2" model-prefixed-id="model" binding="false" value="false"/>
                    <instance scope="" prefixed-id="i3" model-prefixed-id="model" binding="false" value="false"/>
                </model>
                <group scope="" prefixed-id="g1" model-prefixed-id="model" binding="true" value="false">
                    <binding>
                        <analysis expression="instance()/foo" analyzed="true">
                            <returnable>
                                <path>instance('i1')/foo</path>
                            </returnable>
                            <dependent-models>
                                <model>model</model>
                            </dependent-models>
                            <dependent-instances>
                                <instance>i1</instance>
                            </dependent-instances>
                            <returnable-instances>
                                <instance>i1</instance>
                            </returnable-instances>
                        </analysis>
                    </binding>
                    <group scope="" prefixed-id="g2" model-prefixed-id="model" binding="true" value="false">
                        <binding>
                            <analysis expression="instance('i2')/foo" analyzed="true">
                                <returnable>
                                    <path>instance('i2')/foo</path>
                                </returnable>
                                <dependent-models>
                                    <model>model</model>
                                </dependent-models>
                                <dependent-instances>
                                    <instance>i2</instance>
                                </dependent-instances>
                                <returnable-instances>
                                    <instance>i2</instance>
                                </returnable-instances>
                            </analysis>
                        </binding>
                        <group scope="" prefixed-id="g3" model-prefixed-id="model" binding="true" value="false">
                            <binding>
                                <analysis expression="instance('i3')/foo" analyzed="true">
                                    <returnable>
                                        <path>instance('i3')/foo</path>
                                    </returnable>
                                    <dependent-models>
                                        <model>model</model>
                                    </dependent-models>
                                    <dependent-instances>
                                        <instance>i3</instance>
                                    </dependent-instances>
                                    <returnable-instances>
                                        <instance>i3</instance>
                                    </returnable-instances>
                                </analysis>
                            </binding>
                            <output scope="" prefixed-id="o1" model-prefixed-id="model" binding="false" value="true">
                                <value>
                                    <analysis expression="string((xxf:context('g1')/../bar)[1])" analyzed="true">
                                        <value-dependent>
                                            <path>instance('i1')/bar</path>
                                        </value-dependent>
                                        <dependent-models>
                                            <model>model</model>
                                        </dependent-models>
                                        <dependent-instances>
                                            <instance>i1</instance>
                                        </dependent-instances>
                                    </analysis>
                                </value>
                            </output>
                            <output scope="" prefixed-id="o2" model-prefixed-id="model" binding="false" value="true">
                                <value>
                                    <analysis expression="string((xxf:context('g2')/../bar)[1])" analyzed="true">
                                        <value-dependent>
                                            <path>instance('i2')/bar</path>
                                        </value-dependent>
                                        <dependent-models>
                                            <model>model</model>
                                        </dependent-models>
                                        <dependent-instances>
                                            <instance>i2</instance>
                                        </dependent-instances>
                                    </analysis>
                                </value>
                            </output>
                            <output scope="" prefixed-id="o3" model-prefixed-id="model" binding="false" value="true">
                                <value>
                                    <analysis expression="string((xxf:context('g3')/../bar)[1])" analyzed="true">
                                        <value-dependent>
                                            <path>instance('i3')/bar</path>
                                        </value-dependent>
                                        <dependent-models>
                                            <model>model</model>
                                        </dependent-models>
                                        <dependent-instances>
                                            <instance>i3</instance>
                                        </dependent-instances>
                                    </analysis>
                                </value>
                            </output>
                            <output scope="" prefixed-id="o4" model-prefixed-id="model" binding="false" value="true">
                                <value>
                                    <analysis expression="string((xxf:context('o4')/../bar)[1])" analyzed="true">
                                        <value-dependent>
                                            <path>instance('i3')/bar</path>
                                        </value-dependent>
                                        <dependent-models>
                                            <model>model</model>
                                        </dependent-models>
                                        <dependent-instances>
                                            <instance>i3</instance>
                                        </dependent-instances>
                                    </analysis>
                                </value>
                            </output>
                        </group>
                    </group>
                </group>
            </root>
        </output>
    </test>

    <test description="context() function" name="oxf:xforms-xpath-analysis">
        <input name="form">
            <xh:html xmlns:exf="http://www.exforms.org/exf/1-0" xmlns:xxbl="http://orbeon.org/oxf/xml/xbl">
                <xh:head>
                    <xf:model xxf:xpath-analysis="true" id="model">
                        <xf:instance id="i1">
                            <instance/>
                        </xf:instance>
                        <xf:instance id="i2">
                            <instance/>
                        </xf:instance>
                    </xf:model>
                </xh:head>
                <xh:body>
                    <xf:output id="o1" value="context()"/>
                    <!-- Group w/ ref -->
                    <xf:group id="g1" ref="instance()/foo">
                        <xf:output id="o2" value="context()"/>
                        <!-- Group w/ ref to other instance -->
                        <xf:group id="g2" ref="instance('i2')/bar">
                            <xf:output id="o3" value="context()"/>
                            <!-- Group w/o ref -->
                            <xf:group id="g3">
                                <xf:output id="o4" value="baz[context() = instance('i1')]"/>
                            </xf:group>
                            <!-- Group w/ context -->
                            <xf:group id="g4" context="toto">
                                <xf:output id="o5" value="baz[context() = instance('i1')]"/>
                            </xf:group>
                            <!-- Group w/ context and ref -->
                            <xf:group id="g5" context="toto" ref="gaga">
                                <xf:output id="o6" value="baz[context() = instance('i1')]"/>
                            </xf:group>
                        </xf:group>
                    </xf:group>
                    <!-- Repeat -->
                    <xf:repeat id="r1" ref="item">
                        <xf:output id="o7" value="context()"/>
                    </xf:repeat>
                </xh:body>
            </xh:html>
        </input>
        <output name="analysis">
            <root scope="" prefixed-id="#document" model-prefixed-id="model" binding="false" value="false">
                <model scope="" prefixed-id="model" default-instance-prefixed-id="i1" analyzed-binds="true">
                    <instance scope="" prefixed-id="i1" model-prefixed-id="model" binding="false" value="false"/>
                    <instance scope="" prefixed-id="i2" model-prefixed-id="model" binding="false" value="false"/>
                </model>
                <output scope="" prefixed-id="o1" model-prefixed-id="model" binding="false" value="true">
                    <value>
                        <analysis expression="string((context())[1])" analyzed="true">
                            <value-dependent>
                                <path>instance('i1')</path>
                            </value-dependent>
                            <dependent-models>
                                <model>model</model>
                            </dependent-models>
                            <dependent-instances>
                                <instance>i1</instance>
                            </dependent-instances>
                        </analysis>
                    </value>
                </output>
                <group scope="" prefixed-id="g1" model-prefixed-id="model" binding="true" value="false">
                    <binding>
                        <analysis expression="instance()/foo" analyzed="true">
                            <returnable>
                                <path>instance('i1')/foo</path>
                            </returnable>
                            <dependent-models>
                                <model>model</model>
                            </dependent-models>
                            <dependent-instances>
                                <instance>i1</instance>
                            </dependent-instances>
                            <returnable-instances>
                                <instance>i1</instance>
                            </returnable-instances>
                        </analysis>
                    </binding>
                    <output scope="" prefixed-id="o2" model-prefixed-id="model" binding="false" value="true">
                        <value>
                            <analysis expression="string((context())[1])" analyzed="true">
                                <value-dependent>
                                    <path>instance('i1')/foo</path>
                                </value-dependent>
                                <dependent-models>
                                    <model>model</model>
                                </dependent-models>
                                <dependent-instances>
                                    <instance>i1</instance>
                                </dependent-instances>
                            </analysis>
                        </value>
                    </output>
                    <group scope="" prefixed-id="g2" model-prefixed-id="model" binding="true" value="false">
                        <binding>
                            <analysis expression="instance('i2')/bar" analyzed="true">
                                <returnable>
                                    <path>instance('i2')/bar</path>
                                </returnable>
                                <dependent-models>
                                    <model>model</model>
                                </dependent-models>
                                <dependent-instances>
                                    <instance>i2</instance>
                                </dependent-instances>
                                <returnable-instances>
                                    <instance>i2</instance>
                                </returnable-instances>
                            </analysis>
                        </binding>
                        <output scope="" prefixed-id="o3" model-prefixed-id="model" binding="false" value="true">
                            <value>
                                <analysis expression="string((context())[1])" analyzed="true">
                                    <value-dependent>
                                        <path>instance('i2')/bar</path>
                                    </value-dependent>
                                    <dependent-models>
                                        <model>model</model>
                                    </dependent-models>
                                    <dependent-instances>
                                        <instance>i2</instance>
                                    </dependent-instances>
                                </analysis>
                            </value>
                        </output>
                        <group scope="" prefixed-id="g3" model-prefixed-id="model" binding="false" value="false">
                            <output scope="" prefixed-id="o4" model-prefixed-id="model" binding="false" value="true">
                                <value>
                                    <analysis expression="string((baz[context() = instance('i1')])[1])" analyzed="true">
                                        <value-dependent>
                                            <path>instance('i2')/bar/baz</path>
                                            <path>instance('i2')/bar</path>
                                            <path>instance('i1')</path>
                                        </value-dependent>
                                        <dependent-models>
                                            <model>model</model>
                                        </dependent-models>
                                        <dependent-instances>
                                            <instance>i2</instance>
                                            <instance>i1</instance>
                                        </dependent-instances>
                                    </analysis>
                                </value>
                            </output>
                        </group>
                        <group scope="" prefixed-id="g4" model-prefixed-id="model" binding="false" value="false">
                            <output scope="" prefixed-id="o5" model-prefixed-id="model" binding="false" value="true">
                                <value>
                                    <analysis expression="string((baz[context() = instance('i1')])[1])" analyzed="true">
                                        <value-dependent>
                                            <path>instance('i2')/bar/toto/baz</path>
                                            <path>instance('i2')/bar/toto</path>
                                            <path>instance('i1')</path>
                                        </value-dependent>
                                        <dependent-models>
                                            <model>model</model>
                                        </dependent-models>
                                        <dependent-instances>
                                            <instance>i2</instance>
                                            <instance>i1</instance>
                                        </dependent-instances>
                                    </analysis>
                                </value>
                            </output>
                        </group>
                        <group scope="" prefixed-id="g5" model-prefixed-id="model" binding="true" value="false">
                            <binding>
                                <analysis expression="gaga" analyzed="true">
                                    <returnable>
                                        <path>instance('i2')/bar/toto/gaga</path>
                                    </returnable>
                                    <dependent-models>
                                        <model>model</model>
                                    </dependent-models>
                                    <dependent-instances>
                                        <instance>i2</instance>
                                    </dependent-instances>
                                    <returnable-instances>
                                        <instance>i2</instance>
                                    </returnable-instances>
                                </analysis>
                            </binding>
                            <output scope="" prefixed-id="o6" model-prefixed-id="model" binding="false" value="true">
                                <value>
                                    <analysis expression="string((baz[context() = instance('i1')])[1])" analyzed="true">
                                        <value-dependent>
                                            <path>instance('i2')/bar/toto/gaga/baz</path>
                                            <path>instance('i2')/bar/toto/gaga</path>
                                            <path>instance('i1')</path>
                                        </value-dependent>
                                        <dependent-models>
                                            <model>model</model>
                                        </dependent-models>
                                        <dependent-instances>
                                            <instance>i2</instance>
                                            <instance>i1</instance>
                                        </dependent-instances>
                                    </analysis>
                                </value>
                            </output>
                        </group>
                    </group>
                </group>
                <repeat scope="" prefixed-id="r1" model-prefixed-id="model" binding="true" value="false">
                    <binding>
                        <analysis expression="item" analyzed="true">
                            <returnable>
                                <path>instance('i1')/item</path>
                            </returnable>
                            <dependent-models>
                                <model>model</model>
                            </dependent-models>
                            <dependent-instances>
                                <instance>i1</instance>
                            </dependent-instances>
                            <returnable-instances>
                                <instance>i1</instance>
                            </returnable-instances>
                        </analysis>
                    </binding>
                    <repeat-iteration scope="" prefixed-id="r1~iteration" model-prefixed-id="model" binding="false" value="false">
                        <output scope="" prefixed-id="o7" model-prefixed-id="model" binding="false" value="true">
                            <value>
                                <analysis expression="string((context())[1])" analyzed="true">
                                    <value-dependent>
                                        <path>instance('i1')/item</path>
                                    </value-dependent>
                                    <dependent-models>
                                        <model>model</model>
                                    </dependent-models>
                                    <dependent-instances>
                                        <instance>i1</instance>
                                    </dependent-instances>
                                </analysis>
                            </value>
                        </output>
                    </repeat-iteration>
                </repeat>
            </root>
        </output>
    </test>

    <test description="Simple use of xxf:repeat-current() function" name="oxf:xforms-xpath-analysis">
        <input name="form">
            <xh:html xmlns:exf="http://www.exforms.org/exf/1-0" xmlns:xxbl="http://orbeon.org/oxf/xml/xbl">
                <xh:head>
                    <xf:model xxf:xpath-analysis="true" id="model">
                        <xf:instance id="i1">
                            <instance/>
                        </xf:instance>
                        <xf:instance id="i2">
                            <instance/>
                        </xf:instance>
                    </xf:model>
                </xh:head>
                <xh:body>
                    <xf:repeat id="r1" ref="instance()/foo">
                        <xf:repeat id="r2" ref="instance('i2')/foo">
                            <xf:output id="o1" value="xxf:repeat-current('r1')/../bar"/>
                            <xf:output id="o2" value="xxf:repeat-current('r2')/../bar"/>
                            <xf:output id="o3" value="xxf:repeat-current()/../bar"/>
                            <xf:output id="o4" value="gaga[toto = xxf:repeat-current('r1')]"/>
                            <xf:output id="o5" value="gaga[toto = xxf:repeat-current('r2')]"/>
                            <xf:output id="o6" value="gaga[toto = xxf:repeat-current()]"/>
                        </xf:repeat>
                    </xf:repeat>
                </xh:body>
            </xh:html>
        </input>
        <output name="analysis">
            <root scope="" prefixed-id="#document" model-prefixed-id="model" binding="false" value="false">
                <model scope="" prefixed-id="model" default-instance-prefixed-id="i1" analyzed-binds="true">
                    <instance scope="" prefixed-id="i1" model-prefixed-id="model" binding="false" value="false"/>
                    <instance scope="" prefixed-id="i2" model-prefixed-id="model" binding="false" value="false"/>
                </model>
                <repeat scope="" prefixed-id="r1" model-prefixed-id="model" binding="true" value="false">
                    <binding>
                        <analysis expression="instance()/foo" analyzed="true">
                            <returnable>
                                <path>instance('i1')/foo</path>
                            </returnable>
                            <dependent-models>
                                <model>model</model>
                            </dependent-models>
                            <dependent-instances>
                                <instance>i1</instance>
                            </dependent-instances>
                            <returnable-instances>
                                <instance>i1</instance>
                            </returnable-instances>
                        </analysis>
                    </binding>
                    <repeat-iteration scope="" prefixed-id="r1~iteration" model-prefixed-id="model" binding="false" value="false">
                        <repeat scope="" prefixed-id="r2" model-prefixed-id="model" binding="true" value="false">
                            <binding>
                                <analysis expression="instance('i2')/foo" analyzed="true">
                                    <returnable>
                                        <path>instance('i2')/foo</path>
                                    </returnable>
                                    <dependent-models>
                                        <model>model</model>
                                    </dependent-models>
                                    <dependent-instances>
                                        <instance>i2</instance>
                                    </dependent-instances>
                                    <returnable-instances>
                                        <instance>i2</instance>
                                    </returnable-instances>
                                </analysis>
                            </binding>
                            <repeat-iteration scope="" prefixed-id="r2~iteration" model-prefixed-id="model" binding="false" value="false">
                                <output scope="" prefixed-id="o1" model-prefixed-id="model" binding="false" value="true">
                                    <value>
                                        <analysis expression="string((xxf:repeat-current('r1')/../bar)[1])" analyzed="true">
                                            <value-dependent>
                                                <path>instance('i1')/bar</path>
                                            </value-dependent>
                                            <dependent-models>
                                                <model>model</model>
                                            </dependent-models>
                                            <dependent-instances>
                                                <instance>i1</instance>
                                            </dependent-instances>
                                        </analysis>
                                    </value>
                                </output>
                                <output scope="" prefixed-id="o2" model-prefixed-id="model" binding="false" value="true">
                                    <value>
                                        <analysis expression="string((xxf:repeat-current('r2')/../bar)[1])" analyzed="true">
                                            <value-dependent>
                                                <path>instance('i2')/bar</path>
                                            </value-dependent>
                                            <dependent-models>
                                                <model>model</model>
                                            </dependent-models>
                                            <dependent-instances>
                                                <instance>i2</instance>
                                            </dependent-instances>
                                        </analysis>
                                    </value>
                                </output>
                                <output scope="" prefixed-id="o3" model-prefixed-id="model" binding="false" value="true">
                                    <value>
                                        <analysis expression="string((xxf:repeat-current()/../bar)[1])" analyzed="true">
                                            <value-dependent>
                                                <path>instance('i2')/bar</path>
                                            </value-dependent>
                                            <dependent-models>
                                                <model>model</model>
                                            </dependent-models>
                                            <dependent-instances>
                                                <instance>i2</instance>
                                            </dependent-instances>
                                        </analysis>
                                    </value>
                                </output>
                                <output scope="" prefixed-id="o4" model-prefixed-id="model" binding="false" value="true">
                                    <value>
                                        <analysis expression="string((gaga[toto = xxf:repeat-current('r1')])[1])" analyzed="true">
                                            <value-dependent>
                                                <path>instance('i2')/foo/gaga</path>
                                                <path>instance('i2')/foo/gaga/toto</path>
                                                <path>instance('i1')/foo</path>
                                            </value-dependent>
                                            <dependent-models>
                                                <model>model</model>
                                            </dependent-models>
                                            <dependent-instances>
                                                <instance>i2</instance>
                                                <instance>i1</instance>
                                            </dependent-instances>
                                        </analysis>
                                    </value>
                                </output>
                                <output scope="" prefixed-id="o5" model-prefixed-id="model" binding="false" value="true">
                                    <value>
                                        <analysis expression="string((gaga[toto = xxf:repeat-current('r2')])[1])" analyzed="true">
                                            <value-dependent>
                                                <path>instance('i2')/foo/gaga</path>
                                                <path>instance('i2')/foo/gaga/toto</path>
                                                <path>instance('i2')/foo</path>
                                            </value-dependent>
                                            <dependent-models>
                                                <model>model</model>
                                            </dependent-models>
                                            <dependent-instances>
                                                <instance>i2</instance>
                                            </dependent-instances>
                                        </analysis>
                                    </value>
                                </output>
                                <output scope="" prefixed-id="o6" model-prefixed-id="model" binding="false" value="true">
                                    <value>
                                        <analysis expression="string((gaga[toto = xxf:repeat-current()])[1])" analyzed="true">
                                            <value-dependent>
                                                <path>instance('i2')/foo/gaga</path>
                                                <path>instance('i2')/foo/gaga/toto</path>
                                                <path>instance('i2')/foo</path>
                                            </value-dependent>
                                            <dependent-models>
                                                <model>model</model>
                                            </dependent-models>
                                            <dependent-instances>
                                                <instance>i2</instance>
                                            </dependent-instances>
                                        </analysis>
                                    </value>
                                </output>
                            </repeat-iteration>
                        </repeat>
                    </repeat-iteration>
                </repeat>
            </root>
        </output>
    </test>

    <test description="Simple use of xxf:serialize() function" name="oxf:xforms-xpath-analysis">
        <input name="form">
            <xh:html xmlns:exf="http://www.exforms.org/exf/1-0" xmlns:xxbl="http://orbeon.org/oxf/xml/xbl">
                <xh:head>
                    <xf:model xxf:xpath-analysis="true" id="model">
                        <xf:instance id="i1">
                            <instance/>
                        </xf:instance>
                        <xf:instance id="i2">
                            <instance/>
                        </xf:instance>
                    </xf:model>
                </xh:head>
                <xh:body>
                    <xf:output id="o1" value="xxf:serialize(instance()/foo/bar, 'xml')"/>
                    <xf:output id="o2" value="xxf:serialize(instance('i2')/foo/bar, 'html')"/>
                    <xf:output id="o3" value="xxf:serialize(instance()/foo/bar, instance('i2')/gaga)"/>
                </xh:body>
            </xh:html>
        </input>
        <output name="analysis">
            <root scope="" prefixed-id="#document" model-prefixed-id="model" binding="false" value="false">
                <model scope="" prefixed-id="model" default-instance-prefixed-id="i1" analyzed-binds="true">
                    <instance scope="" prefixed-id="i1" model-prefixed-id="model" binding="false" value="false"/>
                    <instance scope="" prefixed-id="i2" model-prefixed-id="model" binding="false" value="false"/>
                </model>
                <output scope="" prefixed-id="o1" model-prefixed-id="model" binding="false" value="true">
                    <value>
                        <analysis expression="string((xxf:serialize(instance()/foo/bar, 'xml'))[1])" analyzed="true">
                            <value-dependent>
                                <path>instance('i1')/foo/bar</path>
                            </value-dependent>
                            <dependent-models>
                                <model>model</model>
                            </dependent-models>
                            <dependent-instances>
                                <instance>i1</instance>
                            </dependent-instances>
                        </analysis>
                    </value>
                </output>
                <output scope="" prefixed-id="o2" model-prefixed-id="model" binding="false" value="true">
                    <value>
                        <analysis expression="string((xxf:serialize(instance('i2')/foo/bar, 'html'))[1])" analyzed="true">
                            <value-dependent>
                                <path>instance('i2')/foo/bar</path>
                            </value-dependent>
                            <dependent-models>
                                <model>model</model>
                            </dependent-models>
                            <dependent-instances>
                                <instance>i2</instance>
                            </dependent-instances>
                        </analysis>
                    </value>
                </output>
                <output scope="" prefixed-id="o3" model-prefixed-id="model" binding="false" value="true">
                    <value>
                        <analysis expression="string((xxf:serialize(instance()/foo/bar, instance('i2')/gaga))[1])" analyzed="true">
                            <value-dependent>
                                <path>instance('i1')/foo/bar</path>
                                <path>instance('i2')/gaga</path>
                            </value-dependent>
                            <dependent-models>
                                <model>model</model>
                            </dependent-models>
                            <dependent-instances>
                                <instance>i1</instance>
                                <instance>i2</instance>
                            </dependent-instances>
                        </analysis>
                    </value>
                </output>
            </root>
        </output>
    </test>

    <test description="Expressions containing AtomicMappingExpression such as a/count(b) or a/sum(b)" name="oxf:xforms-xpath-analysis">
        <!-- See: http://forge.ow2.org/tracker/index.php?func=detail&aid=315523&group_id=168&atid=350207 -->
        <input name="form">
            <xh:html>
                <xh:head>
                    <xf:model id="model" xxf:xpath-analysis="true">
                        <xf:instance id="instance">
                            <instance/>
                        </xf:instance>
                    </xf:model>
                </xh:head>
                <xh:body>
                    <xf:output id="o11" value="a/count(b)"/>
                    <xf:output id="o12" value="a/count(following-sibling::b)"/>
                    <xf:output id="o13" value="a/count(preceding-sibling::b)"/>
                    <xf:output id="o14" value="a/count(self::a)"/>
                    <xf:output id="o15" value="a/b/count(ancestor::a)"/>

                    <xf:output id="o21" value="a/sum(b)"/>
                    <xf:output id="o22" value="a/sum(following-sibling::b)"/>
                    <xf:output id="o23" value="a/sum(preceding-sibling::b)"/>
                    <xf:output id="o24" value="a/sum(self::a)"/>
                    <xf:output id="o25" value="a/b/sum(ancestor::a)"/>
                </xh:body>
            </xh:html>
        </input>
        <output name="analysis">
            <root scope="" prefixed-id="#document" model-prefixed-id="model" binding="false" value="false">
                <model scope="" prefixed-id="model" default-instance-prefixed-id="instance" analyzed-binds="true">
                    <instance scope="" prefixed-id="instance" model-prefixed-id="model" binding="false" value="false"/>
                </model>
                <output scope="" prefixed-id="o11" model-prefixed-id="model" binding="false" value="true">
                    <value>
                        <analysis expression="string((a/count(b))[1])" analyzed="true">
                            <dependent-models>
                                <model>model</model>
                            </dependent-models>
                            <dependent-instances>
                                <instance>instance</instance>
                            </dependent-instances>
                        </analysis>
                    </value>
                </output>
                <output scope="" prefixed-id="o12" model-prefixed-id="model" binding="false" value="true">
                    <value>
                        <analysis expression="string((a/count(following-sibling::b))[1])" analyzed="true">
                            <dependent-models>
                                <model>model</model>
                            </dependent-models>
                            <dependent-instances>
                                <instance>instance</instance>
                            </dependent-instances>
                        </analysis>
                    </value>
                </output>
                <output scope="" prefixed-id="o13" model-prefixed-id="model" binding="false" value="true">
                    <value>
                        <analysis expression="string((a/count(preceding-sibling::b))[1])" analyzed="true">
                            <dependent-models>
                                <model>model</model>
                            </dependent-models>
                            <dependent-instances>
                                <instance>instance</instance>
                            </dependent-instances>
                        </analysis>
                    </value>
                </output>
                <output scope="" prefixed-id="o14" model-prefixed-id="model" binding="false" value="true">
                    <value>
                        <analysis expression="string((a/count(self::a))[1])" analyzed="true">
                            <dependent-models>
                                <model>model</model>
                            </dependent-models>
                            <dependent-instances>
                                <instance>instance</instance>
                            </dependent-instances>
                        </analysis>
                    </value>
                </output>
                <output scope="" prefixed-id="o15" model-prefixed-id="model" binding="false" value="true">
                    <value>
                        <analysis expression="string((a/b/count(ancestor::a))[1])" analyzed="true">
                            <dependent-models>
                                <model>model</model>
                            </dependent-models>
                            <dependent-instances>
                                <instance>instance</instance>
                            </dependent-instances>
                        </analysis>
                    </value>
                </output>
                <output scope="" prefixed-id="o21" model-prefixed-id="model" binding="false" value="true">
                    <value>
                        <analysis expression="string((a/sum(b))[1])" analyzed="true">
                            <value-dependent>
                                <path>instance('instance')/a/b</path>
                            </value-dependent>
                            <dependent-models>
                                <model>model</model>
                            </dependent-models>
                            <dependent-instances>
                                <instance>instance</instance>
                            </dependent-instances>
                        </analysis>
                    </value>
                </output>
                <output scope="" prefixed-id="o22" model-prefixed-id="model" binding="false" value="true">
                    <value>
                        <analysis expression="string((a/sum(following-sibling::b))[1])" analyzed="true">
                            <value-dependent>
                                <path>instance('instance')/b</path>
                            </value-dependent>
                            <dependent-models>
                                <model>model</model>
                            </dependent-models>
                            <dependent-instances>
                                <instance>instance</instance>
                            </dependent-instances>
                        </analysis>
                    </value>
                </output>
                <output scope="" prefixed-id="o23" model-prefixed-id="model" binding="false" value="true">
                    <value>
                        <analysis expression="string((a/sum(preceding-sibling::b))[1])" analyzed="true">
                            <value-dependent>
                                <path>instance('instance')/b</path>
                            </value-dependent>
                            <dependent-models>
                                <model>model</model>
                            </dependent-models>
                            <dependent-instances>
                                <instance>instance</instance>
                            </dependent-instances>
                        </analysis>
                    </value>
                </output>
                <output scope="" prefixed-id="o24" model-prefixed-id="model" binding="false" value="true">
                    <value>
                        <analysis expression="string((a/sum(self::a))[1])" analyzed="true">
                            <value-dependent>
                                <path>instance('instance')/a</path>
                            </value-dependent>
                            <dependent-models>
                                <model>model</model>
                            </dependent-models>
                            <dependent-instances>
                                <instance>instance</instance>
                            </dependent-instances>
                        </analysis>
                    </value>
                </output>
                <output scope="" prefixed-id="o25" model-prefixed-id="model" binding="false" value="true">
                    <value>
                        <analysis expression="string((a/b/sum(ancestor::a))[1])" analyzed="true">
                            <value-dependent>
                                <path>instance('instance')/a</path>
                            </value-dependent>
                            <dependent-models>
                                <model>model</model>
                            </dependent-models>
                            <dependent-instances>
                                <instance>instance</instance>
                            </dependent-instances>
                        </analysis>
                    </value>
                </output>
            </root>
        </output>
    </test>

    <test description="Logging of paths containing attributes" name="oxf:xforms-xpath-analysis">
        <input name="form">
            <xh:html>
                <xh:head>
                    <xf:model id="model" xxf:xpath-analysis="true">
                        <xf:instance id="instance">
                            <instance/>
                        </xf:instance>
                    </xf:model>
                </xh:head>
                <xh:body>
                    <xf:output id="o11" value="@a"/>
                </xh:body>
            </xh:html>
        </input>
        <output name="analysis">
            <root scope="" prefixed-id="#document" model-prefixed-id="model" binding="false" value="false">
                <model scope="" prefixed-id="model" default-instance-prefixed-id="instance" analyzed-binds="true">
                    <instance scope="" prefixed-id="instance" model-prefixed-id="model" binding="false" value="false"/>
                </model>
                <output scope="" prefixed-id="o11" model-prefixed-id="model" binding="false" value="true">
                    <value>
                        <analysis expression="string((@a)[1])" analyzed="true">
                            <value-dependent>
                                <path>instance('instance')/@a</path>
                            </value-dependent>
                            <dependent-models>
                                <model>model</model>
                            </dependent-models>
                            <dependent-instances>
                                <instance>instance</instance>
                            </dependent-instances>
                        </analysis>
                    </value>
                </output>
            </root>
        </output>
    </test>

    <test description="Simple use of position() function" name="oxf:xforms-xpath-analysis">
        <input name="form">
            <xh:html>
                <xh:head>
                    <xf:model id="model" xxf:xpath-analysis="true">
                        <xf:instance id="instance">
                            <instance/>
                        </xf:instance>
                    </xf:model>
                </xh:head>
                <xh:body>
                    <xf:output id="o11" value="position()"/>
                    <xf:output id="o12" value="a/position()"/>
                    <xf:output id="o13" value="a[position() = 1]"/>
                    <xf:output id="o14" value="a[position() = @p]"/>
                </xh:body>
            </xh:html>
        </input>
        <output name="analysis">
            <!-- NOTE: For now there is no information which would allow us to determine whether the position as changed -->
            <root scope="" prefixed-id="#document" model-prefixed-id="model" binding="false" value="false">
                <model scope="" prefixed-id="model" default-instance-prefixed-id="instance" analyzed-binds="true">
                    <instance scope="" prefixed-id="instance" model-prefixed-id="model" binding="false" value="false"/>
                </model>
                <output scope="" prefixed-id="o11" model-prefixed-id="model" binding="false" value="true">
                    <value>
                        <analysis expression="string((position())[1])" analyzed="true">
                            <dependent-models>
                                <model>model</model>
                            </dependent-models>
                            <dependent-instances>
                                <instance>instance</instance>
                            </dependent-instances>
                        </analysis>
                    </value>
                </output>
                <output scope="" prefixed-id="o12" model-prefixed-id="model" binding="false" value="true">
                    <value>
                        <analysis expression="string((a/position())[1])" analyzed="true">
                            <dependent-models>
                                <model>model</model>
                            </dependent-models>
                            <dependent-instances>
                                <instance>instance</instance>
                            </dependent-instances>
                        </analysis>
                    </value>
                </output>
                <output scope="" prefixed-id="o13" model-prefixed-id="model" binding="false" value="true">
                    <value>
                        <analysis expression="string((a[position() = 1])[1])" analyzed="true">
                            <value-dependent>
                                <path>instance('instance')/a</path>
                            </value-dependent>
                            <dependent-models>
                                <model>model</model>
                            </dependent-models>
                            <dependent-instances>
                                <instance>instance</instance>
                            </dependent-instances>
                        </analysis>
                    </value>
                </output>
                <output scope="" prefixed-id="o14" model-prefixed-id="model" binding="false" value="true">
                    <value>
                        <analysis expression="string((a[position() = @p])[1])" analyzed="true">
                            <value-dependent>
                                <path>instance('instance')/a</path>
                                <path>instance('instance')/a/@p</path>
                            </value-dependent>
                            <dependent-models>
                                <model>model</model>
                            </dependent-models>
                            <dependent-instances>
                                <instance>instance</instance>
                            </dependent-instances>
                        </analysis>
                    </value>
                </output>
            </root>
        </output>
    </test>

    <test description="Bind referring to model variables" name="oxf:xforms-xpath-analysis">
        <input name="form">
            <xh:html>
                <xh:head>
                    <xf:model id="model" xxf:xpath-analysis="true">
                        <xf:instance id="instance">
                            <instance/>
                        </xf:instance>
                        <xf:var id="v1" name="foo" value="instance()/a"/>
                        <xf:bind id="b1" ref="$foo"/>
                        <xf:bind id="b2" ref="." relevant="$foo = 42"/>
                    </xf:model>
                </xh:head>
            </xh:html>
        </input>
        <output name="analysis">
            <root scope="" prefixed-id="#document" model-prefixed-id="model" binding="false" value="false">
                <model scope="" prefixed-id="model" default-instance-prefixed-id="instance" analyzed-binds="true">
                    <instance scope="" prefixed-id="instance" model-prefixed-id="model" binding="false" value="false"/>
                    <var scope="" prefixed-id="v1" model-prefixed-id="model" binding="false" value="false" name="foo">
                        <value>
                            <analysis expression="instance()/a" analyzed="true">
                                <returnable>
                                    <path>instance('instance')/a</path>
                                </returnable>
                                <dependent-models>
                                    <model>model</model>
                                </dependent-models>
                                <dependent-instances>
                                    <instance>instance</instance>
                                </dependent-instances>
                                <returnable-instances>
                                    <instance>instance</instance>
                                </returnable-instances>
                            </analysis>
                        </value>
                    </var>
                    <binds>
                        <bind id="b1" ref="$foo">
                            <binding>
                                <analysis expression="$foo" analyzed="true">
                                    <returnable>
                                        <path>instance('instance')/a</path>
                                    </returnable>
                                    <dependent-models>
                                        <model>model</model>
                                    </dependent-models>
                                    <dependent-instances>
                                        <instance>instance</instance>
                                    </dependent-instances>
                                    <returnable-instances>
                                        <instance>instance</instance>
                                    </returnable-instances>
                                </analysis>
                            </binding>
                        </bind>
                        <bind id="b2" ref=".">
                            <binding>
                                <analysis expression="." analyzed="true">
                                    <returnable>
                                        <path>instance('instance')</path>
                                    </returnable>
                                    <dependent-models>
                                        <model>model</model>
                                    </dependent-models>
                                    <dependent-instances>
                                        <instance>instance</instance>
                                    </dependent-instances>
                                    <returnable-instances>
                                        <instance>instance</instance>
                                    </returnable-instances>
                                </analysis>
                            </binding>
                            <mip name="relevant" expression="boolean($foo = 42)">
                                <analysis expression="boolean($foo = 42)" analyzed="true">
                                    <value-dependent>
                                        <path>instance('instance')/a</path>
                                    </value-dependent>
                                    <dependent-models>
                                        <model>model</model>
                                    </dependent-models>
                                    <dependent-instances>
                                        <instance>instance</instance>
                                    </dependent-instances>
                                </analysis>
                            </mip>
                        </bind>
                    </binds>
                    <bind-instances>
                        <instance>instance</instance>
                    </bind-instances>
                    <computed-binds-instances>
                        <instance>instance</instance>
                    </computed-binds-instances>
                </model>
            </root>
        </output>
    </test>

    <test description="Control binding using @bind attribute" name="oxf:xforms-xpath-analysis">
        <input name="form">
            <xh:html>
                <xh:head>
                    <xf:model id="model" xxf:xpath-analysis="true">
                        <xf:instance id="instance">
                            <instance/>
                        </xf:instance>
                        <xf:bind id="b1" ref="instance()">
                            <xf:bind id="b2" ref="a"/>
                        </xf:bind>
                    </xf:model>
                </xh:head>
                <xh:body>
                    <xf:output id="o1" bind="b1"/>
                    <xf:output id="o2" bind="b2"/>
                </xh:body>
            </xh:html>
        </input>
        <output name="analysis">
            <root scope="" prefixed-id="#document" model-prefixed-id="model" binding="false" value="false">
                <model scope="" prefixed-id="model" default-instance-prefixed-id="instance" analyzed-binds="true">
                    <instance scope="" prefixed-id="instance" model-prefixed-id="model" binding="false" value="false"/>
                    <binds>
                        <bind id="b1" ref="instance()">
                            <binding>
                                <analysis expression="instance()" analyzed="true">
                                    <returnable>
                                        <path>instance('instance')</path>
                                    </returnable>
                                    <dependent-models>
                                        <model>model</model>
                                    </dependent-models>
                                    <dependent-instances>
                                        <instance>instance</instance>
                                    </dependent-instances>
                                    <returnable-instances>
                                        <instance>instance</instance>
                                    </returnable-instances>
                                </analysis>
                            </binding>
                            <bind id="b2" ref="a">
                                <binding>
                                    <analysis expression="a" analyzed="true">
                                        <returnable>
                                            <path>instance('instance')/a</path>
                                        </returnable>
                                        <dependent-models>
                                            <model>model</model>
                                        </dependent-models>
                                        <dependent-instances>
                                            <instance>instance</instance>
                                        </dependent-instances>
                                        <returnable-instances>
                                            <instance>instance</instance>
                                        </returnable-instances>
                                    </analysis>
                                </binding>
                            </bind>
                        </bind>
                    </binds>
                    <bind-instances>
                        <instance>instance</instance>
                    </bind-instances>
                </model>
                <output scope="" prefixed-id="o1" model-prefixed-id="model" binding="true" value="true">
                    <binding>
                        <analysis expression="instance()" analyzed="true">
                            <returnable>
                                <path>instance('instance')</path>
                            </returnable>
                            <dependent-models>
                                <model>model</model>
                            </dependent-models>
                            <dependent-instances>
                                <instance>instance</instance>
                            </dependent-instances>
                            <returnable-instances>
                                <instance>instance</instance>
                            </returnable-instances>
                        </analysis>
                    </binding>
                    <value>
                        <analysis expression="string((.)[1])" analyzed="true">
                            <value-dependent>
                                <path>instance('instance')</path>
                            </value-dependent>
                            <dependent-models>
                                <model>model</model>
                            </dependent-models>
                            <dependent-instances>
                                <instance>instance</instance>
                            </dependent-instances>
                        </analysis>
                    </value>
                </output>
                <output scope="" prefixed-id="o2" model-prefixed-id="model" binding="true" value="true">
                    <binding>
                        <analysis expression="a" analyzed="true">
                            <returnable>
                                <path>instance('instance')/a</path>
                            </returnable>
                            <dependent-models>
                                <model>model</model>
                            </dependent-models>
                            <dependent-instances>
                                <instance>instance</instance>
                            </dependent-instances>
                            <returnable-instances>
                                <instance>instance</instance>
                            </returnable-instances>
                        </analysis>
                    </binding>
                    <value>
                        <analysis expression="string((.)[1])" analyzed="true">
                            <value-dependent>
                                <path>instance('instance')/a</path>
                            </value-dependent>
                            <dependent-models>
                                <model>model</model>
                            </dependent-models>
                            <dependent-instances>
                                <instance>instance</instance>
                            </dependent-instances>
                        </analysis>
                    </value>
                </output>
            </root>
        </output>
    </test>

    <test description="Basic LHHA analysis" name="oxf:xforms-xpath-analysis">
        <input name="form">
            <xh:html xmlns:xxbl="http://orbeon.org/oxf/xml/xbl">
                <xh:head>
                    <xf:model xxf:xpath-analysis="true" id="m1">
                        <xf:instance id="i11">
                            <instance/>
                        </xf:instance>
                        <xf:instance id="i12">
                            <instance/>
                        </xf:instance>
                    </xf:model>
                    <xf:model id="m2">
                        <xf:instance id="i21">
                            <instance/>
                        </xf:instance>
                        <xf:instance id="i22">
                            <instance/>
                        </xf:instance>
                    </xf:model>
                </xh:head>
                <xh:body>
                    <xf:input id="i1" ref="instance()">
                        <xf:label ref="@label"/>
                        <xf:help ref="@help"/>
                        <xf:hint ref="@hint"/>
                        <xf:alert ref="@alert"/>
                    </xf:input>
                    <!-- Other attributes -->
                    <xf:input id="i2" ref="instance()">
                        <!-- Use of @context -->
                        <xf:label context="instance('i12')" ref="@label"/>
                        <!-- Use of @model -->
                        <xf:help model="m2" context="instance('i22')" ref="@label"/>
                        <!-- Combined use of attributes -->
                        <xf:hint model="m2" context="instance('i22')" ref="resource" value="@label"/>
                        <!-- Use of xxf:context() -->
                        <xf:alert value="xxf:context('i2')/@label2"/>
                    </xf:input>
                    <!-- Nested elements -->
                    <!-- 2021-06-01: We should handle this case, which requires knowing whether there is a `value` OR a nested
                         `value` or AVT. We should compute this in `getElementExpressionOrConstant` and store it into
                          `LHHAAnalysis` temporarily for this purpose. -->
<!--                    <xf:input id="i3" ref="instance()">-->
<!--                        <xf:label context="instance('i12')" ref="resource">-->
<!--                            <xf:output value="@label"/>-->
<!--                        </xf:label>-->
<!--                    </xf:input>-->
                </xh:body>
            </xh:html>
        </input>
        <output name="analysis">
            <root scope="" prefixed-id="#document" model-prefixed-id="m1" binding="false" value="false">
                <model scope="" prefixed-id="m1" default-instance-prefixed-id="i11" analyzed-binds="true">
                    <instance scope="" prefixed-id="i11" model-prefixed-id="m1" binding="false" value="false"/>
                    <instance scope="" prefixed-id="i12" model-prefixed-id="m1" binding="false" value="false"/>
                </model>
                <model scope="" prefixed-id="m2" default-instance-prefixed-id="i21" analyzed-binds="true">
                    <instance scope="" prefixed-id="i21" model-prefixed-id="m2" binding="false" value="false"/>
                    <instance scope="" prefixed-id="i22" model-prefixed-id="m2" binding="false" value="false"/>
                </model>
                <input scope="" prefixed-id="i1" model-prefixed-id="m1" binding="true" value="true">
                    <binding>
                        <analysis expression="instance()" analyzed="true">
                            <returnable>
                                <path>instance('i11')</path>
                            </returnable>
                            <dependent-models>
                                <model>m1</model>
                            </dependent-models>
                            <dependent-instances>
                                <instance>i11</instance>
                            </dependent-instances>
                            <returnable-instances>
                                <instance>i11</instance>
                            </returnable-instances>
                        </analysis>
                    </binding>
                    <value>
                        <analysis expression="string((.)[1])" analyzed="true">
                            <value-dependent>
                                <path>instance('i11')</path>
                            </value-dependent>
                            <dependent-models>
                                <model>m1</model>
                            </dependent-models>
                            <dependent-instances>
                                <instance>i11</instance>
                            </dependent-instances>
                        </analysis>
                    </value>
                    <label scope="" prefixed-id="xf-1" model-prefixed-id="m1" binding="true" value="false">
                        <value>
                            <analysis expression="string((@label)[1])" analyzed="true">
                                <value-dependent>
                                    <path>instance('i11')/@label</path>
                                </value-dependent>
                                <dependent-models>
                                    <model>m1</model>
                                </dependent-models>
                                <dependent-instances>
                                    <instance>i11</instance>
                                </dependent-instances>
                            </analysis>
                        </value>
                    </label>
                    <help scope="" prefixed-id="xf-2" model-prefixed-id="m1" binding="true" value="false">
                        <value>
                            <analysis expression="string((@help)[1])" analyzed="true">
                                <value-dependent>
                                    <path>instance('i11')/@help</path>
                                </value-dependent>
                                <dependent-models>
                                    <model>m1</model>
                                </dependent-models>
                                <dependent-instances>
                                    <instance>i11</instance>
                                </dependent-instances>
                            </analysis>
                        </value>
                    </help>
                    <hint scope="" prefixed-id="xf-3" model-prefixed-id="m1" binding="true" value="false">
                        <value>
                            <analysis expression="string((@hint)[1])" analyzed="true">
                                <value-dependent>
                                    <path>instance('i11')/@hint</path>
                                </value-dependent>
                                <dependent-models>
                                    <model>m1</model>
                                </dependent-models>
                                <dependent-instances>
                                    <instance>i11</instance>
                                </dependent-instances>
                            </analysis>
                        </value>
                    </hint>
                    <alert scope="" prefixed-id="xf-4" model-prefixed-id="m1" binding="true" value="false">
                        <value>
                            <analysis expression="string((@alert)[1])" analyzed="true">
                                <value-dependent>
                                    <path>instance('i11')/@alert</path>
                                </value-dependent>
                                <dependent-models>
                                    <model>m1</model>
                                </dependent-models>
                                <dependent-instances>
                                    <instance>i11</instance>
                                </dependent-instances>
                            </analysis>
                        </value>
                    </alert>
                </input>
                <input scope="" prefixed-id="i2" model-prefixed-id="m1" binding="true" value="true">
                    <binding>
                        <analysis expression="instance()" analyzed="true">
                            <returnable>
                                <path>instance('i11')</path>
                            </returnable>
                            <dependent-models>
                                <model>m1</model>
                            </dependent-models>
                            <dependent-instances>
                                <instance>i11</instance>
                            </dependent-instances>
                            <returnable-instances>
                                <instance>i11</instance>
                            </returnable-instances>
                        </analysis>
                    </binding>
                    <value>
                        <analysis expression="string((.)[1])" analyzed="true">
                            <value-dependent>
                                <path>instance('i11')</path>
                            </value-dependent>
                            <dependent-models>
                                <model>m1</model>
                            </dependent-models>
                            <dependent-instances>
                                <instance>i11</instance>
                            </dependent-instances>
                        </analysis>
                    </value>
                    <label scope="" prefixed-id="xf-5" model-prefixed-id="m1" binding="true" value="false">
                        <value>
                            <analysis expression="string((@label)[1])" analyzed="true">
                                <value-dependent>
                                    <path>instance('i12')/@label</path>
                                </value-dependent>
                                <dependent-models>
                                    <model>m1</model>
                                </dependent-models>
                                <dependent-instances>
                                    <instance>i12</instance>
                                </dependent-instances>
                            </analysis>
                        </value>
                    </label>
                    <help scope="" prefixed-id="xf-6" model-prefixed-id="m2" binding="true" value="false">
                        <value>
                            <analysis expression="string((@label)[1])" analyzed="true">
                                <value-dependent>
                                    <path>instance('i22')/@label</path>
                                </value-dependent>
                                <dependent-models>
                                    <model>m2</model>
                                </dependent-models>
                                <dependent-instances>
                                    <instance>i22</instance>
                                </dependent-instances>
                            </analysis>
                        </value>
                    </help>
                    <hint scope="" prefixed-id="xf-7" model-prefixed-id="m2" binding="true" value="false">
                        <value>
                            <analysis expression="string((@label)[1])" analyzed="true">
                                <value-dependent>
                                    <path>instance('i22')/resource/@label</path>
                                </value-dependent>
                                <dependent-models>
                                    <model>m2</model>
                                </dependent-models>
                                <dependent-instances>
                                    <instance>i22</instance>
                                </dependent-instances>
                            </analysis>
                        </value>
                    </hint>
                    <alert scope="" prefixed-id="xf-8" model-prefixed-id="m1" binding="false" value="false">
                        <value>
                            <analysis expression="string((xxf:context('i2')/@label2)[1])" analyzed="true">
                                <value-dependent>
                                    <path>instance('i11')/@label2</path>
                                </value-dependent>
                                <dependent-models>
                                    <model>m1</model>
                                </dependent-models>
                                <dependent-instances>
                                    <instance>i11</instance>
                                </dependent-instances>
                            </analysis>
                        </value>
                    </alert>
                </input>
            </root>
        </output>
    </test>

    <test description="LHHA analysis with nested outputs" name="oxf:xforms-xpath-analysis">
        <input name="form">
            <xh:html xmlns:xxbl="http://orbeon.org/oxf/xml/xbl">
                <xh:head>
                    <xf:model xxf:xpath-analysis="true" id="m1">
                        <xf:instance id="i11">
                            <instance/>
                        </xf:instance>
                        <xf:instance id="i12">
                            <instance/>
                        </xf:instance>
                    </xf:model>
                    <xf:model id="m2">
                        <xf:instance id="i21">
                            <instance/>
                        </xf:instance>
                        <xf:instance id="i22">
                            <instance/>
                        </xf:instance>
                    </xf:model>
                </xh:head>
                <xh:body>
                    <xf:input id="i5" ref="instance()">
                        <!-- Simple xf:output -->
                        <xf:label>
                            <xf:output ref="@label"/>
                        </xf:label>
                        <!-- 2 simple xf:output -->
                        <xf:help>
                            <!-- 2021-06-01: nested `model="m2"` no longer supported. -->
                            <xf:output ref="@help1"/> - <xf:output model="m2" ref="@help2"/>
                        </xf:help>
                        <!-- Output we can't analyze -->
                        <xf:hint>
                            <xf:output ref="@help1"/> - <xf:output value="index('my-repeat')"/>
                        </xf:hint>
                    </xf:input>
                </xh:body>
            </xh:html>
        </input>
        <output name="analysis">
            <root scope="" prefixed-id="#document" model-prefixed-id="m1" binding="false" value="false">
                <model scope="" prefixed-id="m1" default-instance-prefixed-id="i11" analyzed-binds="true">
                    <instance scope="" prefixed-id="i11" model-prefixed-id="m1" binding="false" value="false"/>
                    <instance scope="" prefixed-id="i12" model-prefixed-id="m1" binding="false" value="false"/>
                </model>
                <model scope="" prefixed-id="m2" default-instance-prefixed-id="i21" analyzed-binds="true">
                    <instance scope="" prefixed-id="i21" model-prefixed-id="m2" binding="false" value="false"/>
                    <instance scope="" prefixed-id="i22" model-prefixed-id="m2" binding="false" value="false"/>
                </model>
                <input scope="" prefixed-id="i5" model-prefixed-id="m1" binding="true" value="true">
                    <binding>
                        <analysis expression="instance()" analyzed="true">
                            <returnable>
                                <path>instance('i11')</path>
                            </returnable>
                            <dependent-models>
                                <model>m1</model>
                            </dependent-models>
                            <dependent-instances>
                                <instance>i11</instance>
                            </dependent-instances>
                            <returnable-instances>
                                <instance>i11</instance>
                            </returnable-instances>
                        </analysis>
                    </binding>
                    <value>
                        <analysis expression="string((.)[1])" analyzed="true">
                            <value-dependent>
                                <path>instance('i11')</path>
                            </value-dependent>
                            <dependent-models>
                                <model>m1</model>
                            </dependent-models>
                            <dependent-instances>
                                <instance>i11</instance>
                            </dependent-instances>
                        </analysis>
                    </value>
                    <label scope="" prefixed-id="xf-1" model-prefixed-id="m1" binding="false" value="false">
                        <value>
                            <analysis expression="concat(' ', string((@label)[1]), ' ')" analyzed="true">
                                <value-dependent>
                                    <path>instance('i11')/@label</path>
                                </value-dependent>
                                <dependent-models>
                                    <model>m1</model>
                                </dependent-models>
                                <dependent-instances>
                                    <instance>i11</instance>
                                </dependent-instances>
                            </analysis>
                        </value>
                    </label>
                    <help scope="" prefixed-id="xf-3" model-prefixed-id="m1" binding="false" value="false">
                        <value>
                            <analysis expression="concat(' ', string((@help1)[1]), ' - ', string((@help2)[1]), ' ')" analyzed="true">
                                <value-dependent>
                                    <path>instance('i11')/@help1</path>
                                    <path>instance('i11')/@help2</path>
                                </value-dependent>
                                <dependent-models>
                                    <model>m1</model>
                                </dependent-models>
                                <dependent-instances>
                                    <instance>i11</instance>
                                </dependent-instances>
                            </analysis>
                        </value>
                    </help>
                    <hint scope="" prefixed-id="xf-6" model-prefixed-id="m1" binding="false" value="false">
                        <value>
                            <analysis expression="concat(' ', string((@help1)[1]), ' - ', string((index('my-repeat'))[1]), ' ')" analyzed="false"/>
                        </value>
                    </hint>
                </input>
            </root>
        </output>
    </test>

    <test description="Constant variable" name="oxf:xforms-xpath-analysis">
        <input name="form">
            <xh:html xmlns:xxbl="http://orbeon.org/oxf/xml/xbl">
                <xh:head>
                    <xf:model xxf:xpath-analysis="true" id="model">
                        <xf:instance id="instance">
                            <instance/>
                        </xf:instance>
                        <xf:var name="foo">Foo</xf:var>
                    </xf:model>
                </xh:head>
                <xh:body>
                    <xf:var name="bar">Bar</xf:var>
                    <xf:input id="i1" ref="$foo"/>
                    <xf:output id="o1" value="concat(gaga, $bar)"/>
                </xh:body>
            </xh:html>
        </input>
        <output name="analysis">
            <root scope="" prefixed-id="#document" model-prefixed-id="model" binding="false" value="false">
                <model scope="" prefixed-id="model" default-instance-prefixed-id="instance" analyzed-binds="true">
                    <instance scope="" prefixed-id="instance" model-prefixed-id="model" binding="false" value="false"/>
                    <var scope="" prefixed-id="xf-1" model-prefixed-id="model" binding="false" value="false" name="foo">
                        <value>
                            <analysis expression="'CONSTANT'" analyzed="true"/>
                        </value>
                    </var>
                </model>
                <var scope="" prefixed-id="xf-2" model-prefixed-id="model" binding="false" value="false" name="bar">
                    <value>
                        <analysis expression="'CONSTANT'" analyzed="true"/>
                    </value>
                </var>
                <input scope="" prefixed-id="i1" model-prefixed-id="model" binding="true" value="true">
                    <binding>
                        <analysis expression="$foo" analyzed="true"/>
                    </binding>
                    <value>
                        <analysis expression="string((.)[1])" analyzed="true"/>
                    </value>
                </input>
                <output scope="" prefixed-id="o1" model-prefixed-id="model" binding="false" value="true">
                    <value>
                        <analysis expression="string((concat(gaga, $bar))[1])" analyzed="true">
                            <value-dependent>
                                <path>instance('instance')/gaga</path>
                            </value-dependent>
                            <dependent-models>
                                <model>model</model>
                            </dependent-models>
                            <dependent-instances>
                                <instance>instance</instance>
                            </dependent-instances>
                        </analysis>
                    </value>
                </output>
            </root>
        </output>
    </test>

    <test description="LHHA referring to model variable" name="oxf:xforms-xpath-analysis">
        <input name="form">
            <xh:html xmlns:xxbl="http://orbeon.org/oxf/xml/xbl">
                <xh:head>
                    <xf:model xxf:xpath-analysis="true" id="m1">
                        <xf:instance id="i11">
                            <instance label=""/>
                        </xf:instance>
                        <xf:var name="label" value="instance()/@label"/>
                    </xf:model>
                </xh:head>
                <xh:body>
                    <xf:group id="g1">
                        <xf:label id="l1" ref="$label"/>
                    </xf:group>
                </xh:body>
            </xh:html>
        </input>
        <output name="analysis">
            <root scope="" prefixed-id="#document" model-prefixed-id="m1" binding="false" value="false">
                <model scope="" prefixed-id="m1" default-instance-prefixed-id="i11" analyzed-binds="true">
                    <instance scope="" prefixed-id="i11" model-prefixed-id="m1" binding="false" value="false"/>
                    <var scope="" prefixed-id="xf-1" model-prefixed-id="m1" binding="false" value="false" name="label">
                        <value>
                            <analysis expression="instance()/@label" analyzed="true">
                                <returnable>
                                    <path>instance('i11')/@label</path>
                                </returnable>
                                <dependent-models>
                                    <model>m1</model>
                                </dependent-models>
                                <dependent-instances>
                                    <instance>i11</instance>
                                </dependent-instances>
                                <returnable-instances>
                                    <instance>i11</instance>
                                </returnable-instances>
                            </analysis>
                        </value>
                    </var>
                </model>
                <group scope="" prefixed-id="g1" model-prefixed-id="m1" binding="false" value="false">
                    <label scope="" prefixed-id="l1" model-prefixed-id="m1" binding="true" value="false">
                        <value>
                            <analysis expression="string(($label)[1])" analyzed="true">
                                <value-dependent>
                                    <path>instance('i11')/@label</path>
                                </value-dependent>
                                <dependent-models>
                                    <model>m1</model>
                                </dependent-models>
                                <dependent-instances>
                                    <instance>i11</instance>
                                </dependent-instances>
                            </analysis>
                        </value>
                    </label>
                </group>
            </root>
        </output>
    </test>

    <test description="External LHHA preceding control and using variable" name="oxf:xforms-xpath-analysis">
        <input name="form">
            <xh:html xmlns:xxbl="http://orbeon.org/oxf/xml/xbl">
                <xh:head>
                    <xf:model xxf:xpath-analysis="true" id="model">
                        <xf:instance id="instance">
                            <instance label="" bar=""/>
                        </xf:instance>
                    </xf:model>
                </xh:head>
                <xh:body>
                    <xf:var id="bar-variable" name="bar" value="@bar"/>
                    <xf:label id="my-label" for="my-input" value="$bar"/>
                    <xf:input id="my-input" ref="instance()"/>
                </xh:body>
            </xh:html>
        </input>
        <output name="analysis">
            <root scope="" prefixed-id="#document" model-prefixed-id="model" binding="false" value="false">
                <model scope="" prefixed-id="model" default-instance-prefixed-id="instance" analyzed-binds="true">
                    <instance scope="" prefixed-id="instance" model-prefixed-id="model" binding="false" value="false"/>
                </model>
                <var scope="" prefixed-id="bar-variable" model-prefixed-id="model" binding="false" value="false" name="bar">
                    <value>
                        <analysis expression="@bar" analyzed="true">
                            <returnable>
                                <path>instance('instance')/@bar</path>
                            </returnable>
                            <dependent-models>
                                <model>model</model>
                            </dependent-models>
                            <dependent-instances>
                                <instance>instance</instance>
                            </dependent-instances>
                            <returnable-instances>
                                <instance>instance</instance>
                            </returnable-instances>
                        </analysis>
                    </value>
                </var>
                <label scope="" prefixed-id="my-label" model-prefixed-id="model" binding="false" value="false">
                    <value>
                        <analysis expression="string(($bar)[1])" analyzed="true">
                            <value-dependent>
                                <path>instance('instance')/@bar</path>
                            </value-dependent>
                            <dependent-models>
                                <model>model</model>
                            </dependent-models>
                            <dependent-instances>
                                <instance>instance</instance>
                            </dependent-instances>
                        </analysis>
                    </value>
                </label>
                <input scope="" prefixed-id="my-input" model-prefixed-id="model" binding="true" value="true">
                    <binding>
                        <analysis expression="instance()" analyzed="true">
                            <returnable>
                                <path>instance('instance')</path>
                            </returnable>
                            <dependent-models>
                                <model>model</model>
                            </dependent-models>
                            <dependent-instances>
                                <instance>instance</instance>
                            </dependent-instances>
                            <returnable-instances>
                                <instance>instance</instance>
                            </returnable-instances>
                        </analysis>
                    </binding>
                    <value>
                        <analysis expression="string((.)[1])" analyzed="true">
                            <value-dependent>
                                <path>instance('instance')</path>
                            </value-dependent>
                            <dependent-models>
                                <model>model</model>
                            </dependent-models>
                            <dependent-instances>
                                <instance>instance</instance>
                            </dependent-instances>
                        </analysis>
                    </value>
                </input>
            </root>
        </output>
    </test>

    <test description="External LHHA positioning and evaluation context" name="oxf:xforms-xpath-analysis">
        <input name="form">
            <xh:html xmlns:xxbl="http://orbeon.org/oxf/xml/xbl">
                <xh:head>
                    <xf:model xxf:xpath-analysis="true" id="model">
                        <xf:instance id="instance">
                            <instance label1="" label2="" help2="" help3="">
                                <value1/>
                                <nested group-label="" label3="" help1="">
                                    <value2/>
                                </nested>
                                <value3/>
                            </instance>
                        </xf:instance>
                    </xf:model>
                </xh:head>
                <xh:body>
                    <!-- Labels are forward-looking, helps are backward-looking  -->
                    <xf:label id="label1" for="input1" value="@label1"/>
                    <xf:input id="input1" ref="value1"/>
                    <xf:label id="label2" for="input2" value="@label2"/>
                    <xf:group id="group1" context="nested">
                        <xf:label id="group-label1" value="@group-label"/>
                        <xf:input id="input2" ref="value2"/>
                        <xf:label id="label3" for="input3" value="@label3"/>
                        <xf:help id="help1" for="input1" value="@help1"/>
                    </xf:group>
                    <xf:help id="help2" for="input2" value="@help2"/>
                    <xf:input id="input3" ref="value3"/>
                    <xf:help id="help3" for="input3" value="@help3"/>
                </xh:body>
            </xh:html>
        </input>
        <output name="analysis">
            <root scope="" prefixed-id="#document" model-prefixed-id="model" binding="false" value="false">
                <model scope="" prefixed-id="model" default-instance-prefixed-id="instance" analyzed-binds="true">
                    <instance scope="" prefixed-id="instance" model-prefixed-id="model" binding="false" value="false"/>
                </model>
                <label scope="" prefixed-id="label1" model-prefixed-id="model" binding="false" value="false">
                    <value>
                        <analysis expression="string((@label1)[1])" analyzed="true">
                            <value-dependent>
                                <path>instance('instance')/@label1</path>
                            </value-dependent>
                            <dependent-models>
                                <model>model</model>
                            </dependent-models>
                            <dependent-instances>
                                <instance>instance</instance>
                            </dependent-instances>
                        </analysis>
                    </value>
                </label>
                <input scope="" prefixed-id="input1" model-prefixed-id="model" binding="true" value="true">
                    <binding>
                        <analysis expression="value1" analyzed="true">
                            <returnable>
                                <path>instance('instance')/value1</path>
                            </returnable>
                            <dependent-models>
                                <model>model</model>
                            </dependent-models>
                            <dependent-instances>
                                <instance>instance</instance>
                            </dependent-instances>
                            <returnable-instances>
                                <instance>instance</instance>
                            </returnable-instances>
                        </analysis>
                    </binding>
                    <value>
                        <analysis expression="string((.)[1])" analyzed="true">
                            <value-dependent>
                                <path>instance('instance')/value1</path>
                            </value-dependent>
                            <dependent-models>
                                <model>model</model>
                            </dependent-models>
                            <dependent-instances>
                                <instance>instance</instance>
                            </dependent-instances>
                        </analysis>
                    </value>
                </input>
                <label scope="" prefixed-id="label2" model-prefixed-id="model" binding="false" value="false">
                    <value>
                        <analysis expression="string((@label2)[1])" analyzed="true">
                            <value-dependent>
                                <path>instance('instance')/@label2</path>
                            </value-dependent>
                            <dependent-models>
                                <model>model</model>
                            </dependent-models>
                            <dependent-instances>
                                <instance>instance</instance>
                            </dependent-instances>
                        </analysis>
                    </value>
                </label>
                <group scope="" prefixed-id="group1" model-prefixed-id="model" binding="false" value="false">
                    <label scope="" prefixed-id="group-label1" model-prefixed-id="model" binding="false" value="false">
                        <value>
                            <analysis expression="string((@group-label)[1])" analyzed="true">
                                <value-dependent>
                                    <path>instance('instance')/nested/@group-label</path>
                                </value-dependent>
                                <dependent-models>
                                    <model>model</model>
                                </dependent-models>
                                <dependent-instances>
                                    <instance>instance</instance>
                                </dependent-instances>
                            </analysis>
                        </value>
                    </label>
                    <input scope="" prefixed-id="input2" model-prefixed-id="model" binding="true" value="true">
                        <binding>
                            <analysis expression="value2" analyzed="true">
                                <returnable>
                                    <path>instance('instance')/nested/value2</path>
                                </returnable>
                                <dependent-models>
                                    <model>model</model>
                                </dependent-models>
                                <dependent-instances>
                                    <instance>instance</instance>
                                </dependent-instances>
                                <returnable-instances>
                                    <instance>instance</instance>
                                </returnable-instances>
                            </analysis>
                        </binding>
                        <value>
                            <analysis expression="string((.)[1])" analyzed="true">
                                <value-dependent>
                                    <path>instance('instance')/nested/value2</path>
                                </value-dependent>
                                <dependent-models>
                                    <model>model</model>
                                </dependent-models>
                                <dependent-instances>
                                    <instance>instance</instance>
                                </dependent-instances>
                            </analysis>
                        </value>
                    </input>
                    <label scope="" prefixed-id="label3" model-prefixed-id="model" binding="false" value="false">
                        <value>
                            <analysis expression="string((@label3)[1])" analyzed="true">
                                <value-dependent>
                                    <path>instance('instance')/nested/@label3</path>
                                </value-dependent>
                                <dependent-models>
                                    <model>model</model>
                                </dependent-models>
                                <dependent-instances>
                                    <instance>instance</instance>
                                </dependent-instances>
                            </analysis>
                        </value>
                    </label>
                    <help scope="" prefixed-id="help1" model-prefixed-id="model" binding="false" value="false">
                        <value>
                            <analysis expression="string((@help1)[1])" analyzed="true">
                                <value-dependent>
                                    <path>instance('instance')/nested/@help1</path>
                                </value-dependent>
                                <dependent-models>
                                    <model>model</model>
                                </dependent-models>
                                <dependent-instances>
                                    <instance>instance</instance>
                                </dependent-instances>
                            </analysis>
                        </value>
                    </help>
                </group>
                <help scope="" prefixed-id="help2" model-prefixed-id="model" binding="false" value="false">
                    <value>
                        <analysis expression="string((@help2)[1])" analyzed="true">
                            <value-dependent>
                                <path>instance('instance')/@help2</path>
                            </value-dependent>
                            <dependent-models>
                                <model>model</model>
                            </dependent-models>
                            <dependent-instances>
                                <instance>instance</instance>
                            </dependent-instances>
                        </analysis>
                    </value>
                </help>
                <input scope="" prefixed-id="input3" model-prefixed-id="model" binding="true" value="true">
                    <binding>
                        <analysis expression="value3" analyzed="true">
                            <returnable>
                                <path>instance('instance')/value3</path>
                            </returnable>
                            <dependent-models>
                                <model>model</model>
                            </dependent-models>
                            <dependent-instances>
                                <instance>instance</instance>
                            </dependent-instances>
                            <returnable-instances>
                                <instance>instance</instance>
                            </returnable-instances>
                        </analysis>
                    </binding>
                    <value>
                        <analysis expression="string((.)[1])" analyzed="true">
                            <value-dependent>
                                <path>instance('instance')/value3</path>
                            </value-dependent>
                            <dependent-models>
                                <model>model</model>
                            </dependent-models>
                            <dependent-instances>
                                <instance>instance</instance>
                            </dependent-instances>
                        </analysis>
                    </value>
                </input>
                <help scope="" prefixed-id="help3" model-prefixed-id="model" binding="false" value="false">
                    <value>
                        <analysis expression="string((@help3)[1])" analyzed="true">
                            <value-dependent>
                                <path>instance('instance')/@help3</path>
                            </value-dependent>
                            <dependent-models>
                                <model>model</model>
                            </dependent-models>
                            <dependent-instances>
                                <instance>instance</instance>
                            </dependent-instances>
                        </analysis>
                    </value>
                </help>
            </root>
        </output>
    </test>

    <test description="Handling of required upon initialization" name="oxf:pipeline">
        <!-- See: http://forge.ow2.org/tracker/index.php?func=detail&aid=315598&group_id=168&atid=350207 -->
        <input name="config" href="wrap-xforms-controls.xpl"/>
        <input name="document">
            <xh:html>
                <xh:head>
                    <xf:model xxf:xpath-analysis="true">
                        <xf:instance>
                            <first-name/>
                        </xf:instance>
                        <xf:bind ref="instance()" required="true()"/>
                    </xf:model>
                </xh:head>
                <xh:body>
                    <xf:input id="my-input" ref="instance()">
                        <xf:alert>First name is mandatory</xf:alert>
                    </xf:input>
                </xh:body>
            </xh:html>
        </input>
        <output name="response">
            <controls>
                <xh:span id="my-input" class="xforms-control xforms-input xforms-invalid xforms-required xforms-empty">
                    <xh:input id="my-inputxforms-input-1" type="text" name="my-inputxforms-input-1" value="" class="xforms-input-input" aria-required="true" aria-invalid="true"/>
                    <xh:span class="xforms-active xforms-alert">First name is mandatory</xh:span>
                </xh:span>
            </controls>
        </output>
    </test>

    <test description="Simple itemset" name="oxf:xforms-xpath-analysis">
        <input name="form">
            <xh:html>
                <xh:head>
                    <xf:model xxf:xpath-analysis="true" id="model">
                        <xf:instance id="instance">
                            <instance/>
                        </xf:instance>
                    </xf:model>
                </xh:head>
                <xh:body>
                    <xf:select id="my-select" ref="value">
                        <xf:itemset ref="../item">
                            <xf:label ref="label"/>
                            <xf:value ref="value"/>
                        </xf:itemset>
                    </xf:select>
                </xh:body>
            </xh:html>
        </input>
        <output name="analysis">
            <root scope="" prefixed-id="#document" model-prefixed-id="model" binding="false" value="false">
                <model scope="" prefixed-id="model" default-instance-prefixed-id="instance" analyzed-binds="true">
                    <instance scope="" prefixed-id="instance" model-prefixed-id="model" binding="false" value="false"/>
                </model>
                <select scope="" prefixed-id="my-select" model-prefixed-id="model" binding="true" value="true">
                    <binding>
                        <analysis expression="value" analyzed="true">
                            <returnable>
                                <path>instance('instance')/value</path>
                            </returnable>
                            <dependent-models>
                                <model>model</model>
                            </dependent-models>
                            <dependent-instances>
                                <instance>instance</instance>
                            </dependent-instances>
                            <returnable-instances>
                                <instance>instance</instance>
                            </returnable-instances>
                        </analysis>
                    </binding>
                    <value>
                        <analysis expression="string((.)[1])" analyzed="true">
                            <value-dependent>
                                <path>instance('instance')/value</path>
                            </value-dependent>
                            <dependent-models>
                                <model>model</model>
                            </dependent-models>
                            <dependent-instances>
                                <instance>instance</instance>
                            </dependent-instances>
                        </analysis>
                    </value>
                    <itemset>
                        <analysis expression="((../item) | (string((label)[1]))) | (string((value)[1]))" analyzed="true">
                            <value-dependent>
                                <path>instance('instance')/item</path>
                                <path>instance('instance')/item/label</path>
                                <path>instance('instance')/item/value</path>
                            </value-dependent>
                            <dependent-models>
                                <model>model</model>
                            </dependent-models>
                            <dependent-instances>
                                <instance>instance</instance>
                            </dependent-instances>
                        </analysis>
                    </itemset>
                </select>
            </root>
        </output>
    </test>

    <test description="Complex itemset" name="oxf:xforms-xpath-analysis">
        <input name="form">
            <xh:html>
                <xh:head>
                    <xf:model xxf:xpath-analysis="true" id="model1">
                        <xf:instance id="instance1">
                            <instance/>
                        </xf:instance>
                    </xf:model>
                    <xf:model xxf:xpath-analysis="true" id="model2">
                        <xf:instance id="instance2">
                            <instance/>
                        </xf:instance>
                    </xf:model>
                </xh:head>
                <xh:body>
                    <xf:select id="my-select" ref="value">
                        <xf:item context="../item">
                            <xf:label ref="label"/>
                            <xf:value value="value"/>
                        </xf:item>
                        <xf:itemset context="../itemset" ref="item">
                            <xf:label ref="label"/>
                            <xf:value ref="value"/>
                        </xf:itemset>
                        <xf:choices context="../choices">
                            <xf:label ref="label"/>
                            <xf:item context="item">
                                <xf:label ref="label"/>
                                <xf:value value="value"/>
                            </xf:item>
                            <xf:itemset ref="itemset">
                                <xf:label ref="label"/>
                                <xf:value ref="value"/>
                            </xf:itemset>
                            <xf:choices model="model2" context="items">
                                <xf:item>
                                    <xf:label ref="item1/label"/>
                                    <xf:value value="item1/value"/>
                                </xf:item>
                                <xf:item context="item2">
                                    <xf:label ref="label"/>
                                    <xf:value value="value"/>
                                </xf:item>
                            </xf:choices>
                        </xf:choices>
                    </xf:select>
                </xh:body>
            </xh:html>
        </input>
        <output name="analysis">
            <root scope="" prefixed-id="#document" model-prefixed-id="model1" binding="false" value="false">
                <model scope="" prefixed-id="model1" default-instance-prefixed-id="instance1" analyzed-binds="true">
                    <instance scope="" prefixed-id="instance1" model-prefixed-id="model1" binding="false" value="false"/>
                </model>
                <model scope="" prefixed-id="model2" default-instance-prefixed-id="instance2" analyzed-binds="true">
                    <instance scope="" prefixed-id="instance2" model-prefixed-id="model2" binding="false" value="false"/>
                </model>
                <select scope="" prefixed-id="my-select" model-prefixed-id="model1" binding="true" value="true">
                    <binding>
                        <analysis expression="value" analyzed="true">
                            <returnable>
                                <path>instance('instance1')/value</path>
                            </returnable>
                            <dependent-models>
                                <model>model1</model>
                            </dependent-models>
                            <dependent-instances>
                                <instance>instance1</instance>
                            </dependent-instances>
                            <returnable-instances>
                                <instance>instance1</instance>
                            </returnable-instances>
                        </analysis>
                    </binding>
                    <value>
                        <analysis expression="string((.)[1])" analyzed="true">
                            <value-dependent>
                                <path>instance('instance1')/value</path>
                            </value-dependent>
                            <dependent-models>
                                <model>model1</model>
                            </dependent-models>
                            <dependent-instances>
                                <instance>instance1</instance>
                            </dependent-instances>
                        </analysis>
                    </value>
                    <itemset>
                        <analysis expression="((((((((((((((((((((../item) | (string((label)[1]))) | (string((value)[1]))) | (item)) | (string((label)[1]))) | (string((value)[1]))) | (../choices)) | (string((label)[1]))) | (item)) | (string((label)[1]))) | (string((value)[1]))) | (itemset)) | (string((label)[1]))) | (string((value)[1]))) | (items)) | (items)) | (string((item1/label)[1]))) | (string((item1/value)[1]))) | (item2)) | (string((label)[1]))) | (string((value)[1]))" analyzed="true">
                            <value-dependent>
                                <path>instance('instance1')/item</path>
                                <path>instance('instance1')/item/label</path>
                                <path>instance('instance1')/item/value</path>
                                <path>instance('instance1')/itemset/item</path>
                                <path>instance('instance1')/itemset/item/label</path>
                                <path>instance('instance1')/itemset/item/value</path>
                                <path>instance('instance1')/choices</path>
                                <path>instance('instance1')/choices/label</path>
                                <path>instance('instance1')/choices/item</path>
                                <path>instance('instance1')/choices/item/label</path>
                                <path>instance('instance1')/choices/item/value</path>
                                <path>instance('instance1')/choices/itemset</path>
                                <path>instance('instance1')/choices/itemset/label</path>
                                <path>instance('instance1')/choices/itemset/value</path>
                                <path>instance('instance2')/items</path>
                                <path>instance('instance2')/items/item1/label</path>
                                <path>instance('instance2')/items/item1/value</path>
                                <path>instance('instance2')/items/item2</path>
                                <path>instance('instance2')/items/item2/label</path>
                                <path>instance('instance2')/items/item2/value</path>
                            </value-dependent>
                            <dependent-models>
                                <model>model1</model>
                                <model>model2</model>
                            </dependent-models>
                            <dependent-instances>
                                <instance>instance1</instance>
                                <instance>instance2</instance>
                            </dependent-instances>
                        </analysis>
                    </itemset>
                </select>
            </root>
        </output>
    </test>

    <test description="Variable scope within XBL" name="oxf:xforms-xpath-analysis">
        <input name="form">
            <xh:html xmlns:xxbl="http://orbeon.org/oxf/xml/xbl">
                <xh:head>
                    <xf:model xxf:xpath-analysis="true" id="model">
                        <xf:instance id="instance">
                            <instance/>
                        </xf:instance>
                    </xf:model>
                    <xbl:xbl>
                        <xbl:binding id="fr-foo" element="fr|foo">
                            <xbl:implementation>
                                <xf:model id="foo-model">
                                    <xf:instance id="foo-instance">
                                        <instance/>
                                    </xf:instance>
                                </xf:model>
                            </xbl:implementation>
                            <xbl:template>
                                <xf:group id="foo-group" xxbl:scope="outer">
                                    <!-- Pointing to the outer scope -->
                                    <xf:var id="v1" name="v1" value="."/>

                                    <xf:var id="v2" name="v2" xxbl:scope="inner">
                                        <xxf:value value="$v1" xxbl:scope="outer"/>
                                    </xf:var>
                                    <xf:output id="output1" value="$v2" xxbl:scope="inner"/>

                                    <!-- Pointing to the inner scope -->
                                    <xf:var id="v3" name="v3" value="." xxbl:scope="inner"/>

                                    <xf:var id="v4" name="v4">
                                        <xxf:value value="$v3" xxbl:scope="inner"/>
                                    </xf:var>
                                    <xf:output id="output2" value="$v4"/>
                                </xf:group>
                            </xbl:template>
                        </xbl:binding>
                    </xbl:xbl>
                </xh:head>
                <xh:body>
                    <fr:foo id="my-foo"/>
                </xh:body>
            </xh:html>
        </input>
        <output name="analysis">
            <root scope="" prefixed-id="#document" model-prefixed-id="model" binding="false" value="false">
                <model scope="" prefixed-id="model" default-instance-prefixed-id="instance" analyzed-binds="true">
                    <instance scope="" prefixed-id="instance" model-prefixed-id="model" binding="false" value="false"/>
                </model>
                <foo scope="" prefixed-id="my-foo" model-prefixed-id="model" binding="false" value="false">
                    <model scope="my-foo" prefixed-id="my-foofoo-model" default-instance-prefixed-id="my-foofoo-instance" analyzed-binds="true">
                        <instance scope="my-foo" prefixed-id="my-foofoo-instance" model-prefixed-id="my-foofoo-model" binding="false" value="false"/>
                    </model>
                    <template scope="my-foo" prefixed-id="my-fooxf-2" model-prefixed-id="my-foofoo-model" binding="false" value="false">
                        <group scope="" prefixed-id="my-foofoo-group" model-prefixed-id="model" binding="false" value="false">
                            <var scope="" prefixed-id="my-foov1" model-prefixed-id="model" binding="false" value="false" name="v1">
                                <value>
                                    <analysis expression="." analyzed="true">
                                        <returnable>
                                            <path>instance('instance')</path>
                                        </returnable>
                                        <dependent-models>
                                            <model>model</model>
                                        </dependent-models>
                                        <dependent-instances>
                                            <instance>instance</instance>
                                        </dependent-instances>
                                        <returnable-instances>
                                            <instance>instance</instance>
                                        </returnable-instances>
                                    </analysis>
                                </value>
                            </var>
                            <var scope="my-foo" prefixed-id="my-foov2" model-prefixed-id="my-foofoo-model" binding="false" value="false" name="v2">
                                <value>
                                    <analysis expression="$v1" analyzed="true">
                                        <returnable>
                                            <path>instance('instance')</path>
                                        </returnable>
                                        <dependent-models>
                                            <model>model</model>
                                        </dependent-models>
                                        <dependent-instances>
                                            <instance>instance</instance>
                                        </dependent-instances>
                                        <returnable-instances>
                                            <instance>instance</instance>
                                        </returnable-instances>
                                    </analysis>
                                </value>
                            </var>
                            <output scope="my-foo" prefixed-id="my-foooutput1" model-prefixed-id="my-foofoo-model" binding="false" value="true">
                                <value>
                                    <analysis expression="string(($v2)[1])" analyzed="true">
                                        <value-dependent>
                                            <path>instance('instance')</path>
                                        </value-dependent>
                                        <dependent-models>
                                            <model>model</model>
                                        </dependent-models>
                                        <dependent-instances>
                                            <instance>instance</instance>
                                        </dependent-instances>
                                    </analysis>
                                </value>
                            </output>
                            <var scope="my-foo" prefixed-id="my-foov3" model-prefixed-id="my-foofoo-model" binding="false" value="false" name="v3">
                                <value>
                                    <analysis expression="." analyzed="true">
                                        <returnable>
                                            <path>instance('my-foofoo-instance')</path>
                                        </returnable>
                                        <dependent-models>
                                            <model>my-foofoo-model</model>
                                        </dependent-models>
                                        <dependent-instances>
                                            <instance>my-foofoo-instance</instance>
                                        </dependent-instances>
                                        <returnable-instances>
                                            <instance>my-foofoo-instance</instance>
                                        </returnable-instances>
                                    </analysis>
                                </value>
                            </var>
                            <var scope="" prefixed-id="my-foov4" model-prefixed-id="model" binding="false" value="false" name="v4">
                                <value>
                                    <analysis expression="$v3" analyzed="true">
                                        <returnable>
                                            <path>instance('my-foofoo-instance')</path>
                                        </returnable>
                                        <dependent-models>
                                            <model>my-foofoo-model</model>
                                        </dependent-models>
                                        <dependent-instances>
                                            <instance>my-foofoo-instance</instance>
                                        </dependent-instances>
                                        <returnable-instances>
                                            <instance>my-foofoo-instance</instance>
                                        </returnable-instances>
                                    </analysis>
                                </value>
                            </var>
                            <output scope="" prefixed-id="my-foooutput2" model-prefixed-id="model" binding="false" value="true">
                                <value>
                                    <analysis expression="string(($v4)[1])" analyzed="true">
                                        <value-dependent>
                                            <path>instance('my-foofoo-instance')</path>
                                        </value-dependent>
                                        <dependent-models>
                                            <model>my-foofoo-model</model>
                                        </dependent-models>
                                        <dependent-instances>
                                            <instance>my-foofoo-instance</instance>
                                        </dependent-instances>
                                    </analysis>
                                </value>
                            </output>
                        </group>
                    </template>
                </foo>
            </root>
        </output>
    </test>

    <test description="Label output in different scope" name="oxf:xforms-xpath-analysis">
        <input name="form">
            <xh:html xmlns:xxbl="http://orbeon.org/oxf/xml/xbl">
                <xh:head>
                    <xf:model xxf:xpath-analysis="true" id="model">
                        <xf:instance id="instance">
                            <instance>
                                <foo>42</foo>
                                <bar>43</bar>
                            </instance>
                        </xf:instance>
                    </xf:model>
                    <xbl:xbl>
                        <xbl:binding id="fr-foo" element="fr|foo">
                            <xbl:template>
                                <xf:group id="foo-group">
                                    <!-- 2021-06-01: nested `xxbl:scope="outer"` no longer supported. -->
                                    <xf:label id="foo-label" xxbl:scope="outer"><xf:output id="foo-output" xbl:attr="ref=label-ref"/></xf:label>
                                </xf:group>
                            </xbl:template>
                        </xbl:binding>
                    </xbl:xbl>
                </xh:head>
                <xh:body>
                    <xf:var name="bar" value="instance()/bar"/>
                    <fr:foo id="my-foo" label-ref="$bar"/>
                </xh:body>
            </xh:html>
        </input>
        <output name="analysis">
            <root scope="" prefixed-id="#document" model-prefixed-id="model" binding="false" value="false">
                <model scope="" prefixed-id="model" default-instance-prefixed-id="instance" analyzed-binds="true">
                    <instance scope="" prefixed-id="instance" model-prefixed-id="model" binding="false" value="false"/>
                </model>
                <var scope="" prefixed-id="xf-2" model-prefixed-id="model" binding="false" value="false" name="bar">
                    <value>
                        <analysis expression="instance()/bar" analyzed="true">
                            <returnable>
                                <path>instance('instance')/bar</path>
                            </returnable>
                            <dependent-models>
                                <model>model</model>
                            </dependent-models>
                            <dependent-instances>
                                <instance>instance</instance>
                            </dependent-instances>
                            <returnable-instances>
                                <instance>instance</instance>
                            </returnable-instances>
                        </analysis>
                    </value>
                </var>
                <foo scope="" prefixed-id="my-foo" model-prefixed-id="model" binding="false" value="false">
                    <template scope="my-foo" prefixed-id="my-fooxf-3" binding="false" value="false">
                        <group scope="my-foo" prefixed-id="my-foofoo-group" binding="false" value="false">
                            <label scope="" prefixed-id="my-foofoo-label" model-prefixed-id="model" binding="false" value="false">
                                <value>
                                    <analysis expression="string(($bar)[1])" analyzed="true">
                                        <value-dependent>
                                            <path>instance('instance')/bar</path>
                                        </value-dependent>
                                        <dependent-models>
                                            <model>model</model>
                                        </dependent-models>
                                        <dependent-instances>
                                            <instance>instance</instance>
                                        </dependent-instances>
                                    </analysis>
                                </value>
                            </label>
                        </group>
                    </template>
                </foo>
            </root>
        </output>
    </test>

    <test description="Bind with name attribute" name="oxf:xforms-xpath-analysis">
        <input name="form">
            <xh:html>
                <xh:head>
                    <xf:model id="model" xxf:xpath-analysis="true">
                        <xf:instance id="instance">
                            <form source="" destination="" readonly=""/>
                        </xf:instance>
                        <xf:bind id="root-bind" ref="." name="root">
                            <xf:bind id="source-bind" ref="@source" name="source"/>
                            <xf:bind id="readonly-bind" ref="@readonly" readonly="$root + $destination mod 2 = 0"/>
                            <xf:bind id="destination-bind" ref="@destination" name="destination" calculate="$source"/>
                        </xf:bind>
                    </xf:model>
                </xh:head>
            </xh:html>
        </input>
        <output name="analysis">
            <root scope="" prefixed-id="#document" model-prefixed-id="model" binding="false" value="false">
                <model scope="" prefixed-id="model" default-instance-prefixed-id="instance" analyzed-binds="true">
                    <instance scope="" prefixed-id="instance" model-prefixed-id="model" binding="false" value="false"/>
                    <binds>
                        <bind id="root-bind" ref=".">
                            <binding>
                                <analysis expression="." analyzed="true">
                                    <returnable>
                                        <path>instance('instance')</path>
                                    </returnable>
                                    <dependent-models>
                                        <model>model</model>
                                    </dependent-models>
                                    <dependent-instances>
                                        <instance>instance</instance>
                                    </dependent-instances>
                                    <returnable-instances>
                                        <instance>instance</instance>
                                    </returnable-instances>
                                </analysis>
                            </binding>
                            <bind id="source-bind" ref="@source">
                                <binding>
                                    <analysis expression="@source" analyzed="true">
                                        <returnable>
                                            <path>instance('instance')/@source</path>
                                        </returnable>
                                        <dependent-models>
                                            <model>model</model>
                                        </dependent-models>
                                        <dependent-instances>
                                            <instance>instance</instance>
                                        </dependent-instances>
                                        <returnable-instances>
                                            <instance>instance</instance>
                                        </returnable-instances>
                                    </analysis>
                                </binding>
                            </bind>
                            <bind id="readonly-bind" ref="@readonly">
                                <binding>
                                    <analysis expression="@readonly" analyzed="true">
                                        <returnable>
                                            <path>instance('instance')/@readonly</path>
                                        </returnable>
                                        <dependent-models>
                                            <model>model</model>
                                        </dependent-models>
                                        <dependent-instances>
                                            <instance>instance</instance>
                                        </dependent-instances>
                                        <returnable-instances>
                                            <instance>instance</instance>
                                        </returnable-instances>
                                    </analysis>
                                </binding>
                                <mip name="readonly" expression="boolean($root + $destination mod 2 = 0)">
                                    <analysis expression="boolean($root + $destination mod 2 = 0)" analyzed="true">
                                        <value-dependent>
                                            <path>instance('instance')</path>
                                            <path>instance('instance')/@destination</path>
                                        </value-dependent>
                                        <dependent-models>
                                            <model>model</model>
                                        </dependent-models>
                                        <dependent-instances>
                                            <instance>instance</instance>
                                        </dependent-instances>
                                    </analysis>
                                </mip>
                            </bind>
                            <bind id="destination-bind" ref="@destination">
                                <binding>
                                    <analysis expression="@destination" analyzed="true">
                                        <returnable>
                                            <path>instance('instance')/@destination</path>
                                        </returnable>
                                        <dependent-models>
                                            <model>model</model>
                                        </dependent-models>
                                        <dependent-instances>
                                            <instance>instance</instance>
                                        </dependent-instances>
                                        <returnable-instances>
                                            <instance>instance</instance>
                                        </returnable-instances>
                                    </analysis>
                                </binding>
                                <mip name="calculate" expression="string(($source)[1])">
                                    <analysis expression="string(($source)[1])" analyzed="true">
                                        <value-dependent>
                                            <path>instance('instance')/@source</path>
                                        </value-dependent>
                                        <dependent-models>
                                            <model>model</model>
                                        </dependent-models>
                                        <dependent-instances>
                                            <instance>instance</instance>
                                        </dependent-instances>
                                    </analysis>
                                </mip>
                            </bind>
                        </bind>
                    </binds>
                    <bind-instances>
                        <instance>instance</instance>
                    </bind-instances>
                    <computed-binds-instances>
                        <instance>instance</instance>
                    </computed-binds-instances>
                </model>
            </root>
        </output>
    </test>

    <test description="xxf:instance id resolution across XBL scopes" name="oxf:xforms-xpath-analysis">
        <input name="form">
            <xh:html xmlns:xxbl="http://orbeon.org/oxf/xml/xbl">
                <xh:head>
                    <xf:model id="m1" xxf:xpath-analysis="true">
                        <xf:instance id="m1i1"><instance/></xf:instance>
                        <xf:instance id="m1i2"><instance/></xf:instance>
                    </xf:model>
                    <xf:model id="m2">
                        <xf:instance id="m2i1"><instance/></xf:instance>
                        <xf:instance id="m2i2"><instance/></xf:instance>
                    </xf:model>
                    <xbl:xbl>
                        <xbl:binding id="fr-foo" element="fr|foo">
                            <xbl:implementation>
                                <xf:model id="m1">
                                    <xf:instance id="m1i1"><instance/></xf:instance>
                                    <xf:instance id="m1i3"><instance/></xf:instance>
                                </xf:model>
                                <xf:model id="m2">
                                    <xf:instance id="m2i1"><instance/></xf:instance>
                                    <xf:instance id="m2i3"><instance/></xf:instance>
                                </xf:model>
                            </xbl:implementation>
                            <xbl:template>
                                <!-- Must reach local instances -->
                                <xf:output id="o1" value="xxf:instance('m1i1')"/>
                                <xf:output id="o2" value="xxf:instance('m2i1')"/>
                                <!-- Must reach top-level instances -->
                                <xf:output id="o3" value="xxf:instance('m1i2')"/>
                                <xf:output id="o4" value="xxf:instance('m2i2')"/>

                                <fr:bar id="bar1"/>

                                <!-- NOTE: We are playing with fire by specifying ids on outer scope elements here -->
                                <xf:group id="g1" xxbl:scope="outer">
                                    <!-- Must reach top-level instances -->
                                    <xf:output id="o5" value="xxf:instance('m1i1')"/>
                                    <xf:output id="o6" value="xxf:instance('m2i1')"/>
                                    <xf:output id="o7" value="xxf:instance('m1i2')"/>
                                    <xf:output id="o8" value="xxf:instance('m2i2')"/>

                                    <fr:bar id="bar2"/>
                                </xf:group>

                            </xbl:template>
                        </xbl:binding>
                    </xbl:xbl>
                    <xbl:xbl>
                        <xbl:binding id="fr-bar" element="fr|bar">
                            <xbl:implementation>
                                <xf:model id="m1">
                                    <xf:instance id="m1i1"><instance/></xf:instance>
                                </xf:model>
                                <xf:model id="m2">
                                    <xf:instance id="m2i1"><instance/></xf:instance>
                                </xf:model>
                            </xbl:implementation>
                            <xbl:template>
                                <!-- Must reach local instances -->
                                <xf:output id="o1" value="xxf:instance('m1i1')"/>
                                <xf:output id="o2" value="xxf:instance('m2i1')"/>
                                <!-- Must reach parent instances -->
                                <xf:output id="o3" value="xxf:instance('m1i3')"/>
                                <xf:output id="o4" value="xxf:instance('m2i3')"/>
                                <!-- Must reach top-level instances -->
                                <xf:output id="o5" value="xxf:instance('m1i2')"/>
                                <xf:output id="o6" value="xxf:instance('m2i2')"/>

                                <!-- NOTE: We are playing with fire by specifying ids on outer scope elements here -->
                                <xf:group id="g2" xxbl:scope="outer">
                                    <!-- Must reach outer scope instances -->
                                    <xf:output id="o9" value="xxf:instance('m1i1')"/>
                                    <xf:output id="o10" value="xxf:instance('m2i1')"/>
                                    <xf:output id="o11" value="xxf:instance('m1i3')"/>
                                    <xf:output id="o12" value="xxf:instance('m2i3')"/>
                                    <!-- Must reach top-level instances -->
                                    <xf:output id="o13" value="xxf:instance('m1i2')"/>
                                    <xf:output id="o14" value="xxf:instance('m2i2')"/>
                                </xf:group>
                            </xbl:template>
                        </xbl:binding>
                    </xbl:xbl>
                </xh:head>
                <xh:body>
                    <!-- Must reach top-level instances -->
                    <xf:output id="o1" value="xxf:instance('m1i1')"/>
                    <xf:output id="o2" value="xxf:instance('m2i1')"/>

                    <fr:foo id="foo1"/>
                </xh:body>
            </xh:html>
        </input>
        <output name="analysis">
            <root scope="" prefixed-id="#document" model-prefixed-id="m1" binding="false" value="false">
                <model scope="" prefixed-id="m1" default-instance-prefixed-id="m1i1" analyzed-binds="true">
                    <instance scope="" prefixed-id="m1i1" model-prefixed-id="m1" binding="false" value="false"/>
                    <instance scope="" prefixed-id="m1i2" model-prefixed-id="m1" binding="false" value="false"/>
                </model>
                <model scope="" prefixed-id="m2" default-instance-prefixed-id="m2i1" analyzed-binds="true">
                    <instance scope="" prefixed-id="m2i1" model-prefixed-id="m2" binding="false" value="false"/>
                    <instance scope="" prefixed-id="m2i2" model-prefixed-id="m2" binding="false" value="false"/>
                </model>
                <output scope="" prefixed-id="o1" model-prefixed-id="m1" binding="false" value="true">
                    <value>
                        <analysis expression="string((xxf:instance('m1i1'))[1])" analyzed="true">
                            <value-dependent>
                                <path>instance('m1i1')</path>
                            </value-dependent>
                            <dependent-models>
                                <model>m1</model>
                            </dependent-models>
                            <dependent-instances>
                                <instance>m1i1</instance>
                            </dependent-instances>
                        </analysis>
                    </value>
                </output>
                <output scope="" prefixed-id="o2" model-prefixed-id="m1" binding="false" value="true">
                    <value>
                        <analysis expression="string((xxf:instance('m2i1'))[1])" analyzed="true">
                            <value-dependent>
                                <path>instance('m2i1')</path>
                            </value-dependent>
                            <dependent-models>
                                <model>m2</model>
                            </dependent-models>
                            <dependent-instances>
                                <instance>m2i1</instance>
                            </dependent-instances>
                        </analysis>
                    </value>
                </output>
                <foo scope="" prefixed-id="foo1" model-prefixed-id="m1" binding="false" value="false">
                    <model scope="foo1" prefixed-id="foo1m1" default-instance-prefixed-id="foo1m1i1" analyzed-binds="true">
                        <instance scope="foo1" prefixed-id="foo1m1i1" model-prefixed-id="foo1m1" binding="false" value="false"/>
                        <instance scope="foo1" prefixed-id="foo1m1i3" model-prefixed-id="foo1m1" binding="false" value="false"/>
                    </model>
                    <model scope="foo1" prefixed-id="foo1m2" default-instance-prefixed-id="foo1m2i1" analyzed-binds="true">
                        <instance scope="foo1" prefixed-id="foo1m2i1" model-prefixed-id="foo1m2" binding="false" value="false"/>
                        <instance scope="foo1" prefixed-id="foo1m2i3" model-prefixed-id="foo1m2" binding="false" value="false"/>
                    </model>
                    <template scope="foo1" prefixed-id="foo1xf-3" model-prefixed-id="foo1m1" binding="false" value="false">
                        <output scope="foo1" prefixed-id="foo1o1" model-prefixed-id="foo1m1" binding="false" value="true">
                            <value>
                                <analysis expression="string((xxf:instance('m1i1'))[1])" analyzed="true">
                                    <value-dependent>
                                        <path>instance('foo1m1i1')</path>
                                    </value-dependent>
                                    <dependent-models>
                                        <model>foo1m1</model>
                                    </dependent-models>
                                    <dependent-instances>
                                        <instance>foo1m1i1</instance>
                                    </dependent-instances>
                                </analysis>
                            </value>
                        </output>
                        <output scope="foo1" prefixed-id="foo1o2" model-prefixed-id="foo1m1" binding="false" value="true">
                            <value>
                                <analysis expression="string((xxf:instance('m2i1'))[1])" analyzed="true">
                                    <value-dependent>
                                        <path>instance('foo1m2i1')</path>
                                    </value-dependent>
                                    <dependent-models>
                                        <model>foo1m2</model>
                                    </dependent-models>
                                    <dependent-instances>
                                        <instance>foo1m2i1</instance>
                                    </dependent-instances>
                                </analysis>
                            </value>
                        </output>
                        <output scope="foo1" prefixed-id="foo1o3" model-prefixed-id="foo1m1" binding="false" value="true">
                            <value>
                                <analysis expression="string((xxf:instance('m1i2'))[1])" analyzed="true">
                                    <value-dependent>
                                        <path>instance('m1i2')</path>
                                    </value-dependent>
                                    <dependent-models>
                                        <model>m1</model>
                                    </dependent-models>
                                    <dependent-instances>
                                        <instance>m1i2</instance>
                                    </dependent-instances>
                                </analysis>
                            </value>
                        </output>
                        <output scope="foo1" prefixed-id="foo1o4" model-prefixed-id="foo1m1" binding="false" value="true">
                            <value>
                                <analysis expression="string((xxf:instance('m2i2'))[1])" analyzed="true">
                                    <value-dependent>
                                        <path>instance('m2i2')</path>
                                    </value-dependent>
                                    <dependent-models>
                                        <model>m2</model>
                                    </dependent-models>
                                    <dependent-instances>
                                        <instance>m2i2</instance>
                                    </dependent-instances>
                                </analysis>
                            </value>
                        </output>
                        <bar scope="foo1" prefixed-id="foo1bar1" model-prefixed-id="foo1m1" binding="false" value="false">
                            <model scope="foo1bar1" prefixed-id="foo1bar1m1" default-instance-prefixed-id="foo1bar1m1i1" analyzed-binds="true">
                                <instance scope="foo1bar1" prefixed-id="foo1bar1m1i1" model-prefixed-id="foo1bar1m1" binding="false" value="false"/>
                            </model>
                            <model scope="foo1bar1" prefixed-id="foo1bar1m2" default-instance-prefixed-id="foo1bar1m2i1" analyzed-binds="true">
                                <instance scope="foo1bar1" prefixed-id="foo1bar1m2i1" model-prefixed-id="foo1bar1m2" binding="false" value="false"/>
                            </model>
                            <template scope="foo1bar1" prefixed-id="foo1bar1xf-4" model-prefixed-id="foo1bar1m1" binding="false" value="false">
                                <output scope="foo1bar1" prefixed-id="foo1bar1o1" model-prefixed-id="foo1bar1m1" binding="false" value="true">
                                    <value>
                                        <analysis expression="string((xxf:instance('m1i1'))[1])" analyzed="true">
                                            <value-dependent>
                                                <path>instance('foo1bar1m1i1')</path>
                                            </value-dependent>
                                            <dependent-models>
                                                <model>foo1bar1m1</model>
                                            </dependent-models>
                                            <dependent-instances>
                                                <instance>foo1bar1m1i1</instance>
                                            </dependent-instances>
                                        </analysis>
                                    </value>
                                </output>
                                <output scope="foo1bar1" prefixed-id="foo1bar1o2" model-prefixed-id="foo1bar1m1" binding="false" value="true">
                                    <value>
                                        <analysis expression="string((xxf:instance('m2i1'))[1])" analyzed="true">
                                            <value-dependent>
                                                <path>instance('foo1bar1m2i1')</path>
                                            </value-dependent>
                                            <dependent-models>
                                                <model>foo1bar1m2</model>
                                            </dependent-models>
                                            <dependent-instances>
                                                <instance>foo1bar1m2i1</instance>
                                            </dependent-instances>
                                        </analysis>
                                    </value>
                                </output>
                                <output scope="foo1bar1" prefixed-id="foo1bar1o3" model-prefixed-id="foo1bar1m1" binding="false" value="true">
                                    <value>
                                        <analysis expression="string((xxf:instance('m1i3'))[1])" analyzed="true">
                                            <value-dependent>
                                                <path>instance('foo1m1i3')</path>
                                            </value-dependent>
                                            <dependent-models>
                                                <model>foo1m1</model>
                                            </dependent-models>
                                            <dependent-instances>
                                                <instance>foo1m1i3</instance>
                                            </dependent-instances>
                                        </analysis>
                                    </value>
                                </output>
                                <output scope="foo1bar1" prefixed-id="foo1bar1o4" model-prefixed-id="foo1bar1m1" binding="false" value="true">
                                    <value>
                                        <analysis expression="string((xxf:instance('m2i3'))[1])" analyzed="true">
                                            <value-dependent>
                                                <path>instance('foo1m2i3')</path>
                                            </value-dependent>
                                            <dependent-models>
                                                <model>foo1m2</model>
                                            </dependent-models>
                                            <dependent-instances>
                                                <instance>foo1m2i3</instance>
                                            </dependent-instances>
                                        </analysis>
                                    </value>
                                </output>
                                <output scope="foo1bar1" prefixed-id="foo1bar1o5" model-prefixed-id="foo1bar1m1" binding="false" value="true">
                                    <value>
                                        <analysis expression="string((xxf:instance('m1i2'))[1])" analyzed="true">
                                            <value-dependent>
                                                <path>instance('m1i2')</path>
                                            </value-dependent>
                                            <dependent-models>
                                                <model>m1</model>
                                            </dependent-models>
                                            <dependent-instances>
                                                <instance>m1i2</instance>
                                            </dependent-instances>
                                        </analysis>
                                    </value>
                                </output>
                                <output scope="foo1bar1" prefixed-id="foo1bar1o6" model-prefixed-id="foo1bar1m1" binding="false" value="true">
                                    <value>
                                        <analysis expression="string((xxf:instance('m2i2'))[1])" analyzed="true">
                                            <value-dependent>
                                                <path>instance('m2i2')</path>
                                            </value-dependent>
                                            <dependent-models>
                                                <model>m2</model>
                                            </dependent-models>
                                            <dependent-instances>
                                                <instance>m2i2</instance>
                                            </dependent-instances>
                                        </analysis>
                                    </value>
                                </output>
                                <group scope="foo1" prefixed-id="foo1bar1g2" model-prefixed-id="foo1m1" binding="false" value="false">
                                    <output scope="foo1" prefixed-id="foo1bar1o9" model-prefixed-id="foo1m1" binding="false" value="true">
                                        <value>
                                            <analysis expression="string((xxf:instance('m1i1'))[1])" analyzed="true">
                                                <value-dependent>
                                                    <path>instance('foo1m1i1')</path>
                                                </value-dependent>
                                                <dependent-models>
                                                    <model>foo1m1</model>
                                                </dependent-models>
                                                <dependent-instances>
                                                    <instance>foo1m1i1</instance>
                                                </dependent-instances>
                                            </analysis>
                                        </value>
                                    </output>
                                    <output scope="foo1" prefixed-id="foo1bar1o10" model-prefixed-id="foo1m1" binding="false" value="true">
                                        <value>
                                            <analysis expression="string((xxf:instance('m2i1'))[1])" analyzed="true">
                                                <value-dependent>
                                                    <path>instance('foo1m2i1')</path>
                                                </value-dependent>
                                                <dependent-models>
                                                    <model>foo1m2</model>
                                                </dependent-models>
                                                <dependent-instances>
                                                    <instance>foo1m2i1</instance>
                                                </dependent-instances>
                                            </analysis>
                                        </value>
                                    </output>
                                    <output scope="foo1" prefixed-id="foo1bar1o11" model-prefixed-id="foo1m1" binding="false" value="true">
                                        <value>
                                            <analysis expression="string((xxf:instance('m1i3'))[1])" analyzed="true">
                                                <value-dependent>
                                                    <path>instance('foo1m1i3')</path>
                                                </value-dependent>
                                                <dependent-models>
                                                    <model>foo1m1</model>
                                                </dependent-models>
                                                <dependent-instances>
                                                    <instance>foo1m1i3</instance>
                                                </dependent-instances>
                                            </analysis>
                                        </value>
                                    </output>
                                    <output scope="foo1" prefixed-id="foo1bar1o12" model-prefixed-id="foo1m1" binding="false" value="true">
                                        <value>
                                            <analysis expression="string((xxf:instance('m2i3'))[1])" analyzed="true">
                                                <value-dependent>
                                                    <path>instance('foo1m2i3')</path>
                                                </value-dependent>
                                                <dependent-models>
                                                    <model>foo1m2</model>
                                                </dependent-models>
                                                <dependent-instances>
                                                    <instance>foo1m2i3</instance>
                                                </dependent-instances>
                                            </analysis>
                                        </value>
                                    </output>
                                    <output scope="foo1" prefixed-id="foo1bar1o13" model-prefixed-id="foo1m1" binding="false" value="true">
                                        <value>
                                            <analysis expression="string((xxf:instance('m1i2'))[1])" analyzed="true">
                                                <value-dependent>
                                                    <path>instance('m1i2')</path>
                                                </value-dependent>
                                                <dependent-models>
                                                    <model>m1</model>
                                                </dependent-models>
                                                <dependent-instances>
                                                    <instance>m1i2</instance>
                                                </dependent-instances>
                                            </analysis>
                                        </value>
                                    </output>
                                    <output scope="foo1" prefixed-id="foo1bar1o14" model-prefixed-id="foo1m1" binding="false" value="true">
                                        <value>
                                            <analysis expression="string((xxf:instance('m2i2'))[1])" analyzed="true">
                                                <value-dependent>
                                                    <path>instance('m2i2')</path>
                                                </value-dependent>
                                                <dependent-models>
                                                    <model>m2</model>
                                                </dependent-models>
                                                <dependent-instances>
                                                    <instance>m2i2</instance>
                                                </dependent-instances>
                                            </analysis>
                                        </value>
                                    </output>
                                </group>
                            </template>
                        </bar>
                        <group scope="" prefixed-id="foo1g1" model-prefixed-id="m1" binding="false" value="false">
                            <output scope="" prefixed-id="foo1o5" model-prefixed-id="m1" binding="false" value="true">
                                <value>
                                    <analysis expression="string((xxf:instance('m1i1'))[1])" analyzed="true">
                                        <value-dependent>
                                            <path>instance('m1i1')</path>
                                        </value-dependent>
                                        <dependent-models>
                                            <model>m1</model>
                                        </dependent-models>
                                        <dependent-instances>
                                            <instance>m1i1</instance>
                                        </dependent-instances>
                                    </analysis>
                                </value>
                            </output>
                            <output scope="" prefixed-id="foo1o6" model-prefixed-id="m1" binding="false" value="true">
                                <value>
                                    <analysis expression="string((xxf:instance('m2i1'))[1])" analyzed="true">
                                        <value-dependent>
                                            <path>instance('m2i1')</path>
                                        </value-dependent>
                                        <dependent-models>
                                            <model>m2</model>
                                        </dependent-models>
                                        <dependent-instances>
                                            <instance>m2i1</instance>
                                        </dependent-instances>
                                    </analysis>
                                </value>
                            </output>
                            <output scope="" prefixed-id="foo1o7" model-prefixed-id="m1" binding="false" value="true">
                                <value>
                                    <analysis expression="string((xxf:instance('m1i2'))[1])" analyzed="true">
                                        <value-dependent>
                                            <path>instance('m1i2')</path>
                                        </value-dependent>
                                        <dependent-models>
                                            <model>m1</model>
                                        </dependent-models>
                                        <dependent-instances>
                                            <instance>m1i2</instance>
                                        </dependent-instances>
                                    </analysis>
                                </value>
                            </output>
                            <output scope="" prefixed-id="foo1o8" model-prefixed-id="m1" binding="false" value="true">
                                <value>
                                    <analysis expression="string((xxf:instance('m2i2'))[1])" analyzed="true">
                                        <value-dependent>
                                            <path>instance('m2i2')</path>
                                        </value-dependent>
                                        <dependent-models>
                                            <model>m2</model>
                                        </dependent-models>
                                        <dependent-instances>
                                            <instance>m2i2</instance>
                                        </dependent-instances>
                                    </analysis>
                                </value>
                            </output>
                            <bar scope="" prefixed-id="foo1bar2" model-prefixed-id="m1" binding="false" value="false">
                                <model scope="foo1bar2" prefixed-id="foo1bar2m1" default-instance-prefixed-id="foo1bar2m1i1" analyzed-binds="true">
                                    <instance scope="foo1bar2" prefixed-id="foo1bar2m1i1" model-prefixed-id="foo1bar2m1" binding="false" value="false"/>
                                </model>
                                <model scope="foo1bar2" prefixed-id="foo1bar2m2" default-instance-prefixed-id="foo1bar2m2i1" analyzed-binds="true">
                                    <instance scope="foo1bar2" prefixed-id="foo1bar2m2i1" model-prefixed-id="foo1bar2m2" binding="false" value="false"/>
                                </model>
                                <template scope="foo1bar2" prefixed-id="foo1bar2xf-5" model-prefixed-id="foo1bar2m1" binding="false" value="false">
                                    <output scope="foo1bar2" prefixed-id="foo1bar2o1" model-prefixed-id="foo1bar2m1" binding="false" value="true">
                                        <value>
                                            <analysis expression="string((xxf:instance('m1i1'))[1])" analyzed="true">
                                                <value-dependent>
                                                    <path>instance('foo1bar2m1i1')</path>
                                                </value-dependent>
                                                <dependent-models>
                                                    <model>foo1bar2m1</model>
                                                </dependent-models>
                                                <dependent-instances>
                                                    <instance>foo1bar2m1i1</instance>
                                                </dependent-instances>
                                            </analysis>
                                        </value>
                                    </output>
                                    <output scope="foo1bar2" prefixed-id="foo1bar2o2" model-prefixed-id="foo1bar2m1" binding="false" value="true">
                                        <value>
                                            <analysis expression="string((xxf:instance('m2i1'))[1])" analyzed="true">
                                                <value-dependent>
                                                    <path>instance('foo1bar2m2i1')</path>
                                                </value-dependent>
                                                <dependent-models>
                                                    <model>foo1bar2m2</model>
                                                </dependent-models>
                                                <dependent-instances>
                                                    <instance>foo1bar2m2i1</instance>
                                                </dependent-instances>
                                            </analysis>
                                        </value>
                                    </output>
                                    <output scope="foo1bar2" prefixed-id="foo1bar2o3" model-prefixed-id="foo1bar2m1" binding="false" value="true">
                                        <value>
                                            <analysis expression="string((xxf:instance('m1i3'))[1])" analyzed="true">
                                                <value-dependent>
                                                    <path>instance('foo1m1i3')</path>
                                                </value-dependent>
                                                <dependent-models>
                                                    <model>foo1m1</model>
                                                </dependent-models>
                                                <dependent-instances>
                                                    <instance>foo1m1i3</instance>
                                                </dependent-instances>
                                            </analysis>
                                        </value>
                                    </output>
                                    <output scope="foo1bar2" prefixed-id="foo1bar2o4" model-prefixed-id="foo1bar2m1" binding="false" value="true">
                                        <value>
                                            <analysis expression="string((xxf:instance('m2i3'))[1])" analyzed="true">
                                                <value-dependent>
                                                    <path>instance('foo1m2i3')</path>
                                                </value-dependent>
                                                <dependent-models>
                                                    <model>foo1m2</model>
                                                </dependent-models>
                                                <dependent-instances>
                                                    <instance>foo1m2i3</instance>
                                                </dependent-instances>
                                            </analysis>
                                        </value>
                                    </output>
                                    <output scope="foo1bar2" prefixed-id="foo1bar2o5" model-prefixed-id="foo1bar2m1" binding="false" value="true">
                                        <value>
                                            <analysis expression="string((xxf:instance('m1i2'))[1])" analyzed="true">
                                                <value-dependent>
                                                    <path>instance('m1i2')</path>
                                                </value-dependent>
                                                <dependent-models>
                                                    <model>m1</model>
                                                </dependent-models>
                                                <dependent-instances>
                                                    <instance>m1i2</instance>
                                                </dependent-instances>
                                            </analysis>
                                        </value>
                                    </output>
                                    <output scope="foo1bar2" prefixed-id="foo1bar2o6" model-prefixed-id="foo1bar2m1" binding="false" value="true">
                                        <value>
                                            <analysis expression="string((xxf:instance('m2i2'))[1])" analyzed="true">
                                                <value-dependent>
                                                    <path>instance('m2i2')</path>
                                                </value-dependent>
                                                <dependent-models>
                                                    <model>m2</model>
                                                </dependent-models>
                                                <dependent-instances>
                                                    <instance>m2i2</instance>
                                                </dependent-instances>
                                            </analysis>
                                        </value>
                                    </output>
                                    <group scope="" prefixed-id="foo1bar2g2" model-prefixed-id="m1" binding="false" value="false">
                                        <output scope="" prefixed-id="foo1bar2o9" model-prefixed-id="m1" binding="false" value="true">
                                            <value>
                                                <analysis expression="string((xxf:instance('m1i1'))[1])" analyzed="true">
                                                    <value-dependent>
                                                        <path>instance('m1i1')</path>
                                                    </value-dependent>
                                                    <dependent-models>
                                                        <model>m1</model>
                                                    </dependent-models>
                                                    <dependent-instances>
                                                        <instance>m1i1</instance>
                                                    </dependent-instances>
                                                </analysis>
                                            </value>
                                        </output>
                                        <output scope="" prefixed-id="foo1bar2o10" model-prefixed-id="m1" binding="false" value="true">
                                            <value>
                                                <analysis expression="string((xxf:instance('m2i1'))[1])" analyzed="true">
                                                    <value-dependent>
                                                        <path>instance('m2i1')</path>
                                                    </value-dependent>
                                                    <dependent-models>
                                                        <model>m2</model>
                                                    </dependent-models>
                                                    <dependent-instances>
                                                        <instance>m2i1</instance>
                                                    </dependent-instances>
                                                </analysis>
                                            </value>
                                        </output>
                                        <output scope="" prefixed-id="foo1bar2o11" model-prefixed-id="m1" binding="false" value="true">
                                            <value>
                                                <analysis expression="string((xxf:instance('m1i3'))[1])" analyzed="true"/>
                                            </value>
                                        </output>
                                        <output scope="" prefixed-id="foo1bar2o12" model-prefixed-id="m1" binding="false" value="true">
                                            <value>
                                                <analysis expression="string((xxf:instance('m2i3'))[1])" analyzed="true"/>
                                            </value>
                                        </output>
                                        <output scope="" prefixed-id="foo1bar2o13" model-prefixed-id="m1" binding="false" value="true">
                                            <value>
                                                <analysis expression="string((xxf:instance('m1i2'))[1])" analyzed="true">
                                                    <value-dependent>
                                                        <path>instance('m1i2')</path>
                                                    </value-dependent>
                                                    <dependent-models>
                                                        <model>m1</model>
                                                    </dependent-models>
                                                    <dependent-instances>
                                                        <instance>m1i2</instance>
                                                    </dependent-instances>
                                                </analysis>
                                            </value>
                                        </output>
                                        <output scope="" prefixed-id="foo1bar2o14" model-prefixed-id="m1" binding="false" value="true">
                                            <value>
                                                <analysis expression="string((xxf:instance('m2i2'))[1])" analyzed="true">
                                                    <value-dependent>
                                                        <path>instance('m2i2')</path>
                                                    </value-dependent>
                                                    <dependent-models>
                                                        <model>m2</model>
                                                    </dependent-models>
                                                    <dependent-instances>
                                                        <instance>m2i2</instance>
                                                    </dependent-instances>
                                                </analysis>
                                            </value>
                                        </output>
                                    </group>
                                </template>
                            </bar>
                        </group>
                    </template>
                </foo>
            </root>
        </output>
    </test>

    <test description="NPE in NodeWrapper.getDocumentNumber()" name="oxf:pipeline">
        <!-- See: http://forge.ow2.org/tracker/index.php?func=detail&aid=315919&group_id=168&atid=350207 -->
        <input name="config" href="wrap-xforms-state.xpl"/>
        <input name="document">
            <xh:html>
                <xh:head>
                    <xf:model xxf:xpath-analysis="true" id="model">
                        <xf:instance id="instance">
                            <instance>
                                <deleted>
                                    <inside>b</inside>
                                    <inside>a</inside>
                                </deleted>
                            </instance>
                        </xf:instance>
                        <xf:var name="deleted" value="deleted"/>
                        <xf:action ev:event="xforms-ready">
                            <!-- NOTE: setindex is needed to cause the NPE upon delete -->
                            <xf:setindex repeat="my-index" index="2"/>
                            <xf:delete ref="deleted"/>
                        </xf:action>
                    </xf:model>
                </xh:head>
                <xh:body>
                    <xf:repeat ref="$deleted/inside" id="my-repeat">
                        <xf:input ref="." id="my-input"/>
                    </xf:repeat>
                </xh:body>
            </xh:html>
        </input>
        <output name="response">
            <xxf:event-response>
                <xxf:dynamic-state>
                    <dynamic-state>
                        <instances>
                            <instance id="instance" model-id="model">
                                <instance> </instance>
                            </instance>
                        </instances>
                    </dynamic-state>
                </xxf:dynamic-state>
                <xxf:action>
                    <xxf:control-values/>
                </xxf:action>
            </xxf:event-response>
        </output>
    </test>

    <test description="Nested model between variables" name="oxf:xforms-xpath-analysis">
        <input name="form">
            <xh:html>
                <xh:head>
                    <xf:model id="model" xxf:xpath-analysis="true"/>
                </xh:head>
                <xh:body>
                    <xf:group id="my-group">
                        <!-- This variable must be in scope for the xf:output placed after the model -->
                        <xf:var name="foo">foo</xf:var>
                        <xf:model id="nested-model"/>
                        <xf:output id="my-output" value="$foo"/>
                    </xf:group>
                </xh:body>
            </xh:html>
        </input>
        <output name="analysis">
            <root scope="" prefixed-id="#document" model-prefixed-id="model" binding="false" value="false">
                <model scope="" prefixed-id="model" analyzed-binds="true"/>
                <group scope="" prefixed-id="my-group" model-prefixed-id="model" binding="false" value="false">
                    <var scope="" prefixed-id="xf-1" model-prefixed-id="model" binding="false" value="false" name="foo">
                        <value>
                            <analysis expression="'CONSTANT'" analyzed="true"/>
                        </value>
                    </var>
                    <model scope="" prefixed-id="nested-model" analyzed-binds="true"/>
                    <output scope="" prefixed-id="my-output" model-prefixed-id="model" binding="false" value="true">
                        <value>
                            <analysis expression="string(($foo)[1])" analyzed="true"/>
                        </value>
                    </output>
                </group>
            </root>
        </output>
    </test>

    <test description="#336: XPath dependencies not picked up with inter-model recalculate" name="oxf:pipeline">
        <!-- See: https://github.com/orbeon/orbeon-forms/issues/336 -->
        <input name="config" href="wrap-xforms-state.xpl"/>
        <input name="document">
            <xh:html>
                <xh:head>
                    <xf:model id="model1" xxf:xpath-analysis="true">
                        <xf:instance id="instance1">
                            <roles1/>
                        </xf:instance>
                        <xf:action ev:event="xforms-model-construct-done">
                            <xf:setvalue ref=".">a b c</xf:setvalue>
                            <xf:recalculate model="model2"/>
                        </xf:action>
                    </xf:model>
                    <xf:model id="model2">
                        <xf:instance id="instance2">
                            <roles2/>
                        </xf:instance>
                        <xf:var name="roles" value="xxf:instance('instance1')"/>
                        <xf:bind ref="." calculate="$roles" id="roles-bind"/>
                    </xf:model>
                </xh:head>
                <xh:body>
                    <xf:output bind="roles-bind" id="my-output"/>
                </xh:body>
            </xh:html>
        </input>
        <output name="response">
            <xxf:event-response>
                <xxf:dynamic-state>
                    <dynamic-state>
                        <instances>
                            <instance id="instance1" model-id="model1">
                                <roles1>a b c</roles1>
                            </instance>
                            <instance id="instance2" model-id="model2">
                                <roles2>a b c</roles2>
                            </instance>
                        </instances>
                    </dynamic-state>
                </xxf:dynamic-state>
                <xxf:action>
                    <xxf:control-values>
                        <xxf:control id="my-output" readonly="true">
                            <xxf:value>a b c</xxf:value>
                        </xxf:control>
                    </xxf:control-values>
                </xxf:action>
            </xxf:event-response>
        </output>
    </test>

    <test description="xxf:r()" name="oxf:xforms-xpath-analysis">
        <input name="form">
            <xh:html xml:lang="{xxf:instance('fr-language-instance')}">
                <xh:head>
                    <xf:model xxf:xpath-analysis="true" id="model">
                        <xf:instance id="fr-language-instance">
                            <lang>en</lang>
                        </xf:instance>
                        <xf:instance id="orbeon-resources" xxf:readonly="true">
                            <resources>
                                <resource xml:lang="en"/>
                                <resource xml:lang="fr"/>
                            </resources>
                        </xf:instance>
                    </xf:model>
                    <xbl:xbl>
                        <xbl:binding id="fr-foo" element="fr|foo">
                            <xbl:implementation>
                                <xf:model id="model">
                                    <xf:instance id="fr-form-resources" xxf:readonly="true">
                                        <resources>
                                            <resource xml:lang="en"/>
                                            <resource xml:lang="fr"/>
                                        </resources>
                                    </xf:instance>
                                </xf:model>
                            </xbl:implementation>
                            <xbl:template>
                                <xf:output id="my-output-1" value="xxf:r('foo.message')"/>
                                <xf:output id="my-output-2" value="xxf:r('foo.42.alert.0')"/>
                            </xbl:template>
                        </xbl:binding>
                    </xbl:xbl>
                </xh:head>
                <xh:body>
                    <xf:output id="my-output-1" value="xxf:r('bar.message')"/>
                    <xf:output id="my-output-2" value="xxf:r('bar.10.alert.0')"/>
                    <fr:foo id="my-foo"/>
                </xh:body>
            </xh:html>
        </input>
        <output name="analysis">
            <root scope="" prefixed-id="#document" model-prefixed-id="model" binding="false" value="false">
                <attribute scope="" prefixed-id="xf-2" model-prefixed-id="model" binding="false" value="true" name="xml:lang">
                    <value>
                        <analysis expression="{xxf:instance('fr-language-instance')}" analyzed="true">
                            <value-dependent>
                                <path>instance('fr-language-instance')</path>
                            </value-dependent>
                            <dependent-models>
                                <model>model</model>
                            </dependent-models>
                            <dependent-instances>
                                <instance>fr-language-instance</instance>
                            </dependent-instances>
                        </analysis>
                    </value>
                </attribute>
                <model scope="" prefixed-id="model" default-instance-prefixed-id="fr-language-instance" analyzed-binds="true">
                    <instance scope="" prefixed-id="fr-language-instance" model-prefixed-id="model" binding="false" value="false"/>
                    <instance scope="" prefixed-id="orbeon-resources" model-prefixed-id="model" binding="false" value="false"/>
                </model>
                <output scope="" prefixed-id="my-output-1" model-prefixed-id="model" binding="false" value="true">
                    <value>
                        <analysis expression="string((xxf:r('bar.message'))[1])" analyzed="true">
                            <value-dependent>
                                <path>instance('fr-language-instance')</path>
                                <path>instance('orbeon-resources')/resource/bar/message</path>
                            </value-dependent>
                            <dependent-models>
                                <model>model</model>
                            </dependent-models>
                            <dependent-instances>
                                <instance>fr-language-instance</instance>
                                <instance>orbeon-resources</instance>
                            </dependent-instances>
                        </analysis>
                    </value>
                </output>
                <output scope="" prefixed-id="my-output-2" model-prefixed-id="model" binding="false" value="true">
                    <value>
                        <analysis expression="string((xxf:r('bar.10.alert.0'))[1])" analyzed="true">
                            <value-dependent>
                                <path>instance('fr-language-instance')</path>
                                <path>instance('orbeon-resources')/resource/bar/alert</path>
                            </value-dependent>
                            <dependent-models>
                                <model>model</model>
                            </dependent-models>
                            <dependent-instances>
                                <instance>fr-language-instance</instance>
                                <instance>orbeon-resources</instance>
                            </dependent-instances>
                        </analysis>
                    </value>
                </output>
                <foo scope="" prefixed-id="my-foo" model-prefixed-id="model" binding="false" value="false">
                    <model scope="my-foo" prefixed-id="my-foomodel" default-instance-prefixed-id="my-foofr-form-resources" analyzed-binds="true">
                        <instance scope="my-foo" prefixed-id="my-foofr-form-resources" model-prefixed-id="my-foomodel" binding="false" value="false"/>
                    </model>
                    <template scope="my-foo" prefixed-id="my-fooxf-4" model-prefixed-id="my-foomodel" binding="false" value="false">
                        <output scope="my-foo" prefixed-id="my-foomy-output-1" model-prefixed-id="my-foomodel" binding="false" value="true">
                            <value>
                                <analysis expression="string((xxf:r('foo.message'))[1])" analyzed="true">
                                    <value-dependent>
                                        <path>instance('fr-language-instance')</path>
                                        <path>instance('my-foofr-form-resources')/resource/foo/message</path>
                                    </value-dependent>
                                    <dependent-models>
                                        <model>model</model>
                                        <model>my-foomodel</model>
                                    </dependent-models>
                                    <dependent-instances>
                                        <instance>fr-language-instance</instance>
                                        <instance>my-foofr-form-resources</instance>
                                    </dependent-instances>
                                </analysis>
                            </value>
                        </output>
                        <output scope="my-foo" prefixed-id="my-foomy-output-2" model-prefixed-id="my-foomodel" binding="false" value="true">
                           <value>
                               <analysis expression="string((xxf:r('foo.42.alert.0'))[1])" analyzed="true">
                                   <value-dependent>
                                       <path>instance('fr-language-instance')</path>
                                       <path>instance('my-foofr-form-resources')/resource/foo/alert</path>
                                   </value-dependent>
                                    <dependent-models>
                                        <model>model</model>
                                        <model>my-foomodel</model>
                                    </dependent-models>
                                    <dependent-instances>
                                        <instance>fr-language-instance</instance>
                                        <instance>my-foofr-form-resources</instance>
                                    </dependent-instances>
                                </analysis>
                            </value>
                        </output>

                    </template>
                </foo>
            </root>
        </output>
    </test>

    <test description="xxf:lang()" name="oxf:xforms-xpath-analysis">
        <input name="form">
            <xh:html xml:lang="{xxf:instance('fr-language-instance')}">
                <xh:head>
                    <xf:model xxf:xpath-analysis="true" id="model">
                        <xf:instance id="fr-language-instance">
                            <lang>en</lang>
                        </xf:instance>
                    </xf:model>
                    <xbl:xbl>
                        <xbl:binding id="fr-foo" element="fr|foo">
                            <xbl:template>
                                <xf:output id="my-output" value="xxf:lang()"/>
                            </xbl:template>
                        </xbl:binding>
                    </xbl:xbl>
                </xh:head>
                <xh:body>
                    <xf:output id="my-output" value="xxf:lang()"/>
                    <fr:foo id="my-foo"/>
                </xh:body>
            </xh:html>
        </input>
        <output name="analysis">
            <root scope="" prefixed-id="#document" model-prefixed-id="model" binding="false" value="false">
                <attribute scope="" prefixed-id="xf-2" model-prefixed-id="model" binding="false" value="true" name="xml:lang">
                    <value>
                        <analysis expression="{xxf:instance('fr-language-instance')}" analyzed="true">
                            <value-dependent>
                                <path>instance('fr-language-instance')</path>
                            </value-dependent>
                            <dependent-models>
                                <model>model</model>
                            </dependent-models>
                            <dependent-instances>
                                <instance>fr-language-instance</instance>
                            </dependent-instances>
                        </analysis>
                    </value>
                </attribute>
                <model scope="" prefixed-id="model" default-instance-prefixed-id="fr-language-instance" analyzed-binds="true">
                    <instance scope="" prefixed-id="fr-language-instance" model-prefixed-id="model" binding="false" value="false"/>
                </model>
                <output scope="" prefixed-id="my-output" model-prefixed-id="model" binding="false" value="true">
                    <value>
                        <analysis expression="string((xxf:lang())[1])" analyzed="true">
                            <value-dependent>
                                <path>instance('fr-language-instance')</path>
                            </value-dependent>
                            <dependent-models>
                                <model>model</model>
                            </dependent-models>
                            <dependent-instances>
                                <instance>fr-language-instance</instance>
                            </dependent-instances>
                        </analysis>
                    </value>
                </output>
                <foo scope="" prefixed-id="my-foo" model-prefixed-id="model" binding="false" value="false">
                    <template scope="my-foo" prefixed-id="my-fooxf-4" binding="false" value="false">
                        <output scope="my-foo" prefixed-id="my-foomy-output" binding="false" value="true">
                            <value>
                                <analysis expression="string((xxf:lang())[1])" analyzed="true">
                                    <value-dependent>
                                        <path>instance('fr-language-instance')</path>
                                    </value-dependent>
                                    <dependent-models>
                                        <model>model</model>
                                    </dependent-models>
                                    <dependent-instances>
                                        <instance>fr-language-instance</instance>
                                    </dependent-instances>
                                </analysis>
                            </value>
                        </output>
                    </template>
                </foo>
            </root>
        </output>
    </test>

    <test description="xxf:format-message()" name="oxf:xforms-xpath-analysis">
        <input name="form">
            <xh:html xml:lang="{xxf:instance('fr-language-instance')}">
                <xh:head>
                    <xf:model xxf:xpath-analysis="true" id="model">
                        <xf:instance id="main">
                            <form>
                                <invalid>10</invalid>
                                <processed>20</processed>
                            </form>
                        </xf:instance>
                        <xf:instance id="fr-language-instance">
                            <lang>en</lang>
                        </xf:instance>
                    </xf:model>
                </xh:head>
                <xh:body>
                    <xf:output id="my-output" value="xxf:format-message(
                        'NOTE: {0,number,integer} out of {1,number,integer} {1,choice,1#document|1&lt;documents} {0,choice,1#is|1&lt;are} invalid. Only valid documents will be imported.',
                        for $n in (invalid, processed) return xs:integer($n)
                      )"/>
                    <fr:foo id="my-foo"/>
                </xh:body>
            </xh:html>
        </input>
        <output name="analysis">
            <root scope="" prefixed-id="#document" model-prefixed-id="model" binding="false" value="false">
                <attribute scope="" prefixed-id="xf-2" model-prefixed-id="model" binding="false" value="true" name="xml:lang">
                    <value>
                        <analysis expression="{xxf:instance('fr-language-instance')}" analyzed="true">
                            <value-dependent>
                                <path>instance('fr-language-instance')</path>
                            </value-dependent>
                            <dependent-models>
                                <model>model</model>
                            </dependent-models>
                            <dependent-instances>
                                <instance>fr-language-instance</instance>
                            </dependent-instances>
                        </analysis>
                    </value>
                </attribute>
                <model scope="" prefixed-id="model" default-instance-prefixed-id="main" analyzed-binds="true">
                    <instance scope="" prefixed-id="main" model-prefixed-id="model" binding="false" value="false"/>
                    <instance scope="" prefixed-id="fr-language-instance" model-prefixed-id="model" binding="false" value="false"/>
                </model>
                <output scope="" prefixed-id="my-output" model-prefixed-id="model" binding="false" value="true">
                    <value>
                        <analysis expression="string((xxf:format-message(                         'NOTE: {0,number,integer} out of {1,number,integer} {1,choice,1#document|1&lt;documents} {0,choice,1#is|1&lt;are} invalid. Only valid documents will be imported.',                         for $n in (invalid, processed) return xs:integer($n)                       ))[1])" analyzed="true">
                            <value-dependent>
                                <path>instance('main')/invalid</path>
                                <path>instance('main')/processed</path>
                                <path>instance('fr-language-instance')</path>
                            </value-dependent>
                            <dependent-models>
                                <model>model</model>
                            </dependent-models>
                            <dependent-instances>
                                <instance>main</instance>
                                <instance>fr-language-instance</instance>
                            </dependent-instances>
                        </analysis>
                    </value>
                </output>
            </root>
        </output>
    </test>

    <!-- Map functions don't support PathMap yet so this test is disabled as of 2017-06-28. -->
    <test description="#3293: Map functions" name="oxf:xforms-xpath-analysis" exclude="true">
        <input name="form">
            <xh:html xmlns:map="http://www.w3.org/2005/xpath-functions/map">
                <xh:head>
                    <xf:model xxf:xpath-analysis="true" id="model">
                        <xf:instance id="main">
                            <form>
                                <number>42</number>
                                <string>forty-two</string>
                                <node>text</node>
                                <sequence/>
                            </form>
                        </xf:instance>
                    </xf:model>
                </xh:head>
                <xh:body>
                    <xf:var
                        name="map"
                        value="
                            map:merge(
                                (
                                    map:entry('number',   number/xs:integer(.)),
                                    map:entry('string',   string/string()),
                                    map:entry('node',     node),
                                    map:entry('sequence', 1 to 10)
                                )
                            )"/>

                    <xf:var name="number"    value="map:get($map, 'number')"/>
                    <xf:var name="string"    value="map:get($map, 'string')"/>
                    <xf:var name="node-text" value="map:get($map, 'node')/string()"/>
                    <xf:var name="sequence"  value="string-join(for $v in map:get($map, 'sequence') return string($v), ' ')"/>
                </xh:body>
            </xh:html>
        </input>
        <output name="analysis">
            <root/>
        </output>
    </test>

    <test description="xxf:binding() function" name="oxf:xforms-xpath-analysis">
        <input name="form">
            <xh:html xmlns:xxbl="http://orbeon.org/oxf/xml/xbl">
                <xh:head>
                    <xf:model xxf:xpath-analysis="true" id="model">
                        <xf:instance id="main">
                            <form>
                                <number>42</number>
                            </form>
                        </xf:instance>
                    </xf:model>
                    <xbl:xbl>
                        <xbl:binding id="fr-foo" element="fr|foo" xxbl:mode="binding">
                            <xbl:template>
                                <xf:var id="v1" name="v1" value="xxf:binding('fr-foo')"/>
                                <xf:output id="o1" value="xxf:binding('fr-foo')"/>
                                <xf:var id="v1-outer" name="v1-outer" xxbl:scope="outer">
                                    <xxf:value value="$v1" xxbl:scope="inner"/>
                                </xf:var>
                            </xbl:template>
                        </xbl:binding>
                    </xbl:xbl>
                </xh:head>
                <xh:body>
                    <fr:foo id="my-foo" ref="number"/>
                </xh:body>
            </xh:html>
        </input>
        <output name="analysis">
            <root scope="" prefixed-id="#document" model-prefixed-id="model" binding="false" value="false">
                <model scope="" prefixed-id="model" default-instance-prefixed-id="main" analyzed-binds="true">
                    <instance scope="" prefixed-id="main" model-prefixed-id="model" binding="false" value="false"/>
                </model>
                <foo scope="" prefixed-id="my-foo" model-prefixed-id="model" binding="true" value="false">
                    <binding>
                        <analysis expression="number" analyzed="true">
                            <returnable>
                                <path>instance('main')/number</path>
                            </returnable>
                            <dependent-models>
                                <model>model</model>
                            </dependent-models>
                            <dependent-instances>
                                <instance>main</instance>
                            </dependent-instances>
                            <returnable-instances>
                                <instance>main</instance>
                            </returnable-instances>
                        </analysis>
                    </binding>
                    <template scope="my-foo" prefixed-id="my-fooxf-2" binding="false" value="false">
                        <var scope="my-foo" prefixed-id="my-foov1" binding="false" value="false" name="v1">
                            <value>
                                <analysis expression="xxf:binding('fr-foo')" analyzed="true">
                                    <returnable>
                                        <path>instance('main')/number</path>
                                    </returnable>
                                    <dependent-models>
                                        <model>model</model>
                                    </dependent-models>
                                    <dependent-instances>
                                        <instance>main</instance>
                                    </dependent-instances>
                                    <returnable-instances>
                                        <instance>main</instance>
                                    </returnable-instances>
                                </analysis>
                            </value>
                        </var>
                        <output scope="my-foo" prefixed-id="my-fooo1" binding="false" value="true">
                            <value>
                                <analysis expression="string((xxf:binding('fr-foo'))[1])" analyzed="true">
                                    <value-dependent>
                                        <path>instance('main')/number</path>
                                    </value-dependent>
                                    <dependent-models>
                                        <model>model</model>
                                    </dependent-models>
                                    <dependent-instances>
                                        <instance>main</instance>
                                    </dependent-instances>
                                </analysis>
                            </value>
                        </output>
                        <var scope="" prefixed-id="my-foov1-outer" model-prefixed-id="model" binding="false" value="false" name="v1-outer">
                            <value>
                                <analysis expression="$v1" analyzed="true">
                                    <returnable>
                                        <path>instance('main')/number</path>
                                    </returnable>
                                    <dependent-models>
                                        <model>model</model>
                                    </dependent-models>
                                    <dependent-instances>
                                        <instance>main</instance>
                                    </dependent-instances>
                                    <returnable-instances>
                                        <instance>main</instance>
                                    </returnable-instances>
                                </analysis>
                            </value>
                        </var>
                    </template>
                </foo>
            </root>
        </output>
    </test>

</group>
