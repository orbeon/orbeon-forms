<?xml version="1.0" encoding="UTF-8"?>
<!--
  Copyright (C) 2010 Orbeon, Inc.

  This program is free software; you can redistribute it and/or modify it under the terms of the
  GNU Lesser General Public License as published by the Free Software Foundation; either version
  2.1 of the License, or (at your option) any later version.

  This program is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY;
  without even the implied warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.
  See the GNU Lesser General Public License for more details.

  The full text of the license is available at http://www.gnu.org/copyleft/lesser.html
  -->
<group description="XForms XPath Analysis" xmlns:p="http://www.orbeon.com/oxf/pipeline"
    xmlns:xsl="http://www.w3.org/1999/XSL/Transform"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xmlns:xs="http://www.w3.org/2001/XMLSchema"
    xmlns:xh="http://www.w3.org/1999/xhtml"
    xmlns:oxf="http://www.orbeon.com/oxf/processors"
    xmlns:xi="http://www.w3.org/2001/XInclude"
    xmlns:xxi="http://orbeon.org/oxf/xml/xinclude"
    xmlns:xf="http://www.w3.org/2002/xforms"
    xmlns:ev="http://www.w3.org/2001/xml-events"
    xmlns:xbl="http://www.w3.org/ns/xbl"
    xmlns:fr="http://orbeon.org/oxf/xml/form-runner">

    <test description="Simple xforms:bind dependencies" name="oxf:java">
        <input name="config">
            <config sourcepath="oxf:/" class="org.orbeon.oxf.xforms.analysis.XPathAnalysisProcessor"/>
        </input>
        <input name="form">
            <xh:html xmlns:xxf="http://orbeon.org/oxf/xml/xforms">
                <xh:head>
                    <xf:model id="model" xxf:xpath-analysis="true">
                        <xf:instance id="i1">
                            <instance/>
                        </xf:instance>
                        <xf:instance id="i2">
                            <instance/>
                        </xf:instance>
                        <xf:instance id="i3">
                            <instance/>
                        </xf:instance>
                        <xf:instance id="i4">
                            <instance/>
                        </xf:instance>
                        <xf:instance id="i5">
                            <instance/>
                        </xf:instance>
                        <xf:instance id="i6">
                            <instance/>
                        </xf:instance>

                        <xf:bind ref="instance('i1')" id="bv1" type="xs:integer"/>
                        <xf:bind ref="instance('i2')" id="bv2" constraint="true()"/>
                        <xf:bind ref="instance('i3')" id="bv3" required="true()"/>

                        <xf:bind ref="instance('i4')" id="bc1" relevant="false()"/>
                        <xf:bind ref="instance('i5')" id="bc2" calculate="42"/>
                        <xf:bind ref="instance('i6')" id="bc3" readonly="true()"/>
                        <xf:bind ref="instance('i7')" id="bc4" xxf:default="42"/>

                    </xf:model>
                </xh:head>
                <xh:body/>
            </xh:html>
        </input>
        <output name="analysis">
            <request request-uri="/orbeon/doc/home-welcome" query-string="id=12&amp;print=false" method="GET">
                <model scope="" prefixed-id="model" default-instance-prefixed-id="i1" analyzed-binds="true">
                    <binds>
                        <bind id="bv1" ref="instance('i1')">
                            <analysis expression="instance('i1')" analyzed="true">
                                <returnable>
                                    <path>instance('i1')</path>
                                </returnable>
                                <dependent-models>
                                    <model>model</model>
                                </dependent-models>
                                <dependent-instances>
                                    <instance>i1</instance>
                                </dependent-instances>
                                <returnable-instances>
                                    <instance>i1</instance>
                                </returnable-instances>
                            </analysis>
                        </bind>
                        <bind id="bv2" ref="instance('i2')">
                            <analysis expression="instance('i2')" analyzed="true">
                                <returnable>
                                    <path>instance('i2')</path>
                                </returnable>
                                <dependent-models>
                                    <model>model</model>
                                </dependent-models>
                                <dependent-instances>
                                    <instance>i2</instance>
                                </dependent-instances>
                                <returnable-instances>
                                    <instance>i2</instance>
                                </returnable-instances>
                            </analysis>
                            <mip name="constraint" expression="true()">
                                <analysis expression="xs:boolean((true())[1])" analyzed="true"/>
                            </mip>
                        </bind>
                        <bind id="bv3" ref="instance('i3')">
                            <analysis expression="instance('i3')" analyzed="true">
                                <returnable>
                                    <path>instance('i3')</path>
                                </returnable>
                                <dependent-models>
                                    <model>model</model>
                                </dependent-models>
                                <dependent-instances>
                                    <instance>i3</instance>
                                </dependent-instances>
                                <returnable-instances>
                                    <instance>i3</instance>
                                </returnable-instances>
                            </analysis>
                            <mip name="required" expression="true()">
                                <analysis expression="xs:boolean((true())[1])" analyzed="true"/>
                            </mip>
                        </bind>
                        <bind id="bc1" ref="instance('i4')">
                            <analysis expression="instance('i4')" analyzed="true">
                                <returnable>
                                    <path>instance('i4')</path>
                                </returnable>
                                <dependent-models>
                                    <model>model</model>
                                </dependent-models>
                                <dependent-instances>
                                    <instance>i4</instance>
                                </dependent-instances>
                                <returnable-instances>
                                    <instance>i4</instance>
                                </returnable-instances>
                            </analysis>
                            <mip name="relevant" expression="false()">
                                <analysis expression="xs:boolean((false())[1])" analyzed="true"/>
                            </mip>
                        </bind>
                        <bind id="bc2" ref="instance('i5')">
                            <analysis expression="instance('i5')" analyzed="true">
                                <returnable>
                                    <path>instance('i5')</path>
                                </returnable>
                                <dependent-models>
                                    <model>model</model>
                                </dependent-models>
                                <dependent-instances>
                                    <instance>i5</instance>
                                </dependent-instances>
                                <returnable-instances>
                                    <instance>i5</instance>
                                </returnable-instances>
                            </analysis>
                            <mip name="calculate" expression="42">
                                <analysis expression="xs:string((42)[1])" analyzed="true"/>
                            </mip>
                        </bind>
                        <bind id="bc3" ref="instance('i6')">
                            <analysis expression="instance('i6')" analyzed="true">
                                <returnable>
                                    <path>instance('i6')</path>
                                </returnable>
                                <dependent-models>
                                    <model>model</model>
                                </dependent-models>
                                <dependent-instances>
                                    <instance>i6</instance>
                                </dependent-instances>
                                <returnable-instances>
                                    <instance>i6</instance>
                                </returnable-instances>
                            </analysis>
                            <mip name="readonly" expression="true()">
                                <analysis expression="xs:boolean((true())[1])" analyzed="true"/>
                            </mip>
                        </bind>
                        <bind id="bc4" ref="instance('i7')">
                            <analysis expression="instance('i7')" analyzed="true">
                                <returnable>
                                    <path>instance('i7')</path>
                                </returnable>
                                <dependent-models>
                                    <model>model</model>
                                </dependent-models>
                                <dependent-instances>
                                    <instance>i7</instance>
                                </dependent-instances>
                                <returnable-instances>
                                    <instance>i7</instance>
                                </returnable-instances>
                            </analysis>
                            <mip name="initial-value" expression="42">
                                <analysis expression="xs:string((42)[1])" analyzed="true"/>
                            </mip>
                        </bind>
                    </binds>
                    <bind-instances>
                        <instance>i1</instance>
                        <instance>i2</instance>
                        <instance>i3</instance>
                        <instance>i4</instance>
                        <instance>i5</instance>
                        <instance>i6</instance>
                        <instance>i7</instance>
                    </bind-instances>
                    <computed-binds-instances>
                        <instance>i4</instance>
                        <instance>i5</instance>
                        <instance>i6</instance>
                        <instance>i7</instance>
                    </computed-binds-instances>
                    <validation-binds-instances>
                        <instance>i1</instance>
                        <instance>i2</instance>
                        <instance>i3</instance>
                    </validation-binds-instances>
                </model>
            </request>
        </output>
    </test>

    <test description="MIP xforms:bind dependencies" name="oxf:java">
        <input name="config">
            <config sourcepath="oxf:/" class="org.orbeon.oxf.xforms.analysis.XPathAnalysisProcessor"/>
        </input>
        <input name="form">
            <xh:html xmlns:xxf="http://orbeon.org/oxf/xml/xforms">
                <xh:head>
                    <xf:model id="model" xxf:xpath-analysis="true">
                        <xf:instance id="i1">
                            <instance>
                                <a/>
                                <b/>
                                <c/>
                            </instance>
                        </xf:instance>

                        <xf:instance id="i2">
                            <instance>
                                <a/>
                                <b/>
                                <c/>
                            </instance>
                        </xf:instance>

                        <xf:bind id="b1" ref="instance('i1')">
                            <xf:bind id="b11" ref="a" constraint="../b = 'x'"/>
                            <xf:bind id="b12" ref="b" readonly="instance('i2')/a"/>
                            <xf:bind id="b13" ref="instance()/c" required=". = 'y'"/>
                            <xf:bind id="b14" context="a"/>
                        </xf:bind>
                        <xf:bind id="b2" ref="instance('i2')">
                            <xf:bind id="b21" ref="a" calculate="concat(../b, ../c)"/>
                            <xf:bind id="b22" ref="b" xxf:default="concat(../a, ../c)"/>
                        </xf:bind>

                    </xf:model>
                </xh:head>
                <xh:body/>
            </xh:html>
        </input>
        <output name="analysis">
            <request request-uri="/orbeon/doc/home-welcome" query-string="id=12&amp;print=false" method="GET">
                <model scope="" prefixed-id="model" default-instance-prefixed-id="i1" analyzed-binds="false">
                    <binds>
                        <bind id="b1" ref="instance('i1')">
                            <analysis expression="instance('i1')" analyzed="true">
                                <returnable>
                                    <path>instance('i1')</path>
                                </returnable>
                                <dependent-models>
                                    <model>model</model>
                                </dependent-models>
                                <dependent-instances>
                                    <instance>i1</instance>
                                </dependent-instances>
                                <returnable-instances>
                                    <instance>i1</instance>
                                </returnable-instances>
                            </analysis>
                            <bind id="b11" ref="a">
                                <analysis expression="a" analyzed="true">
                                    <returnable>
                                        <path>instance('i1')/a</path>
                                    </returnable>
                                    <dependent-models>
                                        <model>model</model>
                                    </dependent-models>
                                    <dependent-instances>
                                        <instance>i1</instance>
                                    </dependent-instances>
                                    <returnable-instances>
                                        <instance>i1</instance>
                                    </returnable-instances>
                                </analysis>
                                <mip name="constraint" expression="../b = 'x'">
                                    <analysis expression="xs:boolean((../b = 'x')[1])" analyzed="true">
                                        <value-dependent>
                                            <path>instance('i1')/b</path>
                                        </value-dependent>
                                        <dependent-models>
                                            <model>model</model>
                                        </dependent-models>
                                        <dependent-instances>
                                            <instance>i1</instance>
                                        </dependent-instances>
                                    </analysis>
                                </mip>
                            </bind>
                            <bind id="b12" ref="b">
                                <analysis expression="b" analyzed="true">
                                    <returnable>
                                        <path>instance('i1')/b</path>
                                    </returnable>
                                    <dependent-models>
                                        <model>model</model>
                                    </dependent-models>
                                    <dependent-instances>
                                        <instance>i1</instance>
                                    </dependent-instances>
                                    <returnable-instances>
                                        <instance>i1</instance>
                                    </returnable-instances>
                                </analysis>
                                <mip name="readonly" expression="instance('i2')/a">
                                    <analysis expression="xs:boolean((instance('i2')/a)[1])" analyzed="true">
                                        <value-dependent>
                                            <path>instance('i2')/a</path>
                                        </value-dependent>
                                        <dependent-models>
                                            <model>model</model>
                                        </dependent-models>
                                        <dependent-instances>
                                            <instance>i2</instance>
                                        </dependent-instances>
                                    </analysis>
                                </mip>
                            </bind>
                            <bind id="b13" ref="instance()/c">
                                <analysis expression="instance()/c" analyzed="true">
                                    <returnable>
                                        <path>instance('i1')/c</path>
                                    </returnable>
                                    <dependent-models>
                                        <model>model</model>
                                    </dependent-models>
                                    <dependent-instances>
                                        <instance>i1</instance>
                                    </dependent-instances>
                                    <returnable-instances>
                                        <instance>i1</instance>
                                    </returnable-instances>
                                </analysis>
                                <mip name="required" expression=". = 'y'">
                                    <analysis expression="xs:boolean((. = 'y')[1])" analyzed="true">
                                        <value-dependent>
                                            <path>instance('i1')/c</path>
                                        </value-dependent>
                                        <dependent-models>
                                            <model>model</model>
                                        </dependent-models>
                                        <dependent-instances>
                                            <instance>i1</instance>
                                        </dependent-instances>
                                    </analysis>
                                </mip>
                            </bind>
                            <bind id="b14" context="a">
                                <analysis analyzed="false"/>
                            </bind>
                        </bind>
                        <bind id="b2" ref="instance('i2')">
                            <analysis expression="instance('i2')" analyzed="true">
                                <returnable>
                                    <path>instance('i2')</path>
                                </returnable>
                                <dependent-models>
                                    <model>model</model>
                                </dependent-models>
                                <dependent-instances>
                                    <instance>i2</instance>
                                </dependent-instances>
                                <returnable-instances>
                                    <instance>i2</instance>
                                </returnable-instances>
                            </analysis>
                            <bind id="b21" ref="a">
                                <analysis expression="a" analyzed="true">
                                    <returnable>
                                        <path>instance('i2')/a</path>
                                    </returnable>
                                    <dependent-models>
                                        <model>model</model>
                                    </dependent-models>
                                    <dependent-instances>
                                        <instance>i2</instance>
                                    </dependent-instances>
                                    <returnable-instances>
                                        <instance>i2</instance>
                                    </returnable-instances>
                                </analysis>
                                <mip name="calculate" expression="concat(../b, ../c)">
                                    <analysis expression="xs:string((concat(../b, ../c))[1])" analyzed="true">
                                        <value-dependent>
                                            <path>instance('i2')/b</path>
                                            <path>instance('i2')/c</path>
                                        </value-dependent>
                                        <dependent-models>
                                            <model>model</model>
                                        </dependent-models>
                                        <dependent-instances>
                                            <instance>i2</instance>
                                        </dependent-instances>
                                    </analysis>
                                </mip>
                            </bind>
                            <bind id="b22" ref="b">
                                <analysis expression="b" analyzed="true">
                                    <returnable>
                                        <path>instance('i2')/b</path>
                                    </returnable>
                                    <dependent-models>
                                        <model>model</model>
                                    </dependent-models>
                                    <dependent-instances>
                                        <instance>i2</instance>
                                    </dependent-instances>
                                    <returnable-instances>
                                        <instance>i2</instance>
                                    </returnable-instances>
                                </analysis>
                                <mip name="initial-value" expression="concat(../a, ../c)">
                                    <analysis expression="xs:string((concat(../a, ../c))[1])" analyzed="true">
                                        <value-dependent>
                                            <path>instance('i2')/a</path>
                                            <path>instance('i2')/c</path>
                                        </value-dependent>
                                        <dependent-models>
                                            <model>model</model>
                                        </dependent-models>
                                        <dependent-instances>
                                            <instance>i2</instance>
                                        </dependent-instances>
                                    </analysis>
                                </mip>
                            </bind>
                        </bind>
                    </binds>
                </model>
            </request>
        </output>
    </test>

    <test description="Rejection of unsupported attributes" name="oxf:java">
        <input name="config">
            <config sourcepath="oxf:/" class="org.orbeon.oxf.xforms.analysis.XPathAnalysisProcessor"/>
        </input>
        <input name="form">
            <xh:html xmlns:xxf="http://orbeon.org/oxf/xml/xforms">
                <xh:head>
                    <xf:model id="model" xxf:xpath-analysis="true">
                        <xf:instance id="instance">
                            <instance/>
                        </xf:instance>
                        <xf:bind ref="." id="my-bind"/>
                    </xf:model>
                </xh:head>
                <xh:body>
                    <!-- NOTE: @bind now supported -->
                    <xf:input id="u1" bind="my-bind"/>
                    <xf:input id="u2" context="." ref="b"/>
                </xh:body>
            </xh:html>
        </input>
        <output name="analysis">
            <request request-uri="/orbeon/doc/home-welcome" query-string="id=12&amp;print=false" method="GET">
                <control name="input" scope="" prefixed-id="u1" model-prefixed-id="model" binding="true" value="true">
                    <binding>
                        <analysis expression="." analyzed="true">
                            <returnable>
                                <path>instance('instance')</path>
                            </returnable>
                            <dependent-models>
                                <model>model</model>
                            </dependent-models>
                            <dependent-instances>
                                <instance>instance</instance>
                            </dependent-instances>
                            <returnable-instances>
                                <instance>instance</instance>
                            </returnable-instances>
                        </analysis>
                    </binding>
                    <value>
                        <analysis expression="xs:string(.[1])" analyzed="true">
                            <value-dependent>
                                <path>instance('instance')</path>
                            </value-dependent>
                            <dependent-models>
                                <model>model</model>
                            </dependent-models>
                            <dependent-instances>
                                <instance>instance</instance>
                            </dependent-instances>
                        </analysis>
                    </value>
                </control>
                <control name="input" scope="" prefixed-id="u2" model-prefixed-id="model" binding="true" value="true">
                    <binding>
                        <analysis analyzed="false"/>
                    </binding>
                    <value>
                        <analysis expression="xs:string(.[1])" analyzed="false"/>
                    </value>
                </control>
                <model scope="" prefixed-id="model" default-instance-prefixed-id="instance" analyzed-binds="true">
                    <binds>
                        <bind id="my-bind" ref=".">
                            <analysis expression="." analyzed="true">
                                <returnable>
                                    <path>instance('instance')</path>
                                </returnable>
                                <dependent-models>
                                    <model>model</model>
                                </dependent-models>
                                <dependent-instances>
                                    <instance>instance</instance>
                                </dependent-instances>
                                <returnable-instances>
                                    <instance>instance</instance>
                                </returnable-instances>
                            </analysis>
                        </bind>
                    </binds>
                    <bind-instances>
                        <instance>instance</instance>
                    </bind-instances>
                </model>
            </request>            
        </output>
    </test>

    <test description="Rejection of unsupported expressions" name="oxf:java">
        <input name="config">
            <config sourcepath="oxf:/" class="org.orbeon.oxf.xforms.analysis.XPathAnalysisProcessor"/>
        </input>
        <input name="form">
            <xh:html xmlns:xxf="http://orbeon.org/oxf/xml/xforms">
                <xh:head>
                    <xf:model id="model" xxf:xpath-analysis="true">
                        <xf:instance id="instance">
                            <instance/>
                        </xf:instance>
                    </xf:model>
                </xh:head>
                <xh:body>
                    <xf:input id="u1" ref="instance('instance')/a/*"/>
                    <xf:input id="u2" ref="instance('instance')/*/b"/>
                    <!-- TODO: This could be reliably analyzed w/o schema -->
                    <xf:input id="u3" ref="instance('instance')/a/*/parent::a"/>
                    <!-- TODO: This could be reliably analyzed w/o schema -->
                    <xf:input id="u4" ref="instance('instance')/a/*/ancestor::a"/>
                    <xf:input id="u5" ref="instance('instance')/a//parent::a"/>
                    <!-- Can't analyze w/o schema: e.g. if data is instance('instance')/a/b/a/c/ancestor::a -->
                    <xf:input id="u6" ref="instance('instance')/a//ancestor::a"/>

                    <!-- TODO: This should be supported -->
                    <xf:input id="u7" ref="/a/b"/>
                    <xf:input id="u8" ref="../a/b"/>
                    <!-- TODO: This should be supported -->
                    <xf:input id="u9" ref="root()/a/b"/>

                    <!-- NOTE: must be supported in the future, but there is a bug in the PathMap code as of 2010-10-05 -->
                    <xf:output id="u10" value="a/count(following-sibling::b)"/>

                </xh:body>
            </xh:html>
        </input>
        <output name="analysis">
            <request request-uri="/orbeon/doc/home-welcome" query-string="id=12&amp;print=false" method="GET">
                <control name="input" scope="" prefixed-id="u1" model-prefixed-id="model" binding="true" value="true">
                    <binding>
                        <analysis expression="instance('instance')/a/*" analyzed="false"/>
                    </binding>
                    <value>
                        <analysis expression="xs:string(.[1])" analyzed="false"/>
                    </value>
                </control>
                <control name="input" scope="" prefixed-id="u2" model-prefixed-id="model" binding="true" value="true">
                    <binding>
                        <analysis expression="instance('instance')/*/b" analyzed="false"/>
                    </binding>
                    <value>
                        <analysis expression="xs:string(.[1])" analyzed="false"/>
                    </value>
                </control>
                <control name="input" scope="" prefixed-id="u3" model-prefixed-id="model" binding="true" value="true">
                    <binding>
                        <analysis expression="instance('instance')/a/*/parent::a" analyzed="false"/>
                    </binding>
                    <value>
                        <analysis expression="xs:string(.[1])" analyzed="false"/>
                    </value>
                </control>
                <control name="input" scope="" prefixed-id="u4" model-prefixed-id="model" binding="true" value="true">
                    <binding>
                        <analysis expression="instance('instance')/a/*/ancestor::a" analyzed="false"/>
                    </binding>
                    <value>
                        <analysis expression="xs:string(.[1])" analyzed="false"/>
                    </value>
                </control>
                <control name="input" scope="" prefixed-id="u5" model-prefixed-id="model" binding="true" value="true">
                    <binding>
                        <analysis expression="instance('instance')/a//parent::a" analyzed="false"/>
                    </binding>
                    <value>
                        <analysis expression="xs:string(.[1])" analyzed="false"/>
                    </value>
                </control>
                <control name="input" scope="" prefixed-id="u6" model-prefixed-id="model" binding="true" value="true">
                    <binding>
                        <analysis expression="instance('instance')/a//ancestor::a" analyzed="false"/>
                    </binding>
                    <value>
                        <analysis expression="xs:string(.[1])" analyzed="false"/>
                    </value>
                </control>
                <control name="input" scope="" prefixed-id="u7" model-prefixed-id="model" binding="true" value="true">
                    <binding>
                        <analysis expression="/a/b" analyzed="false"/>
                    </binding>
                    <value>
                        <analysis expression="xs:string(.[1])" analyzed="false"/>
                    </value>
                </control>
                <control name="input" scope="" prefixed-id="u8" model-prefixed-id="model" binding="true" value="true">
                    <binding>
                        <analysis expression="../a/b" analyzed="false"/>
                    </binding>
                    <value>
                        <analysis expression="xs:string(.[1])" analyzed="false"/>
                    </value>
                </control>
                <control name="input" scope="" prefixed-id="u9" model-prefixed-id="model" binding="true" value="true">
                    <binding>
                        <analysis expression="root()/a/b" analyzed="false"/>
                    </binding>
                    <value>
                        <analysis expression="xs:string(.[1])" analyzed="false"/>
                    </value>
                </control>
                <control name="output" scope="" prefixed-id="u10" model-prefixed-id="model" binding="false" value="true">
                    <value>
                        <analysis expression="xs:string((a/count(following-sibling::b))[1])" analyzed="false"/>
                    </value>
                </control>
                <model scope="" prefixed-id="model" default-instance-prefixed-id="instance" analyzed-binds="true"/>
            </request>
        </output>
    </test>

    <test description="Handling of parent:: and ancestor:: axes" name="oxf:java">
        <input name="config">
            <config sourcepath="oxf:/" class="org.orbeon.oxf.xforms.analysis.XPathAnalysisProcessor"/>
        </input>
        <input name="form">
            <xh:html xmlns:xxf="http://orbeon.org/oxf/xml/xforms">
                <xh:head>
                    <xf:model id="model" xxf:xpath-analysis="true">
                        <xf:instance id="instance">
                            <instance/>
                        </xf:instance>
                    </xf:model>
                </xh:head>
                <xh:body>
                    <!-- parent:: -->
                    <xf:input id="p1" ref="instance('instance')/a/b"/>
                    <xf:input id="p2" ref="instance('instance')/a/.."/>
                    <xf:input id="p3" ref="instance('instance')/a/../b"/>

                    <!-- ancestor:: -->
                    <xf:input id="a1" ref="instance('instance')/a/b/ancestor::a"/>
                    <xf:input id="a2" ref="instance('instance')/a/b/ancestor::a/c"/>
                    <xf:input id="a3" ref="instance('instance')/a/b/a/c/ancestor::a"/>
                    <xf:input id="a4" ref="instance('instance')/a/b/a/(c/ancestor::a | d)"/>
                </xh:body>
            </xh:html>
        </input>
        <output name="analysis">
            <request request-uri="/orbeon/doc/home-welcome" query-string="id=12&amp;print=false" method="GET">
                <control name="input" scope="" prefixed-id="p1" model-prefixed-id="model" binding="true" value="true">
                    <binding>
                        <analysis expression="instance('instance')/a/b" analyzed="true">
                            <returnable>
                                <path>instance('instance')/a/b</path>
                            </returnable>
                            <dependent-models>
                                <model>model</model>
                            </dependent-models>
                            <dependent-instances>
                                <instance>instance</instance>
                            </dependent-instances>
                            <returnable-instances>
                                <instance>instance</instance>
                            </returnable-instances>
                        </analysis>
                    </binding>
                    <value>
                        <analysis expression="xs:string(.[1])" analyzed="true">
                            <value-dependent>
                                <path>instance('instance')/a/b</path>
                            </value-dependent>
                            <dependent-models>
                                <model>model</model>
                            </dependent-models>
                            <dependent-instances>
                                <instance>instance</instance>
                            </dependent-instances>
                        </analysis>
                    </value>
                </control>
                <control name="input" scope="" prefixed-id="p2" model-prefixed-id="model" binding="true" value="true">
                    <binding>
                        <analysis expression="instance('instance')/a/.." analyzed="true">
                            <returnable>
                                <path>instance('instance')</path>
                            </returnable>
                            <dependent-models>
                                <model>model</model>
                            </dependent-models>
                            <dependent-instances>
                                <instance>instance</instance>
                            </dependent-instances>
                            <returnable-instances>
                                <instance>instance</instance>
                            </returnable-instances>
                        </analysis>
                    </binding>
                    <value>
                        <analysis expression="xs:string(.[1])" analyzed="true">
                            <value-dependent>
                                <path>instance('instance')</path>
                            </value-dependent>
                            <dependent-models>
                                <model>model</model>
                            </dependent-models>
                            <dependent-instances>
                                <instance>instance</instance>
                            </dependent-instances>
                        </analysis>
                    </value>
                </control>
                <control name="input" scope="" prefixed-id="p3" model-prefixed-id="model" binding="true" value="true">
                    <binding>
                        <analysis expression="instance('instance')/a/../b" analyzed="true">
                            <returnable>
                                <path>instance('instance')/b</path>
                            </returnable>
                            <dependent-models>
                                <model>model</model>
                            </dependent-models>
                            <dependent-instances>
                                <instance>instance</instance>
                            </dependent-instances>
                            <returnable-instances>
                                <instance>instance</instance>
                            </returnable-instances>
                        </analysis>
                    </binding>
                    <value>
                        <analysis expression="xs:string(.[1])" analyzed="true">
                            <value-dependent>
                                <path>instance('instance')/b</path>
                            </value-dependent>
                            <dependent-models>
                                <model>model</model>
                            </dependent-models>
                            <dependent-instances>
                                <instance>instance</instance>
                            </dependent-instances>
                        </analysis>
                    </value>
                </control>
                <control name="input" scope="" prefixed-id="a1" model-prefixed-id="model" binding="true" value="true">
                    <binding>
                        <analysis expression="instance('instance')/a/b/ancestor::a" analyzed="true">
                            <returnable>
                                <path>instance('instance')/a</path>
                            </returnable>
                            <dependent-models>
                                <model>model</model>
                            </dependent-models>
                            <dependent-instances>
                                <instance>instance</instance>
                            </dependent-instances>
                            <returnable-instances>
                                <instance>instance</instance>
                            </returnable-instances>
                        </analysis>
                    </binding>
                    <value>
                        <analysis expression="xs:string(.[1])" analyzed="true">
                            <value-dependent>
                                <path>instance('instance')/a</path>
                            </value-dependent>
                            <dependent-models>
                                <model>model</model>
                            </dependent-models>
                            <dependent-instances>
                                <instance>instance</instance>
                            </dependent-instances>
                        </analysis>
                    </value>
                </control>
                <control name="input" scope="" prefixed-id="a2" model-prefixed-id="model" binding="true" value="true">
                    <binding>
                        <analysis expression="instance('instance')/a/b/ancestor::a/c" analyzed="true">
                            <returnable>
                                <path>instance('instance')/a/c</path>
                            </returnable>
                            <dependent-models>
                                <model>model</model>
                            </dependent-models>
                            <dependent-instances>
                                <instance>instance</instance>
                            </dependent-instances>
                            <returnable-instances>
                                <instance>instance</instance>
                            </returnable-instances>
                        </analysis>
                    </binding>
                    <value>
                        <analysis expression="xs:string(.[1])" analyzed="true">
                            <value-dependent>
                                <path>instance('instance')/a/c</path>
                            </value-dependent>
                            <dependent-models>
                                <model>model</model>
                            </dependent-models>
                            <dependent-instances>
                                <instance>instance</instance>
                            </dependent-instances>
                        </analysis>
                    </value>
                </control>
                <control name="input" scope="" prefixed-id="a3" model-prefixed-id="model" binding="true" value="true">
                    <binding>
                        <analysis expression="instance('instance')/a/b/a/c/ancestor::a" analyzed="true">
                            <returnable>
                                <path>instance('instance')/a</path>
                                <path>instance('instance')/a/b/a</path>
                            </returnable>
                            <dependent-models>
                                <model>model</model>
                            </dependent-models>
                            <dependent-instances>
                                <instance>instance</instance>
                            </dependent-instances>
                            <returnable-instances>
                                <instance>instance</instance>
                            </returnable-instances>
                        </analysis>
                    </binding>
                    <value>
                        <analysis expression="xs:string(.[1])" analyzed="true">
                            <value-dependent>
                                <path>instance('instance')/a</path>
                                <path>instance('instance')/a/b/a</path>
                            </value-dependent>
                            <dependent-models>
                                <model>model</model>
                            </dependent-models>
                            <dependent-instances>
                                <instance>instance</instance>
                            </dependent-instances>
                        </analysis>
                    </value>
                </control>
                <control name="input" scope="" prefixed-id="a4" model-prefixed-id="model" binding="true" value="true">
                    <binding>
                        <analysis expression="instance('instance')/a/b/a/(c/ancestor::a | d)" analyzed="true">
                            <returnable>
                                <path>instance('instance')/a</path>
                                <path>instance('instance')/a/b/a</path>
                                <path>instance('instance')/a/b/a/d</path>
                            </returnable>
                            <dependent-models>
                                <model>model</model>
                            </dependent-models>
                            <dependent-instances>
                                <instance>instance</instance>
                            </dependent-instances>
                            <returnable-instances>
                                <instance>instance</instance>
                            </returnable-instances>
                        </analysis>
                    </binding>
                    <value>
                        <analysis expression="xs:string(.[1])" analyzed="true">
                            <value-dependent>
                                <path>instance('instance')/a</path>
                                <path>instance('instance')/a/b/a</path>
                                <path>instance('instance')/a/b/a/d</path>
                            </value-dependent>
                            <dependent-models>
                                <model>model</model>
                            </dependent-models>
                            <dependent-instances>
                                <instance>instance</instance>
                            </dependent-instances>
                        </analysis>
                    </value>
                </control>
                <model scope="" prefixed-id="model" default-instance-prefixed-id="instance" analyzed-binds="true"/>
            </request>
        </output>
    </test>

    <test description="Dependencies on other nodes" name="oxf:java">
        <input name="config">
            <config sourcepath="oxf:/" class="org.orbeon.oxf.xforms.analysis.XPathAnalysisProcessor"/>
        </input>
        <input name="form">
            <xh:html xmlns:xxf="http://orbeon.org/oxf/xml/xforms">
                <xh:head>
                    <xf:model id="model" xxf:xpath-analysis="true">
                        <xf:instance id="instance">
                            <instance/>
                        </xf:instance>
                    </xf:model>
                </xh:head>
                <xh:body>
                    <xf:input id="d1" ref="instance('instance')/a[b]"/>
                    <xf:input id="d2" ref="instance('instance')/a[b = 42]"/>
                    <xf:input id="d3" ref="instance('instance')/a[../b = 42]"/>
                </xh:body>
            </xh:html>
        </input>
        <output name="analysis">
            <request request-uri="/orbeon/doc/home-welcome" query-string="id=12&amp;print=false" method="GET">
                <control name="input" scope="" prefixed-id="d1" model-prefixed-id="model" binding="true" value="true">
                    <binding>
                        <analysis expression="instance('instance')/a[b]" analyzed="true">
                            <returnable>
                                <path>instance('instance')/a</path>
                            </returnable>
                            <dependent-models>
                                <model>model</model>
                            </dependent-models>
                            <dependent-instances>
                                <instance>instance</instance>
                            </dependent-instances>
                            <returnable-instances>
                                <instance>instance</instance>
                            </returnable-instances>
                        </analysis>
                    </binding>
                    <value>
                        <analysis expression="xs:string(.[1])" analyzed="true">
                            <value-dependent>
                                <path>instance('instance')/a</path>
                            </value-dependent>
                            <dependent-models>
                                <model>model</model>
                            </dependent-models>
                            <dependent-instances>
                                <instance>instance</instance>
                            </dependent-instances>
                        </analysis>
                    </value>
                </control>
                <control name="input" scope="" prefixed-id="d2" model-prefixed-id="model" binding="true" value="true">
                    <binding>
                        <analysis expression="instance('instance')/a[b = 42]" analyzed="true">
                            <value-dependent>
                                <path>instance('instance')/a/b</path>
                            </value-dependent>
                            <returnable>
                                <path>instance('instance')/a</path>
                            </returnable>
                            <dependent-models>
                                <model>model</model>
                            </dependent-models>
                            <dependent-instances>
                                <instance>instance</instance>
                            </dependent-instances>
                            <returnable-instances>
                                <instance>instance</instance>
                            </returnable-instances>
                        </analysis>
                    </binding>
                    <value>
                        <analysis expression="xs:string(.[1])" analyzed="true">
                            <value-dependent>
                                <path>instance('instance')/a</path>
                                <path>instance('instance')/a/b</path>
                            </value-dependent>
                            <dependent-models>
                                <model>model</model>
                            </dependent-models>
                            <dependent-instances>
                                <instance>instance</instance>
                            </dependent-instances>
                        </analysis>
                    </value>
                </control>
                <control name="input" scope="" prefixed-id="d3" model-prefixed-id="model" binding="true" value="true">
                    <binding>
                        <analysis expression="instance('instance')/a[../b = 42]" analyzed="true">
                            <value-dependent>
                                <path>instance('instance')/b</path>
                            </value-dependent>
                            <returnable>
                                <path>instance('instance')/a</path>
                            </returnable>
                            <dependent-models>
                                <model>model</model>
                            </dependent-models>
                            <dependent-instances>
                                <instance>instance</instance>
                            </dependent-instances>
                            <returnable-instances>
                                <instance>instance</instance>
                            </returnable-instances>
                        </analysis>
                    </binding>
                    <value>
                        <analysis expression="xs:string(.[1])" analyzed="true">
                            <value-dependent>
                                <path>instance('instance')/a</path>
                                <path>instance('instance')/b</path>
                            </value-dependent>
                            <dependent-models>
                                <model>model</model>
                            </dependent-models>
                            <dependent-instances>
                                <instance>instance</instance>
                            </dependent-instances>
                        </analysis>
                    </value>
                </control>
                <model scope="" prefixed-id="model" default-instance-prefixed-id="instance" analyzed-binds="true"/>
            </request>
        </output>
    </test>
    
    <test description="Model variables" name="oxf:java">
        <input name="config">
            <config sourcepath="oxf:/" class="org.orbeon.oxf.xforms.analysis.XPathAnalysisProcessor"/>
        </input>
        <input name="form" href="oxf:/org/orbeon/oxf/xforms/analysis/model-variables.xml"/>
        <output name="analysis">
            <request request-uri="/orbeon/doc/home-welcome" query-string="id=12&amp;print=false" method="GET">
                <control name="output" scope="" prefixed-id="output1" model-prefixed-id="model1" binding="false" value="true">
                    <value>
                        <analysis expression="xs:string(($mv)[1])" analyzed="true">
                            <value-dependent>
                                <path>instance('instance1')</path>
                            </value-dependent>
                            <dependent-models>
                                <model>model1</model>
                            </dependent-models>
                            <dependent-instances>
                                <instance>instance1</instance>
                            </dependent-instances>
                        </analysis>
                    </value>
                </control>
                <control name="group" scope="" prefixed-id="group2" model-prefixed-id="model2" binding="false" value="false"/>
                <control name="output" scope="" prefixed-id="output2a" model-prefixed-id="model2" binding="false" value="true">
                    <value>
                        <analysis expression="xs:string(($mv)[1])" analyzed="true">
                            <value-dependent>
                                <path>instance('instance2')</path>
                            </value-dependent>
                            <dependent-models>
                                <model>model2</model>
                            </dependent-models>
                            <dependent-instances>
                                <instance>instance2</instance>
                            </dependent-instances>
                        </analysis>
                    </value>
                </control>
                <control name="output" scope="" prefixed-id="output2b" model-prefixed-id="model1" binding="false" value="true">
                    <value>
                        <analysis expression="xs:string(($mv)[1])" analyzed="true">
                            <value-dependent>
                                <path>instance('instance1')</path>
                            </value-dependent>
                            <dependent-models>
                                <model>model1</model>
                            </dependent-models>
                            <dependent-instances>
                                <instance>instance1</instance>
                            </dependent-instances>
                        </analysis>
                    </value>
                </control>
                <control name="group" scope="" prefixed-id="group3" model-prefixed-id="model1" binding="true" value="false">
                    <binding>
                        <analysis expression="xxf:instance('instance2')" analyzed="true">
                            <returnable>
                                <path>instance('instance2')</path>
                            </returnable>
                            <dependent-models>
                                <model>model2</model>
                            </dependent-models>
                            <dependent-instances>
                                <instance>instance2</instance>
                            </dependent-instances>
                            <returnable-instances>
                                <instance>instance2</instance>
                            </returnable-instances>
                        </analysis>
                    </binding>
                </control>
                <control name="output" scope="" prefixed-id="output3a" model-prefixed-id="model1" binding="false" value="true">
                    <value>
                        <analysis expression="xs:string(($mv)[1])" analyzed="true">
                            <value-dependent>
                                <path>instance('instance1')</path>
                            </value-dependent>
                            <dependent-models>
                                <model>model1</model>
                            </dependent-models>
                            <dependent-instances>
                                <instance>instance1</instance>
                            </dependent-instances>
                        </analysis>
                    </value>
                </control>
                <control name="output" scope="" prefixed-id="output3b" model-prefixed-id="model1" binding="false" value="true">
                    <value>
                        <analysis expression="xs:string(($mv)[1])" analyzed="true">
                            <value-dependent>
                                <path>instance('instance1')</path>
                            </value-dependent>
                            <dependent-models>
                                <model>model1</model>
                            </dependent-models>
                            <dependent-instances>
                                <instance>instance1</instance>
                            </dependent-instances>
                        </analysis>
                    </value>
                </control>
                <control name="output" scope="" prefixed-id="output3c" model-prefixed-id="model2" binding="false" value="true">
                    <value>
                        <analysis expression="xs:string(($mv)[1])" analyzed="true">
                            <value-dependent>
                                <path>instance('instance2')</path>
                            </value-dependent>
                            <dependent-models>
                                <model>model2</model>
                            </dependent-models>
                            <dependent-instances>
                                <instance>instance2</instance>
                            </dependent-instances>
                        </analysis>
                    </value>
                </control>
                <control name="group" scope="" prefixed-id="group4" model-prefixed-id="model1" binding="false" value="false"/>
                <control name="output" scope="" prefixed-id="output4a" model-prefixed-id="model1" binding="false" value="true">
                    <value>
                        <analysis expression="xs:string(($mv)[1])" analyzed="true">
                            <value-dependent>
                                <path>instance('instance1')</path>
                            </value-dependent>
                            <dependent-models>
                                <model>model1</model>
                            </dependent-models>
                            <dependent-instances>
                                <instance>instance1</instance>
                            </dependent-instances>
                        </analysis>
                    </value>
                </control>
                <control name="output" scope="" prefixed-id="output4b" model-prefixed-id="model1" binding="false" value="true">
                    <value>
                        <analysis expression="xs:string(($mv)[1])" analyzed="true">
                            <value-dependent>
                                <path>instance('instance1')</path>
                            </value-dependent>
                            <dependent-models>
                                <model>model1</model>
                            </dependent-models>
                            <dependent-instances>
                                <instance>instance1</instance>
                            </dependent-instances>
                        </analysis>
                    </value>
                </control>
                <control name="output" scope="" prefixed-id="output4c" model-prefixed-id="model2" binding="false" value="true">
                    <value>
                        <analysis expression="xs:string(($mv)[1])" analyzed="true">
                            <value-dependent>
                                <path>instance('instance2')</path>
                            </value-dependent>
                            <dependent-models>
                                <model>model2</model>
                            </dependent-models>
                            <dependent-instances>
                                <instance>instance2</instance>
                            </dependent-instances>
                        </analysis>
                    </value>
                </control>
                <variable scope="" prefixed-id="xf-3" model-prefixed-id="model1" binding="false" value="false" name="mv1">
                    <value>
                        <analysis expression="$mv" analyzed="true">
                            <returnable>
                                <path>instance('instance1')</path>
                            </returnable>
                            <dependent-models>
                                <model>model1</model>
                            </dependent-models>
                            <dependent-instances>
                                <instance>instance1</instance>
                            </dependent-instances>
                            <returnable-instances>
                                <instance>instance1</instance>
                            </returnable-instances>
                        </analysis>
                    </value>
                </variable>
                <variable scope="" prefixed-id="xf-4" model-prefixed-id="model2" binding="false" value="false" name="mv2">
                    <value>
                        <analysis expression="$mv" analyzed="true">
                            <returnable>
                                <path>instance('instance2')</path>
                            </returnable>
                            <dependent-models>
                                <model>model2</model>
                            </dependent-models>
                            <dependent-instances>
                                <instance>instance2</instance>
                            </dependent-instances>
                            <returnable-instances>
                                <instance>instance2</instance>
                            </returnable-instances>
                        </analysis>
                    </value>
                </variable>
                <control name="output" scope="" prefixed-id="output5a" model-prefixed-id="model1" binding="false" value="true">
                    <value>
                        <analysis expression="xs:string(($mv1)[1])" analyzed="true">
                            <value-dependent>
                                <path>instance('instance1')</path>
                            </value-dependent>
                            <dependent-models>
                                <model>model1</model>
                            </dependent-models>
                            <dependent-instances>
                                <instance>instance1</instance>
                            </dependent-instances>
                        </analysis>
                    </value>
                </control>
                <control name="output" scope="" prefixed-id="output5b" model-prefixed-id="model1" binding="false" value="true">
                    <value>
                        <analysis expression="xs:string(($mv2)[1])" analyzed="true">
                            <value-dependent>
                                <path>instance('instance2')</path>
                            </value-dependent>
                            <dependent-models>
                                <model>model2</model>
                            </dependent-models>
                            <dependent-instances>
                                <instance>instance2</instance>
                            </dependent-instances>
                        </analysis>
                    </value>
                </control>
                <model scope="" prefixed-id="model1" default-instance-prefixed-id="instance1" analyzed-binds="true">
                    <variable scope="" prefixed-id="xf-1" model-prefixed-id="model1" binding="false" value="true" name="mv">
                        <value>
                            <analysis expression="instance()" analyzed="true">
                                <returnable>
                                    <path>instance('instance1')</path>
                                </returnable>
                                <dependent-models>
                                    <model>model1</model>
                                </dependent-models>
                                <dependent-instances>
                                    <instance>instance1</instance>
                                </dependent-instances>
                                <returnable-instances>
                                    <instance>instance1</instance>
                                </returnable-instances>
                            </analysis>
                        </value>
                    </variable>
                </model>
                <model scope="" prefixed-id="model2" default-instance-prefixed-id="instance2" analyzed-binds="true">
                    <variable scope="" prefixed-id="xf-2" model-prefixed-id="model2" binding="false" value="true" name="mv">
                        <value>
                            <analysis expression="instance()" analyzed="true">
                                <returnable>
                                    <path>instance('instance2')</path>
                                </returnable>
                                <dependent-models>
                                    <model>model2</model>
                                </dependent-models>
                                <dependent-instances>
                                    <instance>instance2</instance>
                                </dependent-instances>
                                <returnable-instances>
                                    <instance>instance2</instance>
                                </returnable-instances>
                            </analysis>
                        </value>
                    </variable>
                </model>
            </request>
        </output>
    </test>

    <test description="Simple xxforms:instance function within models" name="oxf:java">
        <input name="config">
            <config sourcepath="oxf:/" class="org.orbeon.oxf.xforms.analysis.XPathAnalysisProcessor"/>
        </input>
        <input name="form">
            <xh:html xmlns:xxf="http://orbeon.org/oxf/xml/xforms">
                <xh:head>
                    <xf:model id="model1" xxf:xpath-analysis="true">
                        <xf:instance id="instance1">
                            <instance>42</instance>
                        </xf:instance>
                        <xxf:variable name="mv" select="xxf:instance('instance2')"/>
                    </xf:model>
                    <xf:model id="model2">
                        <xf:instance id="instance2">
                            <instance>43</instance>
                        </xf:instance>
                        <xxf:variable name="mv" select="xxf:instance('instance1')"/>
                    </xf:model>
                </xh:head>
                <xh:body/>
            </xh:html>
        </input>
        <output name="analysis">
            <request request-uri="/orbeon/doc/home-welcome" query-string="id=12&amp;print=false" method="GET">
                <model scope="" prefixed-id="model1" default-instance-prefixed-id="instance1" analyzed-binds="true">
                    <variable scope="" prefixed-id="xf-1" model-prefixed-id="model1" binding="false" value="true" name="mv">
                        <value>
                            <analysis expression="xxf:instance('instance2')" analyzed="true">
                                <returnable>
                                    <path>instance('instance2')</path>
                                </returnable>
                                <dependent-models>
                                    <model>model2</model>
                                </dependent-models>
                                <dependent-instances>
                                    <instance>instance2</instance>
                                </dependent-instances>
                                <returnable-instances>
                                    <instance>instance2</instance>
                                </returnable-instances>
                            </analysis>
                        </value>
                    </variable>
                </model>
                <model scope="" prefixed-id="model2" default-instance-prefixed-id="instance2" analyzed-binds="true">
                    <variable scope="" prefixed-id="xf-2" model-prefixed-id="model2" binding="false" value="true" name="mv">
                        <value>
                            <analysis expression="xxf:instance('instance1')" analyzed="true">
                                <returnable>
                                    <path>instance('instance1')</path>
                                </returnable>
                                <dependent-models>
                                    <model>model1</model>
                                </dependent-models>
                                <dependent-instances>
                                    <instance>instance1</instance>
                                </dependent-instances>
                                <returnable-instances>
                                    <instance>instance1</instance>
                                </returnable-instances>
                            </analysis>
                        </value>
                    </variable>
                </model>
            </request>
        </output>
    </test>

    <test description="Complex cross-models instance references" name="oxf:java">
        <input name="config">
            <config sourcepath="oxf:/" class="org.orbeon.oxf.xforms.analysis.XPathAnalysisProcessor"/>
        </input>
        <input name="form">
            <xh:html xmlns:xxf="http://orbeon.org/oxf/xml/xforms">
                <xh:head>
                    <xf:model xxf:xpath-analysis="true" id="model1">
                        <xf:instance id="instance11">
                            <instance/>
                        </xf:instance>
                        <xf:instance id="instance12">
                            <instance/>
                        </xf:instance>

                        <xxf:variable name="v11a" select="instance()"/>
                        <xxf:variable name="v11b" select="instance('instance11')"/>
                        <xxf:variable name="v12" select="instance('instance12')"/>

                        <xxf:variable name="v13" select="xxf:instance('instance21')"/>
                        <xxf:variable name="v14" select="xxf:instance('instance22')"/>

                        <xxf:variable name="v15a" model="model2" select="instance()"/><!-- TODO: fix this test -->
                        <xxf:variable name="v15b" model="model2" select="instance('instance21')"/><!-- TODO: fix this test -->
                        <xxf:variable name="v16" model="model2" select="instance('instance22')"/><!-- TODO: fix this test -->

                    </xf:model>
                    <xf:model id="model2">
                        <xf:instance id="instance21">
                            <instance/>
                        </xf:instance>
                        <xf:instance id="instance22">
                            <instance/>
                        </xf:instance>

                        <xxf:variable name="v21" select="instance()"/>
                        <xxf:variable name="v22" select="instance('instance22')"/>

                        <xxf:variable name="v23" select="xxf:instance('instance11')"/>
                        <xxf:variable name="v24" select="xxf:instance('instance12')"/>

                        <xxf:variable name="v25a" model="model1" select="instance()"/><!-- TODO: fix this test -->
                        <xxf:variable name="v25b" model="model1" select="instance('instance11')"/><!-- TODO: fix this test -->
                        <xxf:variable name="v26" model="model1" select="instance('instance12')"/><!-- TODO: fix this test -->

                    </xf:model>
                </xh:head>
                <xh:body/>
            </xh:html>
        </input>
        <output name="analysis">
            <request request-uri="/orbeon/doc/home-welcome" query-string="id=12&amp;print=false" method="GET">
                <model scope="" prefixed-id="model1" default-instance-prefixed-id="instance11" analyzed-binds="true">
                    <variable scope="" prefixed-id="xf-1" model-prefixed-id="model1" binding="false" value="true" name="v11a">
                        <value>
                            <analysis expression="instance()" analyzed="true">
                                <returnable>
                                    <path>instance('instance11')</path>
                                </returnable>
                                <dependent-models>
                                    <model>model1</model>
                                </dependent-models>
                                <dependent-instances>
                                    <instance>instance11</instance>
                                </dependent-instances>
                                <returnable-instances>
                                    <instance>instance11</instance>
                                </returnable-instances>
                            </analysis>
                        </value>
                    </variable>
                    <variable scope="" prefixed-id="xf-2" model-prefixed-id="model1" binding="false" value="true" name="v11b">
                        <value>
                            <analysis expression="instance('instance11')" analyzed="true">
                                <returnable>
                                    <path>instance('instance11')</path>
                                </returnable>
                                <dependent-models>
                                    <model>model1</model>
                                </dependent-models>
                                <dependent-instances>
                                    <instance>instance11</instance>
                                </dependent-instances>
                                <returnable-instances>
                                    <instance>instance11</instance>
                                </returnable-instances>
                            </analysis>
                        </value>
                    </variable>
                    <variable scope="" prefixed-id="xf-3" model-prefixed-id="model1" binding="false" value="true" name="v12">
                        <value>
                            <analysis expression="instance('instance12')" analyzed="true">
                                <returnable>
                                    <path>instance('instance12')</path>
                                </returnable>
                                <dependent-models>
                                    <model>model1</model>
                                </dependent-models>
                                <dependent-instances>
                                    <instance>instance12</instance>
                                </dependent-instances>
                                <returnable-instances>
                                    <instance>instance12</instance>
                                </returnable-instances>
                            </analysis>
                        </value>
                    </variable>
                    <variable scope="" prefixed-id="xf-4" model-prefixed-id="model1" binding="false" value="true" name="v13">
                        <value>
                            <analysis expression="xxf:instance('instance21')" analyzed="true">
                                <returnable>
                                    <path>instance('instance21')</path>
                                </returnable>
                                <dependent-models>
                                    <model>model2</model>
                                </dependent-models>
                                <dependent-instances>
                                    <instance>instance21</instance>
                                </dependent-instances>
                                <returnable-instances>
                                    <instance>instance21</instance>
                                </returnable-instances>
                            </analysis>
                        </value>
                    </variable>
                    <variable scope="" prefixed-id="xf-5" model-prefixed-id="model1" binding="false" value="true" name="v14">
                        <value>
                            <analysis expression="xxf:instance('instance22')" analyzed="true">
                                <returnable>
                                    <path>instance('instance22')</path>
                                </returnable>
                                <dependent-models>
                                    <model>model2</model>
                                </dependent-models>
                                <dependent-instances>
                                    <instance>instance22</instance>
                                </dependent-instances>
                                <returnable-instances>
                                    <instance>instance22</instance>
                                </returnable-instances>
                            </analysis>
                        </value>
                    </variable>
                    <variable scope="" prefixed-id="xf-6" model-prefixed-id="model1" binding="false" value="true" name="v15a">
                        <value>
                            <analysis expression="instance()" analyzed="true">
                                <returnable>
                                    <path>instance('instance11')</path>
                                </returnable>
                                <dependent-models>
                                    <model>model1</model>
                                </dependent-models>
                                <dependent-instances>
                                    <instance>instance11</instance>
                                </dependent-instances>
                                <returnable-instances>
                                    <instance>instance11</instance>
                                </returnable-instances>
                            </analysis>
                        </value>
                    </variable>
                    <variable scope="" prefixed-id="xf-7" model-prefixed-id="model1" binding="false" value="true" name="v15b">
                        <value>
                            <analysis expression="instance('instance21')" analyzed="true">
                                <returnable>
                                    <path>instance('instance21')</path>
                                </returnable>
                                <dependent-models>
                                    <model>model2</model>
                                </dependent-models>
                                <dependent-instances>
                                    <instance>instance21</instance>
                                </dependent-instances>
                                <returnable-instances>
                                    <instance>instance21</instance>
                                </returnable-instances>
                            </analysis>
                        </value>
                    </variable>
                    <variable scope="" prefixed-id="xf-8" model-prefixed-id="model1" binding="false" value="true" name="v16">
                        <value>
                            <analysis expression="instance('instance22')" analyzed="true">
                                <returnable>
                                    <path>instance('instance22')</path>
                                </returnable>
                                <dependent-models>
                                    <model>model2</model>
                                </dependent-models>
                                <dependent-instances>
                                    <instance>instance22</instance>
                                </dependent-instances>
                                <returnable-instances>
                                    <instance>instance22</instance>
                                </returnable-instances>
                            </analysis>
                        </value>
                    </variable>
                </model>
                <model scope="" prefixed-id="model2" default-instance-prefixed-id="instance21" analyzed-binds="true">
                    <variable scope="" prefixed-id="xf-9" model-prefixed-id="model2" binding="false" value="true" name="v21">
                        <value>
                            <analysis expression="instance()" analyzed="true">
                                <returnable>
                                    <path>instance('instance21')</path>
                                </returnable>
                                <dependent-models>
                                    <model>model2</model>
                                </dependent-models>
                                <dependent-instances>
                                    <instance>instance21</instance>
                                </dependent-instances>
                                <returnable-instances>
                                    <instance>instance21</instance>
                                </returnable-instances>
                            </analysis>
                        </value>
                    </variable>
                    <variable scope="" prefixed-id="xf-10" model-prefixed-id="model2" binding="false" value="true" name="v22">
                        <value>
                            <analysis expression="instance('instance22')" analyzed="true">
                                <returnable>
                                    <path>instance('instance22')</path>
                                </returnable>
                                <dependent-models>
                                    <model>model2</model>
                                </dependent-models>
                                <dependent-instances>
                                    <instance>instance22</instance>
                                </dependent-instances>
                                <returnable-instances>
                                    <instance>instance22</instance>
                                </returnable-instances>
                            </analysis>
                        </value>
                    </variable>
                    <variable scope="" prefixed-id="xf-11" model-prefixed-id="model2" binding="false" value="true" name="v23">
                        <value>
                            <analysis expression="xxf:instance('instance11')" analyzed="true">
                                <returnable>
                                    <path>instance('instance11')</path>
                                </returnable>
                                <dependent-models>
                                    <model>model1</model>
                                </dependent-models>
                                <dependent-instances>
                                    <instance>instance11</instance>
                                </dependent-instances>
                                <returnable-instances>
                                    <instance>instance11</instance>
                                </returnable-instances>
                            </analysis>
                        </value>
                    </variable>
                    <variable scope="" prefixed-id="xf-12" model-prefixed-id="model2" binding="false" value="true" name="v24">
                        <value>
                            <analysis expression="xxf:instance('instance12')" analyzed="true">
                                <returnable>
                                    <path>instance('instance12')</path>
                                </returnable>
                                <dependent-models>
                                    <model>model1</model>
                                </dependent-models>
                                <dependent-instances>
                                    <instance>instance12</instance>
                                </dependent-instances>
                                <returnable-instances>
                                    <instance>instance12</instance>
                                </returnable-instances>
                            </analysis>
                        </value>
                    </variable>
                    <variable scope="" prefixed-id="xf-13" model-prefixed-id="model2" binding="false" value="true" name="v25a">
                        <value>
                            <analysis expression="instance()" analyzed="true">
                                <returnable>
                                    <path>instance('instance21')</path>
                                </returnable>
                                <dependent-models>
                                    <model>model2</model>
                                </dependent-models>
                                <dependent-instances>
                                    <instance>instance21</instance>
                                </dependent-instances>
                                <returnable-instances>
                                    <instance>instance21</instance>
                                </returnable-instances>
                            </analysis>
                        </value>
                    </variable>
                    <variable scope="" prefixed-id="xf-14" model-prefixed-id="model2" binding="false" value="true" name="v25b">
                        <value>
                            <analysis expression="instance('instance11')" analyzed="true">
                                <returnable>
                                    <path>instance('instance11')</path>
                                </returnable>
                                <dependent-models>
                                    <model>model1</model>
                                </dependent-models>
                                <dependent-instances>
                                    <instance>instance11</instance>
                                </dependent-instances>
                                <returnable-instances>
                                    <instance>instance11</instance>
                                </returnable-instances>
                            </analysis>
                        </value>
                    </variable>
                    <variable scope="" prefixed-id="xf-15" model-prefixed-id="model2" binding="false" value="true" name="v26">
                        <value>
                            <analysis expression="instance('instance12')" analyzed="true">
                                <returnable>
                                    <path>instance('instance12')</path>
                                </returnable>
                                <dependent-models>
                                    <model>model1</model>
                                </dependent-models>
                                <dependent-instances>
                                    <instance>instance12</instance>
                                </dependent-instances>
                                <returnable-instances>
                                    <instance>instance12</instance>
                                </returnable-instances>
                            </analysis>
                        </value>
                    </variable>
                </model>
            </request>
        </output>
    </test>

    <test description="Basic xxf:variable/xxf:sequence" name="oxf:java">
        <input name="config">
            <config sourcepath="oxf:/" class="org.orbeon.oxf.xforms.analysis.XPathAnalysisProcessor"/>
        </input>
        <input name="form">
            <xh:html xmlns:xxf="http://orbeon.org/oxf/xml/xforms">
                <xh:head>

                    <xf:model xxf:xpath-analysis="true" id="model">

                        <xf:instance id="instance">
                            <instance>
                                <foo>42</foo>
                                <bar>43</bar>
                            </instance>
                        </xf:instance>

                        <xxf:variable id="vfoo" name="foo" select="foo"/>
                        <xxf:variable id="vbar" name="bar" select="bar"/>

                    </xf:model>
                </xh:head>
                <xh:body>
                    <xxf:variable id="vsum" name="sum">
                        <xxf:sequence select="$foo + $bar"/>
                    </xxf:variable>
                    <xxf:variable id="vproduct" name="product">
                        <xxf:sequence ref="foo" select=". * $bar"/>
                    </xxf:variable>
                    <xxf:variable id="vdifference" name="difference" ref="foo">
                        <xxf:sequence select=". - $bar"/>
                    </xxf:variable>

                    <xf:output id="osum" value="$sum"/>
                    <xf:output id="oproduct" value="$product"/>
                    <xf:output id="odifference" value="$difference"/>
                </xh:body>
            </xh:html>
        </input>
        <output name="analysis">
            <request request-uri="/orbeon/doc/home-welcome" query-string="id=12&amp;print=false" method="GET">
                <variable scope="" prefixed-id="vsum" model-prefixed-id="model" binding="false" value="false" name="sum">
                    <value>
                        <analysis expression="$foo + $bar" analyzed="true">
                            <value-dependent>
                                <path>instance('instance')/foo</path>
                                <path>instance('instance')/bar</path>
                            </value-dependent>
                            <dependent-models>
                                <model>model</model>
                            </dependent-models>
                            <dependent-instances>
                                <instance>instance</instance>
                            </dependent-instances>
                        </analysis>
                    </value>
                </variable>
                <variable scope="" prefixed-id="vproduct" model-prefixed-id="model" binding="false" value="false" name="product">
                    <value>
                        <analysis expression=". * $bar" analyzed="true">
                            <value-dependent>
                                <path>instance('instance')/foo</path>
                                <path>instance('instance')/bar</path>
                            </value-dependent>
                            <dependent-models>
                                <model>model</model>
                            </dependent-models>
                            <dependent-instances>
                                <instance>instance</instance>
                            </dependent-instances>
                        </analysis>
                    </value>
                </variable>
                <variable scope="" prefixed-id="vdifference" model-prefixed-id="model" binding="true" value="false" name="difference">
                    <binding>
                        <analysis expression="foo" analyzed="true">
                            <returnable>
                                <path>instance('instance')/foo</path>
                            </returnable>
                            <dependent-models>
                                <model>model</model>
                            </dependent-models>
                            <dependent-instances>
                                <instance>instance</instance>
                            </dependent-instances>
                            <returnable-instances>
                                <instance>instance</instance>
                            </returnable-instances>
                        </analysis>
                    </binding>
                    <value>
                        <analysis expression=". - $bar" analyzed="true">
                            <value-dependent>
                                <path>instance('instance')/foo</path>
                                <path>instance('instance')/bar</path>
                            </value-dependent>
                            <dependent-models>
                                <model>model</model>
                            </dependent-models>
                            <dependent-instances>
                                <instance>instance</instance>
                            </dependent-instances>
                        </analysis>
                    </value>
                </variable>
                <control name="output" scope="" prefixed-id="osum" model-prefixed-id="model" binding="false" value="true">
                    <value>
                        <analysis expression="xs:string(($sum)[1])" analyzed="true">
                            <value-dependent>
                                <path>instance('instance')/foo</path>
                                <path>instance('instance')/bar</path>
                            </value-dependent>
                            <dependent-models>
                                <model>model</model>
                            </dependent-models>
                            <dependent-instances>
                                <instance>instance</instance>
                            </dependent-instances>
                        </analysis>
                    </value>
                </control>
                <control name="output" scope="" prefixed-id="oproduct" model-prefixed-id="model" binding="false" value="true">
                    <value>
                        <analysis expression="xs:string(($product)[1])" analyzed="true">
                            <value-dependent>
                                <path>instance('instance')/foo</path>
                                <path>instance('instance')/bar</path>
                            </value-dependent>
                            <dependent-models>
                                <model>model</model>
                            </dependent-models>
                            <dependent-instances>
                                <instance>instance</instance>
                            </dependent-instances>
                        </analysis>
                    </value>
                </control>
                <control name="output" scope="" prefixed-id="odifference" model-prefixed-id="model" binding="false" value="true">
                    <value>
                        <analysis expression="xs:string(($difference)[1])" analyzed="true">
                            <value-dependent>
                                <path>instance('instance')/foo</path>
                                <path>instance('instance')/bar</path>
                            </value-dependent>
                            <dependent-models>
                                <model>model</model>
                            </dependent-models>
                            <dependent-instances>
                                <instance>instance</instance>
                            </dependent-instances>
                        </analysis>
                    </value>
                </control>
                <model scope="" prefixed-id="model" default-instance-prefixed-id="instance" analyzed-binds="true">
                    <variable scope="" prefixed-id="vfoo" model-prefixed-id="model" binding="false" value="true" name="foo">
                        <value>
                            <analysis expression="foo" analyzed="true">
                                <returnable>
                                    <path>instance('instance')/foo</path>
                                </returnable>
                                <dependent-models>
                                    <model>model</model>
                                </dependent-models>
                                <dependent-instances>
                                    <instance>instance</instance>
                                </dependent-instances>
                                <returnable-instances>
                                    <instance>instance</instance>
                                </returnable-instances>
                            </analysis>
                        </value>
                    </variable>
                    <variable scope="" prefixed-id="vbar" model-prefixed-id="model" binding="false" value="true" name="bar">
                        <value>
                            <analysis expression="bar" analyzed="true">
                                <returnable>
                                    <path>instance('instance')/bar</path>
                                </returnable>
                                <dependent-models>
                                    <model>model</model>
                                </dependent-models>
                                <dependent-instances>
                                    <instance>instance</instance>
                                </dependent-instances>
                                <returnable-instances>
                                    <instance>instance</instance>
                                </returnable-instances>
                            </analysis>
                        </value>
                    </variable>
                </model>
            </request>
        </output>
    </test>
    
    <test description="XBL xxf:variable/xxf:sequence" name="oxf:java">
        <input name="config">
            <config sourcepath="oxf:/" class="org.orbeon.oxf.xforms.analysis.XPathAnalysisProcessor"/>
        </input>
        <input name="form">
            <xh:html xmlns:xxf="http://orbeon.org/oxf/xml/xforms" xmlns:fr="http://orbeon.org/oxf/xml/form-runner"
                     xmlns:exf="http://www.exforms.org/exf/1-0"
                     xmlns:xbl="http://www.w3.org/ns/xbl" xmlns:xxbl="http://orbeon.org/oxf/xml/xbl">
                <xh:head>

                    <xf:model xxf:xpath-analysis="true" id="model">

                        <xf:instance id="instance">
                            <instance>
                                <foo>42</foo>
                                <bar>43</bar>
                            </instance>
                        </xf:instance>

                        <xxf:variable id="vfoo" name="foo">
                            <xxf:sequence  select="foo"/>
                        </xxf:variable>
                        <xxf:variable id="vbar" name="bar">
                            <xxf:sequence  select="bar"/>
                        </xxf:variable>
                    </xf:model>
                    <xbl:xbl>
                        <xbl:binding id="fr-foo" element="fr|foo">
                            <xbl:implementation>    
                                <xf:model id="model">
                                    <xf:instance id="instance">
                                        <instance/>
                                    </xf:instance>
                                </xf:model>
                            </xbl:implementation>
                            <xbl:template>

                                <xxf:variable id="iv" name="internal" select="."/>
                                <xxf:variable id="ov" name="external">
                                    <xxf:sequence xbl:attr="select=ref" xxbl:scope="outer"/>
                                </xxf:variable>
                                <xxf:variable id="ro" name="readonly" select="exf:readonly($external)"/>

                                <xf:group ref="$external" id="group-external"/>
                                <xf:output id="oexternal" value="$external"/>
                                <xf:output id="oro" value="$readonly"/>
                            </xbl:template>
                        </xbl:binding>
                    </xbl:xbl>
                </xh:head>
                <xh:body>
                    <fr:foo id="my-foo" ref="foo"/>
                </xh:body>
            </xh:html>
        </input>
        <output name="analysis">
            <request request-uri="/orbeon/doc/home-welcome" query-string="id=12&amp;print=false" method="GET">
                <variable scope="my-foo" prefixed-id="my-foo$iv" model-prefixed-id="my-foo$model" binding="false" value="false" name="internal">
                    <value>
                        <analysis expression="." analyzed="true">
                            <returnable>
                                <path>instance('my-foo$instance')</path>
                            </returnable>
                            <dependent-models>
                                <model>my-foo$model</model>
                            </dependent-models>
                            <dependent-instances>
                                <instance>my-foo$instance</instance>
                            </dependent-instances>
                            <returnable-instances>
                                <instance>my-foo$instance</instance>
                            </returnable-instances>
                        </analysis>
                    </value>
                </variable>
                <variable scope="my-foo" prefixed-id="my-foo$ov" model-prefixed-id="my-foo$model" binding="false" value="false" name="external">
                    <value>
                        <analysis expression="foo" analyzed="true">
                            <returnable>
                                <path>instance('instance')/foo</path>
                            </returnable>
                            <dependent-models>
                                <model>model</model>
                            </dependent-models>
                            <dependent-instances>
                                <instance>instance</instance>
                            </dependent-instances>
                            <returnable-instances>
                                <instance>instance</instance>
                            </returnable-instances>
                        </analysis>
                    </value>
                </variable>
                <variable scope="my-foo" prefixed-id="my-foo$ro" model-prefixed-id="my-foo$model" binding="false" value="false" name="readonly">
                    <value>
                        <analysis expression="exf:readonly($external)" analyzed="false"/>
                    </value>
                </variable>
                <control name="group" scope="my-foo" prefixed-id="my-foo$group-external" model-prefixed-id="my-foo$model" binding="true" value="false">
                    <binding>
                        <analysis expression="$external" analyzed="true">
                            <returnable>
                                <path>instance('instance')/foo</path>
                            </returnable>
                            <dependent-models>
                                <model>model</model>
                            </dependent-models>
                            <dependent-instances>
                                <instance>instance</instance>
                            </dependent-instances>
                            <returnable-instances>
                                <instance>instance</instance>
                            </returnable-instances>
                        </analysis>
                    </binding>
                </control>
                <control name="output" scope="my-foo" prefixed-id="my-foo$oexternal" model-prefixed-id="my-foo$model" binding="false" value="true">
                    <value>
                        <analysis expression="xs:string(($external)[1])" analyzed="true">
                            <value-dependent>
                                <path>instance('instance')/foo</path>
                            </value-dependent>
                            <dependent-models>
                                <model>model</model>
                            </dependent-models>
                            <dependent-instances>
                                <instance>instance</instance>
                            </dependent-instances>
                        </analysis>
                    </value>
                </control>
                <control name="output" scope="my-foo" prefixed-id="my-foo$oro" model-prefixed-id="my-foo$model" binding="false" value="true">
                    <value>
                        <analysis expression="xs:string(($readonly)[1])" analyzed="false"/>
                    </value>
                </control>
                <control name="foo" scope="" prefixed-id="my-foo" model-prefixed-id="model" binding="true" value="false">
                    <binding>
                        <analysis expression="instance('instance')" analyzed="true">
                            <returnable>
                                <path>instance('instance')</path>
                            </returnable>
                            <dependent-models>
                                <model>model</model>
                            </dependent-models>
                            <dependent-instances>
                                <instance>instance</instance>
                            </dependent-instances>
                            <returnable-instances>
                                <instance>instance</instance>
                            </returnable-instances>
                        </analysis>
                    </binding>
                </control>
                <model scope="" prefixed-id="model" default-instance-prefixed-id="instance" analyzed-binds="true">
                    <variable scope="" prefixed-id="vfoo" model-prefixed-id="model" binding="false" value="true" name="foo">
                        <value>
                            <analysis expression="foo" analyzed="true">
                                <returnable>
                                    <path>instance('instance')/foo</path>
                                </returnable>
                                <dependent-models>
                                    <model>model</model>
                                </dependent-models>
                                <dependent-instances>
                                    <instance>instance</instance>
                                </dependent-instances>
                                <returnable-instances>
                                    <instance>instance</instance>
                                </returnable-instances>
                            </analysis>
                        </value>
                    </variable>
                    <variable scope="" prefixed-id="vbar" model-prefixed-id="model" binding="false" value="true" name="bar">
                        <value>
                            <analysis expression="bar" analyzed="true">
                                <returnable>
                                    <path>instance('instance')/bar</path>
                                </returnable>
                                <dependent-models>
                                    <model>model</model>
                                </dependent-models>
                                <dependent-instances>
                                    <instance>instance</instance>
                                </dependent-instances>
                                <returnable-instances>
                                    <instance>instance</instance>
                                </returnable-instances>
                            </analysis>
                        </value>
                    </variable>
                </model>
                <model scope="my-foo" prefixed-id="my-foo$model" default-instance-prefixed-id="my-foo$instance" analyzed-binds="true"/>
            </request>
        </output>
    </test>

    <test description="Expression both returning a node and using the node value in predicate" name="oxf:java">
        <input name="config">
            <config sourcepath="oxf:/" class="org.orbeon.oxf.xforms.analysis.XPathAnalysisProcessor"/>
        </input>
        <input name="form">
            <xh:html xmlns:xxf="http://orbeon.org/oxf/xml/xforms">
                <xh:head>
                    <xf:model id="model" xxf:xpath-analysis="true">
                        <xf:instance id="instance">
                            <instance><name/></instance>
                        </xf:instance>
                    </xf:model>
                </xh:head>
                <xh:body>
                    <xf:input id="input" ref="name[. = 42]"/>
                </xh:body>
            </xh:html>
        </input>
        <output name="analysis">
            <request request-uri="/orbeon/doc/home-welcome" query-string="id=12&amp;print=false" method="GET">
                <control name="input" scope="" prefixed-id="input" model-prefixed-id="model" binding="true" value="true">
                    <binding>
                        <analysis expression="name[. = 42]" analyzed="true">
                            <value-dependent>
                                <path>instance('instance')/name</path>
                            </value-dependent>
                            <returnable>
                                <path>instance('instance')/name</path>
                            </returnable>
                            <dependent-models>
                                <model>model</model>
                            </dependent-models>
                            <dependent-instances>
                                <instance>instance</instance>
                            </dependent-instances>
                            <returnable-instances>
                                <instance>instance</instance>
                            </returnable-instances>
                        </analysis>
                    </binding>
                    <value>
                        <analysis expression="xs:string(.[1])" analyzed="true">
                            <value-dependent>
                                <path>instance('instance')/name</path>
                            </value-dependent>
                            <dependent-models>
                                <model>model</model>
                            </dependent-models>
                            <dependent-instances>
                                <instance>instance</instance>
                            </dependent-instances>
                        </analysis>
                    </value>
                </control>
                <model scope="" prefixed-id="model" default-instance-prefixed-id="instance" analyzed-binds="true"/>
            </request>
        </output>
    </test>

    <test description="Binding depending on variable scoped in parent container" name="oxf:java">
        <input name="config">
            <config sourcepath="oxf:/" class="org.orbeon.oxf.xforms.analysis.XPathAnalysisProcessor"/>
        </input>
        <input name="form">
            <xh:html xmlns:xxf="http://orbeon.org/oxf/xml/xforms">
                <xh:head>
                    <xf:model id="model" xxf:xpath-analysis="true">
                        <xf:instance id="instance">
                            <instance><value/></instance>
                        </xf:instance>
                    </xf:model>
                </xh:head>
                <xh:body>
                    <xxf:variable id="show-variable" name="show" select="value = 'true'"/>
                    <xf:group id="enclosing-group">
                        <xf:group id="nested-group" ref=".[$show]"/>
                    </xf:group>

                </xh:body>
            </xh:html>
        </input>
        <output name="analysis">
            <request request-uri="/orbeon/doc/home-welcome" query-string="id=12&amp;print=false" method="GET">
                <variable scope="" prefixed-id="show-variable" model-prefixed-id="model" binding="false" value="false" name="show">
                    <value>
                        <analysis expression="value = 'true'" analyzed="true">
                            <value-dependent>
                                <path>instance('instance')/value</path>
                            </value-dependent>
                            <dependent-models>
                                <model>model</model>
                            </dependent-models>
                            <dependent-instances>
                                <instance>instance</instance>
                            </dependent-instances>
                        </analysis>
                    </value>
                </variable>
                <control name="group" scope="" prefixed-id="enclosing-group" model-prefixed-id="model" binding="false" value="false"/>
                <control name="group" scope="" prefixed-id="nested-group" model-prefixed-id="model" binding="true" value="false">
                    <binding>
                        <analysis expression=".[$show]" analyzed="true">
                            <value-dependent>
                                <path>instance('instance')/value</path>
                            </value-dependent>
                            <returnable>
                                <path>instance('instance')</path>
                            </returnable>
                            <dependent-models>
                                <model>model</model>
                            </dependent-models>
                            <dependent-instances>
                                <instance>instance</instance>
                            </dependent-instances>
                            <returnable-instances>
                                <instance>instance</instance>
                            </returnable-instances>
                        </analysis>
                    </binding>
                </control>
                <model scope="" prefixed-id="model" default-instance-prefixed-id="instance" analyzed-binds="true"/>
            </request>
        </output>
    </test>

    <test description="Top-level model with no instance" name="oxf:java">
        <input name="config">
            <config sourcepath="oxf:/" class="org.orbeon.oxf.xforms.analysis.XPathAnalysisProcessor"/>
        </input>
        <input name="form">
            <xh:html xmlns:xxf="http://orbeon.org/oxf/xml/xforms">
                <xh:head>
                    <xf:model id="model" xxf:xpath-analysis="true"/>
                </xh:head>
                <xh:body>
                    <xf:output id="output" value="current-date()"/>
                </xh:body>
            </xh:html>
        </input>
        <output name="analysis">
            <request request-uri="/orbeon/doc/home-welcome" query-string="id=12&amp;print=false" method="GET">
                <control name="output" scope="" prefixed-id="output" model-prefixed-id="model" binding="false" value="true">
                    <value>
                        <analysis expression="xs:string((current-date())[1])" analyzed="true"/>
                    </value>
                </control>
                <model scope="" prefixed-id="model" analyzed-binds="true"/>
            </request>
        </output>
    </test>

    <test description="XBL with no local model" name="oxf:java">
        <input name="config">
            <config sourcepath="oxf:/" class="org.orbeon.oxf.xforms.analysis.XPathAnalysisProcessor"/>
        </input>
        <input name="form">
            <xh:html xmlns:xxf="http://orbeon.org/oxf/xml/xforms" xmlns:fr="http://orbeon.org/oxf/xml/form-runner"
                     xmlns:exf="http://www.exforms.org/exf/1-0"
                     xmlns:xbl="http://www.w3.org/ns/xbl" xmlns:xxbl="http://orbeon.org/oxf/xml/xbl">
                <xh:head>
                    <xf:model xxf:xpath-analysis="true" id="model"/>
                    <xbl:xbl>
                        <xbl:binding id="fr-foo" element="fr|foo">
                            <xbl:template>
                                <xf:output id="output" value="current-date()"/>
                            </xbl:template>
                        </xbl:binding>
                    </xbl:xbl>
                </xh:head>
                <xh:body>
                    <fr:foo id="my-foo"/>
                </xh:body>
            </xh:html>
        </input>
        <output name="analysis">
            <request request-uri="/orbeon/doc/home-welcome" query-string="id=12&amp;print=false" method="GET">
                <control name="output" scope="my-foo" prefixed-id="my-foo$output" binding="false" value="true">
                    <value>
                        <analysis expression="xs:string((current-date())[1])" analyzed="true"/>
                    </value>
                </control>
                <control name="foo" scope="" prefixed-id="my-foo" model-prefixed-id="model" binding="false" value="false"/>
                <model scope="" prefixed-id="model" analyzed-binds="true"/>
            </request>
        </output>
    </test>

    <test description="Simple change of control validity based on MIP" name="oxf:pipeline">
        <input name="config" href="xforms-server/wrap-xforms-state.xpl"/>
        <input name="document">
            <xh:html xmlns:xxf="http://orbeon.org/oxf/xml/xforms">
                <xh:head>
                    <xf:model id="model" xxf:xpath-analysis="true">
                        <xf:instance id="i1">
                            <instance>
                                <a/>
                                <b/>
                            </instance>
                        </xf:instance>

                        <xf:bind id="b1" ref="instance()/a" constraint="../b = 'x'"/>

                        <xf:action ev:event="xforms-ready">
                            <xf:refresh/>
                            <xf:delete model="events-model" nodeset="*"/>

                            <!-- Cause a to become valid -->
                            <xf:setvalue ref="b">x</xf:setvalue>
                            <xf:refresh/>

                        </xf:action>

                    </xf:model>
                    <xf:model id="events-model">
                        <!-- TEST: Events to gather -->
                        <xf:instance id="events-instance">
                            <events/>
                        </xf:instance>
                    </xf:model>
                </xh:head>
                <xh:body>
                    <xf:insert ev:event="#all"
                                   model="events-model" context="." nodeset="*"
                                   origin="xxf:element('event',
                                            (xxf:attribute('type', xxf:event('xxf:type')),
                                             xxf:attribute('target', xxf:event('xxf:targetid'))))"/>

                    
                    <xf:output id="g11" ref="a"/>

                </xh:body>
            </xh:html>
        </input>
        <output name="response">
            <xxf:event-response xmlns:xxf="http://orbeon.org/oxf/xml/xforms">
                <xxf:dynamic-state>
                    <dynamic-state>
                        <instances>
                            <instance id="i1" model-id="model">
                                <instance>
                                    <a/>
                                    <b>x</b>
                                </instance>
                            </instance>
                            <instance id="events-instance" model-id="events-model">
                                <events>
                                    <event type="xforms-valid" target="g11"/>
                                </events>
                            </instance>
                        </instances>
                    </dynamic-state>
                </xxf:dynamic-state>
                <xxf:action>
                    <xxf:control-values/>
                </xxf:action>
            </xxf:event-response>
        </output>
    </test>

    <test description="PO example: analysis" name="oxf:java">
        <input name="config">
            <config sourcepath="oxf:/" class="org.orbeon.oxf.xforms.analysis.XPathAnalysisProcessor"/>
        </input>
        <input name="form" href="oxf:/ops/unit-tests/xforms-server/po.xhtml"/>
        <output name="analysis">
            <request request-uri="/orbeon/doc/home-welcome" query-string="id=12&amp;print=false" method="GET">
                <control name="repeat" scope="" prefixed-id="item-repeat" model-prefixed-id="model" binding="true" value="false">
                    <binding>
                        <analysis expression="items/item" analyzed="true">
                            <returnable>
                                <path>instance('po')/items/item</path>
                            </returnable>
                            <dependent-models>
                                <model>model</model>
                            </dependent-models>
                            <dependent-instances>
                                <instance>po</instance>
                            </dependent-instances>
                            <returnable-instances>
                                <instance>po</instance>
                            </returnable-instances>
                        </analysis>
                    </binding>
                </control>
                <control name="input" scope="" prefixed-id="name" model-prefixed-id="model" binding="true" value="true">
                    <binding>
                        <analysis expression="name" analyzed="true">
                            <returnable>
                                <path>instance('po')/items/item/name</path>
                            </returnable>
                            <dependent-models>
                                <model>model</model>
                            </dependent-models>
                            <dependent-instances>
                                <instance>po</instance>
                            </dependent-instances>
                            <returnable-instances>
                                <instance>po</instance>
                            </returnable-instances>
                        </analysis>
                    </binding>
                    <value>
                        <analysis expression="xs:string(.[1])" analyzed="true">
                            <value-dependent>
                                <path>instance('po')/items/item/name</path>
                            </value-dependent>
                            <dependent-models>
                                <model>model</model>
                            </dependent-models>
                            <dependent-instances>
                                <instance>po</instance>
                            </dependent-instances>
                        </analysis>
                    </value>
                </control>
                <control name="input" scope="" prefixed-id="units" model-prefixed-id="model" binding="true" value="true">
                    <binding>
                        <analysis expression="units" analyzed="true">
                            <returnable>
                                <path>instance('po')/items/item/units</path>
                            </returnable>
                            <dependent-models>
                                <model>model</model>
                            </dependent-models>
                            <dependent-instances>
                                <instance>po</instance>
                            </dependent-instances>
                            <returnable-instances>
                                <instance>po</instance>
                            </returnable-instances>
                        </analysis>
                    </binding>
                    <value>
                        <analysis expression="xs:string(.[1])" analyzed="true">
                            <value-dependent>
                                <path>instance('po')/items/item/units</path>
                            </value-dependent>
                            <dependent-models>
                                <model>model</model>
                            </dependent-models>
                            <dependent-instances>
                                <instance>po</instance>
                            </dependent-instances>
                        </analysis>
                    </value>
                </control>
                <control name="input" scope="" prefixed-id="price" model-prefixed-id="model" binding="true" value="true">
                    <binding>
                        <analysis expression="price" analyzed="true">
                            <returnable>
                                <path>instance('po')/items/item/price</path>
                            </returnable>
                            <dependent-models>
                                <model>model</model>
                            </dependent-models>
                            <dependent-instances>
                                <instance>po</instance>
                            </dependent-instances>
                            <returnable-instances>
                                <instance>po</instance>
                            </returnable-instances>
                        </analysis>
                    </binding>
                    <value>
                        <analysis expression="xs:string(.[1])" analyzed="true">
                            <value-dependent>
                                <path>instance('po')/items/item/price</path>
                            </value-dependent>
                            <dependent-models>
                                <model>model</model>
                            </dependent-models>
                            <dependent-instances>
                                <instance>po</instance>
                            </dependent-instances>
                        </analysis>
                    </value>
                </control>
                <control name="output" scope="" prefixed-id="line-total" model-prefixed-id="model" binding="true" value="true">
                    <binding>
                        <analysis expression="total" analyzed="true">
                            <returnable>
                                <path>instance('po')/items/item/total</path>
                            </returnable>
                            <dependent-models>
                                <model>model</model>
                            </dependent-models>
                            <dependent-instances>
                                <instance>po</instance>
                            </dependent-instances>
                            <returnable-instances>
                                <instance>po</instance>
                            </returnable-instances>
                        </analysis>
                    </binding>
                    <value>
                        <analysis expression="xs:string(.[1])" analyzed="true">
                            <value-dependent>
                                <path>instance('po')/items/item/total</path>
                            </value-dependent>
                            <dependent-models>
                                <model>model</model>
                            </dependent-models>
                            <dependent-instances>
                                <instance>po</instance>
                            </dependent-instances>
                        </analysis>
                    </value>
                </control>
                <control name="output" scope="" prefixed-id="subtotal" model-prefixed-id="model" binding="true" value="true">
                    <binding>
                        <analysis expression="totals/subtotal" analyzed="true">
                            <returnable>
                                <path>instance('po')/totals/subtotal</path>
                            </returnable>
                            <dependent-models>
                                <model>model</model>
                            </dependent-models>
                            <dependent-instances>
                                <instance>po</instance>
                            </dependent-instances>
                            <returnable-instances>
                                <instance>po</instance>
                            </returnable-instances>
                        </analysis>
                    </binding>
                    <value>
                        <analysis expression="xs:string(.[1])" analyzed="true">
                            <value-dependent>
                                <path>instance('po')/totals/subtotal</path>
                            </value-dependent>
                            <dependent-models>
                                <model>model</model>
                            </dependent-models>
                            <dependent-instances>
                                <instance>po</instance>
                            </dependent-instances>
                        </analysis>
                    </value>
                </control>
                <control name="output" scope="" prefixed-id="tax" model-prefixed-id="model" binding="true" value="true">
                    <binding>
                        <analysis expression="totals/tax" analyzed="true">
                            <returnable>
                                <path>instance('po')/totals/tax</path>
                            </returnable>
                            <dependent-models>
                                <model>model</model>
                            </dependent-models>
                            <dependent-instances>
                                <instance>po</instance>
                            </dependent-instances>
                            <returnable-instances>
                                <instance>po</instance>
                            </returnable-instances>
                        </analysis>
                    </binding>
                    <value>
                        <analysis expression="xs:string(.[1])" analyzed="true">
                            <value-dependent>
                                <path>instance('po')/totals/tax</path>
                            </value-dependent>
                            <dependent-models>
                                <model>model</model>
                            </dependent-models>
                            <dependent-instances>
                                <instance>po</instance>
                            </dependent-instances>
                        </analysis>
                    </value>
                </control>
                <control name="output" scope="" prefixed-id="total" model-prefixed-id="model" binding="true" value="true">
                    <binding>
                        <analysis expression="totals/total" analyzed="true">
                            <returnable>
                                <path>instance('po')/totals/total</path>
                            </returnable>
                            <dependent-models>
                                <model>model</model>
                            </dependent-models>
                            <dependent-instances>
                                <instance>po</instance>
                            </dependent-instances>
                            <returnable-instances>
                                <instance>po</instance>
                            </returnable-instances>
                        </analysis>
                    </binding>
                    <value>
                        <analysis expression="xs:string(.[1])" analyzed="true">
                            <value-dependent>
                                <path>instance('po')/totals/total</path>
                            </value-dependent>
                            <dependent-models>
                                <model>model</model>
                            </dependent-models>
                            <dependent-instances>
                                <instance>po</instance>
                            </dependent-instances>
                        </analysis>
                    </value>
                </control>
                <model scope="" prefixed-id="model" default-instance-prefixed-id="po" analyzed-binds="true">
                    <binds>
                        <bind id="item-bind" ref="items/item">
                            <analysis expression="items/item" analyzed="true">
                                <returnable>
                                    <path>instance('po')/items/item</path>
                                </returnable>
                                <dependent-models>
                                    <model>model</model>
                                </dependent-models>
                                <dependent-instances>
                                    <instance>po</instance>
                                </dependent-instances>
                                <returnable-instances>
                                    <instance>po</instance>
                                </returnable-instances>
                            </analysis>
                            <bind id="name-bind" ref="name">
                                <analysis expression="name" analyzed="true">
                                    <returnable>
                                        <path>instance('po')/items/item/name</path>
                                    </returnable>
                                    <dependent-models>
                                        <model>model</model>
                                    </dependent-models>
                                    <dependent-instances>
                                        <instance>po</instance>
                                    </dependent-instances>
                                    <returnable-instances>
                                        <instance>po</instance>
                                    </returnable-instances>
                                </analysis>
                                <mip name="required" expression="true()">
                                    <analysis expression="xs:boolean((true())[1])" analyzed="true"/>
                                </mip>
                            </bind>
                            <bind id="units-bind" ref="units">
                                <analysis expression="units" analyzed="true">
                                    <returnable>
                                        <path>instance('po')/items/item/units</path>
                                    </returnable>
                                    <dependent-models>
                                        <model>model</model>
                                    </dependent-models>
                                    <dependent-instances>
                                        <instance>po</instance>
                                    </dependent-instances>
                                    <returnable-instances>
                                        <instance>po</instance>
                                    </returnable-instances>
                                </analysis>
                                <mip name="constraint" expression=". &gt; 0">
                                    <analysis expression="xs:boolean((. &gt; 0)[1])" analyzed="true">
                                        <value-dependent>
                                            <path>instance('po')/items/item/units</path>
                                        </value-dependent>
                                        <dependent-models>
                                            <model>model</model>
                                        </dependent-models>
                                        <dependent-instances>
                                            <instance>po</instance>
                                        </dependent-instances>
                                    </analysis>
                                </mip>
                            </bind>
                            <bind id="price-bind" ref="price">
                                <analysis expression="price" analyzed="true">
                                    <returnable>
                                        <path>instance('po')/items/item/price</path>
                                    </returnable>
                                    <dependent-models>
                                        <model>model</model>
                                    </dependent-models>
                                    <dependent-instances>
                                        <instance>po</instance>
                                    </dependent-instances>
                                    <returnable-instances>
                                        <instance>po</instance>
                                    </returnable-instances>
                                </analysis>
                                <mip name="constraint" expression=". &gt; 0">
                                    <analysis expression="xs:boolean((. &gt; 0)[1])" analyzed="true">
                                        <value-dependent>
                                            <path>instance('po')/items/item/price</path>
                                        </value-dependent>
                                        <dependent-models>
                                            <model>model</model>
                                        </dependent-models>
                                        <dependent-instances>
                                            <instance>po</instance>
                                        </dependent-instances>
                                    </analysis>
                                </mip>
                            </bind>
                            <bind id="line-total-bind" ref="total">
                                <analysis expression="total" analyzed="true">
                                    <returnable>
                                        <path>instance('po')/items/item/total</path>
                                    </returnable>
                                    <dependent-models>
                                        <model>model</model>
                                    </dependent-models>
                                    <dependent-instances>
                                        <instance>po</instance>
                                    </dependent-instances>
                                    <returnable-instances>
                                        <instance>po</instance>
                                    </returnable-instances>
                                </analysis>
                                <mip name="relevant" expression="for $u in ../units return $u castable as xs:decimal and $u &gt; 0">
                                    <analysis expression="xs:boolean((for $u in ../units return $u castable as xs:decimal and $u &gt; 0)[1])" analyzed="true">
                                        <value-dependent>
                                            <path>instance('po')/items/item/units</path>
                                        </value-dependent>
                                        <dependent-models>
                                            <model>model</model>
                                        </dependent-models>
                                        <dependent-instances>
                                            <instance>po</instance>
                                        </dependent-instances>
                                    </analysis>
                                </mip>
                                <mip name="calculate" expression="if (../units castable as xs:integer and ../price castable as xs:decimal) then ../units * ../price else '-'">
                                    <analysis expression="xs:string((if (../units castable as xs:integer and ../price castable as xs:decimal) then ../units * ../price else '-')[1])" analyzed="true">
                                        <value-dependent>
                                            <path>instance('po')/items/item/units</path>
                                            <path>instance('po')/items/item/price</path>
                                        </value-dependent>
                                        <dependent-models>
                                            <model>model</model>
                                        </dependent-models>
                                        <dependent-instances>
                                            <instance>po</instance>
                                        </dependent-instances>
                                    </analysis>
                                </mip>
                            </bind>
                        </bind>
                        <bind id="totals-bind" ref="totals">
                            <analysis expression="totals" analyzed="true">
                                <returnable>
                                    <path>instance('po')/totals</path>
                                </returnable>
                                <dependent-models>
                                    <model>model</model>
                                </dependent-models>
                                <dependent-instances>
                                    <instance>po</instance>
                                </dependent-instances>
                                <returnable-instances>
                                    <instance>po</instance>
                                </returnable-instances>
                            </analysis>
                            <bind id="subtotal-bind" ref="subtotal">
                                <analysis expression="subtotal" analyzed="true">
                                    <returnable>
                                        <path>instance('po')/totals/subtotal</path>
                                    </returnable>
                                    <dependent-models>
                                        <model>model</model>
                                    </dependent-models>
                                    <dependent-instances>
                                        <instance>po</instance>
                                    </dependent-instances>
                                    <returnable-instances>
                                        <instance>po</instance>
                                    </returnable-instances>
                                </analysis>
                                <mip name="calculate" expression="sum(for $t in ../../items/item/total[. castable as xs:decimal] return $t)">
                                    <analysis expression="xs:string((sum(for $t in ../../items/item/total[. castable as xs:decimal] return $t))[1])" analyzed="true">
                                        <value-dependent>
                                            <path>instance('po')/items/item/total</path>
                                        </value-dependent>
                                        <dependent-models>
                                            <model>model</model>
                                        </dependent-models>
                                        <dependent-instances>
                                            <instance>po</instance>
                                        </dependent-instances>
                                    </analysis>
                                </mip>
                            </bind>
                            <bind id="tax-bind" ref="tax">
                                <analysis expression="tax" analyzed="true">
                                    <returnable>
                                        <path>instance('po')/totals/tax</path>
                                    </returnable>
                                    <dependent-models>
                                        <model>model</model>
                                    </dependent-models>
                                    <dependent-instances>
                                        <instance>po</instance>
                                    </dependent-instances>
                                    <returnable-instances>
                                        <instance>po</instance>
                                    </returnable-instances>
                                </analysis>
                                <mip name="calculate" expression="../subtotal * ../../info/tax">
                                    <analysis expression="xs:string((../subtotal * ../../info/tax)[1])" analyzed="true">
                                        <value-dependent>
                                            <path>instance('po')/totals/subtotal</path>
                                            <path>instance('po')/info/tax</path>
                                        </value-dependent>
                                        <dependent-models>
                                            <model>model</model>
                                        </dependent-models>
                                        <dependent-instances>
                                            <instance>po</instance>
                                        </dependent-instances>
                                    </analysis>
                                </mip>
                            </bind>
                            <bind id="total-bind" ref="total">
                                <analysis expression="total" analyzed="true">
                                    <returnable>
                                        <path>instance('po')/totals/total</path>
                                    </returnable>
                                    <dependent-models>
                                        <model>model</model>
                                    </dependent-models>
                                    <dependent-instances>
                                        <instance>po</instance>
                                    </dependent-instances>
                                    <returnable-instances>
                                        <instance>po</instance>
                                    </returnable-instances>
                                </analysis>
                                <mip name="calculate" expression="for $t in ../subtotal + ../tax return if ($t &gt; 4000) then $t else $t * 0.9">
                                    <analysis expression="xs:string((for $t in ../subtotal + ../tax return if ($t &gt; 4000) then $t else $t * 0.9)[1])" analyzed="true">
                                        <value-dependent>
                                            <path>instance('po')/totals/subtotal</path>
                                            <path>instance('po')/totals/tax</path>
                                        </value-dependent>
                                        <dependent-models>
                                            <model>model</model>
                                        </dependent-models>
                                        <dependent-instances>
                                            <instance>po</instance>
                                        </dependent-instances>
                                    </analysis>
                                </mip>
                            </bind>
                        </bind>
                        <bind id="info-tax-bind" ref="info/tax">
                            <analysis expression="info/tax" analyzed="true">
                                <returnable>
                                    <path>instance('po')/info/tax</path>
                                </returnable>
                                <dependent-models>
                                    <model>model</model>
                                </dependent-models>
                                <dependent-instances>
                                    <instance>po</instance>
                                </dependent-instances>
                                <returnable-instances>
                                    <instance>po</instance>
                                </returnable-instances>
                            </analysis>
                        </bind>
                    </binds>
                    <bind-instances>
                        <instance>po</instance>
                    </bind-instances>
                    <computed-binds-instances>
                        <instance>po</instance>
                    </computed-binds-instances>
                    <validation-binds-instances>
                        <instance>po</instance>
                    </validation-binds-instances>
                </model>
                <model scope="" prefixed-id="events-model" default-instance-prefixed-id="events-instance" analyzed-binds="true"/>
            </request>
        </output>
    </test>

    <test description="PO example: change to values causing change to MIPs" name="oxf:pipeline">
        <input name="config" href="xforms-server/wrap-xforms-state.xpl"/>
        <input name="document" href="oxf:/ops/unit-tests/xforms-server/po.xhtml"/>
        <output name="response">
            <xxf:event-response xmlns:xxf="http://orbeon.org/oxf/xml/xforms">
                <xxf:dynamic-state>
                    <dynamic-state>
                        <instances>
                            <instance id="po" model-id="model" types="true">
                                <purchaseOrder>
                                    <items>
                                        <item>
                                            <name>Item 1</name>
                                            <units>3</units>
                                            <price>60</price>
                                            <total>180</total>
                                        </item>
                                        <item>
                                            <name>Item 2</name>
                                            <units>1</units>
                                            <price>500</price>
                                            <total>500</total>
                                        </item>
                                        <item>
                                            <name>Item 3</name>
                                            <units>1</units>
                                            <price>1500</price>
                                            <total>1500</total>
                                        </item>
                                    </items>
                                    <totals>
                                        <subtotal>2180</subtotal>
                                        <tax>479.6</tax>
                                        <total>2393.64</total>
                                    </totals>
                                    <info>
                                        <tax>0.22</tax>
                                    </info>
                                </purchaseOrder>
                            </instance>
                            <instance id="events-instance" model-id="events-model" types="true">
                                <events>
                                    <event type="xforms-value-changed" target="price" indexes="1"/>
                                    <event type="xforms-invalid" target="price" indexes="1"/>
                                    <event type="xforms-value-changed" target="line-total" indexes="1"/>
                                    <event type="xforms-invalid" target="line-total" indexes="1"/>
                                    <event type="xforms-value-changed" target="subtotal" indexes=""/>
                                    <event type="xforms-value-changed" target="tax" indexes=""/>
                                    <event type="xforms-value-changed" target="total" indexes=""/>
                                    <event type="xforms-value-changed" target="price" indexes="1"/>
                                    <event type="xforms-valid" target="price" indexes="1"/>
                                    <event type="xforms-value-changed" target="line-total" indexes="1"/>
                                    <event type="xforms-valid" target="line-total" indexes="1"/>
                                    <event type="xforms-value-changed" target="subtotal" indexes=""/>
                                    <event type="xforms-value-changed" target="tax" indexes=""/>
                                    <event type="xforms-value-changed" target="total" indexes=""/>
                                </events>
                            </instance>
                        </instances>
                        <controls>
                            <control effective-id="item-repeat" index="1"/>
                        </controls>
                    </dynamic-state>
                </xxf:dynamic-state>
                <xxf:action>
                    <xxf:control-values>
                        <xxf:control id="name1" required="true">Item 1</xxf:control>
                        <xxf:control id="units1" type="{http://www.w3.org/2001/XMLSchema}integer">3</xxf:control>
                        <xxf:control id="price1" type="{http://www.w3.org/2001/XMLSchema}decimal">60</xxf:control>
                        <xxf:control id="line-total1" type="{http://www.w3.org/2001/XMLSchema}decimal">180.00</xxf:control>
                        <xxf:control id="name2" required="true">Item 2</xxf:control>
                        <xxf:control id="units2" type="{http://www.w3.org/2001/XMLSchema}integer">1</xxf:control>
                        <xxf:control id="price2" type="{http://www.w3.org/2001/XMLSchema}decimal">500</xxf:control>
                        <xxf:control id="line-total2" type="{http://www.w3.org/2001/XMLSchema}decimal">500.00</xxf:control>
                        <xxf:control id="name3" required="true">Item 3</xxf:control>
                        <xxf:control id="units3" type="{http://www.w3.org/2001/XMLSchema}integer">1</xxf:control>
                        <xxf:control id="price3" type="{http://www.w3.org/2001/XMLSchema}decimal">1500</xxf:control>
                        <xxf:control id="line-total3" type="{http://www.w3.org/2001/XMLSchema}decimal">1,500.00</xxf:control>
                        <xxf:control id="subtotal" type="{http://www.w3.org/2001/XMLSchema}decimal">2,180.00</xxf:control>
                        <xxf:control id="tax" type="{http://www.w3.org/2001/XMLSchema}decimal">479.60</xxf:control>
                        <xxf:control id="total" type="{http://www.w3.org/2001/XMLSchema}decimal">2,393.64</xxf:control>
                    </xxf:control-values>
                </xxf:action>
            </xxf:event-response>
        </output>
    </test>

    <test description="Simple use of last() function" name="oxf:java">
        <input name="config">
            <config sourcepath="oxf:/" class="org.orbeon.oxf.xforms.analysis.XPathAnalysisProcessor"/>
        </input>
        <input name="form">
            <xh:html xmlns:xxf="http://orbeon.org/oxf/xml/xforms" xmlns:fr="http://orbeon.org/oxf/xml/form-runner"
                     xmlns:exf="http://www.exforms.org/exf/1-0"
                     xmlns:xbl="http://www.w3.org/ns/xbl" xmlns:xxbl="http://orbeon.org/oxf/xml/xbl">
                <xh:head>
                    <xf:model xxf:xpath-analysis="true" id="model">
                        <xf:instance id="i1">
                            <instance/>
                        </xf:instance>
                    </xf:model>
                </xh:head>
                <xh:body>
                    <xf:output id="01" value="a[last()]/b"/>
                </xh:body>
            </xh:html>
        </input>
        <output name="analysis">
            <request request-uri="/orbeon/doc/home-welcome" query-string="id=12&amp;print=false" method="GET">
            <control name="output" scope="" prefixed-id="01" model-prefixed-id="model" binding="false" value="true">
                <value>
                    <analysis expression="xs:string((a[last()]/b)[1])" analyzed="true">
                        <value-dependent>
                            <path>instance('i1')/a/b</path>
                        </value-dependent>
                        <dependent-models>
                            <model>model</model>
                        </dependent-models>
                        <dependent-instances>
                            <instance>i1</instance>
                        </dependent-instances>
                    </analysis>
                </value>
            </control>
            <model scope="" prefixed-id="model" default-instance-prefixed-id="i1" analyzed-binds="true"/>
        </request>
        </output>
    </test>

    <test description="Simple use of xxf:context() function" name="oxf:java">
        <input name="config">
            <config sourcepath="oxf:/" class="org.orbeon.oxf.xforms.analysis.XPathAnalysisProcessor"/>
        </input>
        <input name="form">
            <xh:html xmlns:xxf="http://orbeon.org/oxf/xml/xforms" xmlns:fr="http://orbeon.org/oxf/xml/form-runner"
                     xmlns:exf="http://www.exforms.org/exf/1-0"
                     xmlns:xbl="http://www.w3.org/ns/xbl" xmlns:xxbl="http://orbeon.org/oxf/xml/xbl">
                <xh:head>
                    <xf:model xxf:xpath-analysis="true" id="model">
                        <xf:instance id="i1">
                            <instance>
                                <foo/>
                                <bar/>
                            </instance>
                        </xf:instance>
                        <xf:instance id="i2">
                            <instance>
                                <foo/>
                                <bar/>
                            </instance>
                        </xf:instance>
                        <xf:instance id="i3">
                            <instance>
                                <foo/>
                                <bar/>
                            </instance>
                        </xf:instance>
                    </xf:model>
                </xh:head>
                <xh:body>
                    <xf:group id="g1" ref="instance()/foo">
                        <xf:group id="g2" ref="instance('i2')/foo">
                            <xf:group id="g3" ref="instance('i3')/foo">
                                <xf:output id="o1" value="xxf:context('g1')/../bar"/>
                                <xf:output id="o2" value="xxf:context('g2')/../bar"/>
                                <xf:output id="o3" value="xxf:context('g3')/../bar"/>

                                <xf:output id="o4" value="xxf:context('o4')/../bar"/>
                            </xf:group>
                        </xf:group>
                    </xf:group>
                </xh:body>
            </xh:html>
        </input>
        <output name="analysis">
            <request request-uri="/orbeon/doc/home-welcome" query-string="id=12&amp;print=false" method="GET">
                <control name="group" scope="" prefixed-id="g1" model-prefixed-id="model" binding="true" value="false">
                    <binding>
                        <analysis expression="instance()/foo" analyzed="true">
                            <returnable>
                                <path>instance('i1')/foo</path>
                            </returnable>
                            <dependent-models>
                                <model>model</model>
                            </dependent-models>
                            <dependent-instances>
                                <instance>i1</instance>
                            </dependent-instances>
                            <returnable-instances>
                                <instance>i1</instance>
                            </returnable-instances>
                        </analysis>
                    </binding>
                </control>
                <control name="group" scope="" prefixed-id="g2" model-prefixed-id="model" binding="true" value="false">
                    <binding>
                        <analysis expression="instance('i2')/foo" analyzed="true">
                            <returnable>
                                <path>instance('i2')/foo</path>
                            </returnable>
                            <dependent-models>
                                <model>model</model>
                            </dependent-models>
                            <dependent-instances>
                                <instance>i2</instance>
                            </dependent-instances>
                            <returnable-instances>
                                <instance>i2</instance>
                            </returnable-instances>
                        </analysis>
                    </binding>
                </control>
                <control name="group" scope="" prefixed-id="g3" model-prefixed-id="model" binding="true" value="false">
                    <binding>
                        <analysis expression="instance('i3')/foo" analyzed="true">
                            <returnable>
                                <path>instance('i3')/foo</path>
                            </returnable>
                            <dependent-models>
                                <model>model</model>
                            </dependent-models>
                            <dependent-instances>
                                <instance>i3</instance>
                            </dependent-instances>
                            <returnable-instances>
                                <instance>i3</instance>
                            </returnable-instances>
                        </analysis>
                    </binding>
                </control>
                <control name="output" scope="" prefixed-id="o1" model-prefixed-id="model" binding="false" value="true">
                    <value>
                        <analysis expression="xs:string((xxf:context('g1')/../bar)[1])" analyzed="true">
                            <value-dependent>
                                <path>instance('i1')/bar</path>
                            </value-dependent>
                            <dependent-models>
                                <model>model</model>
                            </dependent-models>
                            <dependent-instances>
                                <instance>i1</instance>
                            </dependent-instances>
                        </analysis>
                    </value>
                </control>
                <control name="output" scope="" prefixed-id="o2" model-prefixed-id="model" binding="false" value="true">
                    <value>
                        <analysis expression="xs:string((xxf:context('g2')/../bar)[1])" analyzed="true">
                            <value-dependent>
                                <path>instance('i2')/bar</path>
                            </value-dependent>
                            <dependent-models>
                                <model>model</model>
                            </dependent-models>
                            <dependent-instances>
                                <instance>i2</instance>
                            </dependent-instances>
                        </analysis>
                    </value>
                </control>
                <control name="output" scope="" prefixed-id="o3" model-prefixed-id="model" binding="false" value="true">
                    <value>
                        <analysis expression="xs:string((xxf:context('g3')/../bar)[1])" analyzed="true">
                            <value-dependent>
                                <path>instance('i3')/bar</path>
                            </value-dependent>
                            <dependent-models>
                                <model>model</model>
                            </dependent-models>
                            <dependent-instances>
                                <instance>i3</instance>
                            </dependent-instances>
                        </analysis>
                    </value>
                </control>
                <control name="output" scope="" prefixed-id="o4" model-prefixed-id="model" binding="false" value="true">
                    <value>
                        <analysis expression="xs:string((xxf:context('o4')/../bar)[1])" analyzed="true">
                            <value-dependent>
                                <path>instance('i3')/bar</path>
                            </value-dependent>
                            <dependent-models>
                                <model>model</model>
                            </dependent-models>
                            <dependent-instances>
                                <instance>i3</instance>
                            </dependent-instances>
                        </analysis>
                    </value>
                </control>
                <model scope="" prefixed-id="model" default-instance-prefixed-id="i1" analyzed-binds="true"/>
            </request>
        </output>
    </test>

    <test description="Simple use of xxf:repeat-current() function" name="oxf:java">
        <input name="config">
            <config sourcepath="oxf:/" class="org.orbeon.oxf.xforms.analysis.XPathAnalysisProcessor"/>
        </input>
        <input name="form">
            <xh:html xmlns:xxf="http://orbeon.org/oxf/xml/xforms" xmlns:fr="http://orbeon.org/oxf/xml/form-runner"
                     xmlns:exf="http://www.exforms.org/exf/1-0"
                     xmlns:xbl="http://www.w3.org/ns/xbl" xmlns:xxbl="http://orbeon.org/oxf/xml/xbl">
                <xh:head>
                    <xf:model xxf:xpath-analysis="true" id="model">
                        <xf:instance id="i1">
                            <instance/>
                        </xf:instance>
                        <xf:instance id="i2">
                            <instance/>
                        </xf:instance>
                    </xf:model>
                </xh:head>
                <xh:body>
                    <xf:repeat id="r1" ref="instance()/foo">
                        <xf:repeat id="r2" ref="instance('i2')/foo">
                            <xf:output id="o1" value="xxf:repeat-current('r1')/../bar"/>
                            <xf:output id="o2" value="xxf:repeat-current('r2')/../bar"/>
                            <xf:output id="o3" value="xxf:repeat-current()/../bar"/>
                            <xf:output id="o4" value="gaga[toto = xxf:repeat-current('r1')]"/>
                            <xf:output id="o5" value="gaga[toto = xxf:repeat-current('r2')]"/>
                            <xf:output id="o6" value="gaga[toto = xxf:repeat-current()]"/>
                        </xf:repeat>
                    </xf:repeat>
                </xh:body>
            </xh:html>
        </input>
        <output name="analysis">
            <request request-uri="/orbeon/doc/home-welcome" query-string="id=12&amp;print=false" method="GET">
                <control name="repeat" scope="" prefixed-id="r1" model-prefixed-id="model" binding="true" value="false">
                    <binding>
                        <analysis expression="instance()/foo" analyzed="true">
                            <returnable>
                                <path>instance('i1')/foo</path>
                            </returnable>
                            <dependent-models>
                                <model>model</model>
                            </dependent-models>
                            <dependent-instances>
                                <instance>i1</instance>
                            </dependent-instances>
                            <returnable-instances>
                                <instance>i1</instance>
                            </returnable-instances>
                        </analysis>
                    </binding>
                </control>
                <control name="repeat" scope="" prefixed-id="r2" model-prefixed-id="model" binding="true" value="false">
                    <binding>
                        <analysis expression="instance('i2')/foo" analyzed="true">
                            <returnable>
                                <path>instance('i2')/foo</path>
                            </returnable>
                            <dependent-models>
                                <model>model</model>
                            </dependent-models>
                            <dependent-instances>
                                <instance>i2</instance>
                            </dependent-instances>
                            <returnable-instances>
                                <instance>i2</instance>
                            </returnable-instances>
                        </analysis>
                    </binding>
                </control>
                <control name="output" scope="" prefixed-id="o1" model-prefixed-id="model" binding="false" value="true">
                    <value>
                        <analysis expression="xs:string((xxf:repeat-current('r1')/../bar)[1])" analyzed="true">
                            <value-dependent>
                                <path>instance('i1')/bar</path>
                            </value-dependent>
                            <dependent-models>
                                <model>model</model>
                            </dependent-models>
                            <dependent-instances>
                                <instance>i1</instance>
                            </dependent-instances>
                        </analysis>
                    </value>
                </control>
                <control name="output" scope="" prefixed-id="o2" model-prefixed-id="model" binding="false" value="true">
                    <value>
                        <analysis expression="xs:string((xxf:repeat-current('r2')/../bar)[1])" analyzed="true">
                            <value-dependent>
                                <path>instance('i2')/bar</path>
                            </value-dependent>
                            <dependent-models>
                                <model>model</model>
                            </dependent-models>
                            <dependent-instances>
                                <instance>i2</instance>
                            </dependent-instances>
                        </analysis>
                    </value>
                </control>
                <control name="output" scope="" prefixed-id="o3" model-prefixed-id="model" binding="false" value="true">
                    <value>
                        <analysis expression="xs:string((xxf:repeat-current()/../bar)[1])" analyzed="true">
                            <value-dependent>
                                <path>instance('i2')/bar</path>
                            </value-dependent>
                            <dependent-models>
                                <model>model</model>
                            </dependent-models>
                            <dependent-instances>
                                <instance>i2</instance>
                            </dependent-instances>
                        </analysis>
                    </value>
                </control>
                <control name="output" scope="" prefixed-id="o4" model-prefixed-id="model" binding="false" value="true">
                    <value>
                        <analysis expression="xs:string((gaga[toto = xxf:repeat-current('r1')])[1])" analyzed="true">
                            <value-dependent>
                                <path>instance('i2')/foo/gaga</path>
                                <path>instance('i2')/foo/gaga/toto</path>
                                <path>instance('i1')/foo</path>
                            </value-dependent>
                            <dependent-models>
                                <model>model</model>
                            </dependent-models>
                            <dependent-instances>
                                <instance>i2</instance>
                                <instance>i1</instance>
                            </dependent-instances>
                        </analysis>
                    </value>
                </control>
                <control name="output" scope="" prefixed-id="o5" model-prefixed-id="model" binding="false" value="true">
                    <value>
                        <analysis expression="xs:string((gaga[toto = xxf:repeat-current('r2')])[1])" analyzed="true">
                            <value-dependent>
                                <path>instance('i2')/foo/gaga</path>
                                <path>instance('i2')/foo/gaga/toto</path>
                                <path>instance('i2')/foo</path>
                            </value-dependent>
                            <dependent-models>
                                <model>model</model>
                            </dependent-models>
                            <dependent-instances>
                                <instance>i2</instance>
                            </dependent-instances>
                        </analysis>
                    </value>
                </control>
                <control name="output" scope="" prefixed-id="o6" model-prefixed-id="model" binding="false" value="true">
                    <value>
                        <analysis expression="xs:string((gaga[toto = xxf:repeat-current()])[1])" analyzed="true">
                            <value-dependent>
                                <path>instance('i2')/foo/gaga</path>
                                <path>instance('i2')/foo/gaga/toto</path>
                                <path>instance('i2')/foo</path>
                            </value-dependent>
                            <dependent-models>
                                <model>model</model>
                            </dependent-models>
                            <dependent-instances>
                                <instance>i2</instance>
                            </dependent-instances>
                        </analysis>
                    </value>
                </control>
                <model scope="" prefixed-id="model" default-instance-prefixed-id="i1" analyzed-binds="true"/>
            </request>
        </output>
    </test>
    
</group>
